Version,Commit Message
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,read settings and override defaults
v1.8.1-windows,allow json overrides on a per-vehicle basis.
v1.8.1-windows,start server in async mode
v1.8.1-windows,check messages
v1.8.1-windows,plot red arrows for 30 seconds
v1.8.1-windows,plot magenta arrows for 15 seconds
v1.8.1-windows,plot red arrows for 10 seconds
v1.8.1-windows,plot 2 white arrows which are persistent
v1.8.1-windows,plot points
v1.8.1-windows,"plot line strip. 0-1, 1-2, 2-3"
v1.8.1-windows,"plot line list. 0-1, 2-3, 4-5. Must be even."
v1.8.1-windows,plot transforms
v1.8.1-windows,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=0.0, yaw=yaw)) for x, y, yaw in zip(np.linspace(0,10,10), np.linspace(0,0,10), np.linspace(0,np.pi,10))],"
v1.8.1-windows,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.8.1-windows,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=roll, yaw=0.0)) for x, y, roll in zip(np.linspace(0,10,10), np.linspace(1,1,10), np.linspace(0,np.pi,10))],"
v1.8.1-windows,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.8.1-windows,Access an existing light in the world
v1.8.1-windows,Destroy the light
v1.8.1-windows,Create a new light at the same pose
v1.8.1-windows,Change the light's intensity
v1.8.1-windows,asset_name = random.choice(assets)
v1.8.1-windows,Import this module to automatically setup path to local airsim module
v1.8.1-windows,This module first tries to see if airsim module is installed via pip
v1.8.1-windows,If it does then we don't do anything else
v1.8.1-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.8.1-windows,and if it does then we add that in sys.path
v1.8.1-windows,this class simply tries to see if airsim
v1.8.1-windows,if airsim module is installed then don't do anything else
v1.8.1-windows,import pkgutil
v1.8.1-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.8.1-windows,if airsim_loader is not None:
v1.8.1-windows,return
v1.8.1-windows,In settings.json first activate computer vision mode:
v1.8.1-windows,https://github.com/Microsoft/AirSim/blob/main/docs/image_apis.md#computer-vision-mode
v1.8.1-windows,monitor car state while you drive it manually.
v1.8.1-windows,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v1.8.1-windows,denominator from microns^3 to microns * m^2)
v1.8.1-windows,First set everything to 0.
v1.8.1-windows,Next set all objects of interest provided to corresponding object IDs
v1.8.1-windows,segIdDict values MUST match tempEmissivityNew labels.
v1.8.1-windows,"Connect to AirSim, UAV mode."
v1.8.1-windows,Choose temperature values for winter or summer.
v1.8.1-windows,""""""""
v1.8.1-windows,winter
v1.8.1-windows,""""""""
v1.8.1-windows,summer
v1.8.1-windows,Read camera response.
v1.8.1-windows,Calculate radiance.
v1.8.1-windows,Set IDs in AirSim environment.
v1.8.1-windows,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.8.1-windows,save pic
v1.8.1-windows,Change the below dimensions appropriately for the camera settings
v1.8.1-windows,In settings.json first activate computer vision mode:
v1.8.1-windows,https://github.com/Microsoft/AirSim/blob/main/docs/image_apis.md#computer-vision-mode
v1.8.1-windows,"define abstract class to return next vector in the format (x,y,yaw)"
v1.8.1-windows,"compute vector, distance and angle to goal"
v1.8.1-windows,compute box of interest
v1.8.1-windows,scale by weight matrix (optional)
v1.8.1-windows,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.8.1-windows,detect collision
v1.8.1-windows,compute box of interest
v1.8.1-windows,detect collision
v1.8.1-windows,Same as above but decide to go left or right based on average or some metric like that
v1.8.1-windows,"compute resultant normalized vector, distance and angle"
v1.8.1-windows,compute bounding box size
v1.8.1-windows,convert horizonal fov to vertical fov
v1.8.1-windows,matrix with all ones
v1.8.1-windows,matrix with max weight in center and decreasing linearly with distance from center
v1.8.1-windows,matrix with max weight in center and decreasing quadratically with distance from center
v1.8.1-windows,"print (""Saving images to %s"" % tmp_dir)"
v1.8.1-windows,airsim.wait_key('Press any key to start')
v1.8.1-windows,"Define start position, goal and size of UAV"
v1.8.1-windows,Define parameters and thresholds
v1.8.1-windows,initial position
v1.8.1-windows,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.8.1-windows,time.sleep(1)
v1.8.1-windows,get response
v1.8.1-windows,get numpy array
v1.8.1-windows,reshape array to 2D array H X W
v1.8.1-windows,write to png
v1.8.1-windows,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.8.1-windows,pose = client.simGetPose()
v1.8.1-windows,pp.pprint(pose)
v1.8.1-windows,time.sleep(5)
v1.8.1-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.8.1-windows,################### OLD CODE
v1.8.1-windows,timer = 0
v1.8.1-windows,time_obs = 50
v1.8.1-windows,bObstacle = False
v1.8.1-windows,if (bObstacle):
v1.8.1-windows,timer = timer + 1
v1.8.1-windows,if timer > time_obs:
v1.8.1-windows,bObstacle = False
v1.8.1-windows,timer = 0
v1.8.1-windows,else:
v1.8.1-windows,yaw = target_angle
v1.8.1-windows,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.8.1-windows,if (np.average(img2d_box) < coll_thres):
v1.8.1-windows,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.8.1-windows,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.8.1-windows,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.8.1-windows,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.8.1-windows,"print('left: ', img2d_box_l_avg)"
v1.8.1-windows,"print('right: ', img2d_box_r_avg)"
v1.8.1-windows,if img2d_box_l_avg > img2d_box_r_avg:
v1.8.1-windows,##Go LEFT
v1.8.1-windows,#y_offset = y_offset-1
v1.8.1-windows,yaw = yaw - radians(10)
v1.8.1-windows,bObstacle = True
v1.8.1-windows,else:
v1.8.1-windows,##Go RIGHT
v1.8.1-windows,#y_offset = y_offset+1
v1.8.1-windows,yaw = yaw + radians(10)
v1.8.1-windows,bObstacle = true
v1.8.1-windows,"print('yaw: ', yaw)"
v1.8.1-windows,In settings.json first activate computer vision mode:
v1.8.1-windows,https://github.com/Microsoft/AirSim/blob/main/docs/image_apis.md#computer-vision-mode
v1.8.1-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.8.1-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.8.1-windows,pip install opencv-python
v1.8.1-windows,Just change the below to test different cameras easily!
v1.8.1-windows,Test Camera info
v1.8.1-windows,Test Image APIs
v1.8.1-windows,Test FoV API
v1.8.1-windows,Test Pose APIs
v1.8.1-windows,Test Distortion params APIs
v1.8.1-windows,In settings.json first activate computer vision mode:
v1.8.1-windows,https://github.com/Microsoft/AirSim/blob/main/docs/image_apis.md#computer-vision-mode
v1.8.1-windows,In settings.json first activate computer vision mode:
v1.8.1-windows,https://github.com/Microsoft/AirSim/blob/main/docs/image_apis.md#computer-vision-mode
v1.8.1-windows,for block environment
v1.8.1-windows,regex are case insensitive
v1.8.1-windows,#for neighborhood environment
v1.8.1-windows,set object ID for sky
v1.8.1-windows,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.8.1-windows,get segmentation image in various formats
v1.8.1-windows,save segmentation images in various formats
v1.8.1-windows,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.8.1-windows,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.8.1-windows,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v1.8.1-windows,find unique colors
v1.8.1-windows,In settings.json first activate computer vision mode:
v1.8.1-windows,https://github.com/Microsoft/AirSim/blob/main/docs/image_apis.md#computer-vision-mode
v1.8.1-windows,objects can be named in two ways:
v1.8.1-windows,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.8.1-windows,default name is auto-generated and varies from run-to-run.
v1.8.1-windows,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.8.1-windows,
v1.8.1-windows,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.8.1-windows,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.8.1-windows,https://answers.unrealengine.com/revisions/790629.html
v1.8.1-windows,below works in Blocks environment
v1.8.1-windows,------------------------------------ Get current pose ------------------------------------------------
v1.8.1-windows,search object by name:
v1.8.1-windows,search another object by tag
v1.8.1-windows,search non-existent object
v1.8.1-windows,------------------------------------ Set new pose ------------------------------------------------
v1.8.1-windows,here we move with teleport enabled so collisions are ignored
v1.8.1-windows,here we move with teleport enabled so collisions are not ignored
v1.8.1-windows,move non-existent object
v1.8.1-windows,------------------------------------ Get new pose ------------------------------------------------
v1.8.1-windows,search another object by tag
v1.8.1-windows,search non-existent object
v1.8.1-windows,Import this module to automatically setup path to local airsim module
v1.8.1-windows,This module first tries to see if airsim module is installed via pip
v1.8.1-windows,If it does then we don't do anything else
v1.8.1-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.8.1-windows,and if it does then we add that in sys.path
v1.8.1-windows,this class simply tries to see if airsim
v1.8.1-windows,if airsim module is installed then don't do anything else
v1.8.1-windows,import pkgutil
v1.8.1-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.8.1-windows,if airsim_loader is not None:
v1.8.1-windows,return
v1.8.1-windows,"Roll is applied first, then pitch, then yaw."
v1.8.1-windows,Turn the camera position into a column vector.
v1.8.1-windows,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v1.8.1-windows,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v1.8.1-windows,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v1.8.1-windows,Recreate the perspective projection of the camera.
v1.8.1-windows,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v1.8.1-windows,Set pose and sleep after to ensure the pose sticks before capturing image.
v1.8.1-windows,Capture segmentation (IR) and scene images.
v1.8.1-windows,Change images into numpy arrays.
v1.8.1-windows,Capture images for a certain amount of time in seconds (half hour now)
v1.8.1-windows,Capture image - pose.position x_val access may change w/ AirSim
v1.8.1-windows,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v1.8.1-windows,Convert color scene image to BGR for write out with cv2.
v1.8.1-windows,"Connect to AirSim, UAV mode."
v1.8.1-windows,Look for objects with names that match a regular expression.
v1.8.1-windows,"Sample calls to main, varying camera angle and altitude."
v1.8.1-windows,"straight down, 400ft"
v1.8.1-windows,"straight down, 200ft"
v1.8.1-windows,"45 degrees, 200ft -- note that often object won't be scene since position"
v1.8.1-windows,is set exactly to object's
v1.8.1-windows,"45 degrees, 400ft -- note that often object won't be scene since position"
v1.8.1-windows,is set exactly to object's
v1.8.1-windows,In settings.json first activate computer vision mode:
v1.8.1-windows,https://github.com/Microsoft/AirSim/blob/main/docs/image_apis.md#computer-vision-mode
v1.8.1-windows,xn = 1 + x*5  # some random number
v1.8.1-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,monitor car state while you drive it manually.
v1.8.1-windows,get state of the car
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,!/usr/bin/env python3
v1.8.1-windows,-*- coding: utf-8 -*-
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,set the controls for car
v1.8.1-windows,let car drive a bit
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,go forward
v1.8.1-windows,get state of the car
v1.8.1-windows,Python client example to change time-of-day using APIs
v1.8.1-windows,
v1.8.1-windows,Changes time of the day and makes the car move around
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,flip between specific time and default time
v1.8.1-windows,go forward
v1.8.1-windows,Go forward + steer right
v1.8.1-windows,main
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,get state of the car
v1.8.1-windows,go forward
v1.8.1-windows,Go forward + steer right
v1.8.1-windows,go reverse
v1.8.1-windows,apply brakes
v1.8.1-windows,get camera images from the car
v1.8.1-windows,restore to original state
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,go forward
v1.8.1-windows,Python client example to get Lidar data from a car
v1.8.1-windows,
v1.8.1-windows,Makes the drone fly and get Lidar data
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,"print(""state: %s"" % s)"
v1.8.1-windows,go forward
v1.8.1-windows,Go forward + steer right
v1.8.1-windows,"reshape array of floats to array of [X,Y,Z]"
v1.8.1-windows,TODO
v1.8.1-windows,main
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,get state of the car
v1.8.1-windows,go forward
v1.8.1-windows,Go forward + steer right
v1.8.1-windows,go reverse
v1.8.1-windows,apply breaks
v1.8.1-windows,restore to original state
v1.8.1-windows,Sleep for some time to wait for other vehicles to be created
v1.8.1-windows,"driveCar(vehicle_name, client)"
v1.8.1-windows,go forward
v1.8.1-windows,Go forward + steer right
v1.8.1-windows,go reverse
v1.8.1-windows,apply brakes
v1.8.1-windows,Import this module to automatically setup path to local airsim module
v1.8.1-windows,This module first tries to see if airsim module is installed via pip
v1.8.1-windows,If it does then we don't do anything else
v1.8.1-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.8.1-windows,and if it does then we add that in sys.path
v1.8.1-windows,this class simply tries to see if airsim
v1.8.1-windows,if airsim module is installed then don't do anything else
v1.8.1-windows,import pkgutil
v1.8.1-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.8.1-windows,if airsim_loader is not None:
v1.8.1-windows,return
v1.8.1-windows,Use below in settings.json with blocks environment
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,get state of the car
v1.8.1-windows,go forward
v1.8.1-windows,go reverse
v1.8.1-windows,apply breaks
v1.8.1-windows,get camera images from the car
v1.8.1-windows,restore to original state
v1.8.1-windows,from keras.models import load_model
v1.8.1-windows,if (len(sys.argv) != 2):
v1.8.1-windows,print('usage: python drive.py <modelName>')
v1.8.1-windows,sys.exit()
v1.8.1-windows,print('Loading model...')
v1.8.1-windows,model = load_model(sys.argv[1])
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.8.1-windows,"model_output = model.predict([image_buf, state_buf])"
v1.8.1-windows,car_controls.steering = float(model_output[0][0])
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,set camera name and image type to request images and detections
v1.8.1-windows,set detection radius in [cm]
v1.8.1-windows,add desired object name to detect in wild card/regex format
v1.8.1-windows,Import this module to automatically setup path to local airsim module
v1.8.1-windows,This module first tries to see if airsim module is installed via pip
v1.8.1-windows,If it does then we don't do anything else
v1.8.1-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.8.1-windows,and if it does then we add that in sys.path
v1.8.1-windows,this class simply tries to see if airsim
v1.8.1-windows,if airsim module is installed then don't do anything else
v1.8.1-windows,import pkgutil
v1.8.1-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.8.1-windows,if airsim_loader is not None:
v1.8.1-windows,return
v1.8.1-windows,-*- coding: utf-8 -*-
v1.8.1-windows,
v1.8.1-windows,Configuration file for the Sphinx documentation builder.
v1.8.1-windows,
v1.8.1-windows,This file does only contain a selection of the most common options. For a
v1.8.1-windows,full list see the documentation:
v1.8.1-windows,http://www.sphinx-doc.org/en/master/config
v1.8.1-windows,-- Path setup --------------------------------------------------------------
v1.8.1-windows,"If extensions (or modules to document with autodoc) are in another directory,"
v1.8.1-windows,add these directories to sys.path here. If the directory is relative to the
v1.8.1-windows,"documentation root, use os.path.abspath to make it absolute, like shown here."
v1.8.1-windows,
v1.8.1-windows,-- Project information -----------------------------------------------------
v1.8.1-windows,The short X.Y version
v1.8.1-windows,"The full version, including alpha/beta/rc tags"
v1.8.1-windows,-- General configuration ---------------------------------------------------
v1.8.1-windows,"If your documentation needs a minimal Sphinx version, state it here."
v1.8.1-windows,
v1.8.1-windows,needs_sphinx = '1.0'
v1.8.1-windows,"Add any Sphinx extension module names here, as strings. They can be"
v1.8.1-windows,extensions coming with Sphinx (named 'sphinx.ext.*') or your custom
v1.8.1-windows,ones.
v1.8.1-windows,"Add any paths that contain templates here, relative to this directory."
v1.8.1-windows,The suffix(es) of source filenames.
v1.8.1-windows,You can specify multiple suffix as a list of string:
v1.8.1-windows,
v1.8.1-windows,"source_suffix = ['.rst', '.md']"
v1.8.1-windows,The master toctree document.
v1.8.1-windows,The language for content autogenerated by Sphinx. Refer to documentation
v1.8.1-windows,for a list of supported languages.
v1.8.1-windows,
v1.8.1-windows,This is also used if you do content translation via gettext catalogs.
v1.8.1-windows,"Usually you set ""language"" from the command line for these cases."
v1.8.1-windows,"List of patterns, relative to source directory, that match files and"
v1.8.1-windows,directories to ignore when looking for source files.
v1.8.1-windows,This pattern also affects html_static_path and html_extra_path.
v1.8.1-windows,The name of the Pygments (syntax highlighting) style to use.
v1.8.1-windows,-- Options for HTML output -------------------------------------------------
v1.8.1-windows,The theme to use for HTML and HTML Help pages.  See the documentation for
v1.8.1-windows,a list of builtin themes.
v1.8.1-windows,
v1.8.1-windows,html_theme = 'alabaster'
v1.8.1-windows,Theme options are theme-specific and customize the look and feel of a theme
v1.8.1-windows,"further.  For a list of options available for each theme, see the"
v1.8.1-windows,documentation.
v1.8.1-windows,
v1.8.1-windows,html_theme_options = {}
v1.8.1-windows,"Add any paths that contain custom static files (such as style sheets) here,"
v1.8.1-windows,"relative to this directory. They are copied after the builtin static files,"
v1.8.1-windows,"so a file named ""default.css"" will overwrite the builtin ""default.css""."
v1.8.1-windows,"Custom sidebar templates, must be a dictionary that maps document names"
v1.8.1-windows,to template names.
v1.8.1-windows,
v1.8.1-windows,The default sidebars (for documents that don't match any pattern) are
v1.8.1-windows,defined by theme itself.  Builtin themes are using these templates by
v1.8.1-windows,"default: ``['localtoc.html', 'relations.html', 'sourcelink.html',"
v1.8.1-windows,'searchbox.html']``.
v1.8.1-windows,
v1.8.1-windows,html_sidebars = {}
v1.8.1-windows,-- Options for HTMLHelp output ---------------------------------------------
v1.8.1-windows,Output file base name for HTML help builder.
v1.8.1-windows,-- Options for LaTeX output ------------------------------------------------
v1.8.1-windows,The paper size ('letterpaper' or 'a4paper').
v1.8.1-windows,
v1.8.1-windows,"'papersize': 'letterpaper',"
v1.8.1-windows,"The font size ('10pt', '11pt' or '12pt')."
v1.8.1-windows,
v1.8.1-windows,"'pointsize': '10pt',"
v1.8.1-windows,Additional stuff for the LaTeX preamble.
v1.8.1-windows,
v1.8.1-windows,"'preamble': '',"
v1.8.1-windows,Latex figure (float) alignment
v1.8.1-windows,
v1.8.1-windows,"'figure_align': 'htbp',"
v1.8.1-windows,Grouping the document tree into LaTeX files. List of tuples
v1.8.1-windows,"(source start file, target name, title,"
v1.8.1-windows,"author, documentclass [howto, manual, or own class])."
v1.8.1-windows,-- Options for manual page output ------------------------------------------
v1.8.1-windows,One entry per manual page. List of tuples
v1.8.1-windows,"(source start file, name, description, authors, manual section)."
v1.8.1-windows,-- Options for Texinfo output ----------------------------------------------
v1.8.1-windows,Grouping the document tree into Texinfo files. List of tuples
v1.8.1-windows,"(source start file, target name, title, author,"
v1.8.1-windows,"dir menu entry, description, category)"
v1.8.1-windows,-- Options for Epub output -------------------------------------------------
v1.8.1-windows,Bibliographic Dublin Core info.
v1.8.1-windows,The unique identifier of the text. This can be a ISBN number
v1.8.1-windows,or the project homepage.
v1.8.1-windows,
v1.8.1-windows,epub_identifier = ''
v1.8.1-windows,A unique identification for the text.
v1.8.1-windows,
v1.8.1-windows,epub_uid = ''
v1.8.1-windows,A list of files that should not be packed into the epub file.
v1.8.1-windows,-- Extension configuration -------------------------------------------------
v1.8.1-windows,-- Options for intersphinx extension ---------------------------------------
v1.8.1-windows,Example configuration for intersphinx: refer to the Python standard library.
v1.8.1-windows,-- Options for todo extension ----------------------------------------------
v1.8.1-windows,"If true, `todo` and `todoList` produce output, else they produce nothing."
v1.8.1-windows,We ignore the 2D nature of the problem as it is not relevant here
v1.8.1-windows,It makes multi-core processing more straightforward
v1.8.1-windows,Allocations
v1.8.1-windows,Add small number to avoid issues with log(I)
v1.8.1-windows,Event sim keeps track of previous image automatically
v1.8.1-windows,"Using pickle dump in a per-frame fashion to save time, instead of savetxt"
v1.8.1-windows,Optimizations possible
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,that's enough fun for now. let's quit cleanly
v1.8.1-windows,"Python client example to get Lidar data from a drone, although this script works for any AirSim-supported vehicle"
v1.8.1-windows,This script is for Lidar sensors using 'SensorLocalFrame' as DataFrame under settings.json.
v1.8.1-windows,Sample settings.json used for this script:
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,main
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,MultirotorClient.wait_key('Press any key to takeoff')
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,get camera images from the car
v1.8.1-windows,that's enough fun for now. let's quit cleanly
v1.8.1-windows,##################################################################################################
v1.8.1-windows,
v1.8.1-windows,Project:  Embedded Learning Library (ELL)
v1.8.1-windows,File:     speaker.py
v1.8.1-windows,Authors:  Chris Lovett
v1.8.1-windows,
v1.8.1-windows,Requires: Python 3.x
v1.8.1-windows,
v1.8.1-windows,##################################################################################################
v1.8.1-windows,open speakers so we can hear what it is processing...
v1.8.1-windows,teleport the drone + 10 meters in x-direction
v1.8.1-windows,teleport the drone back
v1.8.1-windows,This example shows how to use the External Physics Engine
v1.8.1-windows,It allows you to control the drone through setVehiclePose and obtain collision information.
v1.8.1-windows,It is especially useful for injecting your own flight dynamics model to the AirSim drone.
v1.8.1-windows,Use Blocks environment to see the drone colliding and seeing the collision information
v1.8.1-windows,in the command prompt.
v1.8.1-windows,Add this line to your settings.json before running AirSim:
v1.8.1-windows,"""PhysicsEngineName"":""ExternalPhysicsEngine"""
v1.8.1-windows,use open cv to create point cloud from depth image.
v1.8.1-windows,###########################################
v1.8.1-windows,######### This is work in progress! #######
v1.8.1-windows,###########################################
v1.8.1-windows,file will be saved in PythonClient folder (i.e. same folder as script)
v1.8.1-windows,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.8.1-windows,skip it
v1.8.1-windows,AirSim uses NED coordinates so negative axis is up.
v1.8.1-windows,z of -7 is 7 meters above the original launch point.
v1.8.1-windows,Fly given velocity vector for 5 seconds
v1.8.1-windows,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.8.1-windows,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.8.1-windows,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.8.1-windows,Make the drone fly in a circle.
v1.8.1-windows,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.8.1-windows,check that our home position is stable
v1.8.1-windows,AirSim uses NED coordinates so negative axis is up.
v1.8.1-windows,ramp up time
v1.8.1-windows,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.8.1-windows,compute current angle
v1.8.1-windows,compute lookahead
v1.8.1-windows,if we did the takeoff then also do the landing.
v1.8.1-windows,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.8.1-windows,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.8.1-windows,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.8.1-windows,ignore the click over from 360 back to 0
v1.8.1-windows,watch direction this diff is moving if it switches from shrinking to growing
v1.8.1-windows,then we passed the starting point.
v1.8.1-windows,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.8.1-windows,AirSim uses NED coordinates so negative axis is up.
v1.8.1-windows,z of -5 is 5 meters above the original launch point.
v1.8.1-windows,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.8.1-windows,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.8.1-windows,drone will over-shoot so we bring it back to the start point before landing.
v1.8.1-windows,"Python client example to get Lidar data from a drone, although this script works for any AirSim-supported vehicle"
v1.8.1-windows,This script is for Lidar sensors using 'VehicleInertialFrame' as DataFrame under settings.json
v1.8.1-windows,Sample settings.json used for this script:
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,main
v1.8.1-windows,Run this script with clock speed in settings.json
v1.8.1-windows,"""ClockSpeed"": 1 then change it to 0.5"
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,with ClockSpeed = 0.5 you will see that this takes 6s (system time) and not 3s
v1.8.1-windows,with ClockSpeed = 0.5 you will see that this takes 10s (system time)
v1.8.1-windows,and not 5s in each iteration
v1.8.1-windows,that's enough fun for now. let's quit cleanly
v1.8.1-windows,Takeoff or hover
v1.8.1-windows,Set wind to 0
v1.8.1-windows,Takeoff or hover
v1.8.1-windows,In settings.json first activate computer vision mode:
v1.8.1-windows,https://github.com/Microsoft/AirSim/blob/main/docs/image_apis.md#computer-vision-mode
v1.8.1-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.8.1-windows,pip install opencv-python
v1.8.1-windows,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.8.1-windows,fly for 2 minutes
v1.8.1-windows,more than 50 centimeter drift is unacceptable.
v1.8.1-windows,Python client example to get Lidar data from a drone
v1.8.1-windows,
v1.8.1-windows,Makes the drone fly and get Lidar data
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,"print(""state: %s"" % s)"
v1.8.1-windows,"print(""state: %s"" % pprint.pformat(state))"
v1.8.1-windows,"reshape array of floats to array of [X,Y,Z]"
v1.8.1-windows,TODO
v1.8.1-windows,main
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,AirSim uses NED coordinates so negative axis is up.
v1.8.1-windows,let it settle there a bit.
v1.8.1-windows,after hovering we need to re-enabled api control for next leg of the trip
v1.8.1-windows,now compute the survey path required to fill the box
v1.8.1-windows,##################################################################################################
v1.8.1-windows,
v1.8.1-windows,Project:  Embedded Learning Library (ELL)
v1.8.1-windows,File:     wav_reader.py
v1.8.1-windows,Authors:  Chris Lovett
v1.8.1-windows,
v1.8.1-windows,Requires: Python 3.x
v1.8.1-windows,
v1.8.1-windows,##################################################################################################
v1.8.1-windows,open a stream on the audio input file.
v1.8.1-windows,"assumes signed integer used in raw audio, so for example, the max for 16bit is 2^15 (32768)"
v1.8.1-windows,convert int16 data to scaled floats
v1.8.1-windows,configure output stream to match what we are resampling to...
v1.8.1-windows,convert the audio to the desired recording rate
v1.8.1-windows,split into separate channels
v1.8.1-windows,drop the channels we don't want
v1.8.1-windows,zip the resulting channels back up.
v1.8.1-windows,convert back to packed bytes in PCM 16 format
v1.8.1-windows,"deal with any accumulation of tails, if the tail grows to a full"
v1.8.1-windows,buffer then return it!
v1.8.1-windows,"we have a tail from previous frame, so prepend it"
v1.8.1-windows,"now the caller needs us to stick to our sample_size contract, but when"
v1.8.1-windows,rate conversion happens we can't be sure that 'data' is exactly that size.
v1.8.1-windows,usually one byte extra so add this to our accumulating tail
v1.8.1-windows,"might have reached the end of a file, so pad with zeros."
v1.8.1-windows,"Please add ""EnableTrace"": true to your setting.json as shown below"
v1.8.1-windows,{
v1.8.1-windows,"""SettingsVersion"": 1.2,"
v1.8.1-windows,"""SimMode"": ""Multirotor"","
v1.8.1-windows,"""Vehicles"": {"
v1.8.1-windows,"""Drone"": {"
v1.8.1-windows,"""VehicleType"": ""SimpleFlight"","
v1.8.1-windows,"""EnableTrace"": true"
v1.8.1-windows,}
v1.8.1-windows,}
v1.8.1-windows,}
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,add new vehicle
v1.8.1-windows,Use below in settings.json with Blocks environment
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,get camera images from the car
v1.8.1-windows,that's enough fun for now. let's quit cleanly
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,Import this module to automatically setup path to local airsim module
v1.8.1-windows,This module first tries to see if airsim module is installed via pip
v1.8.1-windows,If it does then we don't do anything else
v1.8.1-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.8.1-windows,and if it does then we add that in sys.path
v1.8.1-windows,this class simply tries to see if airsim
v1.8.1-windows,if airsim module is installed then don't do anything else
v1.8.1-windows,import pkgutil
v1.8.1-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.8.1-windows,if airsim_loader is not None:
v1.8.1-windows,return
v1.8.1-windows,"this script moves the drone to a location, then rests it thousands of time"
v1.8.1-windows,purpose of this script is to stress test reset API
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,that's enough fun for now. let's quite cleanly
v1.8.1-windows,For high speed ascent and descent on PX4 you may need to set these properties:
v1.8.1-windows,param set MPC_Z_VEL_MAX_UP 5
v1.8.1-windows,param set MPC_Z_VEL_MAX_DN 5
v1.8.1-windows,AirSim uses NED coordinates so negative axis is up.
v1.8.1-windows,z of -50 is 50 meters above the original launch point.
v1.8.1-windows,use open cv to show new images from AirSim
v1.8.1-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.8.1-windows,pip install opencv-python
v1.8.1-windows,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.8.1-windows,get depth image
v1.8.1-windows,"this will return png width= 256, height= 144"
v1.8.1-windows,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.8.1-windows,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.8.1-windows,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.8.1-windows,to get an estimate of distance.
v1.8.1-windows,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.8.1-windows,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.8.1-windows,an angular delta of the following pi/10.
v1.8.1-windows,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.8.1-windows,Remove alpha channel if exists
v1.8.1-windows,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.8.1-windows,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.8.1-windows,Flatten and yield as tuple
v1.8.1-windows,Initialize a resizable dataset to hold the output
v1.8.1-windows,Resize the dataset to accommodate the next chunk of rows
v1.8.1-windows,Create the next chunk
v1.8.1-windows,Increment the row count
v1.8.1-windows,Arguments
v1.8.1-windows,Returns
v1.8.1-windows,use composition of homographies
v1.8.1-windows,to generate final transform that needs to be applied
v1.8.1-windows,Arguments
v1.8.1-windows,Returns
v1.8.1-windows,Keeps under lock only the mechanism which advances
v1.8.1-windows,the indexing of each batch.
v1.8.1-windows,The transformation of images is not under thread lock
v1.8.1-windows,so it can be done in parallel
v1.8.1-windows,Trained model path
v1.8.1-windows,Connect to AirSim
v1.8.1-windows,Start driving
v1.8.1-windows,Initialize image buffer
v1.8.1-windows,Update throttle value according to steering angle
v1.8.1-windows,Prediction
v1.8.1-windows,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.8.1-windows,Print progress
v1.8.1-windows,Update next car state
v1.8.1-windows,Wait a bit between iterations
v1.8.1-windows,%matplotlib inline
v1.8.1-windows,chunk size for training batches
v1.8.1-windows,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.8.1-windows,Point this to the directory containing the raw data
v1.8.1-windows,Point this to the desired output directory for the cooked (.h5) data
v1.8.1-windows,Choose The folders to search for data under RAW_DATA_DIR
v1.8.1-windows,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.8.1-windows,data_folder.append('folder_name1')
v1.8.1-windows,data_folder.append('folder_name2')
v1.8.1-windows,...
v1.8.1-windows,Hyper-parameters
v1.8.1-windows,Activation functions
v1.8.1-windows,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.8.1-windows,<< The directory containing the cooked data from the previous step >>
v1.8.1-windows,<< The directory in which the model output will be placed >>
v1.8.1-windows,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.8.1-windows,Network definition
v1.8.1-windows,Import this module to automatically setup path to local airsim module
v1.8.1-windows,This module first tries to see if airsim module is installed via pip
v1.8.1-windows,If it does then we don't do anything else
v1.8.1-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.8.1-windows,and if it does then we add that in sys.path
v1.8.1-windows,this class simply tries to see if airsim
v1.8.1-windows,if airsim module is installed then don't do anything else
v1.8.1-windows,import pkgutil
v1.8.1-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.8.1-windows,if airsim_loader is not None:
v1.8.1-windows,return
v1.8.1-windows,DEY: I don't know why this was there.
v1.8.1-windows,----------------------------------- Common vehicle APIs ---------------------------------------------
v1.8.1-windows,basic flight control
v1.8.1-windows,time-of-day control
v1.8.1-windows,time - of - day control
v1.8.1-windows,weather
v1.8.1-windows,camera control
v1.8.1-windows,simGetImage returns compressed png in array of bytes
v1.8.1-windows,image_type uses one of the ImageType members
v1.8.1-windows,"todo : in future remove below, it's only for compatibility to pre v1.2"
v1.8.1-windows,"because this method returns std::vector < uint8>, msgpack decides to encode it as a string unfortunately."
v1.8.1-windows,camera control
v1.8.1-windows,simGetImage returns compressed png in array of bytes
v1.8.1-windows,image_type uses one of the ImageType members
v1.8.1-windows,CinemAirSim
v1.8.1-windows,End CinemAirSim
v1.8.1-windows,gets the static meshes in the unreal scene
v1.8.1-windows,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.8.1-windows,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.8.1-windows,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.8.1-windows,sensor APIs
v1.8.1-windows,Plotting APIs
v1.8.1-windows,Recording APIs
v1.8.1-windows,Add new vehicle via RPC
v1.8.1-windows,----------------------------------- Multirotor APIs ---------------------------------------------
v1.8.1-windows,APIs for control
v1.8.1-windows,low - level control API
v1.8.1-windows,query vehicle state
v1.8.1-windows,query rotor states
v1.8.1-windows,----------------------------------- Car APIs ---------------------------------------------
v1.8.1-windows,helper method for converting getOrientation to roll/pitch/yaw
v1.8.1-windows,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.8.1-windows,roll (x-axis rotation)
v1.8.1-windows,pitch (y-axis rotation)
v1.8.1-windows,yaw (z-axis rotation)
v1.8.1-windows,DEY: I don't know why this was there.
v1.8.1-windows,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.8.1-windows,return cls(**msgpack.unpack(encoded))
v1.8.1-windows,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.8.1-windows,Create a DummyVecEnv for main airsim gym env
v1.8.1-windows,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.8.1-windows,Initialize RL algorithm type and parameters
v1.8.1-windows,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.8.1-windows,Train for a certain number of timesteps
v1.8.1-windows,Save policy weights
v1.8.1-windows,Create a DummyVecEnv for main airsim gym env
v1.8.1-windows,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.8.1-windows,Initialize RL algorithm type and parameters
v1.8.1-windows,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.8.1-windows,Train for a certain number of timesteps
v1.8.1-windows,Save policy weights
v1.8.1-windows,Import this module to automatically setup path to local airsim module
v1.8.1-windows,This module first tries to see if airsim module is installed via pip
v1.8.1-windows,If it does then we don't do anything else
v1.8.1-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.8.1-windows,and if it does then we add that in sys.path
v1.8.1-windows,this class simply tries to see if airsim
v1.8.1-windows,if airsim module is installed then don't do anything else
v1.8.1-windows,import pkgutil
v1.8.1-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.8.1-windows,if airsim_loader is not None:
v1.8.1-windows,return
v1.8.1-windows,Set home position and velocity
v1.8.1-windows,print(dist)
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,"This is a bit crude, but give it a moment to settle on the ground, else takeoff will fail"
v1.8.1-windows,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.8.1-windows,switch to explicit hover mode so that this is the fallback when
v1.8.1-windows,move* commands are finished.
v1.8.1-windows,"Altitude difference between each platform, in meters"
v1.8.1-windows,"Count down, so the first one can easily go the highest (without knowing count)"
v1.8.1-windows,"in header only mode, control library is not available"
v1.8.1-windows,if using Unreal Build system then include precompiled header file first
v1.8.1-windows,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.8.1-windows,"Windows, OSX and Linux."
v1.8.1-windows,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.8.1-windows,Windows users can move the Documents folder to any location they want
v1.8.1-windows,SHGetFolderPath knows how to find it.
v1.8.1-windows,fall back in case SHGetFolderPath failed for some reason.
v1.8.1-windows,convert from std::path '/' to windows backslash.
v1.8.1-windows,make the current thread run with maximum priority.
v1.8.1-windows,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.8.1-windows,TODO: How to handle POSIX thread priorities on OSX?
v1.8.1-windows,setThreadName is a helper function that is useful when debugging because your threads
v1.8.1-windows,show up in the debugger with the name you set which makes it easier to find the threads
v1.8.1-windows,that you are interested in.
v1.8.1-windows,"unfortunately this is only available on Windows 10, and AirSim is not limited to that."
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.8.1-windows,
v1.8.1-windows,Treat all errors as failure conditions.
v1.8.1-windows,parse command line
v1.8.1-windows,"motive gives a weird error if the project is not found, so we look for it."
v1.8.1-windows,Do an update to pick up any recently-arrived cameras.
v1.8.1-windows,List all detected cameras.
v1.8.1-windows,List all defined rigid bodies.
v1.8.1-windows,throttle to 50 messages per second.
v1.8.1-windows,OptiTrack uses 'y' axis for vertical.
v1.8.1-windows,stdafx.cpp : source file that includes just the standard includes
v1.8.1-windows,MavlinkMoCap.pch will be the pre-compiled header
v1.8.1-windows,stdafx.obj will contain the pre-compiled type information
v1.8.1-windows,TODO: reference any additional headers you need in STDAFX.H
v1.8.1-windows,and not in this file
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,PX4.cpp : Defines the entry point for the console application.
v1.8.1-windows,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.8.1-windows,how do you write to the debug output windows on Unix ?
v1.8.1-windows,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.8.1-windows,connection to create to talke to that server.
v1.8.1-windows,SITL setup info
v1.8.1-windows,The local ethernet interface to use (default localhost).
v1.8.1-windows,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.8.1-windows,server mode on UDP is when you want another app to connect to Pixhawk and publish data back to this process.
v1.8.1-windows,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.8.1-windows,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.8.1-windows,"using their the -qgc option.  Server mode on TCP means mavlinktest will do an ""accept"" socket which is"
v1.8.1-windows,what PX4 is waiting for when it is running in TCP mode.  Here the serverEndPoint is different from the
v1.8.1-windows,offboardEndPoint.  The serverEndPoint specifies which local address to use in case your computer has
v1.8.1-windows,multiple network interfaces.
v1.8.1-windows,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.8.1-windows,this switch controls whether we turn off the RC remote active link loss detection
v1.8.1-windows,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.8.1-windows,from kicking in when you try and fly.
v1.8.1-windows,parse the json
v1.8.1-windows,flatten inner mavlink object
v1.8.1-windows,flatten inner mavlink object
v1.8.1-windows,todo
v1.8.1-windows,todo
v1.8.1-windows,"const char* outLogFileOption = ""outlogfile"";"
v1.8.1-windows,parse command line
v1.8.1-windows,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.8.1-windows,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.8.1-windows,"no local serial connection, so this is the primary droneConnection."
v1.8.1-windows,need a retry loop here because we don't know how quickly px4 will start accepting these connections...
v1.8.1-windows,failed to connect
v1.8.1-windows,"then we need 2 mavlink channels, one for sending/receiving HIL_* messages and the other"
v1.8.1-windows,for controlling the drone.
v1.8.1-windows,this is the control channel.
v1.8.1-windows,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.8.1-windows,cmdTable.push_back(new AltHoldCommand());
v1.8.1-windows,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.8.1-windows,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.8.1-windows,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.8.1-windows,this stops us from being able to connect to SITL mode PX4.
v1.8.1-windows,checkPulse();
v1.8.1-windows,add command text in log
v1.8.1-windows,close previous command.
v1.8.1-windows,FilterLogFiles(logDirectory);
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,send a heartbeat
v1.8.1-windows,accept one incoming connection
v1.8.1-windows,send a heartbeat to the client
v1.8.1-windows,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.8.1-windows,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.8.1-windows,for this unit test we are expecting a request to send an image.
v1.8.1-windows,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.8.1-windows,hmmm
v1.8.1-windows,================ ls
v1.8.1-windows,================ put file
v1.8.1-windows,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.8.1-windows,================ get file
v1.8.1-windows,verify the file contents.
v1.8.1-windows,================ remove file
v1.8.1-windows,================ make directory
v1.8.1-windows,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.8.1-windows,================ remove directory
v1.8.1-windows,Now verification
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,you must call this method if you want HandleMessage to be called subsequently.
v1.8.1-windows,treat literals as one word
v1.8.1-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.8.1-windows,request gps info
v1.8.1-windows,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.8.1-windows,find relative position since command start so we can compare two commands better
v1.8.1-windows,"these PID values are important, so set these to match"
v1.8.1-windows,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.8.1-windows,we can skip ahead.
v1.8.1-windows,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.8.1-windows,TODO: avoid passing hadcoded HIL flag
v1.8.1-windows,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.8.1-windows,"The global position, as returned by the Global Positioning System (GPS)."
v1.8.1-windows,Provides state for additional features
v1.8.1-windows,The general system state
v1.8.1-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.8.1-windows,Provides state for additional features
v1.8.1-windows,The general system state
v1.8.1-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.8.1-windows,Provides state for additional features
v1.8.1-windows,The general system state
v1.8.1-windows,Provides state for additional features
v1.8.1-windows,The general system state
v1.8.1-windows,note: we do not reset com when Close() is called because we want to keep running.
v1.8.1-windows,"user has to invoke ""hil stop"" to stop the hil thread."
v1.8.1-windows,generate random between 0 and 1
v1.8.1-windows,move to range -1 to 1
v1.8.1-windows,scale it
v1.8.1-windows,apply iy
v1.8.1-windows,wait for the Execute method to be called.
v1.8.1-windows,gps is much slower frequency than IMU.
v1.8.1-windows,MAVLINK_MSG_ID_HIL_GPS
v1.8.1-windows,disable MAV_USEHILGPS
v1.8.1-windows,note: we do not reset com when Close() is called because we want to keep running.
v1.8.1-windows,"user has to invoke ""hil stop"" to stop the hil thread."
v1.8.1-windows,generate random between 0 and 1
v1.8.1-windows,move to range -1 to 1
v1.8.1-windows,scale it
v1.8.1-windows,apply iy
v1.8.1-windows,wait for the Execute method to be called.
v1.8.1-windows,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.8.1-windows,gps is much slower frequency than IMU.
v1.8.1-windows,MAVLINK_MSG_ID_HIL_GPS
v1.8.1-windows,disable HIL mode
v1.8.1-windows,Enumeration of landed detector states
v1.8.1-windows,MAV landed state is unknown
v1.8.1-windows,MAV is landed (on ground)
v1.8.1-windows,MAV is in air
v1.8.1-windows,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.8.1-windows,The filtered local position
v1.8.1-windows,must send these regularly to keep offboard control.
v1.8.1-windows,"ok, now we can safely switch to loiter."
v1.8.1-windows,must send these regularly to keep offboard control.
v1.8.1-windows,integrate the heading so it is smoother.
v1.8.1-windows,must send these regularly to keep offboard control.
v1.8.1-windows,integrate the heading so it is smoother.
v1.8.1-windows,fly to radius
v1.8.1-windows,it takes about 10 cm to stop and turn.
v1.8.1-windows,next time around switch to orbiting!
v1.8.1-windows,heading points to center of circle.
v1.8.1-windows,interpoloate the speed ramp up time over 2 seconds from start time
v1.8.1-windows,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.8.1-windows,monitor the sin curves so we can see how on track or off track it actually is.
v1.8.1-windows,the shape of the curve will also tell us if we are progressing at a consistent
v1.8.1-windows,"speed, the more deformed the sin curve the worse our progress."
v1.8.1-windows,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.8.1-windows,degrees just flipped from 359 to 0.
v1.8.1-windows,this enables us to test what happens when offboard control is lost and resumed.
v1.8.1-windows,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.8.1-windows,"ok, now we can start moving by velocity"
v1.8.1-windows,recompute to new target.
v1.8.1-windows,start by moving right with 10 degree roll.
v1.8.1-windows,haven't started yet.
v1.8.1-windows,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.8.1-windows,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.8.1-windows,track how our actual pitch is coming along compared to our target
v1.8.1-windows,and check position
v1.8.1-windows,the amount of pitch should depend on our speed in that direction.
v1.8.1-windows,passed the midpoint.
v1.8.1-windows,fade out the pitch as we pick up speed so we don't overshoot.
v1.8.1-windows,see if we just crossed the wiggle distance threshold.
v1.8.1-windows,(pitch affects the x-position).
v1.8.1-windows,reverse direction with a -30 degrees quick stop
v1.8.1-windows,reverse direction with a 30 degrees quick stop
v1.8.1-windows,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.8.1-windows,too much in that direction.
v1.8.1-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.8.1-windows,track how our actual roll is coming along compared to our target
v1.8.1-windows,and check position
v1.8.1-windows,the amount of roll should depend on our speed in that direction.
v1.8.1-windows,passed the midpoint.
v1.8.1-windows,fade out the roll as we pick up speed so we don't overshoot.
v1.8.1-windows,see if we just crossed the wiggle distance threshold.
v1.8.1-windows,(roll affects the y-position).
v1.8.1-windows,reverse direction with a -30 degrees quick stop
v1.8.1-windows,reverse direction with a 30 degrees quick stop
v1.8.1-windows,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.8.1-windows,too much in that direction.
v1.8.1-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.8.1-windows,for testing PID controller.
v1.8.1-windows,class AltHoldCommand : public Command
v1.8.1-windows,{
v1.8.1-windows,std::shared_ptr<MavLinkVehicle> channel;
v1.8.1-windows,"float sx_, sy_, sz_;"
v1.8.1-windows,MavLinkAttitudeTarget _current;
v1.8.1-windows,PidController thrust_controller_;
v1.8.1-windows,public:
v1.8.1-windows,this->sz_ = pos.z; // user defined target.
v1.8.1-windows,move to local position keeps the offboard control happy.
v1.8.1-windows,haven't started yet.
v1.8.1-windows,and check position
v1.8.1-windows,double dx = this->sx_ - pos.x;
v1.8.1-windows,double dy = this->sy_ - pos.y;
v1.8.1-windows,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.8.1-windows,too much in that direction.
v1.8.1-windows,adjust thrust so we keep steady height target
v1.8.1-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.8.1-windows,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.8.1-windows,local remote
v1.8.1-windows,already handled by the parse method.
v1.8.1-windows,we only support very simple patterns for now.
v1.8.1-windows,each wildcard must be separated by literal.
v1.8.1-windows,back to back wildcards with no literal in between is too complex.
v1.8.1-windows,"we only support simple matching for now, we can add full regex later if we need it."
v1.8.1-windows,yep!
v1.8.1-windows,'*' is done we found the next matching char
v1.8.1-windows,this is ok.
v1.8.1-windows,this is an ERASE_END_LINE command which we ignore.
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,pack the payload buffer.
v1.8.1-windows,calculate checksum
v1.8.1-windows,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.8.1-windows,are variable length as a result.
v1.8.1-windows,form the header as a byte array for the crc
v1.8.1-windows,unpack the message...
v1.8.1-windows,pack the payload buffer.
v1.8.1-windows,"json can't handle ""nan"", so we convert it to null."
v1.8.1-windows,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.8.1-windows,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,start listening to this connection
v1.8.1-windows,Send heartbeat to drone.  You should not do this if some other node is
v1.8.1-windows,already doing it.
v1.8.1-windows,stop listening to the connection.
v1.8.1-windows,get the connection
v1.8.1-windows,Get the local system and component id
v1.8.1-windows,send a command to the remote node
v1.8.1-windows,MavLinkNode::MavLinkNode() = default;
v1.8.1-windows,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.8.1-windows,decrementing the count so the next WaitOne may block.
v1.8.1-windows,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.8.1-windows,convert to absolute time.
v1.8.1-windows,use mach_timespec
v1.8.1-windows,convert to absolute time.
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,return true if we still have offboard control (can lose this if user flips the switch).
v1.8.1-windows,MavLinkVehicle::MavLinkVehicle() = default;
v1.8.1-windows,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.8.1-windows,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,============================== CLIENT ============================================
v1.8.1-windows,image APIs
v1.8.1-windows,or if you are implementing the client side call this function to get the most recent frame.
v1.8.1-windows,returns false if there is no new frame available.
v1.8.1-windows,============================== SERVER ============================================
v1.8.1-windows,call this to send the image back over the connection given to start function.
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,"log every message that is ""sent"" using sendMessage."
v1.8.1-windows,"log every message that is ""received"""
v1.8.1-windows,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.8.1-windows,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.8.1-windows,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.8.1-windows,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,for compatibility with QGroundControl we have to save the time field in big endian.
v1.8.1-windows,todo: mavlink2 support?
v1.8.1-windows,has to be one or the other!
v1.8.1-windows,24 bits.
v1.8.1-windows,24 bits.
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,start listening to this connection
v1.8.1-windows,Send heartbeat to drone.  You should not do this if some other node is
v1.8.1-windows,already doing it.
v1.8.1-windows,this is called for all messages received on the connection.
v1.8.1-windows,"we received a heartbeat, so let's get the capabilities."
v1.8.1-windows,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.8.1-windows,subclasses remembering to call this base implementation.
v1.8.1-windows,stop listening to the connection.
v1.8.1-windows,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.8.1-windows,wait for a heartbeat msg since this will give us the port to send commands to...
v1.8.1-windows,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.8.1-windows,send a heart beat so that the remote node knows we are still alive
v1.8.1-windows,(otherwise drone will trigger a failsafe operation).
v1.8.1-windows,ignore any failures here because we are running in our own thread here.
v1.8.1-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.1-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.1-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.1-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.1-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.1-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.1-windows,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.8.1-windows,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.8.1-windows,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.8.1-windows,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.8.1-windows,"ok, now fetch the missing parameters."
v1.8.1-windows,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.8.1-windows,silently fail since we are on a background thread here...
v1.8.1-windows,tell the caller this is complete.
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,add our custom telemetry message length.
v1.8.1-windows,todo: if we support signing then initialize
v1.8.1-windows,mavlink_intermediate_status_.signing callbacks
v1.8.1-windows,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.8.1-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.8.1-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.8.1-windows,send this right away just in case serial link is not already configured
v1.8.1-windows,"log every message that is ""sent"" using sendMessage."
v1.8.1-windows,"log every message that is ""sent"" using sendMessage."
v1.8.1-windows,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.8.1-windows,pack the payload buffer.
v1.8.1-windows,calculate checksum
v1.8.1-windows,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.8.1-windows,are variable length as a result.
v1.8.1-windows,form the header as a byte array for the crc
v1.8.1-windows,these macros use old style cast.
v1.8.1-windows,forward messages from our connected node to the remote proxy.
v1.8.1-windows,tell the remote connection to expect mavlink2 messages.
v1.8.1-windows,forward messages from remote proxy to local connected node
v1.8.1-windows,CurrentThread::setMaximumPriority();
v1.8.1-windows,"hmmm, wait till it is opened?"
v1.8.1-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.8.1-windows,pick up the sysid/compid of the remote node we are connected to.
v1.8.1-windows,then this is a mavlink 1 message
v1.8.1-windows,then this mavlink sender supports mavlink 2
v1.8.1-windows,queue event for publishing.
v1.8.1-windows,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.8.1-windows,as it ensures we don't lose messages if the listener is slow.
v1.8.1-windows,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.8.1-windows,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.8.1-windows,we would get a deadlock.
v1.8.1-windows,CurrentThread::setMaximumPriority();
v1.8.1-windows,reset counters
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,------------------------------------------------------------------------------
v1.8.1-windows,Defines
v1.8.1-windows,------------------------------------------------------------------------------
v1.8.1-windows,bit number  876543210987654321
v1.8.1-windows,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.8.1-windows,in future it would be good to have ability to add system IDs we are interested in
v1.8.1-windows,if (msg.sysid != getTargetSystemId())
v1.8.1-windows,{
v1.8.1-windows,// we only care about messages from our intended remote node.
v1.8.1-windows,return;
v1.8.1-windows,}
v1.8.1-windows,user may have changed modes on us! So we need to honor that and not
v1.8.1-windows,try and take it back.
v1.8.1-windows,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.8.1-windows,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.8.1-windows,we can store up to 16 channels in rc_channels_scaled.
v1.8.1-windows,The RAW values of the servo outputs
v1.8.1-windows,Metrics typically displayed on a HUD for fixed wing aircraft
v1.8.1-windows,The IMU readings in SI units in NED body frame
v1.8.1-windows,printSystemStatus(&msg);
v1.8.1-windows,todo: use this to determine when we need to do emergency landing...
v1.8.1-windows,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.8.1-windows,Provides state for additional features
v1.8.1-windows,The general system state
v1.8.1-windows,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.8.1-windows,but we do want to know when we get the ack.  So this is async ACK processing!
v1.8.1-windows,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.8.1-windows,if threshold < 0 then the threshold is inverted.
v1.8.1-windows,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.8.1-windows,Convert it to a floating point number between -1 and 1.
v1.8.1-windows,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.8.1-windows,until the move commands start happening.
v1.8.1-windows,return true if user calls requestControl and has not called releaseControl.
v1.8.1-windows,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.8.1-windows,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.8.1-windows,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.8.1-windows,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.8.1-windows,send a few to make sure it gets through...
v1.8.1-windows,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.8.1-windows,us by which time the PX4 times out offboard mode!!
v1.8.1-windows,"assume this was successful, we'll find out if so in the next heartbeat."
v1.8.1-windows,this mode change take precedence over offboard mode.
v1.8.1-windows,thrust must be between -1 and 1.
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,These definitions are copied from PX4 implementation
v1.8.1-windows,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.8.1-windows,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.8.1-windows,/ @brief Command opcodes
v1.8.1-windows,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.8.1-windows,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.8.1-windows,must trim trailing slashes so PX4 doesn't hang!
v1.8.1-windows,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.8.1-windows,from the source.
v1.8.1-windows,check if directory exists.
v1.8.1-windows,perfect.
v1.8.1-windows,use last_message_ so we preserve the sessionid.
v1.8.1-windows,"could not create the local file, so stop."
v1.8.1-windows,must use last_message_ so we preserve the session id.
v1.8.1-windows,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.8.1-windows,todo: error handling here? sequence is out of order...
v1.8.1-windows,"directory must be empty then, can't do nextStep because"
v1.8.1-windows,it will just loop for ever re-requesting zero offset into
v1.8.1-windows,empty directory.
v1.8.1-windows,result should be a list of null terminated file names.
v1.8.1-windows,skipping this entry
v1.8.1-windows,remove the file size field.
v1.8.1-windows,"printf(""%s\n"", name.c_str());"
v1.8.1-windows,request the next batch.
v1.8.1-windows,"perhaps this was a late response after we did a retry, so ignore it."
v1.8.1-windows,"perhaps this was a late response after we did a retry, so ignore it."
v1.8.1-windows,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.8.1-windows,reached the end of the list or the file.
v1.8.1-windows,end of file or directory listing.
v1.8.1-windows,"success, data should be following..."
v1.8.1-windows,ack on this cmd is a noop
v1.8.1-windows,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.8.1-windows,give up then.
v1.8.1-windows,tell watchdog we are sending a request
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,================================= CLIENT ==============================================================
v1.8.1-windows,Check if we have a valid transaction
v1.8.1-windows,emit signal if all packets arrived
v1.8.1-windows,Restart statemachine
v1.8.1-windows,image APIs
v1.8.1-windows,================================= SERVER ==============================================================
v1.8.1-windows,Prepare and send acknowledgment packet
v1.8.1-windows,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.8.1-windows,Send ENCAPSULATED_IMAGE packet
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.8.1-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.8.1-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.8.1-windows,send this right away just in case serial link is not already configured
v1.8.1-windows,CurrentThread::setMaximumPriority();
v1.8.1-windows,"hmmm, wait till it is opened?"
v1.8.1-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.8.1-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.8.1-windows,queue event for publishing.
v1.8.1-windows,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.8.1-windows,as it ensures we don't lose messages if the listener is slow.
v1.8.1-windows,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.8.1-windows,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.8.1-windows,we would get a deadlock.
v1.8.1-windows,CurrentThread::setMaximumPriority();
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.8.1-windows,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.8.1-windows,parse out the VID number
v1.8.1-windows,now the PID
v1.8.1-windows,parse out the VID number
v1.8.1-windows,examples:
v1.8.1-windows,PX4: USB\VID_26AC&PID_0011\0
v1.8.1-windows,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.8.1-windows,"printf(""Found: %S\n"", buffer.c_str());"
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.8.1-windows,parse out the VID number
v1.8.1-windows,now the PID
v1.8.1-windows,parse out the VID number
v1.8.1-windows,suppress
v1.8.1-windows,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,This has not been properly tested
v1.8.1-windows,struct iw_statistics stats;
v1.8.1-windows,struct iwreq req;
v1.8.1-windows,"memset(&stats, 0, sizeof(stats));"
v1.8.1-windows,"memset(&req, 0, sizeof(iwreq));"
v1.8.1-windows,
v1.8.1-windows,"strncpy(req.ifr_name, ifaceName, 16);"
v1.8.1-windows,req.u.data.pointer = &stats;
v1.8.1-windows,req.u.data.length = sizeof(iw_statistics);
v1.8.1-windows,
v1.8.1-windows,#ifdef CLEAR_UPDATED
v1.8.1-windows,req.u.data.flags = 1;
v1.8.1-windows,#endif
v1.8.1-windows,
v1.8.1-windows,/* Perform the ioctl */
v1.8.1-windows,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.8.1-windows,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.8.1-windows,return -127;
v1.8.1-windows,}
v1.8.1-windows,
v1.8.1-windows,return stats.qual.level;
v1.8.1-windows,todo: windows version of this...
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,windows
v1.8.1-windows,Need to link with Ws2_32.lib
v1.8.1-windows,posix
v1.8.1-windows,found it!
v1.8.1-windows,This timeout is important as it allows the MavLinkConnection readPackets
v1.8.1-windows,thread to iterate and notice the connection is now closed. This allows
v1.8.1-windows,AirSim to shutdown properly when drone is not connected.
v1.8.1-windows,bind socket to local address.
v1.8.1-windows,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.8.1-windows,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.8.1-windows,try and reconnect
v1.8.1-windows,write to the serial port
v1.8.1-windows,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.8.1-windows,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.8.1-windows,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.8.1-windows,"try and receive something, up until port is closed anyway."
v1.8.1-windows,"message was too large for the buffer, no problem, return what we have."
v1.8.1-windows,try again - this can happen if server recreates the socket on their side.
v1.8.1-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.8.1-windows,"skip this, the receive just timed out, no problem, we'll try again later."
v1.8.1-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.8.1-windows,"printf(""#### recv failed with error: %d\n"", hr);"
v1.8.1-windows,we now have it.
v1.8.1-windows,this is from someone we are not interested in.
v1.8.1-windows,-----------------------------------------------------------------------------------------
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,Initialize Winsock
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,windows
v1.8.1-windows,Need to link with Ws2_32.lib
v1.8.1-windows,posix
v1.8.1-windows,found it!
v1.8.1-windows,bind socket to local address.
v1.8.1-windows,bind socket to local address.
v1.8.1-windows,start listening for incoming connection
v1.8.1-windows,accept 1
v1.8.1-windows,"don't need to accept any more, so we can close this one."
v1.8.1-windows,write to the serial port
v1.8.1-windows,"try and receive something, up until port is closed anyway."
v1.8.1-windows,"message was too large for the buffer, no problem, return what we have."
v1.8.1-windows,try again - this can happen if server recreates the socket on their side.
v1.8.1-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.8.1-windows,try again - this can happen if server recreates the socket on their side.
v1.8.1-windows,-----------------------------------------------------------------------------------------
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.8.1-windows,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.8.1-windows,set signal
v1.8.1-windows,Clear Handshake flags
v1.8.1-windows,Set Handshake flags
v1.8.1-windows,return GetLastError();
v1.8.1-windows,return GetLastError();
v1.8.1-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.8.1-windows,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.8.1-windows,enable reading
v1.8.1-windows,posix doesn't have mark/space parity.
v1.8.1-windows,posix doesn't have mark/space parity.
v1.8.1-windows,this is the default.
v1.8.1-windows,not sure this is supported...
v1.8.1-windows,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.8.1-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.8.1-windows,First do those specified by POSIX.
v1.8.1-windows,Now conditionally handle a bunch of extended rates.
v1.8.1-windows,First do those specified by POSIX.
v1.8.1-windows,Now conditionally handle a bunch of extended rates.
v1.8.1-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.8.1-windows,import airsim
v1.8.1-windows,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v1.8.1-windows,self.args = args
v1.8.1-windows,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v1.8.1-windows,pdb.set_trace()
v1.8.1-windows,#include <pluginlib/class_list_macros.h>
v1.8.1-windows,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v1.8.1-windows,todo do not reset if already in air?
v1.8.1-windows,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.8.1-windows,ros params
v1.8.1-windows,todo enforce dynamics constraints in this node as well?
v1.8.1-windows,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v1.8.1-windows,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v1.8.1-windows,XmlRpc::XmlRpcValue can't be const in this case
v1.8.1-windows,subscribe to control commands on global nodehandle
v1.8.1-windows,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.8.1-windows,bind to a single callback. todo optimal subs queue length
v1.8.1-windows,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.8.1-windows,TODO: ros::TransportHints().tcpNoDelay();
v1.8.1-windows,"vehicle_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.8.1-windows,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.8.1-windows,camera_setting.gimbal
v1.8.1-windows,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.8.1-windows,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.8.1-windows,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.8.1-windows,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.8.1-windows,"if {DepthPlanar, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.8.1-windows,"push back pair (vector of image captures, current vehicle name)"
v1.8.1-windows,iterate over sensors
v1.8.1-windows,"we want fast access to the lidar sensors for callback handling, sort them out now"
v1.8.1-windows,add takeoff and land all services if more than 2 drones
v1.8.1-windows,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v1.8.1-windows,todo add per vehicle reset in AirLib API
v1.8.1-windows,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.8.1-windows,lidars update on their own callback/thread at a given rate
v1.8.1-windows,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v1.8.1-windows,"todo: error check. if state is not landed, return error."
v1.8.1-windows,todo add reset by vehicle_name API to airlib
v1.8.1-windows,todo not async remove waitonlasttask
v1.8.1-windows,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v1.8.1-windows,todo do actual body frame?
v1.8.1-windows,airsim uses degrees
v1.8.1-windows,todo do actual body frame?
v1.8.1-windows,airsim uses degrees
v1.8.1-windows,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v1.8.1-windows,todo expose waitOnLastTask or nah?
v1.8.1-windows,todo do actual body frame?
v1.8.1-windows,airsim uses degrees
v1.8.1-windows,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.8.1-windows,todo expose waitOnLastTask or nah?
v1.8.1-windows,todo support multiple gimbal commands
v1.8.1-windows,todo support multiple gimbal commands
v1.8.1-windows,1. find quaternion of default gimbal pose
v1.8.1-windows,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.8.1-windows,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.8.1-windows,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.8.1-windows,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.8.1-windows,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.8.1-windows,msg = []
v1.8.1-windows,todo covariances
v1.8.1-windows,gps_msg.position_covariance_type =
v1.8.1-windows,gps_msg.position_covariance =
v1.8.1-windows,todo covariances
v1.8.1-windows,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.8.1-windows,todo radians per second
v1.8.1-windows,meters/s2^m
v1.8.1-windows,imu_msg.orientation_covariance = ;
v1.8.1-windows,imu_msg.angular_velocity_covariance = ;
v1.8.1-windows,imu_msg.linear_acceleration_covariance = ;
v1.8.1-windows,airsim appears to use chrono::system_clock with nanosecond precision
v1.8.1-windows,todo this is global origin
v1.8.1-windows,get the basic vehicle pose and environmental state
v1.8.1-windows,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.8.1-windows,airsim_client needs to provide the simulation time in a future version of the API
v1.8.1-windows,publish the simulation clock
v1.8.1-windows,"publish vehicle state, odom, and all basic sensor types"
v1.8.1-windows,send any commands out to the vehicles
v1.8.1-windows,"should be easier way to get the sim time through API, something like:"
v1.8.1-windows,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.8.1-windows,curr_ros_time = airsim_timestamp_to_ros(env.clock().nowNanos());
v1.8.1-windows,iterate over drones
v1.8.1-windows,get drone state from airsim
v1.8.1-windows,"vehicle environment, we can get ambient temperature here and other truths"
v1.8.1-windows,convert airsim drone state to ROS msgs
v1.8.1-windows,simulation environment truth
v1.8.1-windows,"dashboard reading from car, RPM, gear, etc"
v1.8.1-windows,odom and transforms
v1.8.1-windows,ground truth GPS position from sim/HITL
v1.8.1-windows,handled via callback
v1.8.1-windows,send control commands from the last callback to airsim
v1.8.1-windows,send control commands from the last callback to airsim
v1.8.1-windows,"Only camera rotation, no translation movement of camera"
v1.8.1-windows,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.8.1-windows,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.8.1-windows,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.8.1-windows,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.8.1-windows,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.8.1-windows,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.8.1-windows,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.8.1-windows,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.8.1-windows,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.8.1-windows,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.8.1-windows,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.8.1-windows,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.8.1-windows,update timestamp of saved cam info msgs
v1.8.1-windows,DepthPlanar / DepthPerspective / DepthVis / DisparityNormalized
v1.8.1-windows,Scene / Segmentation / SurfaceNormals / Infrared
v1.8.1-windows,publish camera transforms
v1.8.1-windows,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.8.1-windows,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.8.1-windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.8.1-windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.8.1-windows,ROS params
v1.8.1-windows,ROS publishers
v1.8.1-windows,ROS subscribers
v1.8.1-windows,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.8.1-windows,ROS timers
v1.8.1-windows,todo maintain internal representation as eigen vec?
v1.8.1-windows,todo check if low velocity if within thresh?
v1.8.1-windows,todo maintain separate errors for XY and Z
v1.8.1-windows,todo save this in degrees somewhere to avoid repeated conversion
v1.8.1-windows,this tells the update timer callback to not do active hovering
v1.8.1-windows,todo maintain array of position goals
v1.8.1-windows,todo error checks
v1.8.1-windows,todo fill response
v1.8.1-windows,"Already have goal, and have reached it"
v1.8.1-windows,this tells the update timer callback to not do active hovering
v1.8.1-windows,todo error checks
v1.8.1-windows,todo fill response
v1.8.1-windows,"todo do relative altitude, or add an option for the same?"
v1.8.1-windows,convert GPS goal to NED goal
v1.8.1-windows,todo error checks
v1.8.1-windows,todo fill response
v1.8.1-windows,"Already have goal, this shouldn't happen"
v1.8.1-windows,"todo do relative altitude, or add an option for the same?"
v1.8.1-windows,convert GPS goal to NED goal
v1.8.1-windows,todo error checks
v1.8.1-windows,todo fill response
v1.8.1-windows,todo check if odometry is too old!!
v1.8.1-windows,"if no odom, don't do anything."
v1.8.1-windows,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.8.1-windows,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.8.1-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.8.1-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.8.1-windows,todo yaw limits
v1.8.1-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.8.1-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.8.1-windows,mimics void ASimHUD::initializeSettings()
v1.8.1-windows,int num_threads = 1;
v1.8.1-windows,ros::MultiThreadedSpinner multi_thread(num_threads);
v1.8.1-windows,multi_thread.spin();
v1.8.1-windows,ros::AsyncSpinner async_spinner(num_threads);
v1.8.1-windows,async_spinner.start();
v1.8.1-windows,single threaded spinner
v1.8.1-windows,!/usr/bin/env python
v1.8.1-windows,capture joystick events using ROS and convert to AirSim Car API commands
v1.8.1-windows,to enable:
v1.8.1-windows,rosrun joy joy_node
v1.8.1-windows,"Below was an earlier typo, written like this for compatibility"
v1.8.1-windows,"gearing: -1 reverse, 0 N, >= 1 drive"
v1.8.1-windows,connect to the AirSim simulator
v1.8.1-windows,","
v1.8.1-windows,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.8.1-windows,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,"in header only mode, control library is not available"
v1.8.1-windows,TODO: something defines max macro which interfears with code here
v1.8.1-windows,is cur_pos within fence?
v1.8.1-windows,destination risk is not available then consider it zero
v1.8.1-windows,if dest risk is lower than its more safe
v1.8.1-windows,are we doing better than closest obstacle?
v1.8.1-windows,"if we stay where we are, what is the risk distance?"
v1.8.1-windows,else we are better of moving to dest
v1.8.1-windows,this function should work even when dest_pos == cur_pos
v1.8.1-windows,is this dest_pos cur_pos within the fence?
v1.8.1-windows,transform dest_pos vector to body frame
v1.8.1-windows,check for approx zero vectors to avoid random yaw angles
v1.8.1-windows,we are hovering
v1.8.1-windows,"get yaw in body frame, ie, front is always 0 radians"
v1.8.1-windows,yaw to ticks
v1.8.1-windows,get obstacles in the window at the tick direction around the window
v1.8.1-windows,less risk distance is better
v1.8.1-windows,check obstacles around current position and see if it has lower risk
v1.8.1-windows,else obstacle is too far
v1.8.1-windows,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.8.1-windows,look for each surrounding tick to see if we have obstacle free angle
v1.8.1-windows,else no suggestions required
v1.8.1-windows,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.8.1-windows,evaluate right and left side of circle
v1.8.1-windows,find right and left risk distances
v1.8.1-windows,at this point we have already determined hover is better than going to dest
v1.8.1-windows,we now determine is moving to suggested angle better than hovering?
v1.8.1-windows,check if dest_pos is safe
v1.8.1-windows,breaking distance at this velocity
v1.8.1-windows,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.8.1-windows,check if dest_pos is safe
v1.8.1-windows,float/vec parameters can have NaN which makes them optional
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,"in header only mode, control library is not available"
v1.8.1-windows,handles +/- tick and wraps around circle
v1.8.1-windows,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.8.1-windows,update the specified window on the map
v1.8.1-windows,make sure from <= to
v1.8.1-windows,normalize the ticks so both are valid indices
v1.8.1-windows,if from is still larger then
v1.8.1-windows,to ticks is then added one full circle to make it larger than from_tick
v1.8.1-windows,find closest obstacle in given window
v1.8.1-windows,search whole map to find closest obstacle
v1.8.1-windows,"in header only mode, control library is not available"
v1.8.1-windows,#include <fileapi.h>
v1.8.1-windows,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.8.1-windows,"Windows, OSX and Linux."
v1.8.1-windows,Windows users can move the Documents folder to any location they want
v1.8.1-windows,SHGetFolderPath knows how to find it.
v1.8.1-windows,fall back in case SHGetFolderPath failed for some reason.
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,"in header only mode, control library is not available"
v1.8.1-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.1-windows,if using Unreal Build system then include precompiled header file first
v1.8.1-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.1-windows,this deadlocks UI thread if async_run was called while there are pending rpc calls.
v1.8.1-windows,CinemAirSim
v1.8.1-windows,end CinemAirSim
v1.8.1-windows,Exit if already resetting.
v1.8.1-windows,Reset
v1.8.1-windows,if we don't suppress then server will bomb out for exceptions raised by any method
v1.8.1-windows,required for pimpl
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,"in header only mode, control library is not available"
v1.8.1-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.1-windows,if using Unreal Build system then include precompiled header file first
v1.8.1-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.1-windows,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.8.1-windows,make sure we can talk to the DroneServer
v1.8.1-windows,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.8.1-windows,command_context.client.ping();
v1.8.1-windows,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.8.1-windows,sim only
v1.8.1-windows,CinemAirSim
v1.8.1-windows,End CinemAirSim
v1.8.1-windows,"Minor TODO: consider msgpack magic for GeoPoint, so we can have one arg instead of three"
v1.8.1-windows,Convert
v1.8.1-windows,return value of last task. It should be true if task completed without
v1.8.1-windows,cancellation or timeout
v1.8.1-windows,"should be implemented by derived class if it supports async task,"
v1.8.1-windows,for example using futures
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,"in header only mode, control library is not available"
v1.8.1-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.1-windows,if using Unreal Build system then include precompiled header file first
v1.8.1-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,"in header only mode, control library is not available"
v1.8.1-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.1-windows,if using Unreal Build system then include precompiled header file first
v1.8.1-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.1-windows,required for pimpl
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,"in header only mode, control library is not available"
v1.8.1-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.1-windows,if using Unreal Build system then include precompiled header file first
v1.8.1-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.1-windows,status getters
v1.8.1-windows,Rotor state getter
v1.8.1-windows,Multirotor state getter
v1.8.1-windows,return value of last task. It should be true if task completed without
v1.8.1-windows,cancellation or timeout
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,"in header only mode, control library is not available"
v1.8.1-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.1-windows,if using Unreal Build system then include pre-compiled header file first
v1.8.1-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.1-windows,getters
v1.8.1-windows,Rotor state
v1.8.1-windows,Multirotor state
v1.8.1-windows,required for pimpl
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,"in header only mode, control library is not available"
v1.8.1-windows,last command is to hold on to position
v1.8.1-windows,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.8.1-windows,after landing we detect if drone has stopped moving
v1.8.1-windows,validate path size
v1.8.1-windows,validate yaw mode
v1.8.1-windows,validate and set auto-lookahead value
v1.8.1-windows,if auto mode requested for lookahead then calculate based on velocity
v1.8.1-windows,add current position as starting point
v1.8.1-windows,append the input path and compute segments
v1.8.1-windows,add last segment as zero length segment so we have equal number of segments and points.
v1.8.1-windows,path_segs[i] refers to segment that starts at point i
v1.8.1-windows,"when path ends, we want to slow down"
v1.8.1-windows,else no need to change velocities for last segments
v1.8.1-windows,setup current position on path to 0 offset
v1.8.1-windows,initialize next path position
v1.8.1-windows,until we are at the end of the path (last seg is always zero size)
v1.8.1-windows,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.8.1-windows,send drone command to get to next lookahead
v1.8.1-windows,sleep for rest of the cycle
v1.8.1-windows,how much have we moved towards last goal?
v1.8.1-windows,project actual vector on goal vector
v1.8.1-windows,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.8.1-windows,TODO: below should be lower than 1E3 and configurable
v1.8.1-windows,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.8.1-windows,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.8.1-windows,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.8.1-windows,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.8.1-windows,"if drone moved backward, we don't want goal to move backward as well"
v1.8.1-windows,"so only climb forward on the path, never back. Also note >= which means"
v1.8.1-windows,we climb path even if distance was 0 to take care of duplicated points on path
v1.8.1-windows,else
v1.8.1-windows,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.8.1-windows,compute next target on path
v1.8.1-windows,freeze the quaternion
v1.8.1-windows,convert RC commands to velocity vector
v1.8.1-windows,find yaw as per terrain and remote setting
v1.8.1-windows,execute command
v1.8.1-windows,if timeout occurred then command completed successfully otherwise it was interrupted
v1.8.1-windows,yaw is not within margin
v1.8.1-windows,by default we say that this command is not supported
v1.8.1-windows,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.8.1-windows,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.8.1-windows,get trims
v1.8.1-windows,take average
v1.8.1-windows,validate dest
v1.8.1-windows,what is the distance we will travel at this velocity?
v1.8.1-windows,get velocity vector
v1.8.1-windows,yaw for the direction of travel
v1.8.1-windows,find velocity vector
v1.8.1-windows,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.8.1-windows,generate velocity vector that is same size as cur_dest_norm / command period
v1.8.1-windows,this velocity vect when executed for command period would yield cur_dest_norm
v1.8.1-windows,send commands
v1.8.1-windows,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.8.1-windows,default strategy is for move. In hover mode we set new strategy temporarily
v1.8.1-windows,are we supposed to do EM?
v1.8.1-windows,get suggested velocity vector
v1.8.1-windows,use the unchecked command
v1.8.1-windows,tell caller not to execute planned command
v1.8.1-windows,other wise throw exception
v1.8.1-windows,otherwise there is some other reason why we are in unsafe situation
v1.8.1-windows,send last command to come to full stop
v1.8.1-windows,else no unsafe situation
v1.8.1-windows,note: cur_path_loc and next_path_loc may both point to same object
v1.8.1-windows,"otherwise use up this segment, move on to next one"
v1.8.1-windows,if we are here then we ran out of segments
v1.8.1-windows,consider last segment as zero length segment
v1.8.1-windows,adjust yaw for the direction of travel in forward-only mode
v1.8.1-windows,else no adjustment needed
v1.8.1-windows,if auto mode requested for lookahead then calculate based on velocity
v1.8.1-windows,Create a spring arm component for our chase camera
v1.8.1-windows,"do nothing, spring arm is pulling the camera with it"
v1.8.1-windows,"do nothing, we have camera turned off"
v1.8.1-windows,set initial view mode
v1.8.1-windows,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.8.1-windows,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.8.1-windows,"If the lag is missing, the camera will also occasionally shake."
v1.8.1-windows,"But, lag is not desired when piloting a drone"
v1.8.1-windows,attach spring arm to actor
v1.8.1-windows,remember current parent for external camera. Later when we remove external
v1.8.1-windows,"camera from spring arm, we will attach it back to its last parent"
v1.8.1-windows,now attach camera to spring arm
v1.8.1-windows,"For car, we need to move the camera back a little more than for a drone."
v1.8.1-windows,"Otherwise, the camera will be stuck inside the car"
v1.8.1-windows,ExternalCamera->bUsePawnControlRotation = false;
v1.8.1-windows,detach spring arm
v1.8.1-windows,Re-enable rendering
v1.8.1-windows,Remove any existing key bindings for manual mode
v1.8.1-windows,"else someone else is bound to manual pose controller, leave it alone"
v1.8.1-windows,if new mode is manual mode then add key bindings
v1.8.1-windows,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.8.1-windows,other modes don't need special setup
v1.8.1-windows,make switch official
v1.8.1-windows,Add loading screen to viewport
v1.8.1-windows,Remove Loading screen from viewport
v1.8.1-windows,Create struct for Location and Rotation of actor in Unreal
v1.8.1-windows,Ensure new non-matching name for the object
v1.8.1-windows,Write the binvox file using run-length encoding
v1.8.1-windows,"where each pair of bytes is of the format (run value, run length)"
v1.8.1-windows,This is a run (repeated bit value)
v1.8.1-windows,End of a run
v1.8.1-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.8.1-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.8.1-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.8.1-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.8.1-windows,Split the tag string into individual tags.
v1.8.1-windows,Texture swap on actors that have all of those tags.
v1.8.1-windows,----------- Plotting APIs ----------/
v1.8.1-windows,"plot line for points 0-1, 1-2, 2-3"
v1.8.1-windows,"plot line for points 0-1, 2-3, 4-5... must be even number of points"
v1.8.1-windows,assert points_start.size() == poinst_end.size()
v1.8.1-windows,assert positions.size() == strings.size()
v1.8.1-windows,assert poses.size() == names.size()
v1.8.1-windows,Recording APIs
v1.8.1-windows,"Remove '' from the list, representing default vehicle"
v1.8.1-windows,"We need to run this code on the main game thread, since it iterates over actors"
v1.8.1-windows,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.8.1-windows,"No LOS, so draw red line"
v1.8.1-windows,"Yes LOS, so draw green line"
v1.8.1-windows,"We need to run this code on the main game thread, since it iterates over actors"
v1.8.1-windows,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.8.1-windows,Testing actor enum for world bounds...
v1.8.1-windows,"Same as with the Object Iterator, access the subclass instance with the * or -> operators."
v1.8.1-windows,"TODO think more about how best to determine/indicate ground level, if anyone cares"
v1.8.1-windows,Convert Uvectors to LLAs
v1.8.1-windows,CinemAirSim
v1.8.1-windows,End CinemAirSim
v1.8.1-windows,Fill out your copyright notice in the Description page of Project Settings.
v1.8.1-windows,"Set this component to be initialized when the game starts, and to be ticked every frame.  You can turn these features"
v1.8.1-windows,off to improve performance if you don't need them.
v1.8.1-windows,get render target for texture size
v1.8.1-windows,initialize viewinfo for projection matrix
v1.8.1-windows,calculate 3D corner Points of bounding box
v1.8.1-windows,initialize pixel values
v1.8.1-windows,initialize projection data for sceneview
v1.8.1-windows,do some voodoo rotation that is somehow mandatory and stolen from UGameplayStatics::ProjectWorldToScreen
v1.8.1-windows,Project Points to pixels and get the corner pixels
v1.8.1-windows,If actor in camera view - check if it's actually visible or hidden
v1.8.1-windows,Check against 8 extend points
v1.8.1-windows,"If actor in camera view but didn't hit any point out of 8 extend points,"
v1.8.1-windows,check against 10 random points
v1.8.1-windows,CinemAirSim
v1.8.1-windows,CinemAirSim
v1.8.1-windows,set initial focal length
v1.8.1-windows,by default all image types are disabled
v1.8.1-windows,use final color for all calculations
v1.8.1-windows,We set all cameras to start as nodisplay
v1.8.1-windows,This improves performance because the capture components are no longer updating every frame and only update while requesting an image
v1.8.1-windows,TODO: avoid the need to override const cast here
v1.8.1-windows,if the viewport is taller than it is wide
v1.8.1-windows,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v1.8.1-windows,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v1.8.1-windows,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v1.8.1-windows,use final color for all calculations
v1.8.1-windows,TODO: should we be ignoring position and orientation settings here?
v1.8.1-windows,TODO: can we eliminate storing NedTransform?
v1.8.1-windows,CinemAirSim
v1.8.1-windows,if (!std::isnan(setting.target_gamma))
v1.8.1-windows,camera-> = setting.target_gamma;
v1.8.1-windows,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.8.1-windows,else nothing to enable
v1.8.1-windows,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.8.1-windows,if (controller && controller->GetViewTarget() == this)
v1.8.1-windows,controller->SetViewTarget(nullptr);
v1.8.1-windows,CinemAirSim methods
v1.8.1-windows,Copy all of the post processing settings
v1.8.1-windows,But restore the original blendables
v1.8.1-windows,end CinemAirSim methods
v1.8.1-windows,TODO: explore screenshot option
v1.8.1-windows,addScreenCaptureHandler(camera->GetWorld());
v1.8.1-windows,TODO: may be we should have these methods non-const?
v1.8.1-windows,We don't do game/render thread synchronization for safe method.
v1.8.1-windows,We just blindly sleep for 200ms (the old way)
v1.8.1-windows,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.8.1-windows,Make sure that all alpha values are opaque.
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,TODO: change naming conventions to same as other files?
v1.8.1-windows,Get name of current level
v1.8.1-windows,Only load new level if different from current level
v1.8.1-windows,"context->GetWorld()->SetNewWorldOrigin(FIntVector(0, 0, 0));"
v1.8.1-windows,Enable/disable primary viewport rendering flag
v1.8.1-windows,This disables rendering of the main viewport in the same way as the
v1.8.1-windows,"console command ""show rendering"" would do."
v1.8.1-windows,"When getting an image through the API, the image is produced after the render"
v1.8.1-windows,thread has finished rendering the current and the subsequent frame. This means
v1.8.1-windows,that the frame rate for obtaining images through the API is only half as high as
v1.8.1-windows,"it could be, since only every other image is actually captured. We work around"
v1.8.1-windows,this by telling the viewport to flush the rendering queue at the end of each
v1.8.1-windows,drawn frame so that it executes our render request at that point already.
v1.8.1-windows,Do this only if the main viewport is not being rendered anyway in case there are
v1.8.1-windows,any adverse performance effects during main rendering.
v1.8.1-windows,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v1.8.1-windows,nothing to do for now
v1.8.1-windows,"if hidden, clear any existing messages"
v1.8.1-windows,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.8.1-windows,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.8.1-windows,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.8.1-windows,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.8.1-windows,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.8.1-windows,Find mesh in /Game and /AirSim asset registry. When more plugins are added this function will have to change
v1.8.1-windows,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.8.1-windows,{
v1.8.1-windows,InitializeObjectStencilID(*comp);
v1.8.1-windows,}
v1.8.1-windows,"Takes a UStaticMeshComponent, USkinnedMeshComponent or ALandscapeProxy and returns their custom stencil ID if"
v1.8.1-windows,their meshes's name or their owner's name (depending on the naming method in mesh_naming_method_) equals mesh_name
v1.8.1-windows,"The skybox is ignored here as it is huge, and really is of no use to the end user typically. Also the associated meshes with the cameras"
v1.8.1-windows,Various checks if there is even a valid mesh
v1.8.1-windows,Need to force the render command to go through cause on the next iteration the buffer no longer exists
v1.8.1-windows,Unreal stores more vertices than triangles. So here we find the highest referenced vertex and ignore any after that
v1.8.1-windows,can we see followee?
v1.8.1-windows,remove mapping
v1.8.1-windows,removing binding
v1.8.1-windows,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.8.1-windows,"some point. At the moment, manually swapping Red and Blue"
v1.8.1-windows,Copy scaled image into destination thumb
v1.8.1-windows,Compress data - convert into a .png
v1.8.1-windows,if we already have attached actor
v1.8.1-windows,Fill out your copyright notice in the Description page of Project Settings.
v1.8.1-windows,Check pointer equality first for performance
v1.8.1-windows,"KeyHash = HashCombine(KeyHash, GetTypeHash(Key.WildcardMeshNames));"
v1.8.1-windows,#ifdef _MSC_VER
v1.8.1-windows,//print to VS output window
v1.8.1-windows,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.8.1-windows,#endif
v1.8.1-windows,also do default logging
v1.8.1-windows,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.8.1-windows,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.8.1-windows,{
v1.8.1-windows,if (GEngine != nullptr)
v1.8.1-windows,{
v1.8.1-windows,return GEngine->GameUserSettings;
v1.8.1-windows,}
v1.8.1-windows,return nullptr;
v1.8.1-windows,}
v1.8.1-windows,UGameUserSettings* game_settings = GetGameUserSettings();
v1.8.1-windows,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.8.1-windows,game_settings->ApplySettings(true);
v1.8.1-windows,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.8.1-windows,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.8.1-windows,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.8.1-windows,todo unused. need to manually plots tf axes' line in right handed FLU instead of using DrawDebugCoordinateSystem
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,plugin startup
v1.8.1-windows,plugin shutdown
v1.8.1-windows,initialize state
v1.8.1-windows,add listener for pawn's collision event
v1.8.1-windows,compute our home point
v1.8.1-windows,default behavior is to call update every tick
v1.8.1-windows,"for custom physics engine, this method should be overridden and update should be"
v1.8.1-windows,called from every physics tick
v1.8.1-windows,add cameras that already exists in pawn
v1.8.1-windows,create or replace cameras specified in settings
v1.8.1-windows,setup individual cameras
v1.8.1-windows,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.8.1-windows,for each camera in settings
v1.8.1-windows,get pose
v1.8.1-windows,spawn and attach camera to pawn
v1.8.1-windows,add on to our collection
v1.8.1-windows,Deflect along the surface when we collide.
v1.8.1-windows,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.8.1-windows,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.8.1-windows,-1 to 1 --> 0 to 1
v1.8.1-windows,-1 to 1
v1.8.1-windows,these will be available for devices like steering wheels
v1.8.1-windows,switch index 0 to 7 for FrSky Taranis RC is:
v1.8.1-windows,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.8.1-windows,TODO: should below be at controller level info?
v1.8.1-windows,else don't waste time
v1.8.1-windows,"We need to run this code on the main game thread, since it iterates over actors"
v1.8.1-windows,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.8.1-windows,Transform from LLA to NED
v1.8.1-windows,KM911 remove logging
v1.8.1-windows,"common_utils::Utils::log(""NED from LLA: "" + std::to_string(target_location.X) + "", "" + std::to_string(target_location.Y) + "", "" + std::to_string(target_location.Z), common_utils::Utils::kLogLevelInfo);"
v1.8.1-windows,"No LOS, so draw red line"
v1.8.1-windows,"Yes LOS, so draw green line"
v1.8.1-windows,sync environment from kinematics
v1.8.1-windows,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.8.1-windows,void playBack()
v1.8.1-windows,{
v1.8.1-windows,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.8.1-windows,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.8.1-windows,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.8.1-windows,}
v1.8.1-windows,TODO: refactor below code used for playback
v1.8.1-windows,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.8.1-windows,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.8.1-windows,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.8.1-windows,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.8.1-windows,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.8.1-windows,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.8.1-windows,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.8.1-windows,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.8.1-windows,}
v1.8.1-windows,parameters in NED frame
v1.8.1-windows,translate to new PawnSimApi position & orientation from NED to NEU
v1.8.1-windows,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.8.1-windows,allow teleportation
v1.8.1-windows,if collisions are not enabled
v1.8.1-windows,or we have collided but passthrough is enabled
v1.8.1-windows,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.8.1-windows,"without flip flopping, collisions can't be detected"
v1.8.1-windows,update kinematics from pawn's movement instead of physics engine
v1.8.1-windows,by default we update kinematics from UE pawn
v1.8.1-windows,if SimMod uses its own physics engine then this should be overriden
v1.8.1-windows,no default action in this base class
v1.8.1-windows,"read pixels from render target using render thread, then compress the result into PNG"
v1.8.1-windows,argument on the thread that calls this method.
v1.8.1-windows,TODO: is below really needed?
v1.8.1-windows,make sure we are not on the rendering thread
v1.8.1-windows,TODO: below doesn't work right now because it must be running in game thread
v1.8.1-windows,below is documented method but more expensive because it forces flush
v1.8.1-windows,wait for render thread to pick up our task
v1.8.1-windows,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.8.1-windows,capture CameraPose for this frame
v1.8.1-windows,The completion is called immeidately after GameThread sends the
v1.8.1-windows,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.8.1-windows,execute *immediately* after RenderThread renders the scene!
v1.8.1-windows,"while we're still on GameThread, enqueue request for capture the scene!"
v1.8.1-windows,wait for this task to complete
v1.8.1-windows,log a message and continue wait
v1.8.1-windows,lamda function still references a few objects for which there is no refcount.
v1.8.1-windows,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.8.1-windows,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.8.1-windows,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.8.1-windows,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.8.1-windows,Fill out your copyright notice in the Description page of Project Settings.
v1.8.1-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.1-windows,UWorld* World = GetWorld();
v1.8.1-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.1-windows,still need the menu class for f10
v1.8.1-windows,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v1.8.1-windows,showWeatherMenu(WorldContextObject);
v1.8.1-windows,"if weather is not enabled, dont allow any weather values to be set"
v1.8.1-windows,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v1.8.1-windows,and must be set to true or false before this.
v1.8.1-windows,WeatherEnabled will always be false
v1.8.1-windows,"NOTE: weather enabled must be set first, before other params for this to work"
v1.8.1-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.1-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.1-windows,"get all menu actors, if any"
v1.8.1-windows,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.8.1-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.1-windows,"get all menu actors, if any"
v1.8.1-windows,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.8.1-windows,"get all menu actors, if any, then hide the menu"
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,Stuff to filter out XInput devices
v1.8.1-windows,-----------------------------------------------------------------------------
v1.8.1-windows,"Defines, constants, and global variables"
v1.8.1-windows,-----------------------------------------------------------------------------
v1.8.1-windows,Magnitude ranges from -1 to 1
v1.8.1-windows,Strength ranges from 0 to 1
v1.8.1-windows,Autocenter
v1.8.1-windows,Rumble
v1.8.1-windows,Register with the DirectInput subsystem and get a pointer
v1.8.1-windows,to a IDirectInput interface we can use.
v1.8.1-windows,Create a DInput object
v1.8.1-windows,Look for a simple joystick we can use for this sample program.
v1.8.1-windows,Make sure we got a joystick
v1.8.1-windows,"Set the data format to ""simple joystick"" - a predefined data format"
v1.8.1-windows,
v1.8.1-windows,"A data format specifies which controls on a device we are interested in,"
v1.8.1-windows,and how they should be reported. This tells DInput that we will be
v1.8.1-windows,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.8.1-windows,Set the cooperative level to let DInput know how this device should
v1.8.1-windows,interact with the system and with other DInput applications.
v1.8.1-windows,Enumerate the joystick objects. The callback function enabled user
v1.8.1-windows,"interface elements for objects that are found, and sets the min/max"
v1.8.1-windows,values property for discovered axes.
v1.8.1-windows,-----------------------------------------------------------------------------
v1.8.1-windows,Enum each PNP device using WMI and check each device ID to see if it contains
v1.8.1-windows,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.8.1-windows,Unfortunately this information can not be found by just using DirectInput.
v1.8.1-windows,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.8.1-windows,XInput devices.
v1.8.1-windows,
v1.8.1-windows,This function stores the list of xinput devices in a linked list
v1.8.1-windows,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.8.1-windows,-----------------------------------------------------------------------------
v1.8.1-windows,CoInit if needed
v1.8.1-windows,Create WMI
v1.8.1-windows,Create BSTRs for WMI
v1.8.1-windows,Connect to WMI
v1.8.1-windows,Switch security level to IMPERSONATE
v1.8.1-windows,Get list of Win32_PNPEntity devices
v1.8.1-windows,Loop over all devices
v1.8.1-windows,Get 20 at a time
v1.8.1-windows,"For each device, get its device ID"
v1.8.1-windows,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.8.1-windows,Unfortunately this information can not be found by just using DirectInput
v1.8.1-windows,"If it does, then get the VID/PID from var.bstrVal"
v1.8.1-windows,Add the VID/PID to a linked list
v1.8.1-windows,-----------------------------------------------------------------------------
v1.8.1-windows,Returns true if the DirectInput device is also an XInput device.
v1.8.1-windows,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.8.1-windows,-----------------------------------------------------------------------------
v1.8.1-windows,Check each xinput device to see if this device's vid/pid matches
v1.8.1-windows,-----------------------------------------------------------------------------
v1.8.1-windows,Cleanup needed for IsXInputDevice()
v1.8.1-windows,-----------------------------------------------------------------------------
v1.8.1-windows,Cleanup linked list
v1.8.1-windows,-----------------------------------------------------------------------------
v1.8.1-windows,Name: EnumJoysticksCallback()
v1.8.1-windows,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.8.1-windows,device interface on it so we can play with it.
v1.8.1-windows,-----------------------------------------------------------------------------
v1.8.1-windows,Skip anything other than the perferred joystick device as defined by the control panel.
v1.8.1-windows,Instead you could store all the enumerated joysticks and let the user pick.
v1.8.1-windows,Obtain an interface to the enumerated joystick.
v1.8.1-windows,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.8.1-windows,it while we were in the middle of enumerating it.)
v1.8.1-windows,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.8.1-windows,could store all the enumerated joysticks and let the user pick.
v1.8.1-windows,-----------------------------------------------------------------------------
v1.8.1-windows,Name: EnumObjectsCallback()
v1.8.1-windows,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.8.1-windows,joystick. This function enables user interface elements for objects
v1.8.1-windows,"that are found to exist, and scales axes min/max values."
v1.8.1-windows,-----------------------------------------------------------------------------
v1.8.1-windows,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.8.1-windows,enumerated axis in order to scale min/max values.
v1.8.1-windows,Set the range for the axis
v1.8.1-windows,Set the UI to reflect what objects the joystick supports
v1.8.1-windows,-----------------------------------------------------------------------------
v1.8.1-windows,Name: UpdateInputState()
v1.8.1-windows,Desc: Get the input device's state and display it.
v1.8.1-windows,-----------------------------------------------------------------------------
v1.8.1-windows,Poll the device to read the current state
v1.8.1-windows,DInput is telling us that the input stream has been
v1.8.1-windows,"interrupted. We aren't tracking any state between polls, so"
v1.8.1-windows,we don't have any special reset that needs to be done. We
v1.8.1-windows,just re-acquire and try again.
v1.8.1-windows,while (hr == DIERR_INPUTLOST)
v1.8.1-windows,hr = g_pJoystick->Acquire();
v1.8.1-windows,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.8.1-windows,may occur when the app is minimized or in the process of
v1.8.1-windows,"switching, so just try again later"
v1.8.1-windows,Get the input's device state
v1.8.1-windows,Axes
v1.8.1-windows,Slider controls
v1.8.1-windows,Points of view
v1.8.1-windows,Buttons
v1.8.1-windows,-----------------------------------------------------------------------------
v1.8.1-windows,Name: FreeDirectInput()
v1.8.1-windows,Desc: Initialize the DirectInput variables.
v1.8.1-windows,-----------------------------------------------------------------------------
v1.8.1-windows,Unacquire the device one last time just in case
v1.8.1-windows,the app tried to exit while the device is still acquired.
v1.8.1-windows,Release any DirectInput objects.
v1.8.1-windows,nop
v1.8.1-windows,normalize min to max --> 0 to 1
v1.8.1-windows,normalize 0 to 1 --> -1 to 1
v1.8.1-windows,#include <libudev.h>
v1.8.1-windows,implementation for unsupported OS
v1.8.1-windows,if this is new index
v1.8.1-windows,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.8.1-windows,close previous one
v1.8.1-windows,open new device
v1.8.1-windows,if open was successful
v1.8.1-windows,read the device
v1.8.1-windows,if we didn't had valid read
v1.8.1-windows,"NOTE if this condition is not met, we're probably out of sync and this"
v1.8.1-windows,Joystick instance is likely unusable
v1.8.1-windows,TODO: set below to false?
v1.8.1-windows,state.is_valid = false;
v1.8.1-windows,else ignore
v1.8.1-windows,TODO: implement this for linux
v1.8.1-windows,TODO: implement this for linux
v1.8.1-windows,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.8.1-windows,{
v1.8.1-windows,"manufacturerID = productID = """";"
v1.8.1-windows,// Use udev to look up the product and manufacturer IDs
v1.8.1-windows,struct udev *udev = udev_new();
v1.8.1-windows,if (udev) {
v1.8.1-windows,char sysname[32];
v1.8.1-windows,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.8.1-windows,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.8.1-windows,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.8.1-windows,if (!dev)
v1.8.1-windows,{
v1.8.1-windows,"message = ""Unable to find parent USB device"";"
v1.8.1-windows,return false;
v1.8.1-windows,}
v1.8.1-windows,std::stringstream ss;
v1.8.1-windows,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.8.1-windows,ss >> manufacturerID;
v1.8.1-windows,ss.clear();
v1.8.1-windows,"ss.str("""");"
v1.8.1-windows,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.8.1-windows,ss >> productID;
v1.8.1-windows,udev_device_unref(dev);
v1.8.1-windows,}
v1.8.1-windows,else
v1.8.1-windows,{
v1.8.1-windows,"message = ""Cannot create udev"";"
v1.8.1-windows,return false;
v1.8.1-windows,}
v1.8.1-windows,udev_unref(udev);
v1.8.1-windows,return true;
v1.8.1-windows,}
v1.8.1-windows,required for pimpl
v1.8.1-windows,TODO: anyway to workaround const_cast?
v1.8.1-windows,Prevent a MavLink connection being established if changing levels
v1.8.1-windows,FGenericPlatformMisc::PlatformInit();
v1.8.1-windows,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.8.1-windows,"sub-window captures don't count as a request, set bCaptureEveryFrame and bCaptureOnMovement to display so we can show correctly the subwindow"
v1.8.1-windows,create main widget
v1.8.1-windows,synchronize PIP views
v1.8.1-windows,TODO: should we only do below on SceneCapture2D components and cameras?
v1.8.1-windows,avoid motion blur so capture images don't get
v1.8.1-windows,use two different methods to set console var because sometime it doesn't seem to work
v1.8.1-windows,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.8.1-windows,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.8.1-windows,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.8.1-windows,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.8.1-windows,setup defaults
v1.8.1-windows,Attempts to parse the settings text from one of multiple locations.
v1.8.1-windows,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.8.1-windows,"Next, check the executable's working directory for the settings file."
v1.8.1-windows,"Finally, check the user's documents folder."
v1.8.1-windows,"If the settings file cannot be read, throw an exception"
v1.8.1-windows,Attempts to parse the settings file path or the settings text from the command line
v1.8.1-windows,"Looks for the flag ""-settings="". If it exists, settingsText will be set to the value."
v1.8.1-windows,"Example (Path): AirSim.exe -settings=""C:\path\to\settings.json"""
v1.8.1-windows,"Example (Text): AirSim.exe -settings={""foo"":""bar""} -> settingsText will be set to {""foo"":""bar""}"
v1.8.1-windows,"Returns true if the argument is present, false otherwise."
v1.8.1-windows,build image file name
v1.8.1-windows,write image file
v1.8.1-windows,"Write PNG image, already compressed in binary"
v1.8.1-windows,write to CSV file
v1.8.1-windows,"Either images were saved successfully, or there were no images"
v1.8.1-windows,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.8.1-windows,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.8.1-windows,"Just need any 1 instance, to set the header line of the record file"
v1.8.1-windows,"Set is_ready at the end, setting this before can cause a race when the file isn't open yet"
v1.8.1-windows,make sure all vars are set up
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,decide which derived BP to use
v1.8.1-windows,we don't have real vehicle so no vehicle API
v1.8.1-windows,put camera little bit above vehicle
v1.8.1-windows,update ground level
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,let base class setup physics world
v1.8.1-windows,stop physics thread before we dismantle
v1.8.1-windows,setup clock in ClockFactory
v1.8.1-windows,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.8.1-windows,steppable clock returns interval that is a constant number irrespective of wall clock
v1.8.1-windows,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.8.1-windows,but that would cause vehicles like quadrotors to become unstable
v1.8.1-windows,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.8.1-windows,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.8.1-windows,get increase in clock speed
v1.8.1-windows,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.8.1-windows,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.8.1-windows,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.8.1-windows,Approach 2: scale control loop frequency if clock is speeded up
v1.8.1-windows,"for slowing down, this don't generate instability"
v1.8.1-windows,-------------------------------- overrides -----------------------------------------------//
v1.8.1-windows,decide which derived BP to use
v1.8.1-windows,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.8.1-windows,vehicle_sim_api->reset();
v1.8.1-windows,create vehicle API
v1.8.1-windows,setup physics vehicle
v1.8.1-windows,initialize private vars
v1.8.1-windows,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.8.1-windows,calls to update* are handled by physics engine and in SimModeWorldBase
v1.8.1-windows,"Utils::log(""------Render tick-------"");"
v1.8.1-windows,"if reset is pending then do it first, no need to do other things until next tick"
v1.8.1-windows,move collision info from rendering engine to vehicle
v1.8.1-windows,update rotor poses
v1.8.1-windows,update private rotor variable
v1.8.1-windows,if we did reset then don't worry about synchronizing states for this tick
v1.8.1-windows,Continue to wait for reset
v1.8.1-windows,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.8.1-windows,*** Start: UpdatableState implementation ***//
v1.8.1-windows,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.8.1-windows,environment update for current position
v1.8.1-windows,update forces on vertices
v1.8.1-windows,update to controller must be done after kinematics have been updated by physics engine
v1.8.1-windows,*** End: UpdatableState implementation ***//
v1.8.1-windows,get references of existing camera
v1.8.1-windows,setup clock in PhysX
v1.8.1-windows,-------------------------------- overrides -----------------------------------------------//
v1.8.1-windows,decide which derived BP to use
v1.8.1-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.8.1-windows,Setup suspension forces
v1.8.1-windows,Find the tire object and set the data for it
v1.8.1-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.8.1-windows,Setup suspension forces
v1.8.1-windows,Find the tire object and set the data for it
v1.8.1-windows,Create In-Car camera component
v1.8.1-windows,In car HUD
v1.8.1-windows,Create text render component for in car speed display
v1.8.1-windows,Create text render component for in car gear display
v1.8.1-windows,Setup the audio component and allocate it a sound cue
v1.8.1-windows,Colors for the in-car gear display. One for normal one for reverse
v1.8.1-windows,Wheels/Tires
v1.8.1-windows,Setup the wheels
v1.8.1-windows,Adjust the tire loading
v1.8.1-windows,Engine
v1.8.1-windows,Torque setup
v1.8.1-windows,Adjust the steering
v1.8.1-windows,Transmission
v1.8.1-windows,We want 4wd
v1.8.1-windows,Drive the front wheels a little more than the rear
v1.8.1-windows,Automatic gearbox
v1.8.1-windows,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.8.1-windows,Physics settings
v1.8.1-windows,Adjust the center of mass - the buggy is quite low
v1.8.1-windows,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.8.1-windows,put camera little bit above vehicle
v1.8.1-windows,update physics material
v1.8.1-windows,Update the strings used in the HUD (in-car and on-screen)
v1.8.1-windows,Set the string in the in-car HUD
v1.8.1-windows,Pass the engine RPM to the sound component
v1.8.1-windows,Start an engine sound playing
v1.8.1-windows,Using FText because this is display text that should be localizable
v1.8.1-windows,Setup the text render component strings
v1.8.1-windows,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.8.1-windows,below is not needed
v1.8.1-windows,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.8.1-windows,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.8.1-windows,create vehicle params
v1.8.1-windows,TODO: should do reset() here?
v1.8.1-windows,these are called on render ticks
v1.8.1-windows,TODO: do we need this for cars?
v1.8.1-windows,TODO: move this to SimModeBase?
v1.8.1-windows,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.8.1-windows,reset();
v1.8.1-windows,return;
v1.8.1-windows,}
v1.8.1-windows,Thrustmaster devices
v1.8.1-windows,"Anything else, typically Logitech G920 wheel"
v1.8.1-windows,Two steel levers behind wheel
v1.8.1-windows,if API-client control is not active then we route keyboard/joystick control to car
v1.8.1-windows,all car controls from anywhere must be routed through API component
v1.8.1-windows,*** Start: UpdatableState implementation ***//
v1.8.1-windows,physics tick
v1.8.1-windows,*** End: UpdatableState implementation ***//
v1.8.1-windows,TODO: directly accept getVehicleSimApis() using generic container
v1.8.1-windows,Reset the vehicle as well before registering it
v1.8.1-windows,Similar to what happens in initializeForPlay() above
v1.8.1-windows,remove everything that we created in BeginPlay
v1.8.1-windows,wait if no new frame is renderd
v1.8.1-windows,we use custom debug reporting for this class
v1.8.1-windows,perform any expensive rendering update outside of lock region
v1.8.1-windows,no need to call base reset because of our custom implementation
v1.8.1-windows,TODO: this is going to cause circular references which is fine here but
v1.8.1-windows,in future we should consider moving SimMode not derived from AActor and move
v1.8.1-windows,it to AirLib and directly implement WorldSimApiBase interface
v1.8.1-windows,get player start
v1.8.1-windows,this must be done from within actor otherwise we don't get player start
v1.8.1-windows,Grab player location
v1.8.1-windows,Move the world origin to the player's location (this moves the coordinate system and adds
v1.8.1-windows,a corresponding offset to all positions to compensate for the shift)
v1.8.1-windows,"Regrab the player's position after the offset has been added (which should be 0,0,0 now)"
v1.8.1-windows,UWeatherLib::showWeatherMenu(World);
v1.8.1-windows,else don't init
v1.8.1-windows,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v1.8.1-windows,tod_sim_clock_start_ needs to be reset here.
v1.8.1-windows,Going from enabled to disabled
v1.8.1-windows,do these in the end to ensure that advanceTimeOfDay() doesn't see
v1.8.1-windows,any inconsistent state.
v1.8.1-windows,should be overridden by derived class
v1.8.1-windows,should be overriden by derived class
v1.8.1-windows,should be overridden by derived class
v1.8.1-windows,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.8.1-windows,default setup - this should be overridden in derived modes as needed
v1.8.1-windows,setup clock in ClockFactory
v1.8.1-windows,default implementation
v1.8.1-windows,create director
v1.8.1-windows,create external camera required for the director
v1.8.1-windows,for each camera in settings
v1.8.1-windows,get pose
v1.8.1-windows,spawn and attach camera to pawn
v1.8.1-windows,add on to our collection
v1.8.1-windows,API server start/stop
v1.8.1-windows,get UU origin of global NED frame
v1.8.1-windows,compute initial pose
v1.8.1-windows,spawn vehicle pawn
v1.8.1-windows,create vehicle sim api
v1.8.1-windows,Convert to lowercase as done during settings loading
v1.8.1-windows,TODO: Figure out a better way to add more fields
v1.8.1-windows,Maybe allow passing a JSON string for the vehicle settings?
v1.8.1-windows,"Retroactively adjust AirSimSettings, so it's like we knew about this vehicle all along"
v1.8.1-windows,"Usually physics registration happens at init, in ASimModeWorldBase::initializeForPlay(), but not in this case"
v1.8.1-windows,get UU origin of global NED frame
v1.8.1-windows,determine camera director camera default pose and spawn it
v1.8.1-windows,find all vehicle pawns
v1.8.1-windows,add vehicles from settings
v1.8.1-windows,if vehicle is of type for derived SimMode and auto creatable
v1.8.1-windows,create API objects for each pawn we have
v1.8.1-windows,Create External Cameras
v1.8.1-windows,TODO: better handle no FPV vehicles scenario
v1.8.1-windows,derived class shoudl override this method to add new vehicle to the physics engine
v1.8.1-windows,derived class should override this method to retrieve types of pawns they support
v1.8.1-windows,derived class should override this method to retrieve types of pawns they support
v1.8.1-windows,derived class should override this method to retrieve types of pawns they support
v1.8.1-windows,derived class should override this method to retrieve types of pawns they support
v1.8.1-windows,derived class should override this method to retrieve types of pawns they support
v1.8.1-windows,derived class should override this method to retrieve types of pawns they support
v1.8.1-windows,derived class should override this method to retrieve types of pawns they support
v1.8.1-windows,Draws debug-points on main viewport for Lidar laser hits.
v1.8.1-windows,Used for debugging only.
v1.8.1-windows,Currently we are checking the sensor-collection instead of sensor-settings.
v1.8.1-windows,Also using variables to optimize not checking the collection if not needed.
v1.8.1-windows,TODO: Is it incorrect to assume LidarSimple here?
v1.8.1-windows,Draw debug-point on main viewport for Distance sensor hit
v1.8.1-windows,Find position of point hit
v1.8.1-windows,Similar to UnrealDistanceSensor.cpp#L19
v1.8.1-windows,order of Pose addition is important here because it also adds quaternions which is not commutative!
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,ctor
v1.8.1-windows,initializes information based on lidar configuration
v1.8.1-windows,calculate verticle angle distance between each laser
v1.8.1-windows,store vertical angles for each laser
v1.8.1-windows,returns a point-cloud for the tick
v1.8.1-windows,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.8.1-windows,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.8.1-windows,calculate number of points needed for each laser/channel
v1.8.1-windows,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.8.1-windows,calculate needed angle/distance between each point
v1.8.1-windows,normalize FOV start/end
v1.8.1-windows,shoot lasers
v1.8.1-windows,check if the laser is outside the requested horizontal FOV
v1.8.1-windows,"shoot laser and get the impact point, if any"
v1.8.1-windows,simulate shooting a laser via Unreal ray-tracing.
v1.8.1-windows,start position
v1.8.1-windows,We need to compose rotations here rather than rotate a vector by a quaternion
v1.8.1-windows,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.8.1-windows,get ray quaternion in lidar frame (angles must be in radians)
v1.8.1-windows,get ray quaternion in body frame
v1.8.1-windows,get ray quaternion in world frame
v1.8.1-windows,get ray vector (end position)
v1.8.1-windows,Store the segmentation id of the hit object.
v1.8.1-windows,Debug code for very specific cases.
v1.8.1-windows,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.8.1-windows,decide the frame for the point-cloud
v1.8.1-windows,current detault behavior; though it is probably not very useful.
v1.8.1-windows,not changing the default for now to maintain backwards-compat.
v1.8.1-windows,point in vehicle intertial frame
v1.8.1-windows,tranform to lidar frame
v1.8.1-windows,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.8.1-windows,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.8.1-windows,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.8.1-windows,"On the client side, if it is needed to transform this data back to the world frame,"
v1.8.1-windows,"then do the equivalent of following,"
v1.8.1-windows,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.8.1-windows,See SimModeBase::drawLidarDebugPoints()
v1.8.1-windows,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.8.1-windows,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,update ray tracing
v1.8.1-windows,"FString hit_name = FString(""None"");"
v1.8.1-windows,if (dist_hit.GetActor())
v1.8.1-windows,hit_name=dist_hit.GetActor()->GetName();
v1.8.1-windows,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.8.1-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,This assumes you are running DroneServer already on the same machine.
v1.8.1-windows,DroneServer must be running first.
v1.8.1-windows,enable API control
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,Load gazebo
v1.8.1-windows,Create our node for communication
v1.8.1-windows,Listen to Gazebo topics
v1.8.1-windows,Make sure to shut everything down.
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,move commands
v1.8.1-windows,else leave as it is
v1.8.1-windows,TODO: get these in one call
v1.8.1-windows,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.8.1-windows,TODO: shouldn't we pass folder path?
v1.8.1-windows,parse
v1.8.1-windows,group the images by the current date.
v1.8.1-windows,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.8.1-windows,{
v1.8.1-windows,"return """";"
v1.8.1-windows,}
v1.8.1-windows,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.8.1-windows,{
v1.8.1-windows,return false;
v1.8.1-windows,}
v1.8.1-windows,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.8.1-windows,params.context->client.newTask();
v1.8.1-windows,}
v1.8.1-windows,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.8.1-windows,params.context->client.WaitForCompletion(0);
v1.8.1-windows,}
v1.8.1-windows,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.8.1-windows,{
v1.8.1-windows,}
v1.8.1-windows,parse command line
v1.8.1-windows,Shell callbacks
v1.8.1-windows,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.8.1-windows,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.8.1-windows,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.8.1-windows,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.8.1-windows,Add shell commands
v1.8.1-windows,TODO: add WaitForCompletion command
v1.8.1-windows,"TODO: add command line args help, arg count validation"
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v1.8.1-windows,switch to explicit hover mode so that this is the fall back when
v1.8.1-windows,move* commands are finished.
v1.8.1-windows,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.8.1-windows,TODO: implement weather for Unity
v1.8.1-windows,TODO: implement weather for Unity
v1.8.1-windows,----------------Plotting APIs-----------/
v1.8.1-windows,Recording APIs
v1.8.1-windows,"Remove '' from the list, representing default vehicle"
v1.8.1-windows,CinemAirSim
v1.8.1-windows,End CinemAirSim
v1.8.1-windows,Function pointers to hold the addresses of the functions that are defined in Unity
v1.8.1-windows,"Enabling all LogLevels,"
v1.8.1-windows,"Enabling all LogLevels,"
v1.8.1-windows,delete ltm;
v1.8.1-windows,initialize state
v1.8.1-windows,compute our home point
v1.8.1-windows,default behavior is to call update every tick
v1.8.1-windows,"for custom physics engine, this method should be overridden and update should be"
v1.8.1-windows,called from every physics tick
v1.8.1-windows,these will be available for devices like steering wheels
v1.8.1-windows,sync environment from kinematics
v1.8.1-windows,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.8.1-windows,FVector unrealPosition = getUUPosition();
v1.8.1-windows,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v1.8.1-windows,parameters in NED frame
v1.8.1-windows,allow teleportation
v1.8.1-windows,if collisions are not enabled
v1.8.1-windows,or we have collided but passthrough is enabled
v1.8.1-windows,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.8.1-windows,"without flip flopping, collisions can't be detected"
v1.8.1-windows,by default we update kinematics from UE pawn
v1.8.1-windows,if SimMod uses its own physics engine then this should be overriden
v1.8.1-windows,no default action in this base class
v1.8.1-windows,TODO: because this bug we are using alternative code with stringstream
v1.8.1-windows,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.8.1-windows,update kinematics from pawn's movement instead of physics engine
v1.8.1-windows,TODO: update other fields?
v1.8.1-windows,implements getImages() method in the ImageCaptureBase class.
v1.8.1-windows,update ray tracing
v1.8.1-windows,Attempts to parse the settings text from one of multiple locations.
v1.8.1-windows,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.8.1-windows,"Next, check the executable's working directory for the settings file."
v1.8.1-windows,"Finally, check the user's documents folder."
v1.8.1-windows,"If the settings file cannot be read, throw an exception"
v1.8.1-windows,let base class setup physics world
v1.8.1-windows,stop physics thread before we dismantle
v1.8.1-windows,setup clock in ClockFactory
v1.8.1-windows,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.8.1-windows,steppable clock returns interval that is a constant number irrespective of wall clock
v1.8.1-windows,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.8.1-windows,but that would cause vehicles like quadrotors to become unstable
v1.8.1-windows,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.8.1-windows,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.8.1-windows,get increase in clock speed
v1.8.1-windows,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.8.1-windows,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.8.1-windows,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.8.1-windows,Approach 2: scale control loop frequency if clock is speeded up
v1.8.1-windows,"for slowing down, this don't generate instability"
v1.8.1-windows,-------------------------------- overrides -----------------------------------------------//
v1.8.1-windows,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.8.1-windows,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.8.1-windows,create vehicle API
v1.8.1-windows,setup physics vehicle
v1.8.1-windows,initialize private vars
v1.8.1-windows,"if reset is pending then do it first, no need to do other things until next tick"
v1.8.1-windows,move collision info from rendering engine to vehicle
v1.8.1-windows,update rotor poses
v1.8.1-windows,if we did reset then don't worry about synchronizing states for this tick
v1.8.1-windows,Continue to wait for reset
v1.8.1-windows,*** Start: UpdatableState implementation ***//
v1.8.1-windows,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.8.1-windows,environment update for current position
v1.8.1-windows,update forces on vertices
v1.8.1-windows,update to controller must be done after kinematics have been updated by physics engine
v1.8.1-windows,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.8.1-windows,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.8.1-windows,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.8.1-windows,*** End: UpdatableState implementation ***//
v1.8.1-windows,TODO: should do reset() here?
v1.8.1-windows,these are called on render ticks
v1.8.1-windows,TODO: do we need this for cars?
v1.8.1-windows,Thrustmaster devices
v1.8.1-windows,"Anything else, typically Logitech G920 wheel"
v1.8.1-windows,Two steel levers behind wheel
v1.8.1-windows,if API-client control is not active then we route keyboard/joystick control to car
v1.8.1-windows,This is so that getCarControls API works correctly
v1.8.1-windows,"API is enabled, so we use the controls set by API"
v1.8.1-windows,Update whether to use API controls or keyboard controls
v1.8.1-windows,*** Start: UpdatableState implementation ***//
v1.8.1-windows,physics tick
v1.8.1-windows,void CarPawnSimApi::reportState(StateReporter& reporter)
v1.8.1-windows,{
v1.8.1-windows,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.8.1-windows,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.8.1-windows,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.8.1-windows,}
v1.8.1-windows,*** End: UpdatableState implementation ***//
v1.8.1-windows,remove everything that we created in BeginPlay
v1.8.1-windows,we use custom debug reporting for this class
v1.8.1-windows,perform any expensive rendering update outside of lock region
v1.8.1-windows,no need to call base reset because of our custom implementation
v1.8.1-windows,should be overridden by derived class
v1.8.1-windows,should be overridden by derived class
v1.8.1-windows,should be overridden by derived class
v1.8.1-windows,commenting this out for now to avoid unintentional Unity startup failure
v1.8.1-windows,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v1.8.1-windows,should be overridden by derived class
v1.8.1-windows,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.8.1-windows,default setup - this should be overridden in derived modes as needed
v1.8.1-windows,setup clock in ClockFactory
v1.8.1-windows,API server start/stop
v1.8.1-windows,determine camera director camera default pose and spawn it
v1.8.1-windows,derived class should override this method to retrieve types of pawns they support
v1.8.1-windows,derived class should override this method to retrieve types of pawns they support
v1.8.1-windows,can we just take origin in Unity here?
v1.8.1-windows,60 acres park:
v1.8.1-windows,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.8.1-windows,marymoore park
v1.8.1-windows,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.8.1-windows,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.8.1-windows,DepthNavThreshold depthNav;
v1.8.1-windows,DepthNavOptAStar depthNav;
v1.8.1-windows,DepthNavThreshold depthNav;
v1.8.1-windows,DepthNavOptAStar depthNav;
v1.8.1-windows,runDepthNavGT();
v1.8.1-windows,runDepthNavSGM();
v1.8.1-windows,Create the launch description and populate
v1.8.1-windows,Declare the launch options
v1.8.1-windows,todo do not reset if already in air?
v1.8.1-windows,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.8.1-windows,ros params
v1.8.1-windows,todo enforce dynamics constraints in this node as well?
v1.8.1-windows,"nh_->get_parameter(""max_vert_vel_"", max_vert_vel_);"
v1.8.1-windows,"nh_->get_parameter(""max_horz_vel"", max_horz_vel_)"
v1.8.1-windows,subscribe to control commands on global nodehandle
v1.8.1-windows,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.8.1-windows,bind to a single callback. todo optimal subs queue length
v1.8.1-windows,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.8.1-windows,"vehicle_ros.reset_srvr = nh_->create_service(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.8.1-windows,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.8.1-windows,camera_setting.gimbal
v1.8.1-windows,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.8.1-windows,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.8.1-windows,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.8.1-windows,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.8.1-windows,"if {DepthPlanar, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.8.1-windows,"push back pair (vector of image captures, current vehicle name)"
v1.8.1-windows,iterate over sensors
v1.8.1-windows,add takeoff and land all services if more than 2 drones
v1.8.1-windows,todo add per vehicle reset in AirLib API
v1.8.1-windows,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.8.1-windows,lidars update on their own callback/thread at a given rate
v1.8.1-windows,QoS - The depth of the publisher message queue.
v1.8.1-windows,more details here - https://docs.ros.org/en/foxy/Concepts/About-Quality-of-Service-Settings.html
v1.8.1-windows,"todo: error check. if state is not landed, return error."
v1.8.1-windows,response->success =
v1.8.1-windows,response->success =
v1.8.1-windows,response->success =
v1.8.1-windows,response->success =
v1.8.1-windows,response->success =
v1.8.1-windows,response->success =
v1.8.1-windows,todo add reset by vehicle_name API to airlib
v1.8.1-windows,todo not async remove wait_on_last_task
v1.8.1-windows,todo expose wait_on_last_task or nah?
v1.8.1-windows,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.8.1-windows,todo expose wait_on_last_task or nah?
v1.8.1-windows,todo support multiple gimbal commands
v1.8.1-windows,todo support multiple gimbal commands
v1.8.1-windows,1. find quaternion of default gimbal pose
v1.8.1-windows,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.8.1-windows,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.8.1-windows,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.8.1-windows,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.8.1-windows,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.8.1-windows,msg = []
v1.8.1-windows,todo covariances
v1.8.1-windows,gps_msg.position_covariance_type =
v1.8.1-windows,gps_msg.position_covariance =
v1.8.1-windows,todo covariances
v1.8.1-windows,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.8.1-windows,todo radians per second
v1.8.1-windows,meters/s2^m
v1.8.1-windows,imu_msg.orientation_covariance = ;
v1.8.1-windows,imu_msg.angular_velocity_covariance = ;
v1.8.1-windows,imu_msg.linear_acceleration_covariance = ;
v1.8.1-windows,todo do actual body frame?
v1.8.1-windows,airsim uses degrees
v1.8.1-windows,todo this is global origin
v1.8.1-windows,get the basic vehicle pose and environmental state
v1.8.1-windows,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.8.1-windows,airsim_client needs to provide the simulation time in a future version of the API
v1.8.1-windows,publish the simulation clock
v1.8.1-windows,"publish vehicle state, odom, and all basic sensor types"
v1.8.1-windows,send any commands out to the vehicles
v1.8.1-windows,"should be easier way to get the sim time through API, something like:"
v1.8.1-windows,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.8.1-windows,curr_ros_time = rclcpp::Time(env.clock().nowNanos());
v1.8.1-windows,iterate over drones
v1.8.1-windows,get drone state from airsim
v1.8.1-windows,"vehicle environment, we can get ambient temperature here and other truths"
v1.8.1-windows,convert airsim drone state to ROS msgs
v1.8.1-windows,simulation environment truth
v1.8.1-windows,"dashboard reading from car, RPM, gear, etc"
v1.8.1-windows,odom and transforms
v1.8.1-windows,ground truth GPS position from sim/HITL
v1.8.1-windows,send control commands from the last callback to airsim
v1.8.1-windows,send control commands from the last callback to airsim
v1.8.1-windows,"Only camera rotation, no translation movement of camera"
v1.8.1-windows,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.8.1-windows,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.8.1-windows,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.8.1-windows,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.8.1-windows,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.8.1-windows,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.8.1-windows,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.8.1-windows,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.8.1-windows,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.8.1-windows,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.8.1-windows,update timestamp of saved cam info msgs
v1.8.1-windows,DepthPlanar / DepthPerspective / DepthVis / DisparityNormalized
v1.8.1-windows,Scene / Segmentation / SurfaceNormals / Infrared
v1.8.1-windows,publish camera transforms
v1.8.1-windows,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.8.1-windows,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.8.1-windows,ROS params
v1.8.1-windows,ROS publishers
v1.8.1-windows,ROS subscribers
v1.8.1-windows,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.8.1-windows,ROS timers
v1.8.1-windows,todo maintain internal representation as eigen vec?
v1.8.1-windows,todo check if low velocity if within thresh?
v1.8.1-windows,todo maintain separate errors for XY and Z
v1.8.1-windows,todo save this in degrees somewhere to avoid repeated conversion
v1.8.1-windows,this tells the update timer callback to not do active hovering
v1.8.1-windows,todo maintain array of position goals
v1.8.1-windows,todo error checks
v1.8.1-windows,todo fill response
v1.8.1-windows,"Already have goal, and have reached it"
v1.8.1-windows,this tells the update timer callback to not do active hovering
v1.8.1-windows,todo error checks
v1.8.1-windows,todo fill response
v1.8.1-windows,"todo do relative altitude, or add an option for the same?"
v1.8.1-windows,convert GPS goal to NED goal
v1.8.1-windows,"RCLCPP_INFO_STREAM(""geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.8.1-windows,todo error checks
v1.8.1-windows,todo fill response
v1.8.1-windows,"Already have goal, this shouldn't happen"
v1.8.1-windows,"todo do relative altitude, or add an option for the same?"
v1.8.1-windows,convert GPS goal to NED goal
v1.8.1-windows,"RCLCPP_INFO_STREAM(""geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.8.1-windows,todo error checks
v1.8.1-windows,todo fill response
v1.8.1-windows,todo check if odometry is too old!!
v1.8.1-windows,"if no odom, don't do anything."
v1.8.1-windows,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.8.1-windows,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.8.1-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.8.1-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.8.1-windows,todo yaw limits
v1.8.1-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.8.1-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.8.1-windows,mimics void ASimHUD::initializeSettings()
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,by Sudipta Sinha
v1.8.1-windows,adapted for AirSim by Matthias Mueller
v1.8.1-windows,first row
v1.8.1-windows,last row
v1.8.1-windows,Local quadratic fit of cost and subpixel refinement.
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,by Sudipta Sinha
v1.8.1-windows,adapted for AirSim by Matthias Mueller
v1.8.1-windows,uint64_t x64 = (uint64_t)x;
v1.8.1-windows,uint64_t y64 = (uint64_t)y;
v1.8.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1-windows,Licensed under the MIT License.
v1.8.1-windows,by Sudipta Sinha
v1.8.1-windows,adapted for AirSim by Matthias Mueller
v1.8.1-windows,ensure that disparity range is a multiple of 8
v1.8.1-windows,sgm stereo
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,read settings and override defaults
v1.8.1,allow json overrides on a per-vehicle basis.
v1.8.1,start server in async mode
v1.8.1,check messages
v1.8.1,plot red arrows for 30 seconds
v1.8.1,plot magenta arrows for 15 seconds
v1.8.1,plot red arrows for 10 seconds
v1.8.1,plot 2 white arrows which are persistent
v1.8.1,plot points
v1.8.1,"plot line strip. 0-1, 1-2, 2-3"
v1.8.1,"plot line list. 0-1, 2-3, 4-5. Must be even."
v1.8.1,plot transforms
v1.8.1,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=0.0, yaw=yaw)) for x, y, yaw in zip(np.linspace(0,10,10), np.linspace(0,0,10), np.linspace(0,np.pi,10))],"
v1.8.1,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.8.1,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=roll, yaw=0.0)) for x, y, roll in zip(np.linspace(0,10,10), np.linspace(1,1,10), np.linspace(0,np.pi,10))],"
v1.8.1,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.8.1,Access an existing light in the world
v1.8.1,Destroy the light
v1.8.1,Create a new light at the same pose
v1.8.1,Change the light's intensity
v1.8.1,asset_name = random.choice(assets)
v1.8.1,Import this module to automatically setup path to local airsim module
v1.8.1,This module first tries to see if airsim module is installed via pip
v1.8.1,If it does then we don't do anything else
v1.8.1,Else we look up grand-parent folder to see if it has airsim folder
v1.8.1,and if it does then we add that in sys.path
v1.8.1,this class simply tries to see if airsim
v1.8.1,if airsim module is installed then don't do anything else
v1.8.1,import pkgutil
v1.8.1,airsim_loader = pkgutil.find_loader('airsim')
v1.8.1,if airsim_loader is not None:
v1.8.1,return
v1.8.1,In settings.json first activate computer vision mode:
v1.8.1,https://github.com/Microsoft/AirSim/blob/main/docs/image_apis.md#computer-vision-mode
v1.8.1,monitor car state while you drive it manually.
v1.8.1,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v1.8.1,denominator from microns^3 to microns * m^2)
v1.8.1,First set everything to 0.
v1.8.1,Next set all objects of interest provided to corresponding object IDs
v1.8.1,segIdDict values MUST match tempEmissivityNew labels.
v1.8.1,"Connect to AirSim, UAV mode."
v1.8.1,Choose temperature values for winter or summer.
v1.8.1,""""""""
v1.8.1,winter
v1.8.1,""""""""
v1.8.1,summer
v1.8.1,Read camera response.
v1.8.1,Calculate radiance.
v1.8.1,Set IDs in AirSim environment.
v1.8.1,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.8.1,save pic
v1.8.1,Change the below dimensions appropriately for the camera settings
v1.8.1,In settings.json first activate computer vision mode:
v1.8.1,https://github.com/Microsoft/AirSim/blob/main/docs/image_apis.md#computer-vision-mode
v1.8.1,"define abstract class to return next vector in the format (x,y,yaw)"
v1.8.1,"compute vector, distance and angle to goal"
v1.8.1,compute box of interest
v1.8.1,scale by weight matrix (optional)
v1.8.1,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.8.1,detect collision
v1.8.1,compute box of interest
v1.8.1,detect collision
v1.8.1,Same as above but decide to go left or right based on average or some metric like that
v1.8.1,"compute resultant normalized vector, distance and angle"
v1.8.1,compute bounding box size
v1.8.1,convert horizonal fov to vertical fov
v1.8.1,matrix with all ones
v1.8.1,matrix with max weight in center and decreasing linearly with distance from center
v1.8.1,matrix with max weight in center and decreasing quadratically with distance from center
v1.8.1,"print (""Saving images to %s"" % tmp_dir)"
v1.8.1,airsim.wait_key('Press any key to start')
v1.8.1,"Define start position, goal and size of UAV"
v1.8.1,Define parameters and thresholds
v1.8.1,initial position
v1.8.1,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.8.1,time.sleep(1)
v1.8.1,get response
v1.8.1,get numpy array
v1.8.1,reshape array to 2D array H X W
v1.8.1,write to png
v1.8.1,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.8.1,pose = client.simGetPose()
v1.8.1,pp.pprint(pose)
v1.8.1,time.sleep(5)
v1.8.1,currently reset() doesn't work in CV mode. Below is the workaround
v1.8.1,################### OLD CODE
v1.8.1,timer = 0
v1.8.1,time_obs = 50
v1.8.1,bObstacle = False
v1.8.1,if (bObstacle):
v1.8.1,timer = timer + 1
v1.8.1,if timer > time_obs:
v1.8.1,bObstacle = False
v1.8.1,timer = 0
v1.8.1,else:
v1.8.1,yaw = target_angle
v1.8.1,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.8.1,if (np.average(img2d_box) < coll_thres):
v1.8.1,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.8.1,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.8.1,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.8.1,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.8.1,"print('left: ', img2d_box_l_avg)"
v1.8.1,"print('right: ', img2d_box_r_avg)"
v1.8.1,if img2d_box_l_avg > img2d_box_r_avg:
v1.8.1,##Go LEFT
v1.8.1,#y_offset = y_offset-1
v1.8.1,yaw = yaw - radians(10)
v1.8.1,bObstacle = True
v1.8.1,else:
v1.8.1,##Go RIGHT
v1.8.1,#y_offset = y_offset+1
v1.8.1,yaw = yaw + radians(10)
v1.8.1,bObstacle = true
v1.8.1,"print('yaw: ', yaw)"
v1.8.1,In settings.json first activate computer vision mode:
v1.8.1,https://github.com/Microsoft/AirSim/blob/main/docs/image_apis.md#computer-vision-mode
v1.8.1,currently reset() doesn't work in CV mode. Below is the workaround
v1.8.1,requires Python 3.5.3 :: Anaconda 4.4.0
v1.8.1,pip install opencv-python
v1.8.1,Just change the below to test different cameras easily!
v1.8.1,Test Camera info
v1.8.1,Test Image APIs
v1.8.1,Test FoV API
v1.8.1,Test Pose APIs
v1.8.1,Test Distortion params APIs
v1.8.1,In settings.json first activate computer vision mode:
v1.8.1,https://github.com/Microsoft/AirSim/blob/main/docs/image_apis.md#computer-vision-mode
v1.8.1,In settings.json first activate computer vision mode:
v1.8.1,https://github.com/Microsoft/AirSim/blob/main/docs/image_apis.md#computer-vision-mode
v1.8.1,for block environment
v1.8.1,regex are case insensitive
v1.8.1,#for neighborhood environment
v1.8.1,set object ID for sky
v1.8.1,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.8.1,get segmentation image in various formats
v1.8.1,save segmentation images in various formats
v1.8.1,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.8.1,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.8.1,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v1.8.1,find unique colors
v1.8.1,In settings.json first activate computer vision mode:
v1.8.1,https://github.com/Microsoft/AirSim/blob/main/docs/image_apis.md#computer-vision-mode
v1.8.1,objects can be named in two ways:
v1.8.1,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.8.1,default name is auto-generated and varies from run-to-run.
v1.8.1,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.8.1,
v1.8.1,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.8.1,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.8.1,https://answers.unrealengine.com/revisions/790629.html
v1.8.1,below works in Blocks environment
v1.8.1,------------------------------------ Get current pose ------------------------------------------------
v1.8.1,search object by name:
v1.8.1,search another object by tag
v1.8.1,search non-existent object
v1.8.1,------------------------------------ Set new pose ------------------------------------------------
v1.8.1,here we move with teleport enabled so collisions are ignored
v1.8.1,here we move with teleport enabled so collisions are not ignored
v1.8.1,move non-existent object
v1.8.1,------------------------------------ Get new pose ------------------------------------------------
v1.8.1,search another object by tag
v1.8.1,search non-existent object
v1.8.1,Import this module to automatically setup path to local airsim module
v1.8.1,This module first tries to see if airsim module is installed via pip
v1.8.1,If it does then we don't do anything else
v1.8.1,Else we look up grand-parent folder to see if it has airsim folder
v1.8.1,and if it does then we add that in sys.path
v1.8.1,this class simply tries to see if airsim
v1.8.1,if airsim module is installed then don't do anything else
v1.8.1,import pkgutil
v1.8.1,airsim_loader = pkgutil.find_loader('airsim')
v1.8.1,if airsim_loader is not None:
v1.8.1,return
v1.8.1,"Roll is applied first, then pitch, then yaw."
v1.8.1,Turn the camera position into a column vector.
v1.8.1,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v1.8.1,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v1.8.1,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v1.8.1,Recreate the perspective projection of the camera.
v1.8.1,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v1.8.1,Set pose and sleep after to ensure the pose sticks before capturing image.
v1.8.1,Capture segmentation (IR) and scene images.
v1.8.1,Change images into numpy arrays.
v1.8.1,Capture images for a certain amount of time in seconds (half hour now)
v1.8.1,Capture image - pose.position x_val access may change w/ AirSim
v1.8.1,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v1.8.1,Convert color scene image to BGR for write out with cv2.
v1.8.1,"Connect to AirSim, UAV mode."
v1.8.1,Look for objects with names that match a regular expression.
v1.8.1,"Sample calls to main, varying camera angle and altitude."
v1.8.1,"straight down, 400ft"
v1.8.1,"straight down, 200ft"
v1.8.1,"45 degrees, 200ft -- note that often object won't be scene since position"
v1.8.1,is set exactly to object's
v1.8.1,"45 degrees, 400ft -- note that often object won't be scene since position"
v1.8.1,is set exactly to object's
v1.8.1,In settings.json first activate computer vision mode:
v1.8.1,https://github.com/Microsoft/AirSim/blob/main/docs/image_apis.md#computer-vision-mode
v1.8.1,xn = 1 + x*5  # some random number
v1.8.1,currently reset() doesn't work in CV mode. Below is the workaround
v1.8.1,connect to the AirSim simulator
v1.8.1,monitor car state while you drive it manually.
v1.8.1,get state of the car
v1.8.1,connect to the AirSim simulator
v1.8.1,!/usr/bin/env python3
v1.8.1,-*- coding: utf-8 -*-
v1.8.1,connect to the AirSim simulator
v1.8.1,set the controls for car
v1.8.1,let car drive a bit
v1.8.1,connect to the AirSim simulator
v1.8.1,go forward
v1.8.1,get state of the car
v1.8.1,Python client example to change time-of-day using APIs
v1.8.1,
v1.8.1,Changes time of the day and makes the car move around
v1.8.1,connect to the AirSim simulator
v1.8.1,flip between specific time and default time
v1.8.1,go forward
v1.8.1,Go forward + steer right
v1.8.1,main
v1.8.1,connect to the AirSim simulator
v1.8.1,get state of the car
v1.8.1,go forward
v1.8.1,Go forward + steer right
v1.8.1,go reverse
v1.8.1,apply brakes
v1.8.1,get camera images from the car
v1.8.1,restore to original state
v1.8.1,connect to the AirSim simulator
v1.8.1,go forward
v1.8.1,Python client example to get Lidar data from a car
v1.8.1,
v1.8.1,Makes the drone fly and get Lidar data
v1.8.1,connect to the AirSim simulator
v1.8.1,"print(""state: %s"" % s)"
v1.8.1,go forward
v1.8.1,Go forward + steer right
v1.8.1,"reshape array of floats to array of [X,Y,Z]"
v1.8.1,TODO
v1.8.1,main
v1.8.1,connect to the AirSim simulator
v1.8.1,get state of the car
v1.8.1,go forward
v1.8.1,Go forward + steer right
v1.8.1,go reverse
v1.8.1,apply breaks
v1.8.1,restore to original state
v1.8.1,Sleep for some time to wait for other vehicles to be created
v1.8.1,"driveCar(vehicle_name, client)"
v1.8.1,go forward
v1.8.1,Go forward + steer right
v1.8.1,go reverse
v1.8.1,apply brakes
v1.8.1,Import this module to automatically setup path to local airsim module
v1.8.1,This module first tries to see if airsim module is installed via pip
v1.8.1,If it does then we don't do anything else
v1.8.1,Else we look up grand-parent folder to see if it has airsim folder
v1.8.1,and if it does then we add that in sys.path
v1.8.1,this class simply tries to see if airsim
v1.8.1,if airsim module is installed then don't do anything else
v1.8.1,import pkgutil
v1.8.1,airsim_loader = pkgutil.find_loader('airsim')
v1.8.1,if airsim_loader is not None:
v1.8.1,return
v1.8.1,Use below in settings.json with blocks environment
v1.8.1,connect to the AirSim simulator
v1.8.1,get state of the car
v1.8.1,go forward
v1.8.1,go reverse
v1.8.1,apply breaks
v1.8.1,get camera images from the car
v1.8.1,restore to original state
v1.8.1,from keras.models import load_model
v1.8.1,if (len(sys.argv) != 2):
v1.8.1,print('usage: python drive.py <modelName>')
v1.8.1,sys.exit()
v1.8.1,print('Loading model...')
v1.8.1,model = load_model(sys.argv[1])
v1.8.1,connect to the AirSim simulator
v1.8.1,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.8.1,"model_output = model.predict([image_buf, state_buf])"
v1.8.1,car_controls.steering = float(model_output[0][0])
v1.8.1,connect to the AirSim simulator
v1.8.1,set camera name and image type to request images and detections
v1.8.1,set detection radius in [cm]
v1.8.1,add desired object name to detect in wild card/regex format
v1.8.1,Import this module to automatically setup path to local airsim module
v1.8.1,This module first tries to see if airsim module is installed via pip
v1.8.1,If it does then we don't do anything else
v1.8.1,Else we look up grand-parent folder to see if it has airsim folder
v1.8.1,and if it does then we add that in sys.path
v1.8.1,this class simply tries to see if airsim
v1.8.1,if airsim module is installed then don't do anything else
v1.8.1,import pkgutil
v1.8.1,airsim_loader = pkgutil.find_loader('airsim')
v1.8.1,if airsim_loader is not None:
v1.8.1,return
v1.8.1,-*- coding: utf-8 -*-
v1.8.1,
v1.8.1,Configuration file for the Sphinx documentation builder.
v1.8.1,
v1.8.1,This file does only contain a selection of the most common options. For a
v1.8.1,full list see the documentation:
v1.8.1,http://www.sphinx-doc.org/en/master/config
v1.8.1,-- Path setup --------------------------------------------------------------
v1.8.1,"If extensions (or modules to document with autodoc) are in another directory,"
v1.8.1,add these directories to sys.path here. If the directory is relative to the
v1.8.1,"documentation root, use os.path.abspath to make it absolute, like shown here."
v1.8.1,
v1.8.1,-- Project information -----------------------------------------------------
v1.8.1,The short X.Y version
v1.8.1,"The full version, including alpha/beta/rc tags"
v1.8.1,-- General configuration ---------------------------------------------------
v1.8.1,"If your documentation needs a minimal Sphinx version, state it here."
v1.8.1,
v1.8.1,needs_sphinx = '1.0'
v1.8.1,"Add any Sphinx extension module names here, as strings. They can be"
v1.8.1,extensions coming with Sphinx (named 'sphinx.ext.*') or your custom
v1.8.1,ones.
v1.8.1,"Add any paths that contain templates here, relative to this directory."
v1.8.1,The suffix(es) of source filenames.
v1.8.1,You can specify multiple suffix as a list of string:
v1.8.1,
v1.8.1,"source_suffix = ['.rst', '.md']"
v1.8.1,The master toctree document.
v1.8.1,The language for content autogenerated by Sphinx. Refer to documentation
v1.8.1,for a list of supported languages.
v1.8.1,
v1.8.1,This is also used if you do content translation via gettext catalogs.
v1.8.1,"Usually you set ""language"" from the command line for these cases."
v1.8.1,"List of patterns, relative to source directory, that match files and"
v1.8.1,directories to ignore when looking for source files.
v1.8.1,This pattern also affects html_static_path and html_extra_path.
v1.8.1,The name of the Pygments (syntax highlighting) style to use.
v1.8.1,-- Options for HTML output -------------------------------------------------
v1.8.1,The theme to use for HTML and HTML Help pages.  See the documentation for
v1.8.1,a list of builtin themes.
v1.8.1,
v1.8.1,html_theme = 'alabaster'
v1.8.1,Theme options are theme-specific and customize the look and feel of a theme
v1.8.1,"further.  For a list of options available for each theme, see the"
v1.8.1,documentation.
v1.8.1,
v1.8.1,html_theme_options = {}
v1.8.1,"Add any paths that contain custom static files (such as style sheets) here,"
v1.8.1,"relative to this directory. They are copied after the builtin static files,"
v1.8.1,"so a file named ""default.css"" will overwrite the builtin ""default.css""."
v1.8.1,"Custom sidebar templates, must be a dictionary that maps document names"
v1.8.1,to template names.
v1.8.1,
v1.8.1,The default sidebars (for documents that don't match any pattern) are
v1.8.1,defined by theme itself.  Builtin themes are using these templates by
v1.8.1,"default: ``['localtoc.html', 'relations.html', 'sourcelink.html',"
v1.8.1,'searchbox.html']``.
v1.8.1,
v1.8.1,html_sidebars = {}
v1.8.1,-- Options for HTMLHelp output ---------------------------------------------
v1.8.1,Output file base name for HTML help builder.
v1.8.1,-- Options for LaTeX output ------------------------------------------------
v1.8.1,The paper size ('letterpaper' or 'a4paper').
v1.8.1,
v1.8.1,"'papersize': 'letterpaper',"
v1.8.1,"The font size ('10pt', '11pt' or '12pt')."
v1.8.1,
v1.8.1,"'pointsize': '10pt',"
v1.8.1,Additional stuff for the LaTeX preamble.
v1.8.1,
v1.8.1,"'preamble': '',"
v1.8.1,Latex figure (float) alignment
v1.8.1,
v1.8.1,"'figure_align': 'htbp',"
v1.8.1,Grouping the document tree into LaTeX files. List of tuples
v1.8.1,"(source start file, target name, title,"
v1.8.1,"author, documentclass [howto, manual, or own class])."
v1.8.1,-- Options for manual page output ------------------------------------------
v1.8.1,One entry per manual page. List of tuples
v1.8.1,"(source start file, name, description, authors, manual section)."
v1.8.1,-- Options for Texinfo output ----------------------------------------------
v1.8.1,Grouping the document tree into Texinfo files. List of tuples
v1.8.1,"(source start file, target name, title, author,"
v1.8.1,"dir menu entry, description, category)"
v1.8.1,-- Options for Epub output -------------------------------------------------
v1.8.1,Bibliographic Dublin Core info.
v1.8.1,The unique identifier of the text. This can be a ISBN number
v1.8.1,or the project homepage.
v1.8.1,
v1.8.1,epub_identifier = ''
v1.8.1,A unique identification for the text.
v1.8.1,
v1.8.1,epub_uid = ''
v1.8.1,A list of files that should not be packed into the epub file.
v1.8.1,-- Extension configuration -------------------------------------------------
v1.8.1,-- Options for intersphinx extension ---------------------------------------
v1.8.1,Example configuration for intersphinx: refer to the Python standard library.
v1.8.1,-- Options for todo extension ----------------------------------------------
v1.8.1,"If true, `todo` and `todoList` produce output, else they produce nothing."
v1.8.1,We ignore the 2D nature of the problem as it is not relevant here
v1.8.1,It makes multi-core processing more straightforward
v1.8.1,Allocations
v1.8.1,Add small number to avoid issues with log(I)
v1.8.1,Event sim keeps track of previous image automatically
v1.8.1,"Using pickle dump in a per-frame fashion to save time, instead of savetxt"
v1.8.1,Optimizations possible
v1.8.1,connect to the AirSim simulator
v1.8.1,connect to the AirSim simulator
v1.8.1,that's enough fun for now. let's quit cleanly
v1.8.1,"Python client example to get Lidar data from a drone, although this script works for any AirSim-supported vehicle"
v1.8.1,This script is for Lidar sensors using 'SensorLocalFrame' as DataFrame under settings.json.
v1.8.1,Sample settings.json used for this script:
v1.8.1,connect to the AirSim simulator
v1.8.1,main
v1.8.1,connect to the AirSim simulator
v1.8.1,MultirotorClient.wait_key('Press any key to takeoff')
v1.8.1,connect to the AirSim simulator
v1.8.1,get camera images from the car
v1.8.1,that's enough fun for now. let's quit cleanly
v1.8.1,##################################################################################################
v1.8.1,
v1.8.1,Project:  Embedded Learning Library (ELL)
v1.8.1,File:     speaker.py
v1.8.1,Authors:  Chris Lovett
v1.8.1,
v1.8.1,Requires: Python 3.x
v1.8.1,
v1.8.1,##################################################################################################
v1.8.1,open speakers so we can hear what it is processing...
v1.8.1,teleport the drone + 10 meters in x-direction
v1.8.1,teleport the drone back
v1.8.1,This example shows how to use the External Physics Engine
v1.8.1,It allows you to control the drone through setVehiclePose and obtain collision information.
v1.8.1,It is especially useful for injecting your own flight dynamics model to the AirSim drone.
v1.8.1,Use Blocks environment to see the drone colliding and seeing the collision information
v1.8.1,in the command prompt.
v1.8.1,Add this line to your settings.json before running AirSim:
v1.8.1,"""PhysicsEngineName"":""ExternalPhysicsEngine"""
v1.8.1,use open cv to create point cloud from depth image.
v1.8.1,###########################################
v1.8.1,######### This is work in progress! #######
v1.8.1,###########################################
v1.8.1,file will be saved in PythonClient folder (i.e. same folder as script)
v1.8.1,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.8.1,skip it
v1.8.1,AirSim uses NED coordinates so negative axis is up.
v1.8.1,z of -7 is 7 meters above the original launch point.
v1.8.1,Fly given velocity vector for 5 seconds
v1.8.1,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.8.1,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.8.1,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.8.1,Make the drone fly in a circle.
v1.8.1,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.8.1,check that our home position is stable
v1.8.1,AirSim uses NED coordinates so negative axis is up.
v1.8.1,ramp up time
v1.8.1,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.8.1,compute current angle
v1.8.1,compute lookahead
v1.8.1,if we did the takeoff then also do the landing.
v1.8.1,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.8.1,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.8.1,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.8.1,ignore the click over from 360 back to 0
v1.8.1,watch direction this diff is moving if it switches from shrinking to growing
v1.8.1,then we passed the starting point.
v1.8.1,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.8.1,AirSim uses NED coordinates so negative axis is up.
v1.8.1,z of -5 is 5 meters above the original launch point.
v1.8.1,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.8.1,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.8.1,drone will over-shoot so we bring it back to the start point before landing.
v1.8.1,"Python client example to get Lidar data from a drone, although this script works for any AirSim-supported vehicle"
v1.8.1,This script is for Lidar sensors using 'VehicleInertialFrame' as DataFrame under settings.json
v1.8.1,Sample settings.json used for this script:
v1.8.1,connect to the AirSim simulator
v1.8.1,main
v1.8.1,Run this script with clock speed in settings.json
v1.8.1,"""ClockSpeed"": 1 then change it to 0.5"
v1.8.1,connect to the AirSim simulator
v1.8.1,with ClockSpeed = 0.5 you will see that this takes 6s (system time) and not 3s
v1.8.1,with ClockSpeed = 0.5 you will see that this takes 10s (system time)
v1.8.1,and not 5s in each iteration
v1.8.1,that's enough fun for now. let's quit cleanly
v1.8.1,Takeoff or hover
v1.8.1,Set wind to 0
v1.8.1,Takeoff or hover
v1.8.1,In settings.json first activate computer vision mode:
v1.8.1,https://github.com/Microsoft/AirSim/blob/main/docs/image_apis.md#computer-vision-mode
v1.8.1,requires Python 3.5.3 :: Anaconda 4.4.0
v1.8.1,pip install opencv-python
v1.8.1,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.8.1,fly for 2 minutes
v1.8.1,more than 50 centimeter drift is unacceptable.
v1.8.1,Python client example to get Lidar data from a drone
v1.8.1,
v1.8.1,Makes the drone fly and get Lidar data
v1.8.1,connect to the AirSim simulator
v1.8.1,"print(""state: %s"" % s)"
v1.8.1,"print(""state: %s"" % pprint.pformat(state))"
v1.8.1,"reshape array of floats to array of [X,Y,Z]"
v1.8.1,TODO
v1.8.1,main
v1.8.1,connect to the AirSim simulator
v1.8.1,AirSim uses NED coordinates so negative axis is up.
v1.8.1,let it settle there a bit.
v1.8.1,after hovering we need to re-enabled api control for next leg of the trip
v1.8.1,now compute the survey path required to fill the box
v1.8.1,##################################################################################################
v1.8.1,
v1.8.1,Project:  Embedded Learning Library (ELL)
v1.8.1,File:     wav_reader.py
v1.8.1,Authors:  Chris Lovett
v1.8.1,
v1.8.1,Requires: Python 3.x
v1.8.1,
v1.8.1,##################################################################################################
v1.8.1,open a stream on the audio input file.
v1.8.1,"assumes signed integer used in raw audio, so for example, the max for 16bit is 2^15 (32768)"
v1.8.1,convert int16 data to scaled floats
v1.8.1,configure output stream to match what we are resampling to...
v1.8.1,convert the audio to the desired recording rate
v1.8.1,split into separate channels
v1.8.1,drop the channels we don't want
v1.8.1,zip the resulting channels back up.
v1.8.1,convert back to packed bytes in PCM 16 format
v1.8.1,"deal with any accumulation of tails, if the tail grows to a full"
v1.8.1,buffer then return it!
v1.8.1,"we have a tail from previous frame, so prepend it"
v1.8.1,"now the caller needs us to stick to our sample_size contract, but when"
v1.8.1,rate conversion happens we can't be sure that 'data' is exactly that size.
v1.8.1,usually one byte extra so add this to our accumulating tail
v1.8.1,"might have reached the end of a file, so pad with zeros."
v1.8.1,"Please add ""EnableTrace"": true to your setting.json as shown below"
v1.8.1,{
v1.8.1,"""SettingsVersion"": 1.2,"
v1.8.1,"""SimMode"": ""Multirotor"","
v1.8.1,"""Vehicles"": {"
v1.8.1,"""Drone"": {"
v1.8.1,"""VehicleType"": ""SimpleFlight"","
v1.8.1,"""EnableTrace"": true"
v1.8.1,}
v1.8.1,}
v1.8.1,}
v1.8.1,connect to the AirSim simulator
v1.8.1,connect to the AirSim simulator
v1.8.1,add new vehicle
v1.8.1,Use below in settings.json with Blocks environment
v1.8.1,connect to the AirSim simulator
v1.8.1,get camera images from the car
v1.8.1,that's enough fun for now. let's quit cleanly
v1.8.1,connect to the AirSim simulator
v1.8.1,Import this module to automatically setup path to local airsim module
v1.8.1,This module first tries to see if airsim module is installed via pip
v1.8.1,If it does then we don't do anything else
v1.8.1,Else we look up grand-parent folder to see if it has airsim folder
v1.8.1,and if it does then we add that in sys.path
v1.8.1,this class simply tries to see if airsim
v1.8.1,if airsim module is installed then don't do anything else
v1.8.1,import pkgutil
v1.8.1,airsim_loader = pkgutil.find_loader('airsim')
v1.8.1,if airsim_loader is not None:
v1.8.1,return
v1.8.1,"this script moves the drone to a location, then rests it thousands of time"
v1.8.1,purpose of this script is to stress test reset API
v1.8.1,connect to the AirSim simulator
v1.8.1,that's enough fun for now. let's quite cleanly
v1.8.1,For high speed ascent and descent on PX4 you may need to set these properties:
v1.8.1,param set MPC_Z_VEL_MAX_UP 5
v1.8.1,param set MPC_Z_VEL_MAX_DN 5
v1.8.1,AirSim uses NED coordinates so negative axis is up.
v1.8.1,z of -50 is 50 meters above the original launch point.
v1.8.1,use open cv to show new images from AirSim
v1.8.1,requires Python 3.5.3 :: Anaconda 4.4.0
v1.8.1,pip install opencv-python
v1.8.1,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.8.1,get depth image
v1.8.1,"this will return png width= 256, height= 144"
v1.8.1,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.8.1,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.8.1,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.8.1,to get an estimate of distance.
v1.8.1,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.8.1,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.8.1,an angular delta of the following pi/10.
v1.8.1,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.8.1,Remove alpha channel if exists
v1.8.1,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.8.1,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.8.1,Flatten and yield as tuple
v1.8.1,Initialize a resizable dataset to hold the output
v1.8.1,Resize the dataset to accommodate the next chunk of rows
v1.8.1,Create the next chunk
v1.8.1,Increment the row count
v1.8.1,Arguments
v1.8.1,Returns
v1.8.1,use composition of homographies
v1.8.1,to generate final transform that needs to be applied
v1.8.1,Arguments
v1.8.1,Returns
v1.8.1,Keeps under lock only the mechanism which advances
v1.8.1,the indexing of each batch.
v1.8.1,The transformation of images is not under thread lock
v1.8.1,so it can be done in parallel
v1.8.1,Trained model path
v1.8.1,Connect to AirSim
v1.8.1,Start driving
v1.8.1,Initialize image buffer
v1.8.1,Update throttle value according to steering angle
v1.8.1,Prediction
v1.8.1,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.8.1,Print progress
v1.8.1,Update next car state
v1.8.1,Wait a bit between iterations
v1.8.1,%matplotlib inline
v1.8.1,chunk size for training batches
v1.8.1,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.8.1,Point this to the directory containing the raw data
v1.8.1,Point this to the desired output directory for the cooked (.h5) data
v1.8.1,Choose The folders to search for data under RAW_DATA_DIR
v1.8.1,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.8.1,data_folder.append('folder_name1')
v1.8.1,data_folder.append('folder_name2')
v1.8.1,...
v1.8.1,Hyper-parameters
v1.8.1,Activation functions
v1.8.1,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.8.1,<< The directory containing the cooked data from the previous step >>
v1.8.1,<< The directory in which the model output will be placed >>
v1.8.1,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.8.1,Network definition
v1.8.1,Import this module to automatically setup path to local airsim module
v1.8.1,This module first tries to see if airsim module is installed via pip
v1.8.1,If it does then we don't do anything else
v1.8.1,Else we look up grand-parent folder to see if it has airsim folder
v1.8.1,and if it does then we add that in sys.path
v1.8.1,this class simply tries to see if airsim
v1.8.1,if airsim module is installed then don't do anything else
v1.8.1,import pkgutil
v1.8.1,airsim_loader = pkgutil.find_loader('airsim')
v1.8.1,if airsim_loader is not None:
v1.8.1,return
v1.8.1,DEY: I don't know why this was there.
v1.8.1,----------------------------------- Common vehicle APIs ---------------------------------------------
v1.8.1,basic flight control
v1.8.1,time-of-day control
v1.8.1,time - of - day control
v1.8.1,weather
v1.8.1,camera control
v1.8.1,simGetImage returns compressed png in array of bytes
v1.8.1,image_type uses one of the ImageType members
v1.8.1,"todo : in future remove below, it's only for compatibility to pre v1.2"
v1.8.1,"because this method returns std::vector < uint8>, msgpack decides to encode it as a string unfortunately."
v1.8.1,camera control
v1.8.1,simGetImage returns compressed png in array of bytes
v1.8.1,image_type uses one of the ImageType members
v1.8.1,CinemAirSim
v1.8.1,End CinemAirSim
v1.8.1,gets the static meshes in the unreal scene
v1.8.1,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.8.1,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.8.1,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.8.1,sensor APIs
v1.8.1,Plotting APIs
v1.8.1,Recording APIs
v1.8.1,Add new vehicle via RPC
v1.8.1,----------------------------------- Multirotor APIs ---------------------------------------------
v1.8.1,APIs for control
v1.8.1,low - level control API
v1.8.1,query vehicle state
v1.8.1,query rotor states
v1.8.1,----------------------------------- Car APIs ---------------------------------------------
v1.8.1,helper method for converting getOrientation to roll/pitch/yaw
v1.8.1,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.8.1,roll (x-axis rotation)
v1.8.1,pitch (y-axis rotation)
v1.8.1,yaw (z-axis rotation)
v1.8.1,DEY: I don't know why this was there.
v1.8.1,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.8.1,return cls(**msgpack.unpack(encoded))
v1.8.1,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.8.1,Create a DummyVecEnv for main airsim gym env
v1.8.1,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.8.1,Initialize RL algorithm type and parameters
v1.8.1,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.8.1,Train for a certain number of timesteps
v1.8.1,Save policy weights
v1.8.1,Create a DummyVecEnv for main airsim gym env
v1.8.1,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.8.1,Initialize RL algorithm type and parameters
v1.8.1,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.8.1,Train for a certain number of timesteps
v1.8.1,Save policy weights
v1.8.1,Import this module to automatically setup path to local airsim module
v1.8.1,This module first tries to see if airsim module is installed via pip
v1.8.1,If it does then we don't do anything else
v1.8.1,Else we look up grand-parent folder to see if it has airsim folder
v1.8.1,and if it does then we add that in sys.path
v1.8.1,this class simply tries to see if airsim
v1.8.1,if airsim module is installed then don't do anything else
v1.8.1,import pkgutil
v1.8.1,airsim_loader = pkgutil.find_loader('airsim')
v1.8.1,if airsim_loader is not None:
v1.8.1,return
v1.8.1,Set home position and velocity
v1.8.1,print(dist)
v1.8.1,Licensed under the MIT License.
v1.8.1,"This is a bit crude, but give it a moment to settle on the ground, else takeoff will fail"
v1.8.1,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.8.1,switch to explicit hover mode so that this is the fallback when
v1.8.1,move* commands are finished.
v1.8.1,"Altitude difference between each platform, in meters"
v1.8.1,"Count down, so the first one can easily go the highest (without knowing count)"
v1.8.1,"in header only mode, control library is not available"
v1.8.1,if using Unreal Build system then include precompiled header file first
v1.8.1,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.8.1,"Windows, OSX and Linux."
v1.8.1,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.8.1,Windows users can move the Documents folder to any location they want
v1.8.1,SHGetFolderPath knows how to find it.
v1.8.1,fall back in case SHGetFolderPath failed for some reason.
v1.8.1,convert from std::path '/' to windows backslash.
v1.8.1,make the current thread run with maximum priority.
v1.8.1,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.8.1,TODO: How to handle POSIX thread priorities on OSX?
v1.8.1,setThreadName is a helper function that is useful when debugging because your threads
v1.8.1,show up in the debugger with the name you set which makes it easier to find the threads
v1.8.1,that you are interested in.
v1.8.1,"unfortunately this is only available on Windows 10, and AirSim is not limited to that."
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.8.1,
v1.8.1,Treat all errors as failure conditions.
v1.8.1,parse command line
v1.8.1,"motive gives a weird error if the project is not found, so we look for it."
v1.8.1,Do an update to pick up any recently-arrived cameras.
v1.8.1,List all detected cameras.
v1.8.1,List all defined rigid bodies.
v1.8.1,throttle to 50 messages per second.
v1.8.1,OptiTrack uses 'y' axis for vertical.
v1.8.1,stdafx.cpp : source file that includes just the standard includes
v1.8.1,MavlinkMoCap.pch will be the pre-compiled header
v1.8.1,stdafx.obj will contain the pre-compiled type information
v1.8.1,TODO: reference any additional headers you need in STDAFX.H
v1.8.1,and not in this file
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,PX4.cpp : Defines the entry point for the console application.
v1.8.1,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.8.1,how do you write to the debug output windows on Unix ?
v1.8.1,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.8.1,connection to create to talke to that server.
v1.8.1,SITL setup info
v1.8.1,The local ethernet interface to use (default localhost).
v1.8.1,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.8.1,server mode on UDP is when you want another app to connect to Pixhawk and publish data back to this process.
v1.8.1,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.8.1,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.8.1,"using their the -qgc option.  Server mode on TCP means mavlinktest will do an ""accept"" socket which is"
v1.8.1,what PX4 is waiting for when it is running in TCP mode.  Here the serverEndPoint is different from the
v1.8.1,offboardEndPoint.  The serverEndPoint specifies which local address to use in case your computer has
v1.8.1,multiple network interfaces.
v1.8.1,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.8.1,this switch controls whether we turn off the RC remote active link loss detection
v1.8.1,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.8.1,from kicking in when you try and fly.
v1.8.1,parse the json
v1.8.1,flatten inner mavlink object
v1.8.1,flatten inner mavlink object
v1.8.1,todo
v1.8.1,todo
v1.8.1,"const char* outLogFileOption = ""outlogfile"";"
v1.8.1,parse command line
v1.8.1,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.8.1,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.8.1,"no local serial connection, so this is the primary droneConnection."
v1.8.1,need a retry loop here because we don't know how quickly px4 will start accepting these connections...
v1.8.1,failed to connect
v1.8.1,"then we need 2 mavlink channels, one for sending/receiving HIL_* messages and the other"
v1.8.1,for controlling the drone.
v1.8.1,this is the control channel.
v1.8.1,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.8.1,cmdTable.push_back(new AltHoldCommand());
v1.8.1,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.8.1,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.8.1,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.8.1,this stops us from being able to connect to SITL mode PX4.
v1.8.1,checkPulse();
v1.8.1,add command text in log
v1.8.1,close previous command.
v1.8.1,FilterLogFiles(logDirectory);
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,send a heartbeat
v1.8.1,accept one incoming connection
v1.8.1,send a heartbeat to the client
v1.8.1,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.8.1,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.8.1,for this unit test we are expecting a request to send an image.
v1.8.1,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.8.1,hmmm
v1.8.1,================ ls
v1.8.1,================ put file
v1.8.1,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.8.1,================ get file
v1.8.1,verify the file contents.
v1.8.1,================ remove file
v1.8.1,================ make directory
v1.8.1,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.8.1,================ remove directory
v1.8.1,Now verification
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,you must call this method if you want HandleMessage to be called subsequently.
v1.8.1,treat literals as one word
v1.8.1,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.8.1,request gps info
v1.8.1,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.8.1,find relative position since command start so we can compare two commands better
v1.8.1,"these PID values are important, so set these to match"
v1.8.1,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.8.1,we can skip ahead.
v1.8.1,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.8.1,TODO: avoid passing hadcoded HIL flag
v1.8.1,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.8.1,"The global position, as returned by the Global Positioning System (GPS)."
v1.8.1,Provides state for additional features
v1.8.1,The general system state
v1.8.1,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.8.1,Provides state for additional features
v1.8.1,The general system state
v1.8.1,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.8.1,Provides state for additional features
v1.8.1,The general system state
v1.8.1,Provides state for additional features
v1.8.1,The general system state
v1.8.1,note: we do not reset com when Close() is called because we want to keep running.
v1.8.1,"user has to invoke ""hil stop"" to stop the hil thread."
v1.8.1,generate random between 0 and 1
v1.8.1,move to range -1 to 1
v1.8.1,scale it
v1.8.1,apply iy
v1.8.1,wait for the Execute method to be called.
v1.8.1,gps is much slower frequency than IMU.
v1.8.1,MAVLINK_MSG_ID_HIL_GPS
v1.8.1,disable MAV_USEHILGPS
v1.8.1,note: we do not reset com when Close() is called because we want to keep running.
v1.8.1,"user has to invoke ""hil stop"" to stop the hil thread."
v1.8.1,generate random between 0 and 1
v1.8.1,move to range -1 to 1
v1.8.1,scale it
v1.8.1,apply iy
v1.8.1,wait for the Execute method to be called.
v1.8.1,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.8.1,gps is much slower frequency than IMU.
v1.8.1,MAVLINK_MSG_ID_HIL_GPS
v1.8.1,disable HIL mode
v1.8.1,Enumeration of landed detector states
v1.8.1,MAV landed state is unknown
v1.8.1,MAV is landed (on ground)
v1.8.1,MAV is in air
v1.8.1,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.8.1,The filtered local position
v1.8.1,must send these regularly to keep offboard control.
v1.8.1,"ok, now we can safely switch to loiter."
v1.8.1,must send these regularly to keep offboard control.
v1.8.1,integrate the heading so it is smoother.
v1.8.1,must send these regularly to keep offboard control.
v1.8.1,integrate the heading so it is smoother.
v1.8.1,fly to radius
v1.8.1,it takes about 10 cm to stop and turn.
v1.8.1,next time around switch to orbiting!
v1.8.1,heading points to center of circle.
v1.8.1,interpoloate the speed ramp up time over 2 seconds from start time
v1.8.1,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.8.1,monitor the sin curves so we can see how on track or off track it actually is.
v1.8.1,the shape of the curve will also tell us if we are progressing at a consistent
v1.8.1,"speed, the more deformed the sin curve the worse our progress."
v1.8.1,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.8.1,degrees just flipped from 359 to 0.
v1.8.1,this enables us to test what happens when offboard control is lost and resumed.
v1.8.1,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.8.1,"ok, now we can start moving by velocity"
v1.8.1,recompute to new target.
v1.8.1,start by moving right with 10 degree roll.
v1.8.1,haven't started yet.
v1.8.1,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.8.1,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.8.1,track how our actual pitch is coming along compared to our target
v1.8.1,and check position
v1.8.1,the amount of pitch should depend on our speed in that direction.
v1.8.1,passed the midpoint.
v1.8.1,fade out the pitch as we pick up speed so we don't overshoot.
v1.8.1,see if we just crossed the wiggle distance threshold.
v1.8.1,(pitch affects the x-position).
v1.8.1,reverse direction with a -30 degrees quick stop
v1.8.1,reverse direction with a 30 degrees quick stop
v1.8.1,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.8.1,too much in that direction.
v1.8.1,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.8.1,track how our actual roll is coming along compared to our target
v1.8.1,and check position
v1.8.1,the amount of roll should depend on our speed in that direction.
v1.8.1,passed the midpoint.
v1.8.1,fade out the roll as we pick up speed so we don't overshoot.
v1.8.1,see if we just crossed the wiggle distance threshold.
v1.8.1,(roll affects the y-position).
v1.8.1,reverse direction with a -30 degrees quick stop
v1.8.1,reverse direction with a 30 degrees quick stop
v1.8.1,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.8.1,too much in that direction.
v1.8.1,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.8.1,for testing PID controller.
v1.8.1,class AltHoldCommand : public Command
v1.8.1,{
v1.8.1,std::shared_ptr<MavLinkVehicle> channel;
v1.8.1,"float sx_, sy_, sz_;"
v1.8.1,MavLinkAttitudeTarget _current;
v1.8.1,PidController thrust_controller_;
v1.8.1,public:
v1.8.1,this->sz_ = pos.z; // user defined target.
v1.8.1,move to local position keeps the offboard control happy.
v1.8.1,haven't started yet.
v1.8.1,and check position
v1.8.1,double dx = this->sx_ - pos.x;
v1.8.1,double dy = this->sy_ - pos.y;
v1.8.1,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.8.1,too much in that direction.
v1.8.1,adjust thrust so we keep steady height target
v1.8.1,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.8.1,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.8.1,local remote
v1.8.1,already handled by the parse method.
v1.8.1,we only support very simple patterns for now.
v1.8.1,each wildcard must be separated by literal.
v1.8.1,back to back wildcards with no literal in between is too complex.
v1.8.1,"we only support simple matching for now, we can add full regex later if we need it."
v1.8.1,yep!
v1.8.1,'*' is done we found the next matching char
v1.8.1,this is ok.
v1.8.1,this is an ERASE_END_LINE command which we ignore.
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,pack the payload buffer.
v1.8.1,calculate checksum
v1.8.1,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.8.1,are variable length as a result.
v1.8.1,form the header as a byte array for the crc
v1.8.1,unpack the message...
v1.8.1,pack the payload buffer.
v1.8.1,"json can't handle ""nan"", so we convert it to null."
v1.8.1,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.8.1,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,start listening to this connection
v1.8.1,Send heartbeat to drone.  You should not do this if some other node is
v1.8.1,already doing it.
v1.8.1,stop listening to the connection.
v1.8.1,get the connection
v1.8.1,Get the local system and component id
v1.8.1,send a command to the remote node
v1.8.1,MavLinkNode::MavLinkNode() = default;
v1.8.1,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.8.1,decrementing the count so the next WaitOne may block.
v1.8.1,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.8.1,convert to absolute time.
v1.8.1,use mach_timespec
v1.8.1,convert to absolute time.
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,return true if we still have offboard control (can lose this if user flips the switch).
v1.8.1,MavLinkVehicle::MavLinkVehicle() = default;
v1.8.1,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.8.1,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,============================== CLIENT ============================================
v1.8.1,image APIs
v1.8.1,or if you are implementing the client side call this function to get the most recent frame.
v1.8.1,returns false if there is no new frame available.
v1.8.1,============================== SERVER ============================================
v1.8.1,call this to send the image back over the connection given to start function.
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,"log every message that is ""sent"" using sendMessage."
v1.8.1,"log every message that is ""received"""
v1.8.1,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.8.1,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.8.1,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.8.1,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,for compatibility with QGroundControl we have to save the time field in big endian.
v1.8.1,todo: mavlink2 support?
v1.8.1,has to be one or the other!
v1.8.1,24 bits.
v1.8.1,24 bits.
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,start listening to this connection
v1.8.1,Send heartbeat to drone.  You should not do this if some other node is
v1.8.1,already doing it.
v1.8.1,this is called for all messages received on the connection.
v1.8.1,"we received a heartbeat, so let's get the capabilities."
v1.8.1,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.8.1,subclasses remembering to call this base implementation.
v1.8.1,stop listening to the connection.
v1.8.1,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.8.1,wait for a heartbeat msg since this will give us the port to send commands to...
v1.8.1,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.8.1,send a heart beat so that the remote node knows we are still alive
v1.8.1,(otherwise drone will trigger a failsafe operation).
v1.8.1,ignore any failures here because we are running in our own thread here.
v1.8.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.1,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.8.1,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.8.1,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.8.1,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.8.1,"ok, now fetch the missing parameters."
v1.8.1,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.8.1,silently fail since we are on a background thread here...
v1.8.1,tell the caller this is complete.
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,add our custom telemetry message length.
v1.8.1,todo: if we support signing then initialize
v1.8.1,mavlink_intermediate_status_.signing callbacks
v1.8.1,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.8.1,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.8.1,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.8.1,send this right away just in case serial link is not already configured
v1.8.1,"log every message that is ""sent"" using sendMessage."
v1.8.1,"log every message that is ""sent"" using sendMessage."
v1.8.1,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.8.1,pack the payload buffer.
v1.8.1,calculate checksum
v1.8.1,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.8.1,are variable length as a result.
v1.8.1,form the header as a byte array for the crc
v1.8.1,these macros use old style cast.
v1.8.1,forward messages from our connected node to the remote proxy.
v1.8.1,tell the remote connection to expect mavlink2 messages.
v1.8.1,forward messages from remote proxy to local connected node
v1.8.1,CurrentThread::setMaximumPriority();
v1.8.1,"hmmm, wait till it is opened?"
v1.8.1,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.8.1,pick up the sysid/compid of the remote node we are connected to.
v1.8.1,then this is a mavlink 1 message
v1.8.1,then this mavlink sender supports mavlink 2
v1.8.1,queue event for publishing.
v1.8.1,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.8.1,as it ensures we don't lose messages if the listener is slow.
v1.8.1,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.8.1,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.8.1,we would get a deadlock.
v1.8.1,CurrentThread::setMaximumPriority();
v1.8.1,reset counters
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,------------------------------------------------------------------------------
v1.8.1,Defines
v1.8.1,------------------------------------------------------------------------------
v1.8.1,bit number  876543210987654321
v1.8.1,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.8.1,in future it would be good to have ability to add system IDs we are interested in
v1.8.1,if (msg.sysid != getTargetSystemId())
v1.8.1,{
v1.8.1,// we only care about messages from our intended remote node.
v1.8.1,return;
v1.8.1,}
v1.8.1,user may have changed modes on us! So we need to honor that and not
v1.8.1,try and take it back.
v1.8.1,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.8.1,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.8.1,we can store up to 16 channels in rc_channels_scaled.
v1.8.1,The RAW values of the servo outputs
v1.8.1,Metrics typically displayed on a HUD for fixed wing aircraft
v1.8.1,The IMU readings in SI units in NED body frame
v1.8.1,printSystemStatus(&msg);
v1.8.1,todo: use this to determine when we need to do emergency landing...
v1.8.1,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.8.1,Provides state for additional features
v1.8.1,The general system state
v1.8.1,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.8.1,but we do want to know when we get the ack.  So this is async ACK processing!
v1.8.1,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.8.1,if threshold < 0 then the threshold is inverted.
v1.8.1,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.8.1,Convert it to a floating point number between -1 and 1.
v1.8.1,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.8.1,until the move commands start happening.
v1.8.1,return true if user calls requestControl and has not called releaseControl.
v1.8.1,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.8.1,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.8.1,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.8.1,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.8.1,send a few to make sure it gets through...
v1.8.1,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.8.1,us by which time the PX4 times out offboard mode!!
v1.8.1,"assume this was successful, we'll find out if so in the next heartbeat."
v1.8.1,this mode change take precedence over offboard mode.
v1.8.1,thrust must be between -1 and 1.
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,These definitions are copied from PX4 implementation
v1.8.1,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.8.1,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.8.1,/ @brief Command opcodes
v1.8.1,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.8.1,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.8.1,must trim trailing slashes so PX4 doesn't hang!
v1.8.1,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.8.1,from the source.
v1.8.1,check if directory exists.
v1.8.1,perfect.
v1.8.1,use last_message_ so we preserve the sessionid.
v1.8.1,"could not create the local file, so stop."
v1.8.1,must use last_message_ so we preserve the session id.
v1.8.1,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.8.1,todo: error handling here? sequence is out of order...
v1.8.1,"directory must be empty then, can't do nextStep because"
v1.8.1,it will just loop for ever re-requesting zero offset into
v1.8.1,empty directory.
v1.8.1,result should be a list of null terminated file names.
v1.8.1,skipping this entry
v1.8.1,remove the file size field.
v1.8.1,"printf(""%s\n"", name.c_str());"
v1.8.1,request the next batch.
v1.8.1,"perhaps this was a late response after we did a retry, so ignore it."
v1.8.1,"perhaps this was a late response after we did a retry, so ignore it."
v1.8.1,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.8.1,reached the end of the list or the file.
v1.8.1,end of file or directory listing.
v1.8.1,"success, data should be following..."
v1.8.1,ack on this cmd is a noop
v1.8.1,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.8.1,give up then.
v1.8.1,tell watchdog we are sending a request
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,================================= CLIENT ==============================================================
v1.8.1,Check if we have a valid transaction
v1.8.1,emit signal if all packets arrived
v1.8.1,Restart statemachine
v1.8.1,image APIs
v1.8.1,================================= SERVER ==============================================================
v1.8.1,Prepare and send acknowledgment packet
v1.8.1,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.8.1,Send ENCAPSULATED_IMAGE packet
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.8.1,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.8.1,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.8.1,send this right away just in case serial link is not already configured
v1.8.1,CurrentThread::setMaximumPriority();
v1.8.1,"hmmm, wait till it is opened?"
v1.8.1,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.8.1,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.8.1,queue event for publishing.
v1.8.1,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.8.1,as it ensures we don't lose messages if the listener is slow.
v1.8.1,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.8.1,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.8.1,we would get a deadlock.
v1.8.1,CurrentThread::setMaximumPriority();
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.8.1,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.8.1,parse out the VID number
v1.8.1,now the PID
v1.8.1,parse out the VID number
v1.8.1,examples:
v1.8.1,PX4: USB\VID_26AC&PID_0011\0
v1.8.1,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.8.1,"printf(""Found: %S\n"", buffer.c_str());"
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.8.1,parse out the VID number
v1.8.1,now the PID
v1.8.1,parse out the VID number
v1.8.1,suppress
v1.8.1,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,This has not been properly tested
v1.8.1,struct iw_statistics stats;
v1.8.1,struct iwreq req;
v1.8.1,"memset(&stats, 0, sizeof(stats));"
v1.8.1,"memset(&req, 0, sizeof(iwreq));"
v1.8.1,
v1.8.1,"strncpy(req.ifr_name, ifaceName, 16);"
v1.8.1,req.u.data.pointer = &stats;
v1.8.1,req.u.data.length = sizeof(iw_statistics);
v1.8.1,
v1.8.1,#ifdef CLEAR_UPDATED
v1.8.1,req.u.data.flags = 1;
v1.8.1,#endif
v1.8.1,
v1.8.1,/* Perform the ioctl */
v1.8.1,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.8.1,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.8.1,return -127;
v1.8.1,}
v1.8.1,
v1.8.1,return stats.qual.level;
v1.8.1,todo: windows version of this...
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,windows
v1.8.1,Need to link with Ws2_32.lib
v1.8.1,posix
v1.8.1,found it!
v1.8.1,This timeout is important as it allows the MavLinkConnection readPackets
v1.8.1,thread to iterate and notice the connection is now closed. This allows
v1.8.1,AirSim to shutdown properly when drone is not connected.
v1.8.1,bind socket to local address.
v1.8.1,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.8.1,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.8.1,try and reconnect
v1.8.1,write to the serial port
v1.8.1,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.8.1,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.8.1,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.8.1,"try and receive something, up until port is closed anyway."
v1.8.1,"message was too large for the buffer, no problem, return what we have."
v1.8.1,try again - this can happen if server recreates the socket on their side.
v1.8.1,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.8.1,"skip this, the receive just timed out, no problem, we'll try again later."
v1.8.1,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.8.1,"printf(""#### recv failed with error: %d\n"", hr);"
v1.8.1,we now have it.
v1.8.1,this is from someone we are not interested in.
v1.8.1,-----------------------------------------------------------------------------------------
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,Initialize Winsock
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,windows
v1.8.1,Need to link with Ws2_32.lib
v1.8.1,posix
v1.8.1,found it!
v1.8.1,bind socket to local address.
v1.8.1,bind socket to local address.
v1.8.1,start listening for incoming connection
v1.8.1,accept 1
v1.8.1,"don't need to accept any more, so we can close this one."
v1.8.1,write to the serial port
v1.8.1,"try and receive something, up until port is closed anyway."
v1.8.1,"message was too large for the buffer, no problem, return what we have."
v1.8.1,try again - this can happen if server recreates the socket on their side.
v1.8.1,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.8.1,try again - this can happen if server recreates the socket on their side.
v1.8.1,-----------------------------------------------------------------------------------------
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.8.1,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.8.1,set signal
v1.8.1,Clear Handshake flags
v1.8.1,Set Handshake flags
v1.8.1,return GetLastError();
v1.8.1,return GetLastError();
v1.8.1,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.8.1,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.8.1,enable reading
v1.8.1,posix doesn't have mark/space parity.
v1.8.1,posix doesn't have mark/space parity.
v1.8.1,this is the default.
v1.8.1,not sure this is supported...
v1.8.1,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.8.1,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.8.1,First do those specified by POSIX.
v1.8.1,Now conditionally handle a bunch of extended rates.
v1.8.1,First do those specified by POSIX.
v1.8.1,Now conditionally handle a bunch of extended rates.
v1.8.1,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.8.1,import airsim
v1.8.1,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v1.8.1,self.args = args
v1.8.1,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v1.8.1,pdb.set_trace()
v1.8.1,#include <pluginlib/class_list_macros.h>
v1.8.1,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v1.8.1,todo do not reset if already in air?
v1.8.1,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.8.1,ros params
v1.8.1,todo enforce dynamics constraints in this node as well?
v1.8.1,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v1.8.1,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v1.8.1,XmlRpc::XmlRpcValue can't be const in this case
v1.8.1,subscribe to control commands on global nodehandle
v1.8.1,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.8.1,bind to a single callback. todo optimal subs queue length
v1.8.1,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.8.1,TODO: ros::TransportHints().tcpNoDelay();
v1.8.1,"vehicle_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.8.1,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.8.1,camera_setting.gimbal
v1.8.1,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.8.1,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.8.1,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.8.1,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.8.1,"if {DepthPlanar, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.8.1,"push back pair (vector of image captures, current vehicle name)"
v1.8.1,iterate over sensors
v1.8.1,"we want fast access to the lidar sensors for callback handling, sort them out now"
v1.8.1,add takeoff and land all services if more than 2 drones
v1.8.1,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v1.8.1,todo add per vehicle reset in AirLib API
v1.8.1,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.8.1,lidars update on their own callback/thread at a given rate
v1.8.1,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v1.8.1,"todo: error check. if state is not landed, return error."
v1.8.1,todo add reset by vehicle_name API to airlib
v1.8.1,todo not async remove waitonlasttask
v1.8.1,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v1.8.1,todo do actual body frame?
v1.8.1,airsim uses degrees
v1.8.1,todo do actual body frame?
v1.8.1,airsim uses degrees
v1.8.1,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v1.8.1,todo expose waitOnLastTask or nah?
v1.8.1,todo do actual body frame?
v1.8.1,airsim uses degrees
v1.8.1,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.8.1,todo expose waitOnLastTask or nah?
v1.8.1,todo support multiple gimbal commands
v1.8.1,todo support multiple gimbal commands
v1.8.1,1. find quaternion of default gimbal pose
v1.8.1,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.8.1,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.8.1,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.8.1,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.8.1,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.8.1,msg = []
v1.8.1,todo covariances
v1.8.1,gps_msg.position_covariance_type =
v1.8.1,gps_msg.position_covariance =
v1.8.1,todo covariances
v1.8.1,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.8.1,todo radians per second
v1.8.1,meters/s2^m
v1.8.1,imu_msg.orientation_covariance = ;
v1.8.1,imu_msg.angular_velocity_covariance = ;
v1.8.1,imu_msg.linear_acceleration_covariance = ;
v1.8.1,airsim appears to use chrono::system_clock with nanosecond precision
v1.8.1,todo this is global origin
v1.8.1,get the basic vehicle pose and environmental state
v1.8.1,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.8.1,airsim_client needs to provide the simulation time in a future version of the API
v1.8.1,publish the simulation clock
v1.8.1,"publish vehicle state, odom, and all basic sensor types"
v1.8.1,send any commands out to the vehicles
v1.8.1,"should be easier way to get the sim time through API, something like:"
v1.8.1,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.8.1,curr_ros_time = airsim_timestamp_to_ros(env.clock().nowNanos());
v1.8.1,iterate over drones
v1.8.1,get drone state from airsim
v1.8.1,"vehicle environment, we can get ambient temperature here and other truths"
v1.8.1,convert airsim drone state to ROS msgs
v1.8.1,simulation environment truth
v1.8.1,"dashboard reading from car, RPM, gear, etc"
v1.8.1,odom and transforms
v1.8.1,ground truth GPS position from sim/HITL
v1.8.1,handled via callback
v1.8.1,send control commands from the last callback to airsim
v1.8.1,send control commands from the last callback to airsim
v1.8.1,"Only camera rotation, no translation movement of camera"
v1.8.1,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.8.1,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.8.1,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.8.1,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.8.1,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.8.1,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.8.1,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.8.1,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.8.1,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.8.1,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.8.1,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.8.1,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.8.1,update timestamp of saved cam info msgs
v1.8.1,DepthPlanar / DepthPerspective / DepthVis / DisparityNormalized
v1.8.1,Scene / Segmentation / SurfaceNormals / Infrared
v1.8.1,publish camera transforms
v1.8.1,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.8.1,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.8.1,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.8.1,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.8.1,ROS params
v1.8.1,ROS publishers
v1.8.1,ROS subscribers
v1.8.1,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.8.1,ROS timers
v1.8.1,todo maintain internal representation as eigen vec?
v1.8.1,todo check if low velocity if within thresh?
v1.8.1,todo maintain separate errors for XY and Z
v1.8.1,todo save this in degrees somewhere to avoid repeated conversion
v1.8.1,this tells the update timer callback to not do active hovering
v1.8.1,todo maintain array of position goals
v1.8.1,todo error checks
v1.8.1,todo fill response
v1.8.1,"Already have goal, and have reached it"
v1.8.1,this tells the update timer callback to not do active hovering
v1.8.1,todo error checks
v1.8.1,todo fill response
v1.8.1,"todo do relative altitude, or add an option for the same?"
v1.8.1,convert GPS goal to NED goal
v1.8.1,todo error checks
v1.8.1,todo fill response
v1.8.1,"Already have goal, this shouldn't happen"
v1.8.1,"todo do relative altitude, or add an option for the same?"
v1.8.1,convert GPS goal to NED goal
v1.8.1,todo error checks
v1.8.1,todo fill response
v1.8.1,todo check if odometry is too old!!
v1.8.1,"if no odom, don't do anything."
v1.8.1,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.8.1,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.8.1,todo just add a sgn funciton in common utils? return double to be safe.
v1.8.1,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.8.1,todo yaw limits
v1.8.1,todo just add a sgn funciton in common utils? return double to be safe.
v1.8.1,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.8.1,mimics void ASimHUD::initializeSettings()
v1.8.1,int num_threads = 1;
v1.8.1,ros::MultiThreadedSpinner multi_thread(num_threads);
v1.8.1,multi_thread.spin();
v1.8.1,ros::AsyncSpinner async_spinner(num_threads);
v1.8.1,async_spinner.start();
v1.8.1,single threaded spinner
v1.8.1,!/usr/bin/env python
v1.8.1,capture joystick events using ROS and convert to AirSim Car API commands
v1.8.1,to enable:
v1.8.1,rosrun joy joy_node
v1.8.1,"Below was an earlier typo, written like this for compatibility"
v1.8.1,"gearing: -1 reverse, 0 N, >= 1 drive"
v1.8.1,connect to the AirSim simulator
v1.8.1,","
v1.8.1,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.8.1,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,"in header only mode, control library is not available"
v1.8.1,TODO: something defines max macro which interfears with code here
v1.8.1,is cur_pos within fence?
v1.8.1,destination risk is not available then consider it zero
v1.8.1,if dest risk is lower than its more safe
v1.8.1,are we doing better than closest obstacle?
v1.8.1,"if we stay where we are, what is the risk distance?"
v1.8.1,else we are better of moving to dest
v1.8.1,this function should work even when dest_pos == cur_pos
v1.8.1,is this dest_pos cur_pos within the fence?
v1.8.1,transform dest_pos vector to body frame
v1.8.1,check for approx zero vectors to avoid random yaw angles
v1.8.1,we are hovering
v1.8.1,"get yaw in body frame, ie, front is always 0 radians"
v1.8.1,yaw to ticks
v1.8.1,get obstacles in the window at the tick direction around the window
v1.8.1,less risk distance is better
v1.8.1,check obstacles around current position and see if it has lower risk
v1.8.1,else obstacle is too far
v1.8.1,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.8.1,look for each surrounding tick to see if we have obstacle free angle
v1.8.1,else no suggestions required
v1.8.1,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.8.1,evaluate right and left side of circle
v1.8.1,find right and left risk distances
v1.8.1,at this point we have already determined hover is better than going to dest
v1.8.1,we now determine is moving to suggested angle better than hovering?
v1.8.1,check if dest_pos is safe
v1.8.1,breaking distance at this velocity
v1.8.1,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.8.1,check if dest_pos is safe
v1.8.1,float/vec parameters can have NaN which makes them optional
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,"in header only mode, control library is not available"
v1.8.1,handles +/- tick and wraps around circle
v1.8.1,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.8.1,update the specified window on the map
v1.8.1,make sure from <= to
v1.8.1,normalize the ticks so both are valid indices
v1.8.1,if from is still larger then
v1.8.1,to ticks is then added one full circle to make it larger than from_tick
v1.8.1,find closest obstacle in given window
v1.8.1,search whole map to find closest obstacle
v1.8.1,"in header only mode, control library is not available"
v1.8.1,#include <fileapi.h>
v1.8.1,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.8.1,"Windows, OSX and Linux."
v1.8.1,Windows users can move the Documents folder to any location they want
v1.8.1,SHGetFolderPath knows how to find it.
v1.8.1,fall back in case SHGetFolderPath failed for some reason.
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,"in header only mode, control library is not available"
v1.8.1,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.1,if using Unreal Build system then include precompiled header file first
v1.8.1,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.1,this deadlocks UI thread if async_run was called while there are pending rpc calls.
v1.8.1,CinemAirSim
v1.8.1,end CinemAirSim
v1.8.1,Exit if already resetting.
v1.8.1,Reset
v1.8.1,if we don't suppress then server will bomb out for exceptions raised by any method
v1.8.1,required for pimpl
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,"in header only mode, control library is not available"
v1.8.1,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.1,if using Unreal Build system then include precompiled header file first
v1.8.1,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.1,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.8.1,make sure we can talk to the DroneServer
v1.8.1,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.8.1,command_context.client.ping();
v1.8.1,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.8.1,sim only
v1.8.1,CinemAirSim
v1.8.1,End CinemAirSim
v1.8.1,"Minor TODO: consider msgpack magic for GeoPoint, so we can have one arg instead of three"
v1.8.1,Convert
v1.8.1,return value of last task. It should be true if task completed without
v1.8.1,cancellation or timeout
v1.8.1,"should be implemented by derived class if it supports async task,"
v1.8.1,for example using futures
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,"in header only mode, control library is not available"
v1.8.1,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.1,if using Unreal Build system then include precompiled header file first
v1.8.1,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,"in header only mode, control library is not available"
v1.8.1,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.1,if using Unreal Build system then include precompiled header file first
v1.8.1,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.1,required for pimpl
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,"in header only mode, control library is not available"
v1.8.1,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.1,if using Unreal Build system then include precompiled header file first
v1.8.1,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.1,status getters
v1.8.1,Rotor state getter
v1.8.1,Multirotor state getter
v1.8.1,return value of last task. It should be true if task completed without
v1.8.1,cancellation or timeout
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,"in header only mode, control library is not available"
v1.8.1,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.1,if using Unreal Build system then include pre-compiled header file first
v1.8.1,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.1,getters
v1.8.1,Rotor state
v1.8.1,Multirotor state
v1.8.1,required for pimpl
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,"in header only mode, control library is not available"
v1.8.1,last command is to hold on to position
v1.8.1,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.8.1,after landing we detect if drone has stopped moving
v1.8.1,validate path size
v1.8.1,validate yaw mode
v1.8.1,validate and set auto-lookahead value
v1.8.1,if auto mode requested for lookahead then calculate based on velocity
v1.8.1,add current position as starting point
v1.8.1,append the input path and compute segments
v1.8.1,add last segment as zero length segment so we have equal number of segments and points.
v1.8.1,path_segs[i] refers to segment that starts at point i
v1.8.1,"when path ends, we want to slow down"
v1.8.1,else no need to change velocities for last segments
v1.8.1,setup current position on path to 0 offset
v1.8.1,initialize next path position
v1.8.1,until we are at the end of the path (last seg is always zero size)
v1.8.1,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.8.1,send drone command to get to next lookahead
v1.8.1,sleep for rest of the cycle
v1.8.1,how much have we moved towards last goal?
v1.8.1,project actual vector on goal vector
v1.8.1,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.8.1,TODO: below should be lower than 1E3 and configurable
v1.8.1,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.8.1,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.8.1,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.8.1,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.8.1,"if drone moved backward, we don't want goal to move backward as well"
v1.8.1,"so only climb forward on the path, never back. Also note >= which means"
v1.8.1,we climb path even if distance was 0 to take care of duplicated points on path
v1.8.1,else
v1.8.1,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.8.1,compute next target on path
v1.8.1,freeze the quaternion
v1.8.1,convert RC commands to velocity vector
v1.8.1,find yaw as per terrain and remote setting
v1.8.1,execute command
v1.8.1,if timeout occurred then command completed successfully otherwise it was interrupted
v1.8.1,yaw is not within margin
v1.8.1,by default we say that this command is not supported
v1.8.1,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.8.1,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.8.1,get trims
v1.8.1,take average
v1.8.1,validate dest
v1.8.1,what is the distance we will travel at this velocity?
v1.8.1,get velocity vector
v1.8.1,yaw for the direction of travel
v1.8.1,find velocity vector
v1.8.1,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.8.1,generate velocity vector that is same size as cur_dest_norm / command period
v1.8.1,this velocity vect when executed for command period would yield cur_dest_norm
v1.8.1,send commands
v1.8.1,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.8.1,default strategy is for move. In hover mode we set new strategy temporarily
v1.8.1,are we supposed to do EM?
v1.8.1,get suggested velocity vector
v1.8.1,use the unchecked command
v1.8.1,tell caller not to execute planned command
v1.8.1,other wise throw exception
v1.8.1,otherwise there is some other reason why we are in unsafe situation
v1.8.1,send last command to come to full stop
v1.8.1,else no unsafe situation
v1.8.1,note: cur_path_loc and next_path_loc may both point to same object
v1.8.1,"otherwise use up this segment, move on to next one"
v1.8.1,if we are here then we ran out of segments
v1.8.1,consider last segment as zero length segment
v1.8.1,adjust yaw for the direction of travel in forward-only mode
v1.8.1,else no adjustment needed
v1.8.1,if auto mode requested for lookahead then calculate based on velocity
v1.8.1,Create a spring arm component for our chase camera
v1.8.1,"do nothing, spring arm is pulling the camera with it"
v1.8.1,"do nothing, we have camera turned off"
v1.8.1,set initial view mode
v1.8.1,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.8.1,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.8.1,"If the lag is missing, the camera will also occasionally shake."
v1.8.1,"But, lag is not desired when piloting a drone"
v1.8.1,attach spring arm to actor
v1.8.1,remember current parent for external camera. Later when we remove external
v1.8.1,"camera from spring arm, we will attach it back to its last parent"
v1.8.1,now attach camera to spring arm
v1.8.1,"For car, we need to move the camera back a little more than for a drone."
v1.8.1,"Otherwise, the camera will be stuck inside the car"
v1.8.1,ExternalCamera->bUsePawnControlRotation = false;
v1.8.1,detach spring arm
v1.8.1,Re-enable rendering
v1.8.1,Remove any existing key bindings for manual mode
v1.8.1,"else someone else is bound to manual pose controller, leave it alone"
v1.8.1,if new mode is manual mode then add key bindings
v1.8.1,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.8.1,other modes don't need special setup
v1.8.1,make switch official
v1.8.1,Add loading screen to viewport
v1.8.1,Remove Loading screen from viewport
v1.8.1,Create struct for Location and Rotation of actor in Unreal
v1.8.1,Ensure new non-matching name for the object
v1.8.1,Write the binvox file using run-length encoding
v1.8.1,"where each pair of bytes is of the format (run value, run length)"
v1.8.1,This is a run (repeated bit value)
v1.8.1,End of a run
v1.8.1,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.8.1,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.8.1,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.8.1,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.8.1,Split the tag string into individual tags.
v1.8.1,Texture swap on actors that have all of those tags.
v1.8.1,----------- Plotting APIs ----------/
v1.8.1,"plot line for points 0-1, 1-2, 2-3"
v1.8.1,"plot line for points 0-1, 2-3, 4-5... must be even number of points"
v1.8.1,assert points_start.size() == poinst_end.size()
v1.8.1,assert positions.size() == strings.size()
v1.8.1,assert poses.size() == names.size()
v1.8.1,Recording APIs
v1.8.1,"Remove '' from the list, representing default vehicle"
v1.8.1,"We need to run this code on the main game thread, since it iterates over actors"
v1.8.1,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.8.1,"No LOS, so draw red line"
v1.8.1,"Yes LOS, so draw green line"
v1.8.1,"We need to run this code on the main game thread, since it iterates over actors"
v1.8.1,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.8.1,Testing actor enum for world bounds...
v1.8.1,"Same as with the Object Iterator, access the subclass instance with the * or -> operators."
v1.8.1,"TODO think more about how best to determine/indicate ground level, if anyone cares"
v1.8.1,Convert Uvectors to LLAs
v1.8.1,CinemAirSim
v1.8.1,End CinemAirSim
v1.8.1,Fill out your copyright notice in the Description page of Project Settings.
v1.8.1,"Set this component to be initialized when the game starts, and to be ticked every frame.  You can turn these features"
v1.8.1,off to improve performance if you don't need them.
v1.8.1,get render target for texture size
v1.8.1,initialize viewinfo for projection matrix
v1.8.1,calculate 3D corner Points of bounding box
v1.8.1,initialize pixel values
v1.8.1,initialize projection data for sceneview
v1.8.1,do some voodoo rotation that is somehow mandatory and stolen from UGameplayStatics::ProjectWorldToScreen
v1.8.1,Project Points to pixels and get the corner pixels
v1.8.1,If actor in camera view - check if it's actually visible or hidden
v1.8.1,Check against 8 extend points
v1.8.1,"If actor in camera view but didn't hit any point out of 8 extend points,"
v1.8.1,check against 10 random points
v1.8.1,CinemAirSim
v1.8.1,CinemAirSim
v1.8.1,set initial focal length
v1.8.1,by default all image types are disabled
v1.8.1,use final color for all calculations
v1.8.1,We set all cameras to start as nodisplay
v1.8.1,This improves performance because the capture components are no longer updating every frame and only update while requesting an image
v1.8.1,TODO: avoid the need to override const cast here
v1.8.1,if the viewport is taller than it is wide
v1.8.1,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v1.8.1,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v1.8.1,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v1.8.1,use final color for all calculations
v1.8.1,TODO: should we be ignoring position and orientation settings here?
v1.8.1,TODO: can we eliminate storing NedTransform?
v1.8.1,CinemAirSim
v1.8.1,if (!std::isnan(setting.target_gamma))
v1.8.1,camera-> = setting.target_gamma;
v1.8.1,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.8.1,else nothing to enable
v1.8.1,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.8.1,if (controller && controller->GetViewTarget() == this)
v1.8.1,controller->SetViewTarget(nullptr);
v1.8.1,CinemAirSim methods
v1.8.1,Copy all of the post processing settings
v1.8.1,But restore the original blendables
v1.8.1,end CinemAirSim methods
v1.8.1,TODO: explore screenshot option
v1.8.1,addScreenCaptureHandler(camera->GetWorld());
v1.8.1,TODO: may be we should have these methods non-const?
v1.8.1,We don't do game/render thread synchronization for safe method.
v1.8.1,We just blindly sleep for 200ms (the old way)
v1.8.1,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.8.1,Make sure that all alpha values are opaque.
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,TODO: change naming conventions to same as other files?
v1.8.1,Get name of current level
v1.8.1,Only load new level if different from current level
v1.8.1,"context->GetWorld()->SetNewWorldOrigin(FIntVector(0, 0, 0));"
v1.8.1,Enable/disable primary viewport rendering flag
v1.8.1,This disables rendering of the main viewport in the same way as the
v1.8.1,"console command ""show rendering"" would do."
v1.8.1,"When getting an image through the API, the image is produced after the render"
v1.8.1,thread has finished rendering the current and the subsequent frame. This means
v1.8.1,that the frame rate for obtaining images through the API is only half as high as
v1.8.1,"it could be, since only every other image is actually captured. We work around"
v1.8.1,this by telling the viewport to flush the rendering queue at the end of each
v1.8.1,drawn frame so that it executes our render request at that point already.
v1.8.1,Do this only if the main viewport is not being rendered anyway in case there are
v1.8.1,any adverse performance effects during main rendering.
v1.8.1,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v1.8.1,nothing to do for now
v1.8.1,"if hidden, clear any existing messages"
v1.8.1,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.8.1,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.8.1,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.8.1,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.8.1,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.8.1,Find mesh in /Game and /AirSim asset registry. When more plugins are added this function will have to change
v1.8.1,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.8.1,{
v1.8.1,InitializeObjectStencilID(*comp);
v1.8.1,}
v1.8.1,"Takes a UStaticMeshComponent, USkinnedMeshComponent or ALandscapeProxy and returns their custom stencil ID if"
v1.8.1,their meshes's name or their owner's name (depending on the naming method in mesh_naming_method_) equals mesh_name
v1.8.1,"The skybox is ignored here as it is huge, and really is of no use to the end user typically. Also the associated meshes with the cameras"
v1.8.1,Various checks if there is even a valid mesh
v1.8.1,Need to force the render command to go through cause on the next iteration the buffer no longer exists
v1.8.1,Unreal stores more vertices than triangles. So here we find the highest referenced vertex and ignore any after that
v1.8.1,can we see followee?
v1.8.1,remove mapping
v1.8.1,removing binding
v1.8.1,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.8.1,"some point. At the moment, manually swapping Red and Blue"
v1.8.1,Copy scaled image into destination thumb
v1.8.1,Compress data - convert into a .png
v1.8.1,if we already have attached actor
v1.8.1,Fill out your copyright notice in the Description page of Project Settings.
v1.8.1,Check pointer equality first for performance
v1.8.1,"KeyHash = HashCombine(KeyHash, GetTypeHash(Key.WildcardMeshNames));"
v1.8.1,#ifdef _MSC_VER
v1.8.1,//print to VS output window
v1.8.1,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.8.1,#endif
v1.8.1,also do default logging
v1.8.1,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.8.1,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.8.1,{
v1.8.1,if (GEngine != nullptr)
v1.8.1,{
v1.8.1,return GEngine->GameUserSettings;
v1.8.1,}
v1.8.1,return nullptr;
v1.8.1,}
v1.8.1,UGameUserSettings* game_settings = GetGameUserSettings();
v1.8.1,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.8.1,game_settings->ApplySettings(true);
v1.8.1,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.8.1,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.8.1,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.8.1,todo unused. need to manually plots tf axes' line in right handed FLU instead of using DrawDebugCoordinateSystem
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,plugin startup
v1.8.1,plugin shutdown
v1.8.1,initialize state
v1.8.1,add listener for pawn's collision event
v1.8.1,compute our home point
v1.8.1,default behavior is to call update every tick
v1.8.1,"for custom physics engine, this method should be overridden and update should be"
v1.8.1,called from every physics tick
v1.8.1,add cameras that already exists in pawn
v1.8.1,create or replace cameras specified in settings
v1.8.1,setup individual cameras
v1.8.1,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.8.1,for each camera in settings
v1.8.1,get pose
v1.8.1,spawn and attach camera to pawn
v1.8.1,add on to our collection
v1.8.1,Deflect along the surface when we collide.
v1.8.1,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.8.1,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.8.1,-1 to 1 --> 0 to 1
v1.8.1,-1 to 1
v1.8.1,these will be available for devices like steering wheels
v1.8.1,switch index 0 to 7 for FrSky Taranis RC is:
v1.8.1,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.8.1,TODO: should below be at controller level info?
v1.8.1,else don't waste time
v1.8.1,"We need to run this code on the main game thread, since it iterates over actors"
v1.8.1,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.8.1,Transform from LLA to NED
v1.8.1,KM911 remove logging
v1.8.1,"common_utils::Utils::log(""NED from LLA: "" + std::to_string(target_location.X) + "", "" + std::to_string(target_location.Y) + "", "" + std::to_string(target_location.Z), common_utils::Utils::kLogLevelInfo);"
v1.8.1,"No LOS, so draw red line"
v1.8.1,"Yes LOS, so draw green line"
v1.8.1,sync environment from kinematics
v1.8.1,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.8.1,void playBack()
v1.8.1,{
v1.8.1,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.8.1,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.8.1,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.8.1,}
v1.8.1,TODO: refactor below code used for playback
v1.8.1,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.8.1,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.8.1,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.8.1,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.8.1,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.8.1,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.8.1,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.8.1,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.8.1,}
v1.8.1,parameters in NED frame
v1.8.1,translate to new PawnSimApi position & orientation from NED to NEU
v1.8.1,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.8.1,allow teleportation
v1.8.1,if collisions are not enabled
v1.8.1,or we have collided but passthrough is enabled
v1.8.1,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.8.1,"without flip flopping, collisions can't be detected"
v1.8.1,update kinematics from pawn's movement instead of physics engine
v1.8.1,by default we update kinematics from UE pawn
v1.8.1,if SimMod uses its own physics engine then this should be overriden
v1.8.1,no default action in this base class
v1.8.1,"read pixels from render target using render thread, then compress the result into PNG"
v1.8.1,argument on the thread that calls this method.
v1.8.1,TODO: is below really needed?
v1.8.1,make sure we are not on the rendering thread
v1.8.1,TODO: below doesn't work right now because it must be running in game thread
v1.8.1,below is documented method but more expensive because it forces flush
v1.8.1,wait for render thread to pick up our task
v1.8.1,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.8.1,capture CameraPose for this frame
v1.8.1,The completion is called immeidately after GameThread sends the
v1.8.1,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.8.1,execute *immediately* after RenderThread renders the scene!
v1.8.1,"while we're still on GameThread, enqueue request for capture the scene!"
v1.8.1,wait for this task to complete
v1.8.1,log a message and continue wait
v1.8.1,lamda function still references a few objects for which there is no refcount.
v1.8.1,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.8.1,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.8.1,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.8.1,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.8.1,Fill out your copyright notice in the Description page of Project Settings.
v1.8.1,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.1,UWorld* World = GetWorld();
v1.8.1,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.1,still need the menu class for f10
v1.8.1,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v1.8.1,showWeatherMenu(WorldContextObject);
v1.8.1,"if weather is not enabled, dont allow any weather values to be set"
v1.8.1,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v1.8.1,and must be set to true or false before this.
v1.8.1,WeatherEnabled will always be false
v1.8.1,"NOTE: weather enabled must be set first, before other params for this to work"
v1.8.1,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.1,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.1,"get all menu actors, if any"
v1.8.1,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.8.1,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.1,"get all menu actors, if any"
v1.8.1,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.8.1,"get all menu actors, if any, then hide the menu"
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,Stuff to filter out XInput devices
v1.8.1,-----------------------------------------------------------------------------
v1.8.1,"Defines, constants, and global variables"
v1.8.1,-----------------------------------------------------------------------------
v1.8.1,Magnitude ranges from -1 to 1
v1.8.1,Strength ranges from 0 to 1
v1.8.1,Autocenter
v1.8.1,Rumble
v1.8.1,Register with the DirectInput subsystem and get a pointer
v1.8.1,to a IDirectInput interface we can use.
v1.8.1,Create a DInput object
v1.8.1,Look for a simple joystick we can use for this sample program.
v1.8.1,Make sure we got a joystick
v1.8.1,"Set the data format to ""simple joystick"" - a predefined data format"
v1.8.1,
v1.8.1,"A data format specifies which controls on a device we are interested in,"
v1.8.1,and how they should be reported. This tells DInput that we will be
v1.8.1,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.8.1,Set the cooperative level to let DInput know how this device should
v1.8.1,interact with the system and with other DInput applications.
v1.8.1,Enumerate the joystick objects. The callback function enabled user
v1.8.1,"interface elements for objects that are found, and sets the min/max"
v1.8.1,values property for discovered axes.
v1.8.1,-----------------------------------------------------------------------------
v1.8.1,Enum each PNP device using WMI and check each device ID to see if it contains
v1.8.1,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.8.1,Unfortunately this information can not be found by just using DirectInput.
v1.8.1,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.8.1,XInput devices.
v1.8.1,
v1.8.1,This function stores the list of xinput devices in a linked list
v1.8.1,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.8.1,-----------------------------------------------------------------------------
v1.8.1,CoInit if needed
v1.8.1,Create WMI
v1.8.1,Create BSTRs for WMI
v1.8.1,Connect to WMI
v1.8.1,Switch security level to IMPERSONATE
v1.8.1,Get list of Win32_PNPEntity devices
v1.8.1,Loop over all devices
v1.8.1,Get 20 at a time
v1.8.1,"For each device, get its device ID"
v1.8.1,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.8.1,Unfortunately this information can not be found by just using DirectInput
v1.8.1,"If it does, then get the VID/PID from var.bstrVal"
v1.8.1,Add the VID/PID to a linked list
v1.8.1,-----------------------------------------------------------------------------
v1.8.1,Returns true if the DirectInput device is also an XInput device.
v1.8.1,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.8.1,-----------------------------------------------------------------------------
v1.8.1,Check each xinput device to see if this device's vid/pid matches
v1.8.1,-----------------------------------------------------------------------------
v1.8.1,Cleanup needed for IsXInputDevice()
v1.8.1,-----------------------------------------------------------------------------
v1.8.1,Cleanup linked list
v1.8.1,-----------------------------------------------------------------------------
v1.8.1,Name: EnumJoysticksCallback()
v1.8.1,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.8.1,device interface on it so we can play with it.
v1.8.1,-----------------------------------------------------------------------------
v1.8.1,Skip anything other than the perferred joystick device as defined by the control panel.
v1.8.1,Instead you could store all the enumerated joysticks and let the user pick.
v1.8.1,Obtain an interface to the enumerated joystick.
v1.8.1,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.8.1,it while we were in the middle of enumerating it.)
v1.8.1,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.8.1,could store all the enumerated joysticks and let the user pick.
v1.8.1,-----------------------------------------------------------------------------
v1.8.1,Name: EnumObjectsCallback()
v1.8.1,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.8.1,joystick. This function enables user interface elements for objects
v1.8.1,"that are found to exist, and scales axes min/max values."
v1.8.1,-----------------------------------------------------------------------------
v1.8.1,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.8.1,enumerated axis in order to scale min/max values.
v1.8.1,Set the range for the axis
v1.8.1,Set the UI to reflect what objects the joystick supports
v1.8.1,-----------------------------------------------------------------------------
v1.8.1,Name: UpdateInputState()
v1.8.1,Desc: Get the input device's state and display it.
v1.8.1,-----------------------------------------------------------------------------
v1.8.1,Poll the device to read the current state
v1.8.1,DInput is telling us that the input stream has been
v1.8.1,"interrupted. We aren't tracking any state between polls, so"
v1.8.1,we don't have any special reset that needs to be done. We
v1.8.1,just re-acquire and try again.
v1.8.1,while (hr == DIERR_INPUTLOST)
v1.8.1,hr = g_pJoystick->Acquire();
v1.8.1,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.8.1,may occur when the app is minimized or in the process of
v1.8.1,"switching, so just try again later"
v1.8.1,Get the input's device state
v1.8.1,Axes
v1.8.1,Slider controls
v1.8.1,Points of view
v1.8.1,Buttons
v1.8.1,-----------------------------------------------------------------------------
v1.8.1,Name: FreeDirectInput()
v1.8.1,Desc: Initialize the DirectInput variables.
v1.8.1,-----------------------------------------------------------------------------
v1.8.1,Unacquire the device one last time just in case
v1.8.1,the app tried to exit while the device is still acquired.
v1.8.1,Release any DirectInput objects.
v1.8.1,nop
v1.8.1,normalize min to max --> 0 to 1
v1.8.1,normalize 0 to 1 --> -1 to 1
v1.8.1,#include <libudev.h>
v1.8.1,implementation for unsupported OS
v1.8.1,if this is new index
v1.8.1,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.8.1,close previous one
v1.8.1,open new device
v1.8.1,if open was successful
v1.8.1,read the device
v1.8.1,if we didn't had valid read
v1.8.1,"NOTE if this condition is not met, we're probably out of sync and this"
v1.8.1,Joystick instance is likely unusable
v1.8.1,TODO: set below to false?
v1.8.1,state.is_valid = false;
v1.8.1,else ignore
v1.8.1,TODO: implement this for linux
v1.8.1,TODO: implement this for linux
v1.8.1,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.8.1,{
v1.8.1,"manufacturerID = productID = """";"
v1.8.1,// Use udev to look up the product and manufacturer IDs
v1.8.1,struct udev *udev = udev_new();
v1.8.1,if (udev) {
v1.8.1,char sysname[32];
v1.8.1,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.8.1,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.8.1,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.8.1,if (!dev)
v1.8.1,{
v1.8.1,"message = ""Unable to find parent USB device"";"
v1.8.1,return false;
v1.8.1,}
v1.8.1,std::stringstream ss;
v1.8.1,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.8.1,ss >> manufacturerID;
v1.8.1,ss.clear();
v1.8.1,"ss.str("""");"
v1.8.1,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.8.1,ss >> productID;
v1.8.1,udev_device_unref(dev);
v1.8.1,}
v1.8.1,else
v1.8.1,{
v1.8.1,"message = ""Cannot create udev"";"
v1.8.1,return false;
v1.8.1,}
v1.8.1,udev_unref(udev);
v1.8.1,return true;
v1.8.1,}
v1.8.1,required for pimpl
v1.8.1,TODO: anyway to workaround const_cast?
v1.8.1,Prevent a MavLink connection being established if changing levels
v1.8.1,FGenericPlatformMisc::PlatformInit();
v1.8.1,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.8.1,"sub-window captures don't count as a request, set bCaptureEveryFrame and bCaptureOnMovement to display so we can show correctly the subwindow"
v1.8.1,create main widget
v1.8.1,synchronize PIP views
v1.8.1,TODO: should we only do below on SceneCapture2D components and cameras?
v1.8.1,avoid motion blur so capture images don't get
v1.8.1,use two different methods to set console var because sometime it doesn't seem to work
v1.8.1,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.8.1,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.8.1,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.8.1,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.8.1,setup defaults
v1.8.1,Attempts to parse the settings text from one of multiple locations.
v1.8.1,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.8.1,"Next, check the executable's working directory for the settings file."
v1.8.1,"Finally, check the user's documents folder."
v1.8.1,"If the settings file cannot be read, throw an exception"
v1.8.1,Attempts to parse the settings file path or the settings text from the command line
v1.8.1,"Looks for the flag ""-settings="". If it exists, settingsText will be set to the value."
v1.8.1,"Example (Path): AirSim.exe -settings=""C:\path\to\settings.json"""
v1.8.1,"Example (Text): AirSim.exe -settings={""foo"":""bar""} -> settingsText will be set to {""foo"":""bar""}"
v1.8.1,"Returns true if the argument is present, false otherwise."
v1.8.1,build image file name
v1.8.1,write image file
v1.8.1,"Write PNG image, already compressed in binary"
v1.8.1,write to CSV file
v1.8.1,"Either images were saved successfully, or there were no images"
v1.8.1,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.8.1,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.8.1,"Just need any 1 instance, to set the header line of the record file"
v1.8.1,"Set is_ready at the end, setting this before can cause a race when the file isn't open yet"
v1.8.1,make sure all vars are set up
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,decide which derived BP to use
v1.8.1,we don't have real vehicle so no vehicle API
v1.8.1,put camera little bit above vehicle
v1.8.1,update ground level
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,let base class setup physics world
v1.8.1,stop physics thread before we dismantle
v1.8.1,setup clock in ClockFactory
v1.8.1,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.8.1,steppable clock returns interval that is a constant number irrespective of wall clock
v1.8.1,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.8.1,but that would cause vehicles like quadrotors to become unstable
v1.8.1,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.8.1,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.8.1,get increase in clock speed
v1.8.1,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.8.1,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.8.1,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.8.1,Approach 2: scale control loop frequency if clock is speeded up
v1.8.1,"for slowing down, this don't generate instability"
v1.8.1,-------------------------------- overrides -----------------------------------------------//
v1.8.1,decide which derived BP to use
v1.8.1,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.8.1,vehicle_sim_api->reset();
v1.8.1,create vehicle API
v1.8.1,setup physics vehicle
v1.8.1,initialize private vars
v1.8.1,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.8.1,calls to update* are handled by physics engine and in SimModeWorldBase
v1.8.1,"Utils::log(""------Render tick-------"");"
v1.8.1,"if reset is pending then do it first, no need to do other things until next tick"
v1.8.1,move collision info from rendering engine to vehicle
v1.8.1,update rotor poses
v1.8.1,update private rotor variable
v1.8.1,if we did reset then don't worry about synchronizing states for this tick
v1.8.1,Continue to wait for reset
v1.8.1,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.8.1,*** Start: UpdatableState implementation ***//
v1.8.1,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.8.1,environment update for current position
v1.8.1,update forces on vertices
v1.8.1,update to controller must be done after kinematics have been updated by physics engine
v1.8.1,*** End: UpdatableState implementation ***//
v1.8.1,get references of existing camera
v1.8.1,setup clock in PhysX
v1.8.1,-------------------------------- overrides -----------------------------------------------//
v1.8.1,decide which derived BP to use
v1.8.1,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.8.1,Setup suspension forces
v1.8.1,Find the tire object and set the data for it
v1.8.1,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.8.1,Setup suspension forces
v1.8.1,Find the tire object and set the data for it
v1.8.1,Create In-Car camera component
v1.8.1,In car HUD
v1.8.1,Create text render component for in car speed display
v1.8.1,Create text render component for in car gear display
v1.8.1,Setup the audio component and allocate it a sound cue
v1.8.1,Colors for the in-car gear display. One for normal one for reverse
v1.8.1,Wheels/Tires
v1.8.1,Setup the wheels
v1.8.1,Adjust the tire loading
v1.8.1,Engine
v1.8.1,Torque setup
v1.8.1,Adjust the steering
v1.8.1,Transmission
v1.8.1,We want 4wd
v1.8.1,Drive the front wheels a little more than the rear
v1.8.1,Automatic gearbox
v1.8.1,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.8.1,Physics settings
v1.8.1,Adjust the center of mass - the buggy is quite low
v1.8.1,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.8.1,put camera little bit above vehicle
v1.8.1,update physics material
v1.8.1,Update the strings used in the HUD (in-car and on-screen)
v1.8.1,Set the string in the in-car HUD
v1.8.1,Pass the engine RPM to the sound component
v1.8.1,Start an engine sound playing
v1.8.1,Using FText because this is display text that should be localizable
v1.8.1,Setup the text render component strings
v1.8.1,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.8.1,below is not needed
v1.8.1,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.8.1,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.8.1,create vehicle params
v1.8.1,TODO: should do reset() here?
v1.8.1,these are called on render ticks
v1.8.1,TODO: do we need this for cars?
v1.8.1,TODO: move this to SimModeBase?
v1.8.1,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.8.1,reset();
v1.8.1,return;
v1.8.1,}
v1.8.1,Thrustmaster devices
v1.8.1,"Anything else, typically Logitech G920 wheel"
v1.8.1,Two steel levers behind wheel
v1.8.1,if API-client control is not active then we route keyboard/joystick control to car
v1.8.1,all car controls from anywhere must be routed through API component
v1.8.1,*** Start: UpdatableState implementation ***//
v1.8.1,physics tick
v1.8.1,*** End: UpdatableState implementation ***//
v1.8.1,TODO: directly accept getVehicleSimApis() using generic container
v1.8.1,Reset the vehicle as well before registering it
v1.8.1,Similar to what happens in initializeForPlay() above
v1.8.1,remove everything that we created in BeginPlay
v1.8.1,wait if no new frame is renderd
v1.8.1,we use custom debug reporting for this class
v1.8.1,perform any expensive rendering update outside of lock region
v1.8.1,no need to call base reset because of our custom implementation
v1.8.1,TODO: this is going to cause circular references which is fine here but
v1.8.1,in future we should consider moving SimMode not derived from AActor and move
v1.8.1,it to AirLib and directly implement WorldSimApiBase interface
v1.8.1,get player start
v1.8.1,this must be done from within actor otherwise we don't get player start
v1.8.1,Grab player location
v1.8.1,Move the world origin to the player's location (this moves the coordinate system and adds
v1.8.1,a corresponding offset to all positions to compensate for the shift)
v1.8.1,"Regrab the player's position after the offset has been added (which should be 0,0,0 now)"
v1.8.1,UWeatherLib::showWeatherMenu(World);
v1.8.1,else don't init
v1.8.1,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v1.8.1,tod_sim_clock_start_ needs to be reset here.
v1.8.1,Going from enabled to disabled
v1.8.1,do these in the end to ensure that advanceTimeOfDay() doesn't see
v1.8.1,any inconsistent state.
v1.8.1,should be overridden by derived class
v1.8.1,should be overriden by derived class
v1.8.1,should be overridden by derived class
v1.8.1,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.8.1,default setup - this should be overridden in derived modes as needed
v1.8.1,setup clock in ClockFactory
v1.8.1,default implementation
v1.8.1,create director
v1.8.1,create external camera required for the director
v1.8.1,for each camera in settings
v1.8.1,get pose
v1.8.1,spawn and attach camera to pawn
v1.8.1,add on to our collection
v1.8.1,API server start/stop
v1.8.1,get UU origin of global NED frame
v1.8.1,compute initial pose
v1.8.1,spawn vehicle pawn
v1.8.1,create vehicle sim api
v1.8.1,Convert to lowercase as done during settings loading
v1.8.1,TODO: Figure out a better way to add more fields
v1.8.1,Maybe allow passing a JSON string for the vehicle settings?
v1.8.1,"Retroactively adjust AirSimSettings, so it's like we knew about this vehicle all along"
v1.8.1,"Usually physics registration happens at init, in ASimModeWorldBase::initializeForPlay(), but not in this case"
v1.8.1,get UU origin of global NED frame
v1.8.1,determine camera director camera default pose and spawn it
v1.8.1,find all vehicle pawns
v1.8.1,add vehicles from settings
v1.8.1,if vehicle is of type for derived SimMode and auto creatable
v1.8.1,create API objects for each pawn we have
v1.8.1,Create External Cameras
v1.8.1,TODO: better handle no FPV vehicles scenario
v1.8.1,derived class shoudl override this method to add new vehicle to the physics engine
v1.8.1,derived class should override this method to retrieve types of pawns they support
v1.8.1,derived class should override this method to retrieve types of pawns they support
v1.8.1,derived class should override this method to retrieve types of pawns they support
v1.8.1,derived class should override this method to retrieve types of pawns they support
v1.8.1,derived class should override this method to retrieve types of pawns they support
v1.8.1,derived class should override this method to retrieve types of pawns they support
v1.8.1,derived class should override this method to retrieve types of pawns they support
v1.8.1,Draws debug-points on main viewport for Lidar laser hits.
v1.8.1,Used for debugging only.
v1.8.1,Currently we are checking the sensor-collection instead of sensor-settings.
v1.8.1,Also using variables to optimize not checking the collection if not needed.
v1.8.1,TODO: Is it incorrect to assume LidarSimple here?
v1.8.1,Draw debug-point on main viewport for Distance sensor hit
v1.8.1,Find position of point hit
v1.8.1,Similar to UnrealDistanceSensor.cpp#L19
v1.8.1,order of Pose addition is important here because it also adds quaternions which is not commutative!
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,ctor
v1.8.1,initializes information based on lidar configuration
v1.8.1,calculate verticle angle distance between each laser
v1.8.1,store vertical angles for each laser
v1.8.1,returns a point-cloud for the tick
v1.8.1,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.8.1,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.8.1,calculate number of points needed for each laser/channel
v1.8.1,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.8.1,calculate needed angle/distance between each point
v1.8.1,normalize FOV start/end
v1.8.1,shoot lasers
v1.8.1,check if the laser is outside the requested horizontal FOV
v1.8.1,"shoot laser and get the impact point, if any"
v1.8.1,simulate shooting a laser via Unreal ray-tracing.
v1.8.1,start position
v1.8.1,We need to compose rotations here rather than rotate a vector by a quaternion
v1.8.1,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.8.1,get ray quaternion in lidar frame (angles must be in radians)
v1.8.1,get ray quaternion in body frame
v1.8.1,get ray quaternion in world frame
v1.8.1,get ray vector (end position)
v1.8.1,Store the segmentation id of the hit object.
v1.8.1,Debug code for very specific cases.
v1.8.1,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.8.1,decide the frame for the point-cloud
v1.8.1,current detault behavior; though it is probably not very useful.
v1.8.1,not changing the default for now to maintain backwards-compat.
v1.8.1,point in vehicle intertial frame
v1.8.1,tranform to lidar frame
v1.8.1,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.8.1,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.8.1,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.8.1,"On the client side, if it is needed to transform this data back to the world frame,"
v1.8.1,"then do the equivalent of following,"
v1.8.1,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.8.1,See SimModeBase::drawLidarDebugPoints()
v1.8.1,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.8.1,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,update ray tracing
v1.8.1,"FString hit_name = FString(""None"");"
v1.8.1,if (dist_hit.GetActor())
v1.8.1,hit_name=dist_hit.GetActor()->GetName();
v1.8.1,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.8.1,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,This assumes you are running DroneServer already on the same machine.
v1.8.1,DroneServer must be running first.
v1.8.1,enable API control
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,Load gazebo
v1.8.1,Create our node for communication
v1.8.1,Listen to Gazebo topics
v1.8.1,Make sure to shut everything down.
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,move commands
v1.8.1,else leave as it is
v1.8.1,TODO: get these in one call
v1.8.1,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.8.1,TODO: shouldn't we pass folder path?
v1.8.1,parse
v1.8.1,group the images by the current date.
v1.8.1,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.8.1,{
v1.8.1,"return """";"
v1.8.1,}
v1.8.1,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.8.1,{
v1.8.1,return false;
v1.8.1,}
v1.8.1,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.8.1,params.context->client.newTask();
v1.8.1,}
v1.8.1,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.8.1,params.context->client.WaitForCompletion(0);
v1.8.1,}
v1.8.1,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.8.1,{
v1.8.1,}
v1.8.1,parse command line
v1.8.1,Shell callbacks
v1.8.1,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.8.1,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.8.1,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.8.1,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.8.1,Add shell commands
v1.8.1,TODO: add WaitForCompletion command
v1.8.1,"TODO: add command line args help, arg count validation"
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v1.8.1,switch to explicit hover mode so that this is the fall back when
v1.8.1,move* commands are finished.
v1.8.1,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.8.1,TODO: implement weather for Unity
v1.8.1,TODO: implement weather for Unity
v1.8.1,----------------Plotting APIs-----------/
v1.8.1,Recording APIs
v1.8.1,"Remove '' from the list, representing default vehicle"
v1.8.1,CinemAirSim
v1.8.1,End CinemAirSim
v1.8.1,Function pointers to hold the addresses of the functions that are defined in Unity
v1.8.1,"Enabling all LogLevels,"
v1.8.1,"Enabling all LogLevels,"
v1.8.1,delete ltm;
v1.8.1,initialize state
v1.8.1,compute our home point
v1.8.1,default behavior is to call update every tick
v1.8.1,"for custom physics engine, this method should be overridden and update should be"
v1.8.1,called from every physics tick
v1.8.1,these will be available for devices like steering wheels
v1.8.1,sync environment from kinematics
v1.8.1,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.8.1,FVector unrealPosition = getUUPosition();
v1.8.1,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v1.8.1,parameters in NED frame
v1.8.1,allow teleportation
v1.8.1,if collisions are not enabled
v1.8.1,or we have collided but passthrough is enabled
v1.8.1,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.8.1,"without flip flopping, collisions can't be detected"
v1.8.1,by default we update kinematics from UE pawn
v1.8.1,if SimMod uses its own physics engine then this should be overriden
v1.8.1,no default action in this base class
v1.8.1,TODO: because this bug we are using alternative code with stringstream
v1.8.1,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.8.1,update kinematics from pawn's movement instead of physics engine
v1.8.1,TODO: update other fields?
v1.8.1,implements getImages() method in the ImageCaptureBase class.
v1.8.1,update ray tracing
v1.8.1,Attempts to parse the settings text from one of multiple locations.
v1.8.1,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.8.1,"Next, check the executable's working directory for the settings file."
v1.8.1,"Finally, check the user's documents folder."
v1.8.1,"If the settings file cannot be read, throw an exception"
v1.8.1,let base class setup physics world
v1.8.1,stop physics thread before we dismantle
v1.8.1,setup clock in ClockFactory
v1.8.1,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.8.1,steppable clock returns interval that is a constant number irrespective of wall clock
v1.8.1,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.8.1,but that would cause vehicles like quadrotors to become unstable
v1.8.1,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.8.1,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.8.1,get increase in clock speed
v1.8.1,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.8.1,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.8.1,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.8.1,Approach 2: scale control loop frequency if clock is speeded up
v1.8.1,"for slowing down, this don't generate instability"
v1.8.1,-------------------------------- overrides -----------------------------------------------//
v1.8.1,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.8.1,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.8.1,create vehicle API
v1.8.1,setup physics vehicle
v1.8.1,initialize private vars
v1.8.1,"if reset is pending then do it first, no need to do other things until next tick"
v1.8.1,move collision info from rendering engine to vehicle
v1.8.1,update rotor poses
v1.8.1,if we did reset then don't worry about synchronizing states for this tick
v1.8.1,Continue to wait for reset
v1.8.1,*** Start: UpdatableState implementation ***//
v1.8.1,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.8.1,environment update for current position
v1.8.1,update forces on vertices
v1.8.1,update to controller must be done after kinematics have been updated by physics engine
v1.8.1,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.8.1,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.8.1,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.8.1,*** End: UpdatableState implementation ***//
v1.8.1,TODO: should do reset() here?
v1.8.1,these are called on render ticks
v1.8.1,TODO: do we need this for cars?
v1.8.1,Thrustmaster devices
v1.8.1,"Anything else, typically Logitech G920 wheel"
v1.8.1,Two steel levers behind wheel
v1.8.1,if API-client control is not active then we route keyboard/joystick control to car
v1.8.1,This is so that getCarControls API works correctly
v1.8.1,"API is enabled, so we use the controls set by API"
v1.8.1,Update whether to use API controls or keyboard controls
v1.8.1,*** Start: UpdatableState implementation ***//
v1.8.1,physics tick
v1.8.1,void CarPawnSimApi::reportState(StateReporter& reporter)
v1.8.1,{
v1.8.1,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.8.1,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.8.1,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.8.1,}
v1.8.1,*** End: UpdatableState implementation ***//
v1.8.1,remove everything that we created in BeginPlay
v1.8.1,we use custom debug reporting for this class
v1.8.1,perform any expensive rendering update outside of lock region
v1.8.1,no need to call base reset because of our custom implementation
v1.8.1,should be overridden by derived class
v1.8.1,should be overridden by derived class
v1.8.1,should be overridden by derived class
v1.8.1,commenting this out for now to avoid unintentional Unity startup failure
v1.8.1,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v1.8.1,should be overridden by derived class
v1.8.1,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.8.1,default setup - this should be overridden in derived modes as needed
v1.8.1,setup clock in ClockFactory
v1.8.1,API server start/stop
v1.8.1,determine camera director camera default pose and spawn it
v1.8.1,derived class should override this method to retrieve types of pawns they support
v1.8.1,derived class should override this method to retrieve types of pawns they support
v1.8.1,can we just take origin in Unity here?
v1.8.1,60 acres park:
v1.8.1,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.8.1,marymoore park
v1.8.1,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.8.1,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.8.1,DepthNavThreshold depthNav;
v1.8.1,DepthNavOptAStar depthNav;
v1.8.1,DepthNavThreshold depthNav;
v1.8.1,DepthNavOptAStar depthNav;
v1.8.1,runDepthNavGT();
v1.8.1,runDepthNavSGM();
v1.8.1,Create the launch description and populate
v1.8.1,Declare the launch options
v1.8.1,todo do not reset if already in air?
v1.8.1,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.8.1,ros params
v1.8.1,todo enforce dynamics constraints in this node as well?
v1.8.1,"nh_->get_parameter(""max_vert_vel_"", max_vert_vel_);"
v1.8.1,"nh_->get_parameter(""max_horz_vel"", max_horz_vel_)"
v1.8.1,subscribe to control commands on global nodehandle
v1.8.1,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.8.1,bind to a single callback. todo optimal subs queue length
v1.8.1,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.8.1,"vehicle_ros.reset_srvr = nh_->create_service(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.8.1,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.8.1,camera_setting.gimbal
v1.8.1,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.8.1,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.8.1,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.8.1,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.8.1,"if {DepthPlanar, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.8.1,"push back pair (vector of image captures, current vehicle name)"
v1.8.1,iterate over sensors
v1.8.1,add takeoff and land all services if more than 2 drones
v1.8.1,todo add per vehicle reset in AirLib API
v1.8.1,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.8.1,lidars update on their own callback/thread at a given rate
v1.8.1,QoS - The depth of the publisher message queue.
v1.8.1,more details here - https://docs.ros.org/en/foxy/Concepts/About-Quality-of-Service-Settings.html
v1.8.1,"todo: error check. if state is not landed, return error."
v1.8.1,response->success =
v1.8.1,response->success =
v1.8.1,response->success =
v1.8.1,response->success =
v1.8.1,response->success =
v1.8.1,response->success =
v1.8.1,todo add reset by vehicle_name API to airlib
v1.8.1,todo not async remove wait_on_last_task
v1.8.1,todo expose wait_on_last_task or nah?
v1.8.1,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.8.1,todo expose wait_on_last_task or nah?
v1.8.1,todo support multiple gimbal commands
v1.8.1,todo support multiple gimbal commands
v1.8.1,1. find quaternion of default gimbal pose
v1.8.1,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.8.1,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.8.1,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.8.1,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.8.1,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.8.1,msg = []
v1.8.1,todo covariances
v1.8.1,gps_msg.position_covariance_type =
v1.8.1,gps_msg.position_covariance =
v1.8.1,todo covariances
v1.8.1,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.8.1,todo radians per second
v1.8.1,meters/s2^m
v1.8.1,imu_msg.orientation_covariance = ;
v1.8.1,imu_msg.angular_velocity_covariance = ;
v1.8.1,imu_msg.linear_acceleration_covariance = ;
v1.8.1,todo do actual body frame?
v1.8.1,airsim uses degrees
v1.8.1,todo this is global origin
v1.8.1,get the basic vehicle pose and environmental state
v1.8.1,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.8.1,airsim_client needs to provide the simulation time in a future version of the API
v1.8.1,publish the simulation clock
v1.8.1,"publish vehicle state, odom, and all basic sensor types"
v1.8.1,send any commands out to the vehicles
v1.8.1,"should be easier way to get the sim time through API, something like:"
v1.8.1,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.8.1,curr_ros_time = rclcpp::Time(env.clock().nowNanos());
v1.8.1,iterate over drones
v1.8.1,get drone state from airsim
v1.8.1,"vehicle environment, we can get ambient temperature here and other truths"
v1.8.1,convert airsim drone state to ROS msgs
v1.8.1,simulation environment truth
v1.8.1,"dashboard reading from car, RPM, gear, etc"
v1.8.1,odom and transforms
v1.8.1,ground truth GPS position from sim/HITL
v1.8.1,send control commands from the last callback to airsim
v1.8.1,send control commands from the last callback to airsim
v1.8.1,"Only camera rotation, no translation movement of camera"
v1.8.1,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.8.1,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.8.1,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.8.1,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.8.1,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.8.1,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.8.1,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.8.1,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.8.1,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.8.1,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.8.1,update timestamp of saved cam info msgs
v1.8.1,DepthPlanar / DepthPerspective / DepthVis / DisparityNormalized
v1.8.1,Scene / Segmentation / SurfaceNormals / Infrared
v1.8.1,publish camera transforms
v1.8.1,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.8.1,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.8.1,ROS params
v1.8.1,ROS publishers
v1.8.1,ROS subscribers
v1.8.1,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.8.1,ROS timers
v1.8.1,todo maintain internal representation as eigen vec?
v1.8.1,todo check if low velocity if within thresh?
v1.8.1,todo maintain separate errors for XY and Z
v1.8.1,todo save this in degrees somewhere to avoid repeated conversion
v1.8.1,this tells the update timer callback to not do active hovering
v1.8.1,todo maintain array of position goals
v1.8.1,todo error checks
v1.8.1,todo fill response
v1.8.1,"Already have goal, and have reached it"
v1.8.1,this tells the update timer callback to not do active hovering
v1.8.1,todo error checks
v1.8.1,todo fill response
v1.8.1,"todo do relative altitude, or add an option for the same?"
v1.8.1,convert GPS goal to NED goal
v1.8.1,"RCLCPP_INFO_STREAM(""geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.8.1,todo error checks
v1.8.1,todo fill response
v1.8.1,"Already have goal, this shouldn't happen"
v1.8.1,"todo do relative altitude, or add an option for the same?"
v1.8.1,convert GPS goal to NED goal
v1.8.1,"RCLCPP_INFO_STREAM(""geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.8.1,todo error checks
v1.8.1,todo fill response
v1.8.1,todo check if odometry is too old!!
v1.8.1,"if no odom, don't do anything."
v1.8.1,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.8.1,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.8.1,todo just add a sgn funciton in common utils? return double to be safe.
v1.8.1,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.8.1,todo yaw limits
v1.8.1,todo just add a sgn funciton in common utils? return double to be safe.
v1.8.1,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.8.1,mimics void ASimHUD::initializeSettings()
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,by Sudipta Sinha
v1.8.1,adapted for AirSim by Matthias Mueller
v1.8.1,first row
v1.8.1,last row
v1.8.1,Local quadratic fit of cost and subpixel refinement.
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,by Sudipta Sinha
v1.8.1,adapted for AirSim by Matthias Mueller
v1.8.1,uint64_t x64 = (uint64_t)x;
v1.8.1,uint64_t y64 = (uint64_t)y;
v1.8.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.1,Licensed under the MIT License.
v1.8.1,by Sudipta Sinha
v1.8.1,adapted for AirSim by Matthias Mueller
v1.8.1,ensure that disparity range is a multiple of 8
v1.8.1,sgm stereo
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,read settings and override defaults
v1.8.0-windows,allow json overrides on a per-vehicle basis.
v1.8.0-windows,start server in async mode
v1.8.0-windows,check messages
v1.8.0-windows,plot red arrows for 30 seconds
v1.8.0-windows,plot magenta arrows for 15 seconds
v1.8.0-windows,plot red arrows for 10 seconds
v1.8.0-windows,plot 2 white arrows which are persistent
v1.8.0-windows,plot points
v1.8.0-windows,"plot line strip. 0-1, 1-2, 2-3"
v1.8.0-windows,"plot line list. 0-1, 2-3, 4-5. Must be even."
v1.8.0-windows,plot transforms
v1.8.0-windows,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=0.0, yaw=yaw)) for x, y, yaw in zip(np.linspace(0,10,10), np.linspace(0,0,10), np.linspace(0,np.pi,10))],"
v1.8.0-windows,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.8.0-windows,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=roll, yaw=0.0)) for x, y, roll in zip(np.linspace(0,10,10), np.linspace(1,1,10), np.linspace(0,np.pi,10))],"
v1.8.0-windows,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.8.0-windows,Access an existing light in the world
v1.8.0-windows,Destroy the light
v1.8.0-windows,Create a new light at the same pose
v1.8.0-windows,Change the light's intensity
v1.8.0-windows,asset_name = random.choice(assets)
v1.8.0-windows,Import this module to automatically setup path to local airsim module
v1.8.0-windows,This module first tries to see if airsim module is installed via pip
v1.8.0-windows,If it does then we don't do anything else
v1.8.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.8.0-windows,and if it does then we add that in sys.path
v1.8.0-windows,this class simply tries to see if airsim
v1.8.0-windows,if airsim module is installed then don't do anything else
v1.8.0-windows,import pkgutil
v1.8.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.8.0-windows,if airsim_loader is not None:
v1.8.0-windows,return
v1.8.0-windows,In settings.json first activate computer vision mode:
v1.8.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.8.0-windows,monitor car state while you drive it manually.
v1.8.0-windows,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v1.8.0-windows,denominator from microns^3 to microns * m^2)
v1.8.0-windows,First set everything to 0.
v1.8.0-windows,Next set all objects of interest provided to corresponding object IDs
v1.8.0-windows,segIdDict values MUST match tempEmissivityNew labels.
v1.8.0-windows,"Connect to AirSim, UAV mode."
v1.8.0-windows,Choose temperature values for winter or summer.
v1.8.0-windows,""""""""
v1.8.0-windows,winter
v1.8.0-windows,""""""""
v1.8.0-windows,summer
v1.8.0-windows,Read camera response.
v1.8.0-windows,Calculate radiance.
v1.8.0-windows,Set IDs in AirSim environment.
v1.8.0-windows,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.8.0-windows,save pic
v1.8.0-windows,Change the below dimensions appropriately for the camera settings
v1.8.0-windows,In settings.json first activate computer vision mode:
v1.8.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.8.0-windows,"define abstract class to return next vector in the format (x,y,yaw)"
v1.8.0-windows,"compute vector, distance and angle to goal"
v1.8.0-windows,compute box of interest
v1.8.0-windows,scale by weight matrix (optional)
v1.8.0-windows,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.8.0-windows,detect collision
v1.8.0-windows,compute box of interest
v1.8.0-windows,detect collision
v1.8.0-windows,Same as above but decide to go left or right based on average or some metric like that
v1.8.0-windows,"compute resultant normalized vector, distance and angle"
v1.8.0-windows,compute bounding box size
v1.8.0-windows,convert horizonal fov to vertical fov
v1.8.0-windows,matrix with all ones
v1.8.0-windows,matrix with max weight in center and decreasing linearly with distance from center
v1.8.0-windows,matrix with max weight in center and decreasing quadratically with distance from center
v1.8.0-windows,"print (""Saving images to %s"" % tmp_dir)"
v1.8.0-windows,airsim.wait_key('Press any key to start')
v1.8.0-windows,"Define start position, goal and size of UAV"
v1.8.0-windows,Define parameters and thresholds
v1.8.0-windows,initial position
v1.8.0-windows,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.8.0-windows,time.sleep(1)
v1.8.0-windows,get response
v1.8.0-windows,get numpy array
v1.8.0-windows,reshape array to 2D array H X W
v1.8.0-windows,write to png
v1.8.0-windows,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.8.0-windows,pose = client.simGetPose()
v1.8.0-windows,pp.pprint(pose)
v1.8.0-windows,time.sleep(5)
v1.8.0-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.8.0-windows,################### OLD CODE
v1.8.0-windows,timer = 0
v1.8.0-windows,time_obs = 50
v1.8.0-windows,bObstacle = False
v1.8.0-windows,if (bObstacle):
v1.8.0-windows,timer = timer + 1
v1.8.0-windows,if timer > time_obs:
v1.8.0-windows,bObstacle = False
v1.8.0-windows,timer = 0
v1.8.0-windows,else:
v1.8.0-windows,yaw = target_angle
v1.8.0-windows,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.8.0-windows,if (np.average(img2d_box) < coll_thres):
v1.8.0-windows,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.8.0-windows,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.8.0-windows,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.8.0-windows,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.8.0-windows,"print('left: ', img2d_box_l_avg)"
v1.8.0-windows,"print('right: ', img2d_box_r_avg)"
v1.8.0-windows,if img2d_box_l_avg > img2d_box_r_avg:
v1.8.0-windows,##Go LEFT
v1.8.0-windows,#y_offset = y_offset-1
v1.8.0-windows,yaw = yaw - radians(10)
v1.8.0-windows,bObstacle = True
v1.8.0-windows,else:
v1.8.0-windows,##Go RIGHT
v1.8.0-windows,#y_offset = y_offset+1
v1.8.0-windows,yaw = yaw + radians(10)
v1.8.0-windows,bObstacle = true
v1.8.0-windows,"print('yaw: ', yaw)"
v1.8.0-windows,In settings.json first activate computer vision mode:
v1.8.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.8.0-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.8.0-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.8.0-windows,pip install opencv-python
v1.8.0-windows,Just change the below to test different cameras easily!
v1.8.0-windows,Test Camera info
v1.8.0-windows,Test Image APIs
v1.8.0-windows,Test FoV API
v1.8.0-windows,Test Pose APIs
v1.8.0-windows,Test Distortion params APIs
v1.8.0-windows,In settings.json first activate computer vision mode:
v1.8.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.8.0-windows,In settings.json first activate computer vision mode:
v1.8.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.8.0-windows,for block environment
v1.8.0-windows,regex are case insensitive
v1.8.0-windows,#for neighborhood environment
v1.8.0-windows,set object ID for sky
v1.8.0-windows,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.8.0-windows,get segmentation image in various formats
v1.8.0-windows,save segmentation images in various formats
v1.8.0-windows,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.8.0-windows,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.8.0-windows,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v1.8.0-windows,find unique colors
v1.8.0-windows,In settings.json first activate computer vision mode:
v1.8.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.8.0-windows,objects can be named in two ways:
v1.8.0-windows,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.8.0-windows,default name is auto-generated and varies from run-to-run.
v1.8.0-windows,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.8.0-windows,
v1.8.0-windows,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.8.0-windows,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.8.0-windows,https://answers.unrealengine.com/revisions/790629.html
v1.8.0-windows,below works in Blocks environment
v1.8.0-windows,------------------------------------ Get current pose ------------------------------------------------
v1.8.0-windows,search object by name:
v1.8.0-windows,search another object by tag
v1.8.0-windows,search non-existent object
v1.8.0-windows,------------------------------------ Set new pose ------------------------------------------------
v1.8.0-windows,here we move with teleport enabled so collisions are ignored
v1.8.0-windows,here we move with teleport enabled so collisions are not ignored
v1.8.0-windows,move non-existent object
v1.8.0-windows,------------------------------------ Get new pose ------------------------------------------------
v1.8.0-windows,search another object by tag
v1.8.0-windows,search non-existent object
v1.8.0-windows,Import this module to automatically setup path to local airsim module
v1.8.0-windows,This module first tries to see if airsim module is installed via pip
v1.8.0-windows,If it does then we don't do anything else
v1.8.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.8.0-windows,and if it does then we add that in sys.path
v1.8.0-windows,this class simply tries to see if airsim
v1.8.0-windows,if airsim module is installed then don't do anything else
v1.8.0-windows,import pkgutil
v1.8.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.8.0-windows,if airsim_loader is not None:
v1.8.0-windows,return
v1.8.0-windows,"Roll is applied first, then pitch, then yaw."
v1.8.0-windows,Turn the camera position into a column vector.
v1.8.0-windows,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v1.8.0-windows,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v1.8.0-windows,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v1.8.0-windows,Recreate the perspective projection of the camera.
v1.8.0-windows,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v1.8.0-windows,Set pose and sleep after to ensure the pose sticks before capturing image.
v1.8.0-windows,Capture segmentation (IR) and scene images.
v1.8.0-windows,Change images into numpy arrays.
v1.8.0-windows,Capture images for a certain amount of time in seconds (half hour now)
v1.8.0-windows,Capture image - pose.position x_val access may change w/ AirSim
v1.8.0-windows,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v1.8.0-windows,Convert color scene image to BGR for write out with cv2.
v1.8.0-windows,"Connect to AirSim, UAV mode."
v1.8.0-windows,Look for objects with names that match a regular expression.
v1.8.0-windows,"Sample calls to main, varying camera angle and altitude."
v1.8.0-windows,"straight down, 400ft"
v1.8.0-windows,"straight down, 200ft"
v1.8.0-windows,"45 degrees, 200ft -- note that often object won't be scene since position"
v1.8.0-windows,is set exactly to object's
v1.8.0-windows,"45 degrees, 400ft -- note that often object won't be scene since position"
v1.8.0-windows,is set exactly to object's
v1.8.0-windows,In settings.json first activate computer vision mode:
v1.8.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.8.0-windows,xn = 1 + x*5  # some random number
v1.8.0-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,monitor car state while you drive it manually.
v1.8.0-windows,get state of the car
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,!/usr/bin/env python3
v1.8.0-windows,-*- coding: utf-8 -*-
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,set the controls for car
v1.8.0-windows,let car drive a bit
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,go forward
v1.8.0-windows,get state of the car
v1.8.0-windows,Python client example to change time-of-day using APIs
v1.8.0-windows,
v1.8.0-windows,Changes time of the day and makes the car move around
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,flip between specific time and default time
v1.8.0-windows,go forward
v1.8.0-windows,Go forward + steer right
v1.8.0-windows,main
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,get state of the car
v1.8.0-windows,go forward
v1.8.0-windows,Go forward + steer right
v1.8.0-windows,go reverse
v1.8.0-windows,apply brakes
v1.8.0-windows,get camera images from the car
v1.8.0-windows,restore to original state
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,go forward
v1.8.0-windows,Python client example to get Lidar data from a car
v1.8.0-windows,
v1.8.0-windows,Makes the drone fly and get Lidar data
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,"print(""state: %s"" % s)"
v1.8.0-windows,go forward
v1.8.0-windows,Go forward + steer right
v1.8.0-windows,"reshape array of floats to array of [X,Y,Z]"
v1.8.0-windows,TODO
v1.8.0-windows,main
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,get state of the car
v1.8.0-windows,go forward
v1.8.0-windows,Go forward + steer right
v1.8.0-windows,go reverse
v1.8.0-windows,apply breaks
v1.8.0-windows,restore to original state
v1.8.0-windows,Sleep for some time to wait for other vehicles to be created
v1.8.0-windows,"driveCar(vehicle_name, client)"
v1.8.0-windows,go forward
v1.8.0-windows,Go forward + steer right
v1.8.0-windows,go reverse
v1.8.0-windows,apply brakes
v1.8.0-windows,Import this module to automatically setup path to local airsim module
v1.8.0-windows,This module first tries to see if airsim module is installed via pip
v1.8.0-windows,If it does then we don't do anything else
v1.8.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.8.0-windows,and if it does then we add that in sys.path
v1.8.0-windows,this class simply tries to see if airsim
v1.8.0-windows,if airsim module is installed then don't do anything else
v1.8.0-windows,import pkgutil
v1.8.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.8.0-windows,if airsim_loader is not None:
v1.8.0-windows,return
v1.8.0-windows,Use below in settings.json with blocks environment
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,get state of the car
v1.8.0-windows,go forward
v1.8.0-windows,go reverse
v1.8.0-windows,apply breaks
v1.8.0-windows,get camera images from the car
v1.8.0-windows,restore to original state
v1.8.0-windows,from keras.models import load_model
v1.8.0-windows,if (len(sys.argv) != 2):
v1.8.0-windows,print('usage: python drive.py <modelName>')
v1.8.0-windows,sys.exit()
v1.8.0-windows,print('Loading model...')
v1.8.0-windows,model = load_model(sys.argv[1])
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.8.0-windows,"model_output = model.predict([image_buf, state_buf])"
v1.8.0-windows,car_controls.steering = float(model_output[0][0])
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,set camera name and image type to request images and detections
v1.8.0-windows,set detection radius in [cm]
v1.8.0-windows,add desired object name to detect in wild card/regex format
v1.8.0-windows,Import this module to automatically setup path to local airsim module
v1.8.0-windows,This module first tries to see if airsim module is installed via pip
v1.8.0-windows,If it does then we don't do anything else
v1.8.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.8.0-windows,and if it does then we add that in sys.path
v1.8.0-windows,this class simply tries to see if airsim
v1.8.0-windows,if airsim module is installed then don't do anything else
v1.8.0-windows,import pkgutil
v1.8.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.8.0-windows,if airsim_loader is not None:
v1.8.0-windows,return
v1.8.0-windows,-*- coding: utf-8 -*-
v1.8.0-windows,
v1.8.0-windows,Configuration file for the Sphinx documentation builder.
v1.8.0-windows,
v1.8.0-windows,This file does only contain a selection of the most common options. For a
v1.8.0-windows,full list see the documentation:
v1.8.0-windows,http://www.sphinx-doc.org/en/master/config
v1.8.0-windows,-- Path setup --------------------------------------------------------------
v1.8.0-windows,"If extensions (or modules to document with autodoc) are in another directory,"
v1.8.0-windows,add these directories to sys.path here. If the directory is relative to the
v1.8.0-windows,"documentation root, use os.path.abspath to make it absolute, like shown here."
v1.8.0-windows,
v1.8.0-windows,-- Project information -----------------------------------------------------
v1.8.0-windows,The short X.Y version
v1.8.0-windows,"The full version, including alpha/beta/rc tags"
v1.8.0-windows,-- General configuration ---------------------------------------------------
v1.8.0-windows,"If your documentation needs a minimal Sphinx version, state it here."
v1.8.0-windows,
v1.8.0-windows,needs_sphinx = '1.0'
v1.8.0-windows,"Add any Sphinx extension module names here, as strings. They can be"
v1.8.0-windows,extensions coming with Sphinx (named 'sphinx.ext.*') or your custom
v1.8.0-windows,ones.
v1.8.0-windows,"Add any paths that contain templates here, relative to this directory."
v1.8.0-windows,The suffix(es) of source filenames.
v1.8.0-windows,You can specify multiple suffix as a list of string:
v1.8.0-windows,
v1.8.0-windows,"source_suffix = ['.rst', '.md']"
v1.8.0-windows,The master toctree document.
v1.8.0-windows,The language for content autogenerated by Sphinx. Refer to documentation
v1.8.0-windows,for a list of supported languages.
v1.8.0-windows,
v1.8.0-windows,This is also used if you do content translation via gettext catalogs.
v1.8.0-windows,"Usually you set ""language"" from the command line for these cases."
v1.8.0-windows,"List of patterns, relative to source directory, that match files and"
v1.8.0-windows,directories to ignore when looking for source files.
v1.8.0-windows,This pattern also affects html_static_path and html_extra_path.
v1.8.0-windows,The name of the Pygments (syntax highlighting) style to use.
v1.8.0-windows,-- Options for HTML output -------------------------------------------------
v1.8.0-windows,The theme to use for HTML and HTML Help pages.  See the documentation for
v1.8.0-windows,a list of builtin themes.
v1.8.0-windows,
v1.8.0-windows,html_theme = 'alabaster'
v1.8.0-windows,Theme options are theme-specific and customize the look and feel of a theme
v1.8.0-windows,"further.  For a list of options available for each theme, see the"
v1.8.0-windows,documentation.
v1.8.0-windows,
v1.8.0-windows,html_theme_options = {}
v1.8.0-windows,"Add any paths that contain custom static files (such as style sheets) here,"
v1.8.0-windows,"relative to this directory. They are copied after the builtin static files,"
v1.8.0-windows,"so a file named ""default.css"" will overwrite the builtin ""default.css""."
v1.8.0-windows,"Custom sidebar templates, must be a dictionary that maps document names"
v1.8.0-windows,to template names.
v1.8.0-windows,
v1.8.0-windows,The default sidebars (for documents that don't match any pattern) are
v1.8.0-windows,defined by theme itself.  Builtin themes are using these templates by
v1.8.0-windows,"default: ``['localtoc.html', 'relations.html', 'sourcelink.html',"
v1.8.0-windows,'searchbox.html']``.
v1.8.0-windows,
v1.8.0-windows,html_sidebars = {}
v1.8.0-windows,-- Options for HTMLHelp output ---------------------------------------------
v1.8.0-windows,Output file base name for HTML help builder.
v1.8.0-windows,-- Options for LaTeX output ------------------------------------------------
v1.8.0-windows,The paper size ('letterpaper' or 'a4paper').
v1.8.0-windows,
v1.8.0-windows,"'papersize': 'letterpaper',"
v1.8.0-windows,"The font size ('10pt', '11pt' or '12pt')."
v1.8.0-windows,
v1.8.0-windows,"'pointsize': '10pt',"
v1.8.0-windows,Additional stuff for the LaTeX preamble.
v1.8.0-windows,
v1.8.0-windows,"'preamble': '',"
v1.8.0-windows,Latex figure (float) alignment
v1.8.0-windows,
v1.8.0-windows,"'figure_align': 'htbp',"
v1.8.0-windows,Grouping the document tree into LaTeX files. List of tuples
v1.8.0-windows,"(source start file, target name, title,"
v1.8.0-windows,"author, documentclass [howto, manual, or own class])."
v1.8.0-windows,-- Options for manual page output ------------------------------------------
v1.8.0-windows,One entry per manual page. List of tuples
v1.8.0-windows,"(source start file, name, description, authors, manual section)."
v1.8.0-windows,-- Options for Texinfo output ----------------------------------------------
v1.8.0-windows,Grouping the document tree into Texinfo files. List of tuples
v1.8.0-windows,"(source start file, target name, title, author,"
v1.8.0-windows,"dir menu entry, description, category)"
v1.8.0-windows,-- Options for Epub output -------------------------------------------------
v1.8.0-windows,Bibliographic Dublin Core info.
v1.8.0-windows,The unique identifier of the text. This can be a ISBN number
v1.8.0-windows,or the project homepage.
v1.8.0-windows,
v1.8.0-windows,epub_identifier = ''
v1.8.0-windows,A unique identification for the text.
v1.8.0-windows,
v1.8.0-windows,epub_uid = ''
v1.8.0-windows,A list of files that should not be packed into the epub file.
v1.8.0-windows,-- Extension configuration -------------------------------------------------
v1.8.0-windows,-- Options for intersphinx extension ---------------------------------------
v1.8.0-windows,Example configuration for intersphinx: refer to the Python standard library.
v1.8.0-windows,-- Options for todo extension ----------------------------------------------
v1.8.0-windows,"If true, `todo` and `todoList` produce output, else they produce nothing."
v1.8.0-windows,We ignore the 2D nature of the problem as it is not relevant here
v1.8.0-windows,It makes multi-core processing more straightforward
v1.8.0-windows,Allocations
v1.8.0-windows,Add small number to avoid issues with log(I)
v1.8.0-windows,Event sim keeps track of previous image automatically
v1.8.0-windows,"Using pickle dump in a per-frame fashion to save time, instead of savetxt"
v1.8.0-windows,Optimizations possible
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,that's enough fun for now. let's quit cleanly
v1.8.0-windows,"Python client example to get Lidar data from a drone, although this script works for any AirSim-supported vehicle"
v1.8.0-windows,This script is for Lidar sensors using 'SensorLocalFrame' as DataFrame under settings.json.
v1.8.0-windows,Sample settings.json used for this script:
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,main
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,MultirotorClient.wait_key('Press any key to takeoff')
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,get camera images from the car
v1.8.0-windows,that's enough fun for now. let's quit cleanly
v1.8.0-windows,##################################################################################################
v1.8.0-windows,
v1.8.0-windows,Project:  Embedded Learning Library (ELL)
v1.8.0-windows,File:     speaker.py
v1.8.0-windows,Authors:  Chris Lovett
v1.8.0-windows,
v1.8.0-windows,Requires: Python 3.x
v1.8.0-windows,
v1.8.0-windows,##################################################################################################
v1.8.0-windows,open speakers so we can hear what it is processing...
v1.8.0-windows,teleport the drone + 10 meters in x-direction
v1.8.0-windows,teleport the drone back
v1.8.0-windows,This example shows how to use the External Physics Engine
v1.8.0-windows,It allows you to control the drone through setVehiclePose and obtain collision information.
v1.8.0-windows,It is especially useful for injecting your own flight dynamics model to the AirSim drone.
v1.8.0-windows,Use Blocks environment to see the drone colliding and seeing the collision information
v1.8.0-windows,in the command prompt.
v1.8.0-windows,Add this line to your settings.json before running AirSim:
v1.8.0-windows,"""PhysicsEngineName"":""ExternalPhysicsEngine"""
v1.8.0-windows,use open cv to create point cloud from depth image.
v1.8.0-windows,###########################################
v1.8.0-windows,######### This is work in progress! #######
v1.8.0-windows,###########################################
v1.8.0-windows,file will be saved in PythonClient folder (i.e. same folder as script)
v1.8.0-windows,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.8.0-windows,skip it
v1.8.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.8.0-windows,z of -7 is 7 meters above the original launch point.
v1.8.0-windows,Fly given velocity vector for 5 seconds
v1.8.0-windows,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.8.0-windows,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.8.0-windows,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.8.0-windows,Make the drone fly in a circle.
v1.8.0-windows,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.8.0-windows,check that our home position is stable
v1.8.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.8.0-windows,ramp up time
v1.8.0-windows,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.8.0-windows,compute current angle
v1.8.0-windows,compute lookahead
v1.8.0-windows,if we did the takeoff then also do the landing.
v1.8.0-windows,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.8.0-windows,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.8.0-windows,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.8.0-windows,ignore the click over from 360 back to 0
v1.8.0-windows,watch direction this diff is moving if it switches from shrinking to growing
v1.8.0-windows,then we passed the starting point.
v1.8.0-windows,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.8.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.8.0-windows,z of -5 is 5 meters above the original launch point.
v1.8.0-windows,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.8.0-windows,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.8.0-windows,drone will over-shoot so we bring it back to the start point before landing.
v1.8.0-windows,"Python client example to get Lidar data from a drone, although this script works for any AirSim-supported vehicle"
v1.8.0-windows,This script is for Lidar sensors using 'VehicleInertialFrame' as DataFrame under settings.json
v1.8.0-windows,Sample settings.json used for this script:
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,main
v1.8.0-windows,Run this script with clock speed in settings.json
v1.8.0-windows,"""ClockSpeed"": 1 then change it to 0.5"
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,with ClockSpeed = 0.5 you will see that this takes 6s (system time) and not 3s
v1.8.0-windows,with ClockSpeed = 0.5 you will see that this takes 10s (system time)
v1.8.0-windows,and not 5s in each iteration
v1.8.0-windows,that's enough fun for now. let's quit cleanly
v1.8.0-windows,Takeoff or hover
v1.8.0-windows,Set wind to 0
v1.8.0-windows,Takeoff or hover
v1.8.0-windows,In settings.json first activate computer vision mode:
v1.8.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.8.0-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.8.0-windows,pip install opencv-python
v1.8.0-windows,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.8.0-windows,fly for 2 minutes
v1.8.0-windows,more than 50 centimeter drift is unacceptable.
v1.8.0-windows,Python client example to get Lidar data from a drone
v1.8.0-windows,
v1.8.0-windows,Makes the drone fly and get Lidar data
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,"print(""state: %s"" % s)"
v1.8.0-windows,"print(""state: %s"" % pprint.pformat(state))"
v1.8.0-windows,"reshape array of floats to array of [X,Y,Z]"
v1.8.0-windows,TODO
v1.8.0-windows,main
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.8.0-windows,let it settle there a bit.
v1.8.0-windows,after hovering we need to re-enabled api control for next leg of the trip
v1.8.0-windows,now compute the survey path required to fill the box
v1.8.0-windows,##################################################################################################
v1.8.0-windows,
v1.8.0-windows,Project:  Embedded Learning Library (ELL)
v1.8.0-windows,File:     wav_reader.py
v1.8.0-windows,Authors:  Chris Lovett
v1.8.0-windows,
v1.8.0-windows,Requires: Python 3.x
v1.8.0-windows,
v1.8.0-windows,##################################################################################################
v1.8.0-windows,open a stream on the audio input file.
v1.8.0-windows,"assumes signed integer used in raw audio, so for example, the max for 16bit is 2^15 (32768)"
v1.8.0-windows,convert int16 data to scaled floats
v1.8.0-windows,configure output stream to match what we are resampling to...
v1.8.0-windows,convert the audio to the desired recording rate
v1.8.0-windows,split into separate channels
v1.8.0-windows,drop the channels we don't want
v1.8.0-windows,zip the resulting channels back up.
v1.8.0-windows,convert back to packed bytes in PCM 16 format
v1.8.0-windows,"deal with any accumulation of tails, if the tail grows to a full"
v1.8.0-windows,buffer then return it!
v1.8.0-windows,"we have a tail from previous frame, so prepend it"
v1.8.0-windows,"now the caller needs us to stick to our sample_size contract, but when"
v1.8.0-windows,rate conversion happens we can't be sure that 'data' is exactly that size.
v1.8.0-windows,usually one byte extra so add this to our accumulating tail
v1.8.0-windows,"might have reached the end of a file, so pad with zeros."
v1.8.0-windows,"Please add ""EnableTrace"": true to your setting.json as shown below"
v1.8.0-windows,{
v1.8.0-windows,"""SettingsVersion"": 1.2,"
v1.8.0-windows,"""SimMode"": ""Multirotor"","
v1.8.0-windows,"""Vehicles"": {"
v1.8.0-windows,"""Drone"": {"
v1.8.0-windows,"""VehicleType"": ""SimpleFlight"","
v1.8.0-windows,"""EnableTrace"": true"
v1.8.0-windows,}
v1.8.0-windows,}
v1.8.0-windows,}
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,add new vehicle
v1.8.0-windows,Use below in settings.json with Blocks environment
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,get camera images from the car
v1.8.0-windows,that's enough fun for now. let's quit cleanly
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,Import this module to automatically setup path to local airsim module
v1.8.0-windows,This module first tries to see if airsim module is installed via pip
v1.8.0-windows,If it does then we don't do anything else
v1.8.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.8.0-windows,and if it does then we add that in sys.path
v1.8.0-windows,this class simply tries to see if airsim
v1.8.0-windows,if airsim module is installed then don't do anything else
v1.8.0-windows,import pkgutil
v1.8.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.8.0-windows,if airsim_loader is not None:
v1.8.0-windows,return
v1.8.0-windows,"this script moves the drone to a location, then rests it thousands of time"
v1.8.0-windows,purpose of this script is to stress test reset API
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,that's enough fun for now. let's quite cleanly
v1.8.0-windows,For high speed ascent and descent on PX4 you may need to set these properties:
v1.8.0-windows,param set MPC_Z_VEL_MAX_UP 5
v1.8.0-windows,param set MPC_Z_VEL_MAX_DN 5
v1.8.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.8.0-windows,z of -50 is 50 meters above the original launch point.
v1.8.0-windows,use open cv to show new images from AirSim
v1.8.0-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.8.0-windows,pip install opencv-python
v1.8.0-windows,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.8.0-windows,get depth image
v1.8.0-windows,"this will return png width= 256, height= 144"
v1.8.0-windows,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.8.0-windows,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.8.0-windows,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.8.0-windows,to get an estimate of distance.
v1.8.0-windows,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.8.0-windows,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.8.0-windows,an angular delta of the following pi/10.
v1.8.0-windows,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.8.0-windows,Remove alpha channel if exists
v1.8.0-windows,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.8.0-windows,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.8.0-windows,Flatten and yield as tuple
v1.8.0-windows,Initialize a resizable dataset to hold the output
v1.8.0-windows,Resize the dataset to accommodate the next chunk of rows
v1.8.0-windows,Create the next chunk
v1.8.0-windows,Increment the row count
v1.8.0-windows,Arguments
v1.8.0-windows,Returns
v1.8.0-windows,use composition of homographies
v1.8.0-windows,to generate final transform that needs to be applied
v1.8.0-windows,Arguments
v1.8.0-windows,Returns
v1.8.0-windows,Keeps under lock only the mechanism which advances
v1.8.0-windows,the indexing of each batch.
v1.8.0-windows,The transformation of images is not under thread lock
v1.8.0-windows,so it can be done in parallel
v1.8.0-windows,Trained model path
v1.8.0-windows,Connect to AirSim
v1.8.0-windows,Start driving
v1.8.0-windows,Initialize image buffer
v1.8.0-windows,Update throttle value according to steering angle
v1.8.0-windows,Prediction
v1.8.0-windows,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.8.0-windows,Print progress
v1.8.0-windows,Update next car state
v1.8.0-windows,Wait a bit between iterations
v1.8.0-windows,%matplotlib inline
v1.8.0-windows,chunk size for training batches
v1.8.0-windows,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.8.0-windows,Point this to the directory containing the raw data
v1.8.0-windows,Point this to the desired output directory for the cooked (.h5) data
v1.8.0-windows,Choose The folders to search for data under RAW_DATA_DIR
v1.8.0-windows,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.8.0-windows,data_folder.append('folder_name1')
v1.8.0-windows,data_folder.append('folder_name2')
v1.8.0-windows,...
v1.8.0-windows,Hyper-parameters
v1.8.0-windows,Activation functions
v1.8.0-windows,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.8.0-windows,<< The directory containing the cooked data from the previous step >>
v1.8.0-windows,<< The directory in which the model output will be placed >>
v1.8.0-windows,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.8.0-windows,Network definition
v1.8.0-windows,Import this module to automatically setup path to local airsim module
v1.8.0-windows,This module first tries to see if airsim module is installed via pip
v1.8.0-windows,If it does then we don't do anything else
v1.8.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.8.0-windows,and if it does then we add that in sys.path
v1.8.0-windows,this class simply tries to see if airsim
v1.8.0-windows,if airsim module is installed then don't do anything else
v1.8.0-windows,import pkgutil
v1.8.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.8.0-windows,if airsim_loader is not None:
v1.8.0-windows,return
v1.8.0-windows,DEY: I don't know why this was there.
v1.8.0-windows,----------------------------------- Common vehicle APIs ---------------------------------------------
v1.8.0-windows,basic flight control
v1.8.0-windows,time-of-day control
v1.8.0-windows,time - of - day control
v1.8.0-windows,weather
v1.8.0-windows,camera control
v1.8.0-windows,simGetImage returns compressed png in array of bytes
v1.8.0-windows,image_type uses one of the ImageType members
v1.8.0-windows,"todo : in future remove below, it's only for compatibility to pre v1.2"
v1.8.0-windows,"because this method returns std::vector < uint8>, msgpack decides to encode it as a string unfortunately."
v1.8.0-windows,camera control
v1.8.0-windows,simGetImage returns compressed png in array of bytes
v1.8.0-windows,image_type uses one of the ImageType members
v1.8.0-windows,CinemAirSim
v1.8.0-windows,End CinemAirSim
v1.8.0-windows,gets the static meshes in the unreal scene
v1.8.0-windows,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.8.0-windows,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.8.0-windows,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.8.0-windows,sensor APIs
v1.8.0-windows,Plotting APIs
v1.8.0-windows,Recording APIs
v1.8.0-windows,Add new vehicle via RPC
v1.8.0-windows,----------------------------------- Multirotor APIs ---------------------------------------------
v1.8.0-windows,APIs for control
v1.8.0-windows,low - level control API
v1.8.0-windows,query vehicle state
v1.8.0-windows,query rotor states
v1.8.0-windows,----------------------------------- Car APIs ---------------------------------------------
v1.8.0-windows,helper method for converting getOrientation to roll/pitch/yaw
v1.8.0-windows,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.8.0-windows,roll (x-axis rotation)
v1.8.0-windows,pitch (y-axis rotation)
v1.8.0-windows,yaw (z-axis rotation)
v1.8.0-windows,DEY: I don't know why this was there.
v1.8.0-windows,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.8.0-windows,return cls(**msgpack.unpack(encoded))
v1.8.0-windows,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.8.0-windows,Create a DummyVecEnv for main airsim gym env
v1.8.0-windows,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.8.0-windows,Initialize RL algorithm type and parameters
v1.8.0-windows,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.8.0-windows,Train for a certain number of timesteps
v1.8.0-windows,Save policy weights
v1.8.0-windows,Create a DummyVecEnv for main airsim gym env
v1.8.0-windows,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.8.0-windows,Initialize RL algorithm type and parameters
v1.8.0-windows,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.8.0-windows,Train for a certain number of timesteps
v1.8.0-windows,Save policy weights
v1.8.0-windows,Import this module to automatically setup path to local airsim module
v1.8.0-windows,This module first tries to see if airsim module is installed via pip
v1.8.0-windows,If it does then we don't do anything else
v1.8.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.8.0-windows,and if it does then we add that in sys.path
v1.8.0-windows,this class simply tries to see if airsim
v1.8.0-windows,if airsim module is installed then don't do anything else
v1.8.0-windows,import pkgutil
v1.8.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.8.0-windows,if airsim_loader is not None:
v1.8.0-windows,return
v1.8.0-windows,Set home position and velocity
v1.8.0-windows,print(dist)
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,"This is a bit crude, but give it a moment to settle on the ground, else takeoff will fail"
v1.8.0-windows,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.8.0-windows,switch to explicit hover mode so that this is the fallback when
v1.8.0-windows,move* commands are finished.
v1.8.0-windows,"Altitude difference between each platform, in meters"
v1.8.0-windows,"Count down, so the first one can easily go the highest (without knowing count)"
v1.8.0-windows,"in header only mode, control library is not available"
v1.8.0-windows,if using Unreal Build system then include precompiled header file first
v1.8.0-windows,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.8.0-windows,"Windows, OSX and Linux."
v1.8.0-windows,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.8.0-windows,Windows users can move the Documents folder to any location they want
v1.8.0-windows,SHGetFolderPath knows how to find it.
v1.8.0-windows,fall back in case SHGetFolderPath failed for some reason.
v1.8.0-windows,convert from std::path '/' to windows backslash.
v1.8.0-windows,make the current thread run with maximum priority.
v1.8.0-windows,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.8.0-windows,TODO: How to handle POSIX thread priorities on OSX?
v1.8.0-windows,setThreadName is a helper function that is useful when debugging because your threads
v1.8.0-windows,show up in the debugger with the name you set which makes it easier to find the threads
v1.8.0-windows,that you are interested in.
v1.8.0-windows,"unfortunately this is only available on Windows 10, and AirSim is not limited to that."
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.8.0-windows,
v1.8.0-windows,Treat all errors as failure conditions.
v1.8.0-windows,parse command line
v1.8.0-windows,"motive gives a weird error if the project is not found, so we look for it."
v1.8.0-windows,Do an update to pick up any recently-arrived cameras.
v1.8.0-windows,List all detected cameras.
v1.8.0-windows,List all defined rigid bodies.
v1.8.0-windows,throttle to 50 messages per second.
v1.8.0-windows,OptiTrack uses 'y' axis for vertical.
v1.8.0-windows,stdafx.cpp : source file that includes just the standard includes
v1.8.0-windows,MavlinkMoCap.pch will be the pre-compiled header
v1.8.0-windows,stdafx.obj will contain the pre-compiled type information
v1.8.0-windows,TODO: reference any additional headers you need in STDAFX.H
v1.8.0-windows,and not in this file
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,PX4.cpp : Defines the entry point for the console application.
v1.8.0-windows,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.8.0-windows,how do you write to the debug output windows on Unix ?
v1.8.0-windows,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.8.0-windows,connection to create to talke to that server.
v1.8.0-windows,SITL setup info
v1.8.0-windows,The local ethernet interface to use (default localhost).
v1.8.0-windows,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.8.0-windows,server mode on UDP is when you want another app to connect to Pixhawk and publish data back to this process.
v1.8.0-windows,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.8.0-windows,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.8.0-windows,"using their the -qgc option.  Server mode on TCP means mavlinktest will do an ""accept"" socket which is"
v1.8.0-windows,what PX4 is waiting for when it is running in TCP mode.  Here the serverEndPoint is different from the
v1.8.0-windows,offboardEndPoint.  The serverEndPoint specifies which local address to use in case your computer has
v1.8.0-windows,multiple network interfaces.
v1.8.0-windows,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.8.0-windows,this switch controls whether we turn off the RC remote active link loss detection
v1.8.0-windows,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.8.0-windows,from kicking in when you try and fly.
v1.8.0-windows,parse the json
v1.8.0-windows,flatten inner mavlink object
v1.8.0-windows,flatten inner mavlink object
v1.8.0-windows,todo
v1.8.0-windows,todo
v1.8.0-windows,"const char* outLogFileOption = ""outlogfile"";"
v1.8.0-windows,parse command line
v1.8.0-windows,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.8.0-windows,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.8.0-windows,"no local serial connection, so this is the primary droneConnection."
v1.8.0-windows,need a retry loop here because we don't know how quickly px4 will start accepting these connections...
v1.8.0-windows,failed to connect
v1.8.0-windows,"then we need 2 mavlink channels, one for sending/receiving HIL_* messages and the other"
v1.8.0-windows,for controlling the drone.
v1.8.0-windows,this is the control channel.
v1.8.0-windows,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.8.0-windows,cmdTable.push_back(new AltHoldCommand());
v1.8.0-windows,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.8.0-windows,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.8.0-windows,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.8.0-windows,this stops us from being able to connect to SITL mode PX4.
v1.8.0-windows,checkPulse();
v1.8.0-windows,add command text in log
v1.8.0-windows,close previous command.
v1.8.0-windows,FilterLogFiles(logDirectory);
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,send a heartbeat
v1.8.0-windows,accept one incoming connection
v1.8.0-windows,send a heartbeat to the client
v1.8.0-windows,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.8.0-windows,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.8.0-windows,for this unit test we are expecting a request to send an image.
v1.8.0-windows,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.8.0-windows,hmmm
v1.8.0-windows,================ ls
v1.8.0-windows,================ put file
v1.8.0-windows,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.8.0-windows,================ get file
v1.8.0-windows,verify the file contents.
v1.8.0-windows,================ remove file
v1.8.0-windows,================ make directory
v1.8.0-windows,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.8.0-windows,================ remove directory
v1.8.0-windows,Now verification
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,you must call this method if you want HandleMessage to be called subsequently.
v1.8.0-windows,treat literals as one word
v1.8.0-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.8.0-windows,request gps info
v1.8.0-windows,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.8.0-windows,find relative position since command start so we can compare two commands better
v1.8.0-windows,"these PID values are important, so set these to match"
v1.8.0-windows,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.8.0-windows,we can skip ahead.
v1.8.0-windows,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.8.0-windows,TODO: avoid passing hadcoded HIL flag
v1.8.0-windows,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.8.0-windows,"The global position, as returned by the Global Positioning System (GPS)."
v1.8.0-windows,Provides state for additional features
v1.8.0-windows,The general system state
v1.8.0-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.8.0-windows,Provides state for additional features
v1.8.0-windows,The general system state
v1.8.0-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.8.0-windows,Provides state for additional features
v1.8.0-windows,The general system state
v1.8.0-windows,Provides state for additional features
v1.8.0-windows,The general system state
v1.8.0-windows,note: we do not reset com when Close() is called because we want to keep running.
v1.8.0-windows,"user has to invoke ""hil stop"" to stop the hil thread."
v1.8.0-windows,generate random between 0 and 1
v1.8.0-windows,move to range -1 to 1
v1.8.0-windows,scale it
v1.8.0-windows,apply iy
v1.8.0-windows,wait for the Execute method to be called.
v1.8.0-windows,gps is much slower frequency than IMU.
v1.8.0-windows,MAVLINK_MSG_ID_HIL_GPS
v1.8.0-windows,disable MAV_USEHILGPS
v1.8.0-windows,note: we do not reset com when Close() is called because we want to keep running.
v1.8.0-windows,"user has to invoke ""hil stop"" to stop the hil thread."
v1.8.0-windows,generate random between 0 and 1
v1.8.0-windows,move to range -1 to 1
v1.8.0-windows,scale it
v1.8.0-windows,apply iy
v1.8.0-windows,wait for the Execute method to be called.
v1.8.0-windows,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.8.0-windows,gps is much slower frequency than IMU.
v1.8.0-windows,MAVLINK_MSG_ID_HIL_GPS
v1.8.0-windows,disable HIL mode
v1.8.0-windows,Enumeration of landed detector states
v1.8.0-windows,MAV landed state is unknown
v1.8.0-windows,MAV is landed (on ground)
v1.8.0-windows,MAV is in air
v1.8.0-windows,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.8.0-windows,The filtered local position
v1.8.0-windows,must send these regularly to keep offboard control.
v1.8.0-windows,"ok, now we can safely switch to loiter."
v1.8.0-windows,must send these regularly to keep offboard control.
v1.8.0-windows,integrate the heading so it is smoother.
v1.8.0-windows,must send these regularly to keep offboard control.
v1.8.0-windows,integrate the heading so it is smoother.
v1.8.0-windows,fly to radius
v1.8.0-windows,it takes about 10 cm to stop and turn.
v1.8.0-windows,next time around switch to orbiting!
v1.8.0-windows,heading points to center of circle.
v1.8.0-windows,interpoloate the speed ramp up time over 2 seconds from start time
v1.8.0-windows,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.8.0-windows,monitor the sin curves so we can see how on track or off track it actually is.
v1.8.0-windows,the shape of the curve will also tell us if we are progressing at a consistent
v1.8.0-windows,"speed, the more deformed the sin curve the worse our progress."
v1.8.0-windows,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.8.0-windows,degrees just flipped from 359 to 0.
v1.8.0-windows,this enables us to test what happens when offboard control is lost and resumed.
v1.8.0-windows,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.8.0-windows,"ok, now we can start moving by velocity"
v1.8.0-windows,recompute to new target.
v1.8.0-windows,start by moving right with 10 degree roll.
v1.8.0-windows,haven't started yet.
v1.8.0-windows,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.8.0-windows,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.8.0-windows,track how our actual pitch is coming along compared to our target
v1.8.0-windows,and check position
v1.8.0-windows,the amount of pitch should depend on our speed in that direction.
v1.8.0-windows,passed the midpoint.
v1.8.0-windows,fade out the pitch as we pick up speed so we don't overshoot.
v1.8.0-windows,see if we just crossed the wiggle distance threshold.
v1.8.0-windows,(pitch affects the x-position).
v1.8.0-windows,reverse direction with a -30 degrees quick stop
v1.8.0-windows,reverse direction with a 30 degrees quick stop
v1.8.0-windows,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.8.0-windows,too much in that direction.
v1.8.0-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.8.0-windows,track how our actual roll is coming along compared to our target
v1.8.0-windows,and check position
v1.8.0-windows,the amount of roll should depend on our speed in that direction.
v1.8.0-windows,passed the midpoint.
v1.8.0-windows,fade out the roll as we pick up speed so we don't overshoot.
v1.8.0-windows,see if we just crossed the wiggle distance threshold.
v1.8.0-windows,(roll affects the y-position).
v1.8.0-windows,reverse direction with a -30 degrees quick stop
v1.8.0-windows,reverse direction with a 30 degrees quick stop
v1.8.0-windows,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.8.0-windows,too much in that direction.
v1.8.0-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.8.0-windows,for testing PID controller.
v1.8.0-windows,class AltHoldCommand : public Command
v1.8.0-windows,{
v1.8.0-windows,std::shared_ptr<MavLinkVehicle> channel;
v1.8.0-windows,"float sx_, sy_, sz_;"
v1.8.0-windows,MavLinkAttitudeTarget _current;
v1.8.0-windows,PidController thrust_controller_;
v1.8.0-windows,public:
v1.8.0-windows,this->sz_ = pos.z; // user defined target.
v1.8.0-windows,move to local position keeps the offboard control happy.
v1.8.0-windows,haven't started yet.
v1.8.0-windows,and check position
v1.8.0-windows,double dx = this->sx_ - pos.x;
v1.8.0-windows,double dy = this->sy_ - pos.y;
v1.8.0-windows,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.8.0-windows,too much in that direction.
v1.8.0-windows,adjust thrust so we keep steady height target
v1.8.0-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.8.0-windows,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.8.0-windows,local remote
v1.8.0-windows,already handled by the parse method.
v1.8.0-windows,we only support very simple patterns for now.
v1.8.0-windows,each wildcard must be separated by literal.
v1.8.0-windows,back to back wildcards with no literal in between is too complex.
v1.8.0-windows,"we only support simple matching for now, we can add full regex later if we need it."
v1.8.0-windows,yep!
v1.8.0-windows,'*' is done we found the next matching char
v1.8.0-windows,this is ok.
v1.8.0-windows,this is an ERASE_END_LINE command which we ignore.
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,pack the payload buffer.
v1.8.0-windows,calculate checksum
v1.8.0-windows,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.8.0-windows,are variable length as a result.
v1.8.0-windows,form the header as a byte array for the crc
v1.8.0-windows,unpack the message...
v1.8.0-windows,pack the payload buffer.
v1.8.0-windows,"json can't handle ""nan"", so we convert it to null."
v1.8.0-windows,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.8.0-windows,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,start listening to this connection
v1.8.0-windows,Send heartbeat to drone.  You should not do this if some other node is
v1.8.0-windows,already doing it.
v1.8.0-windows,stop listening to the connection.
v1.8.0-windows,get the connection
v1.8.0-windows,Get the local system and component id
v1.8.0-windows,send a command to the remote node
v1.8.0-windows,MavLinkNode::MavLinkNode() = default;
v1.8.0-windows,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.8.0-windows,decrementing the count so the next WaitOne may block.
v1.8.0-windows,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.8.0-windows,convert to absolute time.
v1.8.0-windows,use mach_timespec
v1.8.0-windows,convert to absolute time.
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,return true if we still have offboard control (can lose this if user flips the switch).
v1.8.0-windows,MavLinkVehicle::MavLinkVehicle() = default;
v1.8.0-windows,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.8.0-windows,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,============================== CLIENT ============================================
v1.8.0-windows,image APIs
v1.8.0-windows,or if you are implementing the client side call this function to get the most recent frame.
v1.8.0-windows,returns false if there is no new frame available.
v1.8.0-windows,============================== SERVER ============================================
v1.8.0-windows,call this to send the image back over the connection given to start function.
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,"log every message that is ""sent"" using sendMessage."
v1.8.0-windows,"log every message that is ""received"""
v1.8.0-windows,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.8.0-windows,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.8.0-windows,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.8.0-windows,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,for compatibility with QGroundControl we have to save the time field in big endian.
v1.8.0-windows,todo: mavlink2 support?
v1.8.0-windows,has to be one or the other!
v1.8.0-windows,24 bits.
v1.8.0-windows,24 bits.
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,start listening to this connection
v1.8.0-windows,Send heartbeat to drone.  You should not do this if some other node is
v1.8.0-windows,already doing it.
v1.8.0-windows,this is called for all messages received on the connection.
v1.8.0-windows,"we received a heartbeat, so let's get the capabilities."
v1.8.0-windows,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.8.0-windows,subclasses remembering to call this base implementation.
v1.8.0-windows,stop listening to the connection.
v1.8.0-windows,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.8.0-windows,wait for a heartbeat msg since this will give us the port to send commands to...
v1.8.0-windows,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.8.0-windows,send a heart beat so that the remote node knows we are still alive
v1.8.0-windows,(otherwise drone will trigger a failsafe operation).
v1.8.0-windows,ignore any failures here because we are running in our own thread here.
v1.8.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.0-windows,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.8.0-windows,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.8.0-windows,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.8.0-windows,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.8.0-windows,"ok, now fetch the missing parameters."
v1.8.0-windows,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.8.0-windows,silently fail since we are on a background thread here...
v1.8.0-windows,tell the caller this is complete.
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,add our custom telemetry message length.
v1.8.0-windows,todo: if we support signing then initialize
v1.8.0-windows,mavlink_intermediate_status_.signing callbacks
v1.8.0-windows,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.8.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.8.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.8.0-windows,send this right away just in case serial link is not already configured
v1.8.0-windows,"log every message that is ""sent"" using sendMessage."
v1.8.0-windows,"log every message that is ""sent"" using sendMessage."
v1.8.0-windows,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.8.0-windows,pack the payload buffer.
v1.8.0-windows,calculate checksum
v1.8.0-windows,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.8.0-windows,are variable length as a result.
v1.8.0-windows,form the header as a byte array for the crc
v1.8.0-windows,these macros use old style cast.
v1.8.0-windows,forward messages from our connected node to the remote proxy.
v1.8.0-windows,tell the remote connection to expect mavlink2 messages.
v1.8.0-windows,forward messages from remote proxy to local connected node
v1.8.0-windows,CurrentThread::setMaximumPriority();
v1.8.0-windows,"hmmm, wait till it is opened?"
v1.8.0-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.8.0-windows,pick up the sysid/compid of the remote node we are connected to.
v1.8.0-windows,then this is a mavlink 1 message
v1.8.0-windows,then this mavlink sender supports mavlink 2
v1.8.0-windows,queue event for publishing.
v1.8.0-windows,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.8.0-windows,as it ensures we don't lose messages if the listener is slow.
v1.8.0-windows,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.8.0-windows,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.8.0-windows,we would get a deadlock.
v1.8.0-windows,CurrentThread::setMaximumPriority();
v1.8.0-windows,reset counters
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,------------------------------------------------------------------------------
v1.8.0-windows,Defines
v1.8.0-windows,------------------------------------------------------------------------------
v1.8.0-windows,bit number  876543210987654321
v1.8.0-windows,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.8.0-windows,in future it would be good to have ability to add system IDs we are interested in
v1.8.0-windows,if (msg.sysid != getTargetSystemId())
v1.8.0-windows,{
v1.8.0-windows,// we only care about messages from our intended remote node.
v1.8.0-windows,return;
v1.8.0-windows,}
v1.8.0-windows,user may have changed modes on us! So we need to honor that and not
v1.8.0-windows,try and take it back.
v1.8.0-windows,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.8.0-windows,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.8.0-windows,we can store up to 16 channels in rc_channels_scaled.
v1.8.0-windows,The RAW values of the servo outputs
v1.8.0-windows,Metrics typically displayed on a HUD for fixed wing aircraft
v1.8.0-windows,The IMU readings in SI units in NED body frame
v1.8.0-windows,printSystemStatus(&msg);
v1.8.0-windows,todo: use this to determine when we need to do emergency landing...
v1.8.0-windows,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.8.0-windows,Provides state for additional features
v1.8.0-windows,The general system state
v1.8.0-windows,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.8.0-windows,but we do want to know when we get the ack.  So this is async ACK processing!
v1.8.0-windows,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.8.0-windows,if threshold < 0 then the threshold is inverted.
v1.8.0-windows,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.8.0-windows,Convert it to a floating point number between -1 and 1.
v1.8.0-windows,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.8.0-windows,until the move commands start happening.
v1.8.0-windows,return true if user calls requestControl and has not called releaseControl.
v1.8.0-windows,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.8.0-windows,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.8.0-windows,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.8.0-windows,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.8.0-windows,send a few to make sure it gets through...
v1.8.0-windows,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.8.0-windows,us by which time the PX4 times out offboard mode!!
v1.8.0-windows,"assume this was successful, we'll find out if so in the next heartbeat."
v1.8.0-windows,this mode change take precedence over offboard mode.
v1.8.0-windows,thrust must be between -1 and 1.
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,These definitions are copied from PX4 implementation
v1.8.0-windows,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.8.0-windows,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.8.0-windows,/ @brief Command opcodes
v1.8.0-windows,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.8.0-windows,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.8.0-windows,must trim trailing slashes so PX4 doesn't hang!
v1.8.0-windows,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.8.0-windows,from the source.
v1.8.0-windows,check if directory exists.
v1.8.0-windows,perfect.
v1.8.0-windows,use last_message_ so we preserve the sessionid.
v1.8.0-windows,"could not create the local file, so stop."
v1.8.0-windows,must use last_message_ so we preserve the session id.
v1.8.0-windows,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.8.0-windows,todo: error handling here? sequence is out of order...
v1.8.0-windows,"directory must be empty then, can't do nextStep because"
v1.8.0-windows,it will just loop for ever re-requesting zero offset into
v1.8.0-windows,empty directory.
v1.8.0-windows,result should be a list of null terminated file names.
v1.8.0-windows,skipping this entry
v1.8.0-windows,remove the file size field.
v1.8.0-windows,"printf(""%s\n"", name.c_str());"
v1.8.0-windows,request the next batch.
v1.8.0-windows,"perhaps this was a late response after we did a retry, so ignore it."
v1.8.0-windows,"perhaps this was a late response after we did a retry, so ignore it."
v1.8.0-windows,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.8.0-windows,reached the end of the list or the file.
v1.8.0-windows,end of file or directory listing.
v1.8.0-windows,"success, data should be following..."
v1.8.0-windows,ack on this cmd is a noop
v1.8.0-windows,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.8.0-windows,give up then.
v1.8.0-windows,tell watchdog we are sending a request
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,================================= CLIENT ==============================================================
v1.8.0-windows,Check if we have a valid transaction
v1.8.0-windows,emit signal if all packets arrived
v1.8.0-windows,Restart statemachine
v1.8.0-windows,image APIs
v1.8.0-windows,================================= SERVER ==============================================================
v1.8.0-windows,Prepare and send acknowledgment packet
v1.8.0-windows,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.8.0-windows,Send ENCAPSULATED_IMAGE packet
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.8.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.8.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.8.0-windows,send this right away just in case serial link is not already configured
v1.8.0-windows,CurrentThread::setMaximumPriority();
v1.8.0-windows,"hmmm, wait till it is opened?"
v1.8.0-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.8.0-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.8.0-windows,queue event for publishing.
v1.8.0-windows,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.8.0-windows,as it ensures we don't lose messages if the listener is slow.
v1.8.0-windows,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.8.0-windows,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.8.0-windows,we would get a deadlock.
v1.8.0-windows,CurrentThread::setMaximumPriority();
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.8.0-windows,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.8.0-windows,parse out the VID number
v1.8.0-windows,now the PID
v1.8.0-windows,parse out the VID number
v1.8.0-windows,examples:
v1.8.0-windows,PX4: USB\VID_26AC&PID_0011\0
v1.8.0-windows,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.8.0-windows,"printf(""Found: %S\n"", buffer.c_str());"
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.8.0-windows,parse out the VID number
v1.8.0-windows,now the PID
v1.8.0-windows,parse out the VID number
v1.8.0-windows,suppress
v1.8.0-windows,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,This has not been properly tested
v1.8.0-windows,struct iw_statistics stats;
v1.8.0-windows,struct iwreq req;
v1.8.0-windows,"memset(&stats, 0, sizeof(stats));"
v1.8.0-windows,"memset(&req, 0, sizeof(iwreq));"
v1.8.0-windows,
v1.8.0-windows,"strncpy(req.ifr_name, ifaceName, 16);"
v1.8.0-windows,req.u.data.pointer = &stats;
v1.8.0-windows,req.u.data.length = sizeof(iw_statistics);
v1.8.0-windows,
v1.8.0-windows,#ifdef CLEAR_UPDATED
v1.8.0-windows,req.u.data.flags = 1;
v1.8.0-windows,#endif
v1.8.0-windows,
v1.8.0-windows,/* Perform the ioctl */
v1.8.0-windows,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.8.0-windows,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.8.0-windows,return -127;
v1.8.0-windows,}
v1.8.0-windows,
v1.8.0-windows,return stats.qual.level;
v1.8.0-windows,todo: windows version of this...
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,windows
v1.8.0-windows,Need to link with Ws2_32.lib
v1.8.0-windows,posix
v1.8.0-windows,found it!
v1.8.0-windows,This timeout is important as it allows the MavLinkConnection readPackets
v1.8.0-windows,thread to iterate and notice the connection is now closed. This allows
v1.8.0-windows,AirSim to shutdown properly when drone is not connected.
v1.8.0-windows,bind socket to local address.
v1.8.0-windows,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.8.0-windows,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.8.0-windows,try and reconnect
v1.8.0-windows,write to the serial port
v1.8.0-windows,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.8.0-windows,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.8.0-windows,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.8.0-windows,"try and receive something, up until port is closed anyway."
v1.8.0-windows,"message was too large for the buffer, no problem, return what we have."
v1.8.0-windows,try again - this can happen if server recreates the socket on their side.
v1.8.0-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.8.0-windows,"skip this, the receive just timed out, no problem, we'll try again later."
v1.8.0-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.8.0-windows,"printf(""#### recv failed with error: %d\n"", hr);"
v1.8.0-windows,we now have it.
v1.8.0-windows,this is from someone we are not interested in.
v1.8.0-windows,-----------------------------------------------------------------------------------------
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,Initialize Winsock
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,windows
v1.8.0-windows,Need to link with Ws2_32.lib
v1.8.0-windows,posix
v1.8.0-windows,found it!
v1.8.0-windows,bind socket to local address.
v1.8.0-windows,bind socket to local address.
v1.8.0-windows,start listening for incoming connection
v1.8.0-windows,accept 1
v1.8.0-windows,"don't need to accept any more, so we can close this one."
v1.8.0-windows,write to the serial port
v1.8.0-windows,"try and receive something, up until port is closed anyway."
v1.8.0-windows,"message was too large for the buffer, no problem, return what we have."
v1.8.0-windows,try again - this can happen if server recreates the socket on their side.
v1.8.0-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.8.0-windows,try again - this can happen if server recreates the socket on their side.
v1.8.0-windows,-----------------------------------------------------------------------------------------
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.8.0-windows,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.8.0-windows,set signal
v1.8.0-windows,Clear Handshake flags
v1.8.0-windows,Set Handshake flags
v1.8.0-windows,return GetLastError();
v1.8.0-windows,return GetLastError();
v1.8.0-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.8.0-windows,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.8.0-windows,enable reading
v1.8.0-windows,posix doesn't have mark/space parity.
v1.8.0-windows,posix doesn't have mark/space parity.
v1.8.0-windows,this is the default.
v1.8.0-windows,not sure this is supported...
v1.8.0-windows,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.8.0-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.8.0-windows,First do those specified by POSIX.
v1.8.0-windows,Now conditionally handle a bunch of extended rates.
v1.8.0-windows,First do those specified by POSIX.
v1.8.0-windows,Now conditionally handle a bunch of extended rates.
v1.8.0-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.8.0-windows,import airsim
v1.8.0-windows,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v1.8.0-windows,self.args = args
v1.8.0-windows,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v1.8.0-windows,pdb.set_trace()
v1.8.0-windows,#include <pluginlib/class_list_macros.h>
v1.8.0-windows,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v1.8.0-windows,todo do not reset if already in air?
v1.8.0-windows,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.8.0-windows,ros params
v1.8.0-windows,todo enforce dynamics constraints in this node as well?
v1.8.0-windows,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v1.8.0-windows,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v1.8.0-windows,XmlRpc::XmlRpcValue can't be const in this case
v1.8.0-windows,subscribe to control commands on global nodehandle
v1.8.0-windows,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.8.0-windows,bind to a single callback. todo optimal subs queue length
v1.8.0-windows,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.8.0-windows,TODO: ros::TransportHints().tcpNoDelay();
v1.8.0-windows,"vehicle_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.8.0-windows,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.8.0-windows,camera_setting.gimbal
v1.8.0-windows,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.8.0-windows,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.8.0-windows,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.8.0-windows,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.8.0-windows,"if {DepthPlanar, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.8.0-windows,"push back pair (vector of image captures, current vehicle name)"
v1.8.0-windows,iterate over sensors
v1.8.0-windows,"we want fast access to the lidar sensors for callback handling, sort them out now"
v1.8.0-windows,add takeoff and land all services if more than 2 drones
v1.8.0-windows,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v1.8.0-windows,todo add per vehicle reset in AirLib API
v1.8.0-windows,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.8.0-windows,lidars update on their own callback/thread at a given rate
v1.8.0-windows,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v1.8.0-windows,"todo: error check. if state is not landed, return error."
v1.8.0-windows,todo add reset by vehicle_name API to airlib
v1.8.0-windows,todo not async remove waitonlasttask
v1.8.0-windows,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v1.8.0-windows,todo do actual body frame?
v1.8.0-windows,airsim uses degrees
v1.8.0-windows,todo do actual body frame?
v1.8.0-windows,airsim uses degrees
v1.8.0-windows,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v1.8.0-windows,todo expose waitOnLastTask or nah?
v1.8.0-windows,todo do actual body frame?
v1.8.0-windows,airsim uses degrees
v1.8.0-windows,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.8.0-windows,todo expose waitOnLastTask or nah?
v1.8.0-windows,todo support multiple gimbal commands
v1.8.0-windows,todo support multiple gimbal commands
v1.8.0-windows,1. find quaternion of default gimbal pose
v1.8.0-windows,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.8.0-windows,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.8.0-windows,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.8.0-windows,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.8.0-windows,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.8.0-windows,msg = []
v1.8.0-windows,todo covariances
v1.8.0-windows,gps_msg.position_covariance_type =
v1.8.0-windows,gps_msg.position_covariance =
v1.8.0-windows,todo covariances
v1.8.0-windows,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.8.0-windows,todo radians per second
v1.8.0-windows,meters/s2^m
v1.8.0-windows,imu_msg.orientation_covariance = ;
v1.8.0-windows,imu_msg.angular_velocity_covariance = ;
v1.8.0-windows,imu_msg.linear_acceleration_covariance = ;
v1.8.0-windows,airsim appears to use chrono::system_clock with nanosecond precision
v1.8.0-windows,todo this is global origin
v1.8.0-windows,get the basic vehicle pose and environmental state
v1.8.0-windows,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.8.0-windows,airsim_client needs to provide the simulation time in a future version of the API
v1.8.0-windows,publish the simulation clock
v1.8.0-windows,"publish vehicle state, odom, and all basic sensor types"
v1.8.0-windows,send any commands out to the vehicles
v1.8.0-windows,"should be easier way to get the sim time through API, something like:"
v1.8.0-windows,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.8.0-windows,curr_ros_time = airsim_timestamp_to_ros(env.clock().nowNanos());
v1.8.0-windows,iterate over drones
v1.8.0-windows,get drone state from airsim
v1.8.0-windows,"vehicle environment, we can get ambient temperature here and other truths"
v1.8.0-windows,convert airsim drone state to ROS msgs
v1.8.0-windows,simulation environment truth
v1.8.0-windows,"dashboard reading from car, RPM, gear, etc"
v1.8.0-windows,odom and transforms
v1.8.0-windows,ground truth GPS position from sim/HITL
v1.8.0-windows,handled via callback
v1.8.0-windows,send control commands from the last callback to airsim
v1.8.0-windows,send control commands from the last callback to airsim
v1.8.0-windows,"Only camera rotation, no translation movement of camera"
v1.8.0-windows,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.8.0-windows,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.8.0-windows,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.8.0-windows,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.8.0-windows,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.8.0-windows,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.8.0-windows,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.8.0-windows,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.8.0-windows,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.8.0-windows,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.8.0-windows,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.8.0-windows,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.8.0-windows,update timestamp of saved cam info msgs
v1.8.0-windows,DepthPlanar / DepthPerspective / DepthVis / DisparityNormalized
v1.8.0-windows,Scene / Segmentation / SurfaceNormals / Infrared
v1.8.0-windows,publish camera transforms
v1.8.0-windows,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.8.0-windows,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.8.0-windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.8.0-windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.8.0-windows,ROS params
v1.8.0-windows,ROS publishers
v1.8.0-windows,ROS subscribers
v1.8.0-windows,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.8.0-windows,ROS timers
v1.8.0-windows,todo maintain internal representation as eigen vec?
v1.8.0-windows,todo check if low velocity if within thresh?
v1.8.0-windows,todo maintain separate errors for XY and Z
v1.8.0-windows,todo save this in degrees somewhere to avoid repeated conversion
v1.8.0-windows,this tells the update timer callback to not do active hovering
v1.8.0-windows,todo maintain array of position goals
v1.8.0-windows,todo error checks
v1.8.0-windows,todo fill response
v1.8.0-windows,"Already have goal, and have reached it"
v1.8.0-windows,this tells the update timer callback to not do active hovering
v1.8.0-windows,todo error checks
v1.8.0-windows,todo fill response
v1.8.0-windows,"todo do relative altitude, or add an option for the same?"
v1.8.0-windows,convert GPS goal to NED goal
v1.8.0-windows,todo error checks
v1.8.0-windows,todo fill response
v1.8.0-windows,"Already have goal, this shouldn't happen"
v1.8.0-windows,"todo do relative altitude, or add an option for the same?"
v1.8.0-windows,convert GPS goal to NED goal
v1.8.0-windows,todo error checks
v1.8.0-windows,todo fill response
v1.8.0-windows,todo check if odometry is too old!!
v1.8.0-windows,"if no odom, don't do anything."
v1.8.0-windows,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.8.0-windows,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.8.0-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.8.0-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.8.0-windows,todo yaw limits
v1.8.0-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.8.0-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.8.0-windows,mimics void ASimHUD::initializeSettings()
v1.8.0-windows,int num_threads = 1;
v1.8.0-windows,ros::MultiThreadedSpinner multi_thread(num_threads);
v1.8.0-windows,multi_thread.spin();
v1.8.0-windows,ros::AsyncSpinner async_spinner(num_threads);
v1.8.0-windows,async_spinner.start();
v1.8.0-windows,single threaded spinner
v1.8.0-windows,!/usr/bin/env python
v1.8.0-windows,capture joystick events using ROS and convert to AirSim Car API commands
v1.8.0-windows,to enable:
v1.8.0-windows,rosrun joy joy_node
v1.8.0-windows,"Below was an earlier typo, written like this for compatibility"
v1.8.0-windows,"gearing: -1 reverse, 0 N, >= 1 drive"
v1.8.0-windows,connect to the AirSim simulator
v1.8.0-windows,","
v1.8.0-windows,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.8.0-windows,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,"in header only mode, control library is not available"
v1.8.0-windows,TODO: something defines max macro which interfears with code here
v1.8.0-windows,is cur_pos within fence?
v1.8.0-windows,destination risk is not available then consider it zero
v1.8.0-windows,if dest risk is lower than its more safe
v1.8.0-windows,are we doing better than closest obstacle?
v1.8.0-windows,"if we stay where we are, what is the risk distance?"
v1.8.0-windows,else we are better of moving to dest
v1.8.0-windows,this function should work even when dest_pos == cur_pos
v1.8.0-windows,is this dest_pos cur_pos within the fence?
v1.8.0-windows,transform dest_pos vector to body frame
v1.8.0-windows,check for approx zero vectors to avoid random yaw angles
v1.8.0-windows,we are hovering
v1.8.0-windows,"get yaw in body frame, ie, front is always 0 radians"
v1.8.0-windows,yaw to ticks
v1.8.0-windows,get obstacles in the window at the tick direction around the window
v1.8.0-windows,less risk distance is better
v1.8.0-windows,check obstacles around current position and see if it has lower risk
v1.8.0-windows,else obstacle is too far
v1.8.0-windows,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.8.0-windows,look for each surrounding tick to see if we have obstacle free angle
v1.8.0-windows,else no suggestions required
v1.8.0-windows,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.8.0-windows,evaluate right and left side of circle
v1.8.0-windows,find right and left risk distances
v1.8.0-windows,at this point we have already determined hover is better than going to dest
v1.8.0-windows,we now determine is moving to suggested angle better than hovering?
v1.8.0-windows,check if dest_pos is safe
v1.8.0-windows,breaking distance at this velocity
v1.8.0-windows,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.8.0-windows,check if dest_pos is safe
v1.8.0-windows,float/vec parameters can have NaN which makes them optional
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,"in header only mode, control library is not available"
v1.8.0-windows,handles +/- tick and wraps around circle
v1.8.0-windows,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.8.0-windows,update the specified window on the map
v1.8.0-windows,make sure from <= to
v1.8.0-windows,normalize the ticks so both are valid indices
v1.8.0-windows,if from is still larger then
v1.8.0-windows,to ticks is then added one full circle to make it larger than from_tick
v1.8.0-windows,find closest obstacle in given window
v1.8.0-windows,search whole map to find closest obstacle
v1.8.0-windows,"in header only mode, control library is not available"
v1.8.0-windows,#include <fileapi.h>
v1.8.0-windows,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.8.0-windows,"Windows, OSX and Linux."
v1.8.0-windows,Windows users can move the Documents folder to any location they want
v1.8.0-windows,SHGetFolderPath knows how to find it.
v1.8.0-windows,fall back in case SHGetFolderPath failed for some reason.
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,"in header only mode, control library is not available"
v1.8.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.0-windows,if using Unreal Build system then include precompiled header file first
v1.8.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.0-windows,this deadlocks UI thread if async_run was called while there are pending rpc calls.
v1.8.0-windows,CinemAirSim
v1.8.0-windows,end CinemAirSim
v1.8.0-windows,Exit if already resetting.
v1.8.0-windows,Reset
v1.8.0-windows,if we don't suppress then server will bomb out for exceptions raised by any method
v1.8.0-windows,required for pimpl
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,"in header only mode, control library is not available"
v1.8.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.0-windows,if using Unreal Build system then include precompiled header file first
v1.8.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.0-windows,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.8.0-windows,make sure we can talk to the DroneServer
v1.8.0-windows,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.8.0-windows,command_context.client.ping();
v1.8.0-windows,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.8.0-windows,sim only
v1.8.0-windows,CinemAirSim
v1.8.0-windows,End CinemAirSim
v1.8.0-windows,"Minor TODO: consider msgpack magic for GeoPoint, so we can have one arg instead of three"
v1.8.0-windows,Convert
v1.8.0-windows,return value of last task. It should be true if task completed without
v1.8.0-windows,cancellation or timeout
v1.8.0-windows,"should be implemented by derived class if it supports async task,"
v1.8.0-windows,for example using futures
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,"in header only mode, control library is not available"
v1.8.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.0-windows,if using Unreal Build system then include precompiled header file first
v1.8.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,"in header only mode, control library is not available"
v1.8.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.0-windows,if using Unreal Build system then include precompiled header file first
v1.8.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.0-windows,required for pimpl
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,"in header only mode, control library is not available"
v1.8.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.0-windows,if using Unreal Build system then include precompiled header file first
v1.8.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.0-windows,status getters
v1.8.0-windows,Rotor state getter
v1.8.0-windows,Multirotor state getter
v1.8.0-windows,return value of last task. It should be true if task completed without
v1.8.0-windows,cancellation or timeout
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,"in header only mode, control library is not available"
v1.8.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.0-windows,if using Unreal Build system then include pre-compiled header file first
v1.8.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.0-windows,getters
v1.8.0-windows,Rotor state
v1.8.0-windows,Multirotor state
v1.8.0-windows,required for pimpl
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,"in header only mode, control library is not available"
v1.8.0-windows,last command is to hold on to position
v1.8.0-windows,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.8.0-windows,after landing we detect if drone has stopped moving
v1.8.0-windows,validate path size
v1.8.0-windows,validate yaw mode
v1.8.0-windows,validate and set auto-lookahead value
v1.8.0-windows,if auto mode requested for lookahead then calculate based on velocity
v1.8.0-windows,add current position as starting point
v1.8.0-windows,append the input path and compute segments
v1.8.0-windows,add last segment as zero length segment so we have equal number of segments and points.
v1.8.0-windows,path_segs[i] refers to segment that starts at point i
v1.8.0-windows,"when path ends, we want to slow down"
v1.8.0-windows,else no need to change velocities for last segments
v1.8.0-windows,setup current position on path to 0 offset
v1.8.0-windows,initialize next path position
v1.8.0-windows,until we are at the end of the path (last seg is always zero size)
v1.8.0-windows,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.8.0-windows,send drone command to get to next lookahead
v1.8.0-windows,sleep for rest of the cycle
v1.8.0-windows,how much have we moved towards last goal?
v1.8.0-windows,project actual vector on goal vector
v1.8.0-windows,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.8.0-windows,TODO: below should be lower than 1E3 and configurable
v1.8.0-windows,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.8.0-windows,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.8.0-windows,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.8.0-windows,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.8.0-windows,"if drone moved backward, we don't want goal to move backward as well"
v1.8.0-windows,"so only climb forward on the path, never back. Also note >= which means"
v1.8.0-windows,we climb path even if distance was 0 to take care of duplicated points on path
v1.8.0-windows,else
v1.8.0-windows,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.8.0-windows,compute next target on path
v1.8.0-windows,freeze the quaternion
v1.8.0-windows,convert RC commands to velocity vector
v1.8.0-windows,find yaw as per terrain and remote setting
v1.8.0-windows,execute command
v1.8.0-windows,if timeout occurred then command completed successfully otherwise it was interrupted
v1.8.0-windows,yaw is not within margin
v1.8.0-windows,by default we say that this command is not supported
v1.8.0-windows,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.8.0-windows,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.8.0-windows,get trims
v1.8.0-windows,take average
v1.8.0-windows,validate dest
v1.8.0-windows,what is the distance we will travel at this velocity?
v1.8.0-windows,get velocity vector
v1.8.0-windows,yaw for the direction of travel
v1.8.0-windows,find velocity vector
v1.8.0-windows,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.8.0-windows,generate velocity vector that is same size as cur_dest_norm / command period
v1.8.0-windows,this velocity vect when executed for command period would yield cur_dest_norm
v1.8.0-windows,send commands
v1.8.0-windows,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.8.0-windows,default strategy is for move. In hover mode we set new strategy temporarily
v1.8.0-windows,are we supposed to do EM?
v1.8.0-windows,get suggested velocity vector
v1.8.0-windows,use the unchecked command
v1.8.0-windows,tell caller not to execute planned command
v1.8.0-windows,other wise throw exception
v1.8.0-windows,otherwise there is some other reason why we are in unsafe situation
v1.8.0-windows,send last command to come to full stop
v1.8.0-windows,else no unsafe situation
v1.8.0-windows,note: cur_path_loc and next_path_loc may both point to same object
v1.8.0-windows,"otherwise use up this segment, move on to next one"
v1.8.0-windows,if we are here then we ran out of segments
v1.8.0-windows,consider last segment as zero length segment
v1.8.0-windows,adjust yaw for the direction of travel in forward-only mode
v1.8.0-windows,else no adjustment needed
v1.8.0-windows,if auto mode requested for lookahead then calculate based on velocity
v1.8.0-windows,Create a spring arm component for our chase camera
v1.8.0-windows,"do nothing, spring arm is pulling the camera with it"
v1.8.0-windows,"do nothing, we have camera turned off"
v1.8.0-windows,set initial view mode
v1.8.0-windows,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.8.0-windows,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.8.0-windows,"If the lag is missing, the camera will also occasionally shake."
v1.8.0-windows,"But, lag is not desired when piloting a drone"
v1.8.0-windows,attach spring arm to actor
v1.8.0-windows,remember current parent for external camera. Later when we remove external
v1.8.0-windows,"camera from spring arm, we will attach it back to its last parent"
v1.8.0-windows,now attach camera to spring arm
v1.8.0-windows,"For car, we need to move the camera back a little more than for a drone."
v1.8.0-windows,"Otherwise, the camera will be stuck inside the car"
v1.8.0-windows,ExternalCamera->bUsePawnControlRotation = false;
v1.8.0-windows,detach spring arm
v1.8.0-windows,Re-enable rendering
v1.8.0-windows,Remove any existing key bindings for manual mode
v1.8.0-windows,"else someone else is bound to manual pose controller, leave it alone"
v1.8.0-windows,if new mode is manual mode then add key bindings
v1.8.0-windows,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.8.0-windows,other modes don't need special setup
v1.8.0-windows,make switch official
v1.8.0-windows,Add loading screen to viewport
v1.8.0-windows,Remove Loading screen from viewport
v1.8.0-windows,Create struct for Location and Rotation of actor in Unreal
v1.8.0-windows,Ensure new non-matching name for the object
v1.8.0-windows,Write the binvox file using run-length encoding
v1.8.0-windows,"where each pair of bytes is of the format (run value, run length)"
v1.8.0-windows,This is a run (repeated bit value)
v1.8.0-windows,End of a run
v1.8.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.8.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.8.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.8.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.8.0-windows,Split the tag string into individual tags.
v1.8.0-windows,Texture swap on actors that have all of those tags.
v1.8.0-windows,----------- Plotting APIs ----------/
v1.8.0-windows,"plot line for points 0-1, 1-2, 2-3"
v1.8.0-windows,"plot line for points 0-1, 2-3, 4-5... must be even number of points"
v1.8.0-windows,assert points_start.size() == poinst_end.size()
v1.8.0-windows,assert positions.size() == strings.size()
v1.8.0-windows,assert poses.size() == names.size()
v1.8.0-windows,Recording APIs
v1.8.0-windows,"Remove '' from the list, representing default vehicle"
v1.8.0-windows,"We need to run this code on the main game thread, since it iterates over actors"
v1.8.0-windows,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.8.0-windows,"No LOS, so draw red line"
v1.8.0-windows,"Yes LOS, so draw green line"
v1.8.0-windows,"We need to run this code on the main game thread, since it iterates over actors"
v1.8.0-windows,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.8.0-windows,Testing actor enum for world bounds...
v1.8.0-windows,"Same as with the Object Iterator, access the subclass instance with the * or -> operators."
v1.8.0-windows,"TODO think more about how best to determine/indicate ground level, if anyone cares"
v1.8.0-windows,Convert Uvectors to LLAs
v1.8.0-windows,CinemAirSim
v1.8.0-windows,End CinemAirSim
v1.8.0-windows,Fill out your copyright notice in the Description page of Project Settings.
v1.8.0-windows,"Set this component to be initialized when the game starts, and to be ticked every frame.  You can turn these features"
v1.8.0-windows,off to improve performance if you don't need them.
v1.8.0-windows,get render target for texture size
v1.8.0-windows,initialize viewinfo for projection matrix
v1.8.0-windows,calculate 3D corner Points of bounding box
v1.8.0-windows,initialize pixel values
v1.8.0-windows,initialize projection data for sceneview
v1.8.0-windows,do some voodoo rotation that is somehow mandatory and stolen from UGameplayStatics::ProjectWorldToScreen
v1.8.0-windows,Project Points to pixels and get the corner pixels
v1.8.0-windows,If actor in camera view - check if it's actually visible or hidden
v1.8.0-windows,Check against 8 extend points
v1.8.0-windows,"If actor in camera view but didn't hit any point out of 8 extend points,"
v1.8.0-windows,check against 10 random points
v1.8.0-windows,CinemAirSim
v1.8.0-windows,CinemAirSim
v1.8.0-windows,set initial focal length
v1.8.0-windows,by default all image types are disabled
v1.8.0-windows,use final color for all calculations
v1.8.0-windows,We set all cameras to start as nodisplay
v1.8.0-windows,This improves performance because the capture components are no longer updating every frame and only update while requesting an image
v1.8.0-windows,TODO: avoid the need to override const cast here
v1.8.0-windows,if the viewport is taller than it is wide
v1.8.0-windows,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v1.8.0-windows,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v1.8.0-windows,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v1.8.0-windows,use final color for all calculations
v1.8.0-windows,TODO: should we be ignoring position and orientation settings here?
v1.8.0-windows,TODO: can we eliminate storing NedTransform?
v1.8.0-windows,CinemAirSim
v1.8.0-windows,if (!std::isnan(setting.target_gamma))
v1.8.0-windows,camera-> = setting.target_gamma;
v1.8.0-windows,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.8.0-windows,else nothing to enable
v1.8.0-windows,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.8.0-windows,if (controller && controller->GetViewTarget() == this)
v1.8.0-windows,controller->SetViewTarget(nullptr);
v1.8.0-windows,CinemAirSim methods
v1.8.0-windows,Copy all of the post processing settings
v1.8.0-windows,But restore the original blendables
v1.8.0-windows,end CinemAirSim methods
v1.8.0-windows,"Check whether requested map exists, this could be very slow if LevelName is a short package name"
v1.8.0-windows,Create Unique Name for sub-level package
v1.8.0-windows,Setup streaming level object that will load specified map
v1.8.0-windows,Transform
v1.8.0-windows,Map to Load
v1.8.0-windows,Add the new level to world.
v1.8.0-windows,TODO: explore screenshot option
v1.8.0-windows,addScreenCaptureHandler(camera->GetWorld());
v1.8.0-windows,TODO: may be we should have these methods non-const?
v1.8.0-windows,We don't do game/render thread synchronization for safe method.
v1.8.0-windows,We just blindly sleep for 200ms (the old way)
v1.8.0-windows,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.8.0-windows,Make sure that all alpha values are opaque.
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,TODO: change naming conventions to same as other files?
v1.8.0-windows,"context->GetWorld()->SetNewWorldOrigin(FIntVector(0, 0, 0));"
v1.8.0-windows,Enable/disable primary viewport rendering flag
v1.8.0-windows,This disables rendering of the main viewport in the same way as the
v1.8.0-windows,"console command ""show rendering"" would do."
v1.8.0-windows,"When getting an image through the API, the image is produced after the render"
v1.8.0-windows,thread has finished rendering the current and the subsequent frame. This means
v1.8.0-windows,that the frame rate for obtaining images through the API is only half as high as
v1.8.0-windows,"it could be, since only every other image is actually captured. We work around"
v1.8.0-windows,this by telling the viewport to flush the rendering queue at the end of each
v1.8.0-windows,drawn frame so that it executes our render request at that point already.
v1.8.0-windows,Do this only if the main viewport is not being rendered anyway in case there are
v1.8.0-windows,any adverse performance effects during main rendering.
v1.8.0-windows,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v1.8.0-windows,nothing to do for now
v1.8.0-windows,"if hidden, clear any existing messages"
v1.8.0-windows,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.8.0-windows,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.8.0-windows,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.8.0-windows,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.8.0-windows,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.8.0-windows,Find mesh in /Game and /AirSim asset registry. When more plugins are added this function will have to change
v1.8.0-windows,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.8.0-windows,{
v1.8.0-windows,InitializeObjectStencilID(*comp);
v1.8.0-windows,}
v1.8.0-windows,"Takes a UStaticMeshComponent, USkinnedMeshComponent or ALandscapeProxy and returns their custom stencil ID if"
v1.8.0-windows,their meshes's name or their owner's name (depending on the naming method in mesh_naming_method_) equals mesh_name
v1.8.0-windows,"The skybox is ignored here as it is huge, and really is of no use to the end user typically. Also the associated meshes with the cameras"
v1.8.0-windows,Various checks if there is even a valid mesh
v1.8.0-windows,Need to force the render command to go through cause on the next iteration the buffer no longer exists
v1.8.0-windows,Unreal stores more vertices than triangles. So here we find the highest referenced vertex and ignore any after that
v1.8.0-windows,can we see followee?
v1.8.0-windows,remove mapping
v1.8.0-windows,removing binding
v1.8.0-windows,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.8.0-windows,"some point. At the moment, manually swapping Red and Blue"
v1.8.0-windows,Copy scaled image into destination thumb
v1.8.0-windows,Compress data - convert into a .png
v1.8.0-windows,if we already have attached actor
v1.8.0-windows,Fill out your copyright notice in the Description page of Project Settings.
v1.8.0-windows,Check pointer equality first for performance
v1.8.0-windows,"KeyHash = HashCombine(KeyHash, GetTypeHash(Key.WildcardMeshNames));"
v1.8.0-windows,#ifdef _MSC_VER
v1.8.0-windows,//print to VS output window
v1.8.0-windows,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.8.0-windows,#endif
v1.8.0-windows,also do default logging
v1.8.0-windows,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.8.0-windows,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.8.0-windows,{
v1.8.0-windows,if (GEngine != nullptr)
v1.8.0-windows,{
v1.8.0-windows,return GEngine->GameUserSettings;
v1.8.0-windows,}
v1.8.0-windows,return nullptr;
v1.8.0-windows,}
v1.8.0-windows,UGameUserSettings* game_settings = GetGameUserSettings();
v1.8.0-windows,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.8.0-windows,game_settings->ApplySettings(true);
v1.8.0-windows,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.8.0-windows,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.8.0-windows,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.8.0-windows,todo unused. need to manually plots tf axes' line in right handed FLU instead of using DrawDebugCoordinateSystem
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,plugin startup
v1.8.0-windows,plugin shutdown
v1.8.0-windows,initialize state
v1.8.0-windows,add listener for pawn's collision event
v1.8.0-windows,compute our home point
v1.8.0-windows,default behavior is to call update every tick
v1.8.0-windows,"for custom physics engine, this method should be overridden and update should be"
v1.8.0-windows,called from every physics tick
v1.8.0-windows,add cameras that already exists in pawn
v1.8.0-windows,create or replace cameras specified in settings
v1.8.0-windows,setup individual cameras
v1.8.0-windows,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.8.0-windows,for each camera in settings
v1.8.0-windows,get pose
v1.8.0-windows,spawn and attach camera to pawn
v1.8.0-windows,add on to our collection
v1.8.0-windows,Deflect along the surface when we collide.
v1.8.0-windows,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.8.0-windows,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.8.0-windows,-1 to 1 --> 0 to 1
v1.8.0-windows,-1 to 1
v1.8.0-windows,these will be available for devices like steering wheels
v1.8.0-windows,switch index 0 to 7 for FrSky Taranis RC is:
v1.8.0-windows,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.8.0-windows,TODO: should below be at controller level info?
v1.8.0-windows,else don't waste time
v1.8.0-windows,"We need to run this code on the main game thread, since it iterates over actors"
v1.8.0-windows,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.8.0-windows,Transform from LLA to NED
v1.8.0-windows,KM911 remove logging
v1.8.0-windows,"common_utils::Utils::log(""NED from LLA: "" + std::to_string(target_location.X) + "", "" + std::to_string(target_location.Y) + "", "" + std::to_string(target_location.Z), common_utils::Utils::kLogLevelInfo);"
v1.8.0-windows,"No LOS, so draw red line"
v1.8.0-windows,"Yes LOS, so draw green line"
v1.8.0-windows,sync environment from kinematics
v1.8.0-windows,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.8.0-windows,void playBack()
v1.8.0-windows,{
v1.8.0-windows,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.8.0-windows,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.8.0-windows,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.8.0-windows,}
v1.8.0-windows,TODO: refactor below code used for playback
v1.8.0-windows,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.8.0-windows,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.8.0-windows,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.8.0-windows,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.8.0-windows,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.8.0-windows,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.8.0-windows,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.8.0-windows,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.8.0-windows,}
v1.8.0-windows,parameters in NED frame
v1.8.0-windows,translate to new PawnSimApi position & orientation from NED to NEU
v1.8.0-windows,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.8.0-windows,allow teleportation
v1.8.0-windows,if collisions are not enabled
v1.8.0-windows,or we have collided but passthrough is enabled
v1.8.0-windows,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.8.0-windows,"without flip flopping, collisions can't be detected"
v1.8.0-windows,update kinematics from pawn's movement instead of physics engine
v1.8.0-windows,by default we update kinematics from UE pawn
v1.8.0-windows,if SimMod uses its own physics engine then this should be overriden
v1.8.0-windows,no default action in this base class
v1.8.0-windows,"read pixels from render target using render thread, then compress the result into PNG"
v1.8.0-windows,argument on the thread that calls this method.
v1.8.0-windows,TODO: is below really needed?
v1.8.0-windows,make sure we are not on the rendering thread
v1.8.0-windows,TODO: below doesn't work right now because it must be running in game thread
v1.8.0-windows,below is documented method but more expensive because it forces flush
v1.8.0-windows,wait for render thread to pick up our task
v1.8.0-windows,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.8.0-windows,capture CameraPose for this frame
v1.8.0-windows,The completion is called immeidately after GameThread sends the
v1.8.0-windows,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.8.0-windows,execute *immediately* after RenderThread renders the scene!
v1.8.0-windows,"while we're still on GameThread, enqueue request for capture the scene!"
v1.8.0-windows,wait for this task to complete
v1.8.0-windows,log a message and continue wait
v1.8.0-windows,lamda function still references a few objects for which there is no refcount.
v1.8.0-windows,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.8.0-windows,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.8.0-windows,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.8.0-windows,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.8.0-windows,Fill out your copyright notice in the Description page of Project Settings.
v1.8.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.0-windows,UWorld* World = GetWorld();
v1.8.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.0-windows,still need the menu class for f10
v1.8.0-windows,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v1.8.0-windows,showWeatherMenu(WorldContextObject);
v1.8.0-windows,"if weather is not enabled, dont allow any weather values to be set"
v1.8.0-windows,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v1.8.0-windows,and must be set to true or false before this.
v1.8.0-windows,WeatherEnabled will always be false
v1.8.0-windows,"NOTE: weather enabled must be set first, before other params for this to work"
v1.8.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.0-windows,"get all menu actors, if any"
v1.8.0-windows,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.8.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.0-windows,"get all menu actors, if any"
v1.8.0-windows,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.8.0-windows,"get all menu actors, if any, then hide the menu"
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,Stuff to filter out XInput devices
v1.8.0-windows,-----------------------------------------------------------------------------
v1.8.0-windows,"Defines, constants, and global variables"
v1.8.0-windows,-----------------------------------------------------------------------------
v1.8.0-windows,Magnitude ranges from -1 to 1
v1.8.0-windows,Strength ranges from 0 to 1
v1.8.0-windows,Autocenter
v1.8.0-windows,Rumble
v1.8.0-windows,Register with the DirectInput subsystem and get a pointer
v1.8.0-windows,to a IDirectInput interface we can use.
v1.8.0-windows,Create a DInput object
v1.8.0-windows,Look for a simple joystick we can use for this sample program.
v1.8.0-windows,Make sure we got a joystick
v1.8.0-windows,"Set the data format to ""simple joystick"" - a predefined data format"
v1.8.0-windows,
v1.8.0-windows,"A data format specifies which controls on a device we are interested in,"
v1.8.0-windows,and how they should be reported. This tells DInput that we will be
v1.8.0-windows,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.8.0-windows,Set the cooperative level to let DInput know how this device should
v1.8.0-windows,interact with the system and with other DInput applications.
v1.8.0-windows,Enumerate the joystick objects. The callback function enabled user
v1.8.0-windows,"interface elements for objects that are found, and sets the min/max"
v1.8.0-windows,values property for discovered axes.
v1.8.0-windows,-----------------------------------------------------------------------------
v1.8.0-windows,Enum each PNP device using WMI and check each device ID to see if it contains
v1.8.0-windows,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.8.0-windows,Unfortunately this information can not be found by just using DirectInput.
v1.8.0-windows,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.8.0-windows,XInput devices.
v1.8.0-windows,
v1.8.0-windows,This function stores the list of xinput devices in a linked list
v1.8.0-windows,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.8.0-windows,-----------------------------------------------------------------------------
v1.8.0-windows,CoInit if needed
v1.8.0-windows,Create WMI
v1.8.0-windows,Create BSTRs for WMI
v1.8.0-windows,Connect to WMI
v1.8.0-windows,Switch security level to IMPERSONATE
v1.8.0-windows,Get list of Win32_PNPEntity devices
v1.8.0-windows,Loop over all devices
v1.8.0-windows,Get 20 at a time
v1.8.0-windows,"For each device, get its device ID"
v1.8.0-windows,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.8.0-windows,Unfortunately this information can not be found by just using DirectInput
v1.8.0-windows,"If it does, then get the VID/PID from var.bstrVal"
v1.8.0-windows,Add the VID/PID to a linked list
v1.8.0-windows,-----------------------------------------------------------------------------
v1.8.0-windows,Returns true if the DirectInput device is also an XInput device.
v1.8.0-windows,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.8.0-windows,-----------------------------------------------------------------------------
v1.8.0-windows,Check each xinput device to see if this device's vid/pid matches
v1.8.0-windows,-----------------------------------------------------------------------------
v1.8.0-windows,Cleanup needed for IsXInputDevice()
v1.8.0-windows,-----------------------------------------------------------------------------
v1.8.0-windows,Cleanup linked list
v1.8.0-windows,-----------------------------------------------------------------------------
v1.8.0-windows,Name: EnumJoysticksCallback()
v1.8.0-windows,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.8.0-windows,device interface on it so we can play with it.
v1.8.0-windows,-----------------------------------------------------------------------------
v1.8.0-windows,Skip anything other than the perferred joystick device as defined by the control panel.
v1.8.0-windows,Instead you could store all the enumerated joysticks and let the user pick.
v1.8.0-windows,Obtain an interface to the enumerated joystick.
v1.8.0-windows,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.8.0-windows,it while we were in the middle of enumerating it.)
v1.8.0-windows,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.8.0-windows,could store all the enumerated joysticks and let the user pick.
v1.8.0-windows,-----------------------------------------------------------------------------
v1.8.0-windows,Name: EnumObjectsCallback()
v1.8.0-windows,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.8.0-windows,joystick. This function enables user interface elements for objects
v1.8.0-windows,"that are found to exist, and scales axes min/max values."
v1.8.0-windows,-----------------------------------------------------------------------------
v1.8.0-windows,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.8.0-windows,enumerated axis in order to scale min/max values.
v1.8.0-windows,Set the range for the axis
v1.8.0-windows,Set the UI to reflect what objects the joystick supports
v1.8.0-windows,-----------------------------------------------------------------------------
v1.8.0-windows,Name: UpdateInputState()
v1.8.0-windows,Desc: Get the input device's state and display it.
v1.8.0-windows,-----------------------------------------------------------------------------
v1.8.0-windows,Poll the device to read the current state
v1.8.0-windows,DInput is telling us that the input stream has been
v1.8.0-windows,"interrupted. We aren't tracking any state between polls, so"
v1.8.0-windows,we don't have any special reset that needs to be done. We
v1.8.0-windows,just re-acquire and try again.
v1.8.0-windows,while (hr == DIERR_INPUTLOST)
v1.8.0-windows,hr = g_pJoystick->Acquire();
v1.8.0-windows,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.8.0-windows,may occur when the app is minimized or in the process of
v1.8.0-windows,"switching, so just try again later"
v1.8.0-windows,Get the input's device state
v1.8.0-windows,Axes
v1.8.0-windows,Slider controls
v1.8.0-windows,Points of view
v1.8.0-windows,Buttons
v1.8.0-windows,-----------------------------------------------------------------------------
v1.8.0-windows,Name: FreeDirectInput()
v1.8.0-windows,Desc: Initialize the DirectInput variables.
v1.8.0-windows,-----------------------------------------------------------------------------
v1.8.0-windows,Unacquire the device one last time just in case
v1.8.0-windows,the app tried to exit while the device is still acquired.
v1.8.0-windows,Release any DirectInput objects.
v1.8.0-windows,nop
v1.8.0-windows,normalize min to max --> 0 to 1
v1.8.0-windows,normalize 0 to 1 --> -1 to 1
v1.8.0-windows,#include <libudev.h>
v1.8.0-windows,implementation for unsupported OS
v1.8.0-windows,if this is new index
v1.8.0-windows,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.8.0-windows,close previous one
v1.8.0-windows,open new device
v1.8.0-windows,if open was successful
v1.8.0-windows,read the device
v1.8.0-windows,if we didn't had valid read
v1.8.0-windows,"NOTE if this condition is not met, we're probably out of sync and this"
v1.8.0-windows,Joystick instance is likely unusable
v1.8.0-windows,TODO: set below to false?
v1.8.0-windows,state.is_valid = false;
v1.8.0-windows,else ignore
v1.8.0-windows,TODO: implement this for linux
v1.8.0-windows,TODO: implement this for linux
v1.8.0-windows,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.8.0-windows,{
v1.8.0-windows,"manufacturerID = productID = """";"
v1.8.0-windows,// Use udev to look up the product and manufacturer IDs
v1.8.0-windows,struct udev *udev = udev_new();
v1.8.0-windows,if (udev) {
v1.8.0-windows,char sysname[32];
v1.8.0-windows,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.8.0-windows,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.8.0-windows,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.8.0-windows,if (!dev)
v1.8.0-windows,{
v1.8.0-windows,"message = ""Unable to find parent USB device"";"
v1.8.0-windows,return false;
v1.8.0-windows,}
v1.8.0-windows,std::stringstream ss;
v1.8.0-windows,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.8.0-windows,ss >> manufacturerID;
v1.8.0-windows,ss.clear();
v1.8.0-windows,"ss.str("""");"
v1.8.0-windows,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.8.0-windows,ss >> productID;
v1.8.0-windows,udev_device_unref(dev);
v1.8.0-windows,}
v1.8.0-windows,else
v1.8.0-windows,{
v1.8.0-windows,"message = ""Cannot create udev"";"
v1.8.0-windows,return false;
v1.8.0-windows,}
v1.8.0-windows,udev_unref(udev);
v1.8.0-windows,return true;
v1.8.0-windows,}
v1.8.0-windows,required for pimpl
v1.8.0-windows,TODO: anyway to workaround const_cast?
v1.8.0-windows,FGenericPlatformMisc::PlatformInit();
v1.8.0-windows,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.8.0-windows,"sub-window captures don't count as a request, set bCaptureEveryFrame and bCaptureOnMovement to display so we can show correctly the subwindow"
v1.8.0-windows,create main widget
v1.8.0-windows,synchronize PIP views
v1.8.0-windows,TODO: should we only do below on SceneCapture2D components and cameras?
v1.8.0-windows,avoid motion blur so capture images don't get
v1.8.0-windows,use two different methods to set console var because sometime it doesn't seem to work
v1.8.0-windows,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.8.0-windows,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.8.0-windows,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.8.0-windows,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.8.0-windows,setup defaults
v1.8.0-windows,Attempts to parse the settings text from one of multiple locations.
v1.8.0-windows,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.8.0-windows,"Next, check the executable's working directory for the settings file."
v1.8.0-windows,"Finally, check the user's documents folder."
v1.8.0-windows,"If the settings file cannot be read, throw an exception"
v1.8.0-windows,Attempts to parse the settings file path or the settings text from the command line
v1.8.0-windows,"Looks for the flag ""-settings="". If it exists, settingsText will be set to the value."
v1.8.0-windows,"Example (Path): AirSim.exe -settings=""C:\path\to\settings.json"""
v1.8.0-windows,"Example (Text): AirSim.exe -settings={""foo"":""bar""} -> settingsText will be set to {""foo"":""bar""}"
v1.8.0-windows,"Returns true if the argument is present, false otherwise."
v1.8.0-windows,build image file name
v1.8.0-windows,write image file
v1.8.0-windows,"Write PNG image, already compressed in binary"
v1.8.0-windows,write to CSV file
v1.8.0-windows,"Either images were saved successfully, or there were no images"
v1.8.0-windows,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.8.0-windows,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.8.0-windows,"Just need any 1 instance, to set the header line of the record file"
v1.8.0-windows,"Set is_ready at the end, setting this before can cause a race when the file isn't open yet"
v1.8.0-windows,make sure all vars are set up
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,decide which derived BP to use
v1.8.0-windows,we don't have real vehicle so no vehicle API
v1.8.0-windows,put camera little bit above vehicle
v1.8.0-windows,update ground level
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,let base class setup physics world
v1.8.0-windows,stop physics thread before we dismantle
v1.8.0-windows,setup clock in ClockFactory
v1.8.0-windows,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.8.0-windows,steppable clock returns interval that is a constant number irrespective of wall clock
v1.8.0-windows,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.8.0-windows,but that would cause vehicles like quadrotors to become unstable
v1.8.0-windows,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.8.0-windows,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.8.0-windows,get increase in clock speed
v1.8.0-windows,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.8.0-windows,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.8.0-windows,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.8.0-windows,Approach 2: scale control loop frequency if clock is speeded up
v1.8.0-windows,"for slowing down, this don't generate instability"
v1.8.0-windows,-------------------------------- overrides -----------------------------------------------//
v1.8.0-windows,decide which derived BP to use
v1.8.0-windows,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.8.0-windows,vehicle_sim_api->reset();
v1.8.0-windows,create vehicle API
v1.8.0-windows,setup physics vehicle
v1.8.0-windows,initialize private vars
v1.8.0-windows,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.8.0-windows,calls to update* are handled by physics engine and in SimModeWorldBase
v1.8.0-windows,"Utils::log(""------Render tick-------"");"
v1.8.0-windows,"if reset is pending then do it first, no need to do other things until next tick"
v1.8.0-windows,move collision info from rendering engine to vehicle
v1.8.0-windows,update rotor poses
v1.8.0-windows,update private rotor variable
v1.8.0-windows,if we did reset then don't worry about synchronizing states for this tick
v1.8.0-windows,Continue to wait for reset
v1.8.0-windows,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.8.0-windows,*** Start: UpdatableState implementation ***//
v1.8.0-windows,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.8.0-windows,environment update for current position
v1.8.0-windows,update forces on vertices
v1.8.0-windows,update to controller must be done after kinematics have been updated by physics engine
v1.8.0-windows,*** End: UpdatableState implementation ***//
v1.8.0-windows,get references of existing camera
v1.8.0-windows,setup clock in PhysX
v1.8.0-windows,-------------------------------- overrides -----------------------------------------------//
v1.8.0-windows,decide which derived BP to use
v1.8.0-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.8.0-windows,Setup suspension forces
v1.8.0-windows,Find the tire object and set the data for it
v1.8.0-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.8.0-windows,Setup suspension forces
v1.8.0-windows,Find the tire object and set the data for it
v1.8.0-windows,Create In-Car camera component
v1.8.0-windows,In car HUD
v1.8.0-windows,Create text render component for in car speed display
v1.8.0-windows,Create text render component for in car gear display
v1.8.0-windows,Setup the audio component and allocate it a sound cue
v1.8.0-windows,Colors for the in-car gear display. One for normal one for reverse
v1.8.0-windows,Wheels/Tires
v1.8.0-windows,Setup the wheels
v1.8.0-windows,Adjust the tire loading
v1.8.0-windows,Engine
v1.8.0-windows,Torque setup
v1.8.0-windows,Adjust the steering
v1.8.0-windows,Transmission
v1.8.0-windows,We want 4wd
v1.8.0-windows,Drive the front wheels a little more than the rear
v1.8.0-windows,Automatic gearbox
v1.8.0-windows,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.8.0-windows,Physics settings
v1.8.0-windows,Adjust the center of mass - the buggy is quite low
v1.8.0-windows,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.8.0-windows,put camera little bit above vehicle
v1.8.0-windows,update physics material
v1.8.0-windows,Update the strings used in the HUD (in-car and on-screen)
v1.8.0-windows,Set the string in the in-car HUD
v1.8.0-windows,Pass the engine RPM to the sound component
v1.8.0-windows,Start an engine sound playing
v1.8.0-windows,Using FText because this is display text that should be localizable
v1.8.0-windows,Setup the text render component strings
v1.8.0-windows,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.8.0-windows,below is not needed
v1.8.0-windows,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.8.0-windows,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.8.0-windows,create vehicle params
v1.8.0-windows,TODO: should do reset() here?
v1.8.0-windows,these are called on render ticks
v1.8.0-windows,TODO: do we need this for cars?
v1.8.0-windows,TODO: move this to SimModeBase?
v1.8.0-windows,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.8.0-windows,reset();
v1.8.0-windows,return;
v1.8.0-windows,}
v1.8.0-windows,Thrustmaster devices
v1.8.0-windows,"Anything else, typically Logitech G920 wheel"
v1.8.0-windows,Two steel levers behind wheel
v1.8.0-windows,if API-client control is not active then we route keyboard/joystick control to car
v1.8.0-windows,all car controls from anywhere must be routed through API component
v1.8.0-windows,*** Start: UpdatableState implementation ***//
v1.8.0-windows,physics tick
v1.8.0-windows,*** End: UpdatableState implementation ***//
v1.8.0-windows,TODO: directly accept getVehicleSimApis() using generic container
v1.8.0-windows,Reset the vehicle as well before registering it
v1.8.0-windows,Similar to what happens in initializeForPlay() above
v1.8.0-windows,remove everything that we created in BeginPlay
v1.8.0-windows,wait if no new frame is renderd
v1.8.0-windows,we use custom debug reporting for this class
v1.8.0-windows,perform any expensive rendering update outside of lock region
v1.8.0-windows,no need to call base reset because of our custom implementation
v1.8.0-windows,TODO: this is going to cause circular references which is fine here but
v1.8.0-windows,in future we should consider moving SimMode not derived from AActor and move
v1.8.0-windows,it to AirLib and directly implement WorldSimApiBase interface
v1.8.0-windows,get player start
v1.8.0-windows,this must be done from within actor otherwise we don't get player start
v1.8.0-windows,Grab player location
v1.8.0-windows,Move the world origin to the player's location (this moves the coordinate system and adds
v1.8.0-windows,a corresponding offset to all positions to compensate for the shift)
v1.8.0-windows,"Regrab the player's position after the offset has been added (which should be 0,0,0 now)"
v1.8.0-windows,UWeatherLib::showWeatherMenu(World);
v1.8.0-windows,else don't init
v1.8.0-windows,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v1.8.0-windows,tod_sim_clock_start_ needs to be reset here.
v1.8.0-windows,Going from enabled to disabled
v1.8.0-windows,do these in the end to ensure that advanceTimeOfDay() doesn't see
v1.8.0-windows,any inconsistent state.
v1.8.0-windows,should be overridden by derived class
v1.8.0-windows,should be overriden by derived class
v1.8.0-windows,should be overridden by derived class
v1.8.0-windows,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.8.0-windows,default setup - this should be overridden in derived modes as needed
v1.8.0-windows,setup clock in ClockFactory
v1.8.0-windows,default implementation
v1.8.0-windows,create director
v1.8.0-windows,create external camera required for the director
v1.8.0-windows,for each camera in settings
v1.8.0-windows,get pose
v1.8.0-windows,spawn and attach camera to pawn
v1.8.0-windows,add on to our collection
v1.8.0-windows,API server start/stop
v1.8.0-windows,get UU origin of global NED frame
v1.8.0-windows,compute initial pose
v1.8.0-windows,spawn vehicle pawn
v1.8.0-windows,create vehicle sim api
v1.8.0-windows,Convert to lowercase as done during settings loading
v1.8.0-windows,TODO: Figure out a better way to add more fields
v1.8.0-windows,Maybe allow passing a JSON string for the vehicle settings?
v1.8.0-windows,"Retroactively adjust AirSimSettings, so it's like we knew about this vehicle all along"
v1.8.0-windows,"Usually physics registration happens at init, in ASimModeWorldBase::initializeForPlay(), but not in this case"
v1.8.0-windows,get UU origin of global NED frame
v1.8.0-windows,determine camera director camera default pose and spawn it
v1.8.0-windows,find all vehicle pawns
v1.8.0-windows,add vehicles from settings
v1.8.0-windows,if vehicle is of type for derived SimMode and auto creatable
v1.8.0-windows,create API objects for each pawn we have
v1.8.0-windows,Create External Cameras
v1.8.0-windows,TODO: better handle no FPV vehicles scenario
v1.8.0-windows,derived class shoudl override this method to add new vehicle to the physics engine
v1.8.0-windows,derived class should override this method to retrieve types of pawns they support
v1.8.0-windows,derived class should override this method to retrieve types of pawns they support
v1.8.0-windows,derived class should override this method to retrieve types of pawns they support
v1.8.0-windows,derived class should override this method to retrieve types of pawns they support
v1.8.0-windows,derived class should override this method to retrieve types of pawns they support
v1.8.0-windows,derived class should override this method to retrieve types of pawns they support
v1.8.0-windows,derived class should override this method to retrieve types of pawns they support
v1.8.0-windows,Draws debug-points on main viewport for Lidar laser hits.
v1.8.0-windows,Used for debugging only.
v1.8.0-windows,Currently we are checking the sensor-collection instead of sensor-settings.
v1.8.0-windows,Also using variables to optimize not checking the collection if not needed.
v1.8.0-windows,TODO: Is it incorrect to assume LidarSimple here?
v1.8.0-windows,Draw debug-point on main viewport for Distance sensor hit
v1.8.0-windows,Find position of point hit
v1.8.0-windows,Similar to UnrealDistanceSensor.cpp#L19
v1.8.0-windows,order of Pose addition is important here because it also adds quaternions which is not commutative!
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,ctor
v1.8.0-windows,initializes information based on lidar configuration
v1.8.0-windows,calculate verticle angle distance between each laser
v1.8.0-windows,store vertical angles for each laser
v1.8.0-windows,returns a point-cloud for the tick
v1.8.0-windows,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.8.0-windows,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.8.0-windows,calculate number of points needed for each laser/channel
v1.8.0-windows,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.8.0-windows,calculate needed angle/distance between each point
v1.8.0-windows,normalize FOV start/end
v1.8.0-windows,shoot lasers
v1.8.0-windows,check if the laser is outside the requested horizontal FOV
v1.8.0-windows,"shoot laser and get the impact point, if any"
v1.8.0-windows,simulate shooting a laser via Unreal ray-tracing.
v1.8.0-windows,start position
v1.8.0-windows,We need to compose rotations here rather than rotate a vector by a quaternion
v1.8.0-windows,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.8.0-windows,get ray quaternion in lidar frame (angles must be in radians)
v1.8.0-windows,get ray quaternion in body frame
v1.8.0-windows,get ray quaternion in world frame
v1.8.0-windows,get ray vector (end position)
v1.8.0-windows,Store the segmentation id of the hit object.
v1.8.0-windows,Debug code for very specific cases.
v1.8.0-windows,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.8.0-windows,decide the frame for the point-cloud
v1.8.0-windows,current detault behavior; though it is probably not very useful.
v1.8.0-windows,not changing the default for now to maintain backwards-compat.
v1.8.0-windows,point in vehicle intertial frame
v1.8.0-windows,tranform to lidar frame
v1.8.0-windows,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.8.0-windows,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.8.0-windows,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.8.0-windows,"On the client side, if it is needed to transform this data back to the world frame,"
v1.8.0-windows,"then do the equivalent of following,"
v1.8.0-windows,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.8.0-windows,See SimModeBase::drawLidarDebugPoints()
v1.8.0-windows,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.8.0-windows,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,update ray tracing
v1.8.0-windows,"FString hit_name = FString(""None"");"
v1.8.0-windows,if (dist_hit.GetActor())
v1.8.0-windows,hit_name=dist_hit.GetActor()->GetName();
v1.8.0-windows,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.8.0-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,This assumes you are running DroneServer already on the same machine.
v1.8.0-windows,DroneServer must be running first.
v1.8.0-windows,enable API control
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,Load gazebo
v1.8.0-windows,Create our node for communication
v1.8.0-windows,Listen to Gazebo topics
v1.8.0-windows,Make sure to shut everything down.
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,move commands
v1.8.0-windows,else leave as it is
v1.8.0-windows,TODO: get these in one call
v1.8.0-windows,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.8.0-windows,TODO: shouldn't we pass folder path?
v1.8.0-windows,parse
v1.8.0-windows,group the images by the current date.
v1.8.0-windows,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.8.0-windows,{
v1.8.0-windows,"return """";"
v1.8.0-windows,}
v1.8.0-windows,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.8.0-windows,{
v1.8.0-windows,return false;
v1.8.0-windows,}
v1.8.0-windows,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.8.0-windows,params.context->client.newTask();
v1.8.0-windows,}
v1.8.0-windows,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.8.0-windows,params.context->client.WaitForCompletion(0);
v1.8.0-windows,}
v1.8.0-windows,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.8.0-windows,{
v1.8.0-windows,}
v1.8.0-windows,parse command line
v1.8.0-windows,Shell callbacks
v1.8.0-windows,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.8.0-windows,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.8.0-windows,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.8.0-windows,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.8.0-windows,Add shell commands
v1.8.0-windows,TODO: add WaitForCompletion command
v1.8.0-windows,"TODO: add command line args help, arg count validation"
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v1.8.0-windows,switch to explicit hover mode so that this is the fall back when
v1.8.0-windows,move* commands are finished.
v1.8.0-windows,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.8.0-windows,TODO: implement weather for Unity
v1.8.0-windows,TODO: implement weather for Unity
v1.8.0-windows,----------------Plotting APIs-----------/
v1.8.0-windows,Recording APIs
v1.8.0-windows,"Remove '' from the list, representing default vehicle"
v1.8.0-windows,CinemAirSim
v1.8.0-windows,End CinemAirSim
v1.8.0-windows,Function pointers to hold the addresses of the functions that are defined in Unity
v1.8.0-windows,"Enabling all LogLevels,"
v1.8.0-windows,"Enabling all LogLevels,"
v1.8.0-windows,delete ltm;
v1.8.0-windows,initialize state
v1.8.0-windows,compute our home point
v1.8.0-windows,default behavior is to call update every tick
v1.8.0-windows,"for custom physics engine, this method should be overridden and update should be"
v1.8.0-windows,called from every physics tick
v1.8.0-windows,these will be available for devices like steering wheels
v1.8.0-windows,sync environment from kinematics
v1.8.0-windows,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.8.0-windows,FVector unrealPosition = getUUPosition();
v1.8.0-windows,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v1.8.0-windows,parameters in NED frame
v1.8.0-windows,allow teleportation
v1.8.0-windows,if collisions are not enabled
v1.8.0-windows,or we have collided but passthrough is enabled
v1.8.0-windows,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.8.0-windows,"without flip flopping, collisions can't be detected"
v1.8.0-windows,by default we update kinematics from UE pawn
v1.8.0-windows,if SimMod uses its own physics engine then this should be overriden
v1.8.0-windows,no default action in this base class
v1.8.0-windows,TODO: because this bug we are using alternative code with stringstream
v1.8.0-windows,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.8.0-windows,update kinematics from pawn's movement instead of physics engine
v1.8.0-windows,TODO: update other fields?
v1.8.0-windows,implements getImages() method in the ImageCaptureBase class.
v1.8.0-windows,update ray tracing
v1.8.0-windows,Attempts to parse the settings text from one of multiple locations.
v1.8.0-windows,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.8.0-windows,"Next, check the executable's working directory for the settings file."
v1.8.0-windows,"Finally, check the user's documents folder."
v1.8.0-windows,"If the settings file cannot be read, throw an exception"
v1.8.0-windows,let base class setup physics world
v1.8.0-windows,stop physics thread before we dismantle
v1.8.0-windows,setup clock in ClockFactory
v1.8.0-windows,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.8.0-windows,steppable clock returns interval that is a constant number irrespective of wall clock
v1.8.0-windows,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.8.0-windows,but that would cause vehicles like quadrotors to become unstable
v1.8.0-windows,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.8.0-windows,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.8.0-windows,get increase in clock speed
v1.8.0-windows,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.8.0-windows,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.8.0-windows,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.8.0-windows,Approach 2: scale control loop frequency if clock is speeded up
v1.8.0-windows,"for slowing down, this don't generate instability"
v1.8.0-windows,-------------------------------- overrides -----------------------------------------------//
v1.8.0-windows,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.8.0-windows,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.8.0-windows,create vehicle API
v1.8.0-windows,setup physics vehicle
v1.8.0-windows,initialize private vars
v1.8.0-windows,"if reset is pending then do it first, no need to do other things until next tick"
v1.8.0-windows,move collision info from rendering engine to vehicle
v1.8.0-windows,update rotor poses
v1.8.0-windows,if we did reset then don't worry about synchronizing states for this tick
v1.8.0-windows,Continue to wait for reset
v1.8.0-windows,*** Start: UpdatableState implementation ***//
v1.8.0-windows,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.8.0-windows,environment update for current position
v1.8.0-windows,update forces on vertices
v1.8.0-windows,update to controller must be done after kinematics have been updated by physics engine
v1.8.0-windows,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.8.0-windows,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.8.0-windows,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.8.0-windows,*** End: UpdatableState implementation ***//
v1.8.0-windows,TODO: should do reset() here?
v1.8.0-windows,these are called on render ticks
v1.8.0-windows,TODO: do we need this for cars?
v1.8.0-windows,Thrustmaster devices
v1.8.0-windows,"Anything else, typically Logitech G920 wheel"
v1.8.0-windows,Two steel levers behind wheel
v1.8.0-windows,if API-client control is not active then we route keyboard/joystick control to car
v1.8.0-windows,This is so that getCarControls API works correctly
v1.8.0-windows,"API is enabled, so we use the controls set by API"
v1.8.0-windows,Update whether to use API controls or keyboard controls
v1.8.0-windows,*** Start: UpdatableState implementation ***//
v1.8.0-windows,physics tick
v1.8.0-windows,void CarPawnSimApi::reportState(StateReporter& reporter)
v1.8.0-windows,{
v1.8.0-windows,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.8.0-windows,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.8.0-windows,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.8.0-windows,}
v1.8.0-windows,*** End: UpdatableState implementation ***//
v1.8.0-windows,remove everything that we created in BeginPlay
v1.8.0-windows,we use custom debug reporting for this class
v1.8.0-windows,perform any expensive rendering update outside of lock region
v1.8.0-windows,no need to call base reset because of our custom implementation
v1.8.0-windows,should be overridden by derived class
v1.8.0-windows,should be overridden by derived class
v1.8.0-windows,should be overridden by derived class
v1.8.0-windows,commenting this out for now to avoid unintentional Unity startup failure
v1.8.0-windows,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v1.8.0-windows,should be overridden by derived class
v1.8.0-windows,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.8.0-windows,default setup - this should be overridden in derived modes as needed
v1.8.0-windows,setup clock in ClockFactory
v1.8.0-windows,API server start/stop
v1.8.0-windows,determine camera director camera default pose and spawn it
v1.8.0-windows,derived class should override this method to retrieve types of pawns they support
v1.8.0-windows,derived class should override this method to retrieve types of pawns they support
v1.8.0-windows,can we just take origin in Unity here?
v1.8.0-windows,60 acres park:
v1.8.0-windows,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.8.0-windows,marymoore park
v1.8.0-windows,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.8.0-windows,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.8.0-windows,DepthNavThreshold depthNav;
v1.8.0-windows,DepthNavOptAStar depthNav;
v1.8.0-windows,DepthNavThreshold depthNav;
v1.8.0-windows,DepthNavOptAStar depthNav;
v1.8.0-windows,runDepthNavGT();
v1.8.0-windows,runDepthNavSGM();
v1.8.0-windows,Create the launch description and populate
v1.8.0-windows,Declare the launch options
v1.8.0-windows,todo do not reset if already in air?
v1.8.0-windows,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.8.0-windows,ros params
v1.8.0-windows,todo enforce dynamics constraints in this node as well?
v1.8.0-windows,"nh_->get_parameter(""max_vert_vel_"", max_vert_vel_);"
v1.8.0-windows,"nh_->get_parameter(""max_horz_vel"", max_horz_vel_)"
v1.8.0-windows,subscribe to control commands on global nodehandle
v1.8.0-windows,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.8.0-windows,bind to a single callback. todo optimal subs queue length
v1.8.0-windows,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.8.0-windows,"vehicle_ros.reset_srvr = nh_->create_service(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.8.0-windows,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.8.0-windows,camera_setting.gimbal
v1.8.0-windows,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.8.0-windows,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.8.0-windows,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.8.0-windows,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.8.0-windows,"if {DepthPlanar, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.8.0-windows,"push back pair (vector of image captures, current vehicle name)"
v1.8.0-windows,iterate over sensors
v1.8.0-windows,add takeoff and land all services if more than 2 drones
v1.8.0-windows,todo add per vehicle reset in AirLib API
v1.8.0-windows,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.8.0-windows,lidars update on their own callback/thread at a given rate
v1.8.0-windows,QoS - The depth of the publisher message queue.
v1.8.0-windows,more details here - https://docs.ros.org/en/foxy/Concepts/About-Quality-of-Service-Settings.html
v1.8.0-windows,"todo: error check. if state is not landed, return error."
v1.8.0-windows,response->success =
v1.8.0-windows,response->success =
v1.8.0-windows,response->success =
v1.8.0-windows,response->success =
v1.8.0-windows,response->success =
v1.8.0-windows,response->success =
v1.8.0-windows,todo add reset by vehicle_name API to airlib
v1.8.0-windows,todo not async remove wait_on_last_task
v1.8.0-windows,todo expose wait_on_last_task or nah?
v1.8.0-windows,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.8.0-windows,todo expose wait_on_last_task or nah?
v1.8.0-windows,todo support multiple gimbal commands
v1.8.0-windows,todo support multiple gimbal commands
v1.8.0-windows,1. find quaternion of default gimbal pose
v1.8.0-windows,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.8.0-windows,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.8.0-windows,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.8.0-windows,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.8.0-windows,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.8.0-windows,msg = []
v1.8.0-windows,todo covariances
v1.8.0-windows,gps_msg.position_covariance_type =
v1.8.0-windows,gps_msg.position_covariance =
v1.8.0-windows,todo covariances
v1.8.0-windows,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.8.0-windows,todo radians per second
v1.8.0-windows,meters/s2^m
v1.8.0-windows,imu_msg.orientation_covariance = ;
v1.8.0-windows,imu_msg.angular_velocity_covariance = ;
v1.8.0-windows,imu_msg.linear_acceleration_covariance = ;
v1.8.0-windows,todo do actual body frame?
v1.8.0-windows,airsim uses degrees
v1.8.0-windows,todo this is global origin
v1.8.0-windows,get the basic vehicle pose and environmental state
v1.8.0-windows,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.8.0-windows,airsim_client needs to provide the simulation time in a future version of the API
v1.8.0-windows,publish the simulation clock
v1.8.0-windows,"publish vehicle state, odom, and all basic sensor types"
v1.8.0-windows,send any commands out to the vehicles
v1.8.0-windows,"should be easier way to get the sim time through API, something like:"
v1.8.0-windows,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.8.0-windows,curr_ros_time = rclcpp::Time(env.clock().nowNanos());
v1.8.0-windows,iterate over drones
v1.8.0-windows,get drone state from airsim
v1.8.0-windows,"vehicle environment, we can get ambient temperature here and other truths"
v1.8.0-windows,convert airsim drone state to ROS msgs
v1.8.0-windows,simulation environment truth
v1.8.0-windows,"dashboard reading from car, RPM, gear, etc"
v1.8.0-windows,odom and transforms
v1.8.0-windows,ground truth GPS position from sim/HITL
v1.8.0-windows,send control commands from the last callback to airsim
v1.8.0-windows,send control commands from the last callback to airsim
v1.8.0-windows,"Only camera rotation, no translation movement of camera"
v1.8.0-windows,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.8.0-windows,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.8.0-windows,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.8.0-windows,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.8.0-windows,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.8.0-windows,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.8.0-windows,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.8.0-windows,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.8.0-windows,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.8.0-windows,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.8.0-windows,update timestamp of saved cam info msgs
v1.8.0-windows,DepthPlanar / DepthPerspective / DepthVis / DisparityNormalized
v1.8.0-windows,Scene / Segmentation / SurfaceNormals / Infrared
v1.8.0-windows,publish camera transforms
v1.8.0-windows,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.8.0-windows,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.8.0-windows,ROS params
v1.8.0-windows,ROS publishers
v1.8.0-windows,ROS subscribers
v1.8.0-windows,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.8.0-windows,ROS timers
v1.8.0-windows,todo maintain internal representation as eigen vec?
v1.8.0-windows,todo check if low velocity if within thresh?
v1.8.0-windows,todo maintain separate errors for XY and Z
v1.8.0-windows,todo save this in degrees somewhere to avoid repeated conversion
v1.8.0-windows,this tells the update timer callback to not do active hovering
v1.8.0-windows,todo maintain array of position goals
v1.8.0-windows,todo error checks
v1.8.0-windows,todo fill response
v1.8.0-windows,"Already have goal, and have reached it"
v1.8.0-windows,this tells the update timer callback to not do active hovering
v1.8.0-windows,todo error checks
v1.8.0-windows,todo fill response
v1.8.0-windows,"todo do relative altitude, or add an option for the same?"
v1.8.0-windows,convert GPS goal to NED goal
v1.8.0-windows,"RCLCPP_INFO_STREAM(""geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.8.0-windows,todo error checks
v1.8.0-windows,todo fill response
v1.8.0-windows,"Already have goal, this shouldn't happen"
v1.8.0-windows,"todo do relative altitude, or add an option for the same?"
v1.8.0-windows,convert GPS goal to NED goal
v1.8.0-windows,"RCLCPP_INFO_STREAM(""geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.8.0-windows,todo error checks
v1.8.0-windows,todo fill response
v1.8.0-windows,todo check if odometry is too old!!
v1.8.0-windows,"if no odom, don't do anything."
v1.8.0-windows,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.8.0-windows,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.8.0-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.8.0-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.8.0-windows,todo yaw limits
v1.8.0-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.8.0-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.8.0-windows,mimics void ASimHUD::initializeSettings()
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,by Sudipta Sinha
v1.8.0-windows,adapted for AirSim by Matthias Mueller
v1.8.0-windows,first row
v1.8.0-windows,last row
v1.8.0-windows,Local quadratic fit of cost and subpixel refinement.
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,by Sudipta Sinha
v1.8.0-windows,adapted for AirSim by Matthias Mueller
v1.8.0-windows,uint64_t x64 = (uint64_t)x;
v1.8.0-windows,uint64_t y64 = (uint64_t)y;
v1.8.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-windows,Licensed under the MIT License.
v1.8.0-windows,by Sudipta Sinha
v1.8.0-windows,adapted for AirSim by Matthias Mueller
v1.8.0-windows,ensure that disparity range is a multiple of 8
v1.8.0-windows,sgm stereo
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,read settings and override defaults
v1.8.0-linux,allow json overrides on a per-vehicle basis.
v1.8.0-linux,start server in async mode
v1.8.0-linux,check messages
v1.8.0-linux,plot red arrows for 30 seconds
v1.8.0-linux,plot magenta arrows for 15 seconds
v1.8.0-linux,plot red arrows for 10 seconds
v1.8.0-linux,plot 2 white arrows which are persistent
v1.8.0-linux,plot points
v1.8.0-linux,"plot line strip. 0-1, 1-2, 2-3"
v1.8.0-linux,"plot line list. 0-1, 2-3, 4-5. Must be even."
v1.8.0-linux,plot transforms
v1.8.0-linux,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=0.0, yaw=yaw)) for x, y, yaw in zip(np.linspace(0,10,10), np.linspace(0,0,10), np.linspace(0,np.pi,10))],"
v1.8.0-linux,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.8.0-linux,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=roll, yaw=0.0)) for x, y, roll in zip(np.linspace(0,10,10), np.linspace(1,1,10), np.linspace(0,np.pi,10))],"
v1.8.0-linux,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.8.0-linux,Access an existing light in the world
v1.8.0-linux,Destroy the light
v1.8.0-linux,Create a new light at the same pose
v1.8.0-linux,Change the light's intensity
v1.8.0-linux,asset_name = random.choice(assets)
v1.8.0-linux,Import this module to automatically setup path to local airsim module
v1.8.0-linux,This module first tries to see if airsim module is installed via pip
v1.8.0-linux,If it does then we don't do anything else
v1.8.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.8.0-linux,and if it does then we add that in sys.path
v1.8.0-linux,this class simply tries to see if airsim
v1.8.0-linux,if airsim module is installed then don't do anything else
v1.8.0-linux,import pkgutil
v1.8.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.8.0-linux,if airsim_loader is not None:
v1.8.0-linux,return
v1.8.0-linux,In settings.json first activate computer vision mode:
v1.8.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.8.0-linux,monitor car state while you drive it manually.
v1.8.0-linux,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v1.8.0-linux,denominator from microns^3 to microns * m^2)
v1.8.0-linux,First set everything to 0.
v1.8.0-linux,Next set all objects of interest provided to corresponding object IDs
v1.8.0-linux,segIdDict values MUST match tempEmissivityNew labels.
v1.8.0-linux,"Connect to AirSim, UAV mode."
v1.8.0-linux,Choose temperature values for winter or summer.
v1.8.0-linux,""""""""
v1.8.0-linux,winter
v1.8.0-linux,""""""""
v1.8.0-linux,summer
v1.8.0-linux,Read camera response.
v1.8.0-linux,Calculate radiance.
v1.8.0-linux,Set IDs in AirSim environment.
v1.8.0-linux,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.8.0-linux,save pic
v1.8.0-linux,Change the below dimensions appropriately for the camera settings
v1.8.0-linux,In settings.json first activate computer vision mode:
v1.8.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.8.0-linux,"define abstract class to return next vector in the format (x,y,yaw)"
v1.8.0-linux,"compute vector, distance and angle to goal"
v1.8.0-linux,compute box of interest
v1.8.0-linux,scale by weight matrix (optional)
v1.8.0-linux,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.8.0-linux,detect collision
v1.8.0-linux,compute box of interest
v1.8.0-linux,detect collision
v1.8.0-linux,Same as above but decide to go left or right based on average or some metric like that
v1.8.0-linux,"compute resultant normalized vector, distance and angle"
v1.8.0-linux,compute bounding box size
v1.8.0-linux,convert horizonal fov to vertical fov
v1.8.0-linux,matrix with all ones
v1.8.0-linux,matrix with max weight in center and decreasing linearly with distance from center
v1.8.0-linux,matrix with max weight in center and decreasing quadratically with distance from center
v1.8.0-linux,"print (""Saving images to %s"" % tmp_dir)"
v1.8.0-linux,airsim.wait_key('Press any key to start')
v1.8.0-linux,"Define start position, goal and size of UAV"
v1.8.0-linux,Define parameters and thresholds
v1.8.0-linux,initial position
v1.8.0-linux,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.8.0-linux,time.sleep(1)
v1.8.0-linux,get response
v1.8.0-linux,get numpy array
v1.8.0-linux,reshape array to 2D array H X W
v1.8.0-linux,write to png
v1.8.0-linux,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.8.0-linux,pose = client.simGetPose()
v1.8.0-linux,pp.pprint(pose)
v1.8.0-linux,time.sleep(5)
v1.8.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.8.0-linux,################### OLD CODE
v1.8.0-linux,timer = 0
v1.8.0-linux,time_obs = 50
v1.8.0-linux,bObstacle = False
v1.8.0-linux,if (bObstacle):
v1.8.0-linux,timer = timer + 1
v1.8.0-linux,if timer > time_obs:
v1.8.0-linux,bObstacle = False
v1.8.0-linux,timer = 0
v1.8.0-linux,else:
v1.8.0-linux,yaw = target_angle
v1.8.0-linux,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.8.0-linux,if (np.average(img2d_box) < coll_thres):
v1.8.0-linux,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.8.0-linux,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.8.0-linux,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.8.0-linux,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.8.0-linux,"print('left: ', img2d_box_l_avg)"
v1.8.0-linux,"print('right: ', img2d_box_r_avg)"
v1.8.0-linux,if img2d_box_l_avg > img2d_box_r_avg:
v1.8.0-linux,##Go LEFT
v1.8.0-linux,#y_offset = y_offset-1
v1.8.0-linux,yaw = yaw - radians(10)
v1.8.0-linux,bObstacle = True
v1.8.0-linux,else:
v1.8.0-linux,##Go RIGHT
v1.8.0-linux,#y_offset = y_offset+1
v1.8.0-linux,yaw = yaw + radians(10)
v1.8.0-linux,bObstacle = true
v1.8.0-linux,"print('yaw: ', yaw)"
v1.8.0-linux,In settings.json first activate computer vision mode:
v1.8.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.8.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.8.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.8.0-linux,pip install opencv-python
v1.8.0-linux,Just change the below to test different cameras easily!
v1.8.0-linux,Test Camera info
v1.8.0-linux,Test Image APIs
v1.8.0-linux,Test FoV API
v1.8.0-linux,Test Pose APIs
v1.8.0-linux,Test Distortion params APIs
v1.8.0-linux,In settings.json first activate computer vision mode:
v1.8.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.8.0-linux,In settings.json first activate computer vision mode:
v1.8.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.8.0-linux,for block environment
v1.8.0-linux,regex are case insensitive
v1.8.0-linux,#for neighborhood environment
v1.8.0-linux,set object ID for sky
v1.8.0-linux,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.8.0-linux,get segmentation image in various formats
v1.8.0-linux,save segmentation images in various formats
v1.8.0-linux,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.8.0-linux,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.8.0-linux,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v1.8.0-linux,find unique colors
v1.8.0-linux,In settings.json first activate computer vision mode:
v1.8.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.8.0-linux,objects can be named in two ways:
v1.8.0-linux,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.8.0-linux,default name is auto-generated and varies from run-to-run.
v1.8.0-linux,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.8.0-linux,
v1.8.0-linux,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.8.0-linux,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.8.0-linux,https://answers.unrealengine.com/revisions/790629.html
v1.8.0-linux,below works in Blocks environment
v1.8.0-linux,------------------------------------ Get current pose ------------------------------------------------
v1.8.0-linux,search object by name:
v1.8.0-linux,search another object by tag
v1.8.0-linux,search non-existent object
v1.8.0-linux,------------------------------------ Set new pose ------------------------------------------------
v1.8.0-linux,here we move with teleport enabled so collisions are ignored
v1.8.0-linux,here we move with teleport enabled so collisions are not ignored
v1.8.0-linux,move non-existent object
v1.8.0-linux,------------------------------------ Get new pose ------------------------------------------------
v1.8.0-linux,search another object by tag
v1.8.0-linux,search non-existent object
v1.8.0-linux,Import this module to automatically setup path to local airsim module
v1.8.0-linux,This module first tries to see if airsim module is installed via pip
v1.8.0-linux,If it does then we don't do anything else
v1.8.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.8.0-linux,and if it does then we add that in sys.path
v1.8.0-linux,this class simply tries to see if airsim
v1.8.0-linux,if airsim module is installed then don't do anything else
v1.8.0-linux,import pkgutil
v1.8.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.8.0-linux,if airsim_loader is not None:
v1.8.0-linux,return
v1.8.0-linux,"Roll is applied first, then pitch, then yaw."
v1.8.0-linux,Turn the camera position into a column vector.
v1.8.0-linux,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v1.8.0-linux,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v1.8.0-linux,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v1.8.0-linux,Recreate the perspective projection of the camera.
v1.8.0-linux,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v1.8.0-linux,Set pose and sleep after to ensure the pose sticks before capturing image.
v1.8.0-linux,Capture segmentation (IR) and scene images.
v1.8.0-linux,Change images into numpy arrays.
v1.8.0-linux,Capture images for a certain amount of time in seconds (half hour now)
v1.8.0-linux,Capture image - pose.position x_val access may change w/ AirSim
v1.8.0-linux,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v1.8.0-linux,Convert color scene image to BGR for write out with cv2.
v1.8.0-linux,"Connect to AirSim, UAV mode."
v1.8.0-linux,Look for objects with names that match a regular expression.
v1.8.0-linux,"Sample calls to main, varying camera angle and altitude."
v1.8.0-linux,"straight down, 400ft"
v1.8.0-linux,"straight down, 200ft"
v1.8.0-linux,"45 degrees, 200ft -- note that often object won't be scene since position"
v1.8.0-linux,is set exactly to object's
v1.8.0-linux,"45 degrees, 400ft -- note that often object won't be scene since position"
v1.8.0-linux,is set exactly to object's
v1.8.0-linux,In settings.json first activate computer vision mode:
v1.8.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.8.0-linux,xn = 1 + x*5  # some random number
v1.8.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,monitor car state while you drive it manually.
v1.8.0-linux,get state of the car
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,!/usr/bin/env python3
v1.8.0-linux,-*- coding: utf-8 -*-
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,set the controls for car
v1.8.0-linux,let car drive a bit
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,go forward
v1.8.0-linux,get state of the car
v1.8.0-linux,Python client example to change time-of-day using APIs
v1.8.0-linux,
v1.8.0-linux,Changes time of the day and makes the car move around
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,flip between specific time and default time
v1.8.0-linux,go forward
v1.8.0-linux,Go forward + steer right
v1.8.0-linux,main
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,get state of the car
v1.8.0-linux,go forward
v1.8.0-linux,Go forward + steer right
v1.8.0-linux,go reverse
v1.8.0-linux,apply brakes
v1.8.0-linux,get camera images from the car
v1.8.0-linux,restore to original state
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,go forward
v1.8.0-linux,Python client example to get Lidar data from a car
v1.8.0-linux,
v1.8.0-linux,Makes the drone fly and get Lidar data
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,"print(""state: %s"" % s)"
v1.8.0-linux,go forward
v1.8.0-linux,Go forward + steer right
v1.8.0-linux,"reshape array of floats to array of [X,Y,Z]"
v1.8.0-linux,TODO
v1.8.0-linux,main
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,get state of the car
v1.8.0-linux,go forward
v1.8.0-linux,Go forward + steer right
v1.8.0-linux,go reverse
v1.8.0-linux,apply breaks
v1.8.0-linux,restore to original state
v1.8.0-linux,Sleep for some time to wait for other vehicles to be created
v1.8.0-linux,"driveCar(vehicle_name, client)"
v1.8.0-linux,go forward
v1.8.0-linux,Go forward + steer right
v1.8.0-linux,go reverse
v1.8.0-linux,apply brakes
v1.8.0-linux,Import this module to automatically setup path to local airsim module
v1.8.0-linux,This module first tries to see if airsim module is installed via pip
v1.8.0-linux,If it does then we don't do anything else
v1.8.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.8.0-linux,and if it does then we add that in sys.path
v1.8.0-linux,this class simply tries to see if airsim
v1.8.0-linux,if airsim module is installed then don't do anything else
v1.8.0-linux,import pkgutil
v1.8.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.8.0-linux,if airsim_loader is not None:
v1.8.0-linux,return
v1.8.0-linux,Use below in settings.json with blocks environment
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,get state of the car
v1.8.0-linux,go forward
v1.8.0-linux,go reverse
v1.8.0-linux,apply breaks
v1.8.0-linux,get camera images from the car
v1.8.0-linux,restore to original state
v1.8.0-linux,from keras.models import load_model
v1.8.0-linux,if (len(sys.argv) != 2):
v1.8.0-linux,print('usage: python drive.py <modelName>')
v1.8.0-linux,sys.exit()
v1.8.0-linux,print('Loading model...')
v1.8.0-linux,model = load_model(sys.argv[1])
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.8.0-linux,"model_output = model.predict([image_buf, state_buf])"
v1.8.0-linux,car_controls.steering = float(model_output[0][0])
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,set camera name and image type to request images and detections
v1.8.0-linux,set detection radius in [cm]
v1.8.0-linux,add desired object name to detect in wild card/regex format
v1.8.0-linux,Import this module to automatically setup path to local airsim module
v1.8.0-linux,This module first tries to see if airsim module is installed via pip
v1.8.0-linux,If it does then we don't do anything else
v1.8.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.8.0-linux,and if it does then we add that in sys.path
v1.8.0-linux,this class simply tries to see if airsim
v1.8.0-linux,if airsim module is installed then don't do anything else
v1.8.0-linux,import pkgutil
v1.8.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.8.0-linux,if airsim_loader is not None:
v1.8.0-linux,return
v1.8.0-linux,-*- coding: utf-8 -*-
v1.8.0-linux,
v1.8.0-linux,Configuration file for the Sphinx documentation builder.
v1.8.0-linux,
v1.8.0-linux,This file does only contain a selection of the most common options. For a
v1.8.0-linux,full list see the documentation:
v1.8.0-linux,http://www.sphinx-doc.org/en/master/config
v1.8.0-linux,-- Path setup --------------------------------------------------------------
v1.8.0-linux,"If extensions (or modules to document with autodoc) are in another directory,"
v1.8.0-linux,add these directories to sys.path here. If the directory is relative to the
v1.8.0-linux,"documentation root, use os.path.abspath to make it absolute, like shown here."
v1.8.0-linux,
v1.8.0-linux,-- Project information -----------------------------------------------------
v1.8.0-linux,The short X.Y version
v1.8.0-linux,"The full version, including alpha/beta/rc tags"
v1.8.0-linux,-- General configuration ---------------------------------------------------
v1.8.0-linux,"If your documentation needs a minimal Sphinx version, state it here."
v1.8.0-linux,
v1.8.0-linux,needs_sphinx = '1.0'
v1.8.0-linux,"Add any Sphinx extension module names here, as strings. They can be"
v1.8.0-linux,extensions coming with Sphinx (named 'sphinx.ext.*') or your custom
v1.8.0-linux,ones.
v1.8.0-linux,"Add any paths that contain templates here, relative to this directory."
v1.8.0-linux,The suffix(es) of source filenames.
v1.8.0-linux,You can specify multiple suffix as a list of string:
v1.8.0-linux,
v1.8.0-linux,"source_suffix = ['.rst', '.md']"
v1.8.0-linux,The master toctree document.
v1.8.0-linux,The language for content autogenerated by Sphinx. Refer to documentation
v1.8.0-linux,for a list of supported languages.
v1.8.0-linux,
v1.8.0-linux,This is also used if you do content translation via gettext catalogs.
v1.8.0-linux,"Usually you set ""language"" from the command line for these cases."
v1.8.0-linux,"List of patterns, relative to source directory, that match files and"
v1.8.0-linux,directories to ignore when looking for source files.
v1.8.0-linux,This pattern also affects html_static_path and html_extra_path.
v1.8.0-linux,The name of the Pygments (syntax highlighting) style to use.
v1.8.0-linux,-- Options for HTML output -------------------------------------------------
v1.8.0-linux,The theme to use for HTML and HTML Help pages.  See the documentation for
v1.8.0-linux,a list of builtin themes.
v1.8.0-linux,
v1.8.0-linux,html_theme = 'alabaster'
v1.8.0-linux,Theme options are theme-specific and customize the look and feel of a theme
v1.8.0-linux,"further.  For a list of options available for each theme, see the"
v1.8.0-linux,documentation.
v1.8.0-linux,
v1.8.0-linux,html_theme_options = {}
v1.8.0-linux,"Add any paths that contain custom static files (such as style sheets) here,"
v1.8.0-linux,"relative to this directory. They are copied after the builtin static files,"
v1.8.0-linux,"so a file named ""default.css"" will overwrite the builtin ""default.css""."
v1.8.0-linux,"Custom sidebar templates, must be a dictionary that maps document names"
v1.8.0-linux,to template names.
v1.8.0-linux,
v1.8.0-linux,The default sidebars (for documents that don't match any pattern) are
v1.8.0-linux,defined by theme itself.  Builtin themes are using these templates by
v1.8.0-linux,"default: ``['localtoc.html', 'relations.html', 'sourcelink.html',"
v1.8.0-linux,'searchbox.html']``.
v1.8.0-linux,
v1.8.0-linux,html_sidebars = {}
v1.8.0-linux,-- Options for HTMLHelp output ---------------------------------------------
v1.8.0-linux,Output file base name for HTML help builder.
v1.8.0-linux,-- Options for LaTeX output ------------------------------------------------
v1.8.0-linux,The paper size ('letterpaper' or 'a4paper').
v1.8.0-linux,
v1.8.0-linux,"'papersize': 'letterpaper',"
v1.8.0-linux,"The font size ('10pt', '11pt' or '12pt')."
v1.8.0-linux,
v1.8.0-linux,"'pointsize': '10pt',"
v1.8.0-linux,Additional stuff for the LaTeX preamble.
v1.8.0-linux,
v1.8.0-linux,"'preamble': '',"
v1.8.0-linux,Latex figure (float) alignment
v1.8.0-linux,
v1.8.0-linux,"'figure_align': 'htbp',"
v1.8.0-linux,Grouping the document tree into LaTeX files. List of tuples
v1.8.0-linux,"(source start file, target name, title,"
v1.8.0-linux,"author, documentclass [howto, manual, or own class])."
v1.8.0-linux,-- Options for manual page output ------------------------------------------
v1.8.0-linux,One entry per manual page. List of tuples
v1.8.0-linux,"(source start file, name, description, authors, manual section)."
v1.8.0-linux,-- Options for Texinfo output ----------------------------------------------
v1.8.0-linux,Grouping the document tree into Texinfo files. List of tuples
v1.8.0-linux,"(source start file, target name, title, author,"
v1.8.0-linux,"dir menu entry, description, category)"
v1.8.0-linux,-- Options for Epub output -------------------------------------------------
v1.8.0-linux,Bibliographic Dublin Core info.
v1.8.0-linux,The unique identifier of the text. This can be a ISBN number
v1.8.0-linux,or the project homepage.
v1.8.0-linux,
v1.8.0-linux,epub_identifier = ''
v1.8.0-linux,A unique identification for the text.
v1.8.0-linux,
v1.8.0-linux,epub_uid = ''
v1.8.0-linux,A list of files that should not be packed into the epub file.
v1.8.0-linux,-- Extension configuration -------------------------------------------------
v1.8.0-linux,-- Options for intersphinx extension ---------------------------------------
v1.8.0-linux,Example configuration for intersphinx: refer to the Python standard library.
v1.8.0-linux,-- Options for todo extension ----------------------------------------------
v1.8.0-linux,"If true, `todo` and `todoList` produce output, else they produce nothing."
v1.8.0-linux,We ignore the 2D nature of the problem as it is not relevant here
v1.8.0-linux,It makes multi-core processing more straightforward
v1.8.0-linux,Allocations
v1.8.0-linux,Add small number to avoid issues with log(I)
v1.8.0-linux,Event sim keeps track of previous image automatically
v1.8.0-linux,"Using pickle dump in a per-frame fashion to save time, instead of savetxt"
v1.8.0-linux,Optimizations possible
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,that's enough fun for now. let's quit cleanly
v1.8.0-linux,"Python client example to get Lidar data from a drone, although this script works for any AirSim-supported vehicle"
v1.8.0-linux,This script is for Lidar sensors using 'SensorLocalFrame' as DataFrame under settings.json.
v1.8.0-linux,Sample settings.json used for this script:
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,main
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,MultirotorClient.wait_key('Press any key to takeoff')
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,get camera images from the car
v1.8.0-linux,that's enough fun for now. let's quit cleanly
v1.8.0-linux,##################################################################################################
v1.8.0-linux,
v1.8.0-linux,Project:  Embedded Learning Library (ELL)
v1.8.0-linux,File:     speaker.py
v1.8.0-linux,Authors:  Chris Lovett
v1.8.0-linux,
v1.8.0-linux,Requires: Python 3.x
v1.8.0-linux,
v1.8.0-linux,##################################################################################################
v1.8.0-linux,open speakers so we can hear what it is processing...
v1.8.0-linux,teleport the drone + 10 meters in x-direction
v1.8.0-linux,teleport the drone back
v1.8.0-linux,This example shows how to use the External Physics Engine
v1.8.0-linux,It allows you to control the drone through setVehiclePose and obtain collision information.
v1.8.0-linux,It is especially useful for injecting your own flight dynamics model to the AirSim drone.
v1.8.0-linux,Use Blocks environment to see the drone colliding and seeing the collision information
v1.8.0-linux,in the command prompt.
v1.8.0-linux,Add this line to your settings.json before running AirSim:
v1.8.0-linux,"""PhysicsEngineName"":""ExternalPhysicsEngine"""
v1.8.0-linux,use open cv to create point cloud from depth image.
v1.8.0-linux,###########################################
v1.8.0-linux,######### This is work in progress! #######
v1.8.0-linux,###########################################
v1.8.0-linux,file will be saved in PythonClient folder (i.e. same folder as script)
v1.8.0-linux,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.8.0-linux,skip it
v1.8.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.8.0-linux,z of -7 is 7 meters above the original launch point.
v1.8.0-linux,Fly given velocity vector for 5 seconds
v1.8.0-linux,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.8.0-linux,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.8.0-linux,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.8.0-linux,Make the drone fly in a circle.
v1.8.0-linux,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.8.0-linux,check that our home position is stable
v1.8.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.8.0-linux,ramp up time
v1.8.0-linux,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.8.0-linux,compute current angle
v1.8.0-linux,compute lookahead
v1.8.0-linux,if we did the takeoff then also do the landing.
v1.8.0-linux,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.8.0-linux,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.8.0-linux,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.8.0-linux,ignore the click over from 360 back to 0
v1.8.0-linux,watch direction this diff is moving if it switches from shrinking to growing
v1.8.0-linux,then we passed the starting point.
v1.8.0-linux,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.8.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.8.0-linux,z of -5 is 5 meters above the original launch point.
v1.8.0-linux,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.8.0-linux,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.8.0-linux,drone will over-shoot so we bring it back to the start point before landing.
v1.8.0-linux,"Python client example to get Lidar data from a drone, although this script works for any AirSim-supported vehicle"
v1.8.0-linux,This script is for Lidar sensors using 'VehicleInertialFrame' as DataFrame under settings.json
v1.8.0-linux,Sample settings.json used for this script:
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,main
v1.8.0-linux,Run this script with clock speed in settings.json
v1.8.0-linux,"""ClockSpeed"": 1 then change it to 0.5"
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,with ClockSpeed = 0.5 you will see that this takes 6s (system time) and not 3s
v1.8.0-linux,with ClockSpeed = 0.5 you will see that this takes 10s (system time)
v1.8.0-linux,and not 5s in each iteration
v1.8.0-linux,that's enough fun for now. let's quit cleanly
v1.8.0-linux,Takeoff or hover
v1.8.0-linux,Set wind to 0
v1.8.0-linux,Takeoff or hover
v1.8.0-linux,In settings.json first activate computer vision mode:
v1.8.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.8.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.8.0-linux,pip install opencv-python
v1.8.0-linux,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.8.0-linux,fly for 2 minutes
v1.8.0-linux,more than 50 centimeter drift is unacceptable.
v1.8.0-linux,Python client example to get Lidar data from a drone
v1.8.0-linux,
v1.8.0-linux,Makes the drone fly and get Lidar data
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,"print(""state: %s"" % s)"
v1.8.0-linux,"print(""state: %s"" % pprint.pformat(state))"
v1.8.0-linux,"reshape array of floats to array of [X,Y,Z]"
v1.8.0-linux,TODO
v1.8.0-linux,main
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.8.0-linux,let it settle there a bit.
v1.8.0-linux,after hovering we need to re-enabled api control for next leg of the trip
v1.8.0-linux,now compute the survey path required to fill the box
v1.8.0-linux,##################################################################################################
v1.8.0-linux,
v1.8.0-linux,Project:  Embedded Learning Library (ELL)
v1.8.0-linux,File:     wav_reader.py
v1.8.0-linux,Authors:  Chris Lovett
v1.8.0-linux,
v1.8.0-linux,Requires: Python 3.x
v1.8.0-linux,
v1.8.0-linux,##################################################################################################
v1.8.0-linux,open a stream on the audio input file.
v1.8.0-linux,"assumes signed integer used in raw audio, so for example, the max for 16bit is 2^15 (32768)"
v1.8.0-linux,convert int16 data to scaled floats
v1.8.0-linux,configure output stream to match what we are resampling to...
v1.8.0-linux,convert the audio to the desired recording rate
v1.8.0-linux,split into separate channels
v1.8.0-linux,drop the channels we don't want
v1.8.0-linux,zip the resulting channels back up.
v1.8.0-linux,convert back to packed bytes in PCM 16 format
v1.8.0-linux,"deal with any accumulation of tails, if the tail grows to a full"
v1.8.0-linux,buffer then return it!
v1.8.0-linux,"we have a tail from previous frame, so prepend it"
v1.8.0-linux,"now the caller needs us to stick to our sample_size contract, but when"
v1.8.0-linux,rate conversion happens we can't be sure that 'data' is exactly that size.
v1.8.0-linux,usually one byte extra so add this to our accumulating tail
v1.8.0-linux,"might have reached the end of a file, so pad with zeros."
v1.8.0-linux,"Please add ""EnableTrace"": true to your setting.json as shown below"
v1.8.0-linux,{
v1.8.0-linux,"""SettingsVersion"": 1.2,"
v1.8.0-linux,"""SimMode"": ""Multirotor"","
v1.8.0-linux,"""Vehicles"": {"
v1.8.0-linux,"""Drone"": {"
v1.8.0-linux,"""VehicleType"": ""SimpleFlight"","
v1.8.0-linux,"""EnableTrace"": true"
v1.8.0-linux,}
v1.8.0-linux,}
v1.8.0-linux,}
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,add new vehicle
v1.8.0-linux,Use below in settings.json with Blocks environment
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,get camera images from the car
v1.8.0-linux,that's enough fun for now. let's quit cleanly
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,Import this module to automatically setup path to local airsim module
v1.8.0-linux,This module first tries to see if airsim module is installed via pip
v1.8.0-linux,If it does then we don't do anything else
v1.8.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.8.0-linux,and if it does then we add that in sys.path
v1.8.0-linux,this class simply tries to see if airsim
v1.8.0-linux,if airsim module is installed then don't do anything else
v1.8.0-linux,import pkgutil
v1.8.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.8.0-linux,if airsim_loader is not None:
v1.8.0-linux,return
v1.8.0-linux,"this script moves the drone to a location, then rests it thousands of time"
v1.8.0-linux,purpose of this script is to stress test reset API
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,that's enough fun for now. let's quite cleanly
v1.8.0-linux,For high speed ascent and descent on PX4 you may need to set these properties:
v1.8.0-linux,param set MPC_Z_VEL_MAX_UP 5
v1.8.0-linux,param set MPC_Z_VEL_MAX_DN 5
v1.8.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.8.0-linux,z of -50 is 50 meters above the original launch point.
v1.8.0-linux,use open cv to show new images from AirSim
v1.8.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.8.0-linux,pip install opencv-python
v1.8.0-linux,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.8.0-linux,get depth image
v1.8.0-linux,"this will return png width= 256, height= 144"
v1.8.0-linux,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.8.0-linux,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.8.0-linux,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.8.0-linux,to get an estimate of distance.
v1.8.0-linux,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.8.0-linux,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.8.0-linux,an angular delta of the following pi/10.
v1.8.0-linux,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.8.0-linux,Remove alpha channel if exists
v1.8.0-linux,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.8.0-linux,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.8.0-linux,Flatten and yield as tuple
v1.8.0-linux,Initialize a resizable dataset to hold the output
v1.8.0-linux,Resize the dataset to accommodate the next chunk of rows
v1.8.0-linux,Create the next chunk
v1.8.0-linux,Increment the row count
v1.8.0-linux,Arguments
v1.8.0-linux,Returns
v1.8.0-linux,use composition of homographies
v1.8.0-linux,to generate final transform that needs to be applied
v1.8.0-linux,Arguments
v1.8.0-linux,Returns
v1.8.0-linux,Keeps under lock only the mechanism which advances
v1.8.0-linux,the indexing of each batch.
v1.8.0-linux,The transformation of images is not under thread lock
v1.8.0-linux,so it can be done in parallel
v1.8.0-linux,Trained model path
v1.8.0-linux,Connect to AirSim
v1.8.0-linux,Start driving
v1.8.0-linux,Initialize image buffer
v1.8.0-linux,Update throttle value according to steering angle
v1.8.0-linux,Prediction
v1.8.0-linux,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.8.0-linux,Print progress
v1.8.0-linux,Update next car state
v1.8.0-linux,Wait a bit between iterations
v1.8.0-linux,%matplotlib inline
v1.8.0-linux,chunk size for training batches
v1.8.0-linux,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.8.0-linux,Point this to the directory containing the raw data
v1.8.0-linux,Point this to the desired output directory for the cooked (.h5) data
v1.8.0-linux,Choose The folders to search for data under RAW_DATA_DIR
v1.8.0-linux,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.8.0-linux,data_folder.append('folder_name1')
v1.8.0-linux,data_folder.append('folder_name2')
v1.8.0-linux,...
v1.8.0-linux,Hyper-parameters
v1.8.0-linux,Activation functions
v1.8.0-linux,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.8.0-linux,<< The directory containing the cooked data from the previous step >>
v1.8.0-linux,<< The directory in which the model output will be placed >>
v1.8.0-linux,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.8.0-linux,Network definition
v1.8.0-linux,Import this module to automatically setup path to local airsim module
v1.8.0-linux,This module first tries to see if airsim module is installed via pip
v1.8.0-linux,If it does then we don't do anything else
v1.8.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.8.0-linux,and if it does then we add that in sys.path
v1.8.0-linux,this class simply tries to see if airsim
v1.8.0-linux,if airsim module is installed then don't do anything else
v1.8.0-linux,import pkgutil
v1.8.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.8.0-linux,if airsim_loader is not None:
v1.8.0-linux,return
v1.8.0-linux,DEY: I don't know why this was there.
v1.8.0-linux,----------------------------------- Common vehicle APIs ---------------------------------------------
v1.8.0-linux,basic flight control
v1.8.0-linux,time-of-day control
v1.8.0-linux,time - of - day control
v1.8.0-linux,weather
v1.8.0-linux,camera control
v1.8.0-linux,simGetImage returns compressed png in array of bytes
v1.8.0-linux,image_type uses one of the ImageType members
v1.8.0-linux,"todo : in future remove below, it's only for compatibility to pre v1.2"
v1.8.0-linux,"because this method returns std::vector < uint8>, msgpack decides to encode it as a string unfortunately."
v1.8.0-linux,camera control
v1.8.0-linux,simGetImage returns compressed png in array of bytes
v1.8.0-linux,image_type uses one of the ImageType members
v1.8.0-linux,CinemAirSim
v1.8.0-linux,End CinemAirSim
v1.8.0-linux,gets the static meshes in the unreal scene
v1.8.0-linux,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.8.0-linux,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.8.0-linux,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.8.0-linux,sensor APIs
v1.8.0-linux,Plotting APIs
v1.8.0-linux,Recording APIs
v1.8.0-linux,Add new vehicle via RPC
v1.8.0-linux,----------------------------------- Multirotor APIs ---------------------------------------------
v1.8.0-linux,APIs for control
v1.8.0-linux,low - level control API
v1.8.0-linux,query vehicle state
v1.8.0-linux,query rotor states
v1.8.0-linux,----------------------------------- Car APIs ---------------------------------------------
v1.8.0-linux,helper method for converting getOrientation to roll/pitch/yaw
v1.8.0-linux,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.8.0-linux,roll (x-axis rotation)
v1.8.0-linux,pitch (y-axis rotation)
v1.8.0-linux,yaw (z-axis rotation)
v1.8.0-linux,DEY: I don't know why this was there.
v1.8.0-linux,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.8.0-linux,return cls(**msgpack.unpack(encoded))
v1.8.0-linux,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.8.0-linux,Create a DummyVecEnv for main airsim gym env
v1.8.0-linux,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.8.0-linux,Initialize RL algorithm type and parameters
v1.8.0-linux,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.8.0-linux,Train for a certain number of timesteps
v1.8.0-linux,Save policy weights
v1.8.0-linux,Create a DummyVecEnv for main airsim gym env
v1.8.0-linux,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.8.0-linux,Initialize RL algorithm type and parameters
v1.8.0-linux,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.8.0-linux,Train for a certain number of timesteps
v1.8.0-linux,Save policy weights
v1.8.0-linux,Import this module to automatically setup path to local airsim module
v1.8.0-linux,This module first tries to see if airsim module is installed via pip
v1.8.0-linux,If it does then we don't do anything else
v1.8.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.8.0-linux,and if it does then we add that in sys.path
v1.8.0-linux,this class simply tries to see if airsim
v1.8.0-linux,if airsim module is installed then don't do anything else
v1.8.0-linux,import pkgutil
v1.8.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.8.0-linux,if airsim_loader is not None:
v1.8.0-linux,return
v1.8.0-linux,Set home position and velocity
v1.8.0-linux,print(dist)
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,"This is a bit crude, but give it a moment to settle on the ground, else takeoff will fail"
v1.8.0-linux,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.8.0-linux,switch to explicit hover mode so that this is the fallback when
v1.8.0-linux,move* commands are finished.
v1.8.0-linux,"Altitude difference between each platform, in meters"
v1.8.0-linux,"Count down, so the first one can easily go the highest (without knowing count)"
v1.8.0-linux,"in header only mode, control library is not available"
v1.8.0-linux,if using Unreal Build system then include precompiled header file first
v1.8.0-linux,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.8.0-linux,"Windows, OSX and Linux."
v1.8.0-linux,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.8.0-linux,Windows users can move the Documents folder to any location they want
v1.8.0-linux,SHGetFolderPath knows how to find it.
v1.8.0-linux,fall back in case SHGetFolderPath failed for some reason.
v1.8.0-linux,convert from std::path '/' to windows backslash.
v1.8.0-linux,make the current thread run with maximum priority.
v1.8.0-linux,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.8.0-linux,TODO: How to handle POSIX thread priorities on OSX?
v1.8.0-linux,setThreadName is a helper function that is useful when debugging because your threads
v1.8.0-linux,show up in the debugger with the name you set which makes it easier to find the threads
v1.8.0-linux,that you are interested in.
v1.8.0-linux,"unfortunately this is only available on Windows 10, and AirSim is not limited to that."
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.8.0-linux,
v1.8.0-linux,Treat all errors as failure conditions.
v1.8.0-linux,parse command line
v1.8.0-linux,"motive gives a weird error if the project is not found, so we look for it."
v1.8.0-linux,Do an update to pick up any recently-arrived cameras.
v1.8.0-linux,List all detected cameras.
v1.8.0-linux,List all defined rigid bodies.
v1.8.0-linux,throttle to 50 messages per second.
v1.8.0-linux,OptiTrack uses 'y' axis for vertical.
v1.8.0-linux,stdafx.cpp : source file that includes just the standard includes
v1.8.0-linux,MavlinkMoCap.pch will be the pre-compiled header
v1.8.0-linux,stdafx.obj will contain the pre-compiled type information
v1.8.0-linux,TODO: reference any additional headers you need in STDAFX.H
v1.8.0-linux,and not in this file
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,PX4.cpp : Defines the entry point for the console application.
v1.8.0-linux,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.8.0-linux,how do you write to the debug output windows on Unix ?
v1.8.0-linux,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.8.0-linux,connection to create to talke to that server.
v1.8.0-linux,SITL setup info
v1.8.0-linux,The local ethernet interface to use (default localhost).
v1.8.0-linux,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.8.0-linux,server mode on UDP is when you want another app to connect to Pixhawk and publish data back to this process.
v1.8.0-linux,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.8.0-linux,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.8.0-linux,"using their the -qgc option.  Server mode on TCP means mavlinktest will do an ""accept"" socket which is"
v1.8.0-linux,what PX4 is waiting for when it is running in TCP mode.  Here the serverEndPoint is different from the
v1.8.0-linux,offboardEndPoint.  The serverEndPoint specifies which local address to use in case your computer has
v1.8.0-linux,multiple network interfaces.
v1.8.0-linux,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.8.0-linux,this switch controls whether we turn off the RC remote active link loss detection
v1.8.0-linux,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.8.0-linux,from kicking in when you try and fly.
v1.8.0-linux,parse the json
v1.8.0-linux,flatten inner mavlink object
v1.8.0-linux,flatten inner mavlink object
v1.8.0-linux,todo
v1.8.0-linux,todo
v1.8.0-linux,"const char* outLogFileOption = ""outlogfile"";"
v1.8.0-linux,parse command line
v1.8.0-linux,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.8.0-linux,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.8.0-linux,"no local serial connection, so this is the primary droneConnection."
v1.8.0-linux,need a retry loop here because we don't know how quickly px4 will start accepting these connections...
v1.8.0-linux,failed to connect
v1.8.0-linux,"then we need 2 mavlink channels, one for sending/receiving HIL_* messages and the other"
v1.8.0-linux,for controlling the drone.
v1.8.0-linux,this is the control channel.
v1.8.0-linux,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.8.0-linux,cmdTable.push_back(new AltHoldCommand());
v1.8.0-linux,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.8.0-linux,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.8.0-linux,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.8.0-linux,this stops us from being able to connect to SITL mode PX4.
v1.8.0-linux,checkPulse();
v1.8.0-linux,add command text in log
v1.8.0-linux,close previous command.
v1.8.0-linux,FilterLogFiles(logDirectory);
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,send a heartbeat
v1.8.0-linux,accept one incoming connection
v1.8.0-linux,send a heartbeat to the client
v1.8.0-linux,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.8.0-linux,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.8.0-linux,for this unit test we are expecting a request to send an image.
v1.8.0-linux,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.8.0-linux,hmmm
v1.8.0-linux,================ ls
v1.8.0-linux,================ put file
v1.8.0-linux,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.8.0-linux,================ get file
v1.8.0-linux,verify the file contents.
v1.8.0-linux,================ remove file
v1.8.0-linux,================ make directory
v1.8.0-linux,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.8.0-linux,================ remove directory
v1.8.0-linux,Now verification
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,you must call this method if you want HandleMessage to be called subsequently.
v1.8.0-linux,treat literals as one word
v1.8.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.8.0-linux,request gps info
v1.8.0-linux,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.8.0-linux,find relative position since command start so we can compare two commands better
v1.8.0-linux,"these PID values are important, so set these to match"
v1.8.0-linux,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.8.0-linux,we can skip ahead.
v1.8.0-linux,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.8.0-linux,TODO: avoid passing hadcoded HIL flag
v1.8.0-linux,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.8.0-linux,"The global position, as returned by the Global Positioning System (GPS)."
v1.8.0-linux,Provides state for additional features
v1.8.0-linux,The general system state
v1.8.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.8.0-linux,Provides state for additional features
v1.8.0-linux,The general system state
v1.8.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.8.0-linux,Provides state for additional features
v1.8.0-linux,The general system state
v1.8.0-linux,Provides state for additional features
v1.8.0-linux,The general system state
v1.8.0-linux,note: we do not reset com when Close() is called because we want to keep running.
v1.8.0-linux,"user has to invoke ""hil stop"" to stop the hil thread."
v1.8.0-linux,generate random between 0 and 1
v1.8.0-linux,move to range -1 to 1
v1.8.0-linux,scale it
v1.8.0-linux,apply iy
v1.8.0-linux,wait for the Execute method to be called.
v1.8.0-linux,gps is much slower frequency than IMU.
v1.8.0-linux,MAVLINK_MSG_ID_HIL_GPS
v1.8.0-linux,disable MAV_USEHILGPS
v1.8.0-linux,note: we do not reset com when Close() is called because we want to keep running.
v1.8.0-linux,"user has to invoke ""hil stop"" to stop the hil thread."
v1.8.0-linux,generate random between 0 and 1
v1.8.0-linux,move to range -1 to 1
v1.8.0-linux,scale it
v1.8.0-linux,apply iy
v1.8.0-linux,wait for the Execute method to be called.
v1.8.0-linux,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.8.0-linux,gps is much slower frequency than IMU.
v1.8.0-linux,MAVLINK_MSG_ID_HIL_GPS
v1.8.0-linux,disable HIL mode
v1.8.0-linux,Enumeration of landed detector states
v1.8.0-linux,MAV landed state is unknown
v1.8.0-linux,MAV is landed (on ground)
v1.8.0-linux,MAV is in air
v1.8.0-linux,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.8.0-linux,The filtered local position
v1.8.0-linux,must send these regularly to keep offboard control.
v1.8.0-linux,"ok, now we can safely switch to loiter."
v1.8.0-linux,must send these regularly to keep offboard control.
v1.8.0-linux,integrate the heading so it is smoother.
v1.8.0-linux,must send these regularly to keep offboard control.
v1.8.0-linux,integrate the heading so it is smoother.
v1.8.0-linux,fly to radius
v1.8.0-linux,it takes about 10 cm to stop and turn.
v1.8.0-linux,next time around switch to orbiting!
v1.8.0-linux,heading points to center of circle.
v1.8.0-linux,interpoloate the speed ramp up time over 2 seconds from start time
v1.8.0-linux,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.8.0-linux,monitor the sin curves so we can see how on track or off track it actually is.
v1.8.0-linux,the shape of the curve will also tell us if we are progressing at a consistent
v1.8.0-linux,"speed, the more deformed the sin curve the worse our progress."
v1.8.0-linux,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.8.0-linux,degrees just flipped from 359 to 0.
v1.8.0-linux,this enables us to test what happens when offboard control is lost and resumed.
v1.8.0-linux,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.8.0-linux,"ok, now we can start moving by velocity"
v1.8.0-linux,recompute to new target.
v1.8.0-linux,start by moving right with 10 degree roll.
v1.8.0-linux,haven't started yet.
v1.8.0-linux,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.8.0-linux,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.8.0-linux,track how our actual pitch is coming along compared to our target
v1.8.0-linux,and check position
v1.8.0-linux,the amount of pitch should depend on our speed in that direction.
v1.8.0-linux,passed the midpoint.
v1.8.0-linux,fade out the pitch as we pick up speed so we don't overshoot.
v1.8.0-linux,see if we just crossed the wiggle distance threshold.
v1.8.0-linux,(pitch affects the x-position).
v1.8.0-linux,reverse direction with a -30 degrees quick stop
v1.8.0-linux,reverse direction with a 30 degrees quick stop
v1.8.0-linux,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.8.0-linux,too much in that direction.
v1.8.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.8.0-linux,track how our actual roll is coming along compared to our target
v1.8.0-linux,and check position
v1.8.0-linux,the amount of roll should depend on our speed in that direction.
v1.8.0-linux,passed the midpoint.
v1.8.0-linux,fade out the roll as we pick up speed so we don't overshoot.
v1.8.0-linux,see if we just crossed the wiggle distance threshold.
v1.8.0-linux,(roll affects the y-position).
v1.8.0-linux,reverse direction with a -30 degrees quick stop
v1.8.0-linux,reverse direction with a 30 degrees quick stop
v1.8.0-linux,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.8.0-linux,too much in that direction.
v1.8.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.8.0-linux,for testing PID controller.
v1.8.0-linux,class AltHoldCommand : public Command
v1.8.0-linux,{
v1.8.0-linux,std::shared_ptr<MavLinkVehicle> channel;
v1.8.0-linux,"float sx_, sy_, sz_;"
v1.8.0-linux,MavLinkAttitudeTarget _current;
v1.8.0-linux,PidController thrust_controller_;
v1.8.0-linux,public:
v1.8.0-linux,this->sz_ = pos.z; // user defined target.
v1.8.0-linux,move to local position keeps the offboard control happy.
v1.8.0-linux,haven't started yet.
v1.8.0-linux,and check position
v1.8.0-linux,double dx = this->sx_ - pos.x;
v1.8.0-linux,double dy = this->sy_ - pos.y;
v1.8.0-linux,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.8.0-linux,too much in that direction.
v1.8.0-linux,adjust thrust so we keep steady height target
v1.8.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.8.0-linux,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.8.0-linux,local remote
v1.8.0-linux,already handled by the parse method.
v1.8.0-linux,we only support very simple patterns for now.
v1.8.0-linux,each wildcard must be separated by literal.
v1.8.0-linux,back to back wildcards with no literal in between is too complex.
v1.8.0-linux,"we only support simple matching for now, we can add full regex later if we need it."
v1.8.0-linux,yep!
v1.8.0-linux,'*' is done we found the next matching char
v1.8.0-linux,this is ok.
v1.8.0-linux,this is an ERASE_END_LINE command which we ignore.
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,pack the payload buffer.
v1.8.0-linux,calculate checksum
v1.8.0-linux,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.8.0-linux,are variable length as a result.
v1.8.0-linux,form the header as a byte array for the crc
v1.8.0-linux,unpack the message...
v1.8.0-linux,pack the payload buffer.
v1.8.0-linux,"json can't handle ""nan"", so we convert it to null."
v1.8.0-linux,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.8.0-linux,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,start listening to this connection
v1.8.0-linux,Send heartbeat to drone.  You should not do this if some other node is
v1.8.0-linux,already doing it.
v1.8.0-linux,stop listening to the connection.
v1.8.0-linux,get the connection
v1.8.0-linux,Get the local system and component id
v1.8.0-linux,send a command to the remote node
v1.8.0-linux,MavLinkNode::MavLinkNode() = default;
v1.8.0-linux,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.8.0-linux,decrementing the count so the next WaitOne may block.
v1.8.0-linux,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.8.0-linux,convert to absolute time.
v1.8.0-linux,use mach_timespec
v1.8.0-linux,convert to absolute time.
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,return true if we still have offboard control (can lose this if user flips the switch).
v1.8.0-linux,MavLinkVehicle::MavLinkVehicle() = default;
v1.8.0-linux,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.8.0-linux,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,============================== CLIENT ============================================
v1.8.0-linux,image APIs
v1.8.0-linux,or if you are implementing the client side call this function to get the most recent frame.
v1.8.0-linux,returns false if there is no new frame available.
v1.8.0-linux,============================== SERVER ============================================
v1.8.0-linux,call this to send the image back over the connection given to start function.
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,"log every message that is ""sent"" using sendMessage."
v1.8.0-linux,"log every message that is ""received"""
v1.8.0-linux,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.8.0-linux,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.8.0-linux,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.8.0-linux,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,for compatibility with QGroundControl we have to save the time field in big endian.
v1.8.0-linux,todo: mavlink2 support?
v1.8.0-linux,has to be one or the other!
v1.8.0-linux,24 bits.
v1.8.0-linux,24 bits.
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,start listening to this connection
v1.8.0-linux,Send heartbeat to drone.  You should not do this if some other node is
v1.8.0-linux,already doing it.
v1.8.0-linux,this is called for all messages received on the connection.
v1.8.0-linux,"we received a heartbeat, so let's get the capabilities."
v1.8.0-linux,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.8.0-linux,subclasses remembering to call this base implementation.
v1.8.0-linux,stop listening to the connection.
v1.8.0-linux,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.8.0-linux,wait for a heartbeat msg since this will give us the port to send commands to...
v1.8.0-linux,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.8.0-linux,send a heart beat so that the remote node knows we are still alive
v1.8.0-linux,(otherwise drone will trigger a failsafe operation).
v1.8.0-linux,ignore any failures here because we are running in our own thread here.
v1.8.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.8.0-linux,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.8.0-linux,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.8.0-linux,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.8.0-linux,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.8.0-linux,"ok, now fetch the missing parameters."
v1.8.0-linux,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.8.0-linux,silently fail since we are on a background thread here...
v1.8.0-linux,tell the caller this is complete.
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,add our custom telemetry message length.
v1.8.0-linux,todo: if we support signing then initialize
v1.8.0-linux,mavlink_intermediate_status_.signing callbacks
v1.8.0-linux,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.8.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.8.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.8.0-linux,send this right away just in case serial link is not already configured
v1.8.0-linux,"log every message that is ""sent"" using sendMessage."
v1.8.0-linux,"log every message that is ""sent"" using sendMessage."
v1.8.0-linux,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.8.0-linux,pack the payload buffer.
v1.8.0-linux,calculate checksum
v1.8.0-linux,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.8.0-linux,are variable length as a result.
v1.8.0-linux,form the header as a byte array for the crc
v1.8.0-linux,these macros use old style cast.
v1.8.0-linux,forward messages from our connected node to the remote proxy.
v1.8.0-linux,tell the remote connection to expect mavlink2 messages.
v1.8.0-linux,forward messages from remote proxy to local connected node
v1.8.0-linux,CurrentThread::setMaximumPriority();
v1.8.0-linux,"hmmm, wait till it is opened?"
v1.8.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.8.0-linux,pick up the sysid/compid of the remote node we are connected to.
v1.8.0-linux,then this is a mavlink 1 message
v1.8.0-linux,then this mavlink sender supports mavlink 2
v1.8.0-linux,queue event for publishing.
v1.8.0-linux,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.8.0-linux,as it ensures we don't lose messages if the listener is slow.
v1.8.0-linux,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.8.0-linux,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.8.0-linux,we would get a deadlock.
v1.8.0-linux,CurrentThread::setMaximumPriority();
v1.8.0-linux,reset counters
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,------------------------------------------------------------------------------
v1.8.0-linux,Defines
v1.8.0-linux,------------------------------------------------------------------------------
v1.8.0-linux,bit number  876543210987654321
v1.8.0-linux,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.8.0-linux,in future it would be good to have ability to add system IDs we are interested in
v1.8.0-linux,if (msg.sysid != getTargetSystemId())
v1.8.0-linux,{
v1.8.0-linux,// we only care about messages from our intended remote node.
v1.8.0-linux,return;
v1.8.0-linux,}
v1.8.0-linux,user may have changed modes on us! So we need to honor that and not
v1.8.0-linux,try and take it back.
v1.8.0-linux,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.8.0-linux,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.8.0-linux,we can store up to 16 channels in rc_channels_scaled.
v1.8.0-linux,The RAW values of the servo outputs
v1.8.0-linux,Metrics typically displayed on a HUD for fixed wing aircraft
v1.8.0-linux,The IMU readings in SI units in NED body frame
v1.8.0-linux,printSystemStatus(&msg);
v1.8.0-linux,todo: use this to determine when we need to do emergency landing...
v1.8.0-linux,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.8.0-linux,Provides state for additional features
v1.8.0-linux,The general system state
v1.8.0-linux,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.8.0-linux,but we do want to know when we get the ack.  So this is async ACK processing!
v1.8.0-linux,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.8.0-linux,if threshold < 0 then the threshold is inverted.
v1.8.0-linux,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.8.0-linux,Convert it to a floating point number between -1 and 1.
v1.8.0-linux,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.8.0-linux,until the move commands start happening.
v1.8.0-linux,return true if user calls requestControl and has not called releaseControl.
v1.8.0-linux,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.8.0-linux,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.8.0-linux,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.8.0-linux,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.8.0-linux,send a few to make sure it gets through...
v1.8.0-linux,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.8.0-linux,us by which time the PX4 times out offboard mode!!
v1.8.0-linux,"assume this was successful, we'll find out if so in the next heartbeat."
v1.8.0-linux,this mode change take precedence over offboard mode.
v1.8.0-linux,thrust must be between -1 and 1.
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,These definitions are copied from PX4 implementation
v1.8.0-linux,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.8.0-linux,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.8.0-linux,/ @brief Command opcodes
v1.8.0-linux,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.8.0-linux,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.8.0-linux,must trim trailing slashes so PX4 doesn't hang!
v1.8.0-linux,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.8.0-linux,from the source.
v1.8.0-linux,check if directory exists.
v1.8.0-linux,perfect.
v1.8.0-linux,use last_message_ so we preserve the sessionid.
v1.8.0-linux,"could not create the local file, so stop."
v1.8.0-linux,must use last_message_ so we preserve the session id.
v1.8.0-linux,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.8.0-linux,todo: error handling here? sequence is out of order...
v1.8.0-linux,"directory must be empty then, can't do nextStep because"
v1.8.0-linux,it will just loop for ever re-requesting zero offset into
v1.8.0-linux,empty directory.
v1.8.0-linux,result should be a list of null terminated file names.
v1.8.0-linux,skipping this entry
v1.8.0-linux,remove the file size field.
v1.8.0-linux,"printf(""%s\n"", name.c_str());"
v1.8.0-linux,request the next batch.
v1.8.0-linux,"perhaps this was a late response after we did a retry, so ignore it."
v1.8.0-linux,"perhaps this was a late response after we did a retry, so ignore it."
v1.8.0-linux,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.8.0-linux,reached the end of the list or the file.
v1.8.0-linux,end of file or directory listing.
v1.8.0-linux,"success, data should be following..."
v1.8.0-linux,ack on this cmd is a noop
v1.8.0-linux,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.8.0-linux,give up then.
v1.8.0-linux,tell watchdog we are sending a request
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,================================= CLIENT ==============================================================
v1.8.0-linux,Check if we have a valid transaction
v1.8.0-linux,emit signal if all packets arrived
v1.8.0-linux,Restart statemachine
v1.8.0-linux,image APIs
v1.8.0-linux,================================= SERVER ==============================================================
v1.8.0-linux,Prepare and send acknowledgment packet
v1.8.0-linux,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.8.0-linux,Send ENCAPSULATED_IMAGE packet
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.8.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.8.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.8.0-linux,send this right away just in case serial link is not already configured
v1.8.0-linux,CurrentThread::setMaximumPriority();
v1.8.0-linux,"hmmm, wait till it is opened?"
v1.8.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.8.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.8.0-linux,queue event for publishing.
v1.8.0-linux,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.8.0-linux,as it ensures we don't lose messages if the listener is slow.
v1.8.0-linux,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.8.0-linux,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.8.0-linux,we would get a deadlock.
v1.8.0-linux,CurrentThread::setMaximumPriority();
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.8.0-linux,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.8.0-linux,parse out the VID number
v1.8.0-linux,now the PID
v1.8.0-linux,parse out the VID number
v1.8.0-linux,examples:
v1.8.0-linux,PX4: USB\VID_26AC&PID_0011\0
v1.8.0-linux,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.8.0-linux,"printf(""Found: %S\n"", buffer.c_str());"
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.8.0-linux,parse out the VID number
v1.8.0-linux,now the PID
v1.8.0-linux,parse out the VID number
v1.8.0-linux,suppress
v1.8.0-linux,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,This has not been properly tested
v1.8.0-linux,struct iw_statistics stats;
v1.8.0-linux,struct iwreq req;
v1.8.0-linux,"memset(&stats, 0, sizeof(stats));"
v1.8.0-linux,"memset(&req, 0, sizeof(iwreq));"
v1.8.0-linux,
v1.8.0-linux,"strncpy(req.ifr_name, ifaceName, 16);"
v1.8.0-linux,req.u.data.pointer = &stats;
v1.8.0-linux,req.u.data.length = sizeof(iw_statistics);
v1.8.0-linux,
v1.8.0-linux,#ifdef CLEAR_UPDATED
v1.8.0-linux,req.u.data.flags = 1;
v1.8.0-linux,#endif
v1.8.0-linux,
v1.8.0-linux,/* Perform the ioctl */
v1.8.0-linux,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.8.0-linux,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.8.0-linux,return -127;
v1.8.0-linux,}
v1.8.0-linux,
v1.8.0-linux,return stats.qual.level;
v1.8.0-linux,todo: windows version of this...
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,windows
v1.8.0-linux,Need to link with Ws2_32.lib
v1.8.0-linux,posix
v1.8.0-linux,found it!
v1.8.0-linux,This timeout is important as it allows the MavLinkConnection readPackets
v1.8.0-linux,thread to iterate and notice the connection is now closed. This allows
v1.8.0-linux,AirSim to shutdown properly when drone is not connected.
v1.8.0-linux,bind socket to local address.
v1.8.0-linux,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.8.0-linux,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.8.0-linux,try and reconnect
v1.8.0-linux,write to the serial port
v1.8.0-linux,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.8.0-linux,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.8.0-linux,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.8.0-linux,"try and receive something, up until port is closed anyway."
v1.8.0-linux,"message was too large for the buffer, no problem, return what we have."
v1.8.0-linux,try again - this can happen if server recreates the socket on their side.
v1.8.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.8.0-linux,"skip this, the receive just timed out, no problem, we'll try again later."
v1.8.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.8.0-linux,"printf(""#### recv failed with error: %d\n"", hr);"
v1.8.0-linux,we now have it.
v1.8.0-linux,this is from someone we are not interested in.
v1.8.0-linux,-----------------------------------------------------------------------------------------
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,Initialize Winsock
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,windows
v1.8.0-linux,Need to link with Ws2_32.lib
v1.8.0-linux,posix
v1.8.0-linux,found it!
v1.8.0-linux,bind socket to local address.
v1.8.0-linux,bind socket to local address.
v1.8.0-linux,start listening for incoming connection
v1.8.0-linux,accept 1
v1.8.0-linux,"don't need to accept any more, so we can close this one."
v1.8.0-linux,write to the serial port
v1.8.0-linux,"try and receive something, up until port is closed anyway."
v1.8.0-linux,"message was too large for the buffer, no problem, return what we have."
v1.8.0-linux,try again - this can happen if server recreates the socket on their side.
v1.8.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.8.0-linux,try again - this can happen if server recreates the socket on their side.
v1.8.0-linux,-----------------------------------------------------------------------------------------
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.8.0-linux,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.8.0-linux,set signal
v1.8.0-linux,Clear Handshake flags
v1.8.0-linux,Set Handshake flags
v1.8.0-linux,return GetLastError();
v1.8.0-linux,return GetLastError();
v1.8.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.8.0-linux,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.8.0-linux,enable reading
v1.8.0-linux,posix doesn't have mark/space parity.
v1.8.0-linux,posix doesn't have mark/space parity.
v1.8.0-linux,this is the default.
v1.8.0-linux,not sure this is supported...
v1.8.0-linux,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.8.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.8.0-linux,First do those specified by POSIX.
v1.8.0-linux,Now conditionally handle a bunch of extended rates.
v1.8.0-linux,First do those specified by POSIX.
v1.8.0-linux,Now conditionally handle a bunch of extended rates.
v1.8.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.8.0-linux,import airsim
v1.8.0-linux,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v1.8.0-linux,self.args = args
v1.8.0-linux,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v1.8.0-linux,pdb.set_trace()
v1.8.0-linux,#include <pluginlib/class_list_macros.h>
v1.8.0-linux,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v1.8.0-linux,todo do not reset if already in air?
v1.8.0-linux,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.8.0-linux,ros params
v1.8.0-linux,todo enforce dynamics constraints in this node as well?
v1.8.0-linux,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v1.8.0-linux,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v1.8.0-linux,XmlRpc::XmlRpcValue can't be const in this case
v1.8.0-linux,subscribe to control commands on global nodehandle
v1.8.0-linux,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.8.0-linux,bind to a single callback. todo optimal subs queue length
v1.8.0-linux,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.8.0-linux,TODO: ros::TransportHints().tcpNoDelay();
v1.8.0-linux,"vehicle_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.8.0-linux,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.8.0-linux,camera_setting.gimbal
v1.8.0-linux,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.8.0-linux,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.8.0-linux,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.8.0-linux,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.8.0-linux,"if {DepthPlanar, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.8.0-linux,"push back pair (vector of image captures, current vehicle name)"
v1.8.0-linux,iterate over sensors
v1.8.0-linux,"we want fast access to the lidar sensors for callback handling, sort them out now"
v1.8.0-linux,add takeoff and land all services if more than 2 drones
v1.8.0-linux,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v1.8.0-linux,todo add per vehicle reset in AirLib API
v1.8.0-linux,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.8.0-linux,lidars update on their own callback/thread at a given rate
v1.8.0-linux,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v1.8.0-linux,"todo: error check. if state is not landed, return error."
v1.8.0-linux,todo add reset by vehicle_name API to airlib
v1.8.0-linux,todo not async remove waitonlasttask
v1.8.0-linux,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v1.8.0-linux,todo do actual body frame?
v1.8.0-linux,airsim uses degrees
v1.8.0-linux,todo do actual body frame?
v1.8.0-linux,airsim uses degrees
v1.8.0-linux,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v1.8.0-linux,todo expose waitOnLastTask or nah?
v1.8.0-linux,todo do actual body frame?
v1.8.0-linux,airsim uses degrees
v1.8.0-linux,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.8.0-linux,todo expose waitOnLastTask or nah?
v1.8.0-linux,todo support multiple gimbal commands
v1.8.0-linux,todo support multiple gimbal commands
v1.8.0-linux,1. find quaternion of default gimbal pose
v1.8.0-linux,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.8.0-linux,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.8.0-linux,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.8.0-linux,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.8.0-linux,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.8.0-linux,msg = []
v1.8.0-linux,todo covariances
v1.8.0-linux,gps_msg.position_covariance_type =
v1.8.0-linux,gps_msg.position_covariance =
v1.8.0-linux,todo covariances
v1.8.0-linux,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.8.0-linux,todo radians per second
v1.8.0-linux,meters/s2^m
v1.8.0-linux,imu_msg.orientation_covariance = ;
v1.8.0-linux,imu_msg.angular_velocity_covariance = ;
v1.8.0-linux,imu_msg.linear_acceleration_covariance = ;
v1.8.0-linux,airsim appears to use chrono::system_clock with nanosecond precision
v1.8.0-linux,todo this is global origin
v1.8.0-linux,get the basic vehicle pose and environmental state
v1.8.0-linux,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.8.0-linux,airsim_client needs to provide the simulation time in a future version of the API
v1.8.0-linux,publish the simulation clock
v1.8.0-linux,"publish vehicle state, odom, and all basic sensor types"
v1.8.0-linux,send any commands out to the vehicles
v1.8.0-linux,"should be easier way to get the sim time through API, something like:"
v1.8.0-linux,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.8.0-linux,curr_ros_time = airsim_timestamp_to_ros(env.clock().nowNanos());
v1.8.0-linux,iterate over drones
v1.8.0-linux,get drone state from airsim
v1.8.0-linux,"vehicle environment, we can get ambient temperature here and other truths"
v1.8.0-linux,convert airsim drone state to ROS msgs
v1.8.0-linux,simulation environment truth
v1.8.0-linux,"dashboard reading from car, RPM, gear, etc"
v1.8.0-linux,odom and transforms
v1.8.0-linux,ground truth GPS position from sim/HITL
v1.8.0-linux,handled via callback
v1.8.0-linux,send control commands from the last callback to airsim
v1.8.0-linux,send control commands from the last callback to airsim
v1.8.0-linux,"Only camera rotation, no translation movement of camera"
v1.8.0-linux,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.8.0-linux,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.8.0-linux,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.8.0-linux,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.8.0-linux,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.8.0-linux,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.8.0-linux,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.8.0-linux,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.8.0-linux,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.8.0-linux,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.8.0-linux,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.8.0-linux,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.8.0-linux,update timestamp of saved cam info msgs
v1.8.0-linux,DepthPlanar / DepthPerspective / DepthVis / DisparityNormalized
v1.8.0-linux,Scene / Segmentation / SurfaceNormals / Infrared
v1.8.0-linux,publish camera transforms
v1.8.0-linux,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.8.0-linux,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.8.0-linux,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.8.0-linux,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.8.0-linux,ROS params
v1.8.0-linux,ROS publishers
v1.8.0-linux,ROS subscribers
v1.8.0-linux,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.8.0-linux,ROS timers
v1.8.0-linux,todo maintain internal representation as eigen vec?
v1.8.0-linux,todo check if low velocity if within thresh?
v1.8.0-linux,todo maintain separate errors for XY and Z
v1.8.0-linux,todo save this in degrees somewhere to avoid repeated conversion
v1.8.0-linux,this tells the update timer callback to not do active hovering
v1.8.0-linux,todo maintain array of position goals
v1.8.0-linux,todo error checks
v1.8.0-linux,todo fill response
v1.8.0-linux,"Already have goal, and have reached it"
v1.8.0-linux,this tells the update timer callback to not do active hovering
v1.8.0-linux,todo error checks
v1.8.0-linux,todo fill response
v1.8.0-linux,"todo do relative altitude, or add an option for the same?"
v1.8.0-linux,convert GPS goal to NED goal
v1.8.0-linux,todo error checks
v1.8.0-linux,todo fill response
v1.8.0-linux,"Already have goal, this shouldn't happen"
v1.8.0-linux,"todo do relative altitude, or add an option for the same?"
v1.8.0-linux,convert GPS goal to NED goal
v1.8.0-linux,todo error checks
v1.8.0-linux,todo fill response
v1.8.0-linux,todo check if odometry is too old!!
v1.8.0-linux,"if no odom, don't do anything."
v1.8.0-linux,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.8.0-linux,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.8.0-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.8.0-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.8.0-linux,todo yaw limits
v1.8.0-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.8.0-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.8.0-linux,mimics void ASimHUD::initializeSettings()
v1.8.0-linux,int num_threads = 1;
v1.8.0-linux,ros::MultiThreadedSpinner multi_thread(num_threads);
v1.8.0-linux,multi_thread.spin();
v1.8.0-linux,ros::AsyncSpinner async_spinner(num_threads);
v1.8.0-linux,async_spinner.start();
v1.8.0-linux,single threaded spinner
v1.8.0-linux,!/usr/bin/env python
v1.8.0-linux,capture joystick events using ROS and convert to AirSim Car API commands
v1.8.0-linux,to enable:
v1.8.0-linux,rosrun joy joy_node
v1.8.0-linux,"Below was an earlier typo, written like this for compatibility"
v1.8.0-linux,"gearing: -1 reverse, 0 N, >= 1 drive"
v1.8.0-linux,connect to the AirSim simulator
v1.8.0-linux,","
v1.8.0-linux,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.8.0-linux,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,"in header only mode, control library is not available"
v1.8.0-linux,TODO: something defines max macro which interfears with code here
v1.8.0-linux,is cur_pos within fence?
v1.8.0-linux,destination risk is not available then consider it zero
v1.8.0-linux,if dest risk is lower than its more safe
v1.8.0-linux,are we doing better than closest obstacle?
v1.8.0-linux,"if we stay where we are, what is the risk distance?"
v1.8.0-linux,else we are better of moving to dest
v1.8.0-linux,this function should work even when dest_pos == cur_pos
v1.8.0-linux,is this dest_pos cur_pos within the fence?
v1.8.0-linux,transform dest_pos vector to body frame
v1.8.0-linux,check for approx zero vectors to avoid random yaw angles
v1.8.0-linux,we are hovering
v1.8.0-linux,"get yaw in body frame, ie, front is always 0 radians"
v1.8.0-linux,yaw to ticks
v1.8.0-linux,get obstacles in the window at the tick direction around the window
v1.8.0-linux,less risk distance is better
v1.8.0-linux,check obstacles around current position and see if it has lower risk
v1.8.0-linux,else obstacle is too far
v1.8.0-linux,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.8.0-linux,look for each surrounding tick to see if we have obstacle free angle
v1.8.0-linux,else no suggestions required
v1.8.0-linux,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.8.0-linux,evaluate right and left side of circle
v1.8.0-linux,find right and left risk distances
v1.8.0-linux,at this point we have already determined hover is better than going to dest
v1.8.0-linux,we now determine is moving to suggested angle better than hovering?
v1.8.0-linux,check if dest_pos is safe
v1.8.0-linux,breaking distance at this velocity
v1.8.0-linux,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.8.0-linux,check if dest_pos is safe
v1.8.0-linux,float/vec parameters can have NaN which makes them optional
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,"in header only mode, control library is not available"
v1.8.0-linux,handles +/- tick and wraps around circle
v1.8.0-linux,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.8.0-linux,update the specified window on the map
v1.8.0-linux,make sure from <= to
v1.8.0-linux,normalize the ticks so both are valid indices
v1.8.0-linux,if from is still larger then
v1.8.0-linux,to ticks is then added one full circle to make it larger than from_tick
v1.8.0-linux,find closest obstacle in given window
v1.8.0-linux,search whole map to find closest obstacle
v1.8.0-linux,"in header only mode, control library is not available"
v1.8.0-linux,#include <fileapi.h>
v1.8.0-linux,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.8.0-linux,"Windows, OSX and Linux."
v1.8.0-linux,Windows users can move the Documents folder to any location they want
v1.8.0-linux,SHGetFolderPath knows how to find it.
v1.8.0-linux,fall back in case SHGetFolderPath failed for some reason.
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,"in header only mode, control library is not available"
v1.8.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.0-linux,if using Unreal Build system then include precompiled header file first
v1.8.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.0-linux,this deadlocks UI thread if async_run was called while there are pending rpc calls.
v1.8.0-linux,CinemAirSim
v1.8.0-linux,end CinemAirSim
v1.8.0-linux,Exit if already resetting.
v1.8.0-linux,Reset
v1.8.0-linux,if we don't suppress then server will bomb out for exceptions raised by any method
v1.8.0-linux,required for pimpl
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,"in header only mode, control library is not available"
v1.8.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.0-linux,if using Unreal Build system then include precompiled header file first
v1.8.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.0-linux,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.8.0-linux,make sure we can talk to the DroneServer
v1.8.0-linux,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.8.0-linux,command_context.client.ping();
v1.8.0-linux,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.8.0-linux,sim only
v1.8.0-linux,CinemAirSim
v1.8.0-linux,End CinemAirSim
v1.8.0-linux,"Minor TODO: consider msgpack magic for GeoPoint, so we can have one arg instead of three"
v1.8.0-linux,Convert
v1.8.0-linux,return value of last task. It should be true if task completed without
v1.8.0-linux,cancellation or timeout
v1.8.0-linux,"should be implemented by derived class if it supports async task,"
v1.8.0-linux,for example using futures
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,"in header only mode, control library is not available"
v1.8.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.0-linux,if using Unreal Build system then include precompiled header file first
v1.8.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,"in header only mode, control library is not available"
v1.8.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.0-linux,if using Unreal Build system then include precompiled header file first
v1.8.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.0-linux,required for pimpl
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,"in header only mode, control library is not available"
v1.8.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.0-linux,if using Unreal Build system then include precompiled header file first
v1.8.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.0-linux,status getters
v1.8.0-linux,Rotor state getter
v1.8.0-linux,Multirotor state getter
v1.8.0-linux,return value of last task. It should be true if task completed without
v1.8.0-linux,cancellation or timeout
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,"in header only mode, control library is not available"
v1.8.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.8.0-linux,if using Unreal Build system then include pre-compiled header file first
v1.8.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.8.0-linux,getters
v1.8.0-linux,Rotor state
v1.8.0-linux,Multirotor state
v1.8.0-linux,required for pimpl
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,"in header only mode, control library is not available"
v1.8.0-linux,last command is to hold on to position
v1.8.0-linux,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.8.0-linux,after landing we detect if drone has stopped moving
v1.8.0-linux,validate path size
v1.8.0-linux,validate yaw mode
v1.8.0-linux,validate and set auto-lookahead value
v1.8.0-linux,if auto mode requested for lookahead then calculate based on velocity
v1.8.0-linux,add current position as starting point
v1.8.0-linux,append the input path and compute segments
v1.8.0-linux,add last segment as zero length segment so we have equal number of segments and points.
v1.8.0-linux,path_segs[i] refers to segment that starts at point i
v1.8.0-linux,"when path ends, we want to slow down"
v1.8.0-linux,else no need to change velocities for last segments
v1.8.0-linux,setup current position on path to 0 offset
v1.8.0-linux,initialize next path position
v1.8.0-linux,until we are at the end of the path (last seg is always zero size)
v1.8.0-linux,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.8.0-linux,send drone command to get to next lookahead
v1.8.0-linux,sleep for rest of the cycle
v1.8.0-linux,how much have we moved towards last goal?
v1.8.0-linux,project actual vector on goal vector
v1.8.0-linux,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.8.0-linux,TODO: below should be lower than 1E3 and configurable
v1.8.0-linux,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.8.0-linux,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.8.0-linux,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.8.0-linux,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.8.0-linux,"if drone moved backward, we don't want goal to move backward as well"
v1.8.0-linux,"so only climb forward on the path, never back. Also note >= which means"
v1.8.0-linux,we climb path even if distance was 0 to take care of duplicated points on path
v1.8.0-linux,else
v1.8.0-linux,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.8.0-linux,compute next target on path
v1.8.0-linux,freeze the quaternion
v1.8.0-linux,convert RC commands to velocity vector
v1.8.0-linux,find yaw as per terrain and remote setting
v1.8.0-linux,execute command
v1.8.0-linux,if timeout occurred then command completed successfully otherwise it was interrupted
v1.8.0-linux,yaw is not within margin
v1.8.0-linux,by default we say that this command is not supported
v1.8.0-linux,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.8.0-linux,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.8.0-linux,get trims
v1.8.0-linux,take average
v1.8.0-linux,validate dest
v1.8.0-linux,what is the distance we will travel at this velocity?
v1.8.0-linux,get velocity vector
v1.8.0-linux,yaw for the direction of travel
v1.8.0-linux,find velocity vector
v1.8.0-linux,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.8.0-linux,generate velocity vector that is same size as cur_dest_norm / command period
v1.8.0-linux,this velocity vect when executed for command period would yield cur_dest_norm
v1.8.0-linux,send commands
v1.8.0-linux,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.8.0-linux,default strategy is for move. In hover mode we set new strategy temporarily
v1.8.0-linux,are we supposed to do EM?
v1.8.0-linux,get suggested velocity vector
v1.8.0-linux,use the unchecked command
v1.8.0-linux,tell caller not to execute planned command
v1.8.0-linux,other wise throw exception
v1.8.0-linux,otherwise there is some other reason why we are in unsafe situation
v1.8.0-linux,send last command to come to full stop
v1.8.0-linux,else no unsafe situation
v1.8.0-linux,note: cur_path_loc and next_path_loc may both point to same object
v1.8.0-linux,"otherwise use up this segment, move on to next one"
v1.8.0-linux,if we are here then we ran out of segments
v1.8.0-linux,consider last segment as zero length segment
v1.8.0-linux,adjust yaw for the direction of travel in forward-only mode
v1.8.0-linux,else no adjustment needed
v1.8.0-linux,if auto mode requested for lookahead then calculate based on velocity
v1.8.0-linux,Create a spring arm component for our chase camera
v1.8.0-linux,"do nothing, spring arm is pulling the camera with it"
v1.8.0-linux,"do nothing, we have camera turned off"
v1.8.0-linux,set initial view mode
v1.8.0-linux,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.8.0-linux,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.8.0-linux,"If the lag is missing, the camera will also occasionally shake."
v1.8.0-linux,"But, lag is not desired when piloting a drone"
v1.8.0-linux,attach spring arm to actor
v1.8.0-linux,remember current parent for external camera. Later when we remove external
v1.8.0-linux,"camera from spring arm, we will attach it back to its last parent"
v1.8.0-linux,now attach camera to spring arm
v1.8.0-linux,"For car, we need to move the camera back a little more than for a drone."
v1.8.0-linux,"Otherwise, the camera will be stuck inside the car"
v1.8.0-linux,ExternalCamera->bUsePawnControlRotation = false;
v1.8.0-linux,detach spring arm
v1.8.0-linux,Re-enable rendering
v1.8.0-linux,Remove any existing key bindings for manual mode
v1.8.0-linux,"else someone else is bound to manual pose controller, leave it alone"
v1.8.0-linux,if new mode is manual mode then add key bindings
v1.8.0-linux,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.8.0-linux,other modes don't need special setup
v1.8.0-linux,make switch official
v1.8.0-linux,Add loading screen to viewport
v1.8.0-linux,Remove Loading screen from viewport
v1.8.0-linux,Create struct for Location and Rotation of actor in Unreal
v1.8.0-linux,Ensure new non-matching name for the object
v1.8.0-linux,Write the binvox file using run-length encoding
v1.8.0-linux,"where each pair of bytes is of the format (run value, run length)"
v1.8.0-linux,This is a run (repeated bit value)
v1.8.0-linux,End of a run
v1.8.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.8.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.8.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.8.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.8.0-linux,Split the tag string into individual tags.
v1.8.0-linux,Texture swap on actors that have all of those tags.
v1.8.0-linux,----------- Plotting APIs ----------/
v1.8.0-linux,"plot line for points 0-1, 1-2, 2-3"
v1.8.0-linux,"plot line for points 0-1, 2-3, 4-5... must be even number of points"
v1.8.0-linux,assert points_start.size() == poinst_end.size()
v1.8.0-linux,assert positions.size() == strings.size()
v1.8.0-linux,assert poses.size() == names.size()
v1.8.0-linux,Recording APIs
v1.8.0-linux,"Remove '' from the list, representing default vehicle"
v1.8.0-linux,"We need to run this code on the main game thread, since it iterates over actors"
v1.8.0-linux,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.8.0-linux,"No LOS, so draw red line"
v1.8.0-linux,"Yes LOS, so draw green line"
v1.8.0-linux,"We need to run this code on the main game thread, since it iterates over actors"
v1.8.0-linux,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.8.0-linux,Testing actor enum for world bounds...
v1.8.0-linux,"Same as with the Object Iterator, access the subclass instance with the * or -> operators."
v1.8.0-linux,"TODO think more about how best to determine/indicate ground level, if anyone cares"
v1.8.0-linux,Convert Uvectors to LLAs
v1.8.0-linux,CinemAirSim
v1.8.0-linux,End CinemAirSim
v1.8.0-linux,Fill out your copyright notice in the Description page of Project Settings.
v1.8.0-linux,"Set this component to be initialized when the game starts, and to be ticked every frame.  You can turn these features"
v1.8.0-linux,off to improve performance if you don't need them.
v1.8.0-linux,get render target for texture size
v1.8.0-linux,initialize viewinfo for projection matrix
v1.8.0-linux,calculate 3D corner Points of bounding box
v1.8.0-linux,initialize pixel values
v1.8.0-linux,initialize projection data for sceneview
v1.8.0-linux,do some voodoo rotation that is somehow mandatory and stolen from UGameplayStatics::ProjectWorldToScreen
v1.8.0-linux,Project Points to pixels and get the corner pixels
v1.8.0-linux,If actor in camera view - check if it's actually visible or hidden
v1.8.0-linux,Check against 8 extend points
v1.8.0-linux,"If actor in camera view but didn't hit any point out of 8 extend points,"
v1.8.0-linux,check against 10 random points
v1.8.0-linux,CinemAirSim
v1.8.0-linux,CinemAirSim
v1.8.0-linux,set initial focal length
v1.8.0-linux,by default all image types are disabled
v1.8.0-linux,use final color for all calculations
v1.8.0-linux,We set all cameras to start as nodisplay
v1.8.0-linux,This improves performance because the capture components are no longer updating every frame and only update while requesting an image
v1.8.0-linux,TODO: avoid the need to override const cast here
v1.8.0-linux,if the viewport is taller than it is wide
v1.8.0-linux,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v1.8.0-linux,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v1.8.0-linux,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v1.8.0-linux,use final color for all calculations
v1.8.0-linux,TODO: should we be ignoring position and orientation settings here?
v1.8.0-linux,TODO: can we eliminate storing NedTransform?
v1.8.0-linux,CinemAirSim
v1.8.0-linux,if (!std::isnan(setting.target_gamma))
v1.8.0-linux,camera-> = setting.target_gamma;
v1.8.0-linux,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.8.0-linux,else nothing to enable
v1.8.0-linux,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.8.0-linux,if (controller && controller->GetViewTarget() == this)
v1.8.0-linux,controller->SetViewTarget(nullptr);
v1.8.0-linux,CinemAirSim methods
v1.8.0-linux,Copy all of the post processing settings
v1.8.0-linux,But restore the original blendables
v1.8.0-linux,end CinemAirSim methods
v1.8.0-linux,"Check whether requested map exists, this could be very slow if LevelName is a short package name"
v1.8.0-linux,Create Unique Name for sub-level package
v1.8.0-linux,Setup streaming level object that will load specified map
v1.8.0-linux,Transform
v1.8.0-linux,Map to Load
v1.8.0-linux,Add the new level to world.
v1.8.0-linux,TODO: explore screenshot option
v1.8.0-linux,addScreenCaptureHandler(camera->GetWorld());
v1.8.0-linux,TODO: may be we should have these methods non-const?
v1.8.0-linux,We don't do game/render thread synchronization for safe method.
v1.8.0-linux,We just blindly sleep for 200ms (the old way)
v1.8.0-linux,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.8.0-linux,Make sure that all alpha values are opaque.
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,TODO: change naming conventions to same as other files?
v1.8.0-linux,"context->GetWorld()->SetNewWorldOrigin(FIntVector(0, 0, 0));"
v1.8.0-linux,Enable/disable primary viewport rendering flag
v1.8.0-linux,This disables rendering of the main viewport in the same way as the
v1.8.0-linux,"console command ""show rendering"" would do."
v1.8.0-linux,"When getting an image through the API, the image is produced after the render"
v1.8.0-linux,thread has finished rendering the current and the subsequent frame. This means
v1.8.0-linux,that the frame rate for obtaining images through the API is only half as high as
v1.8.0-linux,"it could be, since only every other image is actually captured. We work around"
v1.8.0-linux,this by telling the viewport to flush the rendering queue at the end of each
v1.8.0-linux,drawn frame so that it executes our render request at that point already.
v1.8.0-linux,Do this only if the main viewport is not being rendered anyway in case there are
v1.8.0-linux,any adverse performance effects during main rendering.
v1.8.0-linux,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v1.8.0-linux,nothing to do for now
v1.8.0-linux,"if hidden, clear any existing messages"
v1.8.0-linux,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.8.0-linux,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.8.0-linux,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.8.0-linux,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.8.0-linux,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.8.0-linux,Find mesh in /Game and /AirSim asset registry. When more plugins are added this function will have to change
v1.8.0-linux,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.8.0-linux,{
v1.8.0-linux,InitializeObjectStencilID(*comp);
v1.8.0-linux,}
v1.8.0-linux,"Takes a UStaticMeshComponent, USkinnedMeshComponent or ALandscapeProxy and returns their custom stencil ID if"
v1.8.0-linux,their meshes's name or their owner's name (depending on the naming method in mesh_naming_method_) equals mesh_name
v1.8.0-linux,"The skybox is ignored here as it is huge, and really is of no use to the end user typically. Also the associated meshes with the cameras"
v1.8.0-linux,Various checks if there is even a valid mesh
v1.8.0-linux,Need to force the render command to go through cause on the next iteration the buffer no longer exists
v1.8.0-linux,Unreal stores more vertices than triangles. So here we find the highest referenced vertex and ignore any after that
v1.8.0-linux,can we see followee?
v1.8.0-linux,remove mapping
v1.8.0-linux,removing binding
v1.8.0-linux,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.8.0-linux,"some point. At the moment, manually swapping Red and Blue"
v1.8.0-linux,Copy scaled image into destination thumb
v1.8.0-linux,Compress data - convert into a .png
v1.8.0-linux,if we already have attached actor
v1.8.0-linux,Fill out your copyright notice in the Description page of Project Settings.
v1.8.0-linux,Check pointer equality first for performance
v1.8.0-linux,"KeyHash = HashCombine(KeyHash, GetTypeHash(Key.WildcardMeshNames));"
v1.8.0-linux,#ifdef _MSC_VER
v1.8.0-linux,//print to VS output window
v1.8.0-linux,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.8.0-linux,#endif
v1.8.0-linux,also do default logging
v1.8.0-linux,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.8.0-linux,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.8.0-linux,{
v1.8.0-linux,if (GEngine != nullptr)
v1.8.0-linux,{
v1.8.0-linux,return GEngine->GameUserSettings;
v1.8.0-linux,}
v1.8.0-linux,return nullptr;
v1.8.0-linux,}
v1.8.0-linux,UGameUserSettings* game_settings = GetGameUserSettings();
v1.8.0-linux,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.8.0-linux,game_settings->ApplySettings(true);
v1.8.0-linux,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.8.0-linux,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.8.0-linux,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.8.0-linux,todo unused. need to manually plots tf axes' line in right handed FLU instead of using DrawDebugCoordinateSystem
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,plugin startup
v1.8.0-linux,plugin shutdown
v1.8.0-linux,initialize state
v1.8.0-linux,add listener for pawn's collision event
v1.8.0-linux,compute our home point
v1.8.0-linux,default behavior is to call update every tick
v1.8.0-linux,"for custom physics engine, this method should be overridden and update should be"
v1.8.0-linux,called from every physics tick
v1.8.0-linux,add cameras that already exists in pawn
v1.8.0-linux,create or replace cameras specified in settings
v1.8.0-linux,setup individual cameras
v1.8.0-linux,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.8.0-linux,for each camera in settings
v1.8.0-linux,get pose
v1.8.0-linux,spawn and attach camera to pawn
v1.8.0-linux,add on to our collection
v1.8.0-linux,Deflect along the surface when we collide.
v1.8.0-linux,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.8.0-linux,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.8.0-linux,-1 to 1 --> 0 to 1
v1.8.0-linux,-1 to 1
v1.8.0-linux,these will be available for devices like steering wheels
v1.8.0-linux,switch index 0 to 7 for FrSky Taranis RC is:
v1.8.0-linux,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.8.0-linux,TODO: should below be at controller level info?
v1.8.0-linux,else don't waste time
v1.8.0-linux,"We need to run this code on the main game thread, since it iterates over actors"
v1.8.0-linux,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.8.0-linux,Transform from LLA to NED
v1.8.0-linux,KM911 remove logging
v1.8.0-linux,"common_utils::Utils::log(""NED from LLA: "" + std::to_string(target_location.X) + "", "" + std::to_string(target_location.Y) + "", "" + std::to_string(target_location.Z), common_utils::Utils::kLogLevelInfo);"
v1.8.0-linux,"No LOS, so draw red line"
v1.8.0-linux,"Yes LOS, so draw green line"
v1.8.0-linux,sync environment from kinematics
v1.8.0-linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.8.0-linux,void playBack()
v1.8.0-linux,{
v1.8.0-linux,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.8.0-linux,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.8.0-linux,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.8.0-linux,}
v1.8.0-linux,TODO: refactor below code used for playback
v1.8.0-linux,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.8.0-linux,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.8.0-linux,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.8.0-linux,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.8.0-linux,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.8.0-linux,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.8.0-linux,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.8.0-linux,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.8.0-linux,}
v1.8.0-linux,parameters in NED frame
v1.8.0-linux,translate to new PawnSimApi position & orientation from NED to NEU
v1.8.0-linux,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.8.0-linux,allow teleportation
v1.8.0-linux,if collisions are not enabled
v1.8.0-linux,or we have collided but passthrough is enabled
v1.8.0-linux,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.8.0-linux,"without flip flopping, collisions can't be detected"
v1.8.0-linux,update kinematics from pawn's movement instead of physics engine
v1.8.0-linux,by default we update kinematics from UE pawn
v1.8.0-linux,if SimMod uses its own physics engine then this should be overriden
v1.8.0-linux,no default action in this base class
v1.8.0-linux,"read pixels from render target using render thread, then compress the result into PNG"
v1.8.0-linux,argument on the thread that calls this method.
v1.8.0-linux,TODO: is below really needed?
v1.8.0-linux,make sure we are not on the rendering thread
v1.8.0-linux,TODO: below doesn't work right now because it must be running in game thread
v1.8.0-linux,below is documented method but more expensive because it forces flush
v1.8.0-linux,wait for render thread to pick up our task
v1.8.0-linux,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.8.0-linux,capture CameraPose for this frame
v1.8.0-linux,The completion is called immeidately after GameThread sends the
v1.8.0-linux,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.8.0-linux,execute *immediately* after RenderThread renders the scene!
v1.8.0-linux,"while we're still on GameThread, enqueue request for capture the scene!"
v1.8.0-linux,wait for this task to complete
v1.8.0-linux,log a message and continue wait
v1.8.0-linux,lamda function still references a few objects for which there is no refcount.
v1.8.0-linux,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.8.0-linux,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.8.0-linux,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.8.0-linux,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.8.0-linux,Fill out your copyright notice in the Description page of Project Settings.
v1.8.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.0-linux,UWorld* World = GetWorld();
v1.8.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.0-linux,still need the menu class for f10
v1.8.0-linux,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v1.8.0-linux,showWeatherMenu(WorldContextObject);
v1.8.0-linux,"if weather is not enabled, dont allow any weather values to be set"
v1.8.0-linux,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v1.8.0-linux,and must be set to true or false before this.
v1.8.0-linux,WeatherEnabled will always be false
v1.8.0-linux,"NOTE: weather enabled must be set first, before other params for this to work"
v1.8.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.0-linux,"get all menu actors, if any"
v1.8.0-linux,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.8.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.8.0-linux,"get all menu actors, if any"
v1.8.0-linux,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.8.0-linux,"get all menu actors, if any, then hide the menu"
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,Stuff to filter out XInput devices
v1.8.0-linux,-----------------------------------------------------------------------------
v1.8.0-linux,"Defines, constants, and global variables"
v1.8.0-linux,-----------------------------------------------------------------------------
v1.8.0-linux,Magnitude ranges from -1 to 1
v1.8.0-linux,Strength ranges from 0 to 1
v1.8.0-linux,Autocenter
v1.8.0-linux,Rumble
v1.8.0-linux,Register with the DirectInput subsystem and get a pointer
v1.8.0-linux,to a IDirectInput interface we can use.
v1.8.0-linux,Create a DInput object
v1.8.0-linux,Look for a simple joystick we can use for this sample program.
v1.8.0-linux,Make sure we got a joystick
v1.8.0-linux,"Set the data format to ""simple joystick"" - a predefined data format"
v1.8.0-linux,
v1.8.0-linux,"A data format specifies which controls on a device we are interested in,"
v1.8.0-linux,and how they should be reported. This tells DInput that we will be
v1.8.0-linux,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.8.0-linux,Set the cooperative level to let DInput know how this device should
v1.8.0-linux,interact with the system and with other DInput applications.
v1.8.0-linux,Enumerate the joystick objects. The callback function enabled user
v1.8.0-linux,"interface elements for objects that are found, and sets the min/max"
v1.8.0-linux,values property for discovered axes.
v1.8.0-linux,-----------------------------------------------------------------------------
v1.8.0-linux,Enum each PNP device using WMI and check each device ID to see if it contains
v1.8.0-linux,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.8.0-linux,Unfortunately this information can not be found by just using DirectInput.
v1.8.0-linux,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.8.0-linux,XInput devices.
v1.8.0-linux,
v1.8.0-linux,This function stores the list of xinput devices in a linked list
v1.8.0-linux,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.8.0-linux,-----------------------------------------------------------------------------
v1.8.0-linux,CoInit if needed
v1.8.0-linux,Create WMI
v1.8.0-linux,Create BSTRs for WMI
v1.8.0-linux,Connect to WMI
v1.8.0-linux,Switch security level to IMPERSONATE
v1.8.0-linux,Get list of Win32_PNPEntity devices
v1.8.0-linux,Loop over all devices
v1.8.0-linux,Get 20 at a time
v1.8.0-linux,"For each device, get its device ID"
v1.8.0-linux,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.8.0-linux,Unfortunately this information can not be found by just using DirectInput
v1.8.0-linux,"If it does, then get the VID/PID from var.bstrVal"
v1.8.0-linux,Add the VID/PID to a linked list
v1.8.0-linux,-----------------------------------------------------------------------------
v1.8.0-linux,Returns true if the DirectInput device is also an XInput device.
v1.8.0-linux,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.8.0-linux,-----------------------------------------------------------------------------
v1.8.0-linux,Check each xinput device to see if this device's vid/pid matches
v1.8.0-linux,-----------------------------------------------------------------------------
v1.8.0-linux,Cleanup needed for IsXInputDevice()
v1.8.0-linux,-----------------------------------------------------------------------------
v1.8.0-linux,Cleanup linked list
v1.8.0-linux,-----------------------------------------------------------------------------
v1.8.0-linux,Name: EnumJoysticksCallback()
v1.8.0-linux,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.8.0-linux,device interface on it so we can play with it.
v1.8.0-linux,-----------------------------------------------------------------------------
v1.8.0-linux,Skip anything other than the perferred joystick device as defined by the control panel.
v1.8.0-linux,Instead you could store all the enumerated joysticks and let the user pick.
v1.8.0-linux,Obtain an interface to the enumerated joystick.
v1.8.0-linux,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.8.0-linux,it while we were in the middle of enumerating it.)
v1.8.0-linux,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.8.0-linux,could store all the enumerated joysticks and let the user pick.
v1.8.0-linux,-----------------------------------------------------------------------------
v1.8.0-linux,Name: EnumObjectsCallback()
v1.8.0-linux,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.8.0-linux,joystick. This function enables user interface elements for objects
v1.8.0-linux,"that are found to exist, and scales axes min/max values."
v1.8.0-linux,-----------------------------------------------------------------------------
v1.8.0-linux,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.8.0-linux,enumerated axis in order to scale min/max values.
v1.8.0-linux,Set the range for the axis
v1.8.0-linux,Set the UI to reflect what objects the joystick supports
v1.8.0-linux,-----------------------------------------------------------------------------
v1.8.0-linux,Name: UpdateInputState()
v1.8.0-linux,Desc: Get the input device's state and display it.
v1.8.0-linux,-----------------------------------------------------------------------------
v1.8.0-linux,Poll the device to read the current state
v1.8.0-linux,DInput is telling us that the input stream has been
v1.8.0-linux,"interrupted. We aren't tracking any state between polls, so"
v1.8.0-linux,we don't have any special reset that needs to be done. We
v1.8.0-linux,just re-acquire and try again.
v1.8.0-linux,while (hr == DIERR_INPUTLOST)
v1.8.0-linux,hr = g_pJoystick->Acquire();
v1.8.0-linux,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.8.0-linux,may occur when the app is minimized or in the process of
v1.8.0-linux,"switching, so just try again later"
v1.8.0-linux,Get the input's device state
v1.8.0-linux,Axes
v1.8.0-linux,Slider controls
v1.8.0-linux,Points of view
v1.8.0-linux,Buttons
v1.8.0-linux,-----------------------------------------------------------------------------
v1.8.0-linux,Name: FreeDirectInput()
v1.8.0-linux,Desc: Initialize the DirectInput variables.
v1.8.0-linux,-----------------------------------------------------------------------------
v1.8.0-linux,Unacquire the device one last time just in case
v1.8.0-linux,the app tried to exit while the device is still acquired.
v1.8.0-linux,Release any DirectInput objects.
v1.8.0-linux,nop
v1.8.0-linux,normalize min to max --> 0 to 1
v1.8.0-linux,normalize 0 to 1 --> -1 to 1
v1.8.0-linux,#include <libudev.h>
v1.8.0-linux,implementation for unsupported OS
v1.8.0-linux,if this is new index
v1.8.0-linux,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.8.0-linux,close previous one
v1.8.0-linux,open new device
v1.8.0-linux,if open was successful
v1.8.0-linux,read the device
v1.8.0-linux,if we didn't had valid read
v1.8.0-linux,"NOTE if this condition is not met, we're probably out of sync and this"
v1.8.0-linux,Joystick instance is likely unusable
v1.8.0-linux,TODO: set below to false?
v1.8.0-linux,state.is_valid = false;
v1.8.0-linux,else ignore
v1.8.0-linux,TODO: implement this for linux
v1.8.0-linux,TODO: implement this for linux
v1.8.0-linux,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.8.0-linux,{
v1.8.0-linux,"manufacturerID = productID = """";"
v1.8.0-linux,// Use udev to look up the product and manufacturer IDs
v1.8.0-linux,struct udev *udev = udev_new();
v1.8.0-linux,if (udev) {
v1.8.0-linux,char sysname[32];
v1.8.0-linux,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.8.0-linux,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.8.0-linux,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.8.0-linux,if (!dev)
v1.8.0-linux,{
v1.8.0-linux,"message = ""Unable to find parent USB device"";"
v1.8.0-linux,return false;
v1.8.0-linux,}
v1.8.0-linux,std::stringstream ss;
v1.8.0-linux,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.8.0-linux,ss >> manufacturerID;
v1.8.0-linux,ss.clear();
v1.8.0-linux,"ss.str("""");"
v1.8.0-linux,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.8.0-linux,ss >> productID;
v1.8.0-linux,udev_device_unref(dev);
v1.8.0-linux,}
v1.8.0-linux,else
v1.8.0-linux,{
v1.8.0-linux,"message = ""Cannot create udev"";"
v1.8.0-linux,return false;
v1.8.0-linux,}
v1.8.0-linux,udev_unref(udev);
v1.8.0-linux,return true;
v1.8.0-linux,}
v1.8.0-linux,required for pimpl
v1.8.0-linux,TODO: anyway to workaround const_cast?
v1.8.0-linux,FGenericPlatformMisc::PlatformInit();
v1.8.0-linux,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.8.0-linux,"sub-window captures don't count as a request, set bCaptureEveryFrame and bCaptureOnMovement to display so we can show correctly the subwindow"
v1.8.0-linux,create main widget
v1.8.0-linux,synchronize PIP views
v1.8.0-linux,TODO: should we only do below on SceneCapture2D components and cameras?
v1.8.0-linux,avoid motion blur so capture images don't get
v1.8.0-linux,use two different methods to set console var because sometime it doesn't seem to work
v1.8.0-linux,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.8.0-linux,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.8.0-linux,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.8.0-linux,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.8.0-linux,setup defaults
v1.8.0-linux,Attempts to parse the settings text from one of multiple locations.
v1.8.0-linux,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.8.0-linux,"Next, check the executable's working directory for the settings file."
v1.8.0-linux,"Finally, check the user's documents folder."
v1.8.0-linux,"If the settings file cannot be read, throw an exception"
v1.8.0-linux,Attempts to parse the settings file path or the settings text from the command line
v1.8.0-linux,"Looks for the flag ""-settings="". If it exists, settingsText will be set to the value."
v1.8.0-linux,"Example (Path): AirSim.exe -settings=""C:\path\to\settings.json"""
v1.8.0-linux,"Example (Text): AirSim.exe -settings={""foo"":""bar""} -> settingsText will be set to {""foo"":""bar""}"
v1.8.0-linux,"Returns true if the argument is present, false otherwise."
v1.8.0-linux,build image file name
v1.8.0-linux,write image file
v1.8.0-linux,"Write PNG image, already compressed in binary"
v1.8.0-linux,write to CSV file
v1.8.0-linux,"Either images were saved successfully, or there were no images"
v1.8.0-linux,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.8.0-linux,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.8.0-linux,"Just need any 1 instance, to set the header line of the record file"
v1.8.0-linux,"Set is_ready at the end, setting this before can cause a race when the file isn't open yet"
v1.8.0-linux,make sure all vars are set up
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,decide which derived BP to use
v1.8.0-linux,we don't have real vehicle so no vehicle API
v1.8.0-linux,put camera little bit above vehicle
v1.8.0-linux,update ground level
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,let base class setup physics world
v1.8.0-linux,stop physics thread before we dismantle
v1.8.0-linux,setup clock in ClockFactory
v1.8.0-linux,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.8.0-linux,steppable clock returns interval that is a constant number irrespective of wall clock
v1.8.0-linux,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.8.0-linux,but that would cause vehicles like quadrotors to become unstable
v1.8.0-linux,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.8.0-linux,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.8.0-linux,get increase in clock speed
v1.8.0-linux,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.8.0-linux,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.8.0-linux,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.8.0-linux,Approach 2: scale control loop frequency if clock is speeded up
v1.8.0-linux,"for slowing down, this don't generate instability"
v1.8.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.8.0-linux,decide which derived BP to use
v1.8.0-linux,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.8.0-linux,vehicle_sim_api->reset();
v1.8.0-linux,create vehicle API
v1.8.0-linux,setup physics vehicle
v1.8.0-linux,initialize private vars
v1.8.0-linux,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.8.0-linux,calls to update* are handled by physics engine and in SimModeWorldBase
v1.8.0-linux,"Utils::log(""------Render tick-------"");"
v1.8.0-linux,"if reset is pending then do it first, no need to do other things until next tick"
v1.8.0-linux,move collision info from rendering engine to vehicle
v1.8.0-linux,update rotor poses
v1.8.0-linux,update private rotor variable
v1.8.0-linux,if we did reset then don't worry about synchronizing states for this tick
v1.8.0-linux,Continue to wait for reset
v1.8.0-linux,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.8.0-linux,*** Start: UpdatableState implementation ***//
v1.8.0-linux,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.8.0-linux,environment update for current position
v1.8.0-linux,update forces on vertices
v1.8.0-linux,update to controller must be done after kinematics have been updated by physics engine
v1.8.0-linux,*** End: UpdatableState implementation ***//
v1.8.0-linux,get references of existing camera
v1.8.0-linux,setup clock in PhysX
v1.8.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.8.0-linux,decide which derived BP to use
v1.8.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.8.0-linux,Setup suspension forces
v1.8.0-linux,Find the tire object and set the data for it
v1.8.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.8.0-linux,Setup suspension forces
v1.8.0-linux,Find the tire object and set the data for it
v1.8.0-linux,Create In-Car camera component
v1.8.0-linux,In car HUD
v1.8.0-linux,Create text render component for in car speed display
v1.8.0-linux,Create text render component for in car gear display
v1.8.0-linux,Setup the audio component and allocate it a sound cue
v1.8.0-linux,Colors for the in-car gear display. One for normal one for reverse
v1.8.0-linux,Wheels/Tires
v1.8.0-linux,Setup the wheels
v1.8.0-linux,Adjust the tire loading
v1.8.0-linux,Engine
v1.8.0-linux,Torque setup
v1.8.0-linux,Adjust the steering
v1.8.0-linux,Transmission
v1.8.0-linux,We want 4wd
v1.8.0-linux,Drive the front wheels a little more than the rear
v1.8.0-linux,Automatic gearbox
v1.8.0-linux,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.8.0-linux,Physics settings
v1.8.0-linux,Adjust the center of mass - the buggy is quite low
v1.8.0-linux,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.8.0-linux,put camera little bit above vehicle
v1.8.0-linux,update physics material
v1.8.0-linux,Update the strings used in the HUD (in-car and on-screen)
v1.8.0-linux,Set the string in the in-car HUD
v1.8.0-linux,Pass the engine RPM to the sound component
v1.8.0-linux,Start an engine sound playing
v1.8.0-linux,Using FText because this is display text that should be localizable
v1.8.0-linux,Setup the text render component strings
v1.8.0-linux,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.8.0-linux,below is not needed
v1.8.0-linux,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.8.0-linux,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.8.0-linux,create vehicle params
v1.8.0-linux,TODO: should do reset() here?
v1.8.0-linux,these are called on render ticks
v1.8.0-linux,TODO: do we need this for cars?
v1.8.0-linux,TODO: move this to SimModeBase?
v1.8.0-linux,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.8.0-linux,reset();
v1.8.0-linux,return;
v1.8.0-linux,}
v1.8.0-linux,Thrustmaster devices
v1.8.0-linux,"Anything else, typically Logitech G920 wheel"
v1.8.0-linux,Two steel levers behind wheel
v1.8.0-linux,if API-client control is not active then we route keyboard/joystick control to car
v1.8.0-linux,all car controls from anywhere must be routed through API component
v1.8.0-linux,*** Start: UpdatableState implementation ***//
v1.8.0-linux,physics tick
v1.8.0-linux,*** End: UpdatableState implementation ***//
v1.8.0-linux,TODO: directly accept getVehicleSimApis() using generic container
v1.8.0-linux,Reset the vehicle as well before registering it
v1.8.0-linux,Similar to what happens in initializeForPlay() above
v1.8.0-linux,remove everything that we created in BeginPlay
v1.8.0-linux,wait if no new frame is renderd
v1.8.0-linux,we use custom debug reporting for this class
v1.8.0-linux,perform any expensive rendering update outside of lock region
v1.8.0-linux,no need to call base reset because of our custom implementation
v1.8.0-linux,TODO: this is going to cause circular references which is fine here but
v1.8.0-linux,in future we should consider moving SimMode not derived from AActor and move
v1.8.0-linux,it to AirLib and directly implement WorldSimApiBase interface
v1.8.0-linux,get player start
v1.8.0-linux,this must be done from within actor otherwise we don't get player start
v1.8.0-linux,Grab player location
v1.8.0-linux,Move the world origin to the player's location (this moves the coordinate system and adds
v1.8.0-linux,a corresponding offset to all positions to compensate for the shift)
v1.8.0-linux,"Regrab the player's position after the offset has been added (which should be 0,0,0 now)"
v1.8.0-linux,UWeatherLib::showWeatherMenu(World);
v1.8.0-linux,else don't init
v1.8.0-linux,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v1.8.0-linux,tod_sim_clock_start_ needs to be reset here.
v1.8.0-linux,Going from enabled to disabled
v1.8.0-linux,do these in the end to ensure that advanceTimeOfDay() doesn't see
v1.8.0-linux,any inconsistent state.
v1.8.0-linux,should be overridden by derived class
v1.8.0-linux,should be overriden by derived class
v1.8.0-linux,should be overridden by derived class
v1.8.0-linux,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.8.0-linux,default setup - this should be overridden in derived modes as needed
v1.8.0-linux,setup clock in ClockFactory
v1.8.0-linux,default implementation
v1.8.0-linux,create director
v1.8.0-linux,create external camera required for the director
v1.8.0-linux,for each camera in settings
v1.8.0-linux,get pose
v1.8.0-linux,spawn and attach camera to pawn
v1.8.0-linux,add on to our collection
v1.8.0-linux,API server start/stop
v1.8.0-linux,get UU origin of global NED frame
v1.8.0-linux,compute initial pose
v1.8.0-linux,spawn vehicle pawn
v1.8.0-linux,create vehicle sim api
v1.8.0-linux,Convert to lowercase as done during settings loading
v1.8.0-linux,TODO: Figure out a better way to add more fields
v1.8.0-linux,Maybe allow passing a JSON string for the vehicle settings?
v1.8.0-linux,"Retroactively adjust AirSimSettings, so it's like we knew about this vehicle all along"
v1.8.0-linux,"Usually physics registration happens at init, in ASimModeWorldBase::initializeForPlay(), but not in this case"
v1.8.0-linux,get UU origin of global NED frame
v1.8.0-linux,determine camera director camera default pose and spawn it
v1.8.0-linux,find all vehicle pawns
v1.8.0-linux,add vehicles from settings
v1.8.0-linux,if vehicle is of type for derived SimMode and auto creatable
v1.8.0-linux,create API objects for each pawn we have
v1.8.0-linux,Create External Cameras
v1.8.0-linux,TODO: better handle no FPV vehicles scenario
v1.8.0-linux,derived class shoudl override this method to add new vehicle to the physics engine
v1.8.0-linux,derived class should override this method to retrieve types of pawns they support
v1.8.0-linux,derived class should override this method to retrieve types of pawns they support
v1.8.0-linux,derived class should override this method to retrieve types of pawns they support
v1.8.0-linux,derived class should override this method to retrieve types of pawns they support
v1.8.0-linux,derived class should override this method to retrieve types of pawns they support
v1.8.0-linux,derived class should override this method to retrieve types of pawns they support
v1.8.0-linux,derived class should override this method to retrieve types of pawns they support
v1.8.0-linux,Draws debug-points on main viewport for Lidar laser hits.
v1.8.0-linux,Used for debugging only.
v1.8.0-linux,Currently we are checking the sensor-collection instead of sensor-settings.
v1.8.0-linux,Also using variables to optimize not checking the collection if not needed.
v1.8.0-linux,TODO: Is it incorrect to assume LidarSimple here?
v1.8.0-linux,Draw debug-point on main viewport for Distance sensor hit
v1.8.0-linux,Find position of point hit
v1.8.0-linux,Similar to UnrealDistanceSensor.cpp#L19
v1.8.0-linux,order of Pose addition is important here because it also adds quaternions which is not commutative!
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,ctor
v1.8.0-linux,initializes information based on lidar configuration
v1.8.0-linux,calculate verticle angle distance between each laser
v1.8.0-linux,store vertical angles for each laser
v1.8.0-linux,returns a point-cloud for the tick
v1.8.0-linux,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.8.0-linux,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.8.0-linux,calculate number of points needed for each laser/channel
v1.8.0-linux,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.8.0-linux,calculate needed angle/distance between each point
v1.8.0-linux,normalize FOV start/end
v1.8.0-linux,shoot lasers
v1.8.0-linux,check if the laser is outside the requested horizontal FOV
v1.8.0-linux,"shoot laser and get the impact point, if any"
v1.8.0-linux,simulate shooting a laser via Unreal ray-tracing.
v1.8.0-linux,start position
v1.8.0-linux,We need to compose rotations here rather than rotate a vector by a quaternion
v1.8.0-linux,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.8.0-linux,get ray quaternion in lidar frame (angles must be in radians)
v1.8.0-linux,get ray quaternion in body frame
v1.8.0-linux,get ray quaternion in world frame
v1.8.0-linux,get ray vector (end position)
v1.8.0-linux,Store the segmentation id of the hit object.
v1.8.0-linux,Debug code for very specific cases.
v1.8.0-linux,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.8.0-linux,decide the frame for the point-cloud
v1.8.0-linux,current detault behavior; though it is probably not very useful.
v1.8.0-linux,not changing the default for now to maintain backwards-compat.
v1.8.0-linux,point in vehicle intertial frame
v1.8.0-linux,tranform to lidar frame
v1.8.0-linux,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.8.0-linux,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.8.0-linux,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.8.0-linux,"On the client side, if it is needed to transform this data back to the world frame,"
v1.8.0-linux,"then do the equivalent of following,"
v1.8.0-linux,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.8.0-linux,See SimModeBase::drawLidarDebugPoints()
v1.8.0-linux,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.8.0-linux,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,update ray tracing
v1.8.0-linux,"FString hit_name = FString(""None"");"
v1.8.0-linux,if (dist_hit.GetActor())
v1.8.0-linux,hit_name=dist_hit.GetActor()->GetName();
v1.8.0-linux,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.8.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,This assumes you are running DroneServer already on the same machine.
v1.8.0-linux,DroneServer must be running first.
v1.8.0-linux,enable API control
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,Load gazebo
v1.8.0-linux,Create our node for communication
v1.8.0-linux,Listen to Gazebo topics
v1.8.0-linux,Make sure to shut everything down.
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,move commands
v1.8.0-linux,else leave as it is
v1.8.0-linux,TODO: get these in one call
v1.8.0-linux,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.8.0-linux,TODO: shouldn't we pass folder path?
v1.8.0-linux,parse
v1.8.0-linux,group the images by the current date.
v1.8.0-linux,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.8.0-linux,{
v1.8.0-linux,"return """";"
v1.8.0-linux,}
v1.8.0-linux,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.8.0-linux,{
v1.8.0-linux,return false;
v1.8.0-linux,}
v1.8.0-linux,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.8.0-linux,params.context->client.newTask();
v1.8.0-linux,}
v1.8.0-linux,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.8.0-linux,params.context->client.WaitForCompletion(0);
v1.8.0-linux,}
v1.8.0-linux,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.8.0-linux,{
v1.8.0-linux,}
v1.8.0-linux,parse command line
v1.8.0-linux,Shell callbacks
v1.8.0-linux,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.8.0-linux,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.8.0-linux,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.8.0-linux,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.8.0-linux,Add shell commands
v1.8.0-linux,TODO: add WaitForCompletion command
v1.8.0-linux,"TODO: add command line args help, arg count validation"
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v1.8.0-linux,switch to explicit hover mode so that this is the fall back when
v1.8.0-linux,move* commands are finished.
v1.8.0-linux,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.8.0-linux,TODO: implement weather for Unity
v1.8.0-linux,TODO: implement weather for Unity
v1.8.0-linux,----------------Plotting APIs-----------/
v1.8.0-linux,Recording APIs
v1.8.0-linux,"Remove '' from the list, representing default vehicle"
v1.8.0-linux,CinemAirSim
v1.8.0-linux,End CinemAirSim
v1.8.0-linux,Function pointers to hold the addresses of the functions that are defined in Unity
v1.8.0-linux,"Enabling all LogLevels,"
v1.8.0-linux,"Enabling all LogLevels,"
v1.8.0-linux,delete ltm;
v1.8.0-linux,initialize state
v1.8.0-linux,compute our home point
v1.8.0-linux,default behavior is to call update every tick
v1.8.0-linux,"for custom physics engine, this method should be overridden and update should be"
v1.8.0-linux,called from every physics tick
v1.8.0-linux,these will be available for devices like steering wheels
v1.8.0-linux,sync environment from kinematics
v1.8.0-linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.8.0-linux,FVector unrealPosition = getUUPosition();
v1.8.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v1.8.0-linux,parameters in NED frame
v1.8.0-linux,allow teleportation
v1.8.0-linux,if collisions are not enabled
v1.8.0-linux,or we have collided but passthrough is enabled
v1.8.0-linux,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.8.0-linux,"without flip flopping, collisions can't be detected"
v1.8.0-linux,by default we update kinematics from UE pawn
v1.8.0-linux,if SimMod uses its own physics engine then this should be overriden
v1.8.0-linux,no default action in this base class
v1.8.0-linux,TODO: because this bug we are using alternative code with stringstream
v1.8.0-linux,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.8.0-linux,update kinematics from pawn's movement instead of physics engine
v1.8.0-linux,TODO: update other fields?
v1.8.0-linux,implements getImages() method in the ImageCaptureBase class.
v1.8.0-linux,update ray tracing
v1.8.0-linux,Attempts to parse the settings text from one of multiple locations.
v1.8.0-linux,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.8.0-linux,"Next, check the executable's working directory for the settings file."
v1.8.0-linux,"Finally, check the user's documents folder."
v1.8.0-linux,"If the settings file cannot be read, throw an exception"
v1.8.0-linux,let base class setup physics world
v1.8.0-linux,stop physics thread before we dismantle
v1.8.0-linux,setup clock in ClockFactory
v1.8.0-linux,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.8.0-linux,steppable clock returns interval that is a constant number irrespective of wall clock
v1.8.0-linux,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.8.0-linux,but that would cause vehicles like quadrotors to become unstable
v1.8.0-linux,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.8.0-linux,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.8.0-linux,get increase in clock speed
v1.8.0-linux,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.8.0-linux,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.8.0-linux,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.8.0-linux,Approach 2: scale control loop frequency if clock is speeded up
v1.8.0-linux,"for slowing down, this don't generate instability"
v1.8.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.8.0-linux,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.8.0-linux,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.8.0-linux,create vehicle API
v1.8.0-linux,setup physics vehicle
v1.8.0-linux,initialize private vars
v1.8.0-linux,"if reset is pending then do it first, no need to do other things until next tick"
v1.8.0-linux,move collision info from rendering engine to vehicle
v1.8.0-linux,update rotor poses
v1.8.0-linux,if we did reset then don't worry about synchronizing states for this tick
v1.8.0-linux,Continue to wait for reset
v1.8.0-linux,*** Start: UpdatableState implementation ***//
v1.8.0-linux,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.8.0-linux,environment update for current position
v1.8.0-linux,update forces on vertices
v1.8.0-linux,update to controller must be done after kinematics have been updated by physics engine
v1.8.0-linux,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.8.0-linux,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.8.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.8.0-linux,*** End: UpdatableState implementation ***//
v1.8.0-linux,TODO: should do reset() here?
v1.8.0-linux,these are called on render ticks
v1.8.0-linux,TODO: do we need this for cars?
v1.8.0-linux,Thrustmaster devices
v1.8.0-linux,"Anything else, typically Logitech G920 wheel"
v1.8.0-linux,Two steel levers behind wheel
v1.8.0-linux,if API-client control is not active then we route keyboard/joystick control to car
v1.8.0-linux,This is so that getCarControls API works correctly
v1.8.0-linux,"API is enabled, so we use the controls set by API"
v1.8.0-linux,Update whether to use API controls or keyboard controls
v1.8.0-linux,*** Start: UpdatableState implementation ***//
v1.8.0-linux,physics tick
v1.8.0-linux,void CarPawnSimApi::reportState(StateReporter& reporter)
v1.8.0-linux,{
v1.8.0-linux,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.8.0-linux,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.8.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.8.0-linux,}
v1.8.0-linux,*** End: UpdatableState implementation ***//
v1.8.0-linux,remove everything that we created in BeginPlay
v1.8.0-linux,we use custom debug reporting for this class
v1.8.0-linux,perform any expensive rendering update outside of lock region
v1.8.0-linux,no need to call base reset because of our custom implementation
v1.8.0-linux,should be overridden by derived class
v1.8.0-linux,should be overridden by derived class
v1.8.0-linux,should be overridden by derived class
v1.8.0-linux,commenting this out for now to avoid unintentional Unity startup failure
v1.8.0-linux,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v1.8.0-linux,should be overridden by derived class
v1.8.0-linux,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.8.0-linux,default setup - this should be overridden in derived modes as needed
v1.8.0-linux,setup clock in ClockFactory
v1.8.0-linux,API server start/stop
v1.8.0-linux,determine camera director camera default pose and spawn it
v1.8.0-linux,derived class should override this method to retrieve types of pawns they support
v1.8.0-linux,derived class should override this method to retrieve types of pawns they support
v1.8.0-linux,can we just take origin in Unity here?
v1.8.0-linux,60 acres park:
v1.8.0-linux,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.8.0-linux,marymoore park
v1.8.0-linux,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.8.0-linux,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.8.0-linux,DepthNavThreshold depthNav;
v1.8.0-linux,DepthNavOptAStar depthNav;
v1.8.0-linux,DepthNavThreshold depthNav;
v1.8.0-linux,DepthNavOptAStar depthNav;
v1.8.0-linux,runDepthNavGT();
v1.8.0-linux,runDepthNavSGM();
v1.8.0-linux,Create the launch description and populate
v1.8.0-linux,Declare the launch options
v1.8.0-linux,todo do not reset if already in air?
v1.8.0-linux,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.8.0-linux,ros params
v1.8.0-linux,todo enforce dynamics constraints in this node as well?
v1.8.0-linux,"nh_->get_parameter(""max_vert_vel_"", max_vert_vel_);"
v1.8.0-linux,"nh_->get_parameter(""max_horz_vel"", max_horz_vel_)"
v1.8.0-linux,subscribe to control commands on global nodehandle
v1.8.0-linux,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.8.0-linux,bind to a single callback. todo optimal subs queue length
v1.8.0-linux,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.8.0-linux,"vehicle_ros.reset_srvr = nh_->create_service(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.8.0-linux,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.8.0-linux,camera_setting.gimbal
v1.8.0-linux,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.8.0-linux,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.8.0-linux,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.8.0-linux,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.8.0-linux,"if {DepthPlanar, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.8.0-linux,"push back pair (vector of image captures, current vehicle name)"
v1.8.0-linux,iterate over sensors
v1.8.0-linux,add takeoff and land all services if more than 2 drones
v1.8.0-linux,todo add per vehicle reset in AirLib API
v1.8.0-linux,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.8.0-linux,lidars update on their own callback/thread at a given rate
v1.8.0-linux,QoS - The depth of the publisher message queue.
v1.8.0-linux,more details here - https://docs.ros.org/en/foxy/Concepts/About-Quality-of-Service-Settings.html
v1.8.0-linux,"todo: error check. if state is not landed, return error."
v1.8.0-linux,response->success =
v1.8.0-linux,response->success =
v1.8.0-linux,response->success =
v1.8.0-linux,response->success =
v1.8.0-linux,response->success =
v1.8.0-linux,response->success =
v1.8.0-linux,todo add reset by vehicle_name API to airlib
v1.8.0-linux,todo not async remove wait_on_last_task
v1.8.0-linux,todo expose wait_on_last_task or nah?
v1.8.0-linux,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.8.0-linux,todo expose wait_on_last_task or nah?
v1.8.0-linux,todo support multiple gimbal commands
v1.8.0-linux,todo support multiple gimbal commands
v1.8.0-linux,1. find quaternion of default gimbal pose
v1.8.0-linux,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.8.0-linux,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.8.0-linux,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.8.0-linux,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.8.0-linux,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.8.0-linux,msg = []
v1.8.0-linux,todo covariances
v1.8.0-linux,gps_msg.position_covariance_type =
v1.8.0-linux,gps_msg.position_covariance =
v1.8.0-linux,todo covariances
v1.8.0-linux,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.8.0-linux,todo radians per second
v1.8.0-linux,meters/s2^m
v1.8.0-linux,imu_msg.orientation_covariance = ;
v1.8.0-linux,imu_msg.angular_velocity_covariance = ;
v1.8.0-linux,imu_msg.linear_acceleration_covariance = ;
v1.8.0-linux,todo do actual body frame?
v1.8.0-linux,airsim uses degrees
v1.8.0-linux,todo this is global origin
v1.8.0-linux,get the basic vehicle pose and environmental state
v1.8.0-linux,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.8.0-linux,airsim_client needs to provide the simulation time in a future version of the API
v1.8.0-linux,publish the simulation clock
v1.8.0-linux,"publish vehicle state, odom, and all basic sensor types"
v1.8.0-linux,send any commands out to the vehicles
v1.8.0-linux,"should be easier way to get the sim time through API, something like:"
v1.8.0-linux,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.8.0-linux,curr_ros_time = rclcpp::Time(env.clock().nowNanos());
v1.8.0-linux,iterate over drones
v1.8.0-linux,get drone state from airsim
v1.8.0-linux,"vehicle environment, we can get ambient temperature here and other truths"
v1.8.0-linux,convert airsim drone state to ROS msgs
v1.8.0-linux,simulation environment truth
v1.8.0-linux,"dashboard reading from car, RPM, gear, etc"
v1.8.0-linux,odom and transforms
v1.8.0-linux,ground truth GPS position from sim/HITL
v1.8.0-linux,send control commands from the last callback to airsim
v1.8.0-linux,send control commands from the last callback to airsim
v1.8.0-linux,"Only camera rotation, no translation movement of camera"
v1.8.0-linux,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.8.0-linux,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.8.0-linux,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.8.0-linux,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.8.0-linux,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.8.0-linux,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.8.0-linux,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.8.0-linux,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.8.0-linux,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.8.0-linux,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.8.0-linux,update timestamp of saved cam info msgs
v1.8.0-linux,DepthPlanar / DepthPerspective / DepthVis / DisparityNormalized
v1.8.0-linux,Scene / Segmentation / SurfaceNormals / Infrared
v1.8.0-linux,publish camera transforms
v1.8.0-linux,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.8.0-linux,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.8.0-linux,ROS params
v1.8.0-linux,ROS publishers
v1.8.0-linux,ROS subscribers
v1.8.0-linux,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.8.0-linux,ROS timers
v1.8.0-linux,todo maintain internal representation as eigen vec?
v1.8.0-linux,todo check if low velocity if within thresh?
v1.8.0-linux,todo maintain separate errors for XY and Z
v1.8.0-linux,todo save this in degrees somewhere to avoid repeated conversion
v1.8.0-linux,this tells the update timer callback to not do active hovering
v1.8.0-linux,todo maintain array of position goals
v1.8.0-linux,todo error checks
v1.8.0-linux,todo fill response
v1.8.0-linux,"Already have goal, and have reached it"
v1.8.0-linux,this tells the update timer callback to not do active hovering
v1.8.0-linux,todo error checks
v1.8.0-linux,todo fill response
v1.8.0-linux,"todo do relative altitude, or add an option for the same?"
v1.8.0-linux,convert GPS goal to NED goal
v1.8.0-linux,"RCLCPP_INFO_STREAM(""geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.8.0-linux,todo error checks
v1.8.0-linux,todo fill response
v1.8.0-linux,"Already have goal, this shouldn't happen"
v1.8.0-linux,"todo do relative altitude, or add an option for the same?"
v1.8.0-linux,convert GPS goal to NED goal
v1.8.0-linux,"RCLCPP_INFO_STREAM(""geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.8.0-linux,todo error checks
v1.8.0-linux,todo fill response
v1.8.0-linux,todo check if odometry is too old!!
v1.8.0-linux,"if no odom, don't do anything."
v1.8.0-linux,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.8.0-linux,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.8.0-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.8.0-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.8.0-linux,todo yaw limits
v1.8.0-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.8.0-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.8.0-linux,mimics void ASimHUD::initializeSettings()
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,by Sudipta Sinha
v1.8.0-linux,adapted for AirSim by Matthias Mueller
v1.8.0-linux,first row
v1.8.0-linux,last row
v1.8.0-linux,Local quadratic fit of cost and subpixel refinement.
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,by Sudipta Sinha
v1.8.0-linux,adapted for AirSim by Matthias Mueller
v1.8.0-linux,uint64_t x64 = (uint64_t)x;
v1.8.0-linux,uint64_t y64 = (uint64_t)y;
v1.8.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.8.0-linux,Licensed under the MIT License.
v1.8.0-linux,by Sudipta Sinha
v1.8.0-linux,adapted for AirSim by Matthias Mueller
v1.8.0-linux,ensure that disparity range is a multiple of 8
v1.8.0-linux,sgm stereo
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,read settings and override defaults
v1.7.0-linux,allow json overrides on a per-vehicle basis.
v1.7.0-linux,start server in async mode
v1.7.0-linux,check messages
v1.7.0-linux,plot red arrows for 30 seconds
v1.7.0-linux,plot magenta arrows for 15 seconds
v1.7.0-linux,plot red arrows for 10 seconds
v1.7.0-linux,plot 2 white arrows which are persistent
v1.7.0-linux,plot points
v1.7.0-linux,"plot line strip. 0-1, 1-2, 2-3"
v1.7.0-linux,"plot line list. 0-1, 2-3, 4-5. Must be even."
v1.7.0-linux,plot transforms
v1.7.0-linux,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=0.0, yaw=yaw)) for x, y, yaw in zip(np.linspace(0,10,10), np.linspace(0,0,10), np.linspace(0,np.pi,10))],"
v1.7.0-linux,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.7.0-linux,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=roll, yaw=0.0)) for x, y, roll in zip(np.linspace(0,10,10), np.linspace(1,1,10), np.linspace(0,np.pi,10))],"
v1.7.0-linux,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.7.0-linux,Access an existing light in the world
v1.7.0-linux,Destroy the light
v1.7.0-linux,Create a new light at the same pose
v1.7.0-linux,Change the light's intensity
v1.7.0-linux,asset_name = random.choice(assets)
v1.7.0-linux,Import this module to automatically setup path to local airsim module
v1.7.0-linux,This module first tries to see if airsim module is installed via pip
v1.7.0-linux,If it does then we don't do anything else
v1.7.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.7.0-linux,and if it does then we add that in sys.path
v1.7.0-linux,this class simply tries to see if airsim
v1.7.0-linux,if airsim module is installed then don't do anything else
v1.7.0-linux,import pkgutil
v1.7.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.7.0-linux,if airsim_loader is not None:
v1.7.0-linux,return
v1.7.0-linux,In settings.json first activate computer vision mode:
v1.7.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.7.0-linux,monitor car state while you drive it manually.
v1.7.0-linux,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v1.7.0-linux,denominator from microns^3 to microns * m^2)
v1.7.0-linux,First set everything to 0.
v1.7.0-linux,Next set all objects of interest provided to corresponding object IDs
v1.7.0-linux,segIdDict values MUST match tempEmissivityNew labels.
v1.7.0-linux,"Connect to AirSim, UAV mode."
v1.7.0-linux,Choose temperature values for winter or summer.
v1.7.0-linux,""""""""
v1.7.0-linux,winter
v1.7.0-linux,""""""""
v1.7.0-linux,summer
v1.7.0-linux,Read camera response.
v1.7.0-linux,Calculate radiance.
v1.7.0-linux,Set IDs in AirSim environment.
v1.7.0-linux,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.7.0-linux,save pic
v1.7.0-linux,Change the below dimensions appropriately for the camera settings
v1.7.0-linux,In settings.json first activate computer vision mode:
v1.7.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.7.0-linux,"define abstract class to return next vector in the format (x,y,yaw)"
v1.7.0-linux,"compute vector, distance and angle to goal"
v1.7.0-linux,compute box of interest
v1.7.0-linux,scale by weight matrix (optional)
v1.7.0-linux,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.7.0-linux,detect collision
v1.7.0-linux,compute box of interest
v1.7.0-linux,detect collision
v1.7.0-linux,Same as above but decide to go left or right based on average or some metric like that
v1.7.0-linux,"compute resultant normalized vector, distance and angle"
v1.7.0-linux,compute bounding box size
v1.7.0-linux,convert horizonal fov to vertical fov
v1.7.0-linux,matrix with all ones
v1.7.0-linux,matrix with max weight in center and decreasing linearly with distance from center
v1.7.0-linux,matrix with max weight in center and decreasing quadratically with distance from center
v1.7.0-linux,"print (""Saving images to %s"" % tmp_dir)"
v1.7.0-linux,airsim.wait_key('Press any key to start')
v1.7.0-linux,"Define start position, goal and size of UAV"
v1.7.0-linux,Define parameters and thresholds
v1.7.0-linux,initial position
v1.7.0-linux,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.7.0-linux,time.sleep(1)
v1.7.0-linux,get response
v1.7.0-linux,get numpy array
v1.7.0-linux,reshape array to 2D array H X W
v1.7.0-linux,write to png
v1.7.0-linux,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.7.0-linux,pose = client.simGetPose()
v1.7.0-linux,pp.pprint(pose)
v1.7.0-linux,time.sleep(5)
v1.7.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.7.0-linux,################### OLD CODE
v1.7.0-linux,timer = 0
v1.7.0-linux,time_obs = 50
v1.7.0-linux,bObstacle = False
v1.7.0-linux,if (bObstacle):
v1.7.0-linux,timer = timer + 1
v1.7.0-linux,if timer > time_obs:
v1.7.0-linux,bObstacle = False
v1.7.0-linux,timer = 0
v1.7.0-linux,else:
v1.7.0-linux,yaw = target_angle
v1.7.0-linux,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.7.0-linux,if (np.average(img2d_box) < coll_thres):
v1.7.0-linux,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.7.0-linux,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.7.0-linux,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.7.0-linux,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.7.0-linux,"print('left: ', img2d_box_l_avg)"
v1.7.0-linux,"print('right: ', img2d_box_r_avg)"
v1.7.0-linux,if img2d_box_l_avg > img2d_box_r_avg:
v1.7.0-linux,##Go LEFT
v1.7.0-linux,#y_offset = y_offset-1
v1.7.0-linux,yaw = yaw - radians(10)
v1.7.0-linux,bObstacle = True
v1.7.0-linux,else:
v1.7.0-linux,##Go RIGHT
v1.7.0-linux,#y_offset = y_offset+1
v1.7.0-linux,yaw = yaw + radians(10)
v1.7.0-linux,bObstacle = true
v1.7.0-linux,"print('yaw: ', yaw)"
v1.7.0-linux,In settings.json first activate computer vision mode:
v1.7.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.7.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.7.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.7.0-linux,pip install opencv-python
v1.7.0-linux,Just change the below to test different cameras easily!
v1.7.0-linux,Test Camera info
v1.7.0-linux,Test Image APIs
v1.7.0-linux,Test FoV API
v1.7.0-linux,Test Pose APIs
v1.7.0-linux,Test Distortion params APIs
v1.7.0-linux,In settings.json first activate computer vision mode:
v1.7.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.7.0-linux,In settings.json first activate computer vision mode:
v1.7.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.7.0-linux,for block environment
v1.7.0-linux,regex are case insensitive
v1.7.0-linux,#for neighborhood environment
v1.7.0-linux,set object ID for sky
v1.7.0-linux,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.7.0-linux,get segmentation image in various formats
v1.7.0-linux,save segmentation images in various formats
v1.7.0-linux,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.7.0-linux,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.7.0-linux,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v1.7.0-linux,find unique colors
v1.7.0-linux,In settings.json first activate computer vision mode:
v1.7.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.7.0-linux,objects can be named in two ways:
v1.7.0-linux,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.7.0-linux,default name is auto-generated and varies from run-to-run.
v1.7.0-linux,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.7.0-linux,
v1.7.0-linux,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.7.0-linux,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.7.0-linux,https://answers.unrealengine.com/revisions/790629.html
v1.7.0-linux,below works in Blocks environment
v1.7.0-linux,------------------------------------ Get current pose ------------------------------------------------
v1.7.0-linux,search object by name:
v1.7.0-linux,search another object by tag
v1.7.0-linux,search non-existent object
v1.7.0-linux,------------------------------------ Set new pose ------------------------------------------------
v1.7.0-linux,here we move with teleport enabled so collisions are ignored
v1.7.0-linux,here we move with teleport enabled so collisions are not ignored
v1.7.0-linux,move non-existent object
v1.7.0-linux,------------------------------------ Get new pose ------------------------------------------------
v1.7.0-linux,search another object by tag
v1.7.0-linux,search non-existent object
v1.7.0-linux,Import this module to automatically setup path to local airsim module
v1.7.0-linux,This module first tries to see if airsim module is installed via pip
v1.7.0-linux,If it does then we don't do anything else
v1.7.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.7.0-linux,and if it does then we add that in sys.path
v1.7.0-linux,this class simply tries to see if airsim
v1.7.0-linux,if airsim module is installed then don't do anything else
v1.7.0-linux,import pkgutil
v1.7.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.7.0-linux,if airsim_loader is not None:
v1.7.0-linux,return
v1.7.0-linux,"Roll is applied first, then pitch, then yaw."
v1.7.0-linux,Turn the camera position into a column vector.
v1.7.0-linux,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v1.7.0-linux,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v1.7.0-linux,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v1.7.0-linux,Recreate the perspective projection of the camera.
v1.7.0-linux,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v1.7.0-linux,Set pose and sleep after to ensure the pose sticks before capturing image.
v1.7.0-linux,Capture segmentation (IR) and scene images.
v1.7.0-linux,Change images into numpy arrays.
v1.7.0-linux,Capture images for a certain amount of time in seconds (half hour now)
v1.7.0-linux,Capture image - pose.position x_val access may change w/ AirSim
v1.7.0-linux,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v1.7.0-linux,Convert color scene image to BGR for write out with cv2.
v1.7.0-linux,"Connect to AirSim, UAV mode."
v1.7.0-linux,Look for objects with names that match a regular expression.
v1.7.0-linux,"Sample calls to main, varying camera angle and altitude."
v1.7.0-linux,"straight down, 400ft"
v1.7.0-linux,"straight down, 200ft"
v1.7.0-linux,"45 degrees, 200ft -- note that often object won't be scene since position"
v1.7.0-linux,is set exactly to object's
v1.7.0-linux,"45 degrees, 400ft -- note that often object won't be scene since position"
v1.7.0-linux,is set exactly to object's
v1.7.0-linux,In settings.json first activate computer vision mode:
v1.7.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.7.0-linux,xn = 1 + x*5  # some random number
v1.7.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,monitor car state while you drive it manually.
v1.7.0-linux,get state of the car
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,!/usr/bin/env python3
v1.7.0-linux,-*- coding: utf-8 -*-
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,set the controls for car
v1.7.0-linux,let car drive a bit
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,go forward
v1.7.0-linux,get state of the car
v1.7.0-linux,Python client example to change time-of-day using APIs
v1.7.0-linux,
v1.7.0-linux,Changes time of the day and makes the car move around
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,flip between specific time and default time
v1.7.0-linux,go forward
v1.7.0-linux,Go forward + steer right
v1.7.0-linux,main
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,get state of the car
v1.7.0-linux,go forward
v1.7.0-linux,Go forward + steer right
v1.7.0-linux,go reverse
v1.7.0-linux,apply brakes
v1.7.0-linux,get camera images from the car
v1.7.0-linux,restore to original state
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,go forward
v1.7.0-linux,Python client example to get Lidar data from a car
v1.7.0-linux,
v1.7.0-linux,Makes the drone fly and get Lidar data
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,"print(""state: %s"" % s)"
v1.7.0-linux,go forward
v1.7.0-linux,Go forward + steer right
v1.7.0-linux,"reshape array of floats to array of [X,Y,Z]"
v1.7.0-linux,TODO
v1.7.0-linux,main
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,get state of the car
v1.7.0-linux,go forward
v1.7.0-linux,Go forward + steer right
v1.7.0-linux,go reverse
v1.7.0-linux,apply breaks
v1.7.0-linux,restore to original state
v1.7.0-linux,Sleep for some time to wait for other vehicles to be created
v1.7.0-linux,"driveCar(vehicle_name, client)"
v1.7.0-linux,go forward
v1.7.0-linux,Go forward + steer right
v1.7.0-linux,go reverse
v1.7.0-linux,apply brakes
v1.7.0-linux,Import this module to automatically setup path to local airsim module
v1.7.0-linux,This module first tries to see if airsim module is installed via pip
v1.7.0-linux,If it does then we don't do anything else
v1.7.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.7.0-linux,and if it does then we add that in sys.path
v1.7.0-linux,this class simply tries to see if airsim
v1.7.0-linux,if airsim module is installed then don't do anything else
v1.7.0-linux,import pkgutil
v1.7.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.7.0-linux,if airsim_loader is not None:
v1.7.0-linux,return
v1.7.0-linux,Use below in settings.json with blocks environment
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,get state of the car
v1.7.0-linux,go forward
v1.7.0-linux,go reverse
v1.7.0-linux,apply breaks
v1.7.0-linux,get camera images from the car
v1.7.0-linux,restore to original state
v1.7.0-linux,from keras.models import load_model
v1.7.0-linux,if (len(sys.argv) != 2):
v1.7.0-linux,print('usage: python drive.py <modelName>')
v1.7.0-linux,sys.exit()
v1.7.0-linux,print('Loading model...')
v1.7.0-linux,model = load_model(sys.argv[1])
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.7.0-linux,"model_output = model.predict([image_buf, state_buf])"
v1.7.0-linux,car_controls.steering = float(model_output[0][0])
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,set camera name and image type to request images and detections
v1.7.0-linux,set detection radius in [cm]
v1.7.0-linux,add desired object name to detect in wild card/regex format
v1.7.0-linux,Import this module to automatically setup path to local airsim module
v1.7.0-linux,This module first tries to see if airsim module is installed via pip
v1.7.0-linux,If it does then we don't do anything else
v1.7.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.7.0-linux,and if it does then we add that in sys.path
v1.7.0-linux,this class simply tries to see if airsim
v1.7.0-linux,if airsim module is installed then don't do anything else
v1.7.0-linux,import pkgutil
v1.7.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.7.0-linux,if airsim_loader is not None:
v1.7.0-linux,return
v1.7.0-linux,-*- coding: utf-8 -*-
v1.7.0-linux,
v1.7.0-linux,Configuration file for the Sphinx documentation builder.
v1.7.0-linux,
v1.7.0-linux,This file does only contain a selection of the most common options. For a
v1.7.0-linux,full list see the documentation:
v1.7.0-linux,http://www.sphinx-doc.org/en/master/config
v1.7.0-linux,-- Path setup --------------------------------------------------------------
v1.7.0-linux,"If extensions (or modules to document with autodoc) are in another directory,"
v1.7.0-linux,add these directories to sys.path here. If the directory is relative to the
v1.7.0-linux,"documentation root, use os.path.abspath to make it absolute, like shown here."
v1.7.0-linux,
v1.7.0-linux,-- Project information -----------------------------------------------------
v1.7.0-linux,The short X.Y version
v1.7.0-linux,"The full version, including alpha/beta/rc tags"
v1.7.0-linux,-- General configuration ---------------------------------------------------
v1.7.0-linux,"If your documentation needs a minimal Sphinx version, state it here."
v1.7.0-linux,
v1.7.0-linux,needs_sphinx = '1.0'
v1.7.0-linux,"Add any Sphinx extension module names here, as strings. They can be"
v1.7.0-linux,extensions coming with Sphinx (named 'sphinx.ext.*') or your custom
v1.7.0-linux,ones.
v1.7.0-linux,"Add any paths that contain templates here, relative to this directory."
v1.7.0-linux,The suffix(es) of source filenames.
v1.7.0-linux,You can specify multiple suffix as a list of string:
v1.7.0-linux,
v1.7.0-linux,"source_suffix = ['.rst', '.md']"
v1.7.0-linux,The master toctree document.
v1.7.0-linux,The language for content autogenerated by Sphinx. Refer to documentation
v1.7.0-linux,for a list of supported languages.
v1.7.0-linux,
v1.7.0-linux,This is also used if you do content translation via gettext catalogs.
v1.7.0-linux,"Usually you set ""language"" from the command line for these cases."
v1.7.0-linux,"List of patterns, relative to source directory, that match files and"
v1.7.0-linux,directories to ignore when looking for source files.
v1.7.0-linux,This pattern also affects html_static_path and html_extra_path.
v1.7.0-linux,The name of the Pygments (syntax highlighting) style to use.
v1.7.0-linux,-- Options for HTML output -------------------------------------------------
v1.7.0-linux,The theme to use for HTML and HTML Help pages.  See the documentation for
v1.7.0-linux,a list of builtin themes.
v1.7.0-linux,
v1.7.0-linux,html_theme = 'alabaster'
v1.7.0-linux,Theme options are theme-specific and customize the look and feel of a theme
v1.7.0-linux,"further.  For a list of options available for each theme, see the"
v1.7.0-linux,documentation.
v1.7.0-linux,
v1.7.0-linux,html_theme_options = {}
v1.7.0-linux,"Add any paths that contain custom static files (such as style sheets) here,"
v1.7.0-linux,"relative to this directory. They are copied after the builtin static files,"
v1.7.0-linux,"so a file named ""default.css"" will overwrite the builtin ""default.css""."
v1.7.0-linux,"Custom sidebar templates, must be a dictionary that maps document names"
v1.7.0-linux,to template names.
v1.7.0-linux,
v1.7.0-linux,The default sidebars (for documents that don't match any pattern) are
v1.7.0-linux,defined by theme itself.  Builtin themes are using these templates by
v1.7.0-linux,"default: ``['localtoc.html', 'relations.html', 'sourcelink.html',"
v1.7.0-linux,'searchbox.html']``.
v1.7.0-linux,
v1.7.0-linux,html_sidebars = {}
v1.7.0-linux,-- Options for HTMLHelp output ---------------------------------------------
v1.7.0-linux,Output file base name for HTML help builder.
v1.7.0-linux,-- Options for LaTeX output ------------------------------------------------
v1.7.0-linux,The paper size ('letterpaper' or 'a4paper').
v1.7.0-linux,
v1.7.0-linux,"'papersize': 'letterpaper',"
v1.7.0-linux,"The font size ('10pt', '11pt' or '12pt')."
v1.7.0-linux,
v1.7.0-linux,"'pointsize': '10pt',"
v1.7.0-linux,Additional stuff for the LaTeX preamble.
v1.7.0-linux,
v1.7.0-linux,"'preamble': '',"
v1.7.0-linux,Latex figure (float) alignment
v1.7.0-linux,
v1.7.0-linux,"'figure_align': 'htbp',"
v1.7.0-linux,Grouping the document tree into LaTeX files. List of tuples
v1.7.0-linux,"(source start file, target name, title,"
v1.7.0-linux,"author, documentclass [howto, manual, or own class])."
v1.7.0-linux,-- Options for manual page output ------------------------------------------
v1.7.0-linux,One entry per manual page. List of tuples
v1.7.0-linux,"(source start file, name, description, authors, manual section)."
v1.7.0-linux,-- Options for Texinfo output ----------------------------------------------
v1.7.0-linux,Grouping the document tree into Texinfo files. List of tuples
v1.7.0-linux,"(source start file, target name, title, author,"
v1.7.0-linux,"dir menu entry, description, category)"
v1.7.0-linux,-- Options for Epub output -------------------------------------------------
v1.7.0-linux,Bibliographic Dublin Core info.
v1.7.0-linux,The unique identifier of the text. This can be a ISBN number
v1.7.0-linux,or the project homepage.
v1.7.0-linux,
v1.7.0-linux,epub_identifier = ''
v1.7.0-linux,A unique identification for the text.
v1.7.0-linux,
v1.7.0-linux,epub_uid = ''
v1.7.0-linux,A list of files that should not be packed into the epub file.
v1.7.0-linux,-- Extension configuration -------------------------------------------------
v1.7.0-linux,-- Options for intersphinx extension ---------------------------------------
v1.7.0-linux,Example configuration for intersphinx: refer to the Python standard library.
v1.7.0-linux,-- Options for todo extension ----------------------------------------------
v1.7.0-linux,"If true, `todo` and `todoList` produce output, else they produce nothing."
v1.7.0-linux,We ignore the 2D nature of the problem as it is not relevant here
v1.7.0-linux,It makes multi-core processing more straightforward
v1.7.0-linux,Allocations
v1.7.0-linux,Add small number to avoid issues with log(I)
v1.7.0-linux,Event sim keeps track of previous image automatically
v1.7.0-linux,"Using pickle dump in a per-frame fashion to save time, instead of savetxt"
v1.7.0-linux,Optimizations possible
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,that's enough fun for now. let's quit cleanly
v1.7.0-linux,"Python client example to get Lidar data from a drone, although this script works for any AirSim-supported vehicle"
v1.7.0-linux,This script is for Lidar sensors using 'SensorLocalFrame' as DataFrame under settings.json.
v1.7.0-linux,Sample settings.json used for this script:
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,main
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,MultirotorClient.wait_key('Press any key to takeoff')
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,get camera images from the car
v1.7.0-linux,that's enough fun for now. let's quit cleanly
v1.7.0-linux,##################################################################################################
v1.7.0-linux,
v1.7.0-linux,Project:  Embedded Learning Library (ELL)
v1.7.0-linux,File:     speaker.py
v1.7.0-linux,Authors:  Chris Lovett
v1.7.0-linux,
v1.7.0-linux,Requires: Python 3.x
v1.7.0-linux,
v1.7.0-linux,##################################################################################################
v1.7.0-linux,open speakers so we can hear what it is processing...
v1.7.0-linux,teleport the drone + 10 meters in x-direction
v1.7.0-linux,teleport the drone back
v1.7.0-linux,This example shows how to use the External Physics Engine
v1.7.0-linux,It allows you to control the drone through setVehiclePose and obtain collision information.
v1.7.0-linux,It is especially useful for injecting your own flight dynamics model to the AirSim drone.
v1.7.0-linux,Use Blocks environment to see the drone colliding and seeing the collision information
v1.7.0-linux,in the command prompt.
v1.7.0-linux,Add this line to your settings.json before running AirSim:
v1.7.0-linux,"""PhysicsEngineName"":""ExternalPhysicsEngine"""
v1.7.0-linux,use open cv to create point cloud from depth image.
v1.7.0-linux,###########################################
v1.7.0-linux,######### This is work in progress! #######
v1.7.0-linux,###########################################
v1.7.0-linux,file will be saved in PythonClient folder (i.e. same folder as script)
v1.7.0-linux,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.7.0-linux,skip it
v1.7.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.7.0-linux,z of -7 is 7 meters above the original launch point.
v1.7.0-linux,Fly given velocity vector for 5 seconds
v1.7.0-linux,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.7.0-linux,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.7.0-linux,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.7.0-linux,Make the drone fly in a circle.
v1.7.0-linux,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.7.0-linux,check that our home position is stable
v1.7.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.7.0-linux,ramp up time
v1.7.0-linux,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.7.0-linux,compute current angle
v1.7.0-linux,compute lookahead
v1.7.0-linux,if we did the takeoff then also do the landing.
v1.7.0-linux,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.7.0-linux,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.7.0-linux,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.7.0-linux,ignore the click over from 360 back to 0
v1.7.0-linux,watch direction this diff is moving if it switches from shrinking to growing
v1.7.0-linux,then we passed the starting point.
v1.7.0-linux,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.7.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.7.0-linux,z of -5 is 5 meters above the original launch point.
v1.7.0-linux,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.7.0-linux,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.7.0-linux,drone will over-shoot so we bring it back to the start point before landing.
v1.7.0-linux,"Python client example to get Lidar data from a drone, although this script works for any AirSim-supported vehicle"
v1.7.0-linux,This script is for Lidar sensors using 'VehicleInertialFrame' as DataFrame under settings.json
v1.7.0-linux,Sample settings.json used for this script:
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,main
v1.7.0-linux,Run this script with clock speed in settings.json
v1.7.0-linux,"""ClockSpeed"": 1 then change it to 0.5"
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,with ClockSpeed = 0.5 you will see that this takes 6s (system time) and not 3s
v1.7.0-linux,with ClockSpeed = 0.5 you will see that this takes 10s (system time)
v1.7.0-linux,and not 5s in each iteration
v1.7.0-linux,that's enough fun for now. let's quit cleanly
v1.7.0-linux,Takeoff or hover
v1.7.0-linux,Set wind to 0
v1.7.0-linux,Takeoff or hover
v1.7.0-linux,In settings.json first activate computer vision mode:
v1.7.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.7.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.7.0-linux,pip install opencv-python
v1.7.0-linux,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.7.0-linux,fly for 2 minutes
v1.7.0-linux,more than 50 centimeter drift is unacceptable.
v1.7.0-linux,Python client example to get Lidar data from a drone
v1.7.0-linux,
v1.7.0-linux,Makes the drone fly and get Lidar data
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,"print(""state: %s"" % s)"
v1.7.0-linux,"print(""state: %s"" % pprint.pformat(state))"
v1.7.0-linux,"reshape array of floats to array of [X,Y,Z]"
v1.7.0-linux,TODO
v1.7.0-linux,main
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.7.0-linux,let it settle there a bit.
v1.7.0-linux,after hovering we need to re-enabled api control for next leg of the trip
v1.7.0-linux,now compute the survey path required to fill the box
v1.7.0-linux,##################################################################################################
v1.7.0-linux,
v1.7.0-linux,Project:  Embedded Learning Library (ELL)
v1.7.0-linux,File:     wav_reader.py
v1.7.0-linux,Authors:  Chris Lovett
v1.7.0-linux,
v1.7.0-linux,Requires: Python 3.x
v1.7.0-linux,
v1.7.0-linux,##################################################################################################
v1.7.0-linux,open a stream on the audio input file.
v1.7.0-linux,"assumes signed integer used in raw audio, so for example, the max for 16bit is 2^15 (32768)"
v1.7.0-linux,convert int16 data to scaled floats
v1.7.0-linux,configure output stream to match what we are resampling to...
v1.7.0-linux,convert the audio to the desired recording rate
v1.7.0-linux,split into separate channels
v1.7.0-linux,drop the channels we don't want
v1.7.0-linux,zip the resulting channels back up.
v1.7.0-linux,convert back to packed bytes in PCM 16 format
v1.7.0-linux,"deal with any accumulation of tails, if the tail grows to a full"
v1.7.0-linux,buffer then return it!
v1.7.0-linux,"we have a tail from previous frame, so prepend it"
v1.7.0-linux,"now the caller needs us to stick to our sample_size contract, but when"
v1.7.0-linux,rate conversion happens we can't be sure that 'data' is exactly that size.
v1.7.0-linux,usually one byte extra so add this to our accumulating tail
v1.7.0-linux,"might have reached the end of a file, so pad with zeros."
v1.7.0-linux,"Please add ""EnableTrace"": true to your setting.json as shown below"
v1.7.0-linux,{
v1.7.0-linux,"""SettingsVersion"": 1.2,"
v1.7.0-linux,"""SimMode"": ""Multirotor"","
v1.7.0-linux,"""Vehicles"": {"
v1.7.0-linux,"""Drone"": {"
v1.7.0-linux,"""VehicleType"": ""SimpleFlight"","
v1.7.0-linux,"""EnableTrace"": true"
v1.7.0-linux,}
v1.7.0-linux,}
v1.7.0-linux,}
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,add new vehicle
v1.7.0-linux,Use below in settings.json with Blocks environment
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,get camera images from the car
v1.7.0-linux,that's enough fun for now. let's quit cleanly
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,Import this module to automatically setup path to local airsim module
v1.7.0-linux,This module first tries to see if airsim module is installed via pip
v1.7.0-linux,If it does then we don't do anything else
v1.7.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.7.0-linux,and if it does then we add that in sys.path
v1.7.0-linux,this class simply tries to see if airsim
v1.7.0-linux,if airsim module is installed then don't do anything else
v1.7.0-linux,import pkgutil
v1.7.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.7.0-linux,if airsim_loader is not None:
v1.7.0-linux,return
v1.7.0-linux,"this script moves the drone to a location, then rests it thousands of time"
v1.7.0-linux,purpose of this script is to stress test reset API
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,that's enough fun for now. let's quite cleanly
v1.7.0-linux,For high speed ascent and descent on PX4 you may need to set these properties:
v1.7.0-linux,param set MPC_Z_VEL_MAX_UP 5
v1.7.0-linux,param set MPC_Z_VEL_MAX_DN 5
v1.7.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.7.0-linux,z of -50 is 50 meters above the original launch point.
v1.7.0-linux,use open cv to show new images from AirSim
v1.7.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.7.0-linux,pip install opencv-python
v1.7.0-linux,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.7.0-linux,get depth image
v1.7.0-linux,"this will return png width= 256, height= 144"
v1.7.0-linux,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.7.0-linux,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.7.0-linux,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.7.0-linux,to get an estimate of distance.
v1.7.0-linux,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.7.0-linux,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.7.0-linux,an angular delta of the following pi/10.
v1.7.0-linux,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.7.0-linux,Remove alpha channel if exists
v1.7.0-linux,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.7.0-linux,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.7.0-linux,Flatten and yield as tuple
v1.7.0-linux,Initialize a resizable dataset to hold the output
v1.7.0-linux,Resize the dataset to accommodate the next chunk of rows
v1.7.0-linux,Create the next chunk
v1.7.0-linux,Increment the row count
v1.7.0-linux,Arguments
v1.7.0-linux,Returns
v1.7.0-linux,use composition of homographies
v1.7.0-linux,to generate final transform that needs to be applied
v1.7.0-linux,Arguments
v1.7.0-linux,Returns
v1.7.0-linux,Keeps under lock only the mechanism which advances
v1.7.0-linux,the indexing of each batch.
v1.7.0-linux,The transformation of images is not under thread lock
v1.7.0-linux,so it can be done in parallel
v1.7.0-linux,Trained model path
v1.7.0-linux,Connect to AirSim
v1.7.0-linux,Start driving
v1.7.0-linux,Initialize image buffer
v1.7.0-linux,Update throttle value according to steering angle
v1.7.0-linux,Prediction
v1.7.0-linux,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.7.0-linux,Print progress
v1.7.0-linux,Update next car state
v1.7.0-linux,Wait a bit between iterations
v1.7.0-linux,%matplotlib inline
v1.7.0-linux,chunk size for training batches
v1.7.0-linux,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.7.0-linux,Point this to the directory containing the raw data
v1.7.0-linux,Point this to the desired output directory for the cooked (.h5) data
v1.7.0-linux,Choose The folders to search for data under RAW_DATA_DIR
v1.7.0-linux,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.7.0-linux,data_folder.append('folder_name1')
v1.7.0-linux,data_folder.append('folder_name2')
v1.7.0-linux,...
v1.7.0-linux,Hyper-parameters
v1.7.0-linux,Activation functions
v1.7.0-linux,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.7.0-linux,<< The directory containing the cooked data from the previous step >>
v1.7.0-linux,<< The directory in which the model output will be placed >>
v1.7.0-linux,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.7.0-linux,Network definition
v1.7.0-linux,Import this module to automatically setup path to local airsim module
v1.7.0-linux,This module first tries to see if airsim module is installed via pip
v1.7.0-linux,If it does then we don't do anything else
v1.7.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.7.0-linux,and if it does then we add that in sys.path
v1.7.0-linux,this class simply tries to see if airsim
v1.7.0-linux,if airsim module is installed then don't do anything else
v1.7.0-linux,import pkgutil
v1.7.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.7.0-linux,if airsim_loader is not None:
v1.7.0-linux,return
v1.7.0-linux,DEY: I don't know why this was there.
v1.7.0-linux,----------------------------------- Common vehicle APIs ---------------------------------------------
v1.7.0-linux,basic flight control
v1.7.0-linux,time-of-day control
v1.7.0-linux,time - of - day control
v1.7.0-linux,weather
v1.7.0-linux,camera control
v1.7.0-linux,simGetImage returns compressed png in array of bytes
v1.7.0-linux,image_type uses one of the ImageType members
v1.7.0-linux,"todo : in future remove below, it's only for compatibility to pre v1.2"
v1.7.0-linux,"because this method returns std::vector < uint8>, msgpack decides to encode it as a string unfortunately."
v1.7.0-linux,camera control
v1.7.0-linux,simGetImage returns compressed png in array of bytes
v1.7.0-linux,image_type uses one of the ImageType members
v1.7.0-linux,CinemAirSim
v1.7.0-linux,End CinemAirSim
v1.7.0-linux,gets the static meshes in the unreal scene
v1.7.0-linux,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.7.0-linux,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.7.0-linux,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.7.0-linux,sensor APIs
v1.7.0-linux,Plotting APIs
v1.7.0-linux,Recording APIs
v1.7.0-linux,Add new vehicle via RPC
v1.7.0-linux,----------------------------------- Multirotor APIs ---------------------------------------------
v1.7.0-linux,APIs for control
v1.7.0-linux,low - level control API
v1.7.0-linux,query vehicle state
v1.7.0-linux,query rotor states
v1.7.0-linux,----------------------------------- Car APIs ---------------------------------------------
v1.7.0-linux,helper method for converting getOrientation to roll/pitch/yaw
v1.7.0-linux,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.7.0-linux,roll (x-axis rotation)
v1.7.0-linux,pitch (y-axis rotation)
v1.7.0-linux,yaw (z-axis rotation)
v1.7.0-linux,DEY: I don't know why this was there.
v1.7.0-linux,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.7.0-linux,return cls(**msgpack.unpack(encoded))
v1.7.0-linux,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.7.0-linux,Create a DummyVecEnv for main airsim gym env
v1.7.0-linux,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.7.0-linux,Initialize RL algorithm type and parameters
v1.7.0-linux,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.7.0-linux,Train for a certain number of timesteps
v1.7.0-linux,Save policy weights
v1.7.0-linux,Create a DummyVecEnv for main airsim gym env
v1.7.0-linux,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.7.0-linux,Initialize RL algorithm type and parameters
v1.7.0-linux,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.7.0-linux,Train for a certain number of timesteps
v1.7.0-linux,Save policy weights
v1.7.0-linux,Import this module to automatically setup path to local airsim module
v1.7.0-linux,This module first tries to see if airsim module is installed via pip
v1.7.0-linux,If it does then we don't do anything else
v1.7.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.7.0-linux,and if it does then we add that in sys.path
v1.7.0-linux,this class simply tries to see if airsim
v1.7.0-linux,if airsim module is installed then don't do anything else
v1.7.0-linux,import pkgutil
v1.7.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.7.0-linux,if airsim_loader is not None:
v1.7.0-linux,return
v1.7.0-linux,Set home position and velocity
v1.7.0-linux,print(dist)
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,"This is a bit crude, but give it a moment to settle on the ground, else takeoff will fail"
v1.7.0-linux,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.7.0-linux,switch to explicit hover mode so that this is the fallback when
v1.7.0-linux,move* commands are finished.
v1.7.0-linux,"Altitude difference between each platform, in meters"
v1.7.0-linux,"Count down, so the first one can easily go the highest (without knowing count)"
v1.7.0-linux,"in header only mode, control library is not available"
v1.7.0-linux,if using Unreal Build system then include precompiled header file first
v1.7.0-linux,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.7.0-linux,"Windows, OSX and Linux."
v1.7.0-linux,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.7.0-linux,Windows users can move the Documents folder to any location they want
v1.7.0-linux,SHGetFolderPath knows how to find it.
v1.7.0-linux,fall back in case SHGetFolderPath failed for some reason.
v1.7.0-linux,convert from std::path '/' to windows backslash.
v1.7.0-linux,make the current thread run with maximum priority.
v1.7.0-linux,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.7.0-linux,TODO: How to handle POSIX thread priorities on OSX?
v1.7.0-linux,setThreadName is a helper function that is useful when debugging because your threads
v1.7.0-linux,show up in the debugger with the name you set which makes it easier to find the threads
v1.7.0-linux,that you are interested in.
v1.7.0-linux,"unfortunately this is only available on Windows 10, and AirSim is not limited to that."
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.7.0-linux,
v1.7.0-linux,Treat all errors as failure conditions.
v1.7.0-linux,parse command line
v1.7.0-linux,"motive gives a weird error if the project is not found, so we look for it."
v1.7.0-linux,Do an update to pick up any recently-arrived cameras.
v1.7.0-linux,List all detected cameras.
v1.7.0-linux,List all defined rigid bodies.
v1.7.0-linux,throttle to 50 messages per second.
v1.7.0-linux,OptiTrack uses 'y' axis for vertical.
v1.7.0-linux,stdafx.cpp : source file that includes just the standard includes
v1.7.0-linux,MavlinkMoCap.pch will be the pre-compiled header
v1.7.0-linux,stdafx.obj will contain the pre-compiled type information
v1.7.0-linux,TODO: reference any additional headers you need in STDAFX.H
v1.7.0-linux,and not in this file
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,PX4.cpp : Defines the entry point for the console application.
v1.7.0-linux,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.7.0-linux,how do you write to the debug output windows on Unix ?
v1.7.0-linux,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.7.0-linux,connection to create to talke to that server.
v1.7.0-linux,SITL setup info
v1.7.0-linux,The local ethernet interface to use (default localhost).
v1.7.0-linux,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.7.0-linux,server mode on UDP is when you want another app to connect to Pixhawk and publish data back to this process.
v1.7.0-linux,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.7.0-linux,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.7.0-linux,"using their the -qgc option.  Server mode on TCP means mavlinktest will do an ""accept"" socket which is"
v1.7.0-linux,what PX4 is waiting for when it is running in TCP mode.  Here the serverEndPoint is different from the
v1.7.0-linux,offboardEndPoint.  The serverEndPoint specifies which local address to use in case your computer has
v1.7.0-linux,multiple network interfaces.
v1.7.0-linux,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.7.0-linux,this switch controls whether we turn off the RC remote active link loss detection
v1.7.0-linux,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.7.0-linux,from kicking in when you try and fly.
v1.7.0-linux,parse the json
v1.7.0-linux,flatten inner mavlink object
v1.7.0-linux,flatten inner mavlink object
v1.7.0-linux,todo
v1.7.0-linux,todo
v1.7.0-linux,"const char* outLogFileOption = ""outlogfile"";"
v1.7.0-linux,parse command line
v1.7.0-linux,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.7.0-linux,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.7.0-linux,"no local serial connection, so this is the primary droneConnection."
v1.7.0-linux,need a retry loop here because we don't know how quickly px4 will start accepting these connections...
v1.7.0-linux,failed to connect
v1.7.0-linux,"then we need 2 mavlink channels, one for sending/receiving HIL_* messages and the other"
v1.7.0-linux,for controlling the drone.
v1.7.0-linux,this is the control channel.
v1.7.0-linux,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.7.0-linux,cmdTable.push_back(new AltHoldCommand());
v1.7.0-linux,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.7.0-linux,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.7.0-linux,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.7.0-linux,this stops us from being able to connect to SITL mode PX4.
v1.7.0-linux,checkPulse();
v1.7.0-linux,add command text in log
v1.7.0-linux,close previous command.
v1.7.0-linux,FilterLogFiles(logDirectory);
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,send a heartbeat
v1.7.0-linux,accept one incoming connection
v1.7.0-linux,send a heartbeat to the client
v1.7.0-linux,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.7.0-linux,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.7.0-linux,for this unit test we are expecting a request to send an image.
v1.7.0-linux,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.7.0-linux,hmmm
v1.7.0-linux,================ ls
v1.7.0-linux,================ put file
v1.7.0-linux,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.7.0-linux,================ get file
v1.7.0-linux,verify the file contents.
v1.7.0-linux,================ remove file
v1.7.0-linux,================ make directory
v1.7.0-linux,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.7.0-linux,================ remove directory
v1.7.0-linux,Now verification
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,you must call this method if you want HandleMessage to be called subsequently.
v1.7.0-linux,treat literals as one word
v1.7.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.7.0-linux,request gps info
v1.7.0-linux,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.7.0-linux,find relative position since command start so we can compare two commands better
v1.7.0-linux,"these PID values are important, so set these to match"
v1.7.0-linux,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.7.0-linux,we can skip ahead.
v1.7.0-linux,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.7.0-linux,TODO: avoid passing hadcoded HIL flag
v1.7.0-linux,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.7.0-linux,"The global position, as returned by the Global Positioning System (GPS)."
v1.7.0-linux,Provides state for additional features
v1.7.0-linux,The general system state
v1.7.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.7.0-linux,Provides state for additional features
v1.7.0-linux,The general system state
v1.7.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.7.0-linux,Provides state for additional features
v1.7.0-linux,The general system state
v1.7.0-linux,Provides state for additional features
v1.7.0-linux,The general system state
v1.7.0-linux,note: we do not reset com when Close() is called because we want to keep running.
v1.7.0-linux,"user has to invoke ""hil stop"" to stop the hil thread."
v1.7.0-linux,generate random between 0 and 1
v1.7.0-linux,move to range -1 to 1
v1.7.0-linux,scale it
v1.7.0-linux,apply iy
v1.7.0-linux,wait for the Execute method to be called.
v1.7.0-linux,gps is much slower frequency than IMU.
v1.7.0-linux,MAVLINK_MSG_ID_HIL_GPS
v1.7.0-linux,disable MAV_USEHILGPS
v1.7.0-linux,note: we do not reset com when Close() is called because we want to keep running.
v1.7.0-linux,"user has to invoke ""hil stop"" to stop the hil thread."
v1.7.0-linux,generate random between 0 and 1
v1.7.0-linux,move to range -1 to 1
v1.7.0-linux,scale it
v1.7.0-linux,apply iy
v1.7.0-linux,wait for the Execute method to be called.
v1.7.0-linux,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.7.0-linux,gps is much slower frequency than IMU.
v1.7.0-linux,MAVLINK_MSG_ID_HIL_GPS
v1.7.0-linux,disable HIL mode
v1.7.0-linux,Enumeration of landed detector states
v1.7.0-linux,MAV landed state is unknown
v1.7.0-linux,MAV is landed (on ground)
v1.7.0-linux,MAV is in air
v1.7.0-linux,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.7.0-linux,The filtered local position
v1.7.0-linux,must send these regularly to keep offboard control.
v1.7.0-linux,"ok, now we can safely switch to loiter."
v1.7.0-linux,must send these regularly to keep offboard control.
v1.7.0-linux,integrate the heading so it is smoother.
v1.7.0-linux,must send these regularly to keep offboard control.
v1.7.0-linux,integrate the heading so it is smoother.
v1.7.0-linux,fly to radius
v1.7.0-linux,it takes about 10 cm to stop and turn.
v1.7.0-linux,next time around switch to orbiting!
v1.7.0-linux,heading points to center of circle.
v1.7.0-linux,interpoloate the speed ramp up time over 2 seconds from start time
v1.7.0-linux,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.7.0-linux,monitor the sin curves so we can see how on track or off track it actually is.
v1.7.0-linux,the shape of the curve will also tell us if we are progressing at a consistent
v1.7.0-linux,"speed, the more deformed the sin curve the worse our progress."
v1.7.0-linux,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.7.0-linux,degrees just flipped from 359 to 0.
v1.7.0-linux,this enables us to test what happens when offboard control is lost and resumed.
v1.7.0-linux,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.7.0-linux,"ok, now we can start moving by velocity"
v1.7.0-linux,recompute to new target.
v1.7.0-linux,start by moving right with 10 degree roll.
v1.7.0-linux,haven't started yet.
v1.7.0-linux,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.7.0-linux,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.7.0-linux,track how our actual pitch is coming along compared to our target
v1.7.0-linux,and check position
v1.7.0-linux,the amount of pitch should depend on our speed in that direction.
v1.7.0-linux,passed the midpoint.
v1.7.0-linux,fade out the pitch as we pick up speed so we don't overshoot.
v1.7.0-linux,see if we just crossed the wiggle distance threshold.
v1.7.0-linux,(pitch affects the x-position).
v1.7.0-linux,reverse direction with a -30 degrees quick stop
v1.7.0-linux,reverse direction with a 30 degrees quick stop
v1.7.0-linux,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.7.0-linux,too much in that direction.
v1.7.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.7.0-linux,track how our actual roll is coming along compared to our target
v1.7.0-linux,and check position
v1.7.0-linux,the amount of roll should depend on our speed in that direction.
v1.7.0-linux,passed the midpoint.
v1.7.0-linux,fade out the roll as we pick up speed so we don't overshoot.
v1.7.0-linux,see if we just crossed the wiggle distance threshold.
v1.7.0-linux,(roll affects the y-position).
v1.7.0-linux,reverse direction with a -30 degrees quick stop
v1.7.0-linux,reverse direction with a 30 degrees quick stop
v1.7.0-linux,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.7.0-linux,too much in that direction.
v1.7.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.7.0-linux,for testing PID controller.
v1.7.0-linux,class AltHoldCommand : public Command
v1.7.0-linux,{
v1.7.0-linux,std::shared_ptr<MavLinkVehicle> channel;
v1.7.0-linux,"float sx_, sy_, sz_;"
v1.7.0-linux,MavLinkAttitudeTarget _current;
v1.7.0-linux,PidController thrust_controller_;
v1.7.0-linux,public:
v1.7.0-linux,this->sz_ = pos.z; // user defined target.
v1.7.0-linux,move to local position keeps the offboard control happy.
v1.7.0-linux,haven't started yet.
v1.7.0-linux,and check position
v1.7.0-linux,double dx = this->sx_ - pos.x;
v1.7.0-linux,double dy = this->sy_ - pos.y;
v1.7.0-linux,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.7.0-linux,too much in that direction.
v1.7.0-linux,adjust thrust so we keep steady height target
v1.7.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.7.0-linux,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.7.0-linux,local remote
v1.7.0-linux,already handled by the parse method.
v1.7.0-linux,we only support very simple patterns for now.
v1.7.0-linux,each wildcard must be separated by literal.
v1.7.0-linux,back to back wildcards with no literal in between is too complex.
v1.7.0-linux,"we only support simple matching for now, we can add full regex later if we need it."
v1.7.0-linux,yep!
v1.7.0-linux,'*' is done we found the next matching char
v1.7.0-linux,this is ok.
v1.7.0-linux,this is an ERASE_END_LINE command which we ignore.
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,pack the payload buffer.
v1.7.0-linux,calculate checksum
v1.7.0-linux,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.7.0-linux,are variable length as a result.
v1.7.0-linux,form the header as a byte array for the crc
v1.7.0-linux,unpack the message...
v1.7.0-linux,pack the payload buffer.
v1.7.0-linux,"json can't handle ""nan"", so we convert it to null."
v1.7.0-linux,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.7.0-linux,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,start listening to this connection
v1.7.0-linux,Send heartbeat to drone.  You should not do this if some other node is
v1.7.0-linux,already doing it.
v1.7.0-linux,stop listening to the connection.
v1.7.0-linux,get the connection
v1.7.0-linux,Get the local system and component id
v1.7.0-linux,send a command to the remote node
v1.7.0-linux,MavLinkNode::MavLinkNode() = default;
v1.7.0-linux,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.7.0-linux,decrementing the count so the next WaitOne may block.
v1.7.0-linux,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.7.0-linux,convert to absolute time.
v1.7.0-linux,use mach_timespec
v1.7.0-linux,convert to absolute time.
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,return true if we still have offboard control (can lose this if user flips the switch).
v1.7.0-linux,MavLinkVehicle::MavLinkVehicle() = default;
v1.7.0-linux,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.7.0-linux,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,============================== CLIENT ============================================
v1.7.0-linux,image APIs
v1.7.0-linux,or if you are implementing the client side call this function to get the most recent frame.
v1.7.0-linux,returns false if there is no new frame available.
v1.7.0-linux,============================== SERVER ============================================
v1.7.0-linux,call this to send the image back over the connection given to start function.
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,"log every message that is ""sent"" using sendMessage."
v1.7.0-linux,"log every message that is ""received"""
v1.7.0-linux,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.7.0-linux,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.7.0-linux,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.7.0-linux,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,for compatibility with QGroundControl we have to save the time field in big endian.
v1.7.0-linux,todo: mavlink2 support?
v1.7.0-linux,has to be one or the other!
v1.7.0-linux,24 bits.
v1.7.0-linux,24 bits.
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,start listening to this connection
v1.7.0-linux,Send heartbeat to drone.  You should not do this if some other node is
v1.7.0-linux,already doing it.
v1.7.0-linux,this is called for all messages received on the connection.
v1.7.0-linux,"we received a heartbeat, so let's get the capabilities."
v1.7.0-linux,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.7.0-linux,subclasses remembering to call this base implementation.
v1.7.0-linux,stop listening to the connection.
v1.7.0-linux,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.7.0-linux,wait for a heartbeat msg since this will give us the port to send commands to...
v1.7.0-linux,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.7.0-linux,send a heart beat so that the remote node knows we are still alive
v1.7.0-linux,(otherwise drone will trigger a failsafe operation).
v1.7.0-linux,ignore any failures here because we are running in our own thread here.
v1.7.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.7.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.7.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.7.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.7.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.7.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.7.0-linux,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.7.0-linux,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.7.0-linux,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.7.0-linux,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.7.0-linux,"ok, now fetch the missing parameters."
v1.7.0-linux,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.7.0-linux,silently fail since we are on a background thread here...
v1.7.0-linux,tell the caller this is complete.
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,add our custom telemetry message length.
v1.7.0-linux,todo: if we support signing then initialize
v1.7.0-linux,mavlink_intermediate_status_.signing callbacks
v1.7.0-linux,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.7.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.7.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.7.0-linux,send this right away just in case serial link is not already configured
v1.7.0-linux,"log every message that is ""sent"" using sendMessage."
v1.7.0-linux,"log every message that is ""sent"" using sendMessage."
v1.7.0-linux,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.7.0-linux,pack the payload buffer.
v1.7.0-linux,calculate checksum
v1.7.0-linux,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.7.0-linux,are variable length as a result.
v1.7.0-linux,form the header as a byte array for the crc
v1.7.0-linux,these macros use old style cast.
v1.7.0-linux,forward messages from our connected node to the remote proxy.
v1.7.0-linux,tell the remote connection to expect mavlink2 messages.
v1.7.0-linux,forward messages from remote proxy to local connected node
v1.7.0-linux,CurrentThread::setMaximumPriority();
v1.7.0-linux,"hmmm, wait till it is opened?"
v1.7.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.7.0-linux,pick up the sysid/compid of the remote node we are connected to.
v1.7.0-linux,then this is a mavlink 1 message
v1.7.0-linux,then this mavlink sender supports mavlink 2
v1.7.0-linux,queue event for publishing.
v1.7.0-linux,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.7.0-linux,as it ensures we don't lose messages if the listener is slow.
v1.7.0-linux,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.7.0-linux,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.7.0-linux,we would get a deadlock.
v1.7.0-linux,CurrentThread::setMaximumPriority();
v1.7.0-linux,reset counters
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,------------------------------------------------------------------------------
v1.7.0-linux,Defines
v1.7.0-linux,------------------------------------------------------------------------------
v1.7.0-linux,bit number  876543210987654321
v1.7.0-linux,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.7.0-linux,in future it would be good to have ability to add system IDs we are interested in
v1.7.0-linux,if (msg.sysid != getTargetSystemId())
v1.7.0-linux,{
v1.7.0-linux,// we only care about messages from our intended remote node.
v1.7.0-linux,return;
v1.7.0-linux,}
v1.7.0-linux,user may have changed modes on us! So we need to honor that and not
v1.7.0-linux,try and take it back.
v1.7.0-linux,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.7.0-linux,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.7.0-linux,we can store up to 16 channels in rc_channels_scaled.
v1.7.0-linux,The RAW values of the servo outputs
v1.7.0-linux,Metrics typically displayed on a HUD for fixed wing aircraft
v1.7.0-linux,The IMU readings in SI units in NED body frame
v1.7.0-linux,printSystemStatus(&msg);
v1.7.0-linux,todo: use this to determine when we need to do emergency landing...
v1.7.0-linux,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.7.0-linux,Provides state for additional features
v1.7.0-linux,The general system state
v1.7.0-linux,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.7.0-linux,but we do want to know when we get the ack.  So this is async ACK processing!
v1.7.0-linux,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.7.0-linux,if threshold < 0 then the threshold is inverted.
v1.7.0-linux,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.7.0-linux,Convert it to a floating point number between -1 and 1.
v1.7.0-linux,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.7.0-linux,until the move commands start happening.
v1.7.0-linux,return true if user calls requestControl and has not called releaseControl.
v1.7.0-linux,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.7.0-linux,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.7.0-linux,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.7.0-linux,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.7.0-linux,send a few to make sure it gets through...
v1.7.0-linux,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.7.0-linux,us by which time the PX4 times out offboard mode!!
v1.7.0-linux,"assume this was successful, we'll find out if so in the next heartbeat."
v1.7.0-linux,this mode change take precedence over offboard mode.
v1.7.0-linux,thrust must be between -1 and 1.
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,These definitions are copied from PX4 implementation
v1.7.0-linux,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.7.0-linux,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.7.0-linux,/ @brief Command opcodes
v1.7.0-linux,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.7.0-linux,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.7.0-linux,must trim trailing slashes so PX4 doesn't hang!
v1.7.0-linux,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.7.0-linux,from the source.
v1.7.0-linux,check if directory exists.
v1.7.0-linux,perfect.
v1.7.0-linux,use last_message_ so we preserve the sessionid.
v1.7.0-linux,"could not create the local file, so stop."
v1.7.0-linux,must use last_message_ so we preserve the session id.
v1.7.0-linux,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.7.0-linux,todo: error handling here? sequence is out of order...
v1.7.0-linux,"directory must be empty then, can't do nextStep because"
v1.7.0-linux,it will just loop for ever re-requesting zero offset into
v1.7.0-linux,empty directory.
v1.7.0-linux,result should be a list of null terminated file names.
v1.7.0-linux,skipping this entry
v1.7.0-linux,remove the file size field.
v1.7.0-linux,"printf(""%s\n"", name.c_str());"
v1.7.0-linux,request the next batch.
v1.7.0-linux,"perhaps this was a late response after we did a retry, so ignore it."
v1.7.0-linux,"perhaps this was a late response after we did a retry, so ignore it."
v1.7.0-linux,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.7.0-linux,reached the end of the list or the file.
v1.7.0-linux,end of file or directory listing.
v1.7.0-linux,"success, data should be following..."
v1.7.0-linux,ack on this cmd is a noop
v1.7.0-linux,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.7.0-linux,give up then.
v1.7.0-linux,tell watchdog we are sending a request
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,================================= CLIENT ==============================================================
v1.7.0-linux,Check if we have a valid transaction
v1.7.0-linux,emit signal if all packets arrived
v1.7.0-linux,Restart statemachine
v1.7.0-linux,image APIs
v1.7.0-linux,================================= SERVER ==============================================================
v1.7.0-linux,Prepare and send acknowledgment packet
v1.7.0-linux,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.7.0-linux,Send ENCAPSULATED_IMAGE packet
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.7.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.7.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.7.0-linux,send this right away just in case serial link is not already configured
v1.7.0-linux,CurrentThread::setMaximumPriority();
v1.7.0-linux,"hmmm, wait till it is opened?"
v1.7.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.7.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.7.0-linux,queue event for publishing.
v1.7.0-linux,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.7.0-linux,as it ensures we don't lose messages if the listener is slow.
v1.7.0-linux,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.7.0-linux,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.7.0-linux,we would get a deadlock.
v1.7.0-linux,CurrentThread::setMaximumPriority();
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.7.0-linux,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.7.0-linux,parse out the VID number
v1.7.0-linux,now the PID
v1.7.0-linux,parse out the VID number
v1.7.0-linux,examples:
v1.7.0-linux,PX4: USB\VID_26AC&PID_0011\0
v1.7.0-linux,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.7.0-linux,"printf(""Found: %S\n"", buffer.c_str());"
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.7.0-linux,parse out the VID number
v1.7.0-linux,now the PID
v1.7.0-linux,parse out the VID number
v1.7.0-linux,suppress
v1.7.0-linux,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,This has not been properly tested
v1.7.0-linux,struct iw_statistics stats;
v1.7.0-linux,struct iwreq req;
v1.7.0-linux,"memset(&stats, 0, sizeof(stats));"
v1.7.0-linux,"memset(&req, 0, sizeof(iwreq));"
v1.7.0-linux,
v1.7.0-linux,"strncpy(req.ifr_name, ifaceName, 16);"
v1.7.0-linux,req.u.data.pointer = &stats;
v1.7.0-linux,req.u.data.length = sizeof(iw_statistics);
v1.7.0-linux,
v1.7.0-linux,#ifdef CLEAR_UPDATED
v1.7.0-linux,req.u.data.flags = 1;
v1.7.0-linux,#endif
v1.7.0-linux,
v1.7.0-linux,/* Perform the ioctl */
v1.7.0-linux,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.7.0-linux,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.7.0-linux,return -127;
v1.7.0-linux,}
v1.7.0-linux,
v1.7.0-linux,return stats.qual.level;
v1.7.0-linux,todo: windows version of this...
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,windows
v1.7.0-linux,Need to link with Ws2_32.lib
v1.7.0-linux,posix
v1.7.0-linux,found it!
v1.7.0-linux,This timeout is important as it allows the MavLinkConnection readPackets
v1.7.0-linux,thread to iterate and notice the connection is now closed. This allows
v1.7.0-linux,AirSim to shutdown properly when drone is not connected.
v1.7.0-linux,bind socket to local address.
v1.7.0-linux,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.7.0-linux,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.7.0-linux,try and reconnect
v1.7.0-linux,write to the serial port
v1.7.0-linux,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.7.0-linux,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.7.0-linux,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.7.0-linux,"try and receive something, up until port is closed anyway."
v1.7.0-linux,"message was too large for the buffer, no problem, return what we have."
v1.7.0-linux,try again - this can happen if server recreates the socket on their side.
v1.7.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.7.0-linux,"skip this, the receive just timed out, no problem, we'll try again later."
v1.7.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.7.0-linux,"printf(""#### recv failed with error: %d\n"", hr);"
v1.7.0-linux,we now have it.
v1.7.0-linux,this is from someone we are not interested in.
v1.7.0-linux,-----------------------------------------------------------------------------------------
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,Initialize Winsock
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,windows
v1.7.0-linux,Need to link with Ws2_32.lib
v1.7.0-linux,posix
v1.7.0-linux,found it!
v1.7.0-linux,bind socket to local address.
v1.7.0-linux,bind socket to local address.
v1.7.0-linux,start listening for incoming connection
v1.7.0-linux,accept 1
v1.7.0-linux,"don't need to accept any more, so we can close this one."
v1.7.0-linux,write to the serial port
v1.7.0-linux,"try and receive something, up until port is closed anyway."
v1.7.0-linux,"message was too large for the buffer, no problem, return what we have."
v1.7.0-linux,try again - this can happen if server recreates the socket on their side.
v1.7.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.7.0-linux,try again - this can happen if server recreates the socket on their side.
v1.7.0-linux,-----------------------------------------------------------------------------------------
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.7.0-linux,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.7.0-linux,set signal
v1.7.0-linux,Clear Handshake flags
v1.7.0-linux,Set Handshake flags
v1.7.0-linux,return GetLastError();
v1.7.0-linux,return GetLastError();
v1.7.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.7.0-linux,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.7.0-linux,enable reading
v1.7.0-linux,posix doesn't have mark/space parity.
v1.7.0-linux,posix doesn't have mark/space parity.
v1.7.0-linux,this is the default.
v1.7.0-linux,not sure this is supported...
v1.7.0-linux,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.7.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.7.0-linux,First do those specified by POSIX.
v1.7.0-linux,Now conditionally handle a bunch of extended rates.
v1.7.0-linux,First do those specified by POSIX.
v1.7.0-linux,Now conditionally handle a bunch of extended rates.
v1.7.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.7.0-linux,import airsim
v1.7.0-linux,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v1.7.0-linux,self.args = args
v1.7.0-linux,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v1.7.0-linux,pdb.set_trace()
v1.7.0-linux,#include <pluginlib/class_list_macros.h>
v1.7.0-linux,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v1.7.0-linux,todo do not reset if already in air?
v1.7.0-linux,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.7.0-linux,ros params
v1.7.0-linux,todo enforce dynamics constraints in this node as well?
v1.7.0-linux,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v1.7.0-linux,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v1.7.0-linux,XmlRpc::XmlRpcValue can't be const in this case
v1.7.0-linux,subscribe to control commands on global nodehandle
v1.7.0-linux,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.7.0-linux,bind to a single callback. todo optimal subs queue length
v1.7.0-linux,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.7.0-linux,TODO: ros::TransportHints().tcpNoDelay();
v1.7.0-linux,"vehicle_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.7.0-linux,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.7.0-linux,camera_setting.gimbal
v1.7.0-linux,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.7.0-linux,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.7.0-linux,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.7.0-linux,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.7.0-linux,"if {DepthPlanar, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.7.0-linux,"push back pair (vector of image captures, current vehicle name)"
v1.7.0-linux,iterate over sensors
v1.7.0-linux,"we want fast access to the lidar sensors for callback handling, sort them out now"
v1.7.0-linux,add takeoff and land all services if more than 2 drones
v1.7.0-linux,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v1.7.0-linux,todo add per vehicle reset in AirLib API
v1.7.0-linux,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.7.0-linux,lidars update on their own callback/thread at a given rate
v1.7.0-linux,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v1.7.0-linux,"todo: error check. if state is not landed, return error."
v1.7.0-linux,todo add reset by vehicle_name API to airlib
v1.7.0-linux,todo not async remove waitonlasttask
v1.7.0-linux,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v1.7.0-linux,todo do actual body frame?
v1.7.0-linux,airsim uses degrees
v1.7.0-linux,todo do actual body frame?
v1.7.0-linux,airsim uses degrees
v1.7.0-linux,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v1.7.0-linux,todo expose waitOnLastTask or nah?
v1.7.0-linux,todo do actual body frame?
v1.7.0-linux,airsim uses degrees
v1.7.0-linux,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.7.0-linux,todo expose waitOnLastTask or nah?
v1.7.0-linux,todo support multiple gimbal commands
v1.7.0-linux,todo support multiple gimbal commands
v1.7.0-linux,1. find quaternion of default gimbal pose
v1.7.0-linux,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.7.0-linux,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.7.0-linux,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.7.0-linux,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.7.0-linux,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.7.0-linux,msg = []
v1.7.0-linux,todo covariances
v1.7.0-linux,gps_msg.position_covariance_type =
v1.7.0-linux,gps_msg.position_covariance =
v1.7.0-linux,todo covariances
v1.7.0-linux,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.7.0-linux,todo radians per second
v1.7.0-linux,meters/s2^m
v1.7.0-linux,imu_msg.orientation_covariance = ;
v1.7.0-linux,imu_msg.angular_velocity_covariance = ;
v1.7.0-linux,imu_msg.linear_acceleration_covariance = ;
v1.7.0-linux,airsim appears to use chrono::system_clock with nanosecond precision
v1.7.0-linux,todo this is global origin
v1.7.0-linux,get the basic vehicle pose and environmental state
v1.7.0-linux,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.7.0-linux,airsim_client needs to provide the simulation time in a future version of the API
v1.7.0-linux,publish the simulation clock
v1.7.0-linux,"publish vehicle state, odom, and all basic sensor types"
v1.7.0-linux,send any commands out to the vehicles
v1.7.0-linux,"should be easier way to get the sim time through API, something like:"
v1.7.0-linux,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.7.0-linux,curr_ros_time = airsim_timestamp_to_ros(env.clock().nowNanos());
v1.7.0-linux,iterate over drones
v1.7.0-linux,get drone state from airsim
v1.7.0-linux,"vehicle environment, we can get ambient temperature here and other truths"
v1.7.0-linux,convert airsim drone state to ROS msgs
v1.7.0-linux,simulation environment truth
v1.7.0-linux,"dashboard reading from car, RPM, gear, etc"
v1.7.0-linux,odom and transforms
v1.7.0-linux,ground truth GPS position from sim/HITL
v1.7.0-linux,handled via callback
v1.7.0-linux,send control commands from the last callback to airsim
v1.7.0-linux,send control commands from the last callback to airsim
v1.7.0-linux,"Only camera rotation, no translation movement of camera"
v1.7.0-linux,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.7.0-linux,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.7.0-linux,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.7.0-linux,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.7.0-linux,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.7.0-linux,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.7.0-linux,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.7.0-linux,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.7.0-linux,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.7.0-linux,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.7.0-linux,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.7.0-linux,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.7.0-linux,update timestamp of saved cam info msgs
v1.7.0-linux,DepthPlanar / DepthPerspective / DepthVis / DisparityNormalized
v1.7.0-linux,Scene / Segmentation / SurfaceNormals / Infrared
v1.7.0-linux,publish camera transforms
v1.7.0-linux,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.7.0-linux,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.7.0-linux,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.7.0-linux,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.7.0-linux,ROS params
v1.7.0-linux,ROS publishers
v1.7.0-linux,ROS subscribers
v1.7.0-linux,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.7.0-linux,ROS timers
v1.7.0-linux,todo maintain internal representation as eigen vec?
v1.7.0-linux,todo check if low velocity if within thresh?
v1.7.0-linux,todo maintain separate errors for XY and Z
v1.7.0-linux,todo save this in degrees somewhere to avoid repeated conversion
v1.7.0-linux,this tells the update timer callback to not do active hovering
v1.7.0-linux,todo maintain array of position goals
v1.7.0-linux,todo error checks
v1.7.0-linux,todo fill response
v1.7.0-linux,"Already have goal, and have reached it"
v1.7.0-linux,this tells the update timer callback to not do active hovering
v1.7.0-linux,todo error checks
v1.7.0-linux,todo fill response
v1.7.0-linux,"todo do relative altitude, or add an option for the same?"
v1.7.0-linux,convert GPS goal to NED goal
v1.7.0-linux,todo error checks
v1.7.0-linux,todo fill response
v1.7.0-linux,"Already have goal, this shouldn't happen"
v1.7.0-linux,"todo do relative altitude, or add an option for the same?"
v1.7.0-linux,convert GPS goal to NED goal
v1.7.0-linux,todo error checks
v1.7.0-linux,todo fill response
v1.7.0-linux,todo check if odometry is too old!!
v1.7.0-linux,"if no odom, don't do anything."
v1.7.0-linux,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.7.0-linux,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.7.0-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.7.0-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.7.0-linux,todo yaw limits
v1.7.0-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.7.0-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.7.0-linux,mimics void ASimHUD::initializeSettings()
v1.7.0-linux,int num_threads = 1;
v1.7.0-linux,ros::MultiThreadedSpinner multi_thread(num_threads);
v1.7.0-linux,multi_thread.spin();
v1.7.0-linux,ros::AsyncSpinner async_spinner(num_threads);
v1.7.0-linux,async_spinner.start();
v1.7.0-linux,single threaded spinner
v1.7.0-linux,!/usr/bin/env python
v1.7.0-linux,capture joystick events using ROS and convert to AirSim Car API commands
v1.7.0-linux,to enable:
v1.7.0-linux,rosrun joy joy_node
v1.7.0-linux,"Below was an earlier typo, written like this for compatibility"
v1.7.0-linux,"gearing: -1 reverse, 0 N, >= 1 drive"
v1.7.0-linux,connect to the AirSim simulator
v1.7.0-linux,","
v1.7.0-linux,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.7.0-linux,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,"in header only mode, control library is not available"
v1.7.0-linux,TODO: something defines max macro which interfears with code here
v1.7.0-linux,is cur_pos within fence?
v1.7.0-linux,destination risk is not available then consider it zero
v1.7.0-linux,if dest risk is lower than its more safe
v1.7.0-linux,are we doing better than closest obstacle?
v1.7.0-linux,"if we stay where we are, what is the risk distance?"
v1.7.0-linux,else we are better of moving to dest
v1.7.0-linux,this function should work even when dest_pos == cur_pos
v1.7.0-linux,is this dest_pos cur_pos within the fence?
v1.7.0-linux,transform dest_pos vector to body frame
v1.7.0-linux,check for approx zero vectors to avoid random yaw angles
v1.7.0-linux,we are hovering
v1.7.0-linux,"get yaw in body frame, ie, front is always 0 radians"
v1.7.0-linux,yaw to ticks
v1.7.0-linux,get obstacles in the window at the tick direction around the window
v1.7.0-linux,less risk distance is better
v1.7.0-linux,check obstacles around current position and see if it has lower risk
v1.7.0-linux,else obstacle is too far
v1.7.0-linux,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.7.0-linux,look for each surrounding tick to see if we have obstacle free angle
v1.7.0-linux,else no suggestions required
v1.7.0-linux,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.7.0-linux,evaluate right and left side of circle
v1.7.0-linux,find right and left risk distances
v1.7.0-linux,at this point we have already determined hover is better than going to dest
v1.7.0-linux,we now determine is moving to suggested angle better than hovering?
v1.7.0-linux,check if dest_pos is safe
v1.7.0-linux,breaking distance at this velocity
v1.7.0-linux,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.7.0-linux,check if dest_pos is safe
v1.7.0-linux,float/vec parameters can have NaN which makes them optional
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,"in header only mode, control library is not available"
v1.7.0-linux,handles +/- tick and wraps around circle
v1.7.0-linux,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.7.0-linux,update the specified window on the map
v1.7.0-linux,make sure from <= to
v1.7.0-linux,normalize the ticks so both are valid indices
v1.7.0-linux,if from is still larger then
v1.7.0-linux,to ticks is then added one full circle to make it larger than from_tick
v1.7.0-linux,find closest obstacle in given window
v1.7.0-linux,search whole map to find closest obstacle
v1.7.0-linux,"in header only mode, control library is not available"
v1.7.0-linux,#include <fileapi.h>
v1.7.0-linux,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.7.0-linux,"Windows, OSX and Linux."
v1.7.0-linux,Windows users can move the Documents folder to any location they want
v1.7.0-linux,SHGetFolderPath knows how to find it.
v1.7.0-linux,fall back in case SHGetFolderPath failed for some reason.
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,"in header only mode, control library is not available"
v1.7.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.7.0-linux,if using Unreal Build system then include precompiled header file first
v1.7.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.7.0-linux,this deadlocks UI thread if async_run was called while there are pending rpc calls.
v1.7.0-linux,CinemAirSim
v1.7.0-linux,end CinemAirSim
v1.7.0-linux,Exit if already resetting.
v1.7.0-linux,Reset
v1.7.0-linux,if we don't suppress then server will bomb out for exceptions raised by any method
v1.7.0-linux,required for pimpl
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,"in header only mode, control library is not available"
v1.7.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.7.0-linux,if using Unreal Build system then include precompiled header file first
v1.7.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.7.0-linux,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.7.0-linux,make sure we can talk to the DroneServer
v1.7.0-linux,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.7.0-linux,command_context.client.ping();
v1.7.0-linux,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.7.0-linux,sim only
v1.7.0-linux,CinemAirSim
v1.7.0-linux,End CinemAirSim
v1.7.0-linux,"Minor TODO: consider msgpack magic for GeoPoint, so we can have one arg instead of three"
v1.7.0-linux,Convert
v1.7.0-linux,return value of last task. It should be true if task completed without
v1.7.0-linux,cancellation or timeout
v1.7.0-linux,"should be implemented by derived class if it supports async task,"
v1.7.0-linux,for example using futures
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,"in header only mode, control library is not available"
v1.7.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.7.0-linux,if using Unreal Build system then include precompiled header file first
v1.7.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,"in header only mode, control library is not available"
v1.7.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.7.0-linux,if using Unreal Build system then include precompiled header file first
v1.7.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.7.0-linux,required for pimpl
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,"in header only mode, control library is not available"
v1.7.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.7.0-linux,if using Unreal Build system then include precompiled header file first
v1.7.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.7.0-linux,status getters
v1.7.0-linux,Rotor state getter
v1.7.0-linux,Multirotor state getter
v1.7.0-linux,return value of last task. It should be true if task completed without
v1.7.0-linux,cancellation or timeout
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,"in header only mode, control library is not available"
v1.7.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.7.0-linux,if using Unreal Build system then include pre-compiled header file first
v1.7.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.7.0-linux,getters
v1.7.0-linux,Rotor state
v1.7.0-linux,Multirotor state
v1.7.0-linux,required for pimpl
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,"in header only mode, control library is not available"
v1.7.0-linux,last command is to hold on to position
v1.7.0-linux,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.7.0-linux,after landing we detect if drone has stopped moving
v1.7.0-linux,validate path size
v1.7.0-linux,validate yaw mode
v1.7.0-linux,validate and set auto-lookahead value
v1.7.0-linux,if auto mode requested for lookahead then calculate based on velocity
v1.7.0-linux,add current position as starting point
v1.7.0-linux,append the input path and compute segments
v1.7.0-linux,add last segment as zero length segment so we have equal number of segments and points.
v1.7.0-linux,path_segs[i] refers to segment that starts at point i
v1.7.0-linux,"when path ends, we want to slow down"
v1.7.0-linux,else no need to change velocities for last segments
v1.7.0-linux,setup current position on path to 0 offset
v1.7.0-linux,initialize next path position
v1.7.0-linux,until we are at the end of the path (last seg is always zero size)
v1.7.0-linux,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.7.0-linux,send drone command to get to next lookahead
v1.7.0-linux,sleep for rest of the cycle
v1.7.0-linux,how much have we moved towards last goal?
v1.7.0-linux,project actual vector on goal vector
v1.7.0-linux,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.7.0-linux,TODO: below should be lower than 1E3 and configurable
v1.7.0-linux,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.7.0-linux,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.7.0-linux,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.7.0-linux,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.7.0-linux,"if drone moved backward, we don't want goal to move backward as well"
v1.7.0-linux,"so only climb forward on the path, never back. Also note >= which means"
v1.7.0-linux,we climb path even if distance was 0 to take care of duplicated points on path
v1.7.0-linux,else
v1.7.0-linux,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.7.0-linux,compute next target on path
v1.7.0-linux,freeze the quaternion
v1.7.0-linux,convert RC commands to velocity vector
v1.7.0-linux,find yaw as per terrain and remote setting
v1.7.0-linux,execute command
v1.7.0-linux,if timeout occurred then command completed successfully otherwise it was interrupted
v1.7.0-linux,yaw is not within margin
v1.7.0-linux,by default we say that this command is not supported
v1.7.0-linux,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.7.0-linux,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.7.0-linux,get trims
v1.7.0-linux,take average
v1.7.0-linux,validate dest
v1.7.0-linux,what is the distance we will travel at this velocity?
v1.7.0-linux,get velocity vector
v1.7.0-linux,yaw for the direction of travel
v1.7.0-linux,find velocity vector
v1.7.0-linux,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.7.0-linux,generate velocity vector that is same size as cur_dest_norm / command period
v1.7.0-linux,this velocity vect when executed for command period would yield cur_dest_norm
v1.7.0-linux,send commands
v1.7.0-linux,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.7.0-linux,default strategy is for move. In hover mode we set new strategy temporarily
v1.7.0-linux,are we supposed to do EM?
v1.7.0-linux,get suggested velocity vector
v1.7.0-linux,use the unchecked command
v1.7.0-linux,tell caller not to execute planned command
v1.7.0-linux,other wise throw exception
v1.7.0-linux,otherwise there is some other reason why we are in unsafe situation
v1.7.0-linux,send last command to come to full stop
v1.7.0-linux,else no unsafe situation
v1.7.0-linux,note: cur_path_loc and next_path_loc may both point to same object
v1.7.0-linux,"otherwise use up this segment, move on to next one"
v1.7.0-linux,if we are here then we ran out of segments
v1.7.0-linux,consider last segment as zero length segment
v1.7.0-linux,adjust yaw for the direction of travel in forward-only mode
v1.7.0-linux,else no adjustment needed
v1.7.0-linux,if auto mode requested for lookahead then calculate based on velocity
v1.7.0-linux,Create a spring arm component for our chase camera
v1.7.0-linux,"do nothing, spring arm is pulling the camera with it"
v1.7.0-linux,"do nothing, we have camera turned off"
v1.7.0-linux,set initial view mode
v1.7.0-linux,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.7.0-linux,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.7.0-linux,"If the lag is missing, the camera will also occasionally shake."
v1.7.0-linux,"But, lag is not desired when piloting a drone"
v1.7.0-linux,attach spring arm to actor
v1.7.0-linux,remember current parent for external camera. Later when we remove external
v1.7.0-linux,"camera from spring arm, we will attach it back to its last parent"
v1.7.0-linux,now attach camera to spring arm
v1.7.0-linux,"For car, we need to move the camera back a little more than for a drone."
v1.7.0-linux,"Otherwise, the camera will be stuck inside the car"
v1.7.0-linux,ExternalCamera->bUsePawnControlRotation = false;
v1.7.0-linux,detach spring arm
v1.7.0-linux,Re-enable rendering
v1.7.0-linux,Remove any existing key bindings for manual mode
v1.7.0-linux,"else someone else is bound to manual pose controller, leave it alone"
v1.7.0-linux,if new mode is manual mode then add key bindings
v1.7.0-linux,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.7.0-linux,other modes don't need special setup
v1.7.0-linux,make switch official
v1.7.0-linux,Add loading screen to viewport
v1.7.0-linux,Remove Loading screen from viewport
v1.7.0-linux,Create struct for Location and Rotation of actor in Unreal
v1.7.0-linux,Ensure new non-matching name for the object
v1.7.0-linux,Write the binvox file using run-length encoding
v1.7.0-linux,"where each pair of bytes is of the format (run value, run length)"
v1.7.0-linux,This is a run (repeated bit value)
v1.7.0-linux,End of a run
v1.7.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.7.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.7.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.7.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.7.0-linux,Split the tag string into individual tags.
v1.7.0-linux,Texture swap on actors that have all of those tags.
v1.7.0-linux,----------- Plotting APIs ----------/
v1.7.0-linux,"plot line for points 0-1, 1-2, 2-3"
v1.7.0-linux,"plot line for points 0-1, 2-3, 4-5... must be even number of points"
v1.7.0-linux,assert points_start.size() == poinst_end.size()
v1.7.0-linux,assert positions.size() == strings.size()
v1.7.0-linux,assert poses.size() == names.size()
v1.7.0-linux,Recording APIs
v1.7.0-linux,"Remove '' from the list, representing default vehicle"
v1.7.0-linux,"We need to run this code on the main game thread, since it iterates over actors"
v1.7.0-linux,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.7.0-linux,"No LOS, so draw red line"
v1.7.0-linux,"Yes LOS, so draw green line"
v1.7.0-linux,"We need to run this code on the main game thread, since it iterates over actors"
v1.7.0-linux,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.7.0-linux,Testing actor enum for world bounds...
v1.7.0-linux,"Same as with the Object Iterator, access the subclass instance with the * or -> operators."
v1.7.0-linux,"TODO think more about how best to determine/indicate ground level, if anyone cares"
v1.7.0-linux,Convert Uvectors to LLAs
v1.7.0-linux,CinemAirSim
v1.7.0-linux,End CinemAirSim
v1.7.0-linux,Fill out your copyright notice in the Description page of Project Settings.
v1.7.0-linux,"Set this component to be initialized when the game starts, and to be ticked every frame.  You can turn these features"
v1.7.0-linux,off to improve performance if you don't need them.
v1.7.0-linux,get render target for texture size
v1.7.0-linux,initialize viewinfo for projection matrix
v1.7.0-linux,calculate 3D corner Points of bounding box
v1.7.0-linux,initialize pixel values
v1.7.0-linux,initialize projection data for sceneview
v1.7.0-linux,do some voodoo rotation that is somehow mandatory and stolen from UGameplayStatics::ProjectWorldToScreen
v1.7.0-linux,Project Points to pixels and get the corner pixels
v1.7.0-linux,If actor in camera view - check if it's actually visible or hidden
v1.7.0-linux,Check against 8 extend points
v1.7.0-linux,"If actor in camera view but didn't hit any point out of 8 extend points,"
v1.7.0-linux,check against 10 random points
v1.7.0-linux,CinemAirSim
v1.7.0-linux,CinemAirSim
v1.7.0-linux,set initial focal length
v1.7.0-linux,by default all image types are disabled
v1.7.0-linux,use final color for all calculations
v1.7.0-linux,We set all cameras to start as nodisplay
v1.7.0-linux,This improves performance because the capture components are no longer updating every frame and only update while requesting an image
v1.7.0-linux,TODO: avoid the need to override const cast here
v1.7.0-linux,if the viewport is taller than it is wide
v1.7.0-linux,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v1.7.0-linux,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v1.7.0-linux,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v1.7.0-linux,use final color for all calculations
v1.7.0-linux,TODO: should we be ignoring position and orientation settings here?
v1.7.0-linux,TODO: can we eliminate storing NedTransform?
v1.7.0-linux,CinemAirSim
v1.7.0-linux,if (!std::isnan(setting.target_gamma))
v1.7.0-linux,camera-> = setting.target_gamma;
v1.7.0-linux,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.7.0-linux,else nothing to enable
v1.7.0-linux,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.7.0-linux,if (controller && controller->GetViewTarget() == this)
v1.7.0-linux,controller->SetViewTarget(nullptr);
v1.7.0-linux,CinemAirSim methods
v1.7.0-linux,Copy all of the post processing settings
v1.7.0-linux,But restore the original blendables
v1.7.0-linux,end CinemAirSim methods
v1.7.0-linux,"Check whether requested map exists, this could be very slow if LevelName is a short package name"
v1.7.0-linux,Create Unique Name for sub-level package
v1.7.0-linux,Setup streaming level object that will load specified map
v1.7.0-linux,Transform
v1.7.0-linux,Map to Load
v1.7.0-linux,Add the new level to world.
v1.7.0-linux,TODO: explore screenshot option
v1.7.0-linux,addScreenCaptureHandler(camera->GetWorld());
v1.7.0-linux,TODO: may be we should have these methods non-const?
v1.7.0-linux,We don't do game/render thread synchronization for safe method.
v1.7.0-linux,We just blindly sleep for 200ms (the old way)
v1.7.0-linux,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.7.0-linux,Make sure that all alpha values are opaque.
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,TODO: change naming conventions to same as other files?
v1.7.0-linux,"context->GetWorld()->SetNewWorldOrigin(FIntVector(0, 0, 0));"
v1.7.0-linux,Enable/disable primary viewport rendering flag
v1.7.0-linux,This disables rendering of the main viewport in the same way as the
v1.7.0-linux,"console command ""show rendering"" would do."
v1.7.0-linux,"When getting an image through the API, the image is produced after the render"
v1.7.0-linux,thread has finished rendering the current and the subsequent frame. This means
v1.7.0-linux,that the frame rate for obtaining images through the API is only half as high as
v1.7.0-linux,"it could be, since only every other image is actually captured. We work around"
v1.7.0-linux,this by telling the viewport to flush the rendering queue at the end of each
v1.7.0-linux,drawn frame so that it executes our render request at that point already.
v1.7.0-linux,Do this only if the main viewport is not being rendered anyway in case there are
v1.7.0-linux,any adverse performance effects during main rendering.
v1.7.0-linux,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v1.7.0-linux,nothing to do for now
v1.7.0-linux,"if hidden, clear any existing messages"
v1.7.0-linux,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.7.0-linux,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.7.0-linux,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.7.0-linux,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.7.0-linux,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.7.0-linux,Find mesh in /Game and /AirSim asset registry. When more plugins are added this function will have to change
v1.7.0-linux,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.7.0-linux,{
v1.7.0-linux,InitializeObjectStencilID(*comp);
v1.7.0-linux,}
v1.7.0-linux,"Takes a UStaticMeshComponent, USkinnedMeshComponent or ALandscapeProxy and returns their custom stencil ID if"
v1.7.0-linux,their meshes's name or their owner's name (depending on the naming method in mesh_naming_method_) equals mesh_name
v1.7.0-linux,"The skybox is ignored here as it is huge, and really is of no use to the end user typically. Also the associated meshes with the cameras"
v1.7.0-linux,Various checks if there is even a valid mesh
v1.7.0-linux,Need to force the render command to go through cause on the next iteration the buffer no longer exists
v1.7.0-linux,Unreal stores more vertices than triangles. So here we find the highest referenced vertex and ignore any after that
v1.7.0-linux,can we see followee?
v1.7.0-linux,remove mapping
v1.7.0-linux,removing binding
v1.7.0-linux,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.7.0-linux,"some point. At the moment, manually swapping Red and Blue"
v1.7.0-linux,Copy scaled image into destination thumb
v1.7.0-linux,Compress data - convert into a .png
v1.7.0-linux,if we already have attached actor
v1.7.0-linux,Fill out your copyright notice in the Description page of Project Settings.
v1.7.0-linux,Check pointer equality first for performance
v1.7.0-linux,"KeyHash = HashCombine(KeyHash, GetTypeHash(Key.WildcardMeshNames));"
v1.7.0-linux,#ifdef _MSC_VER
v1.7.0-linux,//print to VS output window
v1.7.0-linux,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.7.0-linux,#endif
v1.7.0-linux,also do default logging
v1.7.0-linux,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.7.0-linux,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.7.0-linux,{
v1.7.0-linux,if (GEngine != nullptr)
v1.7.0-linux,{
v1.7.0-linux,return GEngine->GameUserSettings;
v1.7.0-linux,}
v1.7.0-linux,return nullptr;
v1.7.0-linux,}
v1.7.0-linux,UGameUserSettings* game_settings = GetGameUserSettings();
v1.7.0-linux,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.7.0-linux,game_settings->ApplySettings(true);
v1.7.0-linux,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.7.0-linux,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.7.0-linux,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.7.0-linux,todo unused. need to manually plots tf axes' line in right handed FLU instead of using DrawDebugCoordinateSystem
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,plugin startup
v1.7.0-linux,plugin shutdown
v1.7.0-linux,initialize state
v1.7.0-linux,add listener for pawn's collision event
v1.7.0-linux,compute our home point
v1.7.0-linux,default behavior is to call update every tick
v1.7.0-linux,"for custom physics engine, this method should be overridden and update should be"
v1.7.0-linux,called from every physics tick
v1.7.0-linux,add cameras that already exists in pawn
v1.7.0-linux,create or replace cameras specified in settings
v1.7.0-linux,setup individual cameras
v1.7.0-linux,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.7.0-linux,for each camera in settings
v1.7.0-linux,get pose
v1.7.0-linux,spawn and attach camera to pawn
v1.7.0-linux,add on to our collection
v1.7.0-linux,Deflect along the surface when we collide.
v1.7.0-linux,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.7.0-linux,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.7.0-linux,-1 to 1 --> 0 to 1
v1.7.0-linux,-1 to 1
v1.7.0-linux,these will be available for devices like steering wheels
v1.7.0-linux,switch index 0 to 7 for FrSky Taranis RC is:
v1.7.0-linux,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.7.0-linux,TODO: should below be at controller level info?
v1.7.0-linux,else don't waste time
v1.7.0-linux,"We need to run this code on the main game thread, since it iterates over actors"
v1.7.0-linux,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.7.0-linux,Transform from LLA to NED
v1.7.0-linux,KM911 remove logging
v1.7.0-linux,"common_utils::Utils::log(""NED from LLA: "" + std::to_string(target_location.X) + "", "" + std::to_string(target_location.Y) + "", "" + std::to_string(target_location.Z), common_utils::Utils::kLogLevelInfo);"
v1.7.0-linux,"No LOS, so draw red line"
v1.7.0-linux,"Yes LOS, so draw green line"
v1.7.0-linux,sync environment from kinematics
v1.7.0-linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.7.0-linux,void playBack()
v1.7.0-linux,{
v1.7.0-linux,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.7.0-linux,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.7.0-linux,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.7.0-linux,}
v1.7.0-linux,TODO: refactor below code used for playback
v1.7.0-linux,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.7.0-linux,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.7.0-linux,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.7.0-linux,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.7.0-linux,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.7.0-linux,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.7.0-linux,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.7.0-linux,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.7.0-linux,}
v1.7.0-linux,parameters in NED frame
v1.7.0-linux,translate to new PawnSimApi position & orientation from NED to NEU
v1.7.0-linux,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.7.0-linux,allow teleportation
v1.7.0-linux,if collisions are not enabled
v1.7.0-linux,or we have collided but passthrough is enabled
v1.7.0-linux,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.7.0-linux,"without flip flopping, collisions can't be detected"
v1.7.0-linux,update kinematics from pawn's movement instead of physics engine
v1.7.0-linux,by default we update kinematics from UE pawn
v1.7.0-linux,if SimMod uses its own physics engine then this should be overriden
v1.7.0-linux,no default action in this base class
v1.7.0-linux,"read pixels from render target using render thread, then compress the result into PNG"
v1.7.0-linux,argument on the thread that calls this method.
v1.7.0-linux,TODO: is below really needed?
v1.7.0-linux,make sure we are not on the rendering thread
v1.7.0-linux,TODO: below doesn't work right now because it must be running in game thread
v1.7.0-linux,below is documented method but more expensive because it forces flush
v1.7.0-linux,wait for render thread to pick up our task
v1.7.0-linux,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.7.0-linux,capture CameraPose for this frame
v1.7.0-linux,The completion is called immeidately after GameThread sends the
v1.7.0-linux,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.7.0-linux,execute *immediately* after RenderThread renders the scene!
v1.7.0-linux,"while we're still on GameThread, enqueue request for capture the scene!"
v1.7.0-linux,wait for this task to complete
v1.7.0-linux,log a message and continue wait
v1.7.0-linux,lamda function still references a few objects for which there is no refcount.
v1.7.0-linux,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.7.0-linux,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.7.0-linux,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.7.0-linux,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.7.0-linux,Fill out your copyright notice in the Description page of Project Settings.
v1.7.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.7.0-linux,UWorld* World = GetWorld();
v1.7.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.7.0-linux,still need the menu class for f10
v1.7.0-linux,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v1.7.0-linux,showWeatherMenu(WorldContextObject);
v1.7.0-linux,"if weather is not enabled, dont allow any weather values to be set"
v1.7.0-linux,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v1.7.0-linux,and must be set to true or false before this.
v1.7.0-linux,WeatherEnabled will always be false
v1.7.0-linux,"NOTE: weather enabled must be set first, before other params for this to work"
v1.7.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.7.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.7.0-linux,"get all menu actors, if any"
v1.7.0-linux,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.7.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.7.0-linux,"get all menu actors, if any"
v1.7.0-linux,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.7.0-linux,"get all menu actors, if any, then hide the menu"
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,Stuff to filter out XInput devices
v1.7.0-linux,-----------------------------------------------------------------------------
v1.7.0-linux,"Defines, constants, and global variables"
v1.7.0-linux,-----------------------------------------------------------------------------
v1.7.0-linux,Magnitude ranges from -1 to 1
v1.7.0-linux,Strength ranges from 0 to 1
v1.7.0-linux,Autocenter
v1.7.0-linux,Rumble
v1.7.0-linux,Register with the DirectInput subsystem and get a pointer
v1.7.0-linux,to a IDirectInput interface we can use.
v1.7.0-linux,Create a DInput object
v1.7.0-linux,Look for a simple joystick we can use for this sample program.
v1.7.0-linux,Make sure we got a joystick
v1.7.0-linux,"Set the data format to ""simple joystick"" - a predefined data format"
v1.7.0-linux,
v1.7.0-linux,"A data format specifies which controls on a device we are interested in,"
v1.7.0-linux,and how they should be reported. This tells DInput that we will be
v1.7.0-linux,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.7.0-linux,Set the cooperative level to let DInput know how this device should
v1.7.0-linux,interact with the system and with other DInput applications.
v1.7.0-linux,Enumerate the joystick objects. The callback function enabled user
v1.7.0-linux,"interface elements for objects that are found, and sets the min/max"
v1.7.0-linux,values property for discovered axes.
v1.7.0-linux,-----------------------------------------------------------------------------
v1.7.0-linux,Enum each PNP device using WMI and check each device ID to see if it contains
v1.7.0-linux,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.7.0-linux,Unfortunately this information can not be found by just using DirectInput.
v1.7.0-linux,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.7.0-linux,XInput devices.
v1.7.0-linux,
v1.7.0-linux,This function stores the list of xinput devices in a linked list
v1.7.0-linux,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.7.0-linux,-----------------------------------------------------------------------------
v1.7.0-linux,CoInit if needed
v1.7.0-linux,Create WMI
v1.7.0-linux,Create BSTRs for WMI
v1.7.0-linux,Connect to WMI
v1.7.0-linux,Switch security level to IMPERSONATE
v1.7.0-linux,Get list of Win32_PNPEntity devices
v1.7.0-linux,Loop over all devices
v1.7.0-linux,Get 20 at a time
v1.7.0-linux,"For each device, get its device ID"
v1.7.0-linux,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.7.0-linux,Unfortunately this information can not be found by just using DirectInput
v1.7.0-linux,"If it does, then get the VID/PID from var.bstrVal"
v1.7.0-linux,Add the VID/PID to a linked list
v1.7.0-linux,-----------------------------------------------------------------------------
v1.7.0-linux,Returns true if the DirectInput device is also an XInput device.
v1.7.0-linux,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.7.0-linux,-----------------------------------------------------------------------------
v1.7.0-linux,Check each xinput device to see if this device's vid/pid matches
v1.7.0-linux,-----------------------------------------------------------------------------
v1.7.0-linux,Cleanup needed for IsXInputDevice()
v1.7.0-linux,-----------------------------------------------------------------------------
v1.7.0-linux,Cleanup linked list
v1.7.0-linux,-----------------------------------------------------------------------------
v1.7.0-linux,Name: EnumJoysticksCallback()
v1.7.0-linux,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.7.0-linux,device interface on it so we can play with it.
v1.7.0-linux,-----------------------------------------------------------------------------
v1.7.0-linux,Skip anything other than the perferred joystick device as defined by the control panel.
v1.7.0-linux,Instead you could store all the enumerated joysticks and let the user pick.
v1.7.0-linux,Obtain an interface to the enumerated joystick.
v1.7.0-linux,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.7.0-linux,it while we were in the middle of enumerating it.)
v1.7.0-linux,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.7.0-linux,could store all the enumerated joysticks and let the user pick.
v1.7.0-linux,-----------------------------------------------------------------------------
v1.7.0-linux,Name: EnumObjectsCallback()
v1.7.0-linux,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.7.0-linux,joystick. This function enables user interface elements for objects
v1.7.0-linux,"that are found to exist, and scales axes min/max values."
v1.7.0-linux,-----------------------------------------------------------------------------
v1.7.0-linux,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.7.0-linux,enumerated axis in order to scale min/max values.
v1.7.0-linux,Set the range for the axis
v1.7.0-linux,Set the UI to reflect what objects the joystick supports
v1.7.0-linux,-----------------------------------------------------------------------------
v1.7.0-linux,Name: UpdateInputState()
v1.7.0-linux,Desc: Get the input device's state and display it.
v1.7.0-linux,-----------------------------------------------------------------------------
v1.7.0-linux,Poll the device to read the current state
v1.7.0-linux,DInput is telling us that the input stream has been
v1.7.0-linux,"interrupted. We aren't tracking any state between polls, so"
v1.7.0-linux,we don't have any special reset that needs to be done. We
v1.7.0-linux,just re-acquire and try again.
v1.7.0-linux,while (hr == DIERR_INPUTLOST)
v1.7.0-linux,hr = g_pJoystick->Acquire();
v1.7.0-linux,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.7.0-linux,may occur when the app is minimized or in the process of
v1.7.0-linux,"switching, so just try again later"
v1.7.0-linux,Get the input's device state
v1.7.0-linux,Axes
v1.7.0-linux,Slider controls
v1.7.0-linux,Points of view
v1.7.0-linux,Buttons
v1.7.0-linux,-----------------------------------------------------------------------------
v1.7.0-linux,Name: FreeDirectInput()
v1.7.0-linux,Desc: Initialize the DirectInput variables.
v1.7.0-linux,-----------------------------------------------------------------------------
v1.7.0-linux,Unacquire the device one last time just in case
v1.7.0-linux,the app tried to exit while the device is still acquired.
v1.7.0-linux,Release any DirectInput objects.
v1.7.0-linux,nop
v1.7.0-linux,normalize min to max --> 0 to 1
v1.7.0-linux,normalize 0 to 1 --> -1 to 1
v1.7.0-linux,#include <libudev.h>
v1.7.0-linux,implementation for unsupported OS
v1.7.0-linux,if this is new index
v1.7.0-linux,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.7.0-linux,close previous one
v1.7.0-linux,open new device
v1.7.0-linux,if open was successful
v1.7.0-linux,read the device
v1.7.0-linux,if we didn't had valid read
v1.7.0-linux,"NOTE if this condition is not met, we're probably out of sync and this"
v1.7.0-linux,Joystick instance is likely unusable
v1.7.0-linux,TODO: set below to false?
v1.7.0-linux,state.is_valid = false;
v1.7.0-linux,else ignore
v1.7.0-linux,TODO: implement this for linux
v1.7.0-linux,TODO: implement this for linux
v1.7.0-linux,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.7.0-linux,{
v1.7.0-linux,"manufacturerID = productID = """";"
v1.7.0-linux,// Use udev to look up the product and manufacturer IDs
v1.7.0-linux,struct udev *udev = udev_new();
v1.7.0-linux,if (udev) {
v1.7.0-linux,char sysname[32];
v1.7.0-linux,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.7.0-linux,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.7.0-linux,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.7.0-linux,if (!dev)
v1.7.0-linux,{
v1.7.0-linux,"message = ""Unable to find parent USB device"";"
v1.7.0-linux,return false;
v1.7.0-linux,}
v1.7.0-linux,std::stringstream ss;
v1.7.0-linux,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.7.0-linux,ss >> manufacturerID;
v1.7.0-linux,ss.clear();
v1.7.0-linux,"ss.str("""");"
v1.7.0-linux,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.7.0-linux,ss >> productID;
v1.7.0-linux,udev_device_unref(dev);
v1.7.0-linux,}
v1.7.0-linux,else
v1.7.0-linux,{
v1.7.0-linux,"message = ""Cannot create udev"";"
v1.7.0-linux,return false;
v1.7.0-linux,}
v1.7.0-linux,udev_unref(udev);
v1.7.0-linux,return true;
v1.7.0-linux,}
v1.7.0-linux,required for pimpl
v1.7.0-linux,TODO: anyway to workaround const_cast?
v1.7.0-linux,FGenericPlatformMisc::PlatformInit();
v1.7.0-linux,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.7.0-linux,"sub-window captures don't count as a request, set bCaptureEveryFrame and bCaptureOnMovement to display so we can show correctly the subwindow"
v1.7.0-linux,create main widget
v1.7.0-linux,synchronize PIP views
v1.7.0-linux,TODO: should we only do below on SceneCapture2D components and cameras?
v1.7.0-linux,avoid motion blur so capture images don't get
v1.7.0-linux,use two different methods to set console var because sometime it doesn't seem to work
v1.7.0-linux,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.7.0-linux,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.7.0-linux,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.7.0-linux,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.7.0-linux,setup defaults
v1.7.0-linux,Attempts to parse the settings text from one of multiple locations.
v1.7.0-linux,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.7.0-linux,"Next, check the executable's working directory for the settings file."
v1.7.0-linux,"Finally, check the user's documents folder."
v1.7.0-linux,"If the settings file cannot be read, throw an exception"
v1.7.0-linux,Attempts to parse the settings file path or the settings text from the command line
v1.7.0-linux,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.7.0-linux,"Example (Path): AirSim.exe --settings ""C:\path\to\settings.json"""
v1.7.0-linux,"Example (Text): AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.7.0-linux,"Returns true if the argument is present, false otherwise."
v1.7.0-linux,build image file name
v1.7.0-linux,write image file
v1.7.0-linux,"Write PNG image, already compressed in binary"
v1.7.0-linux,write to CSV file
v1.7.0-linux,"Either images were saved successfully, or there were no images"
v1.7.0-linux,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.7.0-linux,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.7.0-linux,"Just need any 1 instance, to set the header line of the record file"
v1.7.0-linux,"Set is_ready at the end, setting this before can cause a race when the file isn't open yet"
v1.7.0-linux,make sure all vars are set up
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,decide which derived BP to use
v1.7.0-linux,we don't have real vehicle so no vehicle API
v1.7.0-linux,put camera little bit above vehicle
v1.7.0-linux,update ground level
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,let base class setup physics world
v1.7.0-linux,stop physics thread before we dismantle
v1.7.0-linux,setup clock in ClockFactory
v1.7.0-linux,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.7.0-linux,steppable clock returns interval that is a constant number irrespective of wall clock
v1.7.0-linux,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.7.0-linux,but that would cause vehicles like quadrotors to become unstable
v1.7.0-linux,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.7.0-linux,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.7.0-linux,get increase in clock speed
v1.7.0-linux,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.7.0-linux,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.7.0-linux,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.7.0-linux,Approach 2: scale control loop frequency if clock is speeded up
v1.7.0-linux,"for slowing down, this don't generate instability"
v1.7.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.7.0-linux,decide which derived BP to use
v1.7.0-linux,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.7.0-linux,vehicle_sim_api->reset();
v1.7.0-linux,create vehicle API
v1.7.0-linux,setup physics vehicle
v1.7.0-linux,initialize private vars
v1.7.0-linux,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.7.0-linux,calls to update* are handled by physics engine and in SimModeWorldBase
v1.7.0-linux,"Utils::log(""------Render tick-------"");"
v1.7.0-linux,"if reset is pending then do it first, no need to do other things until next tick"
v1.7.0-linux,move collision info from rendering engine to vehicle
v1.7.0-linux,update rotor poses
v1.7.0-linux,update private rotor variable
v1.7.0-linux,if we did reset then don't worry about synchronizing states for this tick
v1.7.0-linux,Continue to wait for reset
v1.7.0-linux,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.7.0-linux,*** Start: UpdatableState implementation ***//
v1.7.0-linux,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.7.0-linux,environment update for current position
v1.7.0-linux,update forces on vertices
v1.7.0-linux,update to controller must be done after kinematics have been updated by physics engine
v1.7.0-linux,*** End: UpdatableState implementation ***//
v1.7.0-linux,get references of existing camera
v1.7.0-linux,setup clock in PhysX
v1.7.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.7.0-linux,decide which derived BP to use
v1.7.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.7.0-linux,Setup suspension forces
v1.7.0-linux,Find the tire object and set the data for it
v1.7.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.7.0-linux,Setup suspension forces
v1.7.0-linux,Find the tire object and set the data for it
v1.7.0-linux,Create In-Car camera component
v1.7.0-linux,In car HUD
v1.7.0-linux,Create text render component for in car speed display
v1.7.0-linux,Create text render component for in car gear display
v1.7.0-linux,Setup the audio component and allocate it a sound cue
v1.7.0-linux,Colors for the in-car gear display. One for normal one for reverse
v1.7.0-linux,Wheels/Tires
v1.7.0-linux,Setup the wheels
v1.7.0-linux,Adjust the tire loading
v1.7.0-linux,Engine
v1.7.0-linux,Torque setup
v1.7.0-linux,Adjust the steering
v1.7.0-linux,Transmission
v1.7.0-linux,We want 4wd
v1.7.0-linux,Drive the front wheels a little more than the rear
v1.7.0-linux,Automatic gearbox
v1.7.0-linux,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.7.0-linux,Physics settings
v1.7.0-linux,Adjust the center of mass - the buggy is quite low
v1.7.0-linux,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.7.0-linux,put camera little bit above vehicle
v1.7.0-linux,update physics material
v1.7.0-linux,Update the strings used in the HUD (in-car and on-screen)
v1.7.0-linux,Set the string in the in-car HUD
v1.7.0-linux,Pass the engine RPM to the sound component
v1.7.0-linux,Start an engine sound playing
v1.7.0-linux,Using FText because this is display text that should be localizable
v1.7.0-linux,Setup the text render component strings
v1.7.0-linux,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.7.0-linux,below is not needed
v1.7.0-linux,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.7.0-linux,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.7.0-linux,create vehicle params
v1.7.0-linux,TODO: should do reset() here?
v1.7.0-linux,these are called on render ticks
v1.7.0-linux,TODO: do we need this for cars?
v1.7.0-linux,TODO: move this to SimModeBase?
v1.7.0-linux,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.7.0-linux,reset();
v1.7.0-linux,return;
v1.7.0-linux,}
v1.7.0-linux,Thrustmaster devices
v1.7.0-linux,"Anything else, typically Logitech G920 wheel"
v1.7.0-linux,Two steel levers behind wheel
v1.7.0-linux,if API-client control is not active then we route keyboard/joystick control to car
v1.7.0-linux,all car controls from anywhere must be routed through API component
v1.7.0-linux,*** Start: UpdatableState implementation ***//
v1.7.0-linux,physics tick
v1.7.0-linux,*** End: UpdatableState implementation ***//
v1.7.0-linux,TODO: directly accept getVehicleSimApis() using generic container
v1.7.0-linux,Reset the vehicle as well before registering it
v1.7.0-linux,Similar to what happens in initializeForPlay() above
v1.7.0-linux,remove everything that we created in BeginPlay
v1.7.0-linux,wait if no new frame is renderd
v1.7.0-linux,we use custom debug reporting for this class
v1.7.0-linux,perform any expensive rendering update outside of lock region
v1.7.0-linux,no need to call base reset because of our custom implementation
v1.7.0-linux,TODO: this is going to cause circular references which is fine here but
v1.7.0-linux,in future we should consider moving SimMode not derived from AActor and move
v1.7.0-linux,it to AirLib and directly implement WorldSimApiBase interface
v1.7.0-linux,get player start
v1.7.0-linux,this must be done from within actor otherwise we don't get player start
v1.7.0-linux,Grab player location
v1.7.0-linux,Move the world origin to the player's location (this moves the coordinate system and adds
v1.7.0-linux,a corresponding offset to all positions to compensate for the shift)
v1.7.0-linux,"Regrab the player's position after the offset has been added (which should be 0,0,0 now)"
v1.7.0-linux,UWeatherLib::showWeatherMenu(World);
v1.7.0-linux,else don't init
v1.7.0-linux,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v1.7.0-linux,tod_sim_clock_start_ needs to be reset here.
v1.7.0-linux,Going from enabled to disabled
v1.7.0-linux,do these in the end to ensure that advanceTimeOfDay() doesn't see
v1.7.0-linux,any inconsistent state.
v1.7.0-linux,should be overridden by derived class
v1.7.0-linux,should be overriden by derived class
v1.7.0-linux,should be overridden by derived class
v1.7.0-linux,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.7.0-linux,default setup - this should be overridden in derived modes as needed
v1.7.0-linux,setup clock in ClockFactory
v1.7.0-linux,default implementation
v1.7.0-linux,create director
v1.7.0-linux,create external camera required for the director
v1.7.0-linux,for each camera in settings
v1.7.0-linux,get pose
v1.7.0-linux,spawn and attach camera to pawn
v1.7.0-linux,add on to our collection
v1.7.0-linux,API server start/stop
v1.7.0-linux,get UU origin of global NED frame
v1.7.0-linux,compute initial pose
v1.7.0-linux,spawn vehicle pawn
v1.7.0-linux,create vehicle sim api
v1.7.0-linux,Convert to lowercase as done during settings loading
v1.7.0-linux,TODO: Figure out a better way to add more fields
v1.7.0-linux,Maybe allow passing a JSON string for the vehicle settings?
v1.7.0-linux,"Retroactively adjust AirSimSettings, so it's like we knew about this vehicle all along"
v1.7.0-linux,"Usually physics registration happens at init, in ASimModeWorldBase::initializeForPlay(), but not in this case"
v1.7.0-linux,get UU origin of global NED frame
v1.7.0-linux,determine camera director camera default pose and spawn it
v1.7.0-linux,find all vehicle pawns
v1.7.0-linux,add vehicles from settings
v1.7.0-linux,if vehicle is of type for derived SimMode and auto creatable
v1.7.0-linux,create API objects for each pawn we have
v1.7.0-linux,Create External Cameras
v1.7.0-linux,TODO: better handle no FPV vehicles scenario
v1.7.0-linux,derived class shoudl override this method to add new vehicle to the physics engine
v1.7.0-linux,derived class should override this method to retrieve types of pawns they support
v1.7.0-linux,derived class should override this method to retrieve types of pawns they support
v1.7.0-linux,derived class should override this method to retrieve types of pawns they support
v1.7.0-linux,derived class should override this method to retrieve types of pawns they support
v1.7.0-linux,derived class should override this method to retrieve types of pawns they support
v1.7.0-linux,derived class should override this method to retrieve types of pawns they support
v1.7.0-linux,derived class should override this method to retrieve types of pawns they support
v1.7.0-linux,Draws debug-points on main viewport for Lidar laser hits.
v1.7.0-linux,Used for debugging only.
v1.7.0-linux,Currently we are checking the sensor-collection instead of sensor-settings.
v1.7.0-linux,Also using variables to optimize not checking the collection if not needed.
v1.7.0-linux,TODO: Is it incorrect to assume LidarSimple here?
v1.7.0-linux,Draw debug-point on main viewport for Distance sensor hit
v1.7.0-linux,Find position of point hit
v1.7.0-linux,Similar to UnrealDistanceSensor.cpp#L19
v1.7.0-linux,order of Pose addition is important here because it also adds quaternions which is not commutative!
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,ctor
v1.7.0-linux,initializes information based on lidar configuration
v1.7.0-linux,calculate verticle angle distance between each laser
v1.7.0-linux,store vertical angles for each laser
v1.7.0-linux,returns a point-cloud for the tick
v1.7.0-linux,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.7.0-linux,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.7.0-linux,calculate number of points needed for each laser/channel
v1.7.0-linux,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.7.0-linux,calculate needed angle/distance between each point
v1.7.0-linux,normalize FOV start/end
v1.7.0-linux,shoot lasers
v1.7.0-linux,check if the laser is outside the requested horizontal FOV
v1.7.0-linux,"shoot laser and get the impact point, if any"
v1.7.0-linux,simulate shooting a laser via Unreal ray-tracing.
v1.7.0-linux,start position
v1.7.0-linux,We need to compose rotations here rather than rotate a vector by a quaternion
v1.7.0-linux,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.7.0-linux,get ray quaternion in lidar frame (angles must be in radians)
v1.7.0-linux,get ray quaternion in body frame
v1.7.0-linux,get ray quaternion in world frame
v1.7.0-linux,get ray vector (end position)
v1.7.0-linux,Store the segmentation id of the hit object.
v1.7.0-linux,Debug code for very specific cases.
v1.7.0-linux,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.7.0-linux,decide the frame for the point-cloud
v1.7.0-linux,current detault behavior; though it is probably not very useful.
v1.7.0-linux,not changing the default for now to maintain backwards-compat.
v1.7.0-linux,point in vehicle intertial frame
v1.7.0-linux,tranform to lidar frame
v1.7.0-linux,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.7.0-linux,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.7.0-linux,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.7.0-linux,"On the client side, if it is needed to transform this data back to the world frame,"
v1.7.0-linux,"then do the equivalent of following,"
v1.7.0-linux,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.7.0-linux,See SimModeBase::drawLidarDebugPoints()
v1.7.0-linux,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.7.0-linux,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,update ray tracing
v1.7.0-linux,"FString hit_name = FString(""None"");"
v1.7.0-linux,if (dist_hit.GetActor())
v1.7.0-linux,hit_name=dist_hit.GetActor()->GetName();
v1.7.0-linux,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.7.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,This assumes you are running DroneServer already on the same machine.
v1.7.0-linux,DroneServer must be running first.
v1.7.0-linux,enable API control
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,Load gazebo
v1.7.0-linux,Create our node for communication
v1.7.0-linux,Listen to Gazebo topics
v1.7.0-linux,Make sure to shut everything down.
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,move commands
v1.7.0-linux,else leave as it is
v1.7.0-linux,TODO: get these in one call
v1.7.0-linux,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.7.0-linux,TODO: shouldn't we pass folder path?
v1.7.0-linux,parse
v1.7.0-linux,group the images by the current date.
v1.7.0-linux,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.7.0-linux,{
v1.7.0-linux,"return """";"
v1.7.0-linux,}
v1.7.0-linux,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.7.0-linux,{
v1.7.0-linux,return false;
v1.7.0-linux,}
v1.7.0-linux,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.7.0-linux,params.context->client.newTask();
v1.7.0-linux,}
v1.7.0-linux,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.7.0-linux,params.context->client.WaitForCompletion(0);
v1.7.0-linux,}
v1.7.0-linux,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.7.0-linux,{
v1.7.0-linux,}
v1.7.0-linux,parse command line
v1.7.0-linux,Shell callbacks
v1.7.0-linux,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.7.0-linux,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.7.0-linux,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.7.0-linux,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.7.0-linux,Add shell commands
v1.7.0-linux,TODO: add WaitForCompletion command
v1.7.0-linux,"TODO: add command line args help, arg count validation"
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v1.7.0-linux,switch to explicit hover mode so that this is the fall back when
v1.7.0-linux,move* commands are finished.
v1.7.0-linux,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.7.0-linux,TODO: implement weather for Unity
v1.7.0-linux,TODO: implement weather for Unity
v1.7.0-linux,----------------Plotting APIs-----------/
v1.7.0-linux,Recording APIs
v1.7.0-linux,"Remove '' from the list, representing default vehicle"
v1.7.0-linux,CinemAirSim
v1.7.0-linux,End CinemAirSim
v1.7.0-linux,Function pointers to hold the addresses of the functions that are defined in Unity
v1.7.0-linux,"Enabling all LogLevels,"
v1.7.0-linux,"Enabling all LogLevels,"
v1.7.0-linux,delete ltm;
v1.7.0-linux,initialize state
v1.7.0-linux,compute our home point
v1.7.0-linux,default behavior is to call update every tick
v1.7.0-linux,"for custom physics engine, this method should be overridden and update should be"
v1.7.0-linux,called from every physics tick
v1.7.0-linux,these will be available for devices like steering wheels
v1.7.0-linux,sync environment from kinematics
v1.7.0-linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.7.0-linux,FVector unrealPosition = getUUPosition();
v1.7.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v1.7.0-linux,parameters in NED frame
v1.7.0-linux,allow teleportation
v1.7.0-linux,if collisions are not enabled
v1.7.0-linux,or we have collided but passthrough is enabled
v1.7.0-linux,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.7.0-linux,"without flip flopping, collisions can't be detected"
v1.7.0-linux,by default we update kinematics from UE pawn
v1.7.0-linux,if SimMod uses its own physics engine then this should be overriden
v1.7.0-linux,no default action in this base class
v1.7.0-linux,TODO: because this bug we are using alternative code with stringstream
v1.7.0-linux,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.7.0-linux,update kinematics from pawn's movement instead of physics engine
v1.7.0-linux,TODO: update other fields?
v1.7.0-linux,implements getImages() method in the ImageCaptureBase class.
v1.7.0-linux,update ray tracing
v1.7.0-linux,Attempts to parse the settings text from one of multiple locations.
v1.7.0-linux,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.7.0-linux,"Next, check the executable's working directory for the settings file."
v1.7.0-linux,"Finally, check the user's documents folder."
v1.7.0-linux,"If the settings file cannot be read, throw an exception"
v1.7.0-linux,let base class setup physics world
v1.7.0-linux,stop physics thread before we dismantle
v1.7.0-linux,setup clock in ClockFactory
v1.7.0-linux,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.7.0-linux,steppable clock returns interval that is a constant number irrespective of wall clock
v1.7.0-linux,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.7.0-linux,but that would cause vehicles like quadrotors to become unstable
v1.7.0-linux,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.7.0-linux,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.7.0-linux,get increase in clock speed
v1.7.0-linux,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.7.0-linux,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.7.0-linux,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.7.0-linux,Approach 2: scale control loop frequency if clock is speeded up
v1.7.0-linux,"for slowing down, this don't generate instability"
v1.7.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.7.0-linux,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.7.0-linux,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.7.0-linux,create vehicle API
v1.7.0-linux,setup physics vehicle
v1.7.0-linux,initialize private vars
v1.7.0-linux,"if reset is pending then do it first, no need to do other things until next tick"
v1.7.0-linux,move collision info from rendering engine to vehicle
v1.7.0-linux,update rotor poses
v1.7.0-linux,if we did reset then don't worry about synchronizing states for this tick
v1.7.0-linux,Continue to wait for reset
v1.7.0-linux,*** Start: UpdatableState implementation ***//
v1.7.0-linux,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.7.0-linux,environment update for current position
v1.7.0-linux,update forces on vertices
v1.7.0-linux,update to controller must be done after kinematics have been updated by physics engine
v1.7.0-linux,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.7.0-linux,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.7.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.7.0-linux,*** End: UpdatableState implementation ***//
v1.7.0-linux,TODO: should do reset() here?
v1.7.0-linux,these are called on render ticks
v1.7.0-linux,TODO: do we need this for cars?
v1.7.0-linux,Thrustmaster devices
v1.7.0-linux,"Anything else, typically Logitech G920 wheel"
v1.7.0-linux,Two steel levers behind wheel
v1.7.0-linux,if API-client control is not active then we route keyboard/joystick control to car
v1.7.0-linux,This is so that getCarControls API works correctly
v1.7.0-linux,"API is enabled, so we use the controls set by API"
v1.7.0-linux,Update whether to use API controls or keyboard controls
v1.7.0-linux,*** Start: UpdatableState implementation ***//
v1.7.0-linux,physics tick
v1.7.0-linux,void CarPawnSimApi::reportState(StateReporter& reporter)
v1.7.0-linux,{
v1.7.0-linux,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.7.0-linux,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.7.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.7.0-linux,}
v1.7.0-linux,*** End: UpdatableState implementation ***//
v1.7.0-linux,remove everything that we created in BeginPlay
v1.7.0-linux,we use custom debug reporting for this class
v1.7.0-linux,perform any expensive rendering update outside of lock region
v1.7.0-linux,no need to call base reset because of our custom implementation
v1.7.0-linux,should be overridden by derived class
v1.7.0-linux,should be overridden by derived class
v1.7.0-linux,should be overridden by derived class
v1.7.0-linux,commenting this out for now to avoid unintentional Unity startup failure
v1.7.0-linux,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v1.7.0-linux,should be overridden by derived class
v1.7.0-linux,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.7.0-linux,default setup - this should be overridden in derived modes as needed
v1.7.0-linux,setup clock in ClockFactory
v1.7.0-linux,API server start/stop
v1.7.0-linux,determine camera director camera default pose and spawn it
v1.7.0-linux,derived class should override this method to retrieve types of pawns they support
v1.7.0-linux,derived class should override this method to retrieve types of pawns they support
v1.7.0-linux,can we just take origin in Unity here?
v1.7.0-linux,60 acres park:
v1.7.0-linux,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.7.0-linux,marymoore park
v1.7.0-linux,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.7.0-linux,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.7.0-linux,DepthNavThreshold depthNav;
v1.7.0-linux,DepthNavOptAStar depthNav;
v1.7.0-linux,DepthNavThreshold depthNav;
v1.7.0-linux,DepthNavOptAStar depthNav;
v1.7.0-linux,Cleanup
v1.7.0-linux,runDepthNavGT();
v1.7.0-linux,runDepthNavSGM();
v1.7.0-linux,Create the launch description and populate
v1.7.0-linux,Declare the launch options
v1.7.0-linux,todo do not reset if already in air?
v1.7.0-linux,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.7.0-linux,ros params
v1.7.0-linux,todo enforce dynamics constraints in this node as well?
v1.7.0-linux,"nh_->get_parameter(""max_vert_vel_"", max_vert_vel_);"
v1.7.0-linux,"nh_->get_parameter(""max_horz_vel"", max_horz_vel_)"
v1.7.0-linux,subscribe to control commands on global nodehandle
v1.7.0-linux,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.7.0-linux,bind to a single callback. todo optimal subs queue length
v1.7.0-linux,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.7.0-linux,"vehicle_ros.reset_srvr = nh_->create_service(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.7.0-linux,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.7.0-linux,camera_setting.gimbal
v1.7.0-linux,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.7.0-linux,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.7.0-linux,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.7.0-linux,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.7.0-linux,"if {DepthPlanar, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.7.0-linux,"push back pair (vector of image captures, current vehicle name)"
v1.7.0-linux,iterate over sensors
v1.7.0-linux,add takeoff and land all services if more than 2 drones
v1.7.0-linux,todo add per vehicle reset in AirLib API
v1.7.0-linux,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.7.0-linux,lidars update on their own callback/thread at a given rate
v1.7.0-linux,QoS - The depth of the publisher message queue.
v1.7.0-linux,more details here - https://docs.ros.org/en/foxy/Concepts/About-Quality-of-Service-Settings.html
v1.7.0-linux,"todo: error check. if state is not landed, return error."
v1.7.0-linux,response->success =
v1.7.0-linux,response->success =
v1.7.0-linux,response->success =
v1.7.0-linux,response->success =
v1.7.0-linux,response->success =
v1.7.0-linux,response->success =
v1.7.0-linux,todo add reset by vehicle_name API to airlib
v1.7.0-linux,todo not async remove wait_on_last_task
v1.7.0-linux,todo expose wait_on_last_task or nah?
v1.7.0-linux,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.7.0-linux,todo expose wait_on_last_task or nah?
v1.7.0-linux,todo support multiple gimbal commands
v1.7.0-linux,todo support multiple gimbal commands
v1.7.0-linux,1. find quaternion of default gimbal pose
v1.7.0-linux,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.7.0-linux,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.7.0-linux,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.7.0-linux,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.7.0-linux,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.7.0-linux,msg = []
v1.7.0-linux,todo covariances
v1.7.0-linux,gps_msg.position_covariance_type =
v1.7.0-linux,gps_msg.position_covariance =
v1.7.0-linux,todo covariances
v1.7.0-linux,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.7.0-linux,todo radians per second
v1.7.0-linux,meters/s2^m
v1.7.0-linux,imu_msg.orientation_covariance = ;
v1.7.0-linux,imu_msg.angular_velocity_covariance = ;
v1.7.0-linux,imu_msg.linear_acceleration_covariance = ;
v1.7.0-linux,todo do actual body frame?
v1.7.0-linux,airsim uses degrees
v1.7.0-linux,airsim appears to use chrono::system_clock with nanosecond precision
v1.7.0-linux,todo this is global origin
v1.7.0-linux,get the basic vehicle pose and environmental state
v1.7.0-linux,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.7.0-linux,airsim_client needs to provide the simulation time in a future version of the API
v1.7.0-linux,publish the simulation clock
v1.7.0-linux,"publish vehicle state, odom, and all basic sensor types"
v1.7.0-linux,send any commands out to the vehicles
v1.7.0-linux,"should be easier way to get the sim time through API, something like:"
v1.7.0-linux,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.7.0-linux,curr_ros_time = airsim_timestamp_to_ros(env.clock().nowNanos());
v1.7.0-linux,iterate over drones
v1.7.0-linux,get drone state from airsim
v1.7.0-linux,"vehicle environment, we can get ambient temperature here and other truths"
v1.7.0-linux,convert airsim drone state to ROS msgs
v1.7.0-linux,simulation environment truth
v1.7.0-linux,"dashboard reading from car, RPM, gear, etc"
v1.7.0-linux,odom and transforms
v1.7.0-linux,ground truth GPS position from sim/HITL
v1.7.0-linux,send control commands from the last callback to airsim
v1.7.0-linux,send control commands from the last callback to airsim
v1.7.0-linux,"Only camera rotation, no translation movement of camera"
v1.7.0-linux,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.7.0-linux,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.7.0-linux,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.7.0-linux,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.7.0-linux,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.7.0-linux,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.7.0-linux,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.7.0-linux,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.7.0-linux,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.7.0-linux,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.7.0-linux,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.7.0-linux,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.7.0-linux,update timestamp of saved cam info msgs
v1.7.0-linux,DepthPlanar / DepthPerspective / DepthVis / DisparityNormalized
v1.7.0-linux,Scene / Segmentation / SurfaceNormals / Infrared
v1.7.0-linux,publish camera transforms
v1.7.0-linux,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.7.0-linux,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.7.0-linux,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.7.0-linux,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.7.0-linux,ROS params
v1.7.0-linux,ROS publishers
v1.7.0-linux,ROS subscribers
v1.7.0-linux,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.7.0-linux,ROS timers
v1.7.0-linux,todo maintain internal representation as eigen vec?
v1.7.0-linux,todo check if low velocity if within thresh?
v1.7.0-linux,todo maintain separate errors for XY and Z
v1.7.0-linux,todo save this in degrees somewhere to avoid repeated conversion
v1.7.0-linux,this tells the update timer callback to not do active hovering
v1.7.0-linux,todo maintain array of position goals
v1.7.0-linux,todo error checks
v1.7.0-linux,todo fill response
v1.7.0-linux,"Already have goal, and have reached it"
v1.7.0-linux,this tells the update timer callback to not do active hovering
v1.7.0-linux,todo error checks
v1.7.0-linux,todo fill response
v1.7.0-linux,"todo do relative altitude, or add an option for the same?"
v1.7.0-linux,convert GPS goal to NED goal
v1.7.0-linux,"RCLCPP_INFO_STREAM(""geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.7.0-linux,todo error checks
v1.7.0-linux,todo fill response
v1.7.0-linux,"Already have goal, this shouldn't happen"
v1.7.0-linux,"todo do relative altitude, or add an option for the same?"
v1.7.0-linux,convert GPS goal to NED goal
v1.7.0-linux,"RCLCPP_INFO_STREAM(""geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.7.0-linux,todo error checks
v1.7.0-linux,todo fill response
v1.7.0-linux,todo check if odometry is too old!!
v1.7.0-linux,"if no odom, don't do anything."
v1.7.0-linux,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.7.0-linux,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.7.0-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.7.0-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.7.0-linux,todo yaw limits
v1.7.0-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.7.0-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.7.0-linux,mimics void ASimHUD::initializeSettings()
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,by Sudipta Sinha
v1.7.0-linux,adapted for AirSim by Matthias Mueller
v1.7.0-linux,first row
v1.7.0-linux,last row
v1.7.0-linux,Local quadratic fit of cost and subpixel refinement.
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,by Sudipta Sinha
v1.7.0-linux,adapted for AirSim by Matthias Mueller
v1.7.0-linux,uint64_t x64 = (uint64_t)x;
v1.7.0-linux,uint64_t y64 = (uint64_t)y;
v1.7.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-linux,Licensed under the MIT License.
v1.7.0-linux,by Sudipta Sinha
v1.7.0-linux,adapted for AirSim by Matthias Mueller
v1.7.0-linux,ensure that disparity range is a multiple of 8
v1.7.0-linux,sgm stereo
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,read settings and override defaults
v1.7.0-windows,allow json overrides on a per-vehicle basis.
v1.7.0-windows,start server in async mode
v1.7.0-windows,check messages
v1.7.0-windows,plot red arrows for 30 seconds
v1.7.0-windows,plot magenta arrows for 15 seconds
v1.7.0-windows,plot red arrows for 10 seconds
v1.7.0-windows,plot 2 white arrows which are persistent
v1.7.0-windows,plot points
v1.7.0-windows,"plot line strip. 0-1, 1-2, 2-3"
v1.7.0-windows,"plot line list. 0-1, 2-3, 4-5. Must be even."
v1.7.0-windows,plot transforms
v1.7.0-windows,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=0.0, yaw=yaw)) for x, y, yaw in zip(np.linspace(0,10,10), np.linspace(0,0,10), np.linspace(0,np.pi,10))],"
v1.7.0-windows,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.7.0-windows,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=roll, yaw=0.0)) for x, y, roll in zip(np.linspace(0,10,10), np.linspace(1,1,10), np.linspace(0,np.pi,10))],"
v1.7.0-windows,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.7.0-windows,Access an existing light in the world
v1.7.0-windows,Destroy the light
v1.7.0-windows,Create a new light at the same pose
v1.7.0-windows,Change the light's intensity
v1.7.0-windows,asset_name = random.choice(assets)
v1.7.0-windows,Import this module to automatically setup path to local airsim module
v1.7.0-windows,This module first tries to see if airsim module is installed via pip
v1.7.0-windows,If it does then we don't do anything else
v1.7.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.7.0-windows,and if it does then we add that in sys.path
v1.7.0-windows,this class simply tries to see if airsim
v1.7.0-windows,if airsim module is installed then don't do anything else
v1.7.0-windows,import pkgutil
v1.7.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.7.0-windows,if airsim_loader is not None:
v1.7.0-windows,return
v1.7.0-windows,In settings.json first activate computer vision mode:
v1.7.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.7.0-windows,monitor car state while you drive it manually.
v1.7.0-windows,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v1.7.0-windows,denominator from microns^3 to microns * m^2)
v1.7.0-windows,First set everything to 0.
v1.7.0-windows,Next set all objects of interest provided to corresponding object IDs
v1.7.0-windows,segIdDict values MUST match tempEmissivityNew labels.
v1.7.0-windows,"Connect to AirSim, UAV mode."
v1.7.0-windows,Choose temperature values for winter or summer.
v1.7.0-windows,""""""""
v1.7.0-windows,winter
v1.7.0-windows,""""""""
v1.7.0-windows,summer
v1.7.0-windows,Read camera response.
v1.7.0-windows,Calculate radiance.
v1.7.0-windows,Set IDs in AirSim environment.
v1.7.0-windows,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.7.0-windows,save pic
v1.7.0-windows,Change the below dimensions appropriately for the camera settings
v1.7.0-windows,In settings.json first activate computer vision mode:
v1.7.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.7.0-windows,"define abstract class to return next vector in the format (x,y,yaw)"
v1.7.0-windows,"compute vector, distance and angle to goal"
v1.7.0-windows,compute box of interest
v1.7.0-windows,scale by weight matrix (optional)
v1.7.0-windows,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.7.0-windows,detect collision
v1.7.0-windows,compute box of interest
v1.7.0-windows,detect collision
v1.7.0-windows,Same as above but decide to go left or right based on average or some metric like that
v1.7.0-windows,"compute resultant normalized vector, distance and angle"
v1.7.0-windows,compute bounding box size
v1.7.0-windows,convert horizonal fov to vertical fov
v1.7.0-windows,matrix with all ones
v1.7.0-windows,matrix with max weight in center and decreasing linearly with distance from center
v1.7.0-windows,matrix with max weight in center and decreasing quadratically with distance from center
v1.7.0-windows,"print (""Saving images to %s"" % tmp_dir)"
v1.7.0-windows,airsim.wait_key('Press any key to start')
v1.7.0-windows,"Define start position, goal and size of UAV"
v1.7.0-windows,Define parameters and thresholds
v1.7.0-windows,initial position
v1.7.0-windows,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.7.0-windows,time.sleep(1)
v1.7.0-windows,get response
v1.7.0-windows,get numpy array
v1.7.0-windows,reshape array to 2D array H X W
v1.7.0-windows,write to png
v1.7.0-windows,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.7.0-windows,pose = client.simGetPose()
v1.7.0-windows,pp.pprint(pose)
v1.7.0-windows,time.sleep(5)
v1.7.0-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.7.0-windows,################### OLD CODE
v1.7.0-windows,timer = 0
v1.7.0-windows,time_obs = 50
v1.7.0-windows,bObstacle = False
v1.7.0-windows,if (bObstacle):
v1.7.0-windows,timer = timer + 1
v1.7.0-windows,if timer > time_obs:
v1.7.0-windows,bObstacle = False
v1.7.0-windows,timer = 0
v1.7.0-windows,else:
v1.7.0-windows,yaw = target_angle
v1.7.0-windows,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.7.0-windows,if (np.average(img2d_box) < coll_thres):
v1.7.0-windows,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.7.0-windows,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.7.0-windows,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.7.0-windows,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.7.0-windows,"print('left: ', img2d_box_l_avg)"
v1.7.0-windows,"print('right: ', img2d_box_r_avg)"
v1.7.0-windows,if img2d_box_l_avg > img2d_box_r_avg:
v1.7.0-windows,##Go LEFT
v1.7.0-windows,#y_offset = y_offset-1
v1.7.0-windows,yaw = yaw - radians(10)
v1.7.0-windows,bObstacle = True
v1.7.0-windows,else:
v1.7.0-windows,##Go RIGHT
v1.7.0-windows,#y_offset = y_offset+1
v1.7.0-windows,yaw = yaw + radians(10)
v1.7.0-windows,bObstacle = true
v1.7.0-windows,"print('yaw: ', yaw)"
v1.7.0-windows,In settings.json first activate computer vision mode:
v1.7.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.7.0-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.7.0-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.7.0-windows,pip install opencv-python
v1.7.0-windows,Just change the below to test different cameras easily!
v1.7.0-windows,Test Camera info
v1.7.0-windows,Test Image APIs
v1.7.0-windows,Test FoV API
v1.7.0-windows,Test Pose APIs
v1.7.0-windows,Test Distortion params APIs
v1.7.0-windows,In settings.json first activate computer vision mode:
v1.7.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.7.0-windows,In settings.json first activate computer vision mode:
v1.7.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.7.0-windows,for block environment
v1.7.0-windows,regex are case insensitive
v1.7.0-windows,#for neighborhood environment
v1.7.0-windows,set object ID for sky
v1.7.0-windows,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.7.0-windows,get segmentation image in various formats
v1.7.0-windows,save segmentation images in various formats
v1.7.0-windows,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.7.0-windows,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.7.0-windows,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v1.7.0-windows,find unique colors
v1.7.0-windows,In settings.json first activate computer vision mode:
v1.7.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.7.0-windows,objects can be named in two ways:
v1.7.0-windows,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.7.0-windows,default name is auto-generated and varies from run-to-run.
v1.7.0-windows,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.7.0-windows,
v1.7.0-windows,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.7.0-windows,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.7.0-windows,https://answers.unrealengine.com/revisions/790629.html
v1.7.0-windows,below works in Blocks environment
v1.7.0-windows,------------------------------------ Get current pose ------------------------------------------------
v1.7.0-windows,search object by name:
v1.7.0-windows,search another object by tag
v1.7.0-windows,search non-existent object
v1.7.0-windows,------------------------------------ Set new pose ------------------------------------------------
v1.7.0-windows,here we move with teleport enabled so collisions are ignored
v1.7.0-windows,here we move with teleport enabled so collisions are not ignored
v1.7.0-windows,move non-existent object
v1.7.0-windows,------------------------------------ Get new pose ------------------------------------------------
v1.7.0-windows,search another object by tag
v1.7.0-windows,search non-existent object
v1.7.0-windows,Import this module to automatically setup path to local airsim module
v1.7.0-windows,This module first tries to see if airsim module is installed via pip
v1.7.0-windows,If it does then we don't do anything else
v1.7.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.7.0-windows,and if it does then we add that in sys.path
v1.7.0-windows,this class simply tries to see if airsim
v1.7.0-windows,if airsim module is installed then don't do anything else
v1.7.0-windows,import pkgutil
v1.7.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.7.0-windows,if airsim_loader is not None:
v1.7.0-windows,return
v1.7.0-windows,"Roll is applied first, then pitch, then yaw."
v1.7.0-windows,Turn the camera position into a column vector.
v1.7.0-windows,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v1.7.0-windows,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v1.7.0-windows,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v1.7.0-windows,Recreate the perspective projection of the camera.
v1.7.0-windows,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v1.7.0-windows,Set pose and sleep after to ensure the pose sticks before capturing image.
v1.7.0-windows,Capture segmentation (IR) and scene images.
v1.7.0-windows,Change images into numpy arrays.
v1.7.0-windows,Capture images for a certain amount of time in seconds (half hour now)
v1.7.0-windows,Capture image - pose.position x_val access may change w/ AirSim
v1.7.0-windows,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v1.7.0-windows,Convert color scene image to BGR for write out with cv2.
v1.7.0-windows,"Connect to AirSim, UAV mode."
v1.7.0-windows,Look for objects with names that match a regular expression.
v1.7.0-windows,"Sample calls to main, varying camera angle and altitude."
v1.7.0-windows,"straight down, 400ft"
v1.7.0-windows,"straight down, 200ft"
v1.7.0-windows,"45 degrees, 200ft -- note that often object won't be scene since position"
v1.7.0-windows,is set exactly to object's
v1.7.0-windows,"45 degrees, 400ft -- note that often object won't be scene since position"
v1.7.0-windows,is set exactly to object's
v1.7.0-windows,In settings.json first activate computer vision mode:
v1.7.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.7.0-windows,xn = 1 + x*5  # some random number
v1.7.0-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,monitor car state while you drive it manually.
v1.7.0-windows,get state of the car
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,!/usr/bin/env python3
v1.7.0-windows,-*- coding: utf-8 -*-
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,set the controls for car
v1.7.0-windows,let car drive a bit
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,go forward
v1.7.0-windows,get state of the car
v1.7.0-windows,Python client example to change time-of-day using APIs
v1.7.0-windows,
v1.7.0-windows,Changes time of the day and makes the car move around
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,flip between specific time and default time
v1.7.0-windows,go forward
v1.7.0-windows,Go forward + steer right
v1.7.0-windows,main
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,get state of the car
v1.7.0-windows,go forward
v1.7.0-windows,Go forward + steer right
v1.7.0-windows,go reverse
v1.7.0-windows,apply brakes
v1.7.0-windows,get camera images from the car
v1.7.0-windows,restore to original state
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,go forward
v1.7.0-windows,Python client example to get Lidar data from a car
v1.7.0-windows,
v1.7.0-windows,Makes the drone fly and get Lidar data
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,"print(""state: %s"" % s)"
v1.7.0-windows,go forward
v1.7.0-windows,Go forward + steer right
v1.7.0-windows,"reshape array of floats to array of [X,Y,Z]"
v1.7.0-windows,TODO
v1.7.0-windows,main
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,get state of the car
v1.7.0-windows,go forward
v1.7.0-windows,Go forward + steer right
v1.7.0-windows,go reverse
v1.7.0-windows,apply breaks
v1.7.0-windows,restore to original state
v1.7.0-windows,Sleep for some time to wait for other vehicles to be created
v1.7.0-windows,"driveCar(vehicle_name, client)"
v1.7.0-windows,go forward
v1.7.0-windows,Go forward + steer right
v1.7.0-windows,go reverse
v1.7.0-windows,apply brakes
v1.7.0-windows,Import this module to automatically setup path to local airsim module
v1.7.0-windows,This module first tries to see if airsim module is installed via pip
v1.7.0-windows,If it does then we don't do anything else
v1.7.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.7.0-windows,and if it does then we add that in sys.path
v1.7.0-windows,this class simply tries to see if airsim
v1.7.0-windows,if airsim module is installed then don't do anything else
v1.7.0-windows,import pkgutil
v1.7.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.7.0-windows,if airsim_loader is not None:
v1.7.0-windows,return
v1.7.0-windows,Use below in settings.json with blocks environment
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,get state of the car
v1.7.0-windows,go forward
v1.7.0-windows,go reverse
v1.7.0-windows,apply breaks
v1.7.0-windows,get camera images from the car
v1.7.0-windows,restore to original state
v1.7.0-windows,from keras.models import load_model
v1.7.0-windows,if (len(sys.argv) != 2):
v1.7.0-windows,print('usage: python drive.py <modelName>')
v1.7.0-windows,sys.exit()
v1.7.0-windows,print('Loading model...')
v1.7.0-windows,model = load_model(sys.argv[1])
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.7.0-windows,"model_output = model.predict([image_buf, state_buf])"
v1.7.0-windows,car_controls.steering = float(model_output[0][0])
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,set camera name and image type to request images and detections
v1.7.0-windows,set detection radius in [cm]
v1.7.0-windows,add desired object name to detect in wild card/regex format
v1.7.0-windows,Import this module to automatically setup path to local airsim module
v1.7.0-windows,This module first tries to see if airsim module is installed via pip
v1.7.0-windows,If it does then we don't do anything else
v1.7.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.7.0-windows,and if it does then we add that in sys.path
v1.7.0-windows,this class simply tries to see if airsim
v1.7.0-windows,if airsim module is installed then don't do anything else
v1.7.0-windows,import pkgutil
v1.7.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.7.0-windows,if airsim_loader is not None:
v1.7.0-windows,return
v1.7.0-windows,-*- coding: utf-8 -*-
v1.7.0-windows,
v1.7.0-windows,Configuration file for the Sphinx documentation builder.
v1.7.0-windows,
v1.7.0-windows,This file does only contain a selection of the most common options. For a
v1.7.0-windows,full list see the documentation:
v1.7.0-windows,http://www.sphinx-doc.org/en/master/config
v1.7.0-windows,-- Path setup --------------------------------------------------------------
v1.7.0-windows,"If extensions (or modules to document with autodoc) are in another directory,"
v1.7.0-windows,add these directories to sys.path here. If the directory is relative to the
v1.7.0-windows,"documentation root, use os.path.abspath to make it absolute, like shown here."
v1.7.0-windows,
v1.7.0-windows,-- Project information -----------------------------------------------------
v1.7.0-windows,The short X.Y version
v1.7.0-windows,"The full version, including alpha/beta/rc tags"
v1.7.0-windows,-- General configuration ---------------------------------------------------
v1.7.0-windows,"If your documentation needs a minimal Sphinx version, state it here."
v1.7.0-windows,
v1.7.0-windows,needs_sphinx = '1.0'
v1.7.0-windows,"Add any Sphinx extension module names here, as strings. They can be"
v1.7.0-windows,extensions coming with Sphinx (named 'sphinx.ext.*') or your custom
v1.7.0-windows,ones.
v1.7.0-windows,"Add any paths that contain templates here, relative to this directory."
v1.7.0-windows,The suffix(es) of source filenames.
v1.7.0-windows,You can specify multiple suffix as a list of string:
v1.7.0-windows,
v1.7.0-windows,"source_suffix = ['.rst', '.md']"
v1.7.0-windows,The master toctree document.
v1.7.0-windows,The language for content autogenerated by Sphinx. Refer to documentation
v1.7.0-windows,for a list of supported languages.
v1.7.0-windows,
v1.7.0-windows,This is also used if you do content translation via gettext catalogs.
v1.7.0-windows,"Usually you set ""language"" from the command line for these cases."
v1.7.0-windows,"List of patterns, relative to source directory, that match files and"
v1.7.0-windows,directories to ignore when looking for source files.
v1.7.0-windows,This pattern also affects html_static_path and html_extra_path.
v1.7.0-windows,The name of the Pygments (syntax highlighting) style to use.
v1.7.0-windows,-- Options for HTML output -------------------------------------------------
v1.7.0-windows,The theme to use for HTML and HTML Help pages.  See the documentation for
v1.7.0-windows,a list of builtin themes.
v1.7.0-windows,
v1.7.0-windows,html_theme = 'alabaster'
v1.7.0-windows,Theme options are theme-specific and customize the look and feel of a theme
v1.7.0-windows,"further.  For a list of options available for each theme, see the"
v1.7.0-windows,documentation.
v1.7.0-windows,
v1.7.0-windows,html_theme_options = {}
v1.7.0-windows,"Add any paths that contain custom static files (such as style sheets) here,"
v1.7.0-windows,"relative to this directory. They are copied after the builtin static files,"
v1.7.0-windows,"so a file named ""default.css"" will overwrite the builtin ""default.css""."
v1.7.0-windows,"Custom sidebar templates, must be a dictionary that maps document names"
v1.7.0-windows,to template names.
v1.7.0-windows,
v1.7.0-windows,The default sidebars (for documents that don't match any pattern) are
v1.7.0-windows,defined by theme itself.  Builtin themes are using these templates by
v1.7.0-windows,"default: ``['localtoc.html', 'relations.html', 'sourcelink.html',"
v1.7.0-windows,'searchbox.html']``.
v1.7.0-windows,
v1.7.0-windows,html_sidebars = {}
v1.7.0-windows,-- Options for HTMLHelp output ---------------------------------------------
v1.7.0-windows,Output file base name for HTML help builder.
v1.7.0-windows,-- Options for LaTeX output ------------------------------------------------
v1.7.0-windows,The paper size ('letterpaper' or 'a4paper').
v1.7.0-windows,
v1.7.0-windows,"'papersize': 'letterpaper',"
v1.7.0-windows,"The font size ('10pt', '11pt' or '12pt')."
v1.7.0-windows,
v1.7.0-windows,"'pointsize': '10pt',"
v1.7.0-windows,Additional stuff for the LaTeX preamble.
v1.7.0-windows,
v1.7.0-windows,"'preamble': '',"
v1.7.0-windows,Latex figure (float) alignment
v1.7.0-windows,
v1.7.0-windows,"'figure_align': 'htbp',"
v1.7.0-windows,Grouping the document tree into LaTeX files. List of tuples
v1.7.0-windows,"(source start file, target name, title,"
v1.7.0-windows,"author, documentclass [howto, manual, or own class])."
v1.7.0-windows,-- Options for manual page output ------------------------------------------
v1.7.0-windows,One entry per manual page. List of tuples
v1.7.0-windows,"(source start file, name, description, authors, manual section)."
v1.7.0-windows,-- Options for Texinfo output ----------------------------------------------
v1.7.0-windows,Grouping the document tree into Texinfo files. List of tuples
v1.7.0-windows,"(source start file, target name, title, author,"
v1.7.0-windows,"dir menu entry, description, category)"
v1.7.0-windows,-- Options for Epub output -------------------------------------------------
v1.7.0-windows,Bibliographic Dublin Core info.
v1.7.0-windows,The unique identifier of the text. This can be a ISBN number
v1.7.0-windows,or the project homepage.
v1.7.0-windows,
v1.7.0-windows,epub_identifier = ''
v1.7.0-windows,A unique identification for the text.
v1.7.0-windows,
v1.7.0-windows,epub_uid = ''
v1.7.0-windows,A list of files that should not be packed into the epub file.
v1.7.0-windows,-- Extension configuration -------------------------------------------------
v1.7.0-windows,-- Options for intersphinx extension ---------------------------------------
v1.7.0-windows,Example configuration for intersphinx: refer to the Python standard library.
v1.7.0-windows,-- Options for todo extension ----------------------------------------------
v1.7.0-windows,"If true, `todo` and `todoList` produce output, else they produce nothing."
v1.7.0-windows,We ignore the 2D nature of the problem as it is not relevant here
v1.7.0-windows,It makes multi-core processing more straightforward
v1.7.0-windows,Allocations
v1.7.0-windows,Add small number to avoid issues with log(I)
v1.7.0-windows,Event sim keeps track of previous image automatically
v1.7.0-windows,"Using pickle dump in a per-frame fashion to save time, instead of savetxt"
v1.7.0-windows,Optimizations possible
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,that's enough fun for now. let's quit cleanly
v1.7.0-windows,"Python client example to get Lidar data from a drone, although this script works for any AirSim-supported vehicle"
v1.7.0-windows,This script is for Lidar sensors using 'SensorLocalFrame' as DataFrame under settings.json.
v1.7.0-windows,Sample settings.json used for this script:
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,main
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,MultirotorClient.wait_key('Press any key to takeoff')
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,get camera images from the car
v1.7.0-windows,that's enough fun for now. let's quit cleanly
v1.7.0-windows,##################################################################################################
v1.7.0-windows,
v1.7.0-windows,Project:  Embedded Learning Library (ELL)
v1.7.0-windows,File:     speaker.py
v1.7.0-windows,Authors:  Chris Lovett
v1.7.0-windows,
v1.7.0-windows,Requires: Python 3.x
v1.7.0-windows,
v1.7.0-windows,##################################################################################################
v1.7.0-windows,open speakers so we can hear what it is processing...
v1.7.0-windows,teleport the drone + 10 meters in x-direction
v1.7.0-windows,teleport the drone back
v1.7.0-windows,This example shows how to use the External Physics Engine
v1.7.0-windows,It allows you to control the drone through setVehiclePose and obtain collision information.
v1.7.0-windows,It is especially useful for injecting your own flight dynamics model to the AirSim drone.
v1.7.0-windows,Use Blocks environment to see the drone colliding and seeing the collision information
v1.7.0-windows,in the command prompt.
v1.7.0-windows,Add this line to your settings.json before running AirSim:
v1.7.0-windows,"""PhysicsEngineName"":""ExternalPhysicsEngine"""
v1.7.0-windows,use open cv to create point cloud from depth image.
v1.7.0-windows,###########################################
v1.7.0-windows,######### This is work in progress! #######
v1.7.0-windows,###########################################
v1.7.0-windows,file will be saved in PythonClient folder (i.e. same folder as script)
v1.7.0-windows,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.7.0-windows,skip it
v1.7.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.7.0-windows,z of -7 is 7 meters above the original launch point.
v1.7.0-windows,Fly given velocity vector for 5 seconds
v1.7.0-windows,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.7.0-windows,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.7.0-windows,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.7.0-windows,Make the drone fly in a circle.
v1.7.0-windows,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.7.0-windows,check that our home position is stable
v1.7.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.7.0-windows,ramp up time
v1.7.0-windows,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.7.0-windows,compute current angle
v1.7.0-windows,compute lookahead
v1.7.0-windows,if we did the takeoff then also do the landing.
v1.7.0-windows,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.7.0-windows,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.7.0-windows,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.7.0-windows,ignore the click over from 360 back to 0
v1.7.0-windows,watch direction this diff is moving if it switches from shrinking to growing
v1.7.0-windows,then we passed the starting point.
v1.7.0-windows,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.7.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.7.0-windows,z of -5 is 5 meters above the original launch point.
v1.7.0-windows,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.7.0-windows,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.7.0-windows,drone will over-shoot so we bring it back to the start point before landing.
v1.7.0-windows,"Python client example to get Lidar data from a drone, although this script works for any AirSim-supported vehicle"
v1.7.0-windows,This script is for Lidar sensors using 'VehicleInertialFrame' as DataFrame under settings.json
v1.7.0-windows,Sample settings.json used for this script:
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,main
v1.7.0-windows,Run this script with clock speed in settings.json
v1.7.0-windows,"""ClockSpeed"": 1 then change it to 0.5"
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,with ClockSpeed = 0.5 you will see that this takes 6s (system time) and not 3s
v1.7.0-windows,with ClockSpeed = 0.5 you will see that this takes 10s (system time)
v1.7.0-windows,and not 5s in each iteration
v1.7.0-windows,that's enough fun for now. let's quit cleanly
v1.7.0-windows,Takeoff or hover
v1.7.0-windows,Set wind to 0
v1.7.0-windows,Takeoff or hover
v1.7.0-windows,In settings.json first activate computer vision mode:
v1.7.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.7.0-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.7.0-windows,pip install opencv-python
v1.7.0-windows,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.7.0-windows,fly for 2 minutes
v1.7.0-windows,more than 50 centimeter drift is unacceptable.
v1.7.0-windows,Python client example to get Lidar data from a drone
v1.7.0-windows,
v1.7.0-windows,Makes the drone fly and get Lidar data
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,"print(""state: %s"" % s)"
v1.7.0-windows,"print(""state: %s"" % pprint.pformat(state))"
v1.7.0-windows,"reshape array of floats to array of [X,Y,Z]"
v1.7.0-windows,TODO
v1.7.0-windows,main
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.7.0-windows,let it settle there a bit.
v1.7.0-windows,after hovering we need to re-enabled api control for next leg of the trip
v1.7.0-windows,now compute the survey path required to fill the box
v1.7.0-windows,##################################################################################################
v1.7.0-windows,
v1.7.0-windows,Project:  Embedded Learning Library (ELL)
v1.7.0-windows,File:     wav_reader.py
v1.7.0-windows,Authors:  Chris Lovett
v1.7.0-windows,
v1.7.0-windows,Requires: Python 3.x
v1.7.0-windows,
v1.7.0-windows,##################################################################################################
v1.7.0-windows,open a stream on the audio input file.
v1.7.0-windows,"assumes signed integer used in raw audio, so for example, the max for 16bit is 2^15 (32768)"
v1.7.0-windows,convert int16 data to scaled floats
v1.7.0-windows,configure output stream to match what we are resampling to...
v1.7.0-windows,convert the audio to the desired recording rate
v1.7.0-windows,split into separate channels
v1.7.0-windows,drop the channels we don't want
v1.7.0-windows,zip the resulting channels back up.
v1.7.0-windows,convert back to packed bytes in PCM 16 format
v1.7.0-windows,"deal with any accumulation of tails, if the tail grows to a full"
v1.7.0-windows,buffer then return it!
v1.7.0-windows,"we have a tail from previous frame, so prepend it"
v1.7.0-windows,"now the caller needs us to stick to our sample_size contract, but when"
v1.7.0-windows,rate conversion happens we can't be sure that 'data' is exactly that size.
v1.7.0-windows,usually one byte extra so add this to our accumulating tail
v1.7.0-windows,"might have reached the end of a file, so pad with zeros."
v1.7.0-windows,"Please add ""EnableTrace"": true to your setting.json as shown below"
v1.7.0-windows,{
v1.7.0-windows,"""SettingsVersion"": 1.2,"
v1.7.0-windows,"""SimMode"": ""Multirotor"","
v1.7.0-windows,"""Vehicles"": {"
v1.7.0-windows,"""Drone"": {"
v1.7.0-windows,"""VehicleType"": ""SimpleFlight"","
v1.7.0-windows,"""EnableTrace"": true"
v1.7.0-windows,}
v1.7.0-windows,}
v1.7.0-windows,}
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,add new vehicle
v1.7.0-windows,Use below in settings.json with Blocks environment
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,get camera images from the car
v1.7.0-windows,that's enough fun for now. let's quit cleanly
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,Import this module to automatically setup path to local airsim module
v1.7.0-windows,This module first tries to see if airsim module is installed via pip
v1.7.0-windows,If it does then we don't do anything else
v1.7.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.7.0-windows,and if it does then we add that in sys.path
v1.7.0-windows,this class simply tries to see if airsim
v1.7.0-windows,if airsim module is installed then don't do anything else
v1.7.0-windows,import pkgutil
v1.7.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.7.0-windows,if airsim_loader is not None:
v1.7.0-windows,return
v1.7.0-windows,"this script moves the drone to a location, then rests it thousands of time"
v1.7.0-windows,purpose of this script is to stress test reset API
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,that's enough fun for now. let's quite cleanly
v1.7.0-windows,For high speed ascent and descent on PX4 you may need to set these properties:
v1.7.0-windows,param set MPC_Z_VEL_MAX_UP 5
v1.7.0-windows,param set MPC_Z_VEL_MAX_DN 5
v1.7.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.7.0-windows,z of -50 is 50 meters above the original launch point.
v1.7.0-windows,use open cv to show new images from AirSim
v1.7.0-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.7.0-windows,pip install opencv-python
v1.7.0-windows,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.7.0-windows,get depth image
v1.7.0-windows,"this will return png width= 256, height= 144"
v1.7.0-windows,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.7.0-windows,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.7.0-windows,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.7.0-windows,to get an estimate of distance.
v1.7.0-windows,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.7.0-windows,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.7.0-windows,an angular delta of the following pi/10.
v1.7.0-windows,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.7.0-windows,Remove alpha channel if exists
v1.7.0-windows,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.7.0-windows,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.7.0-windows,Flatten and yield as tuple
v1.7.0-windows,Initialize a resizable dataset to hold the output
v1.7.0-windows,Resize the dataset to accommodate the next chunk of rows
v1.7.0-windows,Create the next chunk
v1.7.0-windows,Increment the row count
v1.7.0-windows,Arguments
v1.7.0-windows,Returns
v1.7.0-windows,use composition of homographies
v1.7.0-windows,to generate final transform that needs to be applied
v1.7.0-windows,Arguments
v1.7.0-windows,Returns
v1.7.0-windows,Keeps under lock only the mechanism which advances
v1.7.0-windows,the indexing of each batch.
v1.7.0-windows,The transformation of images is not under thread lock
v1.7.0-windows,so it can be done in parallel
v1.7.0-windows,Trained model path
v1.7.0-windows,Connect to AirSim
v1.7.0-windows,Start driving
v1.7.0-windows,Initialize image buffer
v1.7.0-windows,Update throttle value according to steering angle
v1.7.0-windows,Prediction
v1.7.0-windows,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.7.0-windows,Print progress
v1.7.0-windows,Update next car state
v1.7.0-windows,Wait a bit between iterations
v1.7.0-windows,%matplotlib inline
v1.7.0-windows,chunk size for training batches
v1.7.0-windows,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.7.0-windows,Point this to the directory containing the raw data
v1.7.0-windows,Point this to the desired output directory for the cooked (.h5) data
v1.7.0-windows,Choose The folders to search for data under RAW_DATA_DIR
v1.7.0-windows,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.7.0-windows,data_folder.append('folder_name1')
v1.7.0-windows,data_folder.append('folder_name2')
v1.7.0-windows,...
v1.7.0-windows,Hyper-parameters
v1.7.0-windows,Activation functions
v1.7.0-windows,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.7.0-windows,<< The directory containing the cooked data from the previous step >>
v1.7.0-windows,<< The directory in which the model output will be placed >>
v1.7.0-windows,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.7.0-windows,Network definition
v1.7.0-windows,Import this module to automatically setup path to local airsim module
v1.7.0-windows,This module first tries to see if airsim module is installed via pip
v1.7.0-windows,If it does then we don't do anything else
v1.7.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.7.0-windows,and if it does then we add that in sys.path
v1.7.0-windows,this class simply tries to see if airsim
v1.7.0-windows,if airsim module is installed then don't do anything else
v1.7.0-windows,import pkgutil
v1.7.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.7.0-windows,if airsim_loader is not None:
v1.7.0-windows,return
v1.7.0-windows,DEY: I don't know why this was there.
v1.7.0-windows,----------------------------------- Common vehicle APIs ---------------------------------------------
v1.7.0-windows,basic flight control
v1.7.0-windows,time-of-day control
v1.7.0-windows,time - of - day control
v1.7.0-windows,weather
v1.7.0-windows,camera control
v1.7.0-windows,simGetImage returns compressed png in array of bytes
v1.7.0-windows,image_type uses one of the ImageType members
v1.7.0-windows,"todo : in future remove below, it's only for compatibility to pre v1.2"
v1.7.0-windows,"because this method returns std::vector < uint8>, msgpack decides to encode it as a string unfortunately."
v1.7.0-windows,camera control
v1.7.0-windows,simGetImage returns compressed png in array of bytes
v1.7.0-windows,image_type uses one of the ImageType members
v1.7.0-windows,CinemAirSim
v1.7.0-windows,End CinemAirSim
v1.7.0-windows,gets the static meshes in the unreal scene
v1.7.0-windows,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.7.0-windows,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.7.0-windows,TODO : below str() conversion is only needed for legacy reason and should be removed in future
v1.7.0-windows,sensor APIs
v1.7.0-windows,Plotting APIs
v1.7.0-windows,Recording APIs
v1.7.0-windows,Add new vehicle via RPC
v1.7.0-windows,----------------------------------- Multirotor APIs ---------------------------------------------
v1.7.0-windows,APIs for control
v1.7.0-windows,low - level control API
v1.7.0-windows,query vehicle state
v1.7.0-windows,query rotor states
v1.7.0-windows,----------------------------------- Car APIs ---------------------------------------------
v1.7.0-windows,helper method for converting getOrientation to roll/pitch/yaw
v1.7.0-windows,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.7.0-windows,roll (x-axis rotation)
v1.7.0-windows,pitch (y-axis rotation)
v1.7.0-windows,yaw (z-axis rotation)
v1.7.0-windows,DEY: I don't know why this was there.
v1.7.0-windows,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.7.0-windows,return cls(**msgpack.unpack(encoded))
v1.7.0-windows,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.7.0-windows,Create a DummyVecEnv for main airsim gym env
v1.7.0-windows,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.7.0-windows,Initialize RL algorithm type and parameters
v1.7.0-windows,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.7.0-windows,Train for a certain number of timesteps
v1.7.0-windows,Save policy weights
v1.7.0-windows,Create a DummyVecEnv for main airsim gym env
v1.7.0-windows,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.7.0-windows,Initialize RL algorithm type and parameters
v1.7.0-windows,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.7.0-windows,Train for a certain number of timesteps
v1.7.0-windows,Save policy weights
v1.7.0-windows,Import this module to automatically setup path to local airsim module
v1.7.0-windows,This module first tries to see if airsim module is installed via pip
v1.7.0-windows,If it does then we don't do anything else
v1.7.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.7.0-windows,and if it does then we add that in sys.path
v1.7.0-windows,this class simply tries to see if airsim
v1.7.0-windows,if airsim module is installed then don't do anything else
v1.7.0-windows,import pkgutil
v1.7.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.7.0-windows,if airsim_loader is not None:
v1.7.0-windows,return
v1.7.0-windows,Set home position and velocity
v1.7.0-windows,print(dist)
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,"This is a bit crude, but give it a moment to settle on the ground, else takeoff will fail"
v1.7.0-windows,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.7.0-windows,switch to explicit hover mode so that this is the fallback when
v1.7.0-windows,move* commands are finished.
v1.7.0-windows,"Altitude difference between each platform, in meters"
v1.7.0-windows,"Count down, so the first one can easily go the highest (without knowing count)"
v1.7.0-windows,"in header only mode, control library is not available"
v1.7.0-windows,if using Unreal Build system then include precompiled header file first
v1.7.0-windows,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.7.0-windows,"Windows, OSX and Linux."
v1.7.0-windows,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.7.0-windows,Windows users can move the Documents folder to any location they want
v1.7.0-windows,SHGetFolderPath knows how to find it.
v1.7.0-windows,fall back in case SHGetFolderPath failed for some reason.
v1.7.0-windows,convert from std::path '/' to windows backslash.
v1.7.0-windows,make the current thread run with maximum priority.
v1.7.0-windows,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.7.0-windows,TODO: How to handle POSIX thread priorities on OSX?
v1.7.0-windows,setThreadName is a helper function that is useful when debugging because your threads
v1.7.0-windows,show up in the debugger with the name you set which makes it easier to find the threads
v1.7.0-windows,that you are interested in.
v1.7.0-windows,"unfortunately this is only available on Windows 10, and AirSim is not limited to that."
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.7.0-windows,
v1.7.0-windows,Treat all errors as failure conditions.
v1.7.0-windows,parse command line
v1.7.0-windows,"motive gives a weird error if the project is not found, so we look for it."
v1.7.0-windows,Do an update to pick up any recently-arrived cameras.
v1.7.0-windows,List all detected cameras.
v1.7.0-windows,List all defined rigid bodies.
v1.7.0-windows,throttle to 50 messages per second.
v1.7.0-windows,OptiTrack uses 'y' axis for vertical.
v1.7.0-windows,stdafx.cpp : source file that includes just the standard includes
v1.7.0-windows,MavlinkMoCap.pch will be the pre-compiled header
v1.7.0-windows,stdafx.obj will contain the pre-compiled type information
v1.7.0-windows,TODO: reference any additional headers you need in STDAFX.H
v1.7.0-windows,and not in this file
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,PX4.cpp : Defines the entry point for the console application.
v1.7.0-windows,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.7.0-windows,how do you write to the debug output windows on Unix ?
v1.7.0-windows,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.7.0-windows,connection to create to talke to that server.
v1.7.0-windows,SITL setup info
v1.7.0-windows,The local ethernet interface to use (default localhost).
v1.7.0-windows,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.7.0-windows,server mode on UDP is when you want another app to connect to Pixhawk and publish data back to this process.
v1.7.0-windows,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.7.0-windows,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.7.0-windows,"using their the -qgc option.  Server mode on TCP means mavlinktest will do an ""accept"" socket which is"
v1.7.0-windows,what PX4 is waiting for when it is running in TCP mode.  Here the serverEndPoint is different from the
v1.7.0-windows,offboardEndPoint.  The serverEndPoint specifies which local address to use in case your computer has
v1.7.0-windows,multiple network interfaces.
v1.7.0-windows,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.7.0-windows,this switch controls whether we turn off the RC remote active link loss detection
v1.7.0-windows,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.7.0-windows,from kicking in when you try and fly.
v1.7.0-windows,parse the json
v1.7.0-windows,flatten inner mavlink object
v1.7.0-windows,flatten inner mavlink object
v1.7.0-windows,todo
v1.7.0-windows,todo
v1.7.0-windows,"const char* outLogFileOption = ""outlogfile"";"
v1.7.0-windows,parse command line
v1.7.0-windows,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.7.0-windows,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.7.0-windows,"no local serial connection, so this is the primary droneConnection."
v1.7.0-windows,need a retry loop here because we don't know how quickly px4 will start accepting these connections...
v1.7.0-windows,failed to connect
v1.7.0-windows,"then we need 2 mavlink channels, one for sending/receiving HIL_* messages and the other"
v1.7.0-windows,for controlling the drone.
v1.7.0-windows,this is the control channel.
v1.7.0-windows,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.7.0-windows,cmdTable.push_back(new AltHoldCommand());
v1.7.0-windows,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.7.0-windows,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.7.0-windows,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.7.0-windows,this stops us from being able to connect to SITL mode PX4.
v1.7.0-windows,checkPulse();
v1.7.0-windows,add command text in log
v1.7.0-windows,close previous command.
v1.7.0-windows,FilterLogFiles(logDirectory);
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,send a heartbeat
v1.7.0-windows,accept one incoming connection
v1.7.0-windows,send a heartbeat to the client
v1.7.0-windows,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.7.0-windows,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.7.0-windows,for this unit test we are expecting a request to send an image.
v1.7.0-windows,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.7.0-windows,hmmm
v1.7.0-windows,================ ls
v1.7.0-windows,================ put file
v1.7.0-windows,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.7.0-windows,================ get file
v1.7.0-windows,verify the file contents.
v1.7.0-windows,================ remove file
v1.7.0-windows,================ make directory
v1.7.0-windows,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.7.0-windows,================ remove directory
v1.7.0-windows,Now verification
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,you must call this method if you want HandleMessage to be called subsequently.
v1.7.0-windows,treat literals as one word
v1.7.0-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.7.0-windows,request gps info
v1.7.0-windows,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.7.0-windows,find relative position since command start so we can compare two commands better
v1.7.0-windows,"these PID values are important, so set these to match"
v1.7.0-windows,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.7.0-windows,we can skip ahead.
v1.7.0-windows,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.7.0-windows,TODO: avoid passing hadcoded HIL flag
v1.7.0-windows,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.7.0-windows,"The global position, as returned by the Global Positioning System (GPS)."
v1.7.0-windows,Provides state for additional features
v1.7.0-windows,The general system state
v1.7.0-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.7.0-windows,Provides state for additional features
v1.7.0-windows,The general system state
v1.7.0-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.7.0-windows,Provides state for additional features
v1.7.0-windows,The general system state
v1.7.0-windows,Provides state for additional features
v1.7.0-windows,The general system state
v1.7.0-windows,note: we do not reset com when Close() is called because we want to keep running.
v1.7.0-windows,"user has to invoke ""hil stop"" to stop the hil thread."
v1.7.0-windows,generate random between 0 and 1
v1.7.0-windows,move to range -1 to 1
v1.7.0-windows,scale it
v1.7.0-windows,apply iy
v1.7.0-windows,wait for the Execute method to be called.
v1.7.0-windows,gps is much slower frequency than IMU.
v1.7.0-windows,MAVLINK_MSG_ID_HIL_GPS
v1.7.0-windows,disable MAV_USEHILGPS
v1.7.0-windows,note: we do not reset com when Close() is called because we want to keep running.
v1.7.0-windows,"user has to invoke ""hil stop"" to stop the hil thread."
v1.7.0-windows,generate random between 0 and 1
v1.7.0-windows,move to range -1 to 1
v1.7.0-windows,scale it
v1.7.0-windows,apply iy
v1.7.0-windows,wait for the Execute method to be called.
v1.7.0-windows,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.7.0-windows,gps is much slower frequency than IMU.
v1.7.0-windows,MAVLINK_MSG_ID_HIL_GPS
v1.7.0-windows,disable HIL mode
v1.7.0-windows,Enumeration of landed detector states
v1.7.0-windows,MAV landed state is unknown
v1.7.0-windows,MAV is landed (on ground)
v1.7.0-windows,MAV is in air
v1.7.0-windows,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.7.0-windows,The filtered local position
v1.7.0-windows,must send these regularly to keep offboard control.
v1.7.0-windows,"ok, now we can safely switch to loiter."
v1.7.0-windows,must send these regularly to keep offboard control.
v1.7.0-windows,integrate the heading so it is smoother.
v1.7.0-windows,must send these regularly to keep offboard control.
v1.7.0-windows,integrate the heading so it is smoother.
v1.7.0-windows,fly to radius
v1.7.0-windows,it takes about 10 cm to stop and turn.
v1.7.0-windows,next time around switch to orbiting!
v1.7.0-windows,heading points to center of circle.
v1.7.0-windows,interpoloate the speed ramp up time over 2 seconds from start time
v1.7.0-windows,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.7.0-windows,monitor the sin curves so we can see how on track or off track it actually is.
v1.7.0-windows,the shape of the curve will also tell us if we are progressing at a consistent
v1.7.0-windows,"speed, the more deformed the sin curve the worse our progress."
v1.7.0-windows,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.7.0-windows,degrees just flipped from 359 to 0.
v1.7.0-windows,this enables us to test what happens when offboard control is lost and resumed.
v1.7.0-windows,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.7.0-windows,"ok, now we can start moving by velocity"
v1.7.0-windows,recompute to new target.
v1.7.0-windows,start by moving right with 10 degree roll.
v1.7.0-windows,haven't started yet.
v1.7.0-windows,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.7.0-windows,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.7.0-windows,track how our actual pitch is coming along compared to our target
v1.7.0-windows,and check position
v1.7.0-windows,the amount of pitch should depend on our speed in that direction.
v1.7.0-windows,passed the midpoint.
v1.7.0-windows,fade out the pitch as we pick up speed so we don't overshoot.
v1.7.0-windows,see if we just crossed the wiggle distance threshold.
v1.7.0-windows,(pitch affects the x-position).
v1.7.0-windows,reverse direction with a -30 degrees quick stop
v1.7.0-windows,reverse direction with a 30 degrees quick stop
v1.7.0-windows,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.7.0-windows,too much in that direction.
v1.7.0-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.7.0-windows,track how our actual roll is coming along compared to our target
v1.7.0-windows,and check position
v1.7.0-windows,the amount of roll should depend on our speed in that direction.
v1.7.0-windows,passed the midpoint.
v1.7.0-windows,fade out the roll as we pick up speed so we don't overshoot.
v1.7.0-windows,see if we just crossed the wiggle distance threshold.
v1.7.0-windows,(roll affects the y-position).
v1.7.0-windows,reverse direction with a -30 degrees quick stop
v1.7.0-windows,reverse direction with a 30 degrees quick stop
v1.7.0-windows,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.7.0-windows,too much in that direction.
v1.7.0-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.7.0-windows,for testing PID controller.
v1.7.0-windows,class AltHoldCommand : public Command
v1.7.0-windows,{
v1.7.0-windows,std::shared_ptr<MavLinkVehicle> channel;
v1.7.0-windows,"float sx_, sy_, sz_;"
v1.7.0-windows,MavLinkAttitudeTarget _current;
v1.7.0-windows,PidController thrust_controller_;
v1.7.0-windows,public:
v1.7.0-windows,this->sz_ = pos.z; // user defined target.
v1.7.0-windows,move to local position keeps the offboard control happy.
v1.7.0-windows,haven't started yet.
v1.7.0-windows,and check position
v1.7.0-windows,double dx = this->sx_ - pos.x;
v1.7.0-windows,double dy = this->sy_ - pos.y;
v1.7.0-windows,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.7.0-windows,too much in that direction.
v1.7.0-windows,adjust thrust so we keep steady height target
v1.7.0-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.7.0-windows,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.7.0-windows,local remote
v1.7.0-windows,already handled by the parse method.
v1.7.0-windows,we only support very simple patterns for now.
v1.7.0-windows,each wildcard must be separated by literal.
v1.7.0-windows,back to back wildcards with no literal in between is too complex.
v1.7.0-windows,"we only support simple matching for now, we can add full regex later if we need it."
v1.7.0-windows,yep!
v1.7.0-windows,'*' is done we found the next matching char
v1.7.0-windows,this is ok.
v1.7.0-windows,this is an ERASE_END_LINE command which we ignore.
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,pack the payload buffer.
v1.7.0-windows,calculate checksum
v1.7.0-windows,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.7.0-windows,are variable length as a result.
v1.7.0-windows,form the header as a byte array for the crc
v1.7.0-windows,unpack the message...
v1.7.0-windows,pack the payload buffer.
v1.7.0-windows,"json can't handle ""nan"", so we convert it to null."
v1.7.0-windows,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.7.0-windows,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,start listening to this connection
v1.7.0-windows,Send heartbeat to drone.  You should not do this if some other node is
v1.7.0-windows,already doing it.
v1.7.0-windows,stop listening to the connection.
v1.7.0-windows,get the connection
v1.7.0-windows,Get the local system and component id
v1.7.0-windows,send a command to the remote node
v1.7.0-windows,MavLinkNode::MavLinkNode() = default;
v1.7.0-windows,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.7.0-windows,decrementing the count so the next WaitOne may block.
v1.7.0-windows,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.7.0-windows,convert to absolute time.
v1.7.0-windows,use mach_timespec
v1.7.0-windows,convert to absolute time.
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,return true if we still have offboard control (can lose this if user flips the switch).
v1.7.0-windows,MavLinkVehicle::MavLinkVehicle() = default;
v1.7.0-windows,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.7.0-windows,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,============================== CLIENT ============================================
v1.7.0-windows,image APIs
v1.7.0-windows,or if you are implementing the client side call this function to get the most recent frame.
v1.7.0-windows,returns false if there is no new frame available.
v1.7.0-windows,============================== SERVER ============================================
v1.7.0-windows,call this to send the image back over the connection given to start function.
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,"log every message that is ""sent"" using sendMessage."
v1.7.0-windows,"log every message that is ""received"""
v1.7.0-windows,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.7.0-windows,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.7.0-windows,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.7.0-windows,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,for compatibility with QGroundControl we have to save the time field in big endian.
v1.7.0-windows,todo: mavlink2 support?
v1.7.0-windows,has to be one or the other!
v1.7.0-windows,24 bits.
v1.7.0-windows,24 bits.
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,start listening to this connection
v1.7.0-windows,Send heartbeat to drone.  You should not do this if some other node is
v1.7.0-windows,already doing it.
v1.7.0-windows,this is called for all messages received on the connection.
v1.7.0-windows,"we received a heartbeat, so let's get the capabilities."
v1.7.0-windows,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.7.0-windows,subclasses remembering to call this base implementation.
v1.7.0-windows,stop listening to the connection.
v1.7.0-windows,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.7.0-windows,wait for a heartbeat msg since this will give us the port to send commands to...
v1.7.0-windows,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.7.0-windows,send a heart beat so that the remote node knows we are still alive
v1.7.0-windows,(otherwise drone will trigger a failsafe operation).
v1.7.0-windows,ignore any failures here because we are running in our own thread here.
v1.7.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.7.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.7.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.7.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.7.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.7.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.7.0-windows,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.7.0-windows,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.7.0-windows,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.7.0-windows,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.7.0-windows,"ok, now fetch the missing parameters."
v1.7.0-windows,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.7.0-windows,silently fail since we are on a background thread here...
v1.7.0-windows,tell the caller this is complete.
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,add our custom telemetry message length.
v1.7.0-windows,todo: if we support signing then initialize
v1.7.0-windows,mavlink_intermediate_status_.signing callbacks
v1.7.0-windows,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.7.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.7.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.7.0-windows,send this right away just in case serial link is not already configured
v1.7.0-windows,"log every message that is ""sent"" using sendMessage."
v1.7.0-windows,"log every message that is ""sent"" using sendMessage."
v1.7.0-windows,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.7.0-windows,pack the payload buffer.
v1.7.0-windows,calculate checksum
v1.7.0-windows,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.7.0-windows,are variable length as a result.
v1.7.0-windows,form the header as a byte array for the crc
v1.7.0-windows,these macros use old style cast.
v1.7.0-windows,forward messages from our connected node to the remote proxy.
v1.7.0-windows,tell the remote connection to expect mavlink2 messages.
v1.7.0-windows,forward messages from remote proxy to local connected node
v1.7.0-windows,CurrentThread::setMaximumPriority();
v1.7.0-windows,"hmmm, wait till it is opened?"
v1.7.0-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.7.0-windows,pick up the sysid/compid of the remote node we are connected to.
v1.7.0-windows,then this is a mavlink 1 message
v1.7.0-windows,then this mavlink sender supports mavlink 2
v1.7.0-windows,queue event for publishing.
v1.7.0-windows,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.7.0-windows,as it ensures we don't lose messages if the listener is slow.
v1.7.0-windows,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.7.0-windows,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.7.0-windows,we would get a deadlock.
v1.7.0-windows,CurrentThread::setMaximumPriority();
v1.7.0-windows,reset counters
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,------------------------------------------------------------------------------
v1.7.0-windows,Defines
v1.7.0-windows,------------------------------------------------------------------------------
v1.7.0-windows,bit number  876543210987654321
v1.7.0-windows,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.7.0-windows,in future it would be good to have ability to add system IDs we are interested in
v1.7.0-windows,if (msg.sysid != getTargetSystemId())
v1.7.0-windows,{
v1.7.0-windows,// we only care about messages from our intended remote node.
v1.7.0-windows,return;
v1.7.0-windows,}
v1.7.0-windows,user may have changed modes on us! So we need to honor that and not
v1.7.0-windows,try and take it back.
v1.7.0-windows,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.7.0-windows,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.7.0-windows,we can store up to 16 channels in rc_channels_scaled.
v1.7.0-windows,The RAW values of the servo outputs
v1.7.0-windows,Metrics typically displayed on a HUD for fixed wing aircraft
v1.7.0-windows,The IMU readings in SI units in NED body frame
v1.7.0-windows,printSystemStatus(&msg);
v1.7.0-windows,todo: use this to determine when we need to do emergency landing...
v1.7.0-windows,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.7.0-windows,Provides state for additional features
v1.7.0-windows,The general system state
v1.7.0-windows,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.7.0-windows,but we do want to know when we get the ack.  So this is async ACK processing!
v1.7.0-windows,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.7.0-windows,if threshold < 0 then the threshold is inverted.
v1.7.0-windows,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.7.0-windows,Convert it to a floating point number between -1 and 1.
v1.7.0-windows,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.7.0-windows,until the move commands start happening.
v1.7.0-windows,return true if user calls requestControl and has not called releaseControl.
v1.7.0-windows,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.7.0-windows,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.7.0-windows,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.7.0-windows,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.7.0-windows,send a few to make sure it gets through...
v1.7.0-windows,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.7.0-windows,us by which time the PX4 times out offboard mode!!
v1.7.0-windows,"assume this was successful, we'll find out if so in the next heartbeat."
v1.7.0-windows,this mode change take precedence over offboard mode.
v1.7.0-windows,thrust must be between -1 and 1.
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,These definitions are copied from PX4 implementation
v1.7.0-windows,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.7.0-windows,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.7.0-windows,/ @brief Command opcodes
v1.7.0-windows,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.7.0-windows,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.7.0-windows,must trim trailing slashes so PX4 doesn't hang!
v1.7.0-windows,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.7.0-windows,from the source.
v1.7.0-windows,check if directory exists.
v1.7.0-windows,perfect.
v1.7.0-windows,use last_message_ so we preserve the sessionid.
v1.7.0-windows,"could not create the local file, so stop."
v1.7.0-windows,must use last_message_ so we preserve the session id.
v1.7.0-windows,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.7.0-windows,todo: error handling here? sequence is out of order...
v1.7.0-windows,"directory must be empty then, can't do nextStep because"
v1.7.0-windows,it will just loop for ever re-requesting zero offset into
v1.7.0-windows,empty directory.
v1.7.0-windows,result should be a list of null terminated file names.
v1.7.0-windows,skipping this entry
v1.7.0-windows,remove the file size field.
v1.7.0-windows,"printf(""%s\n"", name.c_str());"
v1.7.0-windows,request the next batch.
v1.7.0-windows,"perhaps this was a late response after we did a retry, so ignore it."
v1.7.0-windows,"perhaps this was a late response after we did a retry, so ignore it."
v1.7.0-windows,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.7.0-windows,reached the end of the list or the file.
v1.7.0-windows,end of file or directory listing.
v1.7.0-windows,"success, data should be following..."
v1.7.0-windows,ack on this cmd is a noop
v1.7.0-windows,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.7.0-windows,give up then.
v1.7.0-windows,tell watchdog we are sending a request
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,================================= CLIENT ==============================================================
v1.7.0-windows,Check if we have a valid transaction
v1.7.0-windows,emit signal if all packets arrived
v1.7.0-windows,Restart statemachine
v1.7.0-windows,image APIs
v1.7.0-windows,================================= SERVER ==============================================================
v1.7.0-windows,Prepare and send acknowledgment packet
v1.7.0-windows,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.7.0-windows,Send ENCAPSULATED_IMAGE packet
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.7.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.7.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.7.0-windows,send this right away just in case serial link is not already configured
v1.7.0-windows,CurrentThread::setMaximumPriority();
v1.7.0-windows,"hmmm, wait till it is opened?"
v1.7.0-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.7.0-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.7.0-windows,queue event for publishing.
v1.7.0-windows,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.7.0-windows,as it ensures we don't lose messages if the listener is slow.
v1.7.0-windows,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.7.0-windows,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.7.0-windows,we would get a deadlock.
v1.7.0-windows,CurrentThread::setMaximumPriority();
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.7.0-windows,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.7.0-windows,parse out the VID number
v1.7.0-windows,now the PID
v1.7.0-windows,parse out the VID number
v1.7.0-windows,examples:
v1.7.0-windows,PX4: USB\VID_26AC&PID_0011\0
v1.7.0-windows,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.7.0-windows,"printf(""Found: %S\n"", buffer.c_str());"
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.7.0-windows,parse out the VID number
v1.7.0-windows,now the PID
v1.7.0-windows,parse out the VID number
v1.7.0-windows,suppress
v1.7.0-windows,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,This has not been properly tested
v1.7.0-windows,struct iw_statistics stats;
v1.7.0-windows,struct iwreq req;
v1.7.0-windows,"memset(&stats, 0, sizeof(stats));"
v1.7.0-windows,"memset(&req, 0, sizeof(iwreq));"
v1.7.0-windows,
v1.7.0-windows,"strncpy(req.ifr_name, ifaceName, 16);"
v1.7.0-windows,req.u.data.pointer = &stats;
v1.7.0-windows,req.u.data.length = sizeof(iw_statistics);
v1.7.0-windows,
v1.7.0-windows,#ifdef CLEAR_UPDATED
v1.7.0-windows,req.u.data.flags = 1;
v1.7.0-windows,#endif
v1.7.0-windows,
v1.7.0-windows,/* Perform the ioctl */
v1.7.0-windows,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.7.0-windows,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.7.0-windows,return -127;
v1.7.0-windows,}
v1.7.0-windows,
v1.7.0-windows,return stats.qual.level;
v1.7.0-windows,todo: windows version of this...
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,windows
v1.7.0-windows,Need to link with Ws2_32.lib
v1.7.0-windows,posix
v1.7.0-windows,found it!
v1.7.0-windows,This timeout is important as it allows the MavLinkConnection readPackets
v1.7.0-windows,thread to iterate and notice the connection is now closed. This allows
v1.7.0-windows,AirSim to shutdown properly when drone is not connected.
v1.7.0-windows,bind socket to local address.
v1.7.0-windows,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.7.0-windows,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.7.0-windows,try and reconnect
v1.7.0-windows,write to the serial port
v1.7.0-windows,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.7.0-windows,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.7.0-windows,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.7.0-windows,"try and receive something, up until port is closed anyway."
v1.7.0-windows,"message was too large for the buffer, no problem, return what we have."
v1.7.0-windows,try again - this can happen if server recreates the socket on their side.
v1.7.0-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.7.0-windows,"skip this, the receive just timed out, no problem, we'll try again later."
v1.7.0-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.7.0-windows,"printf(""#### recv failed with error: %d\n"", hr);"
v1.7.0-windows,we now have it.
v1.7.0-windows,this is from someone we are not interested in.
v1.7.0-windows,-----------------------------------------------------------------------------------------
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,Initialize Winsock
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,windows
v1.7.0-windows,Need to link with Ws2_32.lib
v1.7.0-windows,posix
v1.7.0-windows,found it!
v1.7.0-windows,bind socket to local address.
v1.7.0-windows,bind socket to local address.
v1.7.0-windows,start listening for incoming connection
v1.7.0-windows,accept 1
v1.7.0-windows,"don't need to accept any more, so we can close this one."
v1.7.0-windows,write to the serial port
v1.7.0-windows,"try and receive something, up until port is closed anyway."
v1.7.0-windows,"message was too large for the buffer, no problem, return what we have."
v1.7.0-windows,try again - this can happen if server recreates the socket on their side.
v1.7.0-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.7.0-windows,try again - this can happen if server recreates the socket on their side.
v1.7.0-windows,-----------------------------------------------------------------------------------------
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.7.0-windows,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.7.0-windows,set signal
v1.7.0-windows,Clear Handshake flags
v1.7.0-windows,Set Handshake flags
v1.7.0-windows,return GetLastError();
v1.7.0-windows,return GetLastError();
v1.7.0-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.7.0-windows,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.7.0-windows,enable reading
v1.7.0-windows,posix doesn't have mark/space parity.
v1.7.0-windows,posix doesn't have mark/space parity.
v1.7.0-windows,this is the default.
v1.7.0-windows,not sure this is supported...
v1.7.0-windows,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.7.0-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.7.0-windows,First do those specified by POSIX.
v1.7.0-windows,Now conditionally handle a bunch of extended rates.
v1.7.0-windows,First do those specified by POSIX.
v1.7.0-windows,Now conditionally handle a bunch of extended rates.
v1.7.0-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.7.0-windows,import airsim
v1.7.0-windows,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v1.7.0-windows,self.args = args
v1.7.0-windows,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v1.7.0-windows,pdb.set_trace()
v1.7.0-windows,#include <pluginlib/class_list_macros.h>
v1.7.0-windows,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v1.7.0-windows,todo do not reset if already in air?
v1.7.0-windows,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.7.0-windows,ros params
v1.7.0-windows,todo enforce dynamics constraints in this node as well?
v1.7.0-windows,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v1.7.0-windows,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v1.7.0-windows,XmlRpc::XmlRpcValue can't be const in this case
v1.7.0-windows,subscribe to control commands on global nodehandle
v1.7.0-windows,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.7.0-windows,bind to a single callback. todo optimal subs queue length
v1.7.0-windows,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.7.0-windows,TODO: ros::TransportHints().tcpNoDelay();
v1.7.0-windows,"vehicle_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.7.0-windows,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.7.0-windows,camera_setting.gimbal
v1.7.0-windows,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.7.0-windows,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.7.0-windows,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.7.0-windows,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.7.0-windows,"if {DepthPlanar, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.7.0-windows,"push back pair (vector of image captures, current vehicle name)"
v1.7.0-windows,iterate over sensors
v1.7.0-windows,"we want fast access to the lidar sensors for callback handling, sort them out now"
v1.7.0-windows,add takeoff and land all services if more than 2 drones
v1.7.0-windows,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v1.7.0-windows,todo add per vehicle reset in AirLib API
v1.7.0-windows,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.7.0-windows,lidars update on their own callback/thread at a given rate
v1.7.0-windows,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v1.7.0-windows,"todo: error check. if state is not landed, return error."
v1.7.0-windows,todo add reset by vehicle_name API to airlib
v1.7.0-windows,todo not async remove waitonlasttask
v1.7.0-windows,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v1.7.0-windows,todo do actual body frame?
v1.7.0-windows,airsim uses degrees
v1.7.0-windows,todo do actual body frame?
v1.7.0-windows,airsim uses degrees
v1.7.0-windows,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v1.7.0-windows,todo expose waitOnLastTask or nah?
v1.7.0-windows,todo do actual body frame?
v1.7.0-windows,airsim uses degrees
v1.7.0-windows,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.7.0-windows,todo expose waitOnLastTask or nah?
v1.7.0-windows,todo support multiple gimbal commands
v1.7.0-windows,todo support multiple gimbal commands
v1.7.0-windows,1. find quaternion of default gimbal pose
v1.7.0-windows,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.7.0-windows,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.7.0-windows,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.7.0-windows,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.7.0-windows,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.7.0-windows,msg = []
v1.7.0-windows,todo covariances
v1.7.0-windows,gps_msg.position_covariance_type =
v1.7.0-windows,gps_msg.position_covariance =
v1.7.0-windows,todo covariances
v1.7.0-windows,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.7.0-windows,todo radians per second
v1.7.0-windows,meters/s2^m
v1.7.0-windows,imu_msg.orientation_covariance = ;
v1.7.0-windows,imu_msg.angular_velocity_covariance = ;
v1.7.0-windows,imu_msg.linear_acceleration_covariance = ;
v1.7.0-windows,airsim appears to use chrono::system_clock with nanosecond precision
v1.7.0-windows,todo this is global origin
v1.7.0-windows,get the basic vehicle pose and environmental state
v1.7.0-windows,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.7.0-windows,airsim_client needs to provide the simulation time in a future version of the API
v1.7.0-windows,publish the simulation clock
v1.7.0-windows,"publish vehicle state, odom, and all basic sensor types"
v1.7.0-windows,send any commands out to the vehicles
v1.7.0-windows,"should be easier way to get the sim time through API, something like:"
v1.7.0-windows,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.7.0-windows,curr_ros_time = airsim_timestamp_to_ros(env.clock().nowNanos());
v1.7.0-windows,iterate over drones
v1.7.0-windows,get drone state from airsim
v1.7.0-windows,"vehicle environment, we can get ambient temperature here and other truths"
v1.7.0-windows,convert airsim drone state to ROS msgs
v1.7.0-windows,simulation environment truth
v1.7.0-windows,"dashboard reading from car, RPM, gear, etc"
v1.7.0-windows,odom and transforms
v1.7.0-windows,ground truth GPS position from sim/HITL
v1.7.0-windows,handled via callback
v1.7.0-windows,send control commands from the last callback to airsim
v1.7.0-windows,send control commands from the last callback to airsim
v1.7.0-windows,"Only camera rotation, no translation movement of camera"
v1.7.0-windows,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.7.0-windows,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.7.0-windows,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.7.0-windows,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.7.0-windows,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.7.0-windows,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.7.0-windows,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.7.0-windows,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.7.0-windows,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.7.0-windows,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.7.0-windows,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.7.0-windows,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.7.0-windows,update timestamp of saved cam info msgs
v1.7.0-windows,DepthPlanar / DepthPerspective / DepthVis / DisparityNormalized
v1.7.0-windows,Scene / Segmentation / SurfaceNormals / Infrared
v1.7.0-windows,publish camera transforms
v1.7.0-windows,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.7.0-windows,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.7.0-windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.7.0-windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.7.0-windows,ROS params
v1.7.0-windows,ROS publishers
v1.7.0-windows,ROS subscribers
v1.7.0-windows,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.7.0-windows,ROS timers
v1.7.0-windows,todo maintain internal representation as eigen vec?
v1.7.0-windows,todo check if low velocity if within thresh?
v1.7.0-windows,todo maintain separate errors for XY and Z
v1.7.0-windows,todo save this in degrees somewhere to avoid repeated conversion
v1.7.0-windows,this tells the update timer callback to not do active hovering
v1.7.0-windows,todo maintain array of position goals
v1.7.0-windows,todo error checks
v1.7.0-windows,todo fill response
v1.7.0-windows,"Already have goal, and have reached it"
v1.7.0-windows,this tells the update timer callback to not do active hovering
v1.7.0-windows,todo error checks
v1.7.0-windows,todo fill response
v1.7.0-windows,"todo do relative altitude, or add an option for the same?"
v1.7.0-windows,convert GPS goal to NED goal
v1.7.0-windows,todo error checks
v1.7.0-windows,todo fill response
v1.7.0-windows,"Already have goal, this shouldn't happen"
v1.7.0-windows,"todo do relative altitude, or add an option for the same?"
v1.7.0-windows,convert GPS goal to NED goal
v1.7.0-windows,todo error checks
v1.7.0-windows,todo fill response
v1.7.0-windows,todo check if odometry is too old!!
v1.7.0-windows,"if no odom, don't do anything."
v1.7.0-windows,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.7.0-windows,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.7.0-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.7.0-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.7.0-windows,todo yaw limits
v1.7.0-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.7.0-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.7.0-windows,mimics void ASimHUD::initializeSettings()
v1.7.0-windows,int num_threads = 1;
v1.7.0-windows,ros::MultiThreadedSpinner multi_thread(num_threads);
v1.7.0-windows,multi_thread.spin();
v1.7.0-windows,ros::AsyncSpinner async_spinner(num_threads);
v1.7.0-windows,async_spinner.start();
v1.7.0-windows,single threaded spinner
v1.7.0-windows,!/usr/bin/env python
v1.7.0-windows,capture joystick events using ROS and convert to AirSim Car API commands
v1.7.0-windows,to enable:
v1.7.0-windows,rosrun joy joy_node
v1.7.0-windows,"Below was an earlier typo, written like this for compatibility"
v1.7.0-windows,"gearing: -1 reverse, 0 N, >= 1 drive"
v1.7.0-windows,connect to the AirSim simulator
v1.7.0-windows,","
v1.7.0-windows,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.7.0-windows,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,"in header only mode, control library is not available"
v1.7.0-windows,TODO: something defines max macro which interfears with code here
v1.7.0-windows,is cur_pos within fence?
v1.7.0-windows,destination risk is not available then consider it zero
v1.7.0-windows,if dest risk is lower than its more safe
v1.7.0-windows,are we doing better than closest obstacle?
v1.7.0-windows,"if we stay where we are, what is the risk distance?"
v1.7.0-windows,else we are better of moving to dest
v1.7.0-windows,this function should work even when dest_pos == cur_pos
v1.7.0-windows,is this dest_pos cur_pos within the fence?
v1.7.0-windows,transform dest_pos vector to body frame
v1.7.0-windows,check for approx zero vectors to avoid random yaw angles
v1.7.0-windows,we are hovering
v1.7.0-windows,"get yaw in body frame, ie, front is always 0 radians"
v1.7.0-windows,yaw to ticks
v1.7.0-windows,get obstacles in the window at the tick direction around the window
v1.7.0-windows,less risk distance is better
v1.7.0-windows,check obstacles around current position and see if it has lower risk
v1.7.0-windows,else obstacle is too far
v1.7.0-windows,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.7.0-windows,look for each surrounding tick to see if we have obstacle free angle
v1.7.0-windows,else no suggestions required
v1.7.0-windows,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.7.0-windows,evaluate right and left side of circle
v1.7.0-windows,find right and left risk distances
v1.7.0-windows,at this point we have already determined hover is better than going to dest
v1.7.0-windows,we now determine is moving to suggested angle better than hovering?
v1.7.0-windows,check if dest_pos is safe
v1.7.0-windows,breaking distance at this velocity
v1.7.0-windows,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.7.0-windows,check if dest_pos is safe
v1.7.0-windows,float/vec parameters can have NaN which makes them optional
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,"in header only mode, control library is not available"
v1.7.0-windows,handles +/- tick and wraps around circle
v1.7.0-windows,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.7.0-windows,update the specified window on the map
v1.7.0-windows,make sure from <= to
v1.7.0-windows,normalize the ticks so both are valid indices
v1.7.0-windows,if from is still larger then
v1.7.0-windows,to ticks is then added one full circle to make it larger than from_tick
v1.7.0-windows,find closest obstacle in given window
v1.7.0-windows,search whole map to find closest obstacle
v1.7.0-windows,"in header only mode, control library is not available"
v1.7.0-windows,#include <fileapi.h>
v1.7.0-windows,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.7.0-windows,"Windows, OSX and Linux."
v1.7.0-windows,Windows users can move the Documents folder to any location they want
v1.7.0-windows,SHGetFolderPath knows how to find it.
v1.7.0-windows,fall back in case SHGetFolderPath failed for some reason.
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,"in header only mode, control library is not available"
v1.7.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.7.0-windows,if using Unreal Build system then include precompiled header file first
v1.7.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.7.0-windows,this deadlocks UI thread if async_run was called while there are pending rpc calls.
v1.7.0-windows,CinemAirSim
v1.7.0-windows,end CinemAirSim
v1.7.0-windows,Exit if already resetting.
v1.7.0-windows,Reset
v1.7.0-windows,if we don't suppress then server will bomb out for exceptions raised by any method
v1.7.0-windows,required for pimpl
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,"in header only mode, control library is not available"
v1.7.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.7.0-windows,if using Unreal Build system then include precompiled header file first
v1.7.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.7.0-windows,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.7.0-windows,make sure we can talk to the DroneServer
v1.7.0-windows,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.7.0-windows,command_context.client.ping();
v1.7.0-windows,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.7.0-windows,sim only
v1.7.0-windows,CinemAirSim
v1.7.0-windows,End CinemAirSim
v1.7.0-windows,"Minor TODO: consider msgpack magic for GeoPoint, so we can have one arg instead of three"
v1.7.0-windows,Convert
v1.7.0-windows,return value of last task. It should be true if task completed without
v1.7.0-windows,cancellation or timeout
v1.7.0-windows,"should be implemented by derived class if it supports async task,"
v1.7.0-windows,for example using futures
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,"in header only mode, control library is not available"
v1.7.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.7.0-windows,if using Unreal Build system then include precompiled header file first
v1.7.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,"in header only mode, control library is not available"
v1.7.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.7.0-windows,if using Unreal Build system then include precompiled header file first
v1.7.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.7.0-windows,required for pimpl
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,"in header only mode, control library is not available"
v1.7.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.7.0-windows,if using Unreal Build system then include precompiled header file first
v1.7.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.7.0-windows,status getters
v1.7.0-windows,Rotor state getter
v1.7.0-windows,Multirotor state getter
v1.7.0-windows,return value of last task. It should be true if task completed without
v1.7.0-windows,cancellation or timeout
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,"in header only mode, control library is not available"
v1.7.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.7.0-windows,if using Unreal Build system then include pre-compiled header file first
v1.7.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.7.0-windows,getters
v1.7.0-windows,Rotor state
v1.7.0-windows,Multirotor state
v1.7.0-windows,required for pimpl
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,"in header only mode, control library is not available"
v1.7.0-windows,last command is to hold on to position
v1.7.0-windows,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.7.0-windows,after landing we detect if drone has stopped moving
v1.7.0-windows,validate path size
v1.7.0-windows,validate yaw mode
v1.7.0-windows,validate and set auto-lookahead value
v1.7.0-windows,if auto mode requested for lookahead then calculate based on velocity
v1.7.0-windows,add current position as starting point
v1.7.0-windows,append the input path and compute segments
v1.7.0-windows,add last segment as zero length segment so we have equal number of segments and points.
v1.7.0-windows,path_segs[i] refers to segment that starts at point i
v1.7.0-windows,"when path ends, we want to slow down"
v1.7.0-windows,else no need to change velocities for last segments
v1.7.0-windows,setup current position on path to 0 offset
v1.7.0-windows,initialize next path position
v1.7.0-windows,until we are at the end of the path (last seg is always zero size)
v1.7.0-windows,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.7.0-windows,send drone command to get to next lookahead
v1.7.0-windows,sleep for rest of the cycle
v1.7.0-windows,how much have we moved towards last goal?
v1.7.0-windows,project actual vector on goal vector
v1.7.0-windows,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.7.0-windows,TODO: below should be lower than 1E3 and configurable
v1.7.0-windows,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.7.0-windows,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.7.0-windows,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.7.0-windows,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.7.0-windows,"if drone moved backward, we don't want goal to move backward as well"
v1.7.0-windows,"so only climb forward on the path, never back. Also note >= which means"
v1.7.0-windows,we climb path even if distance was 0 to take care of duplicated points on path
v1.7.0-windows,else
v1.7.0-windows,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.7.0-windows,compute next target on path
v1.7.0-windows,freeze the quaternion
v1.7.0-windows,convert RC commands to velocity vector
v1.7.0-windows,find yaw as per terrain and remote setting
v1.7.0-windows,execute command
v1.7.0-windows,if timeout occurred then command completed successfully otherwise it was interrupted
v1.7.0-windows,yaw is not within margin
v1.7.0-windows,by default we say that this command is not supported
v1.7.0-windows,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.7.0-windows,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.7.0-windows,get trims
v1.7.0-windows,take average
v1.7.0-windows,validate dest
v1.7.0-windows,what is the distance we will travel at this velocity?
v1.7.0-windows,get velocity vector
v1.7.0-windows,yaw for the direction of travel
v1.7.0-windows,find velocity vector
v1.7.0-windows,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.7.0-windows,generate velocity vector that is same size as cur_dest_norm / command period
v1.7.0-windows,this velocity vect when executed for command period would yield cur_dest_norm
v1.7.0-windows,send commands
v1.7.0-windows,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.7.0-windows,default strategy is for move. In hover mode we set new strategy temporarily
v1.7.0-windows,are we supposed to do EM?
v1.7.0-windows,get suggested velocity vector
v1.7.0-windows,use the unchecked command
v1.7.0-windows,tell caller not to execute planned command
v1.7.0-windows,other wise throw exception
v1.7.0-windows,otherwise there is some other reason why we are in unsafe situation
v1.7.0-windows,send last command to come to full stop
v1.7.0-windows,else no unsafe situation
v1.7.0-windows,note: cur_path_loc and next_path_loc may both point to same object
v1.7.0-windows,"otherwise use up this segment, move on to next one"
v1.7.0-windows,if we are here then we ran out of segments
v1.7.0-windows,consider last segment as zero length segment
v1.7.0-windows,adjust yaw for the direction of travel in forward-only mode
v1.7.0-windows,else no adjustment needed
v1.7.0-windows,if auto mode requested for lookahead then calculate based on velocity
v1.7.0-windows,Create a spring arm component for our chase camera
v1.7.0-windows,"do nothing, spring arm is pulling the camera with it"
v1.7.0-windows,"do nothing, we have camera turned off"
v1.7.0-windows,set initial view mode
v1.7.0-windows,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.7.0-windows,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.7.0-windows,"If the lag is missing, the camera will also occasionally shake."
v1.7.0-windows,"But, lag is not desired when piloting a drone"
v1.7.0-windows,attach spring arm to actor
v1.7.0-windows,remember current parent for external camera. Later when we remove external
v1.7.0-windows,"camera from spring arm, we will attach it back to its last parent"
v1.7.0-windows,now attach camera to spring arm
v1.7.0-windows,"For car, we need to move the camera back a little more than for a drone."
v1.7.0-windows,"Otherwise, the camera will be stuck inside the car"
v1.7.0-windows,ExternalCamera->bUsePawnControlRotation = false;
v1.7.0-windows,detach spring arm
v1.7.0-windows,Re-enable rendering
v1.7.0-windows,Remove any existing key bindings for manual mode
v1.7.0-windows,"else someone else is bound to manual pose controller, leave it alone"
v1.7.0-windows,if new mode is manual mode then add key bindings
v1.7.0-windows,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.7.0-windows,other modes don't need special setup
v1.7.0-windows,make switch official
v1.7.0-windows,Add loading screen to viewport
v1.7.0-windows,Remove Loading screen from viewport
v1.7.0-windows,Create struct for Location and Rotation of actor in Unreal
v1.7.0-windows,Ensure new non-matching name for the object
v1.7.0-windows,Write the binvox file using run-length encoding
v1.7.0-windows,"where each pair of bytes is of the format (run value, run length)"
v1.7.0-windows,This is a run (repeated bit value)
v1.7.0-windows,End of a run
v1.7.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.7.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.7.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.7.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.7.0-windows,Split the tag string into individual tags.
v1.7.0-windows,Texture swap on actors that have all of those tags.
v1.7.0-windows,----------- Plotting APIs ----------/
v1.7.0-windows,"plot line for points 0-1, 1-2, 2-3"
v1.7.0-windows,"plot line for points 0-1, 2-3, 4-5... must be even number of points"
v1.7.0-windows,assert points_start.size() == poinst_end.size()
v1.7.0-windows,assert positions.size() == strings.size()
v1.7.0-windows,assert poses.size() == names.size()
v1.7.0-windows,Recording APIs
v1.7.0-windows,"Remove '' from the list, representing default vehicle"
v1.7.0-windows,"We need to run this code on the main game thread, since it iterates over actors"
v1.7.0-windows,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.7.0-windows,"No LOS, so draw red line"
v1.7.0-windows,"Yes LOS, so draw green line"
v1.7.0-windows,"We need to run this code on the main game thread, since it iterates over actors"
v1.7.0-windows,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.7.0-windows,Testing actor enum for world bounds...
v1.7.0-windows,"Same as with the Object Iterator, access the subclass instance with the * or -> operators."
v1.7.0-windows,"TODO think more about how best to determine/indicate ground level, if anyone cares"
v1.7.0-windows,Convert Uvectors to LLAs
v1.7.0-windows,CinemAirSim
v1.7.0-windows,End CinemAirSim
v1.7.0-windows,Fill out your copyright notice in the Description page of Project Settings.
v1.7.0-windows,"Set this component to be initialized when the game starts, and to be ticked every frame.  You can turn these features"
v1.7.0-windows,off to improve performance if you don't need them.
v1.7.0-windows,get render target for texture size
v1.7.0-windows,initialize viewinfo for projection matrix
v1.7.0-windows,calculate 3D corner Points of bounding box
v1.7.0-windows,initialize pixel values
v1.7.0-windows,initialize projection data for sceneview
v1.7.0-windows,do some voodoo rotation that is somehow mandatory and stolen from UGameplayStatics::ProjectWorldToScreen
v1.7.0-windows,Project Points to pixels and get the corner pixels
v1.7.0-windows,If actor in camera view - check if it's actually visible or hidden
v1.7.0-windows,Check against 8 extend points
v1.7.0-windows,"If actor in camera view but didn't hit any point out of 8 extend points,"
v1.7.0-windows,check against 10 random points
v1.7.0-windows,CinemAirSim
v1.7.0-windows,CinemAirSim
v1.7.0-windows,set initial focal length
v1.7.0-windows,by default all image types are disabled
v1.7.0-windows,use final color for all calculations
v1.7.0-windows,We set all cameras to start as nodisplay
v1.7.0-windows,This improves performance because the capture components are no longer updating every frame and only update while requesting an image
v1.7.0-windows,TODO: avoid the need to override const cast here
v1.7.0-windows,if the viewport is taller than it is wide
v1.7.0-windows,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v1.7.0-windows,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v1.7.0-windows,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v1.7.0-windows,use final color for all calculations
v1.7.0-windows,TODO: should we be ignoring position and orientation settings here?
v1.7.0-windows,TODO: can we eliminate storing NedTransform?
v1.7.0-windows,CinemAirSim
v1.7.0-windows,if (!std::isnan(setting.target_gamma))
v1.7.0-windows,camera-> = setting.target_gamma;
v1.7.0-windows,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.7.0-windows,else nothing to enable
v1.7.0-windows,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.7.0-windows,if (controller && controller->GetViewTarget() == this)
v1.7.0-windows,controller->SetViewTarget(nullptr);
v1.7.0-windows,CinemAirSim methods
v1.7.0-windows,Copy all of the post processing settings
v1.7.0-windows,But restore the original blendables
v1.7.0-windows,end CinemAirSim methods
v1.7.0-windows,"Check whether requested map exists, this could be very slow if LevelName is a short package name"
v1.7.0-windows,Create Unique Name for sub-level package
v1.7.0-windows,Setup streaming level object that will load specified map
v1.7.0-windows,Transform
v1.7.0-windows,Map to Load
v1.7.0-windows,Add the new level to world.
v1.7.0-windows,TODO: explore screenshot option
v1.7.0-windows,addScreenCaptureHandler(camera->GetWorld());
v1.7.0-windows,TODO: may be we should have these methods non-const?
v1.7.0-windows,We don't do game/render thread synchronization for safe method.
v1.7.0-windows,We just blindly sleep for 200ms (the old way)
v1.7.0-windows,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.7.0-windows,Make sure that all alpha values are opaque.
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,TODO: change naming conventions to same as other files?
v1.7.0-windows,"context->GetWorld()->SetNewWorldOrigin(FIntVector(0, 0, 0));"
v1.7.0-windows,Enable/disable primary viewport rendering flag
v1.7.0-windows,This disables rendering of the main viewport in the same way as the
v1.7.0-windows,"console command ""show rendering"" would do."
v1.7.0-windows,"When getting an image through the API, the image is produced after the render"
v1.7.0-windows,thread has finished rendering the current and the subsequent frame. This means
v1.7.0-windows,that the frame rate for obtaining images through the API is only half as high as
v1.7.0-windows,"it could be, since only every other image is actually captured. We work around"
v1.7.0-windows,this by telling the viewport to flush the rendering queue at the end of each
v1.7.0-windows,drawn frame so that it executes our render request at that point already.
v1.7.0-windows,Do this only if the main viewport is not being rendered anyway in case there are
v1.7.0-windows,any adverse performance effects during main rendering.
v1.7.0-windows,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v1.7.0-windows,nothing to do for now
v1.7.0-windows,"if hidden, clear any existing messages"
v1.7.0-windows,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.7.0-windows,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.7.0-windows,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.7.0-windows,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.7.0-windows,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.7.0-windows,Find mesh in /Game and /AirSim asset registry. When more plugins are added this function will have to change
v1.7.0-windows,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.7.0-windows,{
v1.7.0-windows,InitializeObjectStencilID(*comp);
v1.7.0-windows,}
v1.7.0-windows,"Takes a UStaticMeshComponent, USkinnedMeshComponent or ALandscapeProxy and returns their custom stencil ID if"
v1.7.0-windows,their meshes's name or their owner's name (depending on the naming method in mesh_naming_method_) equals mesh_name
v1.7.0-windows,"The skybox is ignored here as it is huge, and really is of no use to the end user typically. Also the associated meshes with the cameras"
v1.7.0-windows,Various checks if there is even a valid mesh
v1.7.0-windows,Need to force the render command to go through cause on the next iteration the buffer no longer exists
v1.7.0-windows,Unreal stores more vertices than triangles. So here we find the highest referenced vertex and ignore any after that
v1.7.0-windows,can we see followee?
v1.7.0-windows,remove mapping
v1.7.0-windows,removing binding
v1.7.0-windows,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.7.0-windows,"some point. At the moment, manually swapping Red and Blue"
v1.7.0-windows,Copy scaled image into destination thumb
v1.7.0-windows,Compress data - convert into a .png
v1.7.0-windows,if we already have attached actor
v1.7.0-windows,Fill out your copyright notice in the Description page of Project Settings.
v1.7.0-windows,Check pointer equality first for performance
v1.7.0-windows,"KeyHash = HashCombine(KeyHash, GetTypeHash(Key.WildcardMeshNames));"
v1.7.0-windows,#ifdef _MSC_VER
v1.7.0-windows,//print to VS output window
v1.7.0-windows,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.7.0-windows,#endif
v1.7.0-windows,also do default logging
v1.7.0-windows,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.7.0-windows,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.7.0-windows,{
v1.7.0-windows,if (GEngine != nullptr)
v1.7.0-windows,{
v1.7.0-windows,return GEngine->GameUserSettings;
v1.7.0-windows,}
v1.7.0-windows,return nullptr;
v1.7.0-windows,}
v1.7.0-windows,UGameUserSettings* game_settings = GetGameUserSettings();
v1.7.0-windows,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.7.0-windows,game_settings->ApplySettings(true);
v1.7.0-windows,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.7.0-windows,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.7.0-windows,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.7.0-windows,todo unused. need to manually plots tf axes' line in right handed FLU instead of using DrawDebugCoordinateSystem
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,plugin startup
v1.7.0-windows,plugin shutdown
v1.7.0-windows,initialize state
v1.7.0-windows,add listener for pawn's collision event
v1.7.0-windows,compute our home point
v1.7.0-windows,default behavior is to call update every tick
v1.7.0-windows,"for custom physics engine, this method should be overridden and update should be"
v1.7.0-windows,called from every physics tick
v1.7.0-windows,add cameras that already exists in pawn
v1.7.0-windows,create or replace cameras specified in settings
v1.7.0-windows,setup individual cameras
v1.7.0-windows,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.7.0-windows,for each camera in settings
v1.7.0-windows,get pose
v1.7.0-windows,spawn and attach camera to pawn
v1.7.0-windows,add on to our collection
v1.7.0-windows,Deflect along the surface when we collide.
v1.7.0-windows,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.7.0-windows,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.7.0-windows,-1 to 1 --> 0 to 1
v1.7.0-windows,-1 to 1
v1.7.0-windows,these will be available for devices like steering wheels
v1.7.0-windows,switch index 0 to 7 for FrSky Taranis RC is:
v1.7.0-windows,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.7.0-windows,TODO: should below be at controller level info?
v1.7.0-windows,else don't waste time
v1.7.0-windows,"We need to run this code on the main game thread, since it iterates over actors"
v1.7.0-windows,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.7.0-windows,Transform from LLA to NED
v1.7.0-windows,KM911 remove logging
v1.7.0-windows,"common_utils::Utils::log(""NED from LLA: "" + std::to_string(target_location.X) + "", "" + std::to_string(target_location.Y) + "", "" + std::to_string(target_location.Z), common_utils::Utils::kLogLevelInfo);"
v1.7.0-windows,"No LOS, so draw red line"
v1.7.0-windows,"Yes LOS, so draw green line"
v1.7.0-windows,sync environment from kinematics
v1.7.0-windows,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.7.0-windows,void playBack()
v1.7.0-windows,{
v1.7.0-windows,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.7.0-windows,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.7.0-windows,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.7.0-windows,}
v1.7.0-windows,TODO: refactor below code used for playback
v1.7.0-windows,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.7.0-windows,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.7.0-windows,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.7.0-windows,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.7.0-windows,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.7.0-windows,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.7.0-windows,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.7.0-windows,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.7.0-windows,}
v1.7.0-windows,parameters in NED frame
v1.7.0-windows,translate to new PawnSimApi position & orientation from NED to NEU
v1.7.0-windows,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.7.0-windows,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.7.0-windows,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.7.0-windows,checked at the start of next tick
v1.7.0-windows,allow teleportation
v1.7.0-windows,if collisions are not enabled
v1.7.0-windows,or we have collided but passthrough is enabled
v1.7.0-windows,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.7.0-windows,"without flip flopping, collisions can't be detected"
v1.7.0-windows,update kinematics from pawn's movement instead of physics engine
v1.7.0-windows,by default we update kinematics from UE pawn
v1.7.0-windows,if SimMod uses its own physics engine then this should be overriden
v1.7.0-windows,no default action in this base class
v1.7.0-windows,"read pixels from render target using render thread, then compress the result into PNG"
v1.7.0-windows,argument on the thread that calls this method.
v1.7.0-windows,TODO: is below really needed?
v1.7.0-windows,make sure we are not on the rendering thread
v1.7.0-windows,TODO: below doesn't work right now because it must be running in game thread
v1.7.0-windows,below is documented method but more expensive because it forces flush
v1.7.0-windows,wait for render thread to pick up our task
v1.7.0-windows,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.7.0-windows,capture CameraPose for this frame
v1.7.0-windows,The completion is called immeidately after GameThread sends the
v1.7.0-windows,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.7.0-windows,execute *immediately* after RenderThread renders the scene!
v1.7.0-windows,"while we're still on GameThread, enqueue request for capture the scene!"
v1.7.0-windows,wait for this task to complete
v1.7.0-windows,log a message and continue wait
v1.7.0-windows,lamda function still references a few objects for which there is no refcount.
v1.7.0-windows,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.7.0-windows,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.7.0-windows,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.7.0-windows,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.7.0-windows,Fill out your copyright notice in the Description page of Project Settings.
v1.7.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.7.0-windows,UWorld* World = GetWorld();
v1.7.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.7.0-windows,still need the menu class for f10
v1.7.0-windows,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v1.7.0-windows,showWeatherMenu(WorldContextObject);
v1.7.0-windows,"if weather is not enabled, dont allow any weather values to be set"
v1.7.0-windows,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v1.7.0-windows,and must be set to true or false before this.
v1.7.0-windows,WeatherEnabled will always be false
v1.7.0-windows,"NOTE: weather enabled must be set first, before other params for this to work"
v1.7.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.7.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.7.0-windows,"get all menu actors, if any"
v1.7.0-windows,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.7.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.7.0-windows,"get all menu actors, if any"
v1.7.0-windows,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.7.0-windows,"get all menu actors, if any, then hide the menu"
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,Stuff to filter out XInput devices
v1.7.0-windows,-----------------------------------------------------------------------------
v1.7.0-windows,"Defines, constants, and global variables"
v1.7.0-windows,-----------------------------------------------------------------------------
v1.7.0-windows,Magnitude ranges from -1 to 1
v1.7.0-windows,Strength ranges from 0 to 1
v1.7.0-windows,Autocenter
v1.7.0-windows,Rumble
v1.7.0-windows,Register with the DirectInput subsystem and get a pointer
v1.7.0-windows,to a IDirectInput interface we can use.
v1.7.0-windows,Create a DInput object
v1.7.0-windows,Look for a simple joystick we can use for this sample program.
v1.7.0-windows,Make sure we got a joystick
v1.7.0-windows,"Set the data format to ""simple joystick"" - a predefined data format"
v1.7.0-windows,
v1.7.0-windows,"A data format specifies which controls on a device we are interested in,"
v1.7.0-windows,and how they should be reported. This tells DInput that we will be
v1.7.0-windows,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.7.0-windows,Set the cooperative level to let DInput know how this device should
v1.7.0-windows,interact with the system and with other DInput applications.
v1.7.0-windows,Enumerate the joystick objects. The callback function enabled user
v1.7.0-windows,"interface elements for objects that are found, and sets the min/max"
v1.7.0-windows,values property for discovered axes.
v1.7.0-windows,-----------------------------------------------------------------------------
v1.7.0-windows,Enum each PNP device using WMI and check each device ID to see if it contains
v1.7.0-windows,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.7.0-windows,Unfortunately this information can not be found by just using DirectInput.
v1.7.0-windows,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.7.0-windows,XInput devices.
v1.7.0-windows,
v1.7.0-windows,This function stores the list of xinput devices in a linked list
v1.7.0-windows,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.7.0-windows,-----------------------------------------------------------------------------
v1.7.0-windows,CoInit if needed
v1.7.0-windows,Create WMI
v1.7.0-windows,Create BSTRs for WMI
v1.7.0-windows,Connect to WMI
v1.7.0-windows,Switch security level to IMPERSONATE
v1.7.0-windows,Get list of Win32_PNPEntity devices
v1.7.0-windows,Loop over all devices
v1.7.0-windows,Get 20 at a time
v1.7.0-windows,"For each device, get its device ID"
v1.7.0-windows,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.7.0-windows,Unfortunately this information can not be found by just using DirectInput
v1.7.0-windows,"If it does, then get the VID/PID from var.bstrVal"
v1.7.0-windows,Add the VID/PID to a linked list
v1.7.0-windows,-----------------------------------------------------------------------------
v1.7.0-windows,Returns true if the DirectInput device is also an XInput device.
v1.7.0-windows,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.7.0-windows,-----------------------------------------------------------------------------
v1.7.0-windows,Check each xinput device to see if this device's vid/pid matches
v1.7.0-windows,-----------------------------------------------------------------------------
v1.7.0-windows,Cleanup needed for IsXInputDevice()
v1.7.0-windows,-----------------------------------------------------------------------------
v1.7.0-windows,Cleanup linked list
v1.7.0-windows,-----------------------------------------------------------------------------
v1.7.0-windows,Name: EnumJoysticksCallback()
v1.7.0-windows,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.7.0-windows,device interface on it so we can play with it.
v1.7.0-windows,-----------------------------------------------------------------------------
v1.7.0-windows,Skip anything other than the perferred joystick device as defined by the control panel.
v1.7.0-windows,Instead you could store all the enumerated joysticks and let the user pick.
v1.7.0-windows,Obtain an interface to the enumerated joystick.
v1.7.0-windows,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.7.0-windows,it while we were in the middle of enumerating it.)
v1.7.0-windows,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.7.0-windows,could store all the enumerated joysticks and let the user pick.
v1.7.0-windows,-----------------------------------------------------------------------------
v1.7.0-windows,Name: EnumObjectsCallback()
v1.7.0-windows,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.7.0-windows,joystick. This function enables user interface elements for objects
v1.7.0-windows,"that are found to exist, and scales axes min/max values."
v1.7.0-windows,-----------------------------------------------------------------------------
v1.7.0-windows,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.7.0-windows,enumerated axis in order to scale min/max values.
v1.7.0-windows,Set the range for the axis
v1.7.0-windows,Set the UI to reflect what objects the joystick supports
v1.7.0-windows,-----------------------------------------------------------------------------
v1.7.0-windows,Name: UpdateInputState()
v1.7.0-windows,Desc: Get the input device's state and display it.
v1.7.0-windows,-----------------------------------------------------------------------------
v1.7.0-windows,Poll the device to read the current state
v1.7.0-windows,DInput is telling us that the input stream has been
v1.7.0-windows,"interrupted. We aren't tracking any state between polls, so"
v1.7.0-windows,we don't have any special reset that needs to be done. We
v1.7.0-windows,just re-acquire and try again.
v1.7.0-windows,while (hr == DIERR_INPUTLOST)
v1.7.0-windows,hr = g_pJoystick->Acquire();
v1.7.0-windows,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.7.0-windows,may occur when the app is minimized or in the process of
v1.7.0-windows,"switching, so just try again later"
v1.7.0-windows,Get the input's device state
v1.7.0-windows,Axes
v1.7.0-windows,Slider controls
v1.7.0-windows,Points of view
v1.7.0-windows,Buttons
v1.7.0-windows,-----------------------------------------------------------------------------
v1.7.0-windows,Name: FreeDirectInput()
v1.7.0-windows,Desc: Initialize the DirectInput variables.
v1.7.0-windows,-----------------------------------------------------------------------------
v1.7.0-windows,Unacquire the device one last time just in case
v1.7.0-windows,the app tried to exit while the device is still acquired.
v1.7.0-windows,Release any DirectInput objects.
v1.7.0-windows,nop
v1.7.0-windows,normalize min to max --> 0 to 1
v1.7.0-windows,normalize 0 to 1 --> -1 to 1
v1.7.0-windows,#include <libudev.h>
v1.7.0-windows,implementation for unsupported OS
v1.7.0-windows,if this is new index
v1.7.0-windows,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.7.0-windows,close previous one
v1.7.0-windows,open new device
v1.7.0-windows,if open was successful
v1.7.0-windows,read the device
v1.7.0-windows,if we didn't had valid read
v1.7.0-windows,"NOTE if this condition is not met, we're probably out of sync and this"
v1.7.0-windows,Joystick instance is likely unusable
v1.7.0-windows,TODO: set below to false?
v1.7.0-windows,state.is_valid = false;
v1.7.0-windows,else ignore
v1.7.0-windows,TODO: implement this for linux
v1.7.0-windows,TODO: implement this for linux
v1.7.0-windows,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.7.0-windows,{
v1.7.0-windows,"manufacturerID = productID = """";"
v1.7.0-windows,// Use udev to look up the product and manufacturer IDs
v1.7.0-windows,struct udev *udev = udev_new();
v1.7.0-windows,if (udev) {
v1.7.0-windows,char sysname[32];
v1.7.0-windows,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.7.0-windows,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.7.0-windows,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.7.0-windows,if (!dev)
v1.7.0-windows,{
v1.7.0-windows,"message = ""Unable to find parent USB device"";"
v1.7.0-windows,return false;
v1.7.0-windows,}
v1.7.0-windows,std::stringstream ss;
v1.7.0-windows,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.7.0-windows,ss >> manufacturerID;
v1.7.0-windows,ss.clear();
v1.7.0-windows,"ss.str("""");"
v1.7.0-windows,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.7.0-windows,ss >> productID;
v1.7.0-windows,udev_device_unref(dev);
v1.7.0-windows,}
v1.7.0-windows,else
v1.7.0-windows,{
v1.7.0-windows,"message = ""Cannot create udev"";"
v1.7.0-windows,return false;
v1.7.0-windows,}
v1.7.0-windows,udev_unref(udev);
v1.7.0-windows,return true;
v1.7.0-windows,}
v1.7.0-windows,required for pimpl
v1.7.0-windows,TODO: anyway to workaround const_cast?
v1.7.0-windows,FGenericPlatformMisc::PlatformInit();
v1.7.0-windows,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.7.0-windows,TODO: index check
v1.7.0-windows,"sub-window captures dont count as a request, set bCaptureEveryFrame and bCaptureOnMovement to display so we can show correctly the subwindow"
v1.7.0-windows,create main widget
v1.7.0-windows,synchronize PIP views
v1.7.0-windows,TODO: should we only do below on SceneCapture2D components and cameras?
v1.7.0-windows,avoid motion blur so capture images don't get
v1.7.0-windows,use two different methods to set console var because sometime it doesn't seem to work
v1.7.0-windows,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.7.0-windows,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.7.0-windows,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.7.0-windows,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.7.0-windows,setup defaults
v1.7.0-windows,Attempts to parse the settings text from one of multiple locations.
v1.7.0-windows,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.7.0-windows,"Next, check the executable's working directory for the settings file."
v1.7.0-windows,"Finally, check the user's documents folder."
v1.7.0-windows,"If the settings file cannot be read, throw an exception"
v1.7.0-windows,Attempts to parse the settings file path or the settings text from the command line
v1.7.0-windows,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.7.0-windows,"Example (Path): AirSim.exe --settings ""C:\path\to\settings.json"""
v1.7.0-windows,"Example (Text): AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.7.0-windows,"Returns true if the argument is present, false otherwise."
v1.7.0-windows,build image file name
v1.7.0-windows,write image file
v1.7.0-windows,"Write PNG image, already compressed in binary"
v1.7.0-windows,write to CSV file
v1.7.0-windows,"Either images were saved successfully, or there were no images"
v1.7.0-windows,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.7.0-windows,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.7.0-windows,"Just need any 1 instance, to set the header line of the record file"
v1.7.0-windows,"Set is_ready at the end, setting this before can cause a race when the file isn't open yet"
v1.7.0-windows,make sure all vars are set up
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,decide which derived BP to use
v1.7.0-windows,we don't have real vehicle so no vehicle API
v1.7.0-windows,put camera little bit above vehicle
v1.7.0-windows,update ground level
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,let base class setup physics world
v1.7.0-windows,stop physics thread before we dismantle
v1.7.0-windows,setup clock in ClockFactory
v1.7.0-windows,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.7.0-windows,steppable clock returns interval that is a constant number irrespective of wall clock
v1.7.0-windows,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.7.0-windows,but that would cause vehicles like quadrotors to become unstable
v1.7.0-windows,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.7.0-windows,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.7.0-windows,get increase in clock speed
v1.7.0-windows,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.7.0-windows,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.7.0-windows,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.7.0-windows,Approach 2: scale control loop frequency if clock is speeded up
v1.7.0-windows,"for slowing down, this don't generate instability"
v1.7.0-windows,-------------------------------- overrides -----------------------------------------------//
v1.7.0-windows,decide which derived BP to use
v1.7.0-windows,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.7.0-windows,vehicle_sim_api->reset();
v1.7.0-windows,create vehicle API
v1.7.0-windows,setup physics vehicle
v1.7.0-windows,initialize private vars
v1.7.0-windows,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.7.0-windows,calls to update* are handled by physics engine and in SimModeWorldBase
v1.7.0-windows,"Utils::log(""------Render tick-------"");"
v1.7.0-windows,"if reset is pending then do it first, no need to do other things until next tick"
v1.7.0-windows,move collision info from rendering engine to vehicle
v1.7.0-windows,update rotor poses
v1.7.0-windows,update private rotor variable
v1.7.0-windows,if we did reset then don't worry about synchronizing states for this tick
v1.7.0-windows,Continue to wait for reset
v1.7.0-windows,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.7.0-windows,*** Start: UpdatableState implementation ***//
v1.7.0-windows,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.7.0-windows,environment update for current position
v1.7.0-windows,update forces on vertices
v1.7.0-windows,update to controller must be done after kinematics have been updated by physics engine
v1.7.0-windows,*** End: UpdatableState implementation ***//
v1.7.0-windows,get references of existing camera
v1.7.0-windows,setup clock in PhysX
v1.7.0-windows,-------------------------------- overrides -----------------------------------------------//
v1.7.0-windows,decide which derived BP to use
v1.7.0-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.7.0-windows,Setup suspension forces
v1.7.0-windows,Find the tire object and set the data for it
v1.7.0-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.7.0-windows,Setup suspension forces
v1.7.0-windows,Find the tire object and set the data for it
v1.7.0-windows,Create In-Car camera component
v1.7.0-windows,In car HUD
v1.7.0-windows,Create text render component for in car speed display
v1.7.0-windows,Create text render component for in car gear display
v1.7.0-windows,Setup the audio component and allocate it a sound cue
v1.7.0-windows,Colors for the in-car gear display. One for normal one for reverse
v1.7.0-windows,Wheels/Tires
v1.7.0-windows,Setup the wheels
v1.7.0-windows,Adjust the tire loading
v1.7.0-windows,Engine
v1.7.0-windows,Torque setup
v1.7.0-windows,Adjust the steering
v1.7.0-windows,Transmission
v1.7.0-windows,We want 4wd
v1.7.0-windows,Drive the front wheels a little more than the rear
v1.7.0-windows,Automatic gearbox
v1.7.0-windows,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.7.0-windows,Physics settings
v1.7.0-windows,Adjust the center of mass - the buggy is quite low
v1.7.0-windows,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.7.0-windows,put camera little bit above vehicle
v1.7.0-windows,update physics material
v1.7.0-windows,Update the strings used in the HUD (in-car and on-screen)
v1.7.0-windows,Set the string in the in-car HUD
v1.7.0-windows,Pass the engine RPM to the sound component
v1.7.0-windows,Start an engine sound playing
v1.7.0-windows,Using FText because this is display text that should be localizable
v1.7.0-windows,Setup the text render component strings
v1.7.0-windows,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.7.0-windows,below is not needed
v1.7.0-windows,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.7.0-windows,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.7.0-windows,create vehicle params
v1.7.0-windows,TODO: should do reset() here?
v1.7.0-windows,these are called on render ticks
v1.7.0-windows,TODO: do we need this for cars?
v1.7.0-windows,TODO: move this to SimModeBase?
v1.7.0-windows,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.7.0-windows,reset();
v1.7.0-windows,return;
v1.7.0-windows,}
v1.7.0-windows,Thrustmaster devices
v1.7.0-windows,"Anything else, typically Logitech G920 wheel"
v1.7.0-windows,Two steel levers behind wheel
v1.7.0-windows,if API-client control is not active then we route keyboard/joystick control to car
v1.7.0-windows,all car controls from anywhere must be routed through API component
v1.7.0-windows,*** Start: UpdatableState implementation ***//
v1.7.0-windows,physics tick
v1.7.0-windows,*** End: UpdatableState implementation ***//
v1.7.0-windows,TODO: directly accept getVehicleSimApis() using generic container
v1.7.0-windows,Reset the vehicle as well before registering it
v1.7.0-windows,Similar to what happens in initializeForPlay() above
v1.7.0-windows,remove everything that we created in BeginPlay
v1.7.0-windows,wait if no new frame is renderd
v1.7.0-windows,we use custom debug reporting for this class
v1.7.0-windows,perform any expensive rendering update outside of lock region
v1.7.0-windows,no need to call base reset because of our custom implementation
v1.7.0-windows,TODO: this is going to cause circular references which is fine here but
v1.7.0-windows,in future we should consider moving SimMode not derived from AActor and move
v1.7.0-windows,it to AirLib and directly implement WorldSimApiBase interface
v1.7.0-windows,get player start
v1.7.0-windows,this must be done from within actor otherwise we don't get player start
v1.7.0-windows,Grab player location
v1.7.0-windows,Move the world origin to the player's location (this moves the coordinate system and adds
v1.7.0-windows,a corresponding offset to all positions to compensate for the shift)
v1.7.0-windows,"Regrab the player's position after the offset has been added (which should be 0,0,0 now)"
v1.7.0-windows,UWeatherLib::showWeatherMenu(World);
v1.7.0-windows,else don't init
v1.7.0-windows,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v1.7.0-windows,tod_sim_clock_start_ needs to be reset here.
v1.7.0-windows,Going from enabled to disabled
v1.7.0-windows,do these in the end to ensure that advanceTimeOfDay() doesn't see
v1.7.0-windows,any inconsistent state.
v1.7.0-windows,should be overridden by derived class
v1.7.0-windows,should be overriden by derived class
v1.7.0-windows,should be overridden by derived class
v1.7.0-windows,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.7.0-windows,default setup - this should be overridden in derived modes as needed
v1.7.0-windows,setup clock in ClockFactory
v1.7.0-windows,default implementation
v1.7.0-windows,create director
v1.7.0-windows,create external camera required for the director
v1.7.0-windows,for each camera in settings
v1.7.0-windows,get pose
v1.7.0-windows,spawn and attach camera to pawn
v1.7.0-windows,add on to our collection
v1.7.0-windows,API server start/stop
v1.7.0-windows,get UU origin of global NED frame
v1.7.0-windows,compute initial pose
v1.7.0-windows,spawn vehicle pawn
v1.7.0-windows,create vehicle sim api
v1.7.0-windows,Convert to lowercase as done during settings loading
v1.7.0-windows,TODO: Figure out a better way to add more fields
v1.7.0-windows,Maybe allow passing a JSON string for the vehicle settings?
v1.7.0-windows,"Retroactively adjust AirSimSettings, so it's like we knew about this vehicle all along"
v1.7.0-windows,"Usually physics registration happens at init, in ASimModeWorldBase::initializeForPlay(), but not in this case"
v1.7.0-windows,get UU origin of global NED frame
v1.7.0-windows,determine camera director camera default pose and spawn it
v1.7.0-windows,find all vehicle pawns
v1.7.0-windows,add vehicles from settings
v1.7.0-windows,if vehicle is of type for derived SimMode and auto creatable
v1.7.0-windows,create API objects for each pawn we have
v1.7.0-windows,Create External Cameras
v1.7.0-windows,TODO: better handle no FPV vehicles scenario
v1.7.0-windows,derived class shoudl override this method to add new vehicle to the physics engine
v1.7.0-windows,derived class should override this method to retrieve types of pawns they support
v1.7.0-windows,derived class should override this method to retrieve types of pawns they support
v1.7.0-windows,derived class should override this method to retrieve types of pawns they support
v1.7.0-windows,derived class should override this method to retrieve types of pawns they support
v1.7.0-windows,derived class should override this method to retrieve types of pawns they support
v1.7.0-windows,derived class should override this method to retrieve types of pawns they support
v1.7.0-windows,derived class should override this method to retrieve types of pawns they support
v1.7.0-windows,Draws debug-points on main viewport for Lidar laser hits.
v1.7.0-windows,Used for debugging only.
v1.7.0-windows,Currently we are checking the sensor-collection instead of sensor-settings.
v1.7.0-windows,Also using variables to optimize not checking the collection if not needed.
v1.7.0-windows,TODO: Is it incorrect to assume LidarSimple here?
v1.7.0-windows,Draw debug-point on main viewport for Distance sensor hit
v1.7.0-windows,Find position of point hit
v1.7.0-windows,Similar to UnrealDistanceSensor.cpp#L19
v1.7.0-windows,order of Pose addition is important here because it also adds quaternions which is not commutative!
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,ctor
v1.7.0-windows,initializes information based on lidar configuration
v1.7.0-windows,calculate verticle angle distance between each laser
v1.7.0-windows,store vertical angles for each laser
v1.7.0-windows,returns a point-cloud for the tick
v1.7.0-windows,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.7.0-windows,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.7.0-windows,calculate number of points needed for each laser/channel
v1.7.0-windows,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.7.0-windows,calculate needed angle/distance between each point
v1.7.0-windows,normalize FOV start/end
v1.7.0-windows,shoot lasers
v1.7.0-windows,check if the laser is outside the requested horizontal FOV
v1.7.0-windows,"shoot laser and get the impact point, if any"
v1.7.0-windows,simulate shooting a laser via Unreal ray-tracing.
v1.7.0-windows,start position
v1.7.0-windows,We need to compose rotations here rather than rotate a vector by a quaternion
v1.7.0-windows,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.7.0-windows,get ray quaternion in lidar frame (angles must be in radians)
v1.7.0-windows,get ray quaternion in body frame
v1.7.0-windows,get ray quaternion in world frame
v1.7.0-windows,get ray vector (end position)
v1.7.0-windows,Store the segmentation id of the hit object.
v1.7.0-windows,Debug code for very specific cases.
v1.7.0-windows,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.7.0-windows,decide the frame for the point-cloud
v1.7.0-windows,current detault behavior; though it is probably not very useful.
v1.7.0-windows,not changing the default for now to maintain backwards-compat.
v1.7.0-windows,point in vehicle intertial frame
v1.7.0-windows,tranform to lidar frame
v1.7.0-windows,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.7.0-windows,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.7.0-windows,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.7.0-windows,"On the client side, if it is needed to transform this data back to the world frame,"
v1.7.0-windows,"then do the equivalent of following,"
v1.7.0-windows,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.7.0-windows,See SimModeBase::drawLidarDebugPoints()
v1.7.0-windows,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.7.0-windows,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,update ray tracing
v1.7.0-windows,"FString hit_name = FString(""None"");"
v1.7.0-windows,if (dist_hit.GetActor())
v1.7.0-windows,hit_name=dist_hit.GetActor()->GetName();
v1.7.0-windows,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.7.0-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,This assumes you are running DroneServer already on the same machine.
v1.7.0-windows,DroneServer must be running first.
v1.7.0-windows,enable API control
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,Load gazebo
v1.7.0-windows,Create our node for communication
v1.7.0-windows,Listen to Gazebo topics
v1.7.0-windows,Make sure to shut everything down.
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,move commands
v1.7.0-windows,else leave as it is
v1.7.0-windows,TODO: get these in one call
v1.7.0-windows,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.7.0-windows,TODO: shouldn't we pass folder path?
v1.7.0-windows,parse
v1.7.0-windows,group the images by the current date.
v1.7.0-windows,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.7.0-windows,{
v1.7.0-windows,"return """";"
v1.7.0-windows,}
v1.7.0-windows,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.7.0-windows,{
v1.7.0-windows,return false;
v1.7.0-windows,}
v1.7.0-windows,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.7.0-windows,params.context->client.newTask();
v1.7.0-windows,}
v1.7.0-windows,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.7.0-windows,params.context->client.WaitForCompletion(0);
v1.7.0-windows,}
v1.7.0-windows,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.7.0-windows,{
v1.7.0-windows,}
v1.7.0-windows,parse command line
v1.7.0-windows,Shell callbacks
v1.7.0-windows,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.7.0-windows,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.7.0-windows,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.7.0-windows,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.7.0-windows,Add shell commands
v1.7.0-windows,TODO: add WaitForCompletion command
v1.7.0-windows,"TODO: add command line args help, arg count validation"
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v1.7.0-windows,switch to explicit hover mode so that this is the fall back when
v1.7.0-windows,move* commands are finished.
v1.7.0-windows,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.7.0-windows,TODO: implement weather for Unity
v1.7.0-windows,TODO: implement weather for Unity
v1.7.0-windows,----------------Plotting APIs-----------/
v1.7.0-windows,Recording APIs
v1.7.0-windows,"Remove '' from the list, representing default vehicle"
v1.7.0-windows,CinemAirSim
v1.7.0-windows,End CinemAirSim
v1.7.0-windows,Function pointers to hold the addresses of the functions that are defined in Unity
v1.7.0-windows,"Enabling all LogLevels,"
v1.7.0-windows,"Enabling all LogLevels,"
v1.7.0-windows,delete ltm;
v1.7.0-windows,initialize state
v1.7.0-windows,compute our home point
v1.7.0-windows,default behavior is to call update every tick
v1.7.0-windows,"for custom physics engine, this method should be overridden and update should be"
v1.7.0-windows,called from every physics tick
v1.7.0-windows,these will be available for devices like steering wheels
v1.7.0-windows,sync environment from kinematics
v1.7.0-windows,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.7.0-windows,FVector unrealPosition = getUUPosition();
v1.7.0-windows,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v1.7.0-windows,parameters in NED frame
v1.7.0-windows,allow teleportation
v1.7.0-windows,if collisions are not enabled
v1.7.0-windows,or we have collided but passthrough is enabled
v1.7.0-windows,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.7.0-windows,"without flip flopping, collisions can't be detected"
v1.7.0-windows,by default we update kinematics from UE pawn
v1.7.0-windows,if SimMod uses its own physics engine then this should be overriden
v1.7.0-windows,no default action in this base class
v1.7.0-windows,TODO: because this bug we are using alternative code with stringstream
v1.7.0-windows,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.7.0-windows,update kinematics from pawn's movement instead of physics engine
v1.7.0-windows,TODO: update other fields?
v1.7.0-windows,implements getImages() method in the ImageCaptureBase class.
v1.7.0-windows,update ray tracing
v1.7.0-windows,TODO: index check
v1.7.0-windows,Attempts to parse the settings text from one of multiple locations.
v1.7.0-windows,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.7.0-windows,"Next, check the executable's working directory for the settings file."
v1.7.0-windows,"Finally, check the user's documents folder."
v1.7.0-windows,"If the settings file cannot be read, throw an exception"
v1.7.0-windows,let base class setup physics world
v1.7.0-windows,stop physics thread before we dismantle
v1.7.0-windows,setup clock in ClockFactory
v1.7.0-windows,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.7.0-windows,steppable clock returns interval that is a constant number irrespective of wall clock
v1.7.0-windows,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.7.0-windows,but that would cause vehicles like quadrotors to become unstable
v1.7.0-windows,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.7.0-windows,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.7.0-windows,get increase in clock speed
v1.7.0-windows,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.7.0-windows,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.7.0-windows,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.7.0-windows,Approach 2: scale control loop frequency if clock is speeded up
v1.7.0-windows,"for slowing down, this don't generate instability"
v1.7.0-windows,-------------------------------- overrides -----------------------------------------------//
v1.7.0-windows,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.7.0-windows,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.7.0-windows,create vehicle API
v1.7.0-windows,setup physics vehicle
v1.7.0-windows,initialize private vars
v1.7.0-windows,"if reset is pending then do it first, no need to do other things until next tick"
v1.7.0-windows,move collision info from rendering engine to vehicle
v1.7.0-windows,update rotor poses
v1.7.0-windows,if we did reset then don't worry about synchronizing states for this tick
v1.7.0-windows,Continue to wait for reset
v1.7.0-windows,*** Start: UpdatableState implementation ***//
v1.7.0-windows,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.7.0-windows,environment update for current position
v1.7.0-windows,update forces on vertices
v1.7.0-windows,update to controller must be done after kinematics have been updated by physics engine
v1.7.0-windows,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.7.0-windows,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.7.0-windows,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.7.0-windows,*** End: UpdatableState implementation ***//
v1.7.0-windows,TODO: should do reset() here?
v1.7.0-windows,these are called on render ticks
v1.7.0-windows,TODO: do we need this for cars?
v1.7.0-windows,Thrustmaster devices
v1.7.0-windows,"Anything else, typically Logitech G920 wheel"
v1.7.0-windows,Two steel levers behind wheel
v1.7.0-windows,if API-client control is not active then we route keyboard/joystick control to car
v1.7.0-windows,This is so that getCarControls API works correctly
v1.7.0-windows,"API is enabled, so we use the controls set by API"
v1.7.0-windows,Update whether to use API controls or keyboard controls
v1.7.0-windows,*** Start: UpdatableState implementation ***//
v1.7.0-windows,physics tick
v1.7.0-windows,void CarPawnSimApi::reportState(StateReporter& reporter)
v1.7.0-windows,{
v1.7.0-windows,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.7.0-windows,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.7.0-windows,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.7.0-windows,}
v1.7.0-windows,*** End: UpdatableState implementation ***//
v1.7.0-windows,remove everything that we created in BeginPlay
v1.7.0-windows,we use custom debug reporting for this class
v1.7.0-windows,perform any expensive rendering update outside of lock region
v1.7.0-windows,no need to call base reset because of our custom implementation
v1.7.0-windows,should be overridden by derived class
v1.7.0-windows,should be overridden by derived class
v1.7.0-windows,should be overridden by derived class
v1.7.0-windows,commenting this out for now to avoid unintentional Unity startup failure
v1.7.0-windows,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v1.7.0-windows,should be overridden by derived class
v1.7.0-windows,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.7.0-windows,default setup - this should be overridden in derived modes as needed
v1.7.0-windows,setup clock in ClockFactory
v1.7.0-windows,API server start/stop
v1.7.0-windows,determine camera director camera default pose and spawn it
v1.7.0-windows,derived class should override this method to retrieve types of pawns they support
v1.7.0-windows,derived class should override this method to retrieve types of pawns they support
v1.7.0-windows,can we just take origin in Unity here?
v1.7.0-windows,60 acres park:
v1.7.0-windows,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.7.0-windows,marymoore park
v1.7.0-windows,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.7.0-windows,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.7.0-windows,DepthNavThreshold depthNav;
v1.7.0-windows,DepthNavOptAStar depthNav;
v1.7.0-windows,DepthNavThreshold depthNav;
v1.7.0-windows,DepthNavOptAStar depthNav;
v1.7.0-windows,Cleanup
v1.7.0-windows,runDepthNavGT();
v1.7.0-windows,runDepthNavSGM();
v1.7.0-windows,Create the launch description and populate
v1.7.0-windows,Declare the launch options
v1.7.0-windows,todo do not reset if already in air?
v1.7.0-windows,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.7.0-windows,ros params
v1.7.0-windows,todo enforce dynamics constraints in this node as well?
v1.7.0-windows,"nh_->get_parameter(""max_vert_vel_"", max_vert_vel_);"
v1.7.0-windows,"nh_->get_parameter(""max_horz_vel"", max_horz_vel_)"
v1.7.0-windows,subscribe to control commands on global nodehandle
v1.7.0-windows,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.7.0-windows,bind to a single callback. todo optimal subs queue length
v1.7.0-windows,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.7.0-windows,"vehicle_ros.reset_srvr = nh_->create_service(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.7.0-windows,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.7.0-windows,camera_setting.gimbal
v1.7.0-windows,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.7.0-windows,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.7.0-windows,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.7.0-windows,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.7.0-windows,"if {DepthPlanar, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.7.0-windows,"push back pair (vector of image captures, current vehicle name)"
v1.7.0-windows,iterate over sensors
v1.7.0-windows,add takeoff and land all services if more than 2 drones
v1.7.0-windows,todo add per vehicle reset in AirLib API
v1.7.0-windows,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.7.0-windows,lidars update on their own callback/thread at a given rate
v1.7.0-windows,QoS - The depth of the publisher message queue.
v1.7.0-windows,more details here - https://docs.ros.org/en/foxy/Concepts/About-Quality-of-Service-Settings.html
v1.7.0-windows,"todo: error check. if state is not landed, return error."
v1.7.0-windows,response->success =
v1.7.0-windows,response->success =
v1.7.0-windows,response->success =
v1.7.0-windows,response->success =
v1.7.0-windows,response->success =
v1.7.0-windows,response->success =
v1.7.0-windows,todo add reset by vehicle_name API to airlib
v1.7.0-windows,todo not async remove wait_on_last_task
v1.7.0-windows,todo expose wait_on_last_task or nah?
v1.7.0-windows,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.7.0-windows,todo expose wait_on_last_task or nah?
v1.7.0-windows,todo support multiple gimbal commands
v1.7.0-windows,todo support multiple gimbal commands
v1.7.0-windows,1. find quaternion of default gimbal pose
v1.7.0-windows,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.7.0-windows,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.7.0-windows,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.7.0-windows,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.7.0-windows,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.7.0-windows,msg = []
v1.7.0-windows,todo covariances
v1.7.0-windows,gps_msg.position_covariance_type =
v1.7.0-windows,gps_msg.position_covariance =
v1.7.0-windows,todo covariances
v1.7.0-windows,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.7.0-windows,todo radians per second
v1.7.0-windows,meters/s2^m
v1.7.0-windows,imu_msg.orientation_covariance = ;
v1.7.0-windows,imu_msg.angular_velocity_covariance = ;
v1.7.0-windows,imu_msg.linear_acceleration_covariance = ;
v1.7.0-windows,todo do actual body frame?
v1.7.0-windows,airsim uses degrees
v1.7.0-windows,airsim appears to use chrono::system_clock with nanosecond precision
v1.7.0-windows,todo this is global origin
v1.7.0-windows,get the basic vehicle pose and environmental state
v1.7.0-windows,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.7.0-windows,airsim_client needs to provide the simulation time in a future version of the API
v1.7.0-windows,publish the simulation clock
v1.7.0-windows,"publish vehicle state, odom, and all basic sensor types"
v1.7.0-windows,send any commands out to the vehicles
v1.7.0-windows,"should be easier way to get the sim time through API, something like:"
v1.7.0-windows,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.7.0-windows,curr_ros_time = airsim_timestamp_to_ros(env.clock().nowNanos());
v1.7.0-windows,iterate over drones
v1.7.0-windows,get drone state from airsim
v1.7.0-windows,"vehicle environment, we can get ambient temperature here and other truths"
v1.7.0-windows,convert airsim drone state to ROS msgs
v1.7.0-windows,simulation environment truth
v1.7.0-windows,"dashboard reading from car, RPM, gear, etc"
v1.7.0-windows,odom and transforms
v1.7.0-windows,ground truth GPS position from sim/HITL
v1.7.0-windows,send control commands from the last callback to airsim
v1.7.0-windows,send control commands from the last callback to airsim
v1.7.0-windows,"Only camera rotation, no translation movement of camera"
v1.7.0-windows,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.7.0-windows,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.7.0-windows,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.7.0-windows,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.7.0-windows,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.7.0-windows,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.7.0-windows,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.7.0-windows,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.7.0-windows,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.7.0-windows,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.7.0-windows,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.7.0-windows,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.7.0-windows,update timestamp of saved cam info msgs
v1.7.0-windows,DepthPlanar / DepthPerspective / DepthVis / DisparityNormalized
v1.7.0-windows,Scene / Segmentation / SurfaceNormals / Infrared
v1.7.0-windows,publish camera transforms
v1.7.0-windows,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.7.0-windows,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.7.0-windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.7.0-windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.7.0-windows,ROS params
v1.7.0-windows,ROS publishers
v1.7.0-windows,ROS subscribers
v1.7.0-windows,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.7.0-windows,ROS timers
v1.7.0-windows,todo maintain internal representation as eigen vec?
v1.7.0-windows,todo check if low velocity if within thresh?
v1.7.0-windows,todo maintain separate errors for XY and Z
v1.7.0-windows,todo save this in degrees somewhere to avoid repeated conversion
v1.7.0-windows,this tells the update timer callback to not do active hovering
v1.7.0-windows,todo maintain array of position goals
v1.7.0-windows,todo error checks
v1.7.0-windows,todo fill response
v1.7.0-windows,"Already have goal, and have reached it"
v1.7.0-windows,this tells the update timer callback to not do active hovering
v1.7.0-windows,todo error checks
v1.7.0-windows,todo fill response
v1.7.0-windows,"todo do relative altitude, or add an option for the same?"
v1.7.0-windows,convert GPS goal to NED goal
v1.7.0-windows,"RCLCPP_INFO_STREAM(""geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.7.0-windows,todo error checks
v1.7.0-windows,todo fill response
v1.7.0-windows,"Already have goal, this shouldn't happen"
v1.7.0-windows,"todo do relative altitude, or add an option for the same?"
v1.7.0-windows,convert GPS goal to NED goal
v1.7.0-windows,"RCLCPP_INFO_STREAM(""geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.7.0-windows,todo error checks
v1.7.0-windows,todo fill response
v1.7.0-windows,todo check if odometry is too old!!
v1.7.0-windows,"if no odom, don't do anything."
v1.7.0-windows,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.7.0-windows,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.7.0-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.7.0-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.7.0-windows,todo yaw limits
v1.7.0-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.7.0-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.7.0-windows,mimics void ASimHUD::initializeSettings()
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,by Sudipta Sinha
v1.7.0-windows,adapted for AirSim by Matthias Mueller
v1.7.0-windows,first row
v1.7.0-windows,last row
v1.7.0-windows,Local quadratic fit of cost and subpixel refinement.
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,by Sudipta Sinha
v1.7.0-windows,adapted for AirSim by Matthias Mueller
v1.7.0-windows,uint64_t x64 = (uint64_t)x;
v1.7.0-windows,uint64_t y64 = (uint64_t)y;
v1.7.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.7.0-windows,Licensed under the MIT License.
v1.7.0-windows,by Sudipta Sinha
v1.7.0-windows,adapted for AirSim by Matthias Mueller
v1.7.0-windows,ensure that disparity range is a multiple of 8
v1.7.0-windows,sgm stereo
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,read settings and override defaults
v1.6.0-windows,allow json overrides on a per-vehicle basis.
v1.6.0-windows,start server in async mode
v1.6.0-windows,check messages
v1.6.0-windows,plot red arrows for 30 seconds
v1.6.0-windows,plot magenta arrows for 15 seconds
v1.6.0-windows,plot red arrows for 10 seconds
v1.6.0-windows,plot 2 white arrows which are persistent
v1.6.0-windows,plot points
v1.6.0-windows,"plot line strip. 0-1, 1-2, 2-3"
v1.6.0-windows,"plot line list. 0-1, 2-3, 4-5. Must be even."
v1.6.0-windows,plot transforms
v1.6.0-windows,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=0.0, yaw=yaw)) for x, y, yaw in zip(np.linspace(0,10,10), np.linspace(0,0,10), np.linspace(0,np.pi,10))],"
v1.6.0-windows,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.6.0-windows,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=roll, yaw=0.0)) for x, y, roll in zip(np.linspace(0,10,10), np.linspace(1,1,10), np.linspace(0,np.pi,10))],"
v1.6.0-windows,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.6.0-windows,Import this module to automatically setup path to local airsim module
v1.6.0-windows,This module first tries to see if airsim module is installed via pip
v1.6.0-windows,If it does then we don't do anything else
v1.6.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.6.0-windows,and if it does then we add that in sys.path
v1.6.0-windows,this class simply tries to see if airsim
v1.6.0-windows,if airsim module is installed then don't do anything else
v1.6.0-windows,import pkgutil
v1.6.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.6.0-windows,if airsim_loader is not None:
v1.6.0-windows,return
v1.6.0-windows,In settings.json first activate computer vision mode:
v1.6.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.6.0-windows,monitor car state while you drive it manually.
v1.6.0-windows,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v1.6.0-windows,denominator from microns^3 to microns * m^2)
v1.6.0-windows,First set everything to 0.
v1.6.0-windows,Next set all objects of interest provided to corresponding object IDs
v1.6.0-windows,segIdDict values MUST match tempEmissivityNew labels.
v1.6.0-windows,"Connect to AirSim, UAV mode."
v1.6.0-windows,Choose temperature values for winter or summer.
v1.6.0-windows,""""""""
v1.6.0-windows,winter
v1.6.0-windows,""""""""
v1.6.0-windows,summer
v1.6.0-windows,Read camera response.
v1.6.0-windows,Calculate radiance.
v1.6.0-windows,Set IDs in AirSim environment.
v1.6.0-windows,In settings.json first activate computer vision mode:
v1.6.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.6.0-windows,"define abstract class to return next vector in the format (x,y,yaw)"
v1.6.0-windows,"compute vector, distance and angle to goal"
v1.6.0-windows,compute box of interest
v1.6.0-windows,scale by weight matrix (optional)
v1.6.0-windows,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.6.0-windows,detect collision
v1.6.0-windows,compute box of interest
v1.6.0-windows,detect collision
v1.6.0-windows,Same as above but decide to go left or right based on average or some metric like that
v1.6.0-windows,"compute resultant normalized vector, distance and angle"
v1.6.0-windows,compute bounding box size
v1.6.0-windows,convert horizonal fov to vertical fov
v1.6.0-windows,matrix with all ones
v1.6.0-windows,matrix with max weight in center and decreasing linearly with distance from center
v1.6.0-windows,matrix with max weight in center and decreasing quadratically with distance from center
v1.6.0-windows,"print (""Saving images to %s"" % tmp_dir)"
v1.6.0-windows,airsim.wait_key('Press any key to start')
v1.6.0-windows,"Define start position, goal and size of UAV"
v1.6.0-windows,Define parameters and thresholds
v1.6.0-windows,initial position
v1.6.0-windows,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.6.0-windows,time.sleep(1)
v1.6.0-windows,get response
v1.6.0-windows,get numpy array
v1.6.0-windows,reshape array to 2D array H X W
v1.6.0-windows,write to png
v1.6.0-windows,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.6.0-windows,pose = client.simGetPose()
v1.6.0-windows,pp.pprint(pose)
v1.6.0-windows,time.sleep(5)
v1.6.0-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.6.0-windows,################### OLD CODE
v1.6.0-windows,timer = 0
v1.6.0-windows,time_obs = 50
v1.6.0-windows,bObstacle = False
v1.6.0-windows,if (bObstacle):
v1.6.0-windows,timer = timer + 1
v1.6.0-windows,if timer > time_obs:
v1.6.0-windows,bObstacle = False
v1.6.0-windows,timer = 0
v1.6.0-windows,else:
v1.6.0-windows,yaw = target_angle
v1.6.0-windows,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.6.0-windows,if (np.average(img2d_box) < coll_thres):
v1.6.0-windows,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.6.0-windows,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.6.0-windows,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.6.0-windows,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.6.0-windows,"print('left: ', img2d_box_l_avg)"
v1.6.0-windows,"print('right: ', img2d_box_r_avg)"
v1.6.0-windows,if img2d_box_l_avg > img2d_box_r_avg:
v1.6.0-windows,##Go LEFT
v1.6.0-windows,#y_offset = y_offset-1
v1.6.0-windows,yaw = yaw - radians(10)
v1.6.0-windows,bObstacle = True
v1.6.0-windows,else:
v1.6.0-windows,##Go RIGHT
v1.6.0-windows,#y_offset = y_offset+1
v1.6.0-windows,yaw = yaw + radians(10)
v1.6.0-windows,bObstacle = true
v1.6.0-windows,"print('yaw: ', yaw)"
v1.6.0-windows,In settings.json first activate computer vision mode:
v1.6.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.6.0-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.6.0-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.6.0-windows,pip install opencv-python
v1.6.0-windows,Just change the below to test different cameras easily!
v1.6.0-windows,Test Camera info
v1.6.0-windows,Test Image APIs
v1.6.0-windows,Test FoV API
v1.6.0-windows,Test Pose APIs
v1.6.0-windows,Test Distortion params APIs
v1.6.0-windows,In settings.json first activate computer vision mode:
v1.6.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.6.0-windows,In settings.json first activate computer vision mode:
v1.6.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.6.0-windows,for block environment
v1.6.0-windows,regex are case insensitive
v1.6.0-windows,#for neighborhood environment
v1.6.0-windows,set object ID for sky
v1.6.0-windows,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.6.0-windows,get segmentation image in various formats
v1.6.0-windows,save segmentation images in various formats
v1.6.0-windows,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.6.0-windows,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.6.0-windows,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v1.6.0-windows,find unique colors
v1.6.0-windows,In settings.json first activate computer vision mode:
v1.6.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.6.0-windows,objects can be named in two ways:
v1.6.0-windows,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.6.0-windows,default name is auto-generated and varies from run-to-run.
v1.6.0-windows,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.6.0-windows,
v1.6.0-windows,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.6.0-windows,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.6.0-windows,https://answers.unrealengine.com/revisions/790629.html
v1.6.0-windows,below works in Blocks environment
v1.6.0-windows,------------------------------------ Get current pose ------------------------------------------------
v1.6.0-windows,search object by name:
v1.6.0-windows,search another object by tag
v1.6.0-windows,search non-existent object
v1.6.0-windows,------------------------------------ Set new pose ------------------------------------------------
v1.6.0-windows,here we move with teleport enabled so collisions are ignored
v1.6.0-windows,here we move with teleport enabled so collisions are not ignored
v1.6.0-windows,move non-existent object
v1.6.0-windows,------------------------------------ Get new pose ------------------------------------------------
v1.6.0-windows,search another object by tag
v1.6.0-windows,search non-existent object
v1.6.0-windows,Import this module to automatically setup path to local airsim module
v1.6.0-windows,This module first tries to see if airsim module is installed via pip
v1.6.0-windows,If it does then we don't do anything else
v1.6.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.6.0-windows,and if it does then we add that in sys.path
v1.6.0-windows,this class simply tries to see if airsim
v1.6.0-windows,if airsim module is installed then don't do anything else
v1.6.0-windows,import pkgutil
v1.6.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.6.0-windows,if airsim_loader is not None:
v1.6.0-windows,return
v1.6.0-windows,"Roll is applied first, then pitch, then yaw."
v1.6.0-windows,Turn the camera position into a column vector.
v1.6.0-windows,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v1.6.0-windows,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v1.6.0-windows,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v1.6.0-windows,Recreate the perspective projection of the camera.
v1.6.0-windows,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v1.6.0-windows,Set pose and sleep after to ensure the pose sticks before capturing image.
v1.6.0-windows,Capture segmentation (IR) and scene images.
v1.6.0-windows,Change images into numpy arrays.
v1.6.0-windows,Capture images for a certain amount of time in seconds (half hour now)
v1.6.0-windows,Capture image - pose.position x_val access may change w/ AirSim
v1.6.0-windows,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v1.6.0-windows,Convert color scene image to BGR for write out with cv2.
v1.6.0-windows,"Connect to AirSim, UAV mode."
v1.6.0-windows,Look for objects with names that match a regular expression.
v1.6.0-windows,"Sample calls to main, varying camera angle and altitude."
v1.6.0-windows,"straight down, 400ft"
v1.6.0-windows,"straight down, 200ft"
v1.6.0-windows,"45 degrees, 200ft -- note that often object won't be scene since position"
v1.6.0-windows,is set exactly to object's
v1.6.0-windows,"45 degrees, 400ft -- note that often object won't be scene since position"
v1.6.0-windows,is set exactly to object's
v1.6.0-windows,In settings.json first activate computer vision mode:
v1.6.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.6.0-windows,xn = 1 + x*5  # some random number
v1.6.0-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,monitor car state while you drive it manually.
v1.6.0-windows,get state of the car
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,go forward
v1.6.0-windows,get state of the car
v1.6.0-windows,Python client example to change time-of-day using APIs
v1.6.0-windows,
v1.6.0-windows,Changes time of the day and makes the car move around
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,flip between specific time and default time
v1.6.0-windows,go forward
v1.6.0-windows,Go forward + steer right
v1.6.0-windows,main
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,get state of the car
v1.6.0-windows,go forward
v1.6.0-windows,Go forward + steer right
v1.6.0-windows,go reverse
v1.6.0-windows,apply brakes
v1.6.0-windows,get camera images from the car
v1.6.0-windows,restore to original state
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,go forward
v1.6.0-windows,Python client example to get Lidar data from a car
v1.6.0-windows,
v1.6.0-windows,Makes the drone fly and get Lidar data
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,"print(""state: %s"" % s)"
v1.6.0-windows,go forward
v1.6.0-windows,Go forward + steer right
v1.6.0-windows,"reshape array of floats to array of [X,Y,Z]"
v1.6.0-windows,TODO
v1.6.0-windows,main
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,get state of the car
v1.6.0-windows,go forward
v1.6.0-windows,Go forward + steer right
v1.6.0-windows,go reverse
v1.6.0-windows,apply breaks
v1.6.0-windows,restore to original state
v1.6.0-windows,Import this module to automatically setup path to local airsim module
v1.6.0-windows,This module first tries to see if airsim module is installed via pip
v1.6.0-windows,If it does then we don't do anything else
v1.6.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.6.0-windows,and if it does then we add that in sys.path
v1.6.0-windows,this class simply tries to see if airsim
v1.6.0-windows,if airsim module is installed then don't do anything else
v1.6.0-windows,import pkgutil
v1.6.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.6.0-windows,if airsim_loader is not None:
v1.6.0-windows,return
v1.6.0-windows,Use below in settings.json with blocks environment
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,get state of the car
v1.6.0-windows,go forward
v1.6.0-windows,go reverse
v1.6.0-windows,apply breaks
v1.6.0-windows,get camera images from the car
v1.6.0-windows,restore to original state
v1.6.0-windows,from keras.models import load_model
v1.6.0-windows,if (len(sys.argv) != 2):
v1.6.0-windows,print('usage: python drive.py <modelName>')
v1.6.0-windows,sys.exit()
v1.6.0-windows,print('Loading model...')
v1.6.0-windows,model = load_model(sys.argv[1])
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.6.0-windows,"model_output = model.predict([image_buf, state_buf])"
v1.6.0-windows,car_controls.steering = float(model_output[0][0])
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,set camera name and image type to request images and detections
v1.6.0-windows,set detection radius in [cm]
v1.6.0-windows,add desired object name to detect in wild card/regex format
v1.6.0-windows,Import this module to automatically setup path to local airsim module
v1.6.0-windows,This module first tries to see if airsim module is installed via pip
v1.6.0-windows,If it does then we don't do anything else
v1.6.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.6.0-windows,and if it does then we add that in sys.path
v1.6.0-windows,this class simply tries to see if airsim
v1.6.0-windows,if airsim module is installed then don't do anything else
v1.6.0-windows,import pkgutil
v1.6.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.6.0-windows,if airsim_loader is not None:
v1.6.0-windows,return
v1.6.0-windows,-*- coding: utf-8 -*-
v1.6.0-windows,
v1.6.0-windows,Configuration file for the Sphinx documentation builder.
v1.6.0-windows,
v1.6.0-windows,This file does only contain a selection of the most common options. For a
v1.6.0-windows,full list see the documentation:
v1.6.0-windows,http://www.sphinx-doc.org/en/master/config
v1.6.0-windows,-- Path setup --------------------------------------------------------------
v1.6.0-windows,"If extensions (or modules to document with autodoc) are in another directory,"
v1.6.0-windows,add these directories to sys.path here. If the directory is relative to the
v1.6.0-windows,"documentation root, use os.path.abspath to make it absolute, like shown here."
v1.6.0-windows,
v1.6.0-windows,-- Project information -----------------------------------------------------
v1.6.0-windows,The short X.Y version
v1.6.0-windows,"The full version, including alpha/beta/rc tags"
v1.6.0-windows,-- General configuration ---------------------------------------------------
v1.6.0-windows,"If your documentation needs a minimal Sphinx version, state it here."
v1.6.0-windows,
v1.6.0-windows,needs_sphinx = '1.0'
v1.6.0-windows,"Add any Sphinx extension module names here, as strings. They can be"
v1.6.0-windows,extensions coming with Sphinx (named 'sphinx.ext.*') or your custom
v1.6.0-windows,ones.
v1.6.0-windows,"Add any paths that contain templates here, relative to this directory."
v1.6.0-windows,The suffix(es) of source filenames.
v1.6.0-windows,You can specify multiple suffix as a list of string:
v1.6.0-windows,
v1.6.0-windows,"source_suffix = ['.rst', '.md']"
v1.6.0-windows,The master toctree document.
v1.6.0-windows,The language for content autogenerated by Sphinx. Refer to documentation
v1.6.0-windows,for a list of supported languages.
v1.6.0-windows,
v1.6.0-windows,This is also used if you do content translation via gettext catalogs.
v1.6.0-windows,"Usually you set ""language"" from the command line for these cases."
v1.6.0-windows,"List of patterns, relative to source directory, that match files and"
v1.6.0-windows,directories to ignore when looking for source files.
v1.6.0-windows,This pattern also affects html_static_path and html_extra_path.
v1.6.0-windows,The name of the Pygments (syntax highlighting) style to use.
v1.6.0-windows,-- Options for HTML output -------------------------------------------------
v1.6.0-windows,The theme to use for HTML and HTML Help pages.  See the documentation for
v1.6.0-windows,a list of builtin themes.
v1.6.0-windows,
v1.6.0-windows,html_theme = 'alabaster'
v1.6.0-windows,Theme options are theme-specific and customize the look and feel of a theme
v1.6.0-windows,"further.  For a list of options available for each theme, see the"
v1.6.0-windows,documentation.
v1.6.0-windows,
v1.6.0-windows,html_theme_options = {}
v1.6.0-windows,"Add any paths that contain custom static files (such as style sheets) here,"
v1.6.0-windows,"relative to this directory. They are copied after the builtin static files,"
v1.6.0-windows,"so a file named ""default.css"" will overwrite the builtin ""default.css""."
v1.6.0-windows,"Custom sidebar templates, must be a dictionary that maps document names"
v1.6.0-windows,to template names.
v1.6.0-windows,
v1.6.0-windows,The default sidebars (for documents that don't match any pattern) are
v1.6.0-windows,defined by theme itself.  Builtin themes are using these templates by
v1.6.0-windows,"default: ``['localtoc.html', 'relations.html', 'sourcelink.html',"
v1.6.0-windows,'searchbox.html']``.
v1.6.0-windows,
v1.6.0-windows,html_sidebars = {}
v1.6.0-windows,-- Options for HTMLHelp output ---------------------------------------------
v1.6.0-windows,Output file base name for HTML help builder.
v1.6.0-windows,-- Options for LaTeX output ------------------------------------------------
v1.6.0-windows,The paper size ('letterpaper' or 'a4paper').
v1.6.0-windows,
v1.6.0-windows,"'papersize': 'letterpaper',"
v1.6.0-windows,"The font size ('10pt', '11pt' or '12pt')."
v1.6.0-windows,
v1.6.0-windows,"'pointsize': '10pt',"
v1.6.0-windows,Additional stuff for the LaTeX preamble.
v1.6.0-windows,
v1.6.0-windows,"'preamble': '',"
v1.6.0-windows,Latex figure (float) alignment
v1.6.0-windows,
v1.6.0-windows,"'figure_align': 'htbp',"
v1.6.0-windows,Grouping the document tree into LaTeX files. List of tuples
v1.6.0-windows,"(source start file, target name, title,"
v1.6.0-windows,"author, documentclass [howto, manual, or own class])."
v1.6.0-windows,-- Options for manual page output ------------------------------------------
v1.6.0-windows,One entry per manual page. List of tuples
v1.6.0-windows,"(source start file, name, description, authors, manual section)."
v1.6.0-windows,-- Options for Texinfo output ----------------------------------------------
v1.6.0-windows,Grouping the document tree into Texinfo files. List of tuples
v1.6.0-windows,"(source start file, target name, title, author,"
v1.6.0-windows,"dir menu entry, description, category)"
v1.6.0-windows,-- Options for Epub output -------------------------------------------------
v1.6.0-windows,Bibliographic Dublin Core info.
v1.6.0-windows,The unique identifier of the text. This can be a ISBN number
v1.6.0-windows,or the project homepage.
v1.6.0-windows,
v1.6.0-windows,epub_identifier = ''
v1.6.0-windows,A unique identification for the text.
v1.6.0-windows,
v1.6.0-windows,epub_uid = ''
v1.6.0-windows,A list of files that should not be packed into the epub file.
v1.6.0-windows,-- Extension configuration -------------------------------------------------
v1.6.0-windows,-- Options for intersphinx extension ---------------------------------------
v1.6.0-windows,Example configuration for intersphinx: refer to the Python standard library.
v1.6.0-windows,-- Options for todo extension ----------------------------------------------
v1.6.0-windows,"If true, `todo` and `todoList` produce output, else they produce nothing."
v1.6.0-windows,We ignore the 2D nature of the problem as it is not relevant here
v1.6.0-windows,It makes multi-core processing more straightforward
v1.6.0-windows,Allocations
v1.6.0-windows,Add small number to avoid issues with log(I)
v1.6.0-windows,Event sim keeps track of previous image automatically
v1.6.0-windows,"Using pickle dump in a per-frame fashion to save time, instead of savetxt"
v1.6.0-windows,Optimizations possible
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,that's enough fun for now. let's quit cleanly
v1.6.0-windows,"Python client example to get Lidar data from a drone, although this script works for any AirSim-supported vehicle"
v1.6.0-windows,This script is for Lidar sensors using 'SensorLocalFrame' as DataFrame under settings.json.
v1.6.0-windows,Sample settings.json used for this script:
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,main
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,MultirotorClient.wait_key('Press any key to takeoff')
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,get camera images from the car
v1.6.0-windows,that's enough fun for now. let's quit cleanly
v1.6.0-windows,##################################################################################################
v1.6.0-windows,
v1.6.0-windows,Project:  Embedded Learning Library (ELL)
v1.6.0-windows,File:     speaker.py
v1.6.0-windows,Authors:  Chris Lovett
v1.6.0-windows,
v1.6.0-windows,Requires: Python 3.x
v1.6.0-windows,
v1.6.0-windows,##################################################################################################
v1.6.0-windows,open speakers so we can hear what it is processing...
v1.6.0-windows,teleport the drone + 10 meters in x-direction
v1.6.0-windows,teleport the drone back
v1.6.0-windows,This example shows how to use the External Physics Engine
v1.6.0-windows,It allows you to control the drone through setVehiclePose and obtain collision information.
v1.6.0-windows,It is especially useful for injecting your own flight dynamics model to the AirSim drone.
v1.6.0-windows,Use Blocks environment to see the drone colliding and seeing the collision information
v1.6.0-windows,in the command prompt.
v1.6.0-windows,Add this line to your settings.json before running AirSim:
v1.6.0-windows,"""PhysicsEngineName"":""ExternalPhysicsEngine"""
v1.6.0-windows,use open cv to create point cloud from depth image.
v1.6.0-windows,###########################################
v1.6.0-windows,######### This is work in progress! #######
v1.6.0-windows,###########################################
v1.6.0-windows,file will be saved in PythonClient folder (i.e. same folder as script)
v1.6.0-windows,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.6.0-windows,skip it
v1.6.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.6.0-windows,z of -7 is 7 meters above the original launch point.
v1.6.0-windows,Fly given velocity vector for 5 seconds
v1.6.0-windows,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.6.0-windows,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.6.0-windows,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.6.0-windows,Make the drone fly in a circle.
v1.6.0-windows,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.6.0-windows,check that our home position is stable
v1.6.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.6.0-windows,ramp up time
v1.6.0-windows,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.6.0-windows,compute current angle
v1.6.0-windows,compute lookahead
v1.6.0-windows,if we did the takeoff then also do the landing.
v1.6.0-windows,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.6.0-windows,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.6.0-windows,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.6.0-windows,ignore the click over from 360 back to 0
v1.6.0-windows,watch direction this diff is moving if it switches from shrinking to growing
v1.6.0-windows,then we passed the starting point.
v1.6.0-windows,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.6.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.6.0-windows,z of -5 is 5 meters above the original launch point.
v1.6.0-windows,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.6.0-windows,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.6.0-windows,drone will over-shoot so we bring it back to the start point before landing.
v1.6.0-windows,"Python client example to get Lidar data from a drone, although this script works for any AirSim-supported vehicle"
v1.6.0-windows,This script is for Lidar sensors using 'VehicleInertialFrame' as DataFrame under settings.json
v1.6.0-windows,Sample settings.json used for this script:
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,main
v1.6.0-windows,Run this script with clock speed in settings.json
v1.6.0-windows,"""ClockSpeed"": 1 then change it to 0.5"
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,with ClockSpeed = 0.5 you will see that this takes 6s (system time) and not 3s
v1.6.0-windows,with ClockSpeed = 0.5 you will see that this takes 10s (system time)
v1.6.0-windows,and not 5s in each iteration
v1.6.0-windows,that's enough fun for now. let's quit cleanly
v1.6.0-windows,Takeoff or hover
v1.6.0-windows,Set wind to 0
v1.6.0-windows,Takeoff or hover
v1.6.0-windows,In settings.json first activate computer vision mode:
v1.6.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.6.0-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.6.0-windows,pip install opencv-python
v1.6.0-windows,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.6.0-windows,fly for 2 minutes
v1.6.0-windows,more than 50 centimeter drift is unacceptable.
v1.6.0-windows,Python client example to get Lidar data from a drone
v1.6.0-windows,
v1.6.0-windows,Makes the drone fly and get Lidar data
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,"print(""state: %s"" % s)"
v1.6.0-windows,"print(""state: %s"" % pprint.pformat(state))"
v1.6.0-windows,"reshape array of floats to array of [X,Y,Z]"
v1.6.0-windows,TODO
v1.6.0-windows,main
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.6.0-windows,let it settle there a bit.
v1.6.0-windows,after hovering we need to re-enabled api control for next leg of the trip
v1.6.0-windows,now compute the survey path required to fill the box
v1.6.0-windows,##################################################################################################
v1.6.0-windows,
v1.6.0-windows,Project:  Embedded Learning Library (ELL)
v1.6.0-windows,File:     wav_reader.py
v1.6.0-windows,Authors:  Chris Lovett
v1.6.0-windows,
v1.6.0-windows,Requires: Python 3.x
v1.6.0-windows,
v1.6.0-windows,##################################################################################################
v1.6.0-windows,open a stream on the audio input file.
v1.6.0-windows,"assumes signed integer used in raw audio, so for example, the max for 16bit is 2^15 (32768)"
v1.6.0-windows,convert int16 data to scaled floats
v1.6.0-windows,configure output stream to match what we are resampling to...
v1.6.0-windows,convert the audio to the desired recording rate
v1.6.0-windows,split into separate channels
v1.6.0-windows,drop the channels we don't want
v1.6.0-windows,zip the resulting channels back up.
v1.6.0-windows,convert back to packed bytes in PCM 16 format
v1.6.0-windows,"deal with any accumulation of tails, if the tail grows to a full"
v1.6.0-windows,buffer then return it!
v1.6.0-windows,"we have a tail from previous frame, so prepend it"
v1.6.0-windows,"now the caller needs us to stick to our sample_size contract, but when"
v1.6.0-windows,rate conversion happens we can't be sure that 'data' is exactly that size.
v1.6.0-windows,usually one byte extra so add this to our accumulating tail
v1.6.0-windows,"might have reached the end of a file, so pad with zeros."
v1.6.0-windows,"Please add ""EnableTrace"": true to your setting.json as shown below"
v1.6.0-windows,{
v1.6.0-windows,"""SettingsVersion"": 1.2,"
v1.6.0-windows,"""SimMode"": ""Multirotor"","
v1.6.0-windows,"""Vehicles"": {"
v1.6.0-windows,"""Drone"": {"
v1.6.0-windows,"""VehicleType"": ""SimpleFlight"","
v1.6.0-windows,"""EnableTrace"": true"
v1.6.0-windows,}
v1.6.0-windows,}
v1.6.0-windows,}
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,add new vehicle
v1.6.0-windows,Use below in settings.json with Blocks environment
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,get camera images from the car
v1.6.0-windows,that's enough fun for now. let's quit cleanly
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,Import this module to automatically setup path to local airsim module
v1.6.0-windows,This module first tries to see if airsim module is installed via pip
v1.6.0-windows,If it does then we don't do anything else
v1.6.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.6.0-windows,and if it does then we add that in sys.path
v1.6.0-windows,this class simply tries to see if airsim
v1.6.0-windows,if airsim module is installed then don't do anything else
v1.6.0-windows,import pkgutil
v1.6.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.6.0-windows,if airsim_loader is not None:
v1.6.0-windows,return
v1.6.0-windows,"this script moves the drone to a location, then rests it thousands of time"
v1.6.0-windows,purpose of this script is to stress test reset API
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,that's enough fun for now. let's quite cleanly
v1.6.0-windows,For high speed ascent and descent on PX4 you may need to set these properties:
v1.6.0-windows,param set MPC_Z_VEL_MAX_UP 5
v1.6.0-windows,param set MPC_Z_VEL_MAX_DN 5
v1.6.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.6.0-windows,z of -50 is 50 meters above the original launch point.
v1.6.0-windows,use open cv to show new images from AirSim
v1.6.0-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.6.0-windows,pip install opencv-python
v1.6.0-windows,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.6.0-windows,get depth image
v1.6.0-windows,"this will return png width= 256, height= 144"
v1.6.0-windows,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.6.0-windows,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.6.0-windows,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.6.0-windows,to get an estimate of distance.
v1.6.0-windows,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.6.0-windows,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.6.0-windows,an angular delta of the following pi/10.
v1.6.0-windows,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.6.0-windows,Remove alpha channel if exists
v1.6.0-windows,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.6.0-windows,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.6.0-windows,Flatten and yield as tuple
v1.6.0-windows,Initialize a resizable dataset to hold the output
v1.6.0-windows,Resize the dataset to accommodate the next chunk of rows
v1.6.0-windows,Create the next chunk
v1.6.0-windows,Increment the row count
v1.6.0-windows,Arguments
v1.6.0-windows,Returns
v1.6.0-windows,use composition of homographies
v1.6.0-windows,to generate final transform that needs to be applied
v1.6.0-windows,Arguments
v1.6.0-windows,Returns
v1.6.0-windows,Keeps under lock only the mechanism which advances
v1.6.0-windows,the indexing of each batch.
v1.6.0-windows,The transformation of images is not under thread lock
v1.6.0-windows,so it can be done in parallel
v1.6.0-windows,Trained model path
v1.6.0-windows,Connect to AirSim
v1.6.0-windows,Start driving
v1.6.0-windows,Initialize image buffer
v1.6.0-windows,Update throttle value according to steering angle
v1.6.0-windows,Prediction
v1.6.0-windows,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.6.0-windows,Print progress
v1.6.0-windows,Update next car state
v1.6.0-windows,Wait a bit between iterations
v1.6.0-windows,%matplotlib inline
v1.6.0-windows,chunk size for training batches
v1.6.0-windows,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.6.0-windows,Point this to the directory containing the raw data
v1.6.0-windows,Point this to the desired output directory for the cooked (.h5) data
v1.6.0-windows,Choose The folders to search for data under RAW_DATA_DIR
v1.6.0-windows,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.6.0-windows,data_folder.append('folder_name1')
v1.6.0-windows,data_folder.append('folder_name2')
v1.6.0-windows,...
v1.6.0-windows,Hyper-parameters
v1.6.0-windows,Activation functions
v1.6.0-windows,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.6.0-windows,<< The directory containing the cooked data from the previous step >>
v1.6.0-windows,<< The directory in which the model output will be placed >>
v1.6.0-windows,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.6.0-windows,Network definition
v1.6.0-windows,Import this module to automatically setup path to local airsim module
v1.6.0-windows,This module first tries to see if airsim module is installed via pip
v1.6.0-windows,If it does then we don't do anything else
v1.6.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.6.0-windows,and if it does then we add that in sys.path
v1.6.0-windows,this class simply tries to see if airsim
v1.6.0-windows,if airsim module is installed then don't do anything else
v1.6.0-windows,import pkgutil
v1.6.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.6.0-windows,if airsim_loader is not None:
v1.6.0-windows,return
v1.6.0-windows,DEY: I don't know why this was there.
v1.6.0-windows,-----------------------------------  Common vehicle APIs ---------------------------------------------
v1.6.0-windows,basic flight control
v1.6.0-windows,time-of-day control
v1.6.0-windows,weather
v1.6.0-windows,camera control
v1.6.0-windows,simGetImage returns compressed png in array of bytes
v1.6.0-windows,image_type uses one of the ImageType members
v1.6.0-windows,"todo: in future remove below, it's only for compatibility to pre v1.2"
v1.6.0-windows,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.6.0-windows,camera control
v1.6.0-windows,simGetImage returns compressed png in array of bytes
v1.6.0-windows,image_type uses one of the ImageType members
v1.6.0-windows,gets the static meshes in the unreal scene
v1.6.0-windows,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.6.0-windows,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.6.0-windows,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.6.0-windows,sensor APIs
v1.6.0-windows,Plotting APIs
v1.6.0-windows,Recording APIs
v1.6.0-windows,Add new vehicle via RPC
v1.6.0-windows,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.6.0-windows,APIs for control
v1.6.0-windows,low-level control API
v1.6.0-windows,query vehicle state
v1.6.0-windows,query rotor states
v1.6.0-windows,-----------------------------------  Car APIs ---------------------------------------------
v1.6.0-windows,helper method for converting getOrientation to roll/pitch/yaw
v1.6.0-windows,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.6.0-windows,roll (x-axis rotation)
v1.6.0-windows,pitch (y-axis rotation)
v1.6.0-windows,yaw (z-axis rotation)
v1.6.0-windows,DEY: I don't know why this was there.
v1.6.0-windows,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.6.0-windows,return cls(**msgpack.unpack(encoded))
v1.6.0-windows,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.6.0-windows,Create a DummyVecEnv for main airsim gym env
v1.6.0-windows,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.6.0-windows,Initialize RL algorithm type and parameters
v1.6.0-windows,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.6.0-windows,Train for a certain number of timesteps
v1.6.0-windows,Save policy weights
v1.6.0-windows,Create a DummyVecEnv for main airsim gym env
v1.6.0-windows,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.6.0-windows,Initialize RL algorithm type and parameters
v1.6.0-windows,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.6.0-windows,Train for a certain number of timesteps
v1.6.0-windows,Save policy weights
v1.6.0-windows,Import this module to automatically setup path to local airsim module
v1.6.0-windows,This module first tries to see if airsim module is installed via pip
v1.6.0-windows,If it does then we don't do anything else
v1.6.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.6.0-windows,and if it does then we add that in sys.path
v1.6.0-windows,this class simply tries to see if airsim
v1.6.0-windows,if airsim module is installed then don't do anything else
v1.6.0-windows,import pkgutil
v1.6.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.6.0-windows,if airsim_loader is not None:
v1.6.0-windows,return
v1.6.0-windows,Set home position and velocity
v1.6.0-windows,print(dist)
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,"This is a bit crude, but give it a moment to settle on the ground, else takeoff will fail"
v1.6.0-windows,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.6.0-windows,switch to explicit hover mode so that this is the fallback when
v1.6.0-windows,move* commands are finished.
v1.6.0-windows,"Altitude difference between each platform, in meters"
v1.6.0-windows,"Count down, so the first one can easily go the highest (without knowing count)"
v1.6.0-windows,"in header only mode, control library is not available"
v1.6.0-windows,if using Unreal Build system then include precompiled header file first
v1.6.0-windows,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.6.0-windows,"Windows, OSX and Linux."
v1.6.0-windows,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.6.0-windows,Windows users can move the Documents folder to any location they want
v1.6.0-windows,SHGetFolderPath knows how to find it.
v1.6.0-windows,fall back in case SHGetFolderPath failed for some reason.
v1.6.0-windows,convert from std::path '/' to windows backslash.
v1.6.0-windows,make the current thread run with maximum priority.
v1.6.0-windows,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.6.0-windows,TODO: How to handle POSIX thread priorities on OSX?
v1.6.0-windows,setThreadName is a helper function that is useful when debugging because your threads
v1.6.0-windows,show up in the debugger with the name you set which makes it easier to find the threads
v1.6.0-windows,that you are interested in.
v1.6.0-windows,"unfortunately this is only available on Windows 10, and AirSim is not limited to that."
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.6.0-windows,
v1.6.0-windows,Treat all errors as failure conditions.
v1.6.0-windows,parse command line
v1.6.0-windows,"motive gives a weird error if the project is not found, so we look for it."
v1.6.0-windows,Do an update to pick up any recently-arrived cameras.
v1.6.0-windows,List all detected cameras.
v1.6.0-windows,List all defined rigid bodies.
v1.6.0-windows,throttle to 50 messages per second.
v1.6.0-windows,OptiTrack uses 'y' axis for vertical.
v1.6.0-windows,stdafx.cpp : source file that includes just the standard includes
v1.6.0-windows,MavlinkMoCap.pch will be the pre-compiled header
v1.6.0-windows,stdafx.obj will contain the pre-compiled type information
v1.6.0-windows,TODO: reference any additional headers you need in STDAFX.H
v1.6.0-windows,and not in this file
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,PX4.cpp : Defines the entry point for the console application.
v1.6.0-windows,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.6.0-windows,how do you write to the debug output windows on Unix ?
v1.6.0-windows,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.6.0-windows,connection to create to talke to that server.
v1.6.0-windows,SITL setup info
v1.6.0-windows,The local ethernet interface to use (default localhost).
v1.6.0-windows,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.6.0-windows,server mode on UDP is when you want another app to connect to Pixhawk and publish data back to this process.
v1.6.0-windows,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.6.0-windows,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.6.0-windows,"using their the -qgc option.  Server mode on TCP means mavlinktest will do an ""accept"" socket which is"
v1.6.0-windows,what PX4 is waiting for when it is running in TCP mode.  Here the serverEndPoint is different from the
v1.6.0-windows,offboardEndPoint.  The serverEndPoint specifies which local address to use in case your computer has
v1.6.0-windows,multiple network interfaces.
v1.6.0-windows,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.6.0-windows,this switch controls whether we turn off the RC remote active link loss detection
v1.6.0-windows,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.6.0-windows,from kicking in when you try and fly.
v1.6.0-windows,parse the json
v1.6.0-windows,flatten inner mavlink object
v1.6.0-windows,flatten inner mavlink object
v1.6.0-windows,todo
v1.6.0-windows,todo
v1.6.0-windows,"const char* outLogFileOption = ""outlogfile"";"
v1.6.0-windows,parse command line
v1.6.0-windows,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.6.0-windows,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.6.0-windows,"no local serial connection, so this is the primary droneConnection."
v1.6.0-windows,need a retry loop here because we don't know how quickly px4 will start accepting these connections...
v1.6.0-windows,failed to connect
v1.6.0-windows,"then we need 2 mavlink channels, one for sending/receiving HIL_* messages and the other"
v1.6.0-windows,for controlling the drone.
v1.6.0-windows,this is the control channel.
v1.6.0-windows,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.6.0-windows,cmdTable.push_back(new AltHoldCommand());
v1.6.0-windows,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.6.0-windows,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.6.0-windows,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.6.0-windows,this stops us from being able to connect to SITL mode PX4.
v1.6.0-windows,checkPulse();
v1.6.0-windows,add command text in log
v1.6.0-windows,close previous command.
v1.6.0-windows,FilterLogFiles(logDirectory);
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,send a heartbeat
v1.6.0-windows,accept one incoming connection
v1.6.0-windows,send a heartbeat to the client
v1.6.0-windows,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.6.0-windows,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.6.0-windows,for this unit test we are expecting a request to send an image.
v1.6.0-windows,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.6.0-windows,hmmm
v1.6.0-windows,================ ls
v1.6.0-windows,================ put file
v1.6.0-windows,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.6.0-windows,================ get file
v1.6.0-windows,verify the file contents.
v1.6.0-windows,================ remove file
v1.6.0-windows,================ make directory
v1.6.0-windows,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.6.0-windows,================ remove directory
v1.6.0-windows,Now verification
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,you must call this method if you want HandleMessage to be called subsequently.
v1.6.0-windows,treat literals as one word
v1.6.0-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.6.0-windows,request gps info
v1.6.0-windows,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.6.0-windows,find relative position since command start so we can compare two commands better
v1.6.0-windows,"these PID values are important, so set these to match"
v1.6.0-windows,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.6.0-windows,we can skip ahead.
v1.6.0-windows,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.6.0-windows,TODO: avoid passing hadcoded HIL flag
v1.6.0-windows,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.6.0-windows,"The global position, as returned by the Global Positioning System (GPS)."
v1.6.0-windows,Provides state for additional features
v1.6.0-windows,The general system state
v1.6.0-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.6.0-windows,Provides state for additional features
v1.6.0-windows,The general system state
v1.6.0-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.6.0-windows,Provides state for additional features
v1.6.0-windows,The general system state
v1.6.0-windows,Provides state for additional features
v1.6.0-windows,The general system state
v1.6.0-windows,note: we do not reset com when Close() is called because we want to keep running.
v1.6.0-windows,"user has to invoke ""hil stop"" to stop the hil thread."
v1.6.0-windows,generate random between 0 and 1
v1.6.0-windows,move to range -1 to 1
v1.6.0-windows,scale it
v1.6.0-windows,apply iy
v1.6.0-windows,wait for the Execute method to be called.
v1.6.0-windows,gps is much slower frequency than IMU.
v1.6.0-windows,MAVLINK_MSG_ID_HIL_GPS
v1.6.0-windows,disable MAV_USEHILGPS
v1.6.0-windows,note: we do not reset com when Close() is called because we want to keep running.
v1.6.0-windows,"user has to invoke ""hil stop"" to stop the hil thread."
v1.6.0-windows,generate random between 0 and 1
v1.6.0-windows,move to range -1 to 1
v1.6.0-windows,scale it
v1.6.0-windows,apply iy
v1.6.0-windows,wait for the Execute method to be called.
v1.6.0-windows,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.6.0-windows,gps is much slower frequency than IMU.
v1.6.0-windows,MAVLINK_MSG_ID_HIL_GPS
v1.6.0-windows,disable HIL mode
v1.6.0-windows,Enumeration of landed detector states
v1.6.0-windows,MAV landed state is unknown
v1.6.0-windows,MAV is landed (on ground)
v1.6.0-windows,MAV is in air
v1.6.0-windows,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.6.0-windows,The filtered local position
v1.6.0-windows,must send these regularly to keep offboard control.
v1.6.0-windows,"ok, now we can safely switch to loiter."
v1.6.0-windows,must send these regularly to keep offboard control.
v1.6.0-windows,integrate the heading so it is smoother.
v1.6.0-windows,must send these regularly to keep offboard control.
v1.6.0-windows,integrate the heading so it is smoother.
v1.6.0-windows,fly to radius
v1.6.0-windows,it takes about 10 cm to stop and turn.
v1.6.0-windows,next time around switch to orbiting!
v1.6.0-windows,heading points to center of circle.
v1.6.0-windows,interpoloate the speed ramp up time over 2 seconds from start time
v1.6.0-windows,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.6.0-windows,monitor the sin curves so we can see how on track or off track it actually is.
v1.6.0-windows,the shape of the curve will also tell us if we are progressing at a consistent
v1.6.0-windows,"speed, the more deformed the sin curve the worse our progress."
v1.6.0-windows,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.6.0-windows,degrees just flipped from 359 to 0.
v1.6.0-windows,this enables us to test what happens when offboard control is lost and resumed.
v1.6.0-windows,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.6.0-windows,"ok, now we can start moving by velocity"
v1.6.0-windows,recompute to new target.
v1.6.0-windows,start by moving right with 10 degree roll.
v1.6.0-windows,haven't started yet.
v1.6.0-windows,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.6.0-windows,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.6.0-windows,track how our actual pitch is coming along compared to our target
v1.6.0-windows,and check position
v1.6.0-windows,the amount of pitch should depend on our speed in that direction.
v1.6.0-windows,passed the midpoint.
v1.6.0-windows,fade out the pitch as we pick up speed so we don't overshoot.
v1.6.0-windows,see if we just crossed the wiggle distance threshold.
v1.6.0-windows,(pitch affects the x-position).
v1.6.0-windows,reverse direction with a -30 degrees quick stop
v1.6.0-windows,reverse direction with a 30 degrees quick stop
v1.6.0-windows,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.6.0-windows,too much in that direction.
v1.6.0-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.6.0-windows,track how our actual roll is coming along compared to our target
v1.6.0-windows,and check position
v1.6.0-windows,the amount of roll should depend on our speed in that direction.
v1.6.0-windows,passed the midpoint.
v1.6.0-windows,fade out the roll as we pick up speed so we don't overshoot.
v1.6.0-windows,see if we just crossed the wiggle distance threshold.
v1.6.0-windows,(roll affects the y-position).
v1.6.0-windows,reverse direction with a -30 degrees quick stop
v1.6.0-windows,reverse direction with a 30 degrees quick stop
v1.6.0-windows,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.6.0-windows,too much in that direction.
v1.6.0-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.6.0-windows,for testing PID controller.
v1.6.0-windows,class AltHoldCommand : public Command
v1.6.0-windows,{
v1.6.0-windows,std::shared_ptr<MavLinkVehicle> channel;
v1.6.0-windows,"float sx_, sy_, sz_;"
v1.6.0-windows,MavLinkAttitudeTarget _current;
v1.6.0-windows,PidController thrust_controller_;
v1.6.0-windows,public:
v1.6.0-windows,this->sz_ = pos.z; // user defined target.
v1.6.0-windows,move to local position keeps the offboard control happy.
v1.6.0-windows,haven't started yet.
v1.6.0-windows,and check position
v1.6.0-windows,double dx = this->sx_ - pos.x;
v1.6.0-windows,double dy = this->sy_ - pos.y;
v1.6.0-windows,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.6.0-windows,too much in that direction.
v1.6.0-windows,adjust thrust so we keep steady height target
v1.6.0-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.6.0-windows,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.6.0-windows,local remote
v1.6.0-windows,already handled by the parse method.
v1.6.0-windows,we only support very simple patterns for now.
v1.6.0-windows,each wildcard must be separated by literal.
v1.6.0-windows,back to back wildcards with no literal in between is too complex.
v1.6.0-windows,"we only support simple matching for now, we can add full regex later if we need it."
v1.6.0-windows,yep!
v1.6.0-windows,'*' is done we found the next matching char
v1.6.0-windows,this is ok.
v1.6.0-windows,this is an ERASE_END_LINE command which we ignore.
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,pack the payload buffer.
v1.6.0-windows,calculate checksum
v1.6.0-windows,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.6.0-windows,are variable length as a result.
v1.6.0-windows,form the header as a byte array for the crc
v1.6.0-windows,unpack the message...
v1.6.0-windows,pack the payload buffer.
v1.6.0-windows,"json can't handle ""nan"", so we convert it to null."
v1.6.0-windows,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.6.0-windows,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,start listening to this connection
v1.6.0-windows,Send heartbeat to drone.  You should not do this if some other node is
v1.6.0-windows,already doing it.
v1.6.0-windows,stop listening to the connection.
v1.6.0-windows,get the connection
v1.6.0-windows,Get the local system and component id
v1.6.0-windows,send a command to the remote node
v1.6.0-windows,MavLinkNode::MavLinkNode() = default;
v1.6.0-windows,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.6.0-windows,decrementing the count so the next WaitOne may block.
v1.6.0-windows,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.6.0-windows,convert to absolute time.
v1.6.0-windows,use mach_timespec
v1.6.0-windows,convert to absolute time.
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,return true if we still have offboard control (can lose this if user flips the switch).
v1.6.0-windows,MavLinkVehicle::MavLinkVehicle() = default;
v1.6.0-windows,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.6.0-windows,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,============================== CLIENT ============================================
v1.6.0-windows,image APIs
v1.6.0-windows,or if you are implementing the client side call this function to get the most recent frame.
v1.6.0-windows,returns false if there is no new frame available.
v1.6.0-windows,============================== SERVER ============================================
v1.6.0-windows,call this to send the image back over the connection given to start function.
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,"log every message that is ""sent"" using sendMessage."
v1.6.0-windows,"log every message that is ""received"""
v1.6.0-windows,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.6.0-windows,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.6.0-windows,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.6.0-windows,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,for compatibility with QGroundControl we have to save the time field in big endian.
v1.6.0-windows,todo: mavlink2 support?
v1.6.0-windows,has to be one or the other!
v1.6.0-windows,24 bits.
v1.6.0-windows,24 bits.
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,start listening to this connection
v1.6.0-windows,Send heartbeat to drone.  You should not do this if some other node is
v1.6.0-windows,already doing it.
v1.6.0-windows,this is called for all messages received on the connection.
v1.6.0-windows,"we received a heartbeat, so let's get the capabilities."
v1.6.0-windows,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.6.0-windows,subclasses remembering to call this base implementation.
v1.6.0-windows,stop listening to the connection.
v1.6.0-windows,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.6.0-windows,wait for a heartbeat msg since this will give us the port to send commands to...
v1.6.0-windows,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.6.0-windows,send a heart beat so that the remote node knows we are still alive
v1.6.0-windows,(otherwise drone will trigger a failsafe operation).
v1.6.0-windows,ignore any failures here because we are running in our own thread here.
v1.6.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.6.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.6.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.6.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.6.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.6.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.6.0-windows,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.6.0-windows,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.6.0-windows,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.6.0-windows,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.6.0-windows,"ok, now fetch the missing parameters."
v1.6.0-windows,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.6.0-windows,silently fail since we are on a background thread here...
v1.6.0-windows,tell the caller this is complete.
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,add our custom telemetry message length.
v1.6.0-windows,todo: if we support signing then initialize
v1.6.0-windows,mavlink_intermediate_status_.signing callbacks
v1.6.0-windows,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.6.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.6.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.6.0-windows,send this right away just in case serial link is not already configured
v1.6.0-windows,"log every message that is ""sent"" using sendMessage."
v1.6.0-windows,"log every message that is ""sent"" using sendMessage."
v1.6.0-windows,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.6.0-windows,pack the payload buffer.
v1.6.0-windows,calculate checksum
v1.6.0-windows,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.6.0-windows,are variable length as a result.
v1.6.0-windows,form the header as a byte array for the crc
v1.6.0-windows,these macros use old style cast.
v1.6.0-windows,forward messages from our connected node to the remote proxy.
v1.6.0-windows,tell the remote connection to expect mavlink2 messages.
v1.6.0-windows,forward messages from remote proxy to local connected node
v1.6.0-windows,CurrentThread::setMaximumPriority();
v1.6.0-windows,"hmmm, wait till it is opened?"
v1.6.0-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.6.0-windows,pick up the sysid/compid of the remote node we are connected to.
v1.6.0-windows,then this is a mavlink 1 message
v1.6.0-windows,then this mavlink sender supports mavlink 2
v1.6.0-windows,queue event for publishing.
v1.6.0-windows,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.6.0-windows,as it ensures we don't lose messages if the listener is slow.
v1.6.0-windows,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.6.0-windows,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.6.0-windows,we would get a deadlock.
v1.6.0-windows,CurrentThread::setMaximumPriority();
v1.6.0-windows,reset counters
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,------------------------------------------------------------------------------
v1.6.0-windows,Defines
v1.6.0-windows,------------------------------------------------------------------------------
v1.6.0-windows,bit number  876543210987654321
v1.6.0-windows,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.6.0-windows,in future it would be good to have ability to add system IDs we are interested in
v1.6.0-windows,if (msg.sysid != getTargetSystemId())
v1.6.0-windows,{
v1.6.0-windows,// we only care about messages from our intended remote node.
v1.6.0-windows,return;
v1.6.0-windows,}
v1.6.0-windows,user may have changed modes on us! So we need to honor that and not
v1.6.0-windows,try and take it back.
v1.6.0-windows,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.6.0-windows,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.6.0-windows,we can store up to 16 channels in rc_channels_scaled.
v1.6.0-windows,The RAW values of the servo outputs
v1.6.0-windows,Metrics typically displayed on a HUD for fixed wing aircraft
v1.6.0-windows,The IMU readings in SI units in NED body frame
v1.6.0-windows,printSystemStatus(&msg);
v1.6.0-windows,todo: use this to determine when we need to do emergency landing...
v1.6.0-windows,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.6.0-windows,Provides state for additional features
v1.6.0-windows,The general system state
v1.6.0-windows,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.6.0-windows,but we do want to know when we get the ack.  So this is async ACK processing!
v1.6.0-windows,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.6.0-windows,if threshold < 0 then the threshold is inverted.
v1.6.0-windows,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.6.0-windows,Convert it to a floating point number between -1 and 1.
v1.6.0-windows,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.6.0-windows,until the move commands start happening.
v1.6.0-windows,return true if user calls requestControl and has not called releaseControl.
v1.6.0-windows,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.6.0-windows,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.6.0-windows,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.6.0-windows,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.6.0-windows,send a few to make sure it gets through...
v1.6.0-windows,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.6.0-windows,us by which time the PX4 times out offboard mode!!
v1.6.0-windows,"assume this was successful, we'll find out if so in the next heartbeat."
v1.6.0-windows,this mode change take precedence over offboard mode.
v1.6.0-windows,thrust must be between -1 and 1.
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,These definitions are copied from PX4 implementation
v1.6.0-windows,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.6.0-windows,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.6.0-windows,/ @brief Command opcodes
v1.6.0-windows,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.6.0-windows,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.6.0-windows,must trim trailing slashes so PX4 doesn't hang!
v1.6.0-windows,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.6.0-windows,from the source.
v1.6.0-windows,check if directory exists.
v1.6.0-windows,perfect.
v1.6.0-windows,use last_message_ so we preserve the sessionid.
v1.6.0-windows,"could not create the local file, so stop."
v1.6.0-windows,must use last_message_ so we preserve the session id.
v1.6.0-windows,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.6.0-windows,todo: error handling here? sequence is out of order...
v1.6.0-windows,"directory must be empty then, can't do nextStep because"
v1.6.0-windows,it will just loop for ever re-requesting zero offset into
v1.6.0-windows,empty directory.
v1.6.0-windows,result should be a list of null terminated file names.
v1.6.0-windows,skipping this entry
v1.6.0-windows,remove the file size field.
v1.6.0-windows,"printf(""%s\n"", name.c_str());"
v1.6.0-windows,request the next batch.
v1.6.0-windows,"perhaps this was a late response after we did a retry, so ignore it."
v1.6.0-windows,"perhaps this was a late response after we did a retry, so ignore it."
v1.6.0-windows,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.6.0-windows,reached the end of the list or the file.
v1.6.0-windows,end of file or directory listing.
v1.6.0-windows,"success, data should be following..."
v1.6.0-windows,ack on this cmd is a noop
v1.6.0-windows,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.6.0-windows,give up then.
v1.6.0-windows,tell watchdog we are sending a request
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,================================= CLIENT ==============================================================
v1.6.0-windows,Check if we have a valid transaction
v1.6.0-windows,emit signal if all packets arrived
v1.6.0-windows,Restart statemachine
v1.6.0-windows,image APIs
v1.6.0-windows,================================= SERVER ==============================================================
v1.6.0-windows,Prepare and send acknowledgment packet
v1.6.0-windows,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.6.0-windows,Send ENCAPSULATED_IMAGE packet
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.6.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.6.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.6.0-windows,send this right away just in case serial link is not already configured
v1.6.0-windows,CurrentThread::setMaximumPriority();
v1.6.0-windows,"hmmm, wait till it is opened?"
v1.6.0-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.6.0-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.6.0-windows,queue event for publishing.
v1.6.0-windows,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.6.0-windows,as it ensures we don't lose messages if the listener is slow.
v1.6.0-windows,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.6.0-windows,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.6.0-windows,we would get a deadlock.
v1.6.0-windows,CurrentThread::setMaximumPriority();
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.6.0-windows,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.6.0-windows,parse out the VID number
v1.6.0-windows,now the PID
v1.6.0-windows,parse out the VID number
v1.6.0-windows,examples:
v1.6.0-windows,PX4: USB\VID_26AC&PID_0011\0
v1.6.0-windows,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.6.0-windows,"printf(""Found: %S\n"", buffer.c_str());"
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.6.0-windows,parse out the VID number
v1.6.0-windows,now the PID
v1.6.0-windows,parse out the VID number
v1.6.0-windows,suppress
v1.6.0-windows,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,This has not been properly tested
v1.6.0-windows,struct iw_statistics stats;
v1.6.0-windows,struct iwreq req;
v1.6.0-windows,"memset(&stats, 0, sizeof(stats));"
v1.6.0-windows,"memset(&req, 0, sizeof(iwreq));"
v1.6.0-windows,
v1.6.0-windows,"strncpy(req.ifr_name, ifaceName, 16);"
v1.6.0-windows,req.u.data.pointer = &stats;
v1.6.0-windows,req.u.data.length = sizeof(iw_statistics);
v1.6.0-windows,
v1.6.0-windows,#ifdef CLEAR_UPDATED
v1.6.0-windows,req.u.data.flags = 1;
v1.6.0-windows,#endif
v1.6.0-windows,
v1.6.0-windows,/* Perform the ioctl */
v1.6.0-windows,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.6.0-windows,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.6.0-windows,return -127;
v1.6.0-windows,}
v1.6.0-windows,
v1.6.0-windows,return stats.qual.level;
v1.6.0-windows,todo: windows version of this...
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,windows
v1.6.0-windows,Need to link with Ws2_32.lib
v1.6.0-windows,posix
v1.6.0-windows,found it!
v1.6.0-windows,This timeout is important as it allows the MavLinkConnection readPackets
v1.6.0-windows,thread to iterate and notice the connection is now closed. This allows
v1.6.0-windows,AirSim to shutdown properly when drone is not connected.
v1.6.0-windows,bind socket to local address.
v1.6.0-windows,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.6.0-windows,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.6.0-windows,try and reconnect
v1.6.0-windows,write to the serial port
v1.6.0-windows,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.6.0-windows,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.6.0-windows,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.6.0-windows,"try and receive something, up until port is closed anyway."
v1.6.0-windows,"message was too large for the buffer, no problem, return what we have."
v1.6.0-windows,try again - this can happen if server recreates the socket on their side.
v1.6.0-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.6.0-windows,"skip this, the receive just timed out, no problem, we'll try again later."
v1.6.0-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.6.0-windows,"printf(""#### recv failed with error: %d\n"", hr);"
v1.6.0-windows,we now have it.
v1.6.0-windows,this is from someone we are not interested in.
v1.6.0-windows,-----------------------------------------------------------------------------------------
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,Initialize Winsock
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,windows
v1.6.0-windows,Need to link with Ws2_32.lib
v1.6.0-windows,posix
v1.6.0-windows,found it!
v1.6.0-windows,bind socket to local address.
v1.6.0-windows,bind socket to local address.
v1.6.0-windows,start listening for incoming connection
v1.6.0-windows,accept 1
v1.6.0-windows,"don't need to accept any more, so we can close this one."
v1.6.0-windows,write to the serial port
v1.6.0-windows,"try and receive something, up until port is closed anyway."
v1.6.0-windows,"message was too large for the buffer, no problem, return what we have."
v1.6.0-windows,try again - this can happen if server recreates the socket on their side.
v1.6.0-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.6.0-windows,try again - this can happen if server recreates the socket on their side.
v1.6.0-windows,-----------------------------------------------------------------------------------------
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.6.0-windows,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.6.0-windows,set signal
v1.6.0-windows,Clear Handshake flags
v1.6.0-windows,Set Handshake flags
v1.6.0-windows,return GetLastError();
v1.6.0-windows,return GetLastError();
v1.6.0-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.6.0-windows,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.6.0-windows,enable reading
v1.6.0-windows,posix doesn't have mark/space parity.
v1.6.0-windows,posix doesn't have mark/space parity.
v1.6.0-windows,this is the default.
v1.6.0-windows,not sure this is supported...
v1.6.0-windows,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.6.0-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.6.0-windows,First do those specified by POSIX.
v1.6.0-windows,Now conditionally handle a bunch of extended rates.
v1.6.0-windows,First do those specified by POSIX.
v1.6.0-windows,Now conditionally handle a bunch of extended rates.
v1.6.0-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.6.0-windows,import airsim
v1.6.0-windows,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v1.6.0-windows,self.args = args
v1.6.0-windows,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v1.6.0-windows,pdb.set_trace()
v1.6.0-windows,#include <pluginlib/class_list_macros.h>
v1.6.0-windows,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v1.6.0-windows,todo do not reset if already in air?
v1.6.0-windows,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.6.0-windows,ros params
v1.6.0-windows,todo enforce dynamics constraints in this node as well?
v1.6.0-windows,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v1.6.0-windows,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v1.6.0-windows,XmlRpc::XmlRpcValue can't be const in this case
v1.6.0-windows,subscribe to control commands on global nodehandle
v1.6.0-windows,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.6.0-windows,bind to a single callback. todo optimal subs queue length
v1.6.0-windows,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.6.0-windows,"vehicle_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.6.0-windows,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.6.0-windows,camera_setting.gimbal
v1.6.0-windows,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.6.0-windows,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.6.0-windows,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.6.0-windows,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.6.0-windows,"if {DepthPlanar, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.6.0-windows,"push back pair (vector of image captures, current vehicle name)"
v1.6.0-windows,iterate over sensors
v1.6.0-windows,"we want fast access to the lidar sensors for callback handling, sort them out now"
v1.6.0-windows,add takeoff and land all services if more than 2 drones
v1.6.0-windows,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v1.6.0-windows,todo add per vehicle reset in AirLib API
v1.6.0-windows,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.6.0-windows,lidars update on their own callback/thread at a given rate
v1.6.0-windows,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v1.6.0-windows,"todo: error check. if state is not landed, return error."
v1.6.0-windows,response.success =
v1.6.0-windows,response.success =
v1.6.0-windows,response.success =
v1.6.0-windows,response.success =
v1.6.0-windows,response.success =
v1.6.0-windows,response.success =
v1.6.0-windows,todo add reset by vehicle_name API to airlib
v1.6.0-windows,todo not async remove waitonlasttask
v1.6.0-windows,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v1.6.0-windows,todo do actual body frame?
v1.6.0-windows,airsim uses degrees
v1.6.0-windows,todo do actual body frame?
v1.6.0-windows,airsim uses degrees
v1.6.0-windows,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v1.6.0-windows,todo expose waitOnLastTask or nah?
v1.6.0-windows,todo do actual body frame?
v1.6.0-windows,airsim uses degrees
v1.6.0-windows,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.6.0-windows,todo expose waitOnLastTask or nah?
v1.6.0-windows,todo support multiple gimbal commands
v1.6.0-windows,todo support multiple gimbal commands
v1.6.0-windows,1. find quaternion of default gimbal pose
v1.6.0-windows,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.6.0-windows,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.6.0-windows,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.6.0-windows,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.6.0-windows,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.6.0-windows,msg = []
v1.6.0-windows,todo covariances
v1.6.0-windows,gps_msg.position_covariance_type =
v1.6.0-windows,gps_msg.position_covariance =
v1.6.0-windows,todo covariances
v1.6.0-windows,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.6.0-windows,todo radians per second
v1.6.0-windows,meters/s2^m
v1.6.0-windows,imu_msg.orientation_covariance = ;
v1.6.0-windows,imu_msg.angular_velocity_covariance = ;
v1.6.0-windows,imu_msg.linear_acceleration_covariance = ;
v1.6.0-windows,airsim appears to use chrono::system_clock with nanosecond precision
v1.6.0-windows,todo this is global origin
v1.6.0-windows,get the basic vehicle pose and environmental state
v1.6.0-windows,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.6.0-windows,airsim_client needs to provide the simulation time in a future version of the API
v1.6.0-windows,publish the simulation clock
v1.6.0-windows,"publish vehicle state, odom, and all basic sensor types"
v1.6.0-windows,send any commands out to the vehicles
v1.6.0-windows,"should be easier way to get the sim time through API, something like:"
v1.6.0-windows,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.6.0-windows,curr_ros_time = airsim_timestamp_to_ros(env.clock().nowNanos());
v1.6.0-windows,iterate over drones
v1.6.0-windows,get drone state from airsim
v1.6.0-windows,"vehicle environment, we can get ambient temperature here and other truths"
v1.6.0-windows,convert airsim drone state to ROS msgs
v1.6.0-windows,simulation environment truth
v1.6.0-windows,"dashboard reading from car, RPM, gear, etc"
v1.6.0-windows,odom and transforms
v1.6.0-windows,ground truth GPS position from sim/HITL
v1.6.0-windows,handled via callback
v1.6.0-windows,send control commands from the last callback to airsim
v1.6.0-windows,send control commands from the last callback to airsim
v1.6.0-windows,"Only camera rotation, no translation movement of camera"
v1.6.0-windows,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.6.0-windows,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.6.0-windows,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.6.0-windows,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.6.0-windows,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.6.0-windows,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.6.0-windows,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.6.0-windows,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.6.0-windows,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.6.0-windows,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.6.0-windows,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.6.0-windows,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.6.0-windows,update timestamp of saved cam info msgs
v1.6.0-windows,DepthPlanar / DepthPerspective / DepthVis / DisparityNormalized
v1.6.0-windows,Scene / Segmentation / SurfaceNormals / Infrared
v1.6.0-windows,publish camera transforms
v1.6.0-windows,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.6.0-windows,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.6.0-windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.6.0-windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.6.0-windows,ROS params
v1.6.0-windows,ROS publishers
v1.6.0-windows,ROS subscribers
v1.6.0-windows,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.6.0-windows,ROS timers
v1.6.0-windows,todo maintain internal representation as eigen vec?
v1.6.0-windows,todo check if low velocity if within thresh?
v1.6.0-windows,todo maintain separate errors for XY and Z
v1.6.0-windows,todo save this in degrees somewhere to avoid repeated conversion
v1.6.0-windows,this tells the update timer callback to not do active hovering
v1.6.0-windows,todo maintain array of position goals
v1.6.0-windows,todo error checks
v1.6.0-windows,todo fill response
v1.6.0-windows,"Already have goal, and have reached it"
v1.6.0-windows,this tells the update timer callback to not do active hovering
v1.6.0-windows,todo error checks
v1.6.0-windows,todo fill response
v1.6.0-windows,"todo do relative altitude, or add an option for the same?"
v1.6.0-windows,convert GPS goal to NED goal
v1.6.0-windows,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.6.0-windows,todo error checks
v1.6.0-windows,todo fill response
v1.6.0-windows,"Already have goal, this shouldn't happen"
v1.6.0-windows,"todo do relative altitude, or add an option for the same?"
v1.6.0-windows,convert GPS goal to NED goal
v1.6.0-windows,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.6.0-windows,todo error checks
v1.6.0-windows,todo fill response
v1.6.0-windows,todo check if odometry is too old!!
v1.6.0-windows,"if no odom, don't do anything."
v1.6.0-windows,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.6.0-windows,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.6.0-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.6.0-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.6.0-windows,todo yaw limits
v1.6.0-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.6.0-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.6.0-windows,mimics void ASimHUD::initializeSettings()
v1.6.0-windows,int num_threads = 1;
v1.6.0-windows,ros::MultiThreadedSpinner multi_thread(num_threads);
v1.6.0-windows,multi_thread.spin();
v1.6.0-windows,ros::AsyncSpinner async_spinner(num_threads);
v1.6.0-windows,async_spinner.start();
v1.6.0-windows,single threaded spinner
v1.6.0-windows,connect to the AirSim simulator
v1.6.0-windows,","
v1.6.0-windows,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.6.0-windows,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,"in header only mode, control library is not available"
v1.6.0-windows,TODO: something defines max macro which interfears with code here
v1.6.0-windows,is cur_pos within fence?
v1.6.0-windows,destination risk is not available then consider it zero
v1.6.0-windows,if dest risk is lower than its more safe
v1.6.0-windows,are we doing better than closest obstacle?
v1.6.0-windows,"if we stay where we are, what is the risk distance?"
v1.6.0-windows,else we are better of moving to dest
v1.6.0-windows,this function should work even when dest_pos == cur_pos
v1.6.0-windows,is this dest_pos cur_pos within the fence?
v1.6.0-windows,transform dest_pos vector to body frame
v1.6.0-windows,check for approx zero vectors to avoid random yaw angles
v1.6.0-windows,we are hovering
v1.6.0-windows,"get yaw in body frame, ie, front is always 0 radians"
v1.6.0-windows,yaw to ticks
v1.6.0-windows,get obstacles in the window at the tick direction around the window
v1.6.0-windows,less risk distance is better
v1.6.0-windows,check obstacles around current position and see if it has lower risk
v1.6.0-windows,else obstacle is too far
v1.6.0-windows,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.6.0-windows,look for each surrounding tick to see if we have obstacle free angle
v1.6.0-windows,else no suggestions required
v1.6.0-windows,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.6.0-windows,evaluate right and left side of circle
v1.6.0-windows,find right and left risk distances
v1.6.0-windows,at this point we have already determined hover is better than going to dest
v1.6.0-windows,we now determine is moving to suggested angle better than hovering?
v1.6.0-windows,check if dest_pos is safe
v1.6.0-windows,breaking distance at this velocity
v1.6.0-windows,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.6.0-windows,check if dest_pos is safe
v1.6.0-windows,float/vec parameters can have NaN which makes them optional
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,"in header only mode, control library is not available"
v1.6.0-windows,handles +/- tick and wraps around circle
v1.6.0-windows,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.6.0-windows,update the specified window on the map
v1.6.0-windows,make sure from <= to
v1.6.0-windows,normalize the ticks so both are valid indices
v1.6.0-windows,if from is still larger then
v1.6.0-windows,to ticks is then added one full circle to make it larger than from_tick
v1.6.0-windows,find closest obstacle in given window
v1.6.0-windows,search whole map to find closest obstacle
v1.6.0-windows,"in header only mode, control library is not available"
v1.6.0-windows,#include <fileapi.h>
v1.6.0-windows,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.6.0-windows,"Windows, OSX and Linux."
v1.6.0-windows,Windows users can move the Documents folder to any location they want
v1.6.0-windows,SHGetFolderPath knows how to find it.
v1.6.0-windows,fall back in case SHGetFolderPath failed for some reason.
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,"in header only mode, control library is not available"
v1.6.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.6.0-windows,if using Unreal Build system then include precompiled header file first
v1.6.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.6.0-windows,this deadlocks UI thread if async_run was called while there are pending rpc calls.
v1.6.0-windows,Exit if already resetting.
v1.6.0-windows,Reset
v1.6.0-windows,if we don't suppress then server will bomb out for exceptions raised by any method
v1.6.0-windows,required for pimpl
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,"in header only mode, control library is not available"
v1.6.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.6.0-windows,if using Unreal Build system then include precompiled header file first
v1.6.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.6.0-windows,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.6.0-windows,make sure we can talk to the DroneServer
v1.6.0-windows,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.6.0-windows,command_context.client.ping();
v1.6.0-windows,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.6.0-windows,sim only
v1.6.0-windows,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.6.0-windows,"Minor TODO: consider msgpack magic for GeoPoint, so we can have one arg instead of three"
v1.6.0-windows,Convert
v1.6.0-windows,return value of last task. It should be true if task completed without
v1.6.0-windows,cancellation or timeout
v1.6.0-windows,"should be implemented by derived class if it supports async task,"
v1.6.0-windows,for example using futures
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,"in header only mode, control library is not available"
v1.6.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.6.0-windows,if using Unreal Build system then include precompiled header file first
v1.6.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,"in header only mode, control library is not available"
v1.6.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.6.0-windows,if using Unreal Build system then include precompiled header file first
v1.6.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.6.0-windows,required for pimpl
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,"in header only mode, control library is not available"
v1.6.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.6.0-windows,if using Unreal Build system then include precompiled header file first
v1.6.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.6.0-windows,status getters
v1.6.0-windows,Rotor state getter
v1.6.0-windows,Multirotor state getter
v1.6.0-windows,return value of last task. It should be true if task completed without
v1.6.0-windows,cancellation or timeout
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,"in header only mode, control library is not available"
v1.6.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.6.0-windows,if using Unreal Build system then include pre-compiled header file first
v1.6.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.6.0-windows,getters
v1.6.0-windows,Rotor state
v1.6.0-windows,Multirotor state
v1.6.0-windows,required for pimpl
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,"in header only mode, control library is not available"
v1.6.0-windows,last command is to hold on to position
v1.6.0-windows,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.6.0-windows,after landing we detect if drone has stopped moving
v1.6.0-windows,validate path size
v1.6.0-windows,validate yaw mode
v1.6.0-windows,validate and set auto-lookahead value
v1.6.0-windows,if auto mode requested for lookahead then calculate based on velocity
v1.6.0-windows,add current position as starting point
v1.6.0-windows,append the input path and compute segments
v1.6.0-windows,add last segment as zero length segment so we have equal number of segments and points.
v1.6.0-windows,path_segs[i] refers to segment that starts at point i
v1.6.0-windows,"when path ends, we want to slow down"
v1.6.0-windows,else no need to change velocities for last segments
v1.6.0-windows,setup current position on path to 0 offset
v1.6.0-windows,initialize next path position
v1.6.0-windows,until we are at the end of the path (last seg is always zero size)
v1.6.0-windows,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.6.0-windows,send drone command to get to next lookahead
v1.6.0-windows,sleep for rest of the cycle
v1.6.0-windows,how much have we moved towards last goal?
v1.6.0-windows,project actual vector on goal vector
v1.6.0-windows,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.6.0-windows,TODO: below should be lower than 1E3 and configurable
v1.6.0-windows,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.6.0-windows,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.6.0-windows,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.6.0-windows,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.6.0-windows,"if drone moved backward, we don't want goal to move backward as well"
v1.6.0-windows,"so only climb forward on the path, never back. Also note >= which means"
v1.6.0-windows,we climb path even if distance was 0 to take care of duplicated points on path
v1.6.0-windows,else
v1.6.0-windows,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.6.0-windows,compute next target on path
v1.6.0-windows,freeze the quaternion
v1.6.0-windows,convert RC commands to velocity vector
v1.6.0-windows,find yaw as per terrain and remote setting
v1.6.0-windows,execute command
v1.6.0-windows,if timeout occurred then command completed successfully otherwise it was interrupted
v1.6.0-windows,yaw is not within margin
v1.6.0-windows,by default we say that this command is not supported
v1.6.0-windows,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.6.0-windows,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.6.0-windows,get trims
v1.6.0-windows,take average
v1.6.0-windows,validate dest
v1.6.0-windows,what is the distance we will travel at this velocity?
v1.6.0-windows,get velocity vector
v1.6.0-windows,yaw for the direction of travel
v1.6.0-windows,find velocity vector
v1.6.0-windows,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.6.0-windows,generate velocity vector that is same size as cur_dest_norm / command period
v1.6.0-windows,this velocity vect when executed for command period would yield cur_dest_norm
v1.6.0-windows,send commands
v1.6.0-windows,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.6.0-windows,default strategy is for move. In hover mode we set new strategy temporarily
v1.6.0-windows,are we supposed to do EM?
v1.6.0-windows,get suggested velocity vector
v1.6.0-windows,use the unchecked command
v1.6.0-windows,tell caller not to execute planned command
v1.6.0-windows,other wise throw exception
v1.6.0-windows,otherwise there is some other reason why we are in unsafe situation
v1.6.0-windows,send last command to come to full stop
v1.6.0-windows,else no unsafe situation
v1.6.0-windows,note: cur_path_loc and next_path_loc may both point to same object
v1.6.0-windows,"otherwise use up this segment, move on to next one"
v1.6.0-windows,if we are here then we ran out of segments
v1.6.0-windows,consider last segment as zero length segment
v1.6.0-windows,adjust yaw for the direction of travel in forward-only mode
v1.6.0-windows,else no adjustment needed
v1.6.0-windows,if auto mode requested for lookahead then calculate based on velocity
v1.6.0-windows,Create a spring arm component for our chase camera
v1.6.0-windows,"do nothing, spring arm is pulling the camera with it"
v1.6.0-windows,"do nothing, we have camera turned off"
v1.6.0-windows,set initial view mode
v1.6.0-windows,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.6.0-windows,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.6.0-windows,"If the lag is missing, the camera will also occasionally shake."
v1.6.0-windows,"But, lag is not desired when piloting a drone"
v1.6.0-windows,attach spring arm to actor
v1.6.0-windows,remember current parent for external camera. Later when we remove external
v1.6.0-windows,"camera from spring arm, we will attach it back to its last parent"
v1.6.0-windows,now attach camera to spring arm
v1.6.0-windows,"For car, we need to move the camera back a little more than for a drone."
v1.6.0-windows,"Otherwise, the camera will be stuck inside the car"
v1.6.0-windows,ExternalCamera->bUsePawnControlRotation = false;
v1.6.0-windows,detach spring arm
v1.6.0-windows,Re-enable rendering
v1.6.0-windows,Remove any existing key bindings for manual mode
v1.6.0-windows,"else someone else is bound to manual pose controller, leave it alone"
v1.6.0-windows,if new mode is manual mode then add key bindings
v1.6.0-windows,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.6.0-windows,other modes don't need special setup
v1.6.0-windows,make switch official
v1.6.0-windows,Add loading screen to viewport
v1.6.0-windows,Remove Loading screen from viewport
v1.6.0-windows,Create struct for Location and Rotation of actor in Unreal
v1.6.0-windows,new_actor_spawn_params.NameMode = FActorSpawnParameters::ESpawnActorNameMode::Required_ReturnNull;
v1.6.0-windows,Write the binvox file using run-length encoding
v1.6.0-windows,"where each pair of bytes is of the format (run value, run length)"
v1.6.0-windows,This is a run (repeated bit value)
v1.6.0-windows,End of a run
v1.6.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.6.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.6.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.6.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.6.0-windows,Split the tag string into individual tags.
v1.6.0-windows,Texture swap on actors that have all of those tags.
v1.6.0-windows,----------- Plotting APIs ----------/
v1.6.0-windows,"plot line for points 0-1, 1-2, 2-3"
v1.6.0-windows,"plot line for points 0-1, 2-3, 4-5... must be even number of points"
v1.6.0-windows,assert points_start.size() == poinst_end.size()
v1.6.0-windows,assert positions.size() == strings.size()
v1.6.0-windows,assert poses.size() == names.size()
v1.6.0-windows,Recording APIs
v1.6.0-windows,"Remove '' from the list, representing default vehicle"
v1.6.0-windows,"We need to run this code on the main game thread, since it iterates over actors"
v1.6.0-windows,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.6.0-windows,"No LOS, so draw red line"
v1.6.0-windows,"Yes LOS, so draw green line"
v1.6.0-windows,"We need to run this code on the main game thread, since it iterates over actors"
v1.6.0-windows,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.6.0-windows,Testing actor enum for world bounds...
v1.6.0-windows,"Same as with the Object Iterator, access the subclass instance with the * or -> operators."
v1.6.0-windows,"TODO think more about how best to determine/indicate ground level, if anyone cares"
v1.6.0-windows,Convert Uvectors to LLAs
v1.6.0-windows,Fill out your copyright notice in the Description page of Project Settings.
v1.6.0-windows,"Set this component to be initialized when the game starts, and to be ticked every frame.  You can turn these features"
v1.6.0-windows,off to improve performance if you don't need them.
v1.6.0-windows,get render target for texture size
v1.6.0-windows,initialize viewinfo for projection matrix
v1.6.0-windows,calculate 3D corner Points of bounding box
v1.6.0-windows,initialize pixel values
v1.6.0-windows,initialize projection data for sceneview
v1.6.0-windows,do some voodoo rotation that is somehow mandatory and stolen from UGameplayStatics::ProjectWorldToScreen
v1.6.0-windows,Project Points to pixels and get the corner pixels
v1.6.0-windows,If actor in camera view - check if it's actually visible or hidden
v1.6.0-windows,Check against 8 extend points
v1.6.0-windows,"If actor in camera view but didn't hit any point out of 8 extend points,"
v1.6.0-windows,check against 10 random points
v1.6.0-windows,by default all image types are disabled
v1.6.0-windows,use final color for all calculations
v1.6.0-windows,TODO: avoid the need to override const cast here
v1.6.0-windows,if the viewport is taller than it is wide
v1.6.0-windows,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v1.6.0-windows,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v1.6.0-windows,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v1.6.0-windows,use final color for all calculations
v1.6.0-windows,TODO: should we be ignoring position and orientation settings here?
v1.6.0-windows,TODO: can we eliminate storing NedTransform?
v1.6.0-windows,if (!std::isnan(setting.target_gamma))
v1.6.0-windows,camera-> = setting.target_gamma;
v1.6.0-windows,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.6.0-windows,else nothing to enable
v1.6.0-windows,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.6.0-windows,if (controller && controller->GetViewTarget() == this)
v1.6.0-windows,controller->SetViewTarget(nullptr);
v1.6.0-windows,"Check whether requested map exists, this could be very slow if LevelName is a short package name"
v1.6.0-windows,Create Unique Name for sub-level package
v1.6.0-windows,Setup streaming level object that will load specified map
v1.6.0-windows,Transform
v1.6.0-windows,Map to Load
v1.6.0-windows,Add the new level to world.
v1.6.0-windows,TODO: explore screenshot option
v1.6.0-windows,addScreenCaptureHandler(camera->GetWorld());
v1.6.0-windows,TODO: may be we should have these methods non-const?
v1.6.0-windows,We don't do game/render thread synchronization for safe method.
v1.6.0-windows,We just blindly sleep for 200ms (the old way)
v1.6.0-windows,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.6.0-windows,Make sure that all alpha values are opaque.
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,TODO: change naming conventions to same as other files?
v1.6.0-windows,"context->GetWorld()->SetNewWorldOrigin(FIntVector(0, 0, 0));"
v1.6.0-windows,Enable/disable primary viewport rendering flag
v1.6.0-windows,This disables rendering of the main viewport in the same way as the
v1.6.0-windows,"console command ""show rendering"" would do."
v1.6.0-windows,"When getting an image through the API, the image is produced after the render"
v1.6.0-windows,thread has finished rendering the current and the subsequent frame. This means
v1.6.0-windows,that the frame rate for obtaining images through the API is only half as high as
v1.6.0-windows,"it could be, since only every other image is actually captured. We work around"
v1.6.0-windows,this by telling the viewport to flush the rendering queue at the end of each
v1.6.0-windows,drawn frame so that it executes our render request at that point already.
v1.6.0-windows,Do this only if the main viewport is not being rendered anyway in case there are
v1.6.0-windows,any adverse performance effects during main rendering.
v1.6.0-windows,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v1.6.0-windows,nothing to do for now
v1.6.0-windows,"if hidden, clear any existing messages"
v1.6.0-windows,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.6.0-windows,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.6.0-windows,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.6.0-windows,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.6.0-windows,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.6.0-windows,Find mesh in /Game and /AirSim asset registry. When more plugins are added this function will have to change
v1.6.0-windows,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.6.0-windows,{
v1.6.0-windows,InitializeObjectStencilID(*comp);
v1.6.0-windows,}
v1.6.0-windows,"Takes a UStaticMeshComponent, USkinnedMeshComponent or ALandscapeProxy and returns their custom stencil ID if"
v1.6.0-windows,their meshes's name or their owner's name (depending on the naming method in mesh_naming_method_) equals mesh_name
v1.6.0-windows,"The skybox is ignored here as it is huge, and really is of no use to the end user typically. Also the associated meshes with the cameras"
v1.6.0-windows,Various checks if there is even a valid mesh
v1.6.0-windows,Need to force the render command to go through cause on the next iteration the buffer no longer exists
v1.6.0-windows,Unreal stores more vertices than triangles. So here we find the highest referenced vertex and ignore any after that
v1.6.0-windows,can we see followee?
v1.6.0-windows,remove mapping
v1.6.0-windows,removing binding
v1.6.0-windows,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.6.0-windows,"some point. At the moment, manually swapping Red and Blue"
v1.6.0-windows,Copy scaled image into destination thumb
v1.6.0-windows,Compress data - convert into a .png
v1.6.0-windows,if we already have attached actor
v1.6.0-windows,Fill out your copyright notice in the Description page of Project Settings.
v1.6.0-windows,Check pointer equality first for performance
v1.6.0-windows,"KeyHash = HashCombine(KeyHash, GetTypeHash(Key.WildcardMeshNames));"
v1.6.0-windows,#ifdef _MSC_VER
v1.6.0-windows,//print to VS output window
v1.6.0-windows,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.6.0-windows,#endif
v1.6.0-windows,also do default logging
v1.6.0-windows,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.6.0-windows,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.6.0-windows,{
v1.6.0-windows,if (GEngine != nullptr)
v1.6.0-windows,{
v1.6.0-windows,return GEngine->GameUserSettings;
v1.6.0-windows,}
v1.6.0-windows,return nullptr;
v1.6.0-windows,}
v1.6.0-windows,UGameUserSettings* game_settings = GetGameUserSettings();
v1.6.0-windows,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.6.0-windows,game_settings->ApplySettings(true);
v1.6.0-windows,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.6.0-windows,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.6.0-windows,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.6.0-windows,todo unused. need to manually plots tf axes' line in right handed FLU instead of using DrawDebugCoordinateSystem
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,plugin startup
v1.6.0-windows,plugin shutdown
v1.6.0-windows,initialize state
v1.6.0-windows,add listener for pawn's collision event
v1.6.0-windows,compute our home point
v1.6.0-windows,default behavior is to call update every tick
v1.6.0-windows,"for custom physics engine, this method should be overridden and update should be"
v1.6.0-windows,called from every physics tick
v1.6.0-windows,add cameras that already exists in pawn
v1.6.0-windows,create or replace cameras specified in settings
v1.6.0-windows,setup individual cameras
v1.6.0-windows,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.6.0-windows,for each camera in settings
v1.6.0-windows,get pose
v1.6.0-windows,spawn and attach camera to pawn
v1.6.0-windows,add on to our collection
v1.6.0-windows,Deflect along the surface when we collide.
v1.6.0-windows,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.6.0-windows,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.6.0-windows,-1 to 1 --> 0 to 1
v1.6.0-windows,-1 to 1
v1.6.0-windows,these will be available for devices like steering wheels
v1.6.0-windows,switch index 0 to 7 for FrSky Taranis RC is:
v1.6.0-windows,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.6.0-windows,TODO: should below be at controller level info?
v1.6.0-windows,else don't waste time
v1.6.0-windows,"We need to run this code on the main game thread, since it iterates over actors"
v1.6.0-windows,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.6.0-windows,Transform from LLA to NED
v1.6.0-windows,KM911 remove logging
v1.6.0-windows,"common_utils::Utils::log(""NED from LLA: "" + std::to_string(target_location.X) + "", "" + std::to_string(target_location.Y) + "", "" + std::to_string(target_location.Z), common_utils::Utils::kLogLevelInfo);"
v1.6.0-windows,"No LOS, so draw red line"
v1.6.0-windows,"Yes LOS, so draw green line"
v1.6.0-windows,sync environment from kinematics
v1.6.0-windows,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.6.0-windows,void playBack()
v1.6.0-windows,{
v1.6.0-windows,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.6.0-windows,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.6.0-windows,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.6.0-windows,}
v1.6.0-windows,TODO: refactor below code used for playback
v1.6.0-windows,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.6.0-windows,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.6.0-windows,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.6.0-windows,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.6.0-windows,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.6.0-windows,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.6.0-windows,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.6.0-windows,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.6.0-windows,}
v1.6.0-windows,parameters in NED frame
v1.6.0-windows,translate to new PawnSimApi position & orientation from NED to NEU
v1.6.0-windows,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.6.0-windows,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.6.0-windows,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.6.0-windows,checked at the start of next tick
v1.6.0-windows,allow teleportation
v1.6.0-windows,if collisions are not enabled
v1.6.0-windows,or we have collided but passthrough is enabled
v1.6.0-windows,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.6.0-windows,"without flip flopping, collisions can't be detected"
v1.6.0-windows,update kinematics from pawn's movement instead of physics engine
v1.6.0-windows,by default we update kinematics from UE pawn
v1.6.0-windows,if SimMod uses its own physics engine then this should be overriden
v1.6.0-windows,no default action in this base class
v1.6.0-windows,"read pixels from render target using render thread, then compress the result into PNG"
v1.6.0-windows,argument on the thread that calls this method.
v1.6.0-windows,TODO: is below really needed?
v1.6.0-windows,make sure we are not on the rendering thread
v1.6.0-windows,TODO: below doesn't work right now because it must be running in game thread
v1.6.0-windows,below is documented method but more expensive because it forces flush
v1.6.0-windows,wait for render thread to pick up our task
v1.6.0-windows,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.6.0-windows,capture CameraPose for this frame
v1.6.0-windows,The completion is called immeidately after GameThread sends the
v1.6.0-windows,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.6.0-windows,execute *immediately* after RenderThread renders the scene!
v1.6.0-windows,"while we're still on GameThread, enqueue request for capture the scene!"
v1.6.0-windows,wait for this task to complete
v1.6.0-windows,log a message and continue wait
v1.6.0-windows,lamda function still references a few objects for which there is no refcount.
v1.6.0-windows,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.6.0-windows,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.6.0-windows,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.6.0-windows,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.6.0-windows,Fill out your copyright notice in the Description page of Project Settings.
v1.6.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.6.0-windows,UWorld* World = GetWorld();
v1.6.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.6.0-windows,still need the menu class for f10
v1.6.0-windows,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v1.6.0-windows,showWeatherMenu(WorldContextObject);
v1.6.0-windows,"if weather is not enabled, dont allow any weather values to be set"
v1.6.0-windows,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v1.6.0-windows,and must be set to true or false before this.
v1.6.0-windows,WeatherEnabled will always be false
v1.6.0-windows,"NOTE: weather enabled must be set first, before other params for this to work"
v1.6.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.6.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.6.0-windows,"get all menu actors, if any"
v1.6.0-windows,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.6.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.6.0-windows,"get all menu actors, if any"
v1.6.0-windows,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.6.0-windows,"get all menu actors, if any, then hide the menu"
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,Stuff to filter out XInput devices
v1.6.0-windows,-----------------------------------------------------------------------------
v1.6.0-windows,"Defines, constants, and global variables"
v1.6.0-windows,-----------------------------------------------------------------------------
v1.6.0-windows,Magnitude ranges from -1 to 1
v1.6.0-windows,Strength ranges from 0 to 1
v1.6.0-windows,Autocenter
v1.6.0-windows,Rumble
v1.6.0-windows,Register with the DirectInput subsystem and get a pointer
v1.6.0-windows,to a IDirectInput interface we can use.
v1.6.0-windows,Create a DInput object
v1.6.0-windows,Look for a simple joystick we can use for this sample program.
v1.6.0-windows,Make sure we got a joystick
v1.6.0-windows,"Set the data format to ""simple joystick"" - a predefined data format"
v1.6.0-windows,
v1.6.0-windows,"A data format specifies which controls on a device we are interested in,"
v1.6.0-windows,and how they should be reported. This tells DInput that we will be
v1.6.0-windows,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.6.0-windows,Set the cooperative level to let DInput know how this device should
v1.6.0-windows,interact with the system and with other DInput applications.
v1.6.0-windows,Enumerate the joystick objects. The callback function enabled user
v1.6.0-windows,"interface elements for objects that are found, and sets the min/max"
v1.6.0-windows,values property for discovered axes.
v1.6.0-windows,-----------------------------------------------------------------------------
v1.6.0-windows,Enum each PNP device using WMI and check each device ID to see if it contains
v1.6.0-windows,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.6.0-windows,Unfortunately this information can not be found by just using DirectInput.
v1.6.0-windows,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.6.0-windows,XInput devices.
v1.6.0-windows,
v1.6.0-windows,This function stores the list of xinput devices in a linked list
v1.6.0-windows,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.6.0-windows,-----------------------------------------------------------------------------
v1.6.0-windows,CoInit if needed
v1.6.0-windows,Create WMI
v1.6.0-windows,Create BSTRs for WMI
v1.6.0-windows,Connect to WMI
v1.6.0-windows,Switch security level to IMPERSONATE
v1.6.0-windows,Get list of Win32_PNPEntity devices
v1.6.0-windows,Loop over all devices
v1.6.0-windows,Get 20 at a time
v1.6.0-windows,"For each device, get its device ID"
v1.6.0-windows,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.6.0-windows,Unfortunately this information can not be found by just using DirectInput
v1.6.0-windows,"If it does, then get the VID/PID from var.bstrVal"
v1.6.0-windows,Add the VID/PID to a linked list
v1.6.0-windows,-----------------------------------------------------------------------------
v1.6.0-windows,Returns true if the DirectInput device is also an XInput device.
v1.6.0-windows,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.6.0-windows,-----------------------------------------------------------------------------
v1.6.0-windows,Check each xinput device to see if this device's vid/pid matches
v1.6.0-windows,-----------------------------------------------------------------------------
v1.6.0-windows,Cleanup needed for IsXInputDevice()
v1.6.0-windows,-----------------------------------------------------------------------------
v1.6.0-windows,Cleanup linked list
v1.6.0-windows,-----------------------------------------------------------------------------
v1.6.0-windows,Name: EnumJoysticksCallback()
v1.6.0-windows,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.6.0-windows,device interface on it so we can play with it.
v1.6.0-windows,-----------------------------------------------------------------------------
v1.6.0-windows,Skip anything other than the perferred joystick device as defined by the control panel.
v1.6.0-windows,Instead you could store all the enumerated joysticks and let the user pick.
v1.6.0-windows,Obtain an interface to the enumerated joystick.
v1.6.0-windows,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.6.0-windows,it while we were in the middle of enumerating it.)
v1.6.0-windows,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.6.0-windows,could store all the enumerated joysticks and let the user pick.
v1.6.0-windows,-----------------------------------------------------------------------------
v1.6.0-windows,Name: EnumObjectsCallback()
v1.6.0-windows,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.6.0-windows,joystick. This function enables user interface elements for objects
v1.6.0-windows,"that are found to exist, and scales axes min/max values."
v1.6.0-windows,-----------------------------------------------------------------------------
v1.6.0-windows,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.6.0-windows,enumerated axis in order to scale min/max values.
v1.6.0-windows,Set the range for the axis
v1.6.0-windows,Set the UI to reflect what objects the joystick supports
v1.6.0-windows,-----------------------------------------------------------------------------
v1.6.0-windows,Name: UpdateInputState()
v1.6.0-windows,Desc: Get the input device's state and display it.
v1.6.0-windows,-----------------------------------------------------------------------------
v1.6.0-windows,Poll the device to read the current state
v1.6.0-windows,DInput is telling us that the input stream has been
v1.6.0-windows,"interrupted. We aren't tracking any state between polls, so"
v1.6.0-windows,we don't have any special reset that needs to be done. We
v1.6.0-windows,just re-acquire and try again.
v1.6.0-windows,while (hr == DIERR_INPUTLOST)
v1.6.0-windows,hr = g_pJoystick->Acquire();
v1.6.0-windows,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.6.0-windows,may occur when the app is minimized or in the process of
v1.6.0-windows,"switching, so just try again later"
v1.6.0-windows,Get the input's device state
v1.6.0-windows,Axes
v1.6.0-windows,Slider controls
v1.6.0-windows,Points of view
v1.6.0-windows,Buttons
v1.6.0-windows,-----------------------------------------------------------------------------
v1.6.0-windows,Name: FreeDirectInput()
v1.6.0-windows,Desc: Initialize the DirectInput variables.
v1.6.0-windows,-----------------------------------------------------------------------------
v1.6.0-windows,Unacquire the device one last time just in case
v1.6.0-windows,the app tried to exit while the device is still acquired.
v1.6.0-windows,Release any DirectInput objects.
v1.6.0-windows,nop
v1.6.0-windows,normalize min to max --> 0 to 1
v1.6.0-windows,normalize 0 to 1 --> -1 to 1
v1.6.0-windows,#include <libudev.h>
v1.6.0-windows,implementation for unsupported OS
v1.6.0-windows,if this is new index
v1.6.0-windows,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.6.0-windows,close previous one
v1.6.0-windows,open new device
v1.6.0-windows,if open was successful
v1.6.0-windows,read the device
v1.6.0-windows,if we didn't had valid read
v1.6.0-windows,"NOTE if this condition is not met, we're probably out of sync and this"
v1.6.0-windows,Joystick instance is likely unusable
v1.6.0-windows,TODO: set below to false?
v1.6.0-windows,state.is_valid = false;
v1.6.0-windows,else ignore
v1.6.0-windows,TODO: implement this for linux
v1.6.0-windows,TODO: implement this for linux
v1.6.0-windows,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.6.0-windows,{
v1.6.0-windows,"manufacturerID = productID = """";"
v1.6.0-windows,// Use udev to look up the product and manufacturer IDs
v1.6.0-windows,struct udev *udev = udev_new();
v1.6.0-windows,if (udev) {
v1.6.0-windows,char sysname[32];
v1.6.0-windows,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.6.0-windows,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.6.0-windows,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.6.0-windows,if (!dev)
v1.6.0-windows,{
v1.6.0-windows,"message = ""Unable to find parent USB device"";"
v1.6.0-windows,return false;
v1.6.0-windows,}
v1.6.0-windows,std::stringstream ss;
v1.6.0-windows,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.6.0-windows,ss >> manufacturerID;
v1.6.0-windows,ss.clear();
v1.6.0-windows,"ss.str("""");"
v1.6.0-windows,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.6.0-windows,ss >> productID;
v1.6.0-windows,udev_device_unref(dev);
v1.6.0-windows,}
v1.6.0-windows,else
v1.6.0-windows,{
v1.6.0-windows,"message = ""Cannot create udev"";"
v1.6.0-windows,return false;
v1.6.0-windows,}
v1.6.0-windows,udev_unref(udev);
v1.6.0-windows,return true;
v1.6.0-windows,}
v1.6.0-windows,required for pimpl
v1.6.0-windows,TODO: anyway to workaround const_cast?
v1.6.0-windows,FGenericPlatformMisc::PlatformInit();
v1.6.0-windows,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.6.0-windows,TODO: index check
v1.6.0-windows,create main widget
v1.6.0-windows,synchronize PIP views
v1.6.0-windows,TODO: should we only do below on SceneCapture2D components and cameras?
v1.6.0-windows,avoid motion blur so capture images don't get
v1.6.0-windows,use two different methods to set console var because sometime it doesn't seem to work
v1.6.0-windows,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.6.0-windows,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.6.0-windows,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.6.0-windows,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.6.0-windows,setup defaults
v1.6.0-windows,Attempts to parse the settings text from one of multiple locations.
v1.6.0-windows,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.6.0-windows,"Next, check the executable's working directory for the settings file."
v1.6.0-windows,"Finally, check the user's documents folder."
v1.6.0-windows,"If the settings file cannot be read, throw an exception"
v1.6.0-windows,Attempts to parse the settings file path or the settings text from the command line
v1.6.0-windows,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.6.0-windows,"Example (Path): AirSim.exe --settings ""C:\path\to\settings.json"""
v1.6.0-windows,"Example (Text): AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.6.0-windows,"Returns true if the argument is present, false otherwise."
v1.6.0-windows,build image file name
v1.6.0-windows,write image file
v1.6.0-windows,"Write PNG image, already compressed in binary"
v1.6.0-windows,write to CSV file
v1.6.0-windows,"Either images were saved successfully, or there were no images"
v1.6.0-windows,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.6.0-windows,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.6.0-windows,"Just need any 1 instance, to set the header line of the record file"
v1.6.0-windows,"Set is_ready at the end, setting this before can cause a race when the file isn't open yet"
v1.6.0-windows,make sure all vars are set up
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,decide which derived BP to use
v1.6.0-windows,we don't have real vehicle so no vehicle API
v1.6.0-windows,put camera little bit above vehicle
v1.6.0-windows,update ground level
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,let base class setup physics world
v1.6.0-windows,stop physics thread before we dismantle
v1.6.0-windows,setup clock in ClockFactory
v1.6.0-windows,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.6.0-windows,steppable clock returns interval that is a constant number irrespective of wall clock
v1.6.0-windows,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.6.0-windows,but that would cause vehicles like quadrotors to become unstable
v1.6.0-windows,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.6.0-windows,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.6.0-windows,get increase in clock speed
v1.6.0-windows,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.6.0-windows,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.6.0-windows,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.6.0-windows,Approach 2: scale control loop frequency if clock is speeded up
v1.6.0-windows,"for slowing down, this don't generate instability"
v1.6.0-windows,-------------------------------- overrides -----------------------------------------------//
v1.6.0-windows,decide which derived BP to use
v1.6.0-windows,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.6.0-windows,vehicle_sim_api->reset();
v1.6.0-windows,create vehicle API
v1.6.0-windows,setup physics vehicle
v1.6.0-windows,initialize private vars
v1.6.0-windows,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.6.0-windows,calls to update* are handled by physics engine and in SimModeWorldBase
v1.6.0-windows,"Utils::log(""------Render tick-------"");"
v1.6.0-windows,"if reset is pending then do it first, no need to do other things until next tick"
v1.6.0-windows,move collision info from rendering engine to vehicle
v1.6.0-windows,update rotor poses
v1.6.0-windows,update private rotor variable
v1.6.0-windows,if we did reset then don't worry about synchronizing states for this tick
v1.6.0-windows,Continue to wait for reset
v1.6.0-windows,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.6.0-windows,*** Start: UpdatableState implementation ***//
v1.6.0-windows,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.6.0-windows,environment update for current position
v1.6.0-windows,update forces on vertices
v1.6.0-windows,update to controller must be done after kinematics have been updated by physics engine
v1.6.0-windows,*** End: UpdatableState implementation ***//
v1.6.0-windows,get references of existing camera
v1.6.0-windows,setup clock in PhysX
v1.6.0-windows,-------------------------------- overrides -----------------------------------------------//
v1.6.0-windows,decide which derived BP to use
v1.6.0-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.6.0-windows,Setup suspension forces
v1.6.0-windows,Find the tire object and set the data for it
v1.6.0-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.6.0-windows,Setup suspension forces
v1.6.0-windows,Find the tire object and set the data for it
v1.6.0-windows,Create In-Car camera component
v1.6.0-windows,In car HUD
v1.6.0-windows,Create text render component for in car speed display
v1.6.0-windows,Create text render component for in car gear display
v1.6.0-windows,Setup the audio component and allocate it a sound cue
v1.6.0-windows,Colors for the in-car gear display. One for normal one for reverse
v1.6.0-windows,Wheels/Tires
v1.6.0-windows,Setup the wheels
v1.6.0-windows,Adjust the tire loading
v1.6.0-windows,Engine
v1.6.0-windows,Torque setup
v1.6.0-windows,Adjust the steering
v1.6.0-windows,Transmission
v1.6.0-windows,We want 4wd
v1.6.0-windows,Drive the front wheels a little more than the rear
v1.6.0-windows,Automatic gearbox
v1.6.0-windows,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.6.0-windows,Physics settings
v1.6.0-windows,Adjust the center of mass - the buggy is quite low
v1.6.0-windows,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.6.0-windows,put camera little bit above vehicle
v1.6.0-windows,update physics material
v1.6.0-windows,Update the strings used in the HUD (in-car and on-screen)
v1.6.0-windows,Set the string in the in-car HUD
v1.6.0-windows,Pass the engine RPM to the sound component
v1.6.0-windows,Start an engine sound playing
v1.6.0-windows,Using FText because this is display text that should be localizable
v1.6.0-windows,Setup the text render component strings
v1.6.0-windows,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.6.0-windows,below is not needed
v1.6.0-windows,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.6.0-windows,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.6.0-windows,TODO: should do reset() here?
v1.6.0-windows,create vehicle params
v1.6.0-windows,these are called on render ticks
v1.6.0-windows,TODO: do we need this for cars?
v1.6.0-windows,TODO: move this to SimModeBase?
v1.6.0-windows,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.6.0-windows,reset();
v1.6.0-windows,return;
v1.6.0-windows,}
v1.6.0-windows,Thrustmaster devices
v1.6.0-windows,"Anything else, typically Logitech G920 wheel"
v1.6.0-windows,Two steel levers behind wheel
v1.6.0-windows,if API-client control is not active then we route keyboard/joystick control to car
v1.6.0-windows,all car controls from anywhere must be routed through API component
v1.6.0-windows,*** Start: UpdatableState implementation ***//
v1.6.0-windows,physics tick
v1.6.0-windows,*** End: UpdatableState implementation ***//
v1.6.0-windows,TODO: directly accept getVehicleSimApis() using generic container
v1.6.0-windows,remove everything that we created in BeginPlay
v1.6.0-windows,wait if no new frame is renderd
v1.6.0-windows,we use custom debug reporting for this class
v1.6.0-windows,perform any expensive rendering update outside of lock region
v1.6.0-windows,no need to call base reset because of our custom implementation
v1.6.0-windows,TODO: this is going to cause circular references which is fine here but
v1.6.0-windows,in future we should consider moving SimMode not derived from AActor and move
v1.6.0-windows,it to AirLib and directly implement WorldSimApiBase interface
v1.6.0-windows,get player start
v1.6.0-windows,this must be done from within actor otherwise we don't get player start
v1.6.0-windows,Grab player location
v1.6.0-windows,Move the world origin to the player's location (this moves the coordinate system and adds
v1.6.0-windows,a corresponding offset to all positions to compensate for the shift)
v1.6.0-windows,"Regrab the player's position after the offset has been added (which should be 0,0,0 now)"
v1.6.0-windows,UWeatherLib::showWeatherMenu(World);
v1.6.0-windows,else don't init
v1.6.0-windows,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v1.6.0-windows,tod_sim_clock_start_ needs to be reset here.
v1.6.0-windows,Going from enabled to disabled
v1.6.0-windows,do these in the end to ensure that advanceTimeOfDay() doesn't see
v1.6.0-windows,any inconsistent state.
v1.6.0-windows,should be overridden by derived class
v1.6.0-windows,should be overridden by derived class
v1.6.0-windows,should be overriden by derived class
v1.6.0-windows,should be overridden by derived class
v1.6.0-windows,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.6.0-windows,default setup - this should be overridden in derived modes as needed
v1.6.0-windows,setup clock in ClockFactory
v1.6.0-windows,default implementation
v1.6.0-windows,create director
v1.6.0-windows,create external camera required for the director
v1.6.0-windows,for each camera in settings
v1.6.0-windows,get pose
v1.6.0-windows,spawn and attach camera to pawn
v1.6.0-windows,add on to our collection
v1.6.0-windows,API server start/stop
v1.6.0-windows,get UU origin of global NED frame
v1.6.0-windows,compute initial pose
v1.6.0-windows,spawn vehicle pawn
v1.6.0-windows,create vehicle sim api
v1.6.0-windows,TODO: Figure out a better way to add more fields
v1.6.0-windows,Maybe allow passing a JSON string for the vehicle settings?
v1.6.0-windows,"Retroactively adjust AirSimSettings, so it's like we knew about this vehicle all along"
v1.6.0-windows,"Usually physics registration happens at init, in ASimModeWorldBase::initializeForPlay(), but not in this case"
v1.6.0-windows,Can't be done before the vehicle apis have been created
v1.6.0-windows,get UU origin of global NED frame
v1.6.0-windows,determine camera director camera default pose and spawn it
v1.6.0-windows,find all vehicle pawns
v1.6.0-windows,add vehicles from settings
v1.6.0-windows,if vehicle is of type for derived SimMode and auto creatable
v1.6.0-windows,create API objects for each pawn we have
v1.6.0-windows,Create External Cameras
v1.6.0-windows,TODO: better handle no FPV vehicles scenario
v1.6.0-windows,derived class shoudl override this method to add new vehicle to the physics engine
v1.6.0-windows,derived class should override this method to retrieve types of pawns they support
v1.6.0-windows,derived class should override this method to retrieve types of pawns they support
v1.6.0-windows,derived class should override this method to retrieve types of pawns they support
v1.6.0-windows,derived class should override this method to retrieve types of pawns they support
v1.6.0-windows,derived class should override this method to retrieve types of pawns they support
v1.6.0-windows,derived class should override this method to retrieve types of pawns they support
v1.6.0-windows,derived class should override this method to retrieve types of pawns they support
v1.6.0-windows,Draws debug-points on main viewport for Lidar laser hits.
v1.6.0-windows,Used for debugging only.
v1.6.0-windows,Currently we are checking the sensor-collection instead of sensor-settings.
v1.6.0-windows,Also using variables to optimize not checking the collection if not needed.
v1.6.0-windows,TODO: Is it incorrect to assume LidarSimple here?
v1.6.0-windows,Draw debug-point on main viewport for Distance sensor hit
v1.6.0-windows,Find position of point hit
v1.6.0-windows,Similar to UnrealDistanceSensor.cpp#L19
v1.6.0-windows,order of Pose addition is important here because it also adds quaternions which is not commutative!
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,ctor
v1.6.0-windows,initializes information based on lidar configuration
v1.6.0-windows,calculate verticle angle distance between each laser
v1.6.0-windows,store vertical angles for each laser
v1.6.0-windows,returns a point-cloud for the tick
v1.6.0-windows,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.6.0-windows,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.6.0-windows,calculate number of points needed for each laser/channel
v1.6.0-windows,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.6.0-windows,calculate needed angle/distance between each point
v1.6.0-windows,normalize FOV start/end
v1.6.0-windows,shoot lasers
v1.6.0-windows,check if the laser is outside the requested horizontal FOV
v1.6.0-windows,"shoot laser and get the impact point, if any"
v1.6.0-windows,simulate shooting a laser via Unreal ray-tracing.
v1.6.0-windows,start position
v1.6.0-windows,We need to compose rotations here rather than rotate a vector by a quaternion
v1.6.0-windows,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.6.0-windows,get ray quaternion in lidar frame (angles must be in radians)
v1.6.0-windows,get ray quaternion in body frame
v1.6.0-windows,get ray quaternion in world frame
v1.6.0-windows,get ray vector (end position)
v1.6.0-windows,Store the segmentation id of the hit object.
v1.6.0-windows,Debug code for very specific cases.
v1.6.0-windows,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.6.0-windows,decide the frame for the point-cloud
v1.6.0-windows,current detault behavior; though it is probably not very useful.
v1.6.0-windows,not changing the default for now to maintain backwards-compat.
v1.6.0-windows,point in vehicle intertial frame
v1.6.0-windows,tranform to lidar frame
v1.6.0-windows,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.6.0-windows,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.6.0-windows,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.6.0-windows,"On the client side, if it is needed to transform this data back to the world frame,"
v1.6.0-windows,"then do the equivalent of following,"
v1.6.0-windows,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.6.0-windows,See SimModeBase::drawLidarDebugPoints()
v1.6.0-windows,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.6.0-windows,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,update ray tracing
v1.6.0-windows,"FString hit_name = FString(""None"");"
v1.6.0-windows,if (dist_hit.GetActor())
v1.6.0-windows,hit_name=dist_hit.GetActor()->GetName();
v1.6.0-windows,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.6.0-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,This assumes you are running DroneServer already on the same machine.
v1.6.0-windows,DroneServer must be running first.
v1.6.0-windows,enable API control
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,Load gazebo
v1.6.0-windows,Create our node for communication
v1.6.0-windows,Listen to Gazebo topics
v1.6.0-windows,Make sure to shut everything down.
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,move commands
v1.6.0-windows,else leave as it is
v1.6.0-windows,TODO: get these in one call
v1.6.0-windows,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.6.0-windows,TODO: shouldn't we pass folder path?
v1.6.0-windows,parse
v1.6.0-windows,group the images by the current date.
v1.6.0-windows,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.6.0-windows,{
v1.6.0-windows,"return """";"
v1.6.0-windows,}
v1.6.0-windows,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.6.0-windows,{
v1.6.0-windows,return false;
v1.6.0-windows,}
v1.6.0-windows,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.6.0-windows,params.context->client.newTask();
v1.6.0-windows,}
v1.6.0-windows,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.6.0-windows,params.context->client.WaitForCompletion(0);
v1.6.0-windows,}
v1.6.0-windows,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.6.0-windows,{
v1.6.0-windows,}
v1.6.0-windows,parse command line
v1.6.0-windows,Shell callbacks
v1.6.0-windows,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.6.0-windows,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.6.0-windows,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.6.0-windows,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.6.0-windows,Add shell commands
v1.6.0-windows,TODO: add WaitForCompletion command
v1.6.0-windows,"TODO: add command line args help, arg count validation"
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v1.6.0-windows,switch to explicit hover mode so that this is the fall back when
v1.6.0-windows,move* commands are finished.
v1.6.0-windows,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.6.0-windows,TODO: implement weather for Unity
v1.6.0-windows,TODO: implement weather for Unity
v1.6.0-windows,----------------Plotting APIs-----------/
v1.6.0-windows,Recording APIs
v1.6.0-windows,"Remove '' from the list, representing default vehicle"
v1.6.0-windows,Function pointers to hold the addresses of the functions that are defined in Unity
v1.6.0-windows,"Enabling all LogLevels,"
v1.6.0-windows,"Enabling all LogLevels,"
v1.6.0-windows,delete ltm;
v1.6.0-windows,initialize state
v1.6.0-windows,compute our home point
v1.6.0-windows,default behavior is to call update every tick
v1.6.0-windows,"for custom physics engine, this method should be overridden and update should be"
v1.6.0-windows,called from every physics tick
v1.6.0-windows,these will be available for devices like steering wheels
v1.6.0-windows,sync environment from kinematics
v1.6.0-windows,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.6.0-windows,FVector unrealPosition = getUUPosition();
v1.6.0-windows,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v1.6.0-windows,parameters in NED frame
v1.6.0-windows,allow teleportation
v1.6.0-windows,if collisions are not enabled
v1.6.0-windows,or we have collided but passthrough is enabled
v1.6.0-windows,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.6.0-windows,"without flip flopping, collisions can't be detected"
v1.6.0-windows,by default we update kinematics from UE pawn
v1.6.0-windows,if SimMod uses its own physics engine then this should be overriden
v1.6.0-windows,no default action in this base class
v1.6.0-windows,TODO: because this bug we are using alternative code with stringstream
v1.6.0-windows,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.6.0-windows,update kinematics from pawn's movement instead of physics engine
v1.6.0-windows,TODO: update other fields?
v1.6.0-windows,implements getImages() method in the ImageCaptureBase class.
v1.6.0-windows,update ray tracing
v1.6.0-windows,TODO: index check
v1.6.0-windows,Attempts to parse the settings text from one of multiple locations.
v1.6.0-windows,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.6.0-windows,"Next, check the executable's working directory for the settings file."
v1.6.0-windows,"Finally, check the user's documents folder."
v1.6.0-windows,"If the settings file cannot be read, throw an exception"
v1.6.0-windows,let base class setup physics world
v1.6.0-windows,stop physics thread before we dismantle
v1.6.0-windows,setup clock in ClockFactory
v1.6.0-windows,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.6.0-windows,steppable clock returns interval that is a constant number irrespective of wall clock
v1.6.0-windows,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.6.0-windows,but that would cause vehicles like quadrotors to become unstable
v1.6.0-windows,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.6.0-windows,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.6.0-windows,get increase in clock speed
v1.6.0-windows,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.6.0-windows,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.6.0-windows,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.6.0-windows,Approach 2: scale control loop frequency if clock is speeded up
v1.6.0-windows,"for slowing down, this don't generate instability"
v1.6.0-windows,-------------------------------- overrides -----------------------------------------------//
v1.6.0-windows,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.6.0-windows,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.6.0-windows,create vehicle API
v1.6.0-windows,setup physics vehicle
v1.6.0-windows,initialize private vars
v1.6.0-windows,"if reset is pending then do it first, no need to do other things until next tick"
v1.6.0-windows,move collision info from rendering engine to vehicle
v1.6.0-windows,update rotor poses
v1.6.0-windows,if we did reset then don't worry about synchronizing states for this tick
v1.6.0-windows,Continue to wait for reset
v1.6.0-windows,*** Start: UpdatableState implementation ***//
v1.6.0-windows,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.6.0-windows,environment update for current position
v1.6.0-windows,update forces on vertices
v1.6.0-windows,update to controller must be done after kinematics have been updated by physics engine
v1.6.0-windows,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.6.0-windows,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.6.0-windows,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.6.0-windows,*** End: UpdatableState implementation ***//
v1.6.0-windows,TODO: should do reset() here?
v1.6.0-windows,these are called on render ticks
v1.6.0-windows,TODO: do we need this for cars?
v1.6.0-windows,Thrustmaster devices
v1.6.0-windows,"Anything else, typically Logitech G920 wheel"
v1.6.0-windows,Two steel levers behind wheel
v1.6.0-windows,if API-client control is not active then we route keyboard/joystick control to car
v1.6.0-windows,This is so that getCarControls API works correctly
v1.6.0-windows,"API is enabled, so we use the controls set by API"
v1.6.0-windows,Update whether to use API controls or keyboard controls
v1.6.0-windows,*** Start: UpdatableState implementation ***//
v1.6.0-windows,physics tick
v1.6.0-windows,void CarPawnSimApi::reportState(StateReporter& reporter)
v1.6.0-windows,{
v1.6.0-windows,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.6.0-windows,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.6.0-windows,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.6.0-windows,}
v1.6.0-windows,*** End: UpdatableState implementation ***//
v1.6.0-windows,remove everything that we created in BeginPlay
v1.6.0-windows,we use custom debug reporting for this class
v1.6.0-windows,perform any expensive rendering update outside of lock region
v1.6.0-windows,no need to call base reset because of our custom implementation
v1.6.0-windows,should be overridden by derived class
v1.6.0-windows,should be overridden by derived class
v1.6.0-windows,should be overridden by derived class
v1.6.0-windows,commenting this out for now to avoid unintentional Unity startup failure
v1.6.0-windows,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v1.6.0-windows,should be overridden by derived class
v1.6.0-windows,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.6.0-windows,default setup - this should be overridden in derived modes as needed
v1.6.0-windows,setup clock in ClockFactory
v1.6.0-windows,API server start/stop
v1.6.0-windows,determine camera director camera default pose and spawn it
v1.6.0-windows,derived class should override this method to retrieve types of pawns they support
v1.6.0-windows,derived class should override this method to retrieve types of pawns they support
v1.6.0-windows,60 acres park:
v1.6.0-windows,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.6.0-windows,marymoore park
v1.6.0-windows,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.6.0-windows,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.6.0-windows,DepthNavThreshold depthNav;
v1.6.0-windows,DepthNavOptAStar depthNav;
v1.6.0-windows,DepthNavThreshold depthNav;
v1.6.0-windows,DepthNavOptAStar depthNav;
v1.6.0-windows,Cleanup
v1.6.0-windows,runDepthNavGT();
v1.6.0-windows,runDepthNavSGM();
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,by Sudipta Sinha
v1.6.0-windows,adapted for AirSim by Matthias Mueller
v1.6.0-windows,first row
v1.6.0-windows,last row
v1.6.0-windows,Local quadratic fit of cost and subpixel refinement.
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,by Sudipta Sinha
v1.6.0-windows,adapted for AirSim by Matthias Mueller
v1.6.0-windows,uint64_t x64 = (uint64_t)x;
v1.6.0-windows,uint64_t y64 = (uint64_t)y;
v1.6.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-windows,Licensed under the MIT License.
v1.6.0-windows,by Sudipta Sinha
v1.6.0-windows,adapted for AirSim by Matthias Mueller
v1.6.0-windows,ensure that disparity range is a multiple of 8
v1.6.0-windows,sgm stereo
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,read settings and override defaults
v1.6.0-linux,allow json overrides on a per-vehicle basis.
v1.6.0-linux,start server in async mode
v1.6.0-linux,check messages
v1.6.0-linux,plot red arrows for 30 seconds
v1.6.0-linux,plot magenta arrows for 15 seconds
v1.6.0-linux,plot red arrows for 10 seconds
v1.6.0-linux,plot 2 white arrows which are persistent
v1.6.0-linux,plot points
v1.6.0-linux,"plot line strip. 0-1, 1-2, 2-3"
v1.6.0-linux,"plot line list. 0-1, 2-3, 4-5. Must be even."
v1.6.0-linux,plot transforms
v1.6.0-linux,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=0.0, yaw=yaw)) for x, y, yaw in zip(np.linspace(0,10,10), np.linspace(0,0,10), np.linspace(0,np.pi,10))],"
v1.6.0-linux,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.6.0-linux,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=roll, yaw=0.0)) for x, y, roll in zip(np.linspace(0,10,10), np.linspace(1,1,10), np.linspace(0,np.pi,10))],"
v1.6.0-linux,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.6.0-linux,Import this module to automatically setup path to local airsim module
v1.6.0-linux,This module first tries to see if airsim module is installed via pip
v1.6.0-linux,If it does then we don't do anything else
v1.6.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.6.0-linux,and if it does then we add that in sys.path
v1.6.0-linux,this class simply tries to see if airsim
v1.6.0-linux,if airsim module is installed then don't do anything else
v1.6.0-linux,import pkgutil
v1.6.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.6.0-linux,if airsim_loader is not None:
v1.6.0-linux,return
v1.6.0-linux,In settings.json first activate computer vision mode:
v1.6.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.6.0-linux,monitor car state while you drive it manually.
v1.6.0-linux,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v1.6.0-linux,denominator from microns^3 to microns * m^2)
v1.6.0-linux,First set everything to 0.
v1.6.0-linux,Next set all objects of interest provided to corresponding object IDs
v1.6.0-linux,segIdDict values MUST match tempEmissivityNew labels.
v1.6.0-linux,"Connect to AirSim, UAV mode."
v1.6.0-linux,Choose temperature values for winter or summer.
v1.6.0-linux,""""""""
v1.6.0-linux,winter
v1.6.0-linux,""""""""
v1.6.0-linux,summer
v1.6.0-linux,Read camera response.
v1.6.0-linux,Calculate radiance.
v1.6.0-linux,Set IDs in AirSim environment.
v1.6.0-linux,In settings.json first activate computer vision mode:
v1.6.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.6.0-linux,"define abstract class to return next vector in the format (x,y,yaw)"
v1.6.0-linux,"compute vector, distance and angle to goal"
v1.6.0-linux,compute box of interest
v1.6.0-linux,scale by weight matrix (optional)
v1.6.0-linux,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.6.0-linux,detect collision
v1.6.0-linux,compute box of interest
v1.6.0-linux,detect collision
v1.6.0-linux,Same as above but decide to go left or right based on average or some metric like that
v1.6.0-linux,"compute resultant normalized vector, distance and angle"
v1.6.0-linux,compute bounding box size
v1.6.0-linux,convert horizonal fov to vertical fov
v1.6.0-linux,matrix with all ones
v1.6.0-linux,matrix with max weight in center and decreasing linearly with distance from center
v1.6.0-linux,matrix with max weight in center and decreasing quadratically with distance from center
v1.6.0-linux,"print (""Saving images to %s"" % tmp_dir)"
v1.6.0-linux,airsim.wait_key('Press any key to start')
v1.6.0-linux,"Define start position, goal and size of UAV"
v1.6.0-linux,Define parameters and thresholds
v1.6.0-linux,initial position
v1.6.0-linux,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.6.0-linux,time.sleep(1)
v1.6.0-linux,get response
v1.6.0-linux,get numpy array
v1.6.0-linux,reshape array to 2D array H X W
v1.6.0-linux,write to png
v1.6.0-linux,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.6.0-linux,pose = client.simGetPose()
v1.6.0-linux,pp.pprint(pose)
v1.6.0-linux,time.sleep(5)
v1.6.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.6.0-linux,################### OLD CODE
v1.6.0-linux,timer = 0
v1.6.0-linux,time_obs = 50
v1.6.0-linux,bObstacle = False
v1.6.0-linux,if (bObstacle):
v1.6.0-linux,timer = timer + 1
v1.6.0-linux,if timer > time_obs:
v1.6.0-linux,bObstacle = False
v1.6.0-linux,timer = 0
v1.6.0-linux,else:
v1.6.0-linux,yaw = target_angle
v1.6.0-linux,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.6.0-linux,if (np.average(img2d_box) < coll_thres):
v1.6.0-linux,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.6.0-linux,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.6.0-linux,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.6.0-linux,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.6.0-linux,"print('left: ', img2d_box_l_avg)"
v1.6.0-linux,"print('right: ', img2d_box_r_avg)"
v1.6.0-linux,if img2d_box_l_avg > img2d_box_r_avg:
v1.6.0-linux,##Go LEFT
v1.6.0-linux,#y_offset = y_offset-1
v1.6.0-linux,yaw = yaw - radians(10)
v1.6.0-linux,bObstacle = True
v1.6.0-linux,else:
v1.6.0-linux,##Go RIGHT
v1.6.0-linux,#y_offset = y_offset+1
v1.6.0-linux,yaw = yaw + radians(10)
v1.6.0-linux,bObstacle = true
v1.6.0-linux,"print('yaw: ', yaw)"
v1.6.0-linux,In settings.json first activate computer vision mode:
v1.6.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.6.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.6.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.6.0-linux,pip install opencv-python
v1.6.0-linux,Just change the below to test different cameras easily!
v1.6.0-linux,Test Camera info
v1.6.0-linux,Test Image APIs
v1.6.0-linux,Test FoV API
v1.6.0-linux,Test Pose APIs
v1.6.0-linux,Test Distortion params APIs
v1.6.0-linux,In settings.json first activate computer vision mode:
v1.6.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.6.0-linux,In settings.json first activate computer vision mode:
v1.6.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.6.0-linux,for block environment
v1.6.0-linux,regex are case insensitive
v1.6.0-linux,#for neighborhood environment
v1.6.0-linux,set object ID for sky
v1.6.0-linux,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.6.0-linux,get segmentation image in various formats
v1.6.0-linux,save segmentation images in various formats
v1.6.0-linux,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.6.0-linux,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.6.0-linux,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v1.6.0-linux,find unique colors
v1.6.0-linux,In settings.json first activate computer vision mode:
v1.6.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.6.0-linux,objects can be named in two ways:
v1.6.0-linux,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.6.0-linux,default name is auto-generated and varies from run-to-run.
v1.6.0-linux,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.6.0-linux,
v1.6.0-linux,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.6.0-linux,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.6.0-linux,https://answers.unrealengine.com/revisions/790629.html
v1.6.0-linux,below works in Blocks environment
v1.6.0-linux,------------------------------------ Get current pose ------------------------------------------------
v1.6.0-linux,search object by name:
v1.6.0-linux,search another object by tag
v1.6.0-linux,search non-existent object
v1.6.0-linux,------------------------------------ Set new pose ------------------------------------------------
v1.6.0-linux,here we move with teleport enabled so collisions are ignored
v1.6.0-linux,here we move with teleport enabled so collisions are not ignored
v1.6.0-linux,move non-existent object
v1.6.0-linux,------------------------------------ Get new pose ------------------------------------------------
v1.6.0-linux,search another object by tag
v1.6.0-linux,search non-existent object
v1.6.0-linux,Import this module to automatically setup path to local airsim module
v1.6.0-linux,This module first tries to see if airsim module is installed via pip
v1.6.0-linux,If it does then we don't do anything else
v1.6.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.6.0-linux,and if it does then we add that in sys.path
v1.6.0-linux,this class simply tries to see if airsim
v1.6.0-linux,if airsim module is installed then don't do anything else
v1.6.0-linux,import pkgutil
v1.6.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.6.0-linux,if airsim_loader is not None:
v1.6.0-linux,return
v1.6.0-linux,"Roll is applied first, then pitch, then yaw."
v1.6.0-linux,Turn the camera position into a column vector.
v1.6.0-linux,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v1.6.0-linux,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v1.6.0-linux,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v1.6.0-linux,Recreate the perspective projection of the camera.
v1.6.0-linux,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v1.6.0-linux,Set pose and sleep after to ensure the pose sticks before capturing image.
v1.6.0-linux,Capture segmentation (IR) and scene images.
v1.6.0-linux,Change images into numpy arrays.
v1.6.0-linux,Capture images for a certain amount of time in seconds (half hour now)
v1.6.0-linux,Capture image - pose.position x_val access may change w/ AirSim
v1.6.0-linux,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v1.6.0-linux,Convert color scene image to BGR for write out with cv2.
v1.6.0-linux,"Connect to AirSim, UAV mode."
v1.6.0-linux,Look for objects with names that match a regular expression.
v1.6.0-linux,"Sample calls to main, varying camera angle and altitude."
v1.6.0-linux,"straight down, 400ft"
v1.6.0-linux,"straight down, 200ft"
v1.6.0-linux,"45 degrees, 200ft -- note that often object won't be scene since position"
v1.6.0-linux,is set exactly to object's
v1.6.0-linux,"45 degrees, 400ft -- note that often object won't be scene since position"
v1.6.0-linux,is set exactly to object's
v1.6.0-linux,In settings.json first activate computer vision mode:
v1.6.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.6.0-linux,xn = 1 + x*5  # some random number
v1.6.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,monitor car state while you drive it manually.
v1.6.0-linux,get state of the car
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,go forward
v1.6.0-linux,get state of the car
v1.6.0-linux,Python client example to change time-of-day using APIs
v1.6.0-linux,
v1.6.0-linux,Changes time of the day and makes the car move around
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,flip between specific time and default time
v1.6.0-linux,go forward
v1.6.0-linux,Go forward + steer right
v1.6.0-linux,main
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,get state of the car
v1.6.0-linux,go forward
v1.6.0-linux,Go forward + steer right
v1.6.0-linux,go reverse
v1.6.0-linux,apply brakes
v1.6.0-linux,get camera images from the car
v1.6.0-linux,restore to original state
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,go forward
v1.6.0-linux,Python client example to get Lidar data from a car
v1.6.0-linux,
v1.6.0-linux,Makes the drone fly and get Lidar data
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,"print(""state: %s"" % s)"
v1.6.0-linux,go forward
v1.6.0-linux,Go forward + steer right
v1.6.0-linux,"reshape array of floats to array of [X,Y,Z]"
v1.6.0-linux,TODO
v1.6.0-linux,main
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,get state of the car
v1.6.0-linux,go forward
v1.6.0-linux,Go forward + steer right
v1.6.0-linux,go reverse
v1.6.0-linux,apply breaks
v1.6.0-linux,restore to original state
v1.6.0-linux,Import this module to automatically setup path to local airsim module
v1.6.0-linux,This module first tries to see if airsim module is installed via pip
v1.6.0-linux,If it does then we don't do anything else
v1.6.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.6.0-linux,and if it does then we add that in sys.path
v1.6.0-linux,this class simply tries to see if airsim
v1.6.0-linux,if airsim module is installed then don't do anything else
v1.6.0-linux,import pkgutil
v1.6.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.6.0-linux,if airsim_loader is not None:
v1.6.0-linux,return
v1.6.0-linux,Use below in settings.json with blocks environment
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,get state of the car
v1.6.0-linux,go forward
v1.6.0-linux,go reverse
v1.6.0-linux,apply breaks
v1.6.0-linux,get camera images from the car
v1.6.0-linux,restore to original state
v1.6.0-linux,from keras.models import load_model
v1.6.0-linux,if (len(sys.argv) != 2):
v1.6.0-linux,print('usage: python drive.py <modelName>')
v1.6.0-linux,sys.exit()
v1.6.0-linux,print('Loading model...')
v1.6.0-linux,model = load_model(sys.argv[1])
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.6.0-linux,"model_output = model.predict([image_buf, state_buf])"
v1.6.0-linux,car_controls.steering = float(model_output[0][0])
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,set camera name and image type to request images and detections
v1.6.0-linux,set detection radius in [cm]
v1.6.0-linux,add desired object name to detect in wild card/regex format
v1.6.0-linux,Import this module to automatically setup path to local airsim module
v1.6.0-linux,This module first tries to see if airsim module is installed via pip
v1.6.0-linux,If it does then we don't do anything else
v1.6.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.6.0-linux,and if it does then we add that in sys.path
v1.6.0-linux,this class simply tries to see if airsim
v1.6.0-linux,if airsim module is installed then don't do anything else
v1.6.0-linux,import pkgutil
v1.6.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.6.0-linux,if airsim_loader is not None:
v1.6.0-linux,return
v1.6.0-linux,-*- coding: utf-8 -*-
v1.6.0-linux,
v1.6.0-linux,Configuration file for the Sphinx documentation builder.
v1.6.0-linux,
v1.6.0-linux,This file does only contain a selection of the most common options. For a
v1.6.0-linux,full list see the documentation:
v1.6.0-linux,http://www.sphinx-doc.org/en/master/config
v1.6.0-linux,-- Path setup --------------------------------------------------------------
v1.6.0-linux,"If extensions (or modules to document with autodoc) are in another directory,"
v1.6.0-linux,add these directories to sys.path here. If the directory is relative to the
v1.6.0-linux,"documentation root, use os.path.abspath to make it absolute, like shown here."
v1.6.0-linux,
v1.6.0-linux,-- Project information -----------------------------------------------------
v1.6.0-linux,The short X.Y version
v1.6.0-linux,"The full version, including alpha/beta/rc tags"
v1.6.0-linux,-- General configuration ---------------------------------------------------
v1.6.0-linux,"If your documentation needs a minimal Sphinx version, state it here."
v1.6.0-linux,
v1.6.0-linux,needs_sphinx = '1.0'
v1.6.0-linux,"Add any Sphinx extension module names here, as strings. They can be"
v1.6.0-linux,extensions coming with Sphinx (named 'sphinx.ext.*') or your custom
v1.6.0-linux,ones.
v1.6.0-linux,"Add any paths that contain templates here, relative to this directory."
v1.6.0-linux,The suffix(es) of source filenames.
v1.6.0-linux,You can specify multiple suffix as a list of string:
v1.6.0-linux,
v1.6.0-linux,"source_suffix = ['.rst', '.md']"
v1.6.0-linux,The master toctree document.
v1.6.0-linux,The language for content autogenerated by Sphinx. Refer to documentation
v1.6.0-linux,for a list of supported languages.
v1.6.0-linux,
v1.6.0-linux,This is also used if you do content translation via gettext catalogs.
v1.6.0-linux,"Usually you set ""language"" from the command line for these cases."
v1.6.0-linux,"List of patterns, relative to source directory, that match files and"
v1.6.0-linux,directories to ignore when looking for source files.
v1.6.0-linux,This pattern also affects html_static_path and html_extra_path.
v1.6.0-linux,The name of the Pygments (syntax highlighting) style to use.
v1.6.0-linux,-- Options for HTML output -------------------------------------------------
v1.6.0-linux,The theme to use for HTML and HTML Help pages.  See the documentation for
v1.6.0-linux,a list of builtin themes.
v1.6.0-linux,
v1.6.0-linux,html_theme = 'alabaster'
v1.6.0-linux,Theme options are theme-specific and customize the look and feel of a theme
v1.6.0-linux,"further.  For a list of options available for each theme, see the"
v1.6.0-linux,documentation.
v1.6.0-linux,
v1.6.0-linux,html_theme_options = {}
v1.6.0-linux,"Add any paths that contain custom static files (such as style sheets) here,"
v1.6.0-linux,"relative to this directory. They are copied after the builtin static files,"
v1.6.0-linux,"so a file named ""default.css"" will overwrite the builtin ""default.css""."
v1.6.0-linux,"Custom sidebar templates, must be a dictionary that maps document names"
v1.6.0-linux,to template names.
v1.6.0-linux,
v1.6.0-linux,The default sidebars (for documents that don't match any pattern) are
v1.6.0-linux,defined by theme itself.  Builtin themes are using these templates by
v1.6.0-linux,"default: ``['localtoc.html', 'relations.html', 'sourcelink.html',"
v1.6.0-linux,'searchbox.html']``.
v1.6.0-linux,
v1.6.0-linux,html_sidebars = {}
v1.6.0-linux,-- Options for HTMLHelp output ---------------------------------------------
v1.6.0-linux,Output file base name for HTML help builder.
v1.6.0-linux,-- Options for LaTeX output ------------------------------------------------
v1.6.0-linux,The paper size ('letterpaper' or 'a4paper').
v1.6.0-linux,
v1.6.0-linux,"'papersize': 'letterpaper',"
v1.6.0-linux,"The font size ('10pt', '11pt' or '12pt')."
v1.6.0-linux,
v1.6.0-linux,"'pointsize': '10pt',"
v1.6.0-linux,Additional stuff for the LaTeX preamble.
v1.6.0-linux,
v1.6.0-linux,"'preamble': '',"
v1.6.0-linux,Latex figure (float) alignment
v1.6.0-linux,
v1.6.0-linux,"'figure_align': 'htbp',"
v1.6.0-linux,Grouping the document tree into LaTeX files. List of tuples
v1.6.0-linux,"(source start file, target name, title,"
v1.6.0-linux,"author, documentclass [howto, manual, or own class])."
v1.6.0-linux,-- Options for manual page output ------------------------------------------
v1.6.0-linux,One entry per manual page. List of tuples
v1.6.0-linux,"(source start file, name, description, authors, manual section)."
v1.6.0-linux,-- Options for Texinfo output ----------------------------------------------
v1.6.0-linux,Grouping the document tree into Texinfo files. List of tuples
v1.6.0-linux,"(source start file, target name, title, author,"
v1.6.0-linux,"dir menu entry, description, category)"
v1.6.0-linux,-- Options for Epub output -------------------------------------------------
v1.6.0-linux,Bibliographic Dublin Core info.
v1.6.0-linux,The unique identifier of the text. This can be a ISBN number
v1.6.0-linux,or the project homepage.
v1.6.0-linux,
v1.6.0-linux,epub_identifier = ''
v1.6.0-linux,A unique identification for the text.
v1.6.0-linux,
v1.6.0-linux,epub_uid = ''
v1.6.0-linux,A list of files that should not be packed into the epub file.
v1.6.0-linux,-- Extension configuration -------------------------------------------------
v1.6.0-linux,-- Options for intersphinx extension ---------------------------------------
v1.6.0-linux,Example configuration for intersphinx: refer to the Python standard library.
v1.6.0-linux,-- Options for todo extension ----------------------------------------------
v1.6.0-linux,"If true, `todo` and `todoList` produce output, else they produce nothing."
v1.6.0-linux,We ignore the 2D nature of the problem as it is not relevant here
v1.6.0-linux,It makes multi-core processing more straightforward
v1.6.0-linux,Allocations
v1.6.0-linux,Add small number to avoid issues with log(I)
v1.6.0-linux,Event sim keeps track of previous image automatically
v1.6.0-linux,"Using pickle dump in a per-frame fashion to save time, instead of savetxt"
v1.6.0-linux,Optimizations possible
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,that's enough fun for now. let's quit cleanly
v1.6.0-linux,"Python client example to get Lidar data from a drone, although this script works for any AirSim-supported vehicle"
v1.6.0-linux,This script is for Lidar sensors using 'SensorLocalFrame' as DataFrame under settings.json.
v1.6.0-linux,Sample settings.json used for this script:
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,main
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,MultirotorClient.wait_key('Press any key to takeoff')
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,get camera images from the car
v1.6.0-linux,that's enough fun for now. let's quit cleanly
v1.6.0-linux,##################################################################################################
v1.6.0-linux,
v1.6.0-linux,Project:  Embedded Learning Library (ELL)
v1.6.0-linux,File:     speaker.py
v1.6.0-linux,Authors:  Chris Lovett
v1.6.0-linux,
v1.6.0-linux,Requires: Python 3.x
v1.6.0-linux,
v1.6.0-linux,##################################################################################################
v1.6.0-linux,open speakers so we can hear what it is processing...
v1.6.0-linux,teleport the drone + 10 meters in x-direction
v1.6.0-linux,teleport the drone back
v1.6.0-linux,This example shows how to use the External Physics Engine
v1.6.0-linux,It allows you to control the drone through setVehiclePose and obtain collision information.
v1.6.0-linux,It is especially useful for injecting your own flight dynamics model to the AirSim drone.
v1.6.0-linux,Use Blocks environment to see the drone colliding and seeing the collision information
v1.6.0-linux,in the command prompt.
v1.6.0-linux,Add this line to your settings.json before running AirSim:
v1.6.0-linux,"""PhysicsEngineName"":""ExternalPhysicsEngine"""
v1.6.0-linux,use open cv to create point cloud from depth image.
v1.6.0-linux,###########################################
v1.6.0-linux,######### This is work in progress! #######
v1.6.0-linux,###########################################
v1.6.0-linux,file will be saved in PythonClient folder (i.e. same folder as script)
v1.6.0-linux,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.6.0-linux,skip it
v1.6.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.6.0-linux,z of -7 is 7 meters above the original launch point.
v1.6.0-linux,Fly given velocity vector for 5 seconds
v1.6.0-linux,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.6.0-linux,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.6.0-linux,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.6.0-linux,Make the drone fly in a circle.
v1.6.0-linux,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.6.0-linux,check that our home position is stable
v1.6.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.6.0-linux,ramp up time
v1.6.0-linux,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.6.0-linux,compute current angle
v1.6.0-linux,compute lookahead
v1.6.0-linux,if we did the takeoff then also do the landing.
v1.6.0-linux,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.6.0-linux,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.6.0-linux,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.6.0-linux,ignore the click over from 360 back to 0
v1.6.0-linux,watch direction this diff is moving if it switches from shrinking to growing
v1.6.0-linux,then we passed the starting point.
v1.6.0-linux,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.6.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.6.0-linux,z of -5 is 5 meters above the original launch point.
v1.6.0-linux,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.6.0-linux,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.6.0-linux,drone will over-shoot so we bring it back to the start point before landing.
v1.6.0-linux,"Python client example to get Lidar data from a drone, although this script works for any AirSim-supported vehicle"
v1.6.0-linux,This script is for Lidar sensors using 'VehicleInertialFrame' as DataFrame under settings.json
v1.6.0-linux,Sample settings.json used for this script:
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,main
v1.6.0-linux,Run this script with clock speed in settings.json
v1.6.0-linux,"""ClockSpeed"": 1 then change it to 0.5"
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,with ClockSpeed = 0.5 you will see that this takes 6s (system time) and not 3s
v1.6.0-linux,with ClockSpeed = 0.5 you will see that this takes 10s (system time)
v1.6.0-linux,and not 5s in each iteration
v1.6.0-linux,that's enough fun for now. let's quit cleanly
v1.6.0-linux,Takeoff or hover
v1.6.0-linux,Set wind to 0
v1.6.0-linux,Takeoff or hover
v1.6.0-linux,In settings.json first activate computer vision mode:
v1.6.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.6.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.6.0-linux,pip install opencv-python
v1.6.0-linux,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.6.0-linux,fly for 2 minutes
v1.6.0-linux,more than 50 centimeter drift is unacceptable.
v1.6.0-linux,Python client example to get Lidar data from a drone
v1.6.0-linux,
v1.6.0-linux,Makes the drone fly and get Lidar data
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,"print(""state: %s"" % s)"
v1.6.0-linux,"print(""state: %s"" % pprint.pformat(state))"
v1.6.0-linux,"reshape array of floats to array of [X,Y,Z]"
v1.6.0-linux,TODO
v1.6.0-linux,main
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.6.0-linux,let it settle there a bit.
v1.6.0-linux,after hovering we need to re-enabled api control for next leg of the trip
v1.6.0-linux,now compute the survey path required to fill the box
v1.6.0-linux,##################################################################################################
v1.6.0-linux,
v1.6.0-linux,Project:  Embedded Learning Library (ELL)
v1.6.0-linux,File:     wav_reader.py
v1.6.0-linux,Authors:  Chris Lovett
v1.6.0-linux,
v1.6.0-linux,Requires: Python 3.x
v1.6.0-linux,
v1.6.0-linux,##################################################################################################
v1.6.0-linux,open a stream on the audio input file.
v1.6.0-linux,"assumes signed integer used in raw audio, so for example, the max for 16bit is 2^15 (32768)"
v1.6.0-linux,convert int16 data to scaled floats
v1.6.0-linux,configure output stream to match what we are resampling to...
v1.6.0-linux,convert the audio to the desired recording rate
v1.6.0-linux,split into separate channels
v1.6.0-linux,drop the channels we don't want
v1.6.0-linux,zip the resulting channels back up.
v1.6.0-linux,convert back to packed bytes in PCM 16 format
v1.6.0-linux,"deal with any accumulation of tails, if the tail grows to a full"
v1.6.0-linux,buffer then return it!
v1.6.0-linux,"we have a tail from previous frame, so prepend it"
v1.6.0-linux,"now the caller needs us to stick to our sample_size contract, but when"
v1.6.0-linux,rate conversion happens we can't be sure that 'data' is exactly that size.
v1.6.0-linux,usually one byte extra so add this to our accumulating tail
v1.6.0-linux,"might have reached the end of a file, so pad with zeros."
v1.6.0-linux,"Please add ""EnableTrace"": true to your setting.json as shown below"
v1.6.0-linux,{
v1.6.0-linux,"""SettingsVersion"": 1.2,"
v1.6.0-linux,"""SimMode"": ""Multirotor"","
v1.6.0-linux,"""Vehicles"": {"
v1.6.0-linux,"""Drone"": {"
v1.6.0-linux,"""VehicleType"": ""SimpleFlight"","
v1.6.0-linux,"""EnableTrace"": true"
v1.6.0-linux,}
v1.6.0-linux,}
v1.6.0-linux,}
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,add new vehicle
v1.6.0-linux,Use below in settings.json with Blocks environment
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,get camera images from the car
v1.6.0-linux,that's enough fun for now. let's quit cleanly
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,Import this module to automatically setup path to local airsim module
v1.6.0-linux,This module first tries to see if airsim module is installed via pip
v1.6.0-linux,If it does then we don't do anything else
v1.6.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.6.0-linux,and if it does then we add that in sys.path
v1.6.0-linux,this class simply tries to see if airsim
v1.6.0-linux,if airsim module is installed then don't do anything else
v1.6.0-linux,import pkgutil
v1.6.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.6.0-linux,if airsim_loader is not None:
v1.6.0-linux,return
v1.6.0-linux,"this script moves the drone to a location, then rests it thousands of time"
v1.6.0-linux,purpose of this script is to stress test reset API
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,that's enough fun for now. let's quite cleanly
v1.6.0-linux,For high speed ascent and descent on PX4 you may need to set these properties:
v1.6.0-linux,param set MPC_Z_VEL_MAX_UP 5
v1.6.0-linux,param set MPC_Z_VEL_MAX_DN 5
v1.6.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.6.0-linux,z of -50 is 50 meters above the original launch point.
v1.6.0-linux,use open cv to show new images from AirSim
v1.6.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.6.0-linux,pip install opencv-python
v1.6.0-linux,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.6.0-linux,get depth image
v1.6.0-linux,"this will return png width= 256, height= 144"
v1.6.0-linux,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.6.0-linux,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.6.0-linux,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.6.0-linux,to get an estimate of distance.
v1.6.0-linux,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.6.0-linux,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.6.0-linux,an angular delta of the following pi/10.
v1.6.0-linux,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.6.0-linux,Remove alpha channel if exists
v1.6.0-linux,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.6.0-linux,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.6.0-linux,Flatten and yield as tuple
v1.6.0-linux,Initialize a resizable dataset to hold the output
v1.6.0-linux,Resize the dataset to accommodate the next chunk of rows
v1.6.0-linux,Create the next chunk
v1.6.0-linux,Increment the row count
v1.6.0-linux,Arguments
v1.6.0-linux,Returns
v1.6.0-linux,use composition of homographies
v1.6.0-linux,to generate final transform that needs to be applied
v1.6.0-linux,Arguments
v1.6.0-linux,Returns
v1.6.0-linux,Keeps under lock only the mechanism which advances
v1.6.0-linux,the indexing of each batch.
v1.6.0-linux,The transformation of images is not under thread lock
v1.6.0-linux,so it can be done in parallel
v1.6.0-linux,Trained model path
v1.6.0-linux,Connect to AirSim
v1.6.0-linux,Start driving
v1.6.0-linux,Initialize image buffer
v1.6.0-linux,Update throttle value according to steering angle
v1.6.0-linux,Prediction
v1.6.0-linux,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.6.0-linux,Print progress
v1.6.0-linux,Update next car state
v1.6.0-linux,Wait a bit between iterations
v1.6.0-linux,%matplotlib inline
v1.6.0-linux,chunk size for training batches
v1.6.0-linux,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.6.0-linux,Point this to the directory containing the raw data
v1.6.0-linux,Point this to the desired output directory for the cooked (.h5) data
v1.6.0-linux,Choose The folders to search for data under RAW_DATA_DIR
v1.6.0-linux,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.6.0-linux,data_folder.append('folder_name1')
v1.6.0-linux,data_folder.append('folder_name2')
v1.6.0-linux,...
v1.6.0-linux,Hyper-parameters
v1.6.0-linux,Activation functions
v1.6.0-linux,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.6.0-linux,<< The directory containing the cooked data from the previous step >>
v1.6.0-linux,<< The directory in which the model output will be placed >>
v1.6.0-linux,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.6.0-linux,Network definition
v1.6.0-linux,Import this module to automatically setup path to local airsim module
v1.6.0-linux,This module first tries to see if airsim module is installed via pip
v1.6.0-linux,If it does then we don't do anything else
v1.6.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.6.0-linux,and if it does then we add that in sys.path
v1.6.0-linux,this class simply tries to see if airsim
v1.6.0-linux,if airsim module is installed then don't do anything else
v1.6.0-linux,import pkgutil
v1.6.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.6.0-linux,if airsim_loader is not None:
v1.6.0-linux,return
v1.6.0-linux,DEY: I don't know why this was there.
v1.6.0-linux,-----------------------------------  Common vehicle APIs ---------------------------------------------
v1.6.0-linux,basic flight control
v1.6.0-linux,time-of-day control
v1.6.0-linux,weather
v1.6.0-linux,camera control
v1.6.0-linux,simGetImage returns compressed png in array of bytes
v1.6.0-linux,image_type uses one of the ImageType members
v1.6.0-linux,"todo: in future remove below, it's only for compatibility to pre v1.2"
v1.6.0-linux,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.6.0-linux,camera control
v1.6.0-linux,simGetImage returns compressed png in array of bytes
v1.6.0-linux,image_type uses one of the ImageType members
v1.6.0-linux,gets the static meshes in the unreal scene
v1.6.0-linux,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.6.0-linux,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.6.0-linux,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.6.0-linux,sensor APIs
v1.6.0-linux,Plotting APIs
v1.6.0-linux,Recording APIs
v1.6.0-linux,Add new vehicle via RPC
v1.6.0-linux,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.6.0-linux,APIs for control
v1.6.0-linux,low-level control API
v1.6.0-linux,query vehicle state
v1.6.0-linux,query rotor states
v1.6.0-linux,-----------------------------------  Car APIs ---------------------------------------------
v1.6.0-linux,helper method for converting getOrientation to roll/pitch/yaw
v1.6.0-linux,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.6.0-linux,roll (x-axis rotation)
v1.6.0-linux,pitch (y-axis rotation)
v1.6.0-linux,yaw (z-axis rotation)
v1.6.0-linux,DEY: I don't know why this was there.
v1.6.0-linux,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.6.0-linux,return cls(**msgpack.unpack(encoded))
v1.6.0-linux,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.6.0-linux,Create a DummyVecEnv for main airsim gym env
v1.6.0-linux,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.6.0-linux,Initialize RL algorithm type and parameters
v1.6.0-linux,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.6.0-linux,Train for a certain number of timesteps
v1.6.0-linux,Save policy weights
v1.6.0-linux,Create a DummyVecEnv for main airsim gym env
v1.6.0-linux,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.6.0-linux,Initialize RL algorithm type and parameters
v1.6.0-linux,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.6.0-linux,Train for a certain number of timesteps
v1.6.0-linux,Save policy weights
v1.6.0-linux,Import this module to automatically setup path to local airsim module
v1.6.0-linux,This module first tries to see if airsim module is installed via pip
v1.6.0-linux,If it does then we don't do anything else
v1.6.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.6.0-linux,and if it does then we add that in sys.path
v1.6.0-linux,this class simply tries to see if airsim
v1.6.0-linux,if airsim module is installed then don't do anything else
v1.6.0-linux,import pkgutil
v1.6.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.6.0-linux,if airsim_loader is not None:
v1.6.0-linux,return
v1.6.0-linux,Set home position and velocity
v1.6.0-linux,print(dist)
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,"This is a bit crude, but give it a moment to settle on the ground, else takeoff will fail"
v1.6.0-linux,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.6.0-linux,switch to explicit hover mode so that this is the fallback when
v1.6.0-linux,move* commands are finished.
v1.6.0-linux,"Altitude difference between each platform, in meters"
v1.6.0-linux,"Count down, so the first one can easily go the highest (without knowing count)"
v1.6.0-linux,"in header only mode, control library is not available"
v1.6.0-linux,if using Unreal Build system then include precompiled header file first
v1.6.0-linux,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.6.0-linux,"Windows, OSX and Linux."
v1.6.0-linux,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.6.0-linux,Windows users can move the Documents folder to any location they want
v1.6.0-linux,SHGetFolderPath knows how to find it.
v1.6.0-linux,fall back in case SHGetFolderPath failed for some reason.
v1.6.0-linux,convert from std::path '/' to windows backslash.
v1.6.0-linux,make the current thread run with maximum priority.
v1.6.0-linux,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.6.0-linux,TODO: How to handle POSIX thread priorities on OSX?
v1.6.0-linux,setThreadName is a helper function that is useful when debugging because your threads
v1.6.0-linux,show up in the debugger with the name you set which makes it easier to find the threads
v1.6.0-linux,that you are interested in.
v1.6.0-linux,"unfortunately this is only available on Windows 10, and AirSim is not limited to that."
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.6.0-linux,
v1.6.0-linux,Treat all errors as failure conditions.
v1.6.0-linux,parse command line
v1.6.0-linux,"motive gives a weird error if the project is not found, so we look for it."
v1.6.0-linux,Do an update to pick up any recently-arrived cameras.
v1.6.0-linux,List all detected cameras.
v1.6.0-linux,List all defined rigid bodies.
v1.6.0-linux,throttle to 50 messages per second.
v1.6.0-linux,OptiTrack uses 'y' axis for vertical.
v1.6.0-linux,stdafx.cpp : source file that includes just the standard includes
v1.6.0-linux,MavlinkMoCap.pch will be the pre-compiled header
v1.6.0-linux,stdafx.obj will contain the pre-compiled type information
v1.6.0-linux,TODO: reference any additional headers you need in STDAFX.H
v1.6.0-linux,and not in this file
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,PX4.cpp : Defines the entry point for the console application.
v1.6.0-linux,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.6.0-linux,how do you write to the debug output windows on Unix ?
v1.6.0-linux,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.6.0-linux,connection to create to talke to that server.
v1.6.0-linux,SITL setup info
v1.6.0-linux,The local ethernet interface to use (default localhost).
v1.6.0-linux,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.6.0-linux,server mode on UDP is when you want another app to connect to Pixhawk and publish data back to this process.
v1.6.0-linux,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.6.0-linux,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.6.0-linux,"using their the -qgc option.  Server mode on TCP means mavlinktest will do an ""accept"" socket which is"
v1.6.0-linux,what PX4 is waiting for when it is running in TCP mode.  Here the serverEndPoint is different from the
v1.6.0-linux,offboardEndPoint.  The serverEndPoint specifies which local address to use in case your computer has
v1.6.0-linux,multiple network interfaces.
v1.6.0-linux,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.6.0-linux,this switch controls whether we turn off the RC remote active link loss detection
v1.6.0-linux,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.6.0-linux,from kicking in when you try and fly.
v1.6.0-linux,parse the json
v1.6.0-linux,flatten inner mavlink object
v1.6.0-linux,flatten inner mavlink object
v1.6.0-linux,todo
v1.6.0-linux,todo
v1.6.0-linux,"const char* outLogFileOption = ""outlogfile"";"
v1.6.0-linux,parse command line
v1.6.0-linux,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.6.0-linux,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.6.0-linux,"no local serial connection, so this is the primary droneConnection."
v1.6.0-linux,need a retry loop here because we don't know how quickly px4 will start accepting these connections...
v1.6.0-linux,failed to connect
v1.6.0-linux,"then we need 2 mavlink channels, one for sending/receiving HIL_* messages and the other"
v1.6.0-linux,for controlling the drone.
v1.6.0-linux,this is the control channel.
v1.6.0-linux,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.6.0-linux,cmdTable.push_back(new AltHoldCommand());
v1.6.0-linux,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.6.0-linux,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.6.0-linux,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.6.0-linux,this stops us from being able to connect to SITL mode PX4.
v1.6.0-linux,checkPulse();
v1.6.0-linux,add command text in log
v1.6.0-linux,close previous command.
v1.6.0-linux,FilterLogFiles(logDirectory);
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,send a heartbeat
v1.6.0-linux,accept one incoming connection
v1.6.0-linux,send a heartbeat to the client
v1.6.0-linux,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.6.0-linux,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.6.0-linux,for this unit test we are expecting a request to send an image.
v1.6.0-linux,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.6.0-linux,hmmm
v1.6.0-linux,================ ls
v1.6.0-linux,================ put file
v1.6.0-linux,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.6.0-linux,================ get file
v1.6.0-linux,verify the file contents.
v1.6.0-linux,================ remove file
v1.6.0-linux,================ make directory
v1.6.0-linux,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.6.0-linux,================ remove directory
v1.6.0-linux,Now verification
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,you must call this method if you want HandleMessage to be called subsequently.
v1.6.0-linux,treat literals as one word
v1.6.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.6.0-linux,request gps info
v1.6.0-linux,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.6.0-linux,find relative position since command start so we can compare two commands better
v1.6.0-linux,"these PID values are important, so set these to match"
v1.6.0-linux,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.6.0-linux,we can skip ahead.
v1.6.0-linux,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.6.0-linux,TODO: avoid passing hadcoded HIL flag
v1.6.0-linux,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.6.0-linux,"The global position, as returned by the Global Positioning System (GPS)."
v1.6.0-linux,Provides state for additional features
v1.6.0-linux,The general system state
v1.6.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.6.0-linux,Provides state for additional features
v1.6.0-linux,The general system state
v1.6.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.6.0-linux,Provides state for additional features
v1.6.0-linux,The general system state
v1.6.0-linux,Provides state for additional features
v1.6.0-linux,The general system state
v1.6.0-linux,note: we do not reset com when Close() is called because we want to keep running.
v1.6.0-linux,"user has to invoke ""hil stop"" to stop the hil thread."
v1.6.0-linux,generate random between 0 and 1
v1.6.0-linux,move to range -1 to 1
v1.6.0-linux,scale it
v1.6.0-linux,apply iy
v1.6.0-linux,wait for the Execute method to be called.
v1.6.0-linux,gps is much slower frequency than IMU.
v1.6.0-linux,MAVLINK_MSG_ID_HIL_GPS
v1.6.0-linux,disable MAV_USEHILGPS
v1.6.0-linux,note: we do not reset com when Close() is called because we want to keep running.
v1.6.0-linux,"user has to invoke ""hil stop"" to stop the hil thread."
v1.6.0-linux,generate random between 0 and 1
v1.6.0-linux,move to range -1 to 1
v1.6.0-linux,scale it
v1.6.0-linux,apply iy
v1.6.0-linux,wait for the Execute method to be called.
v1.6.0-linux,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.6.0-linux,gps is much slower frequency than IMU.
v1.6.0-linux,MAVLINK_MSG_ID_HIL_GPS
v1.6.0-linux,disable HIL mode
v1.6.0-linux,Enumeration of landed detector states
v1.6.0-linux,MAV landed state is unknown
v1.6.0-linux,MAV is landed (on ground)
v1.6.0-linux,MAV is in air
v1.6.0-linux,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.6.0-linux,The filtered local position
v1.6.0-linux,must send these regularly to keep offboard control.
v1.6.0-linux,"ok, now we can safely switch to loiter."
v1.6.0-linux,must send these regularly to keep offboard control.
v1.6.0-linux,integrate the heading so it is smoother.
v1.6.0-linux,must send these regularly to keep offboard control.
v1.6.0-linux,integrate the heading so it is smoother.
v1.6.0-linux,fly to radius
v1.6.0-linux,it takes about 10 cm to stop and turn.
v1.6.0-linux,next time around switch to orbiting!
v1.6.0-linux,heading points to center of circle.
v1.6.0-linux,interpoloate the speed ramp up time over 2 seconds from start time
v1.6.0-linux,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.6.0-linux,monitor the sin curves so we can see how on track or off track it actually is.
v1.6.0-linux,the shape of the curve will also tell us if we are progressing at a consistent
v1.6.0-linux,"speed, the more deformed the sin curve the worse our progress."
v1.6.0-linux,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.6.0-linux,degrees just flipped from 359 to 0.
v1.6.0-linux,this enables us to test what happens when offboard control is lost and resumed.
v1.6.0-linux,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.6.0-linux,"ok, now we can start moving by velocity"
v1.6.0-linux,recompute to new target.
v1.6.0-linux,start by moving right with 10 degree roll.
v1.6.0-linux,haven't started yet.
v1.6.0-linux,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.6.0-linux,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.6.0-linux,track how our actual pitch is coming along compared to our target
v1.6.0-linux,and check position
v1.6.0-linux,the amount of pitch should depend on our speed in that direction.
v1.6.0-linux,passed the midpoint.
v1.6.0-linux,fade out the pitch as we pick up speed so we don't overshoot.
v1.6.0-linux,see if we just crossed the wiggle distance threshold.
v1.6.0-linux,(pitch affects the x-position).
v1.6.0-linux,reverse direction with a -30 degrees quick stop
v1.6.0-linux,reverse direction with a 30 degrees quick stop
v1.6.0-linux,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.6.0-linux,too much in that direction.
v1.6.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.6.0-linux,track how our actual roll is coming along compared to our target
v1.6.0-linux,and check position
v1.6.0-linux,the amount of roll should depend on our speed in that direction.
v1.6.0-linux,passed the midpoint.
v1.6.0-linux,fade out the roll as we pick up speed so we don't overshoot.
v1.6.0-linux,see if we just crossed the wiggle distance threshold.
v1.6.0-linux,(roll affects the y-position).
v1.6.0-linux,reverse direction with a -30 degrees quick stop
v1.6.0-linux,reverse direction with a 30 degrees quick stop
v1.6.0-linux,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.6.0-linux,too much in that direction.
v1.6.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.6.0-linux,for testing PID controller.
v1.6.0-linux,class AltHoldCommand : public Command
v1.6.0-linux,{
v1.6.0-linux,std::shared_ptr<MavLinkVehicle> channel;
v1.6.0-linux,"float sx_, sy_, sz_;"
v1.6.0-linux,MavLinkAttitudeTarget _current;
v1.6.0-linux,PidController thrust_controller_;
v1.6.0-linux,public:
v1.6.0-linux,this->sz_ = pos.z; // user defined target.
v1.6.0-linux,move to local position keeps the offboard control happy.
v1.6.0-linux,haven't started yet.
v1.6.0-linux,and check position
v1.6.0-linux,double dx = this->sx_ - pos.x;
v1.6.0-linux,double dy = this->sy_ - pos.y;
v1.6.0-linux,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.6.0-linux,too much in that direction.
v1.6.0-linux,adjust thrust so we keep steady height target
v1.6.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.6.0-linux,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.6.0-linux,local remote
v1.6.0-linux,already handled by the parse method.
v1.6.0-linux,we only support very simple patterns for now.
v1.6.0-linux,each wildcard must be separated by literal.
v1.6.0-linux,back to back wildcards with no literal in between is too complex.
v1.6.0-linux,"we only support simple matching for now, we can add full regex later if we need it."
v1.6.0-linux,yep!
v1.6.0-linux,'*' is done we found the next matching char
v1.6.0-linux,this is ok.
v1.6.0-linux,this is an ERASE_END_LINE command which we ignore.
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,pack the payload buffer.
v1.6.0-linux,calculate checksum
v1.6.0-linux,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.6.0-linux,are variable length as a result.
v1.6.0-linux,form the header as a byte array for the crc
v1.6.0-linux,unpack the message...
v1.6.0-linux,pack the payload buffer.
v1.6.0-linux,"json can't handle ""nan"", so we convert it to null."
v1.6.0-linux,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.6.0-linux,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,start listening to this connection
v1.6.0-linux,Send heartbeat to drone.  You should not do this if some other node is
v1.6.0-linux,already doing it.
v1.6.0-linux,stop listening to the connection.
v1.6.0-linux,get the connection
v1.6.0-linux,Get the local system and component id
v1.6.0-linux,send a command to the remote node
v1.6.0-linux,MavLinkNode::MavLinkNode() = default;
v1.6.0-linux,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.6.0-linux,decrementing the count so the next WaitOne may block.
v1.6.0-linux,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.6.0-linux,convert to absolute time.
v1.6.0-linux,use mach_timespec
v1.6.0-linux,convert to absolute time.
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,return true if we still have offboard control (can lose this if user flips the switch).
v1.6.0-linux,MavLinkVehicle::MavLinkVehicle() = default;
v1.6.0-linux,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.6.0-linux,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,============================== CLIENT ============================================
v1.6.0-linux,image APIs
v1.6.0-linux,or if you are implementing the client side call this function to get the most recent frame.
v1.6.0-linux,returns false if there is no new frame available.
v1.6.0-linux,============================== SERVER ============================================
v1.6.0-linux,call this to send the image back over the connection given to start function.
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,"log every message that is ""sent"" using sendMessage."
v1.6.0-linux,"log every message that is ""received"""
v1.6.0-linux,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.6.0-linux,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.6.0-linux,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.6.0-linux,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,for compatibility with QGroundControl we have to save the time field in big endian.
v1.6.0-linux,todo: mavlink2 support?
v1.6.0-linux,has to be one or the other!
v1.6.0-linux,24 bits.
v1.6.0-linux,24 bits.
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,start listening to this connection
v1.6.0-linux,Send heartbeat to drone.  You should not do this if some other node is
v1.6.0-linux,already doing it.
v1.6.0-linux,this is called for all messages received on the connection.
v1.6.0-linux,"we received a heartbeat, so let's get the capabilities."
v1.6.0-linux,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.6.0-linux,subclasses remembering to call this base implementation.
v1.6.0-linux,stop listening to the connection.
v1.6.0-linux,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.6.0-linux,wait for a heartbeat msg since this will give us the port to send commands to...
v1.6.0-linux,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.6.0-linux,send a heart beat so that the remote node knows we are still alive
v1.6.0-linux,(otherwise drone will trigger a failsafe operation).
v1.6.0-linux,ignore any failures here because we are running in our own thread here.
v1.6.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.6.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.6.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.6.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.6.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.6.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.6.0-linux,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.6.0-linux,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.6.0-linux,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.6.0-linux,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.6.0-linux,"ok, now fetch the missing parameters."
v1.6.0-linux,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.6.0-linux,silently fail since we are on a background thread here...
v1.6.0-linux,tell the caller this is complete.
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,add our custom telemetry message length.
v1.6.0-linux,todo: if we support signing then initialize
v1.6.0-linux,mavlink_intermediate_status_.signing callbacks
v1.6.0-linux,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.6.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.6.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.6.0-linux,send this right away just in case serial link is not already configured
v1.6.0-linux,"log every message that is ""sent"" using sendMessage."
v1.6.0-linux,"log every message that is ""sent"" using sendMessage."
v1.6.0-linux,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.6.0-linux,pack the payload buffer.
v1.6.0-linux,calculate checksum
v1.6.0-linux,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.6.0-linux,are variable length as a result.
v1.6.0-linux,form the header as a byte array for the crc
v1.6.0-linux,these macros use old style cast.
v1.6.0-linux,forward messages from our connected node to the remote proxy.
v1.6.0-linux,tell the remote connection to expect mavlink2 messages.
v1.6.0-linux,forward messages from remote proxy to local connected node
v1.6.0-linux,CurrentThread::setMaximumPriority();
v1.6.0-linux,"hmmm, wait till it is opened?"
v1.6.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.6.0-linux,pick up the sysid/compid of the remote node we are connected to.
v1.6.0-linux,then this is a mavlink 1 message
v1.6.0-linux,then this mavlink sender supports mavlink 2
v1.6.0-linux,queue event for publishing.
v1.6.0-linux,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.6.0-linux,as it ensures we don't lose messages if the listener is slow.
v1.6.0-linux,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.6.0-linux,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.6.0-linux,we would get a deadlock.
v1.6.0-linux,CurrentThread::setMaximumPriority();
v1.6.0-linux,reset counters
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,------------------------------------------------------------------------------
v1.6.0-linux,Defines
v1.6.0-linux,------------------------------------------------------------------------------
v1.6.0-linux,bit number  876543210987654321
v1.6.0-linux,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.6.0-linux,in future it would be good to have ability to add system IDs we are interested in
v1.6.0-linux,if (msg.sysid != getTargetSystemId())
v1.6.0-linux,{
v1.6.0-linux,// we only care about messages from our intended remote node.
v1.6.0-linux,return;
v1.6.0-linux,}
v1.6.0-linux,user may have changed modes on us! So we need to honor that and not
v1.6.0-linux,try and take it back.
v1.6.0-linux,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.6.0-linux,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.6.0-linux,we can store up to 16 channels in rc_channels_scaled.
v1.6.0-linux,The RAW values of the servo outputs
v1.6.0-linux,Metrics typically displayed on a HUD for fixed wing aircraft
v1.6.0-linux,The IMU readings in SI units in NED body frame
v1.6.0-linux,printSystemStatus(&msg);
v1.6.0-linux,todo: use this to determine when we need to do emergency landing...
v1.6.0-linux,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.6.0-linux,Provides state for additional features
v1.6.0-linux,The general system state
v1.6.0-linux,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.6.0-linux,but we do want to know when we get the ack.  So this is async ACK processing!
v1.6.0-linux,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.6.0-linux,if threshold < 0 then the threshold is inverted.
v1.6.0-linux,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.6.0-linux,Convert it to a floating point number between -1 and 1.
v1.6.0-linux,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.6.0-linux,until the move commands start happening.
v1.6.0-linux,return true if user calls requestControl and has not called releaseControl.
v1.6.0-linux,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.6.0-linux,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.6.0-linux,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.6.0-linux,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.6.0-linux,send a few to make sure it gets through...
v1.6.0-linux,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.6.0-linux,us by which time the PX4 times out offboard mode!!
v1.6.0-linux,"assume this was successful, we'll find out if so in the next heartbeat."
v1.6.0-linux,this mode change take precedence over offboard mode.
v1.6.0-linux,thrust must be between -1 and 1.
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,These definitions are copied from PX4 implementation
v1.6.0-linux,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.6.0-linux,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.6.0-linux,/ @brief Command opcodes
v1.6.0-linux,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.6.0-linux,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.6.0-linux,must trim trailing slashes so PX4 doesn't hang!
v1.6.0-linux,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.6.0-linux,from the source.
v1.6.0-linux,check if directory exists.
v1.6.0-linux,perfect.
v1.6.0-linux,use last_message_ so we preserve the sessionid.
v1.6.0-linux,"could not create the local file, so stop."
v1.6.0-linux,must use last_message_ so we preserve the session id.
v1.6.0-linux,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.6.0-linux,todo: error handling here? sequence is out of order...
v1.6.0-linux,"directory must be empty then, can't do nextStep because"
v1.6.0-linux,it will just loop for ever re-requesting zero offset into
v1.6.0-linux,empty directory.
v1.6.0-linux,result should be a list of null terminated file names.
v1.6.0-linux,skipping this entry
v1.6.0-linux,remove the file size field.
v1.6.0-linux,"printf(""%s\n"", name.c_str());"
v1.6.0-linux,request the next batch.
v1.6.0-linux,"perhaps this was a late response after we did a retry, so ignore it."
v1.6.0-linux,"perhaps this was a late response after we did a retry, so ignore it."
v1.6.0-linux,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.6.0-linux,reached the end of the list or the file.
v1.6.0-linux,end of file or directory listing.
v1.6.0-linux,"success, data should be following..."
v1.6.0-linux,ack on this cmd is a noop
v1.6.0-linux,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.6.0-linux,give up then.
v1.6.0-linux,tell watchdog we are sending a request
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,================================= CLIENT ==============================================================
v1.6.0-linux,Check if we have a valid transaction
v1.6.0-linux,emit signal if all packets arrived
v1.6.0-linux,Restart statemachine
v1.6.0-linux,image APIs
v1.6.0-linux,================================= SERVER ==============================================================
v1.6.0-linux,Prepare and send acknowledgment packet
v1.6.0-linux,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.6.0-linux,Send ENCAPSULATED_IMAGE packet
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.6.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.6.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.6.0-linux,send this right away just in case serial link is not already configured
v1.6.0-linux,CurrentThread::setMaximumPriority();
v1.6.0-linux,"hmmm, wait till it is opened?"
v1.6.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.6.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.6.0-linux,queue event for publishing.
v1.6.0-linux,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.6.0-linux,as it ensures we don't lose messages if the listener is slow.
v1.6.0-linux,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.6.0-linux,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.6.0-linux,we would get a deadlock.
v1.6.0-linux,CurrentThread::setMaximumPriority();
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.6.0-linux,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.6.0-linux,parse out the VID number
v1.6.0-linux,now the PID
v1.6.0-linux,parse out the VID number
v1.6.0-linux,examples:
v1.6.0-linux,PX4: USB\VID_26AC&PID_0011\0
v1.6.0-linux,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.6.0-linux,"printf(""Found: %S\n"", buffer.c_str());"
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.6.0-linux,parse out the VID number
v1.6.0-linux,now the PID
v1.6.0-linux,parse out the VID number
v1.6.0-linux,suppress
v1.6.0-linux,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,This has not been properly tested
v1.6.0-linux,struct iw_statistics stats;
v1.6.0-linux,struct iwreq req;
v1.6.0-linux,"memset(&stats, 0, sizeof(stats));"
v1.6.0-linux,"memset(&req, 0, sizeof(iwreq));"
v1.6.0-linux,
v1.6.0-linux,"strncpy(req.ifr_name, ifaceName, 16);"
v1.6.0-linux,req.u.data.pointer = &stats;
v1.6.0-linux,req.u.data.length = sizeof(iw_statistics);
v1.6.0-linux,
v1.6.0-linux,#ifdef CLEAR_UPDATED
v1.6.0-linux,req.u.data.flags = 1;
v1.6.0-linux,#endif
v1.6.0-linux,
v1.6.0-linux,/* Perform the ioctl */
v1.6.0-linux,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.6.0-linux,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.6.0-linux,return -127;
v1.6.0-linux,}
v1.6.0-linux,
v1.6.0-linux,return stats.qual.level;
v1.6.0-linux,todo: windows version of this...
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,windows
v1.6.0-linux,Need to link with Ws2_32.lib
v1.6.0-linux,posix
v1.6.0-linux,found it!
v1.6.0-linux,This timeout is important as it allows the MavLinkConnection readPackets
v1.6.0-linux,thread to iterate and notice the connection is now closed. This allows
v1.6.0-linux,AirSim to shutdown properly when drone is not connected.
v1.6.0-linux,bind socket to local address.
v1.6.0-linux,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.6.0-linux,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.6.0-linux,try and reconnect
v1.6.0-linux,write to the serial port
v1.6.0-linux,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.6.0-linux,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.6.0-linux,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.6.0-linux,"try and receive something, up until port is closed anyway."
v1.6.0-linux,"message was too large for the buffer, no problem, return what we have."
v1.6.0-linux,try again - this can happen if server recreates the socket on their side.
v1.6.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.6.0-linux,"skip this, the receive just timed out, no problem, we'll try again later."
v1.6.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.6.0-linux,"printf(""#### recv failed with error: %d\n"", hr);"
v1.6.0-linux,we now have it.
v1.6.0-linux,this is from someone we are not interested in.
v1.6.0-linux,-----------------------------------------------------------------------------------------
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,Initialize Winsock
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,windows
v1.6.0-linux,Need to link with Ws2_32.lib
v1.6.0-linux,posix
v1.6.0-linux,found it!
v1.6.0-linux,bind socket to local address.
v1.6.0-linux,bind socket to local address.
v1.6.0-linux,start listening for incoming connection
v1.6.0-linux,accept 1
v1.6.0-linux,"don't need to accept any more, so we can close this one."
v1.6.0-linux,write to the serial port
v1.6.0-linux,"try and receive something, up until port is closed anyway."
v1.6.0-linux,"message was too large for the buffer, no problem, return what we have."
v1.6.0-linux,try again - this can happen if server recreates the socket on their side.
v1.6.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.6.0-linux,try again - this can happen if server recreates the socket on their side.
v1.6.0-linux,-----------------------------------------------------------------------------------------
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.6.0-linux,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.6.0-linux,set signal
v1.6.0-linux,Clear Handshake flags
v1.6.0-linux,Set Handshake flags
v1.6.0-linux,return GetLastError();
v1.6.0-linux,return GetLastError();
v1.6.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.6.0-linux,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.6.0-linux,enable reading
v1.6.0-linux,posix doesn't have mark/space parity.
v1.6.0-linux,posix doesn't have mark/space parity.
v1.6.0-linux,this is the default.
v1.6.0-linux,not sure this is supported...
v1.6.0-linux,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.6.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.6.0-linux,First do those specified by POSIX.
v1.6.0-linux,Now conditionally handle a bunch of extended rates.
v1.6.0-linux,First do those specified by POSIX.
v1.6.0-linux,Now conditionally handle a bunch of extended rates.
v1.6.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.6.0-linux,import airsim
v1.6.0-linux,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v1.6.0-linux,self.args = args
v1.6.0-linux,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v1.6.0-linux,pdb.set_trace()
v1.6.0-linux,#include <pluginlib/class_list_macros.h>
v1.6.0-linux,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v1.6.0-linux,todo do not reset if already in air?
v1.6.0-linux,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.6.0-linux,ros params
v1.6.0-linux,todo enforce dynamics constraints in this node as well?
v1.6.0-linux,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v1.6.0-linux,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v1.6.0-linux,XmlRpc::XmlRpcValue can't be const in this case
v1.6.0-linux,subscribe to control commands on global nodehandle
v1.6.0-linux,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.6.0-linux,bind to a single callback. todo optimal subs queue length
v1.6.0-linux,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.6.0-linux,"vehicle_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.6.0-linux,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.6.0-linux,camera_setting.gimbal
v1.6.0-linux,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.6.0-linux,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.6.0-linux,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.6.0-linux,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.6.0-linux,"if {DepthPlanar, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.6.0-linux,"push back pair (vector of image captures, current vehicle name)"
v1.6.0-linux,iterate over sensors
v1.6.0-linux,"we want fast access to the lidar sensors for callback handling, sort them out now"
v1.6.0-linux,add takeoff and land all services if more than 2 drones
v1.6.0-linux,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v1.6.0-linux,todo add per vehicle reset in AirLib API
v1.6.0-linux,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.6.0-linux,lidars update on their own callback/thread at a given rate
v1.6.0-linux,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v1.6.0-linux,"todo: error check. if state is not landed, return error."
v1.6.0-linux,response.success =
v1.6.0-linux,response.success =
v1.6.0-linux,response.success =
v1.6.0-linux,response.success =
v1.6.0-linux,response.success =
v1.6.0-linux,response.success =
v1.6.0-linux,todo add reset by vehicle_name API to airlib
v1.6.0-linux,todo not async remove waitonlasttask
v1.6.0-linux,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v1.6.0-linux,todo do actual body frame?
v1.6.0-linux,airsim uses degrees
v1.6.0-linux,todo do actual body frame?
v1.6.0-linux,airsim uses degrees
v1.6.0-linux,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v1.6.0-linux,todo expose waitOnLastTask or nah?
v1.6.0-linux,todo do actual body frame?
v1.6.0-linux,airsim uses degrees
v1.6.0-linux,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.6.0-linux,todo expose waitOnLastTask or nah?
v1.6.0-linux,todo support multiple gimbal commands
v1.6.0-linux,todo support multiple gimbal commands
v1.6.0-linux,1. find quaternion of default gimbal pose
v1.6.0-linux,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.6.0-linux,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.6.0-linux,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.6.0-linux,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.6.0-linux,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.6.0-linux,msg = []
v1.6.0-linux,todo covariances
v1.6.0-linux,gps_msg.position_covariance_type =
v1.6.0-linux,gps_msg.position_covariance =
v1.6.0-linux,todo covariances
v1.6.0-linux,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.6.0-linux,todo radians per second
v1.6.0-linux,meters/s2^m
v1.6.0-linux,imu_msg.orientation_covariance = ;
v1.6.0-linux,imu_msg.angular_velocity_covariance = ;
v1.6.0-linux,imu_msg.linear_acceleration_covariance = ;
v1.6.0-linux,airsim appears to use chrono::system_clock with nanosecond precision
v1.6.0-linux,todo this is global origin
v1.6.0-linux,get the basic vehicle pose and environmental state
v1.6.0-linux,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.6.0-linux,airsim_client needs to provide the simulation time in a future version of the API
v1.6.0-linux,publish the simulation clock
v1.6.0-linux,"publish vehicle state, odom, and all basic sensor types"
v1.6.0-linux,send any commands out to the vehicles
v1.6.0-linux,"should be easier way to get the sim time through API, something like:"
v1.6.0-linux,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.6.0-linux,curr_ros_time = airsim_timestamp_to_ros(env.clock().nowNanos());
v1.6.0-linux,iterate over drones
v1.6.0-linux,get drone state from airsim
v1.6.0-linux,"vehicle environment, we can get ambient temperature here and other truths"
v1.6.0-linux,convert airsim drone state to ROS msgs
v1.6.0-linux,simulation environment truth
v1.6.0-linux,"dashboard reading from car, RPM, gear, etc"
v1.6.0-linux,odom and transforms
v1.6.0-linux,ground truth GPS position from sim/HITL
v1.6.0-linux,handled via callback
v1.6.0-linux,send control commands from the last callback to airsim
v1.6.0-linux,send control commands from the last callback to airsim
v1.6.0-linux,"Only camera rotation, no translation movement of camera"
v1.6.0-linux,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.6.0-linux,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.6.0-linux,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.6.0-linux,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.6.0-linux,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.6.0-linux,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.6.0-linux,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.6.0-linux,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.6.0-linux,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.6.0-linux,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.6.0-linux,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.6.0-linux,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.6.0-linux,update timestamp of saved cam info msgs
v1.6.0-linux,DepthPlanar / DepthPerspective / DepthVis / DisparityNormalized
v1.6.0-linux,Scene / Segmentation / SurfaceNormals / Infrared
v1.6.0-linux,publish camera transforms
v1.6.0-linux,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.6.0-linux,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.6.0-linux,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.6.0-linux,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.6.0-linux,ROS params
v1.6.0-linux,ROS publishers
v1.6.0-linux,ROS subscribers
v1.6.0-linux,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.6.0-linux,ROS timers
v1.6.0-linux,todo maintain internal representation as eigen vec?
v1.6.0-linux,todo check if low velocity if within thresh?
v1.6.0-linux,todo maintain separate errors for XY and Z
v1.6.0-linux,todo save this in degrees somewhere to avoid repeated conversion
v1.6.0-linux,this tells the update timer callback to not do active hovering
v1.6.0-linux,todo maintain array of position goals
v1.6.0-linux,todo error checks
v1.6.0-linux,todo fill response
v1.6.0-linux,"Already have goal, and have reached it"
v1.6.0-linux,this tells the update timer callback to not do active hovering
v1.6.0-linux,todo error checks
v1.6.0-linux,todo fill response
v1.6.0-linux,"todo do relative altitude, or add an option for the same?"
v1.6.0-linux,convert GPS goal to NED goal
v1.6.0-linux,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.6.0-linux,todo error checks
v1.6.0-linux,todo fill response
v1.6.0-linux,"Already have goal, this shouldn't happen"
v1.6.0-linux,"todo do relative altitude, or add an option for the same?"
v1.6.0-linux,convert GPS goal to NED goal
v1.6.0-linux,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.6.0-linux,todo error checks
v1.6.0-linux,todo fill response
v1.6.0-linux,todo check if odometry is too old!!
v1.6.0-linux,"if no odom, don't do anything."
v1.6.0-linux,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.6.0-linux,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.6.0-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.6.0-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.6.0-linux,todo yaw limits
v1.6.0-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.6.0-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.6.0-linux,mimics void ASimHUD::initializeSettings()
v1.6.0-linux,int num_threads = 1;
v1.6.0-linux,ros::MultiThreadedSpinner multi_thread(num_threads);
v1.6.0-linux,multi_thread.spin();
v1.6.0-linux,ros::AsyncSpinner async_spinner(num_threads);
v1.6.0-linux,async_spinner.start();
v1.6.0-linux,single threaded spinner
v1.6.0-linux,connect to the AirSim simulator
v1.6.0-linux,","
v1.6.0-linux,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.6.0-linux,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,"in header only mode, control library is not available"
v1.6.0-linux,TODO: something defines max macro which interfears with code here
v1.6.0-linux,is cur_pos within fence?
v1.6.0-linux,destination risk is not available then consider it zero
v1.6.0-linux,if dest risk is lower than its more safe
v1.6.0-linux,are we doing better than closest obstacle?
v1.6.0-linux,"if we stay where we are, what is the risk distance?"
v1.6.0-linux,else we are better of moving to dest
v1.6.0-linux,this function should work even when dest_pos == cur_pos
v1.6.0-linux,is this dest_pos cur_pos within the fence?
v1.6.0-linux,transform dest_pos vector to body frame
v1.6.0-linux,check for approx zero vectors to avoid random yaw angles
v1.6.0-linux,we are hovering
v1.6.0-linux,"get yaw in body frame, ie, front is always 0 radians"
v1.6.0-linux,yaw to ticks
v1.6.0-linux,get obstacles in the window at the tick direction around the window
v1.6.0-linux,less risk distance is better
v1.6.0-linux,check obstacles around current position and see if it has lower risk
v1.6.0-linux,else obstacle is too far
v1.6.0-linux,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.6.0-linux,look for each surrounding tick to see if we have obstacle free angle
v1.6.0-linux,else no suggestions required
v1.6.0-linux,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.6.0-linux,evaluate right and left side of circle
v1.6.0-linux,find right and left risk distances
v1.6.0-linux,at this point we have already determined hover is better than going to dest
v1.6.0-linux,we now determine is moving to suggested angle better than hovering?
v1.6.0-linux,check if dest_pos is safe
v1.6.0-linux,breaking distance at this velocity
v1.6.0-linux,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.6.0-linux,check if dest_pos is safe
v1.6.0-linux,float/vec parameters can have NaN which makes them optional
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,"in header only mode, control library is not available"
v1.6.0-linux,handles +/- tick and wraps around circle
v1.6.0-linux,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.6.0-linux,update the specified window on the map
v1.6.0-linux,make sure from <= to
v1.6.0-linux,normalize the ticks so both are valid indices
v1.6.0-linux,if from is still larger then
v1.6.0-linux,to ticks is then added one full circle to make it larger than from_tick
v1.6.0-linux,find closest obstacle in given window
v1.6.0-linux,search whole map to find closest obstacle
v1.6.0-linux,"in header only mode, control library is not available"
v1.6.0-linux,#include <fileapi.h>
v1.6.0-linux,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.6.0-linux,"Windows, OSX and Linux."
v1.6.0-linux,Windows users can move the Documents folder to any location they want
v1.6.0-linux,SHGetFolderPath knows how to find it.
v1.6.0-linux,fall back in case SHGetFolderPath failed for some reason.
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,"in header only mode, control library is not available"
v1.6.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.6.0-linux,if using Unreal Build system then include precompiled header file first
v1.6.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.6.0-linux,this deadlocks UI thread if async_run was called while there are pending rpc calls.
v1.6.0-linux,Exit if already resetting.
v1.6.0-linux,Reset
v1.6.0-linux,if we don't suppress then server will bomb out for exceptions raised by any method
v1.6.0-linux,required for pimpl
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,"in header only mode, control library is not available"
v1.6.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.6.0-linux,if using Unreal Build system then include precompiled header file first
v1.6.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.6.0-linux,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.6.0-linux,make sure we can talk to the DroneServer
v1.6.0-linux,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.6.0-linux,command_context.client.ping();
v1.6.0-linux,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.6.0-linux,sim only
v1.6.0-linux,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.6.0-linux,"Minor TODO: consider msgpack magic for GeoPoint, so we can have one arg instead of three"
v1.6.0-linux,Convert
v1.6.0-linux,return value of last task. It should be true if task completed without
v1.6.0-linux,cancellation or timeout
v1.6.0-linux,"should be implemented by derived class if it supports async task,"
v1.6.0-linux,for example using futures
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,"in header only mode, control library is not available"
v1.6.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.6.0-linux,if using Unreal Build system then include precompiled header file first
v1.6.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,"in header only mode, control library is not available"
v1.6.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.6.0-linux,if using Unreal Build system then include precompiled header file first
v1.6.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.6.0-linux,required for pimpl
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,"in header only mode, control library is not available"
v1.6.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.6.0-linux,if using Unreal Build system then include precompiled header file first
v1.6.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.6.0-linux,status getters
v1.6.0-linux,Rotor state getter
v1.6.0-linux,Multirotor state getter
v1.6.0-linux,return value of last task. It should be true if task completed without
v1.6.0-linux,cancellation or timeout
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,"in header only mode, control library is not available"
v1.6.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.6.0-linux,if using Unreal Build system then include pre-compiled header file first
v1.6.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.6.0-linux,getters
v1.6.0-linux,Rotor state
v1.6.0-linux,Multirotor state
v1.6.0-linux,required for pimpl
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,"in header only mode, control library is not available"
v1.6.0-linux,last command is to hold on to position
v1.6.0-linux,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.6.0-linux,after landing we detect if drone has stopped moving
v1.6.0-linux,validate path size
v1.6.0-linux,validate yaw mode
v1.6.0-linux,validate and set auto-lookahead value
v1.6.0-linux,if auto mode requested for lookahead then calculate based on velocity
v1.6.0-linux,add current position as starting point
v1.6.0-linux,append the input path and compute segments
v1.6.0-linux,add last segment as zero length segment so we have equal number of segments and points.
v1.6.0-linux,path_segs[i] refers to segment that starts at point i
v1.6.0-linux,"when path ends, we want to slow down"
v1.6.0-linux,else no need to change velocities for last segments
v1.6.0-linux,setup current position on path to 0 offset
v1.6.0-linux,initialize next path position
v1.6.0-linux,until we are at the end of the path (last seg is always zero size)
v1.6.0-linux,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.6.0-linux,send drone command to get to next lookahead
v1.6.0-linux,sleep for rest of the cycle
v1.6.0-linux,how much have we moved towards last goal?
v1.6.0-linux,project actual vector on goal vector
v1.6.0-linux,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.6.0-linux,TODO: below should be lower than 1E3 and configurable
v1.6.0-linux,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.6.0-linux,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.6.0-linux,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.6.0-linux,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.6.0-linux,"if drone moved backward, we don't want goal to move backward as well"
v1.6.0-linux,"so only climb forward on the path, never back. Also note >= which means"
v1.6.0-linux,we climb path even if distance was 0 to take care of duplicated points on path
v1.6.0-linux,else
v1.6.0-linux,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.6.0-linux,compute next target on path
v1.6.0-linux,freeze the quaternion
v1.6.0-linux,convert RC commands to velocity vector
v1.6.0-linux,find yaw as per terrain and remote setting
v1.6.0-linux,execute command
v1.6.0-linux,if timeout occurred then command completed successfully otherwise it was interrupted
v1.6.0-linux,yaw is not within margin
v1.6.0-linux,by default we say that this command is not supported
v1.6.0-linux,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.6.0-linux,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.6.0-linux,get trims
v1.6.0-linux,take average
v1.6.0-linux,validate dest
v1.6.0-linux,what is the distance we will travel at this velocity?
v1.6.0-linux,get velocity vector
v1.6.0-linux,yaw for the direction of travel
v1.6.0-linux,find velocity vector
v1.6.0-linux,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.6.0-linux,generate velocity vector that is same size as cur_dest_norm / command period
v1.6.0-linux,this velocity vect when executed for command period would yield cur_dest_norm
v1.6.0-linux,send commands
v1.6.0-linux,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.6.0-linux,default strategy is for move. In hover mode we set new strategy temporarily
v1.6.0-linux,are we supposed to do EM?
v1.6.0-linux,get suggested velocity vector
v1.6.0-linux,use the unchecked command
v1.6.0-linux,tell caller not to execute planned command
v1.6.0-linux,other wise throw exception
v1.6.0-linux,otherwise there is some other reason why we are in unsafe situation
v1.6.0-linux,send last command to come to full stop
v1.6.0-linux,else no unsafe situation
v1.6.0-linux,note: cur_path_loc and next_path_loc may both point to same object
v1.6.0-linux,"otherwise use up this segment, move on to next one"
v1.6.0-linux,if we are here then we ran out of segments
v1.6.0-linux,consider last segment as zero length segment
v1.6.0-linux,adjust yaw for the direction of travel in forward-only mode
v1.6.0-linux,else no adjustment needed
v1.6.0-linux,if auto mode requested for lookahead then calculate based on velocity
v1.6.0-linux,Create a spring arm component for our chase camera
v1.6.0-linux,"do nothing, spring arm is pulling the camera with it"
v1.6.0-linux,"do nothing, we have camera turned off"
v1.6.0-linux,set initial view mode
v1.6.0-linux,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.6.0-linux,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.6.0-linux,"If the lag is missing, the camera will also occasionally shake."
v1.6.0-linux,"But, lag is not desired when piloting a drone"
v1.6.0-linux,attach spring arm to actor
v1.6.0-linux,remember current parent for external camera. Later when we remove external
v1.6.0-linux,"camera from spring arm, we will attach it back to its last parent"
v1.6.0-linux,now attach camera to spring arm
v1.6.0-linux,"For car, we need to move the camera back a little more than for a drone."
v1.6.0-linux,"Otherwise, the camera will be stuck inside the car"
v1.6.0-linux,ExternalCamera->bUsePawnControlRotation = false;
v1.6.0-linux,detach spring arm
v1.6.0-linux,Re-enable rendering
v1.6.0-linux,Remove any existing key bindings for manual mode
v1.6.0-linux,"else someone else is bound to manual pose controller, leave it alone"
v1.6.0-linux,if new mode is manual mode then add key bindings
v1.6.0-linux,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.6.0-linux,other modes don't need special setup
v1.6.0-linux,make switch official
v1.6.0-linux,Add loading screen to viewport
v1.6.0-linux,Remove Loading screen from viewport
v1.6.0-linux,Create struct for Location and Rotation of actor in Unreal
v1.6.0-linux,new_actor_spawn_params.NameMode = FActorSpawnParameters::ESpawnActorNameMode::Required_ReturnNull;
v1.6.0-linux,Write the binvox file using run-length encoding
v1.6.0-linux,"where each pair of bytes is of the format (run value, run length)"
v1.6.0-linux,This is a run (repeated bit value)
v1.6.0-linux,End of a run
v1.6.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.6.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.6.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.6.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.6.0-linux,Split the tag string into individual tags.
v1.6.0-linux,Texture swap on actors that have all of those tags.
v1.6.0-linux,----------- Plotting APIs ----------/
v1.6.0-linux,"plot line for points 0-1, 1-2, 2-3"
v1.6.0-linux,"plot line for points 0-1, 2-3, 4-5... must be even number of points"
v1.6.0-linux,assert points_start.size() == poinst_end.size()
v1.6.0-linux,assert positions.size() == strings.size()
v1.6.0-linux,assert poses.size() == names.size()
v1.6.0-linux,Recording APIs
v1.6.0-linux,"Remove '' from the list, representing default vehicle"
v1.6.0-linux,"We need to run this code on the main game thread, since it iterates over actors"
v1.6.0-linux,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.6.0-linux,"No LOS, so draw red line"
v1.6.0-linux,"Yes LOS, so draw green line"
v1.6.0-linux,"We need to run this code on the main game thread, since it iterates over actors"
v1.6.0-linux,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.6.0-linux,Testing actor enum for world bounds...
v1.6.0-linux,"Same as with the Object Iterator, access the subclass instance with the * or -> operators."
v1.6.0-linux,"TODO think more about how best to determine/indicate ground level, if anyone cares"
v1.6.0-linux,Convert Uvectors to LLAs
v1.6.0-linux,Fill out your copyright notice in the Description page of Project Settings.
v1.6.0-linux,"Set this component to be initialized when the game starts, and to be ticked every frame.  You can turn these features"
v1.6.0-linux,off to improve performance if you don't need them.
v1.6.0-linux,get render target for texture size
v1.6.0-linux,initialize viewinfo for projection matrix
v1.6.0-linux,calculate 3D corner Points of bounding box
v1.6.0-linux,initialize pixel values
v1.6.0-linux,initialize projection data for sceneview
v1.6.0-linux,do some voodoo rotation that is somehow mandatory and stolen from UGameplayStatics::ProjectWorldToScreen
v1.6.0-linux,Project Points to pixels and get the corner pixels
v1.6.0-linux,If actor in camera view - check if it's actually visible or hidden
v1.6.0-linux,Check against 8 extend points
v1.6.0-linux,"If actor in camera view but didn't hit any point out of 8 extend points,"
v1.6.0-linux,check against 10 random points
v1.6.0-linux,by default all image types are disabled
v1.6.0-linux,use final color for all calculations
v1.6.0-linux,TODO: avoid the need to override const cast here
v1.6.0-linux,if the viewport is taller than it is wide
v1.6.0-linux,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v1.6.0-linux,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v1.6.0-linux,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v1.6.0-linux,use final color for all calculations
v1.6.0-linux,TODO: should we be ignoring position and orientation settings here?
v1.6.0-linux,TODO: can we eliminate storing NedTransform?
v1.6.0-linux,if (!std::isnan(setting.target_gamma))
v1.6.0-linux,camera-> = setting.target_gamma;
v1.6.0-linux,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.6.0-linux,else nothing to enable
v1.6.0-linux,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.6.0-linux,if (controller && controller->GetViewTarget() == this)
v1.6.0-linux,controller->SetViewTarget(nullptr);
v1.6.0-linux,"Check whether requested map exists, this could be very slow if LevelName is a short package name"
v1.6.0-linux,Create Unique Name for sub-level package
v1.6.0-linux,Setup streaming level object that will load specified map
v1.6.0-linux,Transform
v1.6.0-linux,Map to Load
v1.6.0-linux,Add the new level to world.
v1.6.0-linux,TODO: explore screenshot option
v1.6.0-linux,addScreenCaptureHandler(camera->GetWorld());
v1.6.0-linux,TODO: may be we should have these methods non-const?
v1.6.0-linux,We don't do game/render thread synchronization for safe method.
v1.6.0-linux,We just blindly sleep for 200ms (the old way)
v1.6.0-linux,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.6.0-linux,Make sure that all alpha values are opaque.
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,TODO: change naming conventions to same as other files?
v1.6.0-linux,"context->GetWorld()->SetNewWorldOrigin(FIntVector(0, 0, 0));"
v1.6.0-linux,Enable/disable primary viewport rendering flag
v1.6.0-linux,This disables rendering of the main viewport in the same way as the
v1.6.0-linux,"console command ""show rendering"" would do."
v1.6.0-linux,"When getting an image through the API, the image is produced after the render"
v1.6.0-linux,thread has finished rendering the current and the subsequent frame. This means
v1.6.0-linux,that the frame rate for obtaining images through the API is only half as high as
v1.6.0-linux,"it could be, since only every other image is actually captured. We work around"
v1.6.0-linux,this by telling the viewport to flush the rendering queue at the end of each
v1.6.0-linux,drawn frame so that it executes our render request at that point already.
v1.6.0-linux,Do this only if the main viewport is not being rendered anyway in case there are
v1.6.0-linux,any adverse performance effects during main rendering.
v1.6.0-linux,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v1.6.0-linux,nothing to do for now
v1.6.0-linux,"if hidden, clear any existing messages"
v1.6.0-linux,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.6.0-linux,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.6.0-linux,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.6.0-linux,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.6.0-linux,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.6.0-linux,Find mesh in /Game and /AirSim asset registry. When more plugins are added this function will have to change
v1.6.0-linux,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.6.0-linux,{
v1.6.0-linux,InitializeObjectStencilID(*comp);
v1.6.0-linux,}
v1.6.0-linux,"Takes a UStaticMeshComponent, USkinnedMeshComponent or ALandscapeProxy and returns their custom stencil ID if"
v1.6.0-linux,their meshes's name or their owner's name (depending on the naming method in mesh_naming_method_) equals mesh_name
v1.6.0-linux,"The skybox is ignored here as it is huge, and really is of no use to the end user typically. Also the associated meshes with the cameras"
v1.6.0-linux,Various checks if there is even a valid mesh
v1.6.0-linux,Need to force the render command to go through cause on the next iteration the buffer no longer exists
v1.6.0-linux,Unreal stores more vertices than triangles. So here we find the highest referenced vertex and ignore any after that
v1.6.0-linux,can we see followee?
v1.6.0-linux,remove mapping
v1.6.0-linux,removing binding
v1.6.0-linux,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.6.0-linux,"some point. At the moment, manually swapping Red and Blue"
v1.6.0-linux,Copy scaled image into destination thumb
v1.6.0-linux,Compress data - convert into a .png
v1.6.0-linux,if we already have attached actor
v1.6.0-linux,Fill out your copyright notice in the Description page of Project Settings.
v1.6.0-linux,Check pointer equality first for performance
v1.6.0-linux,"KeyHash = HashCombine(KeyHash, GetTypeHash(Key.WildcardMeshNames));"
v1.6.0-linux,#ifdef _MSC_VER
v1.6.0-linux,//print to VS output window
v1.6.0-linux,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.6.0-linux,#endif
v1.6.0-linux,also do default logging
v1.6.0-linux,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.6.0-linux,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.6.0-linux,{
v1.6.0-linux,if (GEngine != nullptr)
v1.6.0-linux,{
v1.6.0-linux,return GEngine->GameUserSettings;
v1.6.0-linux,}
v1.6.0-linux,return nullptr;
v1.6.0-linux,}
v1.6.0-linux,UGameUserSettings* game_settings = GetGameUserSettings();
v1.6.0-linux,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.6.0-linux,game_settings->ApplySettings(true);
v1.6.0-linux,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.6.0-linux,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.6.0-linux,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.6.0-linux,todo unused. need to manually plots tf axes' line in right handed FLU instead of using DrawDebugCoordinateSystem
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,plugin startup
v1.6.0-linux,plugin shutdown
v1.6.0-linux,initialize state
v1.6.0-linux,add listener for pawn's collision event
v1.6.0-linux,compute our home point
v1.6.0-linux,default behavior is to call update every tick
v1.6.0-linux,"for custom physics engine, this method should be overridden and update should be"
v1.6.0-linux,called from every physics tick
v1.6.0-linux,add cameras that already exists in pawn
v1.6.0-linux,create or replace cameras specified in settings
v1.6.0-linux,setup individual cameras
v1.6.0-linux,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.6.0-linux,for each camera in settings
v1.6.0-linux,get pose
v1.6.0-linux,spawn and attach camera to pawn
v1.6.0-linux,add on to our collection
v1.6.0-linux,Deflect along the surface when we collide.
v1.6.0-linux,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.6.0-linux,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.6.0-linux,-1 to 1 --> 0 to 1
v1.6.0-linux,-1 to 1
v1.6.0-linux,these will be available for devices like steering wheels
v1.6.0-linux,switch index 0 to 7 for FrSky Taranis RC is:
v1.6.0-linux,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.6.0-linux,TODO: should below be at controller level info?
v1.6.0-linux,else don't waste time
v1.6.0-linux,"We need to run this code on the main game thread, since it iterates over actors"
v1.6.0-linux,"This default NedTransform is part of how we anchor the AirSim primary LLA origin at 0, 0, 0 in Unreal"
v1.6.0-linux,Transform from LLA to NED
v1.6.0-linux,KM911 remove logging
v1.6.0-linux,"common_utils::Utils::log(""NED from LLA: "" + std::to_string(target_location.X) + "", "" + std::to_string(target_location.Y) + "", "" + std::to_string(target_location.Z), common_utils::Utils::kLogLevelInfo);"
v1.6.0-linux,"No LOS, so draw red line"
v1.6.0-linux,"Yes LOS, so draw green line"
v1.6.0-linux,sync environment from kinematics
v1.6.0-linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.6.0-linux,void playBack()
v1.6.0-linux,{
v1.6.0-linux,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.6.0-linux,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.6.0-linux,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.6.0-linux,}
v1.6.0-linux,TODO: refactor below code used for playback
v1.6.0-linux,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.6.0-linux,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.6.0-linux,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.6.0-linux,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.6.0-linux,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.6.0-linux,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.6.0-linux,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.6.0-linux,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.6.0-linux,}
v1.6.0-linux,parameters in NED frame
v1.6.0-linux,translate to new PawnSimApi position & orientation from NED to NEU
v1.6.0-linux,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.6.0-linux,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.6.0-linux,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.6.0-linux,checked at the start of next tick
v1.6.0-linux,allow teleportation
v1.6.0-linux,if collisions are not enabled
v1.6.0-linux,or we have collided but passthrough is enabled
v1.6.0-linux,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.6.0-linux,"without flip flopping, collisions can't be detected"
v1.6.0-linux,update kinematics from pawn's movement instead of physics engine
v1.6.0-linux,by default we update kinematics from UE pawn
v1.6.0-linux,if SimMod uses its own physics engine then this should be overriden
v1.6.0-linux,no default action in this base class
v1.6.0-linux,"read pixels from render target using render thread, then compress the result into PNG"
v1.6.0-linux,argument on the thread that calls this method.
v1.6.0-linux,TODO: is below really needed?
v1.6.0-linux,make sure we are not on the rendering thread
v1.6.0-linux,TODO: below doesn't work right now because it must be running in game thread
v1.6.0-linux,below is documented method but more expensive because it forces flush
v1.6.0-linux,wait for render thread to pick up our task
v1.6.0-linux,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.6.0-linux,capture CameraPose for this frame
v1.6.0-linux,The completion is called immeidately after GameThread sends the
v1.6.0-linux,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.6.0-linux,execute *immediately* after RenderThread renders the scene!
v1.6.0-linux,"while we're still on GameThread, enqueue request for capture the scene!"
v1.6.0-linux,wait for this task to complete
v1.6.0-linux,log a message and continue wait
v1.6.0-linux,lamda function still references a few objects for which there is no refcount.
v1.6.0-linux,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.6.0-linux,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.6.0-linux,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.6.0-linux,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.6.0-linux,Fill out your copyright notice in the Description page of Project Settings.
v1.6.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.6.0-linux,UWorld* World = GetWorld();
v1.6.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.6.0-linux,still need the menu class for f10
v1.6.0-linux,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v1.6.0-linux,showWeatherMenu(WorldContextObject);
v1.6.0-linux,"if weather is not enabled, dont allow any weather values to be set"
v1.6.0-linux,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v1.6.0-linux,and must be set to true or false before this.
v1.6.0-linux,WeatherEnabled will always be false
v1.6.0-linux,"NOTE: weather enabled must be set first, before other params for this to work"
v1.6.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.6.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.6.0-linux,"get all menu actors, if any"
v1.6.0-linux,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.6.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.6.0-linux,"get all menu actors, if any"
v1.6.0-linux,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.6.0-linux,"get all menu actors, if any, then hide the menu"
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,Stuff to filter out XInput devices
v1.6.0-linux,-----------------------------------------------------------------------------
v1.6.0-linux,"Defines, constants, and global variables"
v1.6.0-linux,-----------------------------------------------------------------------------
v1.6.0-linux,Magnitude ranges from -1 to 1
v1.6.0-linux,Strength ranges from 0 to 1
v1.6.0-linux,Autocenter
v1.6.0-linux,Rumble
v1.6.0-linux,Register with the DirectInput subsystem and get a pointer
v1.6.0-linux,to a IDirectInput interface we can use.
v1.6.0-linux,Create a DInput object
v1.6.0-linux,Look for a simple joystick we can use for this sample program.
v1.6.0-linux,Make sure we got a joystick
v1.6.0-linux,"Set the data format to ""simple joystick"" - a predefined data format"
v1.6.0-linux,
v1.6.0-linux,"A data format specifies which controls on a device we are interested in,"
v1.6.0-linux,and how they should be reported. This tells DInput that we will be
v1.6.0-linux,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.6.0-linux,Set the cooperative level to let DInput know how this device should
v1.6.0-linux,interact with the system and with other DInput applications.
v1.6.0-linux,Enumerate the joystick objects. The callback function enabled user
v1.6.0-linux,"interface elements for objects that are found, and sets the min/max"
v1.6.0-linux,values property for discovered axes.
v1.6.0-linux,-----------------------------------------------------------------------------
v1.6.0-linux,Enum each PNP device using WMI and check each device ID to see if it contains
v1.6.0-linux,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.6.0-linux,Unfortunately this information can not be found by just using DirectInput.
v1.6.0-linux,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.6.0-linux,XInput devices.
v1.6.0-linux,
v1.6.0-linux,This function stores the list of xinput devices in a linked list
v1.6.0-linux,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.6.0-linux,-----------------------------------------------------------------------------
v1.6.0-linux,CoInit if needed
v1.6.0-linux,Create WMI
v1.6.0-linux,Create BSTRs for WMI
v1.6.0-linux,Connect to WMI
v1.6.0-linux,Switch security level to IMPERSONATE
v1.6.0-linux,Get list of Win32_PNPEntity devices
v1.6.0-linux,Loop over all devices
v1.6.0-linux,Get 20 at a time
v1.6.0-linux,"For each device, get its device ID"
v1.6.0-linux,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.6.0-linux,Unfortunately this information can not be found by just using DirectInput
v1.6.0-linux,"If it does, then get the VID/PID from var.bstrVal"
v1.6.0-linux,Add the VID/PID to a linked list
v1.6.0-linux,-----------------------------------------------------------------------------
v1.6.0-linux,Returns true if the DirectInput device is also an XInput device.
v1.6.0-linux,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.6.0-linux,-----------------------------------------------------------------------------
v1.6.0-linux,Check each xinput device to see if this device's vid/pid matches
v1.6.0-linux,-----------------------------------------------------------------------------
v1.6.0-linux,Cleanup needed for IsXInputDevice()
v1.6.0-linux,-----------------------------------------------------------------------------
v1.6.0-linux,Cleanup linked list
v1.6.0-linux,-----------------------------------------------------------------------------
v1.6.0-linux,Name: EnumJoysticksCallback()
v1.6.0-linux,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.6.0-linux,device interface on it so we can play with it.
v1.6.0-linux,-----------------------------------------------------------------------------
v1.6.0-linux,Skip anything other than the perferred joystick device as defined by the control panel.
v1.6.0-linux,Instead you could store all the enumerated joysticks and let the user pick.
v1.6.0-linux,Obtain an interface to the enumerated joystick.
v1.6.0-linux,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.6.0-linux,it while we were in the middle of enumerating it.)
v1.6.0-linux,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.6.0-linux,could store all the enumerated joysticks and let the user pick.
v1.6.0-linux,-----------------------------------------------------------------------------
v1.6.0-linux,Name: EnumObjectsCallback()
v1.6.0-linux,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.6.0-linux,joystick. This function enables user interface elements for objects
v1.6.0-linux,"that are found to exist, and scales axes min/max values."
v1.6.0-linux,-----------------------------------------------------------------------------
v1.6.0-linux,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.6.0-linux,enumerated axis in order to scale min/max values.
v1.6.0-linux,Set the range for the axis
v1.6.0-linux,Set the UI to reflect what objects the joystick supports
v1.6.0-linux,-----------------------------------------------------------------------------
v1.6.0-linux,Name: UpdateInputState()
v1.6.0-linux,Desc: Get the input device's state and display it.
v1.6.0-linux,-----------------------------------------------------------------------------
v1.6.0-linux,Poll the device to read the current state
v1.6.0-linux,DInput is telling us that the input stream has been
v1.6.0-linux,"interrupted. We aren't tracking any state between polls, so"
v1.6.0-linux,we don't have any special reset that needs to be done. We
v1.6.0-linux,just re-acquire and try again.
v1.6.0-linux,while (hr == DIERR_INPUTLOST)
v1.6.0-linux,hr = g_pJoystick->Acquire();
v1.6.0-linux,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.6.0-linux,may occur when the app is minimized or in the process of
v1.6.0-linux,"switching, so just try again later"
v1.6.0-linux,Get the input's device state
v1.6.0-linux,Axes
v1.6.0-linux,Slider controls
v1.6.0-linux,Points of view
v1.6.0-linux,Buttons
v1.6.0-linux,-----------------------------------------------------------------------------
v1.6.0-linux,Name: FreeDirectInput()
v1.6.0-linux,Desc: Initialize the DirectInput variables.
v1.6.0-linux,-----------------------------------------------------------------------------
v1.6.0-linux,Unacquire the device one last time just in case
v1.6.0-linux,the app tried to exit while the device is still acquired.
v1.6.0-linux,Release any DirectInput objects.
v1.6.0-linux,nop
v1.6.0-linux,normalize min to max --> 0 to 1
v1.6.0-linux,normalize 0 to 1 --> -1 to 1
v1.6.0-linux,#include <libudev.h>
v1.6.0-linux,implementation for unsupported OS
v1.6.0-linux,if this is new index
v1.6.0-linux,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.6.0-linux,close previous one
v1.6.0-linux,open new device
v1.6.0-linux,if open was successful
v1.6.0-linux,read the device
v1.6.0-linux,if we didn't had valid read
v1.6.0-linux,"NOTE if this condition is not met, we're probably out of sync and this"
v1.6.0-linux,Joystick instance is likely unusable
v1.6.0-linux,TODO: set below to false?
v1.6.0-linux,state.is_valid = false;
v1.6.0-linux,else ignore
v1.6.0-linux,TODO: implement this for linux
v1.6.0-linux,TODO: implement this for linux
v1.6.0-linux,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.6.0-linux,{
v1.6.0-linux,"manufacturerID = productID = """";"
v1.6.0-linux,// Use udev to look up the product and manufacturer IDs
v1.6.0-linux,struct udev *udev = udev_new();
v1.6.0-linux,if (udev) {
v1.6.0-linux,char sysname[32];
v1.6.0-linux,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.6.0-linux,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.6.0-linux,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.6.0-linux,if (!dev)
v1.6.0-linux,{
v1.6.0-linux,"message = ""Unable to find parent USB device"";"
v1.6.0-linux,return false;
v1.6.0-linux,}
v1.6.0-linux,std::stringstream ss;
v1.6.0-linux,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.6.0-linux,ss >> manufacturerID;
v1.6.0-linux,ss.clear();
v1.6.0-linux,"ss.str("""");"
v1.6.0-linux,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.6.0-linux,ss >> productID;
v1.6.0-linux,udev_device_unref(dev);
v1.6.0-linux,}
v1.6.0-linux,else
v1.6.0-linux,{
v1.6.0-linux,"message = ""Cannot create udev"";"
v1.6.0-linux,return false;
v1.6.0-linux,}
v1.6.0-linux,udev_unref(udev);
v1.6.0-linux,return true;
v1.6.0-linux,}
v1.6.0-linux,required for pimpl
v1.6.0-linux,TODO: anyway to workaround const_cast?
v1.6.0-linux,FGenericPlatformMisc::PlatformInit();
v1.6.0-linux,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.6.0-linux,TODO: index check
v1.6.0-linux,create main widget
v1.6.0-linux,synchronize PIP views
v1.6.0-linux,TODO: should we only do below on SceneCapture2D components and cameras?
v1.6.0-linux,avoid motion blur so capture images don't get
v1.6.0-linux,use two different methods to set console var because sometime it doesn't seem to work
v1.6.0-linux,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.6.0-linux,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.6.0-linux,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.6.0-linux,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.6.0-linux,setup defaults
v1.6.0-linux,Attempts to parse the settings text from one of multiple locations.
v1.6.0-linux,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.6.0-linux,"Next, check the executable's working directory for the settings file."
v1.6.0-linux,"Finally, check the user's documents folder."
v1.6.0-linux,"If the settings file cannot be read, throw an exception"
v1.6.0-linux,Attempts to parse the settings file path or the settings text from the command line
v1.6.0-linux,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.6.0-linux,"Example (Path): AirSim.exe --settings ""C:\path\to\settings.json"""
v1.6.0-linux,"Example (Text): AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.6.0-linux,"Returns true if the argument is present, false otherwise."
v1.6.0-linux,build image file name
v1.6.0-linux,write image file
v1.6.0-linux,"Write PNG image, already compressed in binary"
v1.6.0-linux,write to CSV file
v1.6.0-linux,"Either images were saved successfully, or there were no images"
v1.6.0-linux,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.6.0-linux,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.6.0-linux,"Just need any 1 instance, to set the header line of the record file"
v1.6.0-linux,"Set is_ready at the end, setting this before can cause a race when the file isn't open yet"
v1.6.0-linux,make sure all vars are set up
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,decide which derived BP to use
v1.6.0-linux,we don't have real vehicle so no vehicle API
v1.6.0-linux,put camera little bit above vehicle
v1.6.0-linux,update ground level
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,let base class setup physics world
v1.6.0-linux,stop physics thread before we dismantle
v1.6.0-linux,setup clock in ClockFactory
v1.6.0-linux,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.6.0-linux,steppable clock returns interval that is a constant number irrespective of wall clock
v1.6.0-linux,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.6.0-linux,but that would cause vehicles like quadrotors to become unstable
v1.6.0-linux,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.6.0-linux,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.6.0-linux,get increase in clock speed
v1.6.0-linux,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.6.0-linux,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.6.0-linux,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.6.0-linux,Approach 2: scale control loop frequency if clock is speeded up
v1.6.0-linux,"for slowing down, this don't generate instability"
v1.6.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.6.0-linux,decide which derived BP to use
v1.6.0-linux,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.6.0-linux,vehicle_sim_api->reset();
v1.6.0-linux,create vehicle API
v1.6.0-linux,setup physics vehicle
v1.6.0-linux,initialize private vars
v1.6.0-linux,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.6.0-linux,calls to update* are handled by physics engine and in SimModeWorldBase
v1.6.0-linux,"Utils::log(""------Render tick-------"");"
v1.6.0-linux,"if reset is pending then do it first, no need to do other things until next tick"
v1.6.0-linux,move collision info from rendering engine to vehicle
v1.6.0-linux,update rotor poses
v1.6.0-linux,update private rotor variable
v1.6.0-linux,if we did reset then don't worry about synchronizing states for this tick
v1.6.0-linux,Continue to wait for reset
v1.6.0-linux,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.6.0-linux,*** Start: UpdatableState implementation ***//
v1.6.0-linux,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.6.0-linux,environment update for current position
v1.6.0-linux,update forces on vertices
v1.6.0-linux,update to controller must be done after kinematics have been updated by physics engine
v1.6.0-linux,*** End: UpdatableState implementation ***//
v1.6.0-linux,get references of existing camera
v1.6.0-linux,setup clock in PhysX
v1.6.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.6.0-linux,decide which derived BP to use
v1.6.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.6.0-linux,Setup suspension forces
v1.6.0-linux,Find the tire object and set the data for it
v1.6.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.6.0-linux,Setup suspension forces
v1.6.0-linux,Find the tire object and set the data for it
v1.6.0-linux,Create In-Car camera component
v1.6.0-linux,In car HUD
v1.6.0-linux,Create text render component for in car speed display
v1.6.0-linux,Create text render component for in car gear display
v1.6.0-linux,Setup the audio component and allocate it a sound cue
v1.6.0-linux,Colors for the in-car gear display. One for normal one for reverse
v1.6.0-linux,Wheels/Tires
v1.6.0-linux,Setup the wheels
v1.6.0-linux,Adjust the tire loading
v1.6.0-linux,Engine
v1.6.0-linux,Torque setup
v1.6.0-linux,Adjust the steering
v1.6.0-linux,Transmission
v1.6.0-linux,We want 4wd
v1.6.0-linux,Drive the front wheels a little more than the rear
v1.6.0-linux,Automatic gearbox
v1.6.0-linux,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.6.0-linux,Physics settings
v1.6.0-linux,Adjust the center of mass - the buggy is quite low
v1.6.0-linux,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.6.0-linux,put camera little bit above vehicle
v1.6.0-linux,update physics material
v1.6.0-linux,Update the strings used in the HUD (in-car and on-screen)
v1.6.0-linux,Set the string in the in-car HUD
v1.6.0-linux,Pass the engine RPM to the sound component
v1.6.0-linux,Start an engine sound playing
v1.6.0-linux,Using FText because this is display text that should be localizable
v1.6.0-linux,Setup the text render component strings
v1.6.0-linux,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.6.0-linux,below is not needed
v1.6.0-linux,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.6.0-linux,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.6.0-linux,TODO: should do reset() here?
v1.6.0-linux,create vehicle params
v1.6.0-linux,these are called on render ticks
v1.6.0-linux,TODO: do we need this for cars?
v1.6.0-linux,TODO: move this to SimModeBase?
v1.6.0-linux,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.6.0-linux,reset();
v1.6.0-linux,return;
v1.6.0-linux,}
v1.6.0-linux,Thrustmaster devices
v1.6.0-linux,"Anything else, typically Logitech G920 wheel"
v1.6.0-linux,Two steel levers behind wheel
v1.6.0-linux,if API-client control is not active then we route keyboard/joystick control to car
v1.6.0-linux,all car controls from anywhere must be routed through API component
v1.6.0-linux,*** Start: UpdatableState implementation ***//
v1.6.0-linux,physics tick
v1.6.0-linux,*** End: UpdatableState implementation ***//
v1.6.0-linux,TODO: directly accept getVehicleSimApis() using generic container
v1.6.0-linux,remove everything that we created in BeginPlay
v1.6.0-linux,wait if no new frame is renderd
v1.6.0-linux,we use custom debug reporting for this class
v1.6.0-linux,perform any expensive rendering update outside of lock region
v1.6.0-linux,no need to call base reset because of our custom implementation
v1.6.0-linux,TODO: this is going to cause circular references which is fine here but
v1.6.0-linux,in future we should consider moving SimMode not derived from AActor and move
v1.6.0-linux,it to AirLib and directly implement WorldSimApiBase interface
v1.6.0-linux,get player start
v1.6.0-linux,this must be done from within actor otherwise we don't get player start
v1.6.0-linux,Grab player location
v1.6.0-linux,Move the world origin to the player's location (this moves the coordinate system and adds
v1.6.0-linux,a corresponding offset to all positions to compensate for the shift)
v1.6.0-linux,"Regrab the player's position after the offset has been added (which should be 0,0,0 now)"
v1.6.0-linux,UWeatherLib::showWeatherMenu(World);
v1.6.0-linux,else don't init
v1.6.0-linux,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v1.6.0-linux,tod_sim_clock_start_ needs to be reset here.
v1.6.0-linux,Going from enabled to disabled
v1.6.0-linux,do these in the end to ensure that advanceTimeOfDay() doesn't see
v1.6.0-linux,any inconsistent state.
v1.6.0-linux,should be overridden by derived class
v1.6.0-linux,should be overridden by derived class
v1.6.0-linux,should be overriden by derived class
v1.6.0-linux,should be overridden by derived class
v1.6.0-linux,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.6.0-linux,default setup - this should be overridden in derived modes as needed
v1.6.0-linux,setup clock in ClockFactory
v1.6.0-linux,default implementation
v1.6.0-linux,create director
v1.6.0-linux,create external camera required for the director
v1.6.0-linux,for each camera in settings
v1.6.0-linux,get pose
v1.6.0-linux,spawn and attach camera to pawn
v1.6.0-linux,add on to our collection
v1.6.0-linux,API server start/stop
v1.6.0-linux,get UU origin of global NED frame
v1.6.0-linux,compute initial pose
v1.6.0-linux,spawn vehicle pawn
v1.6.0-linux,create vehicle sim api
v1.6.0-linux,TODO: Figure out a better way to add more fields
v1.6.0-linux,Maybe allow passing a JSON string for the vehicle settings?
v1.6.0-linux,"Retroactively adjust AirSimSettings, so it's like we knew about this vehicle all along"
v1.6.0-linux,"Usually physics registration happens at init, in ASimModeWorldBase::initializeForPlay(), but not in this case"
v1.6.0-linux,Can't be done before the vehicle apis have been created
v1.6.0-linux,get UU origin of global NED frame
v1.6.0-linux,determine camera director camera default pose and spawn it
v1.6.0-linux,find all vehicle pawns
v1.6.0-linux,add vehicles from settings
v1.6.0-linux,if vehicle is of type for derived SimMode and auto creatable
v1.6.0-linux,create API objects for each pawn we have
v1.6.0-linux,Create External Cameras
v1.6.0-linux,TODO: better handle no FPV vehicles scenario
v1.6.0-linux,derived class shoudl override this method to add new vehicle to the physics engine
v1.6.0-linux,derived class should override this method to retrieve types of pawns they support
v1.6.0-linux,derived class should override this method to retrieve types of pawns they support
v1.6.0-linux,derived class should override this method to retrieve types of pawns they support
v1.6.0-linux,derived class should override this method to retrieve types of pawns they support
v1.6.0-linux,derived class should override this method to retrieve types of pawns they support
v1.6.0-linux,derived class should override this method to retrieve types of pawns they support
v1.6.0-linux,derived class should override this method to retrieve types of pawns they support
v1.6.0-linux,Draws debug-points on main viewport for Lidar laser hits.
v1.6.0-linux,Used for debugging only.
v1.6.0-linux,Currently we are checking the sensor-collection instead of sensor-settings.
v1.6.0-linux,Also using variables to optimize not checking the collection if not needed.
v1.6.0-linux,TODO: Is it incorrect to assume LidarSimple here?
v1.6.0-linux,Draw debug-point on main viewport for Distance sensor hit
v1.6.0-linux,Find position of point hit
v1.6.0-linux,Similar to UnrealDistanceSensor.cpp#L19
v1.6.0-linux,order of Pose addition is important here because it also adds quaternions which is not commutative!
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,ctor
v1.6.0-linux,initializes information based on lidar configuration
v1.6.0-linux,calculate verticle angle distance between each laser
v1.6.0-linux,store vertical angles for each laser
v1.6.0-linux,returns a point-cloud for the tick
v1.6.0-linux,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.6.0-linux,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.6.0-linux,calculate number of points needed for each laser/channel
v1.6.0-linux,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.6.0-linux,calculate needed angle/distance between each point
v1.6.0-linux,normalize FOV start/end
v1.6.0-linux,shoot lasers
v1.6.0-linux,check if the laser is outside the requested horizontal FOV
v1.6.0-linux,"shoot laser and get the impact point, if any"
v1.6.0-linux,simulate shooting a laser via Unreal ray-tracing.
v1.6.0-linux,start position
v1.6.0-linux,We need to compose rotations here rather than rotate a vector by a quaternion
v1.6.0-linux,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.6.0-linux,get ray quaternion in lidar frame (angles must be in radians)
v1.6.0-linux,get ray quaternion in body frame
v1.6.0-linux,get ray quaternion in world frame
v1.6.0-linux,get ray vector (end position)
v1.6.0-linux,Store the segmentation id of the hit object.
v1.6.0-linux,Debug code for very specific cases.
v1.6.0-linux,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.6.0-linux,decide the frame for the point-cloud
v1.6.0-linux,current detault behavior; though it is probably not very useful.
v1.6.0-linux,not changing the default for now to maintain backwards-compat.
v1.6.0-linux,point in vehicle intertial frame
v1.6.0-linux,tranform to lidar frame
v1.6.0-linux,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.6.0-linux,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.6.0-linux,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.6.0-linux,"On the client side, if it is needed to transform this data back to the world frame,"
v1.6.0-linux,"then do the equivalent of following,"
v1.6.0-linux,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.6.0-linux,See SimModeBase::drawLidarDebugPoints()
v1.6.0-linux,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.6.0-linux,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,update ray tracing
v1.6.0-linux,"FString hit_name = FString(""None"");"
v1.6.0-linux,if (dist_hit.GetActor())
v1.6.0-linux,hit_name=dist_hit.GetActor()->GetName();
v1.6.0-linux,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.6.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,This assumes you are running DroneServer already on the same machine.
v1.6.0-linux,DroneServer must be running first.
v1.6.0-linux,enable API control
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,Load gazebo
v1.6.0-linux,Create our node for communication
v1.6.0-linux,Listen to Gazebo topics
v1.6.0-linux,Make sure to shut everything down.
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,move commands
v1.6.0-linux,else leave as it is
v1.6.0-linux,TODO: get these in one call
v1.6.0-linux,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.6.0-linux,TODO: shouldn't we pass folder path?
v1.6.0-linux,parse
v1.6.0-linux,group the images by the current date.
v1.6.0-linux,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.6.0-linux,{
v1.6.0-linux,"return """";"
v1.6.0-linux,}
v1.6.0-linux,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.6.0-linux,{
v1.6.0-linux,return false;
v1.6.0-linux,}
v1.6.0-linux,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.6.0-linux,params.context->client.newTask();
v1.6.0-linux,}
v1.6.0-linux,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.6.0-linux,params.context->client.WaitForCompletion(0);
v1.6.0-linux,}
v1.6.0-linux,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.6.0-linux,{
v1.6.0-linux,}
v1.6.0-linux,parse command line
v1.6.0-linux,Shell callbacks
v1.6.0-linux,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.6.0-linux,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.6.0-linux,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.6.0-linux,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.6.0-linux,Add shell commands
v1.6.0-linux,TODO: add WaitForCompletion command
v1.6.0-linux,"TODO: add command line args help, arg count validation"
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v1.6.0-linux,switch to explicit hover mode so that this is the fall back when
v1.6.0-linux,move* commands are finished.
v1.6.0-linux,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.6.0-linux,TODO: implement weather for Unity
v1.6.0-linux,TODO: implement weather for Unity
v1.6.0-linux,----------------Plotting APIs-----------/
v1.6.0-linux,Recording APIs
v1.6.0-linux,"Remove '' from the list, representing default vehicle"
v1.6.0-linux,Function pointers to hold the addresses of the functions that are defined in Unity
v1.6.0-linux,"Enabling all LogLevels,"
v1.6.0-linux,"Enabling all LogLevels,"
v1.6.0-linux,delete ltm;
v1.6.0-linux,initialize state
v1.6.0-linux,compute our home point
v1.6.0-linux,default behavior is to call update every tick
v1.6.0-linux,"for custom physics engine, this method should be overridden and update should be"
v1.6.0-linux,called from every physics tick
v1.6.0-linux,these will be available for devices like steering wheels
v1.6.0-linux,sync environment from kinematics
v1.6.0-linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.6.0-linux,FVector unrealPosition = getUUPosition();
v1.6.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v1.6.0-linux,parameters in NED frame
v1.6.0-linux,allow teleportation
v1.6.0-linux,if collisions are not enabled
v1.6.0-linux,or we have collided but passthrough is enabled
v1.6.0-linux,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.6.0-linux,"without flip flopping, collisions can't be detected"
v1.6.0-linux,by default we update kinematics from UE pawn
v1.6.0-linux,if SimMod uses its own physics engine then this should be overriden
v1.6.0-linux,no default action in this base class
v1.6.0-linux,TODO: because this bug we are using alternative code with stringstream
v1.6.0-linux,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.6.0-linux,update kinematics from pawn's movement instead of physics engine
v1.6.0-linux,TODO: update other fields?
v1.6.0-linux,implements getImages() method in the ImageCaptureBase class.
v1.6.0-linux,update ray tracing
v1.6.0-linux,TODO: index check
v1.6.0-linux,Attempts to parse the settings text from one of multiple locations.
v1.6.0-linux,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.6.0-linux,"Next, check the executable's working directory for the settings file."
v1.6.0-linux,"Finally, check the user's documents folder."
v1.6.0-linux,"If the settings file cannot be read, throw an exception"
v1.6.0-linux,let base class setup physics world
v1.6.0-linux,stop physics thread before we dismantle
v1.6.0-linux,setup clock in ClockFactory
v1.6.0-linux,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.6.0-linux,steppable clock returns interval that is a constant number irrespective of wall clock
v1.6.0-linux,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.6.0-linux,but that would cause vehicles like quadrotors to become unstable
v1.6.0-linux,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.6.0-linux,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.6.0-linux,get increase in clock speed
v1.6.0-linux,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.6.0-linux,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.6.0-linux,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.6.0-linux,Approach 2: scale control loop frequency if clock is speeded up
v1.6.0-linux,"for slowing down, this don't generate instability"
v1.6.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.6.0-linux,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.6.0-linux,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.6.0-linux,create vehicle API
v1.6.0-linux,setup physics vehicle
v1.6.0-linux,initialize private vars
v1.6.0-linux,"if reset is pending then do it first, no need to do other things until next tick"
v1.6.0-linux,move collision info from rendering engine to vehicle
v1.6.0-linux,update rotor poses
v1.6.0-linux,if we did reset then don't worry about synchronizing states for this tick
v1.6.0-linux,Continue to wait for reset
v1.6.0-linux,*** Start: UpdatableState implementation ***//
v1.6.0-linux,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.6.0-linux,environment update for current position
v1.6.0-linux,update forces on vertices
v1.6.0-linux,update to controller must be done after kinematics have been updated by physics engine
v1.6.0-linux,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.6.0-linux,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.6.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.6.0-linux,*** End: UpdatableState implementation ***//
v1.6.0-linux,TODO: should do reset() here?
v1.6.0-linux,these are called on render ticks
v1.6.0-linux,TODO: do we need this for cars?
v1.6.0-linux,Thrustmaster devices
v1.6.0-linux,"Anything else, typically Logitech G920 wheel"
v1.6.0-linux,Two steel levers behind wheel
v1.6.0-linux,if API-client control is not active then we route keyboard/joystick control to car
v1.6.0-linux,This is so that getCarControls API works correctly
v1.6.0-linux,"API is enabled, so we use the controls set by API"
v1.6.0-linux,Update whether to use API controls or keyboard controls
v1.6.0-linux,*** Start: UpdatableState implementation ***//
v1.6.0-linux,physics tick
v1.6.0-linux,void CarPawnSimApi::reportState(StateReporter& reporter)
v1.6.0-linux,{
v1.6.0-linux,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.6.0-linux,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.6.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.6.0-linux,}
v1.6.0-linux,*** End: UpdatableState implementation ***//
v1.6.0-linux,remove everything that we created in BeginPlay
v1.6.0-linux,we use custom debug reporting for this class
v1.6.0-linux,perform any expensive rendering update outside of lock region
v1.6.0-linux,no need to call base reset because of our custom implementation
v1.6.0-linux,should be overridden by derived class
v1.6.0-linux,should be overridden by derived class
v1.6.0-linux,should be overridden by derived class
v1.6.0-linux,commenting this out for now to avoid unintentional Unity startup failure
v1.6.0-linux,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v1.6.0-linux,should be overridden by derived class
v1.6.0-linux,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.6.0-linux,default setup - this should be overridden in derived modes as needed
v1.6.0-linux,setup clock in ClockFactory
v1.6.0-linux,API server start/stop
v1.6.0-linux,determine camera director camera default pose and spawn it
v1.6.0-linux,derived class should override this method to retrieve types of pawns they support
v1.6.0-linux,derived class should override this method to retrieve types of pawns they support
v1.6.0-linux,60 acres park:
v1.6.0-linux,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.6.0-linux,marymoore park
v1.6.0-linux,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.6.0-linux,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.6.0-linux,DepthNavThreshold depthNav;
v1.6.0-linux,DepthNavOptAStar depthNav;
v1.6.0-linux,DepthNavThreshold depthNav;
v1.6.0-linux,DepthNavOptAStar depthNav;
v1.6.0-linux,Cleanup
v1.6.0-linux,runDepthNavGT();
v1.6.0-linux,runDepthNavSGM();
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,by Sudipta Sinha
v1.6.0-linux,adapted for AirSim by Matthias Mueller
v1.6.0-linux,first row
v1.6.0-linux,last row
v1.6.0-linux,Local quadratic fit of cost and subpixel refinement.
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,by Sudipta Sinha
v1.6.0-linux,adapted for AirSim by Matthias Mueller
v1.6.0-linux,uint64_t x64 = (uint64_t)x;
v1.6.0-linux,uint64_t y64 = (uint64_t)y;
v1.6.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.6.0-linux,Licensed under the MIT License.
v1.6.0-linux,by Sudipta Sinha
v1.6.0-linux,adapted for AirSim by Matthias Mueller
v1.6.0-linux,ensure that disparity range is a multiple of 8
v1.6.0-linux,sgm stereo
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,read settings and override defaults
v1.5.0-windows,allow json overrides on a per-vehicle basis.
v1.5.0-windows,start server in async mode
v1.5.0-windows,check messages
v1.5.0-windows,plot red arrows for 30 seconds
v1.5.0-windows,plot magenta arrows for 15 seconds
v1.5.0-windows,plot red arrows for 10 seconds
v1.5.0-windows,plot 2 white arrows which are persistent
v1.5.0-windows,plot points
v1.5.0-windows,"plot line strip. 0-1, 1-2, 2-3"
v1.5.0-windows,"plot line list. 0-1, 2-3, 4-5. Must be even."
v1.5.0-windows,plot transforms
v1.5.0-windows,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=0.0, yaw=yaw)) for x, y, yaw in zip(np.linspace(0,10,10), np.linspace(0,0,10), np.linspace(0,np.pi,10))],"
v1.5.0-windows,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.5.0-windows,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=roll, yaw=0.0)) for x, y, roll in zip(np.linspace(0,10,10), np.linspace(1,1,10), np.linspace(0,np.pi,10))],"
v1.5.0-windows,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.5.0-windows,In settings.json first activate computer vision mode:
v1.5.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.5.0-windows,monitor car state while you drive it manually.
v1.5.0-windows,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v1.5.0-windows,denominator from microns^3 to microns * m^2)
v1.5.0-windows,First set everything to 0.
v1.5.0-windows,Next set all objects of interest provided to corresponding object IDs
v1.5.0-windows,segIdDict values MUST match tempEmissivityNew labels.
v1.5.0-windows,"Connect to AirSim, UAV mode."
v1.5.0-windows,Choose temperature values for winter or summer.
v1.5.0-windows,""""""""
v1.5.0-windows,winter
v1.5.0-windows,""""""""
v1.5.0-windows,summer
v1.5.0-windows,Read camera response.
v1.5.0-windows,Calculate radiance.
v1.5.0-windows,Set IDs in AirSim environment.
v1.5.0-windows,In settings.json first activate computer vision mode:
v1.5.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.5.0-windows,"define abstract class to return next vector in the format (x,y,yaw)"
v1.5.0-windows,"compute vector, distance and angle to goal"
v1.5.0-windows,compute box of interest
v1.5.0-windows,scale by weight matrix (optional)
v1.5.0-windows,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.5.0-windows,detect collision
v1.5.0-windows,compute box of interest
v1.5.0-windows,detect collision
v1.5.0-windows,Same as above but decide to go left or right based on average or some metric like that
v1.5.0-windows,"compute resultant normalized vector, distance and angle"
v1.5.0-windows,compute bounding box size
v1.5.0-windows,convert horizonal fov to vertical fov
v1.5.0-windows,matrix with all ones
v1.5.0-windows,matrix with max weight in center and decreasing linearly with distance from center
v1.5.0-windows,matrix with max weight in center and decreasing quadratically with distance from center
v1.5.0-windows,"print (""Saving images to %s"" % tmp_dir)"
v1.5.0-windows,airsim.wait_key('Press any key to start')
v1.5.0-windows,"Define start position, goal and size of UAV"
v1.5.0-windows,Define parameters and thresholds
v1.5.0-windows,initial position
v1.5.0-windows,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.5.0-windows,time.sleep(1)
v1.5.0-windows,get response
v1.5.0-windows,get numpy array
v1.5.0-windows,reshape array to 2D array H X W
v1.5.0-windows,write to png
v1.5.0-windows,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.5.0-windows,pose = client.simGetPose()
v1.5.0-windows,pp.pprint(pose)
v1.5.0-windows,time.sleep(5)
v1.5.0-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.5.0-windows,################### OLD CODE
v1.5.0-windows,timer = 0
v1.5.0-windows,time_obs = 50
v1.5.0-windows,bObstacle = False
v1.5.0-windows,if (bObstacle):
v1.5.0-windows,timer = timer + 1
v1.5.0-windows,if timer > time_obs:
v1.5.0-windows,bObstacle = False
v1.5.0-windows,timer = 0
v1.5.0-windows,else:
v1.5.0-windows,yaw = target_angle
v1.5.0-windows,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.5.0-windows,if (np.average(img2d_box) < coll_thres):
v1.5.0-windows,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.5.0-windows,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.5.0-windows,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.5.0-windows,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.5.0-windows,"print('left: ', img2d_box_l_avg)"
v1.5.0-windows,"print('right: ', img2d_box_r_avg)"
v1.5.0-windows,if img2d_box_l_avg > img2d_box_r_avg:
v1.5.0-windows,##Go LEFT
v1.5.0-windows,#y_offset = y_offset-1
v1.5.0-windows,yaw = yaw - radians(10)
v1.5.0-windows,bObstacle = True
v1.5.0-windows,else:
v1.5.0-windows,##Go RIGHT
v1.5.0-windows,#y_offset = y_offset+1
v1.5.0-windows,yaw = yaw + radians(10)
v1.5.0-windows,bObstacle = true
v1.5.0-windows,"print('yaw: ', yaw)"
v1.5.0-windows,In settings.json first activate computer vision mode:
v1.5.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.5.0-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.5.0-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.5.0-windows,pip install opencv-python
v1.5.0-windows,In settings.json first activate computer vision mode:
v1.5.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.5.0-windows,In settings.json first activate computer vision mode:
v1.5.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.5.0-windows,for block environment
v1.5.0-windows,regex are case insensitive
v1.5.0-windows,#for neighborhood environment
v1.5.0-windows,set object ID for sky
v1.5.0-windows,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.5.0-windows,get segmentation image in various formats
v1.5.0-windows,save segmentation images in various formats
v1.5.0-windows,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.5.0-windows,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.5.0-windows,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v1.5.0-windows,find unique colors
v1.5.0-windows,In settings.json first activate computer vision mode:
v1.5.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.5.0-windows,objects can be named in two ways:
v1.5.0-windows,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.5.0-windows,default name is auto-generated and varies from run-to-run.
v1.5.0-windows,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.5.0-windows,
v1.5.0-windows,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.5.0-windows,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.5.0-windows,https://answers.unrealengine.com/revisions/790629.html
v1.5.0-windows,below works in Blocks environment
v1.5.0-windows,------------------------------------ Get current pose ------------------------------------------------
v1.5.0-windows,search object by name:
v1.5.0-windows,search another object by tag
v1.5.0-windows,search non-existent object
v1.5.0-windows,------------------------------------ Set new pose ------------------------------------------------
v1.5.0-windows,here we move with teleport enabled so collisions are ignored
v1.5.0-windows,here we move with teleport enabled so collisions are not ignored
v1.5.0-windows,move non-existent object
v1.5.0-windows,------------------------------------ Get new pose ------------------------------------------------
v1.5.0-windows,search another object by tag
v1.5.0-windows,search non-existent object
v1.5.0-windows,Import this module to automatically setup path to local airsim module
v1.5.0-windows,This module first tries to see if airsim module is installed via pip
v1.5.0-windows,If it does then we don't do anything else
v1.5.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.5.0-windows,and if it does then we add that in sys.path
v1.5.0-windows,this class simply tries to see if airsim
v1.5.0-windows,if airsim module is installed then don't do anything else
v1.5.0-windows,import pkgutil
v1.5.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.5.0-windows,if airsim_loader is not None:
v1.5.0-windows,return
v1.5.0-windows,"Roll is applied first, then pitch, then yaw."
v1.5.0-windows,Turn the camera position into a column vector.
v1.5.0-windows,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v1.5.0-windows,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v1.5.0-windows,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v1.5.0-windows,Recreate the perspective projection of the camera.
v1.5.0-windows,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v1.5.0-windows,Set pose and sleep after to ensure the pose sticks before capturing image.
v1.5.0-windows,Capture segmentation (IR) and scene images.
v1.5.0-windows,Change images into numpy arrays.
v1.5.0-windows,Capture images for a certain amount of time in seconds (half hour now)
v1.5.0-windows,Capture image - pose.position x_val access may change w/ AirSim
v1.5.0-windows,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v1.5.0-windows,Convert color scene image to BGR for write out with cv2.
v1.5.0-windows,"Connect to AirSim, UAV mode."
v1.5.0-windows,Look for objects with names that match a regular expression.
v1.5.0-windows,"Sample calls to main, varying camera angle and altitude."
v1.5.0-windows,"straight down, 400ft"
v1.5.0-windows,"straight down, 200ft"
v1.5.0-windows,"45 degrees, 200ft -- note that often object won't be scene since position"
v1.5.0-windows,is set exactly to object's
v1.5.0-windows,"45 degrees, 400ft -- note that often object won't be scene since position"
v1.5.0-windows,is set exactly to object's
v1.5.0-windows,In settings.json first activate computer vision mode:
v1.5.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.5.0-windows,xn = 1 + x*5  # some random number
v1.5.0-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,monitor car state while you drive it manually.
v1.5.0-windows,get state of the car
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,go forward
v1.5.0-windows,get state of the car
v1.5.0-windows,Python client example to change time-of-day using APIs
v1.5.0-windows,
v1.5.0-windows,Changes time of the day and makes the car move around
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,flip between specific time and default time
v1.5.0-windows,go forward
v1.5.0-windows,Go forward + steer right
v1.5.0-windows,main
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,get state of the car
v1.5.0-windows,go forward
v1.5.0-windows,Go forward + steer right
v1.5.0-windows,go reverse
v1.5.0-windows,apply brakes
v1.5.0-windows,get camera images from the car
v1.5.0-windows,restore to original state
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,go forward
v1.5.0-windows,Python client example to get Lidar data from a car
v1.5.0-windows,
v1.5.0-windows,Makes the drone fly and get Lidar data
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,"print(""state: %s"" % s)"
v1.5.0-windows,go forward
v1.5.0-windows,Go forward + steer right
v1.5.0-windows,"reshape array of floats to array of [X,Y,Z]"
v1.5.0-windows,TODO
v1.5.0-windows,main
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,get state of the car
v1.5.0-windows,go forward
v1.5.0-windows,Go forward + steer right
v1.5.0-windows,go reverse
v1.5.0-windows,apply breaks
v1.5.0-windows,restore to original state
v1.5.0-windows,Import this module to automatically setup path to local airsim module
v1.5.0-windows,This module first tries to see if airsim module is installed via pip
v1.5.0-windows,If it does then we don't do anything else
v1.5.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.5.0-windows,and if it does then we add that in sys.path
v1.5.0-windows,this class simply tries to see if airsim
v1.5.0-windows,if airsim module is installed then don't do anything else
v1.5.0-windows,import pkgutil
v1.5.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.5.0-windows,if airsim_loader is not None:
v1.5.0-windows,return
v1.5.0-windows,Use below in settings.json with blocks environment
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,get state of the car
v1.5.0-windows,go forward
v1.5.0-windows,go reverse
v1.5.0-windows,apply breaks
v1.5.0-windows,get camera images from the car
v1.5.0-windows,restore to original state
v1.5.0-windows,from keras.models import load_model
v1.5.0-windows,if (len(sys.argv) != 2):
v1.5.0-windows,print('usage: python drive.py <modelName>')
v1.5.0-windows,sys.exit()
v1.5.0-windows,print('Loading model...')
v1.5.0-windows,model = load_model(sys.argv[1])
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.5.0-windows,"model_output = model.predict([image_buf, state_buf])"
v1.5.0-windows,car_controls.steering = float(model_output[0][0])
v1.5.0-windows,-*- coding: utf-8 -*-
v1.5.0-windows,
v1.5.0-windows,Configuration file for the Sphinx documentation builder.
v1.5.0-windows,
v1.5.0-windows,This file does only contain a selection of the most common options. For a
v1.5.0-windows,full list see the documentation:
v1.5.0-windows,http://www.sphinx-doc.org/en/master/config
v1.5.0-windows,-- Path setup --------------------------------------------------------------
v1.5.0-windows,"If extensions (or modules to document with autodoc) are in another directory,"
v1.5.0-windows,add these directories to sys.path here. If the directory is relative to the
v1.5.0-windows,"documentation root, use os.path.abspath to make it absolute, like shown here."
v1.5.0-windows,
v1.5.0-windows,-- Project information -----------------------------------------------------
v1.5.0-windows,The short X.Y version
v1.5.0-windows,"The full version, including alpha/beta/rc tags"
v1.5.0-windows,-- General configuration ---------------------------------------------------
v1.5.0-windows,"If your documentation needs a minimal Sphinx version, state it here."
v1.5.0-windows,
v1.5.0-windows,needs_sphinx = '1.0'
v1.5.0-windows,"Add any Sphinx extension module names here, as strings. They can be"
v1.5.0-windows,extensions coming with Sphinx (named 'sphinx.ext.*') or your custom
v1.5.0-windows,ones.
v1.5.0-windows,"Add any paths that contain templates here, relative to this directory."
v1.5.0-windows,The suffix(es) of source filenames.
v1.5.0-windows,You can specify multiple suffix as a list of string:
v1.5.0-windows,
v1.5.0-windows,"source_suffix = ['.rst', '.md']"
v1.5.0-windows,The master toctree document.
v1.5.0-windows,The language for content autogenerated by Sphinx. Refer to documentation
v1.5.0-windows,for a list of supported languages.
v1.5.0-windows,
v1.5.0-windows,This is also used if you do content translation via gettext catalogs.
v1.5.0-windows,"Usually you set ""language"" from the command line for these cases."
v1.5.0-windows,"List of patterns, relative to source directory, that match files and"
v1.5.0-windows,directories to ignore when looking for source files.
v1.5.0-windows,This pattern also affects html_static_path and html_extra_path.
v1.5.0-windows,The name of the Pygments (syntax highlighting) style to use.
v1.5.0-windows,-- Options for HTML output -------------------------------------------------
v1.5.0-windows,The theme to use for HTML and HTML Help pages.  See the documentation for
v1.5.0-windows,a list of builtin themes.
v1.5.0-windows,
v1.5.0-windows,html_theme = 'alabaster'
v1.5.0-windows,Theme options are theme-specific and customize the look and feel of a theme
v1.5.0-windows,"further.  For a list of options available for each theme, see the"
v1.5.0-windows,documentation.
v1.5.0-windows,
v1.5.0-windows,html_theme_options = {}
v1.5.0-windows,"Add any paths that contain custom static files (such as style sheets) here,"
v1.5.0-windows,"relative to this directory. They are copied after the builtin static files,"
v1.5.0-windows,"so a file named ""default.css"" will overwrite the builtin ""default.css""."
v1.5.0-windows,"Custom sidebar templates, must be a dictionary that maps document names"
v1.5.0-windows,to template names.
v1.5.0-windows,
v1.5.0-windows,The default sidebars (for documents that don't match any pattern) are
v1.5.0-windows,defined by theme itself.  Builtin themes are using these templates by
v1.5.0-windows,"default: ``['localtoc.html', 'relations.html', 'sourcelink.html',"
v1.5.0-windows,'searchbox.html']``.
v1.5.0-windows,
v1.5.0-windows,html_sidebars = {}
v1.5.0-windows,-- Options for HTMLHelp output ---------------------------------------------
v1.5.0-windows,Output file base name for HTML help builder.
v1.5.0-windows,-- Options for LaTeX output ------------------------------------------------
v1.5.0-windows,The paper size ('letterpaper' or 'a4paper').
v1.5.0-windows,
v1.5.0-windows,"'papersize': 'letterpaper',"
v1.5.0-windows,"The font size ('10pt', '11pt' or '12pt')."
v1.5.0-windows,
v1.5.0-windows,"'pointsize': '10pt',"
v1.5.0-windows,Additional stuff for the LaTeX preamble.
v1.5.0-windows,
v1.5.0-windows,"'preamble': '',"
v1.5.0-windows,Latex figure (float) alignment
v1.5.0-windows,
v1.5.0-windows,"'figure_align': 'htbp',"
v1.5.0-windows,Grouping the document tree into LaTeX files. List of tuples
v1.5.0-windows,"(source start file, target name, title,"
v1.5.0-windows,"author, documentclass [howto, manual, or own class])."
v1.5.0-windows,-- Options for manual page output ------------------------------------------
v1.5.0-windows,One entry per manual page. List of tuples
v1.5.0-windows,"(source start file, name, description, authors, manual section)."
v1.5.0-windows,-- Options for Texinfo output ----------------------------------------------
v1.5.0-windows,Grouping the document tree into Texinfo files. List of tuples
v1.5.0-windows,"(source start file, target name, title, author,"
v1.5.0-windows,"dir menu entry, description, category)"
v1.5.0-windows,-- Options for Epub output -------------------------------------------------
v1.5.0-windows,Bibliographic Dublin Core info.
v1.5.0-windows,The unique identifier of the text. This can be a ISBN number
v1.5.0-windows,or the project homepage.
v1.5.0-windows,
v1.5.0-windows,epub_identifier = ''
v1.5.0-windows,A unique identification for the text.
v1.5.0-windows,
v1.5.0-windows,epub_uid = ''
v1.5.0-windows,A list of files that should not be packed into the epub file.
v1.5.0-windows,-- Extension configuration -------------------------------------------------
v1.5.0-windows,-- Options for intersphinx extension ---------------------------------------
v1.5.0-windows,Example configuration for intersphinx: refer to the Python standard library.
v1.5.0-windows,-- Options for todo extension ----------------------------------------------
v1.5.0-windows,"If true, `todo` and `todoList` produce output, else they produce nothing."
v1.5.0-windows,We ignore the 2D nature of the problem as it is not relevant here
v1.5.0-windows,It makes multi-core processing more straightforward
v1.5.0-windows,Allocations
v1.5.0-windows,Add small number to avoid issues with log(I)
v1.5.0-windows,Event sim keeps track of previous image automatically
v1.5.0-windows,"Using pickle dump in a per-frame fashion to save time, instead of savetxt"
v1.5.0-windows,Optimizations possible
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,MultirotorClient.wait_key('Press any key to takeoff')
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,get camera images from the car
v1.5.0-windows,that's enough fun for now. let's quit cleanly
v1.5.0-windows,##################################################################################################
v1.5.0-windows,
v1.5.0-windows,Project:  Embedded Learning Library (ELL)
v1.5.0-windows,File:     speaker.py
v1.5.0-windows,Authors:  Chris Lovett
v1.5.0-windows,
v1.5.0-windows,Requires: Python 3.x
v1.5.0-windows,
v1.5.0-windows,##################################################################################################
v1.5.0-windows,open speakers so we can hear what it is processing...
v1.5.0-windows,teleport the drone + 10 meters in x-direction
v1.5.0-windows,teleport the drone back
v1.5.0-windows,This example shows how to use the External Physics Engine
v1.5.0-windows,It allows you to control the drone through setVehiclePose and obtain collision information.
v1.5.0-windows,It is especially useful for injecting your own flight dynamics model to the AirSim drone.
v1.5.0-windows,Use Blocks environment to see the drone colliding and seeing the collision information
v1.5.0-windows,in the command prompt.
v1.5.0-windows,Add this line to your settings.json before running AirSim:
v1.5.0-windows,"""PhysicsEngineName"":""ExternalPhysicsEngine"""
v1.5.0-windows,use open cv to create point cloud from depth image.
v1.5.0-windows,###########################################
v1.5.0-windows,######### This is work in progress! #######
v1.5.0-windows,###########################################
v1.5.0-windows,file will be saved in PythonClient folder (i.e. same folder as script)
v1.5.0-windows,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.5.0-windows,skip it
v1.5.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.5.0-windows,z of -7 is 7 meters above the original launch point.
v1.5.0-windows,Fly given velocity vector for 5 seconds
v1.5.0-windows,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.5.0-windows,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.5.0-windows,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.5.0-windows,Make the drone fly in a circle.
v1.5.0-windows,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.5.0-windows,check that our home position is stable
v1.5.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.5.0-windows,ramp up time
v1.5.0-windows,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.5.0-windows,compute current angle
v1.5.0-windows,compute lookahead
v1.5.0-windows,if we did the takeoff then also do the landing.
v1.5.0-windows,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.5.0-windows,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.5.0-windows,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.5.0-windows,ignore the click over from 360 back to 0
v1.5.0-windows,watch direction this diff is moving if it switches from shrinking to growing
v1.5.0-windows,then we passed the starting point.
v1.5.0-windows,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.5.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.5.0-windows,z of -5 is 5 meters above the original launch point.
v1.5.0-windows,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.5.0-windows,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.5.0-windows,drone will over-shoot so we bring it back to the start point before landing.
v1.5.0-windows,Run this script with clock speed in settings.json
v1.5.0-windows,"""ClockSpeed"": 1 then change it to 0.5"
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,with ClockSpeed = 0.5 you will see that this takes 6s (system time) and not 3s
v1.5.0-windows,with ClockSpeed = 0.5 you will see that this takes 10s (system time)
v1.5.0-windows,and not 5s in each iteration
v1.5.0-windows,that's enough fun for now. let's quit cleanly
v1.5.0-windows,Takeoff or hover
v1.5.0-windows,Set wind to 0
v1.5.0-windows,Takeoff or hover
v1.5.0-windows,In settings.json first activate computer vision mode:
v1.5.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.5.0-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.5.0-windows,pip install opencv-python
v1.5.0-windows,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.5.0-windows,fly for 2 minutes
v1.5.0-windows,more than 50 centimeter drift is unacceptable.
v1.5.0-windows,Python client example to get Lidar data from a drone
v1.5.0-windows,
v1.5.0-windows,Makes the drone fly and get Lidar data
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,"print(""state: %s"" % s)"
v1.5.0-windows,"print(""state: %s"" % pprint.pformat(state))"
v1.5.0-windows,"reshape array of floats to array of [X,Y,Z]"
v1.5.0-windows,TODO
v1.5.0-windows,main
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.5.0-windows,let it settle there a bit.
v1.5.0-windows,after hovering we need to re-enabled api control for next leg of the trip
v1.5.0-windows,now compute the survey path required to fill the box
v1.5.0-windows,##################################################################################################
v1.5.0-windows,
v1.5.0-windows,Project:  Embedded Learning Library (ELL)
v1.5.0-windows,File:     wav_reader.py
v1.5.0-windows,Authors:  Chris Lovett
v1.5.0-windows,
v1.5.0-windows,Requires: Python 3.x
v1.5.0-windows,
v1.5.0-windows,##################################################################################################
v1.5.0-windows,open a stream on the audio input file.
v1.5.0-windows,"assumes signed integer used in raw audio, so for example, the max for 16bit is 2^15 (32768)"
v1.5.0-windows,convert int16 data to scaled floats
v1.5.0-windows,configure output stream to match what we are resampling to...
v1.5.0-windows,convert the audio to the desired recording rate
v1.5.0-windows,split into separate channels
v1.5.0-windows,drop the channels we don't want
v1.5.0-windows,zip the resulting channels back up.
v1.5.0-windows,convert back to packed bytes in PCM 16 format
v1.5.0-windows,"deal with any accumulation of tails, if the tail grows to a full"
v1.5.0-windows,buffer then return it!
v1.5.0-windows,"we have a tail from previous frame, so prepend it"
v1.5.0-windows,"now the caller needs us to stick to our sample_size contract, but when"
v1.5.0-windows,rate conversion happens we can't be sure that 'data' is exactly that size.
v1.5.0-windows,usually one byte extra so add this to our accumulating tail
v1.5.0-windows,"might have reached the end of a file, so pad with zeros."
v1.5.0-windows,"Please add ""EnableTrace"": true to your setting.json as shown below"
v1.5.0-windows,{
v1.5.0-windows,"""SettingsVersion"": 1.2,"
v1.5.0-windows,"""SimMode"": ""Multirotor"","
v1.5.0-windows,"""Vehicles"": {"
v1.5.0-windows,"""Drone"": {"
v1.5.0-windows,"""VehicleType"": ""SimpleFlight"","
v1.5.0-windows,"""EnableTrace"": true"
v1.5.0-windows,}
v1.5.0-windows,}
v1.5.0-windows,}
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,add new vehicle
v1.5.0-windows,Use below in settings.json with Blocks environment
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,get camera images from the car
v1.5.0-windows,that's enough fun for now. let's quit cleanly
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,Import this module to automatically setup path to local airsim module
v1.5.0-windows,This module first tries to see if airsim module is installed via pip
v1.5.0-windows,If it does then we don't do anything else
v1.5.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.5.0-windows,and if it does then we add that in sys.path
v1.5.0-windows,this class simply tries to see if airsim
v1.5.0-windows,if airsim module is installed then don't do anything else
v1.5.0-windows,import pkgutil
v1.5.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.5.0-windows,if airsim_loader is not None:
v1.5.0-windows,return
v1.5.0-windows,"this script moves the drone to a location, then rests it thousands of time"
v1.5.0-windows,purpose of this script is to stress test reset API
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,that's enough fun for now. let's quite cleanly
v1.5.0-windows,For high speed ascent and descent on PX4 you may need to set these properties:
v1.5.0-windows,param set MPC_Z_VEL_MAX_UP 5
v1.5.0-windows,param set MPC_Z_VEL_MAX_DN 5
v1.5.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.5.0-windows,z of -50 is 50 meters above the original launch point.
v1.5.0-windows,use open cv to show new images from AirSim
v1.5.0-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.5.0-windows,pip install opencv-python
v1.5.0-windows,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.5.0-windows,get depth image
v1.5.0-windows,"this will return png width= 256, height= 144"
v1.5.0-windows,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.5.0-windows,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.5.0-windows,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.5.0-windows,to get an estimate of distance.
v1.5.0-windows,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.5.0-windows,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.5.0-windows,an angular delta of the following pi/10.
v1.5.0-windows,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.5.0-windows,Remove alpha channel if exists
v1.5.0-windows,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.5.0-windows,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.5.0-windows,Flatten and yield as tuple
v1.5.0-windows,Initialize a resizable dataset to hold the output
v1.5.0-windows,Resize the dataset to accommodate the next chunk of rows
v1.5.0-windows,Create the next chunk
v1.5.0-windows,Increment the row count
v1.5.0-windows,Arguments
v1.5.0-windows,Returns
v1.5.0-windows,use composition of homographies
v1.5.0-windows,to generate final transform that needs to be applied
v1.5.0-windows,Arguments
v1.5.0-windows,Returns
v1.5.0-windows,Keeps under lock only the mechanism which advances
v1.5.0-windows,the indexing of each batch.
v1.5.0-windows,The transformation of images is not under thread lock
v1.5.0-windows,so it can be done in parallel
v1.5.0-windows,Trained model path
v1.5.0-windows,Connect to AirSim
v1.5.0-windows,Start driving
v1.5.0-windows,Initialize image buffer
v1.5.0-windows,Update throttle value according to steering angle
v1.5.0-windows,Prediction
v1.5.0-windows,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.5.0-windows,Print progress
v1.5.0-windows,Update next car state
v1.5.0-windows,Wait a bit between iterations
v1.5.0-windows,%matplotlib inline
v1.5.0-windows,chunk size for training batches
v1.5.0-windows,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.5.0-windows,Point this to the directory containing the raw data
v1.5.0-windows,Point this to the desired output directory for the cooked (.h5) data
v1.5.0-windows,Choose The folders to search for data under RAW_DATA_DIR
v1.5.0-windows,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.5.0-windows,data_folder.append('folder_name1')
v1.5.0-windows,data_folder.append('folder_name2')
v1.5.0-windows,...
v1.5.0-windows,Hyper-parameters
v1.5.0-windows,Activation functions
v1.5.0-windows,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.5.0-windows,<< The directory containing the cooked data from the previous step >>
v1.5.0-windows,<< The directory in which the model output will be placed >>
v1.5.0-windows,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.5.0-windows,Network definition
v1.5.0-windows,Import this module to automatically setup path to local airsim module
v1.5.0-windows,This module first tries to see if airsim module is installed via pip
v1.5.0-windows,If it does then we don't do anything else
v1.5.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.5.0-windows,and if it does then we add that in sys.path
v1.5.0-windows,this class simply tries to see if airsim
v1.5.0-windows,if airsim module is installed then don't do anything else
v1.5.0-windows,import pkgutil
v1.5.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.5.0-windows,if airsim_loader is not None:
v1.5.0-windows,return
v1.5.0-windows,DEY: I don't know why this was there.
v1.5.0-windows,-----------------------------------  Common vehicle APIs ---------------------------------------------
v1.5.0-windows,basic flight control
v1.5.0-windows,time-of-day control
v1.5.0-windows,weather
v1.5.0-windows,camera control
v1.5.0-windows,simGetImage returns compressed png in array of bytes
v1.5.0-windows,image_type uses one of the ImageType members
v1.5.0-windows,"todo: in future remove below, it's only for compatibility to pre v1.2"
v1.5.0-windows,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.5.0-windows,camera control
v1.5.0-windows,simGetImage returns compressed png in array of bytes
v1.5.0-windows,image_type uses one of the ImageType members
v1.5.0-windows,gets the static meshes in the unreal scene
v1.5.0-windows,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.5.0-windows,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.5.0-windows,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.5.0-windows,sensor APIs
v1.5.0-windows,Plotting APIs
v1.5.0-windows,Recording APIs
v1.5.0-windows,Add new vehicle via RPC
v1.5.0-windows,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.5.0-windows,APIs for control
v1.5.0-windows,low-level control API
v1.5.0-windows,query vehicle state
v1.5.0-windows,query rotor states
v1.5.0-windows,-----------------------------------  Car APIs ---------------------------------------------
v1.5.0-windows,helper method for converting getOrientation to roll/pitch/yaw
v1.5.0-windows,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.5.0-windows,roll (x-axis rotation)
v1.5.0-windows,pitch (y-axis rotation)
v1.5.0-windows,yaw (z-axis rotation)
v1.5.0-windows,DEY: I don't know why this was there.
v1.5.0-windows,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.5.0-windows,return cls(**msgpack.unpack(encoded))
v1.5.0-windows,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.5.0-windows,Create a DummyVecEnv for main airsim gym env
v1.5.0-windows,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.5.0-windows,Initialize RL algorithm type and parameters
v1.5.0-windows,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.5.0-windows,Train for a certain number of timesteps
v1.5.0-windows,Save policy weights
v1.5.0-windows,Create a DummyVecEnv for main airsim gym env
v1.5.0-windows,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.5.0-windows,Initialize RL algorithm type and parameters
v1.5.0-windows,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.5.0-windows,Train for a certain number of timesteps
v1.5.0-windows,Save policy weights
v1.5.0-windows,Import this module to automatically setup path to local airsim module
v1.5.0-windows,This module first tries to see if airsim module is installed via pip
v1.5.0-windows,If it does then we don't do anything else
v1.5.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.5.0-windows,and if it does then we add that in sys.path
v1.5.0-windows,this class simply tries to see if airsim
v1.5.0-windows,if airsim module is installed then don't do anything else
v1.5.0-windows,import pkgutil
v1.5.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.5.0-windows,if airsim_loader is not None:
v1.5.0-windows,return
v1.5.0-windows,Set home position and velocity
v1.5.0-windows,print(dist)
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,"This is a bit crude, but give it a moment to settle on the ground, else takeoff will fail"
v1.5.0-windows,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.5.0-windows,switch to explicit hover mode so that this is the fallback when
v1.5.0-windows,move* commands are finished.
v1.5.0-windows,"Altitude difference between each platform, in meters"
v1.5.0-windows,"Count down, so the first one can easily go the highest (without knowing count)"
v1.5.0-windows,"in header only mode, control library is not available"
v1.5.0-windows,if using Unreal Build system then include precompiled header file first
v1.5.0-windows,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.5.0-windows,"Windows, OSX and Linux."
v1.5.0-windows,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.5.0-windows,Windows users can move the Documents folder to any location they want
v1.5.0-windows,SHGetFolderPath knows how to find it.
v1.5.0-windows,fall back in case SHGetFolderPath failed for some reason.
v1.5.0-windows,convert from std::path '/' to windows backslash.
v1.5.0-windows,make the current thread run with maximum priority.
v1.5.0-windows,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.5.0-windows,TODO: How to handle POSIX thread priorities on OSX?
v1.5.0-windows,setThreadName is a helper function that is useful when debugging because your threads
v1.5.0-windows,show up in the debugger with the name you set which makes it easier to find the threads
v1.5.0-windows,that you are interested in.
v1.5.0-windows,"unfortunately this is only available on Windows 10, and AirSim is not limited to that."
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.5.0-windows,
v1.5.0-windows,Treat all errors as failure conditions.
v1.5.0-windows,parse command line
v1.5.0-windows,"motive gives a weird error if the project is not found, so we look for it."
v1.5.0-windows,Do an update to pick up any recently-arrived cameras.
v1.5.0-windows,List all detected cameras.
v1.5.0-windows,List all defined rigid bodies.
v1.5.0-windows,throttle to 50 messages per second.
v1.5.0-windows,OptiTrack uses 'y' axis for vertical.
v1.5.0-windows,stdafx.cpp : source file that includes just the standard includes
v1.5.0-windows,MavlinkMoCap.pch will be the pre-compiled header
v1.5.0-windows,stdafx.obj will contain the pre-compiled type information
v1.5.0-windows,TODO: reference any additional headers you need in STDAFX.H
v1.5.0-windows,and not in this file
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,PX4.cpp : Defines the entry point for the console application.
v1.5.0-windows,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.5.0-windows,how do you write to the debug output windows on Unix ?
v1.5.0-windows,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.5.0-windows,connection to create to talke to that server.
v1.5.0-windows,SITL setup info
v1.5.0-windows,The local ethernet interface to use (default localhost).
v1.5.0-windows,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.5.0-windows,server mode on UDP is when you want another app to connect to Pixhawk and publish data back to this process.
v1.5.0-windows,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.5.0-windows,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.5.0-windows,"using their the -qgc option.  Server mode on TCP means mavlinktest will do an ""accept"" socket which is"
v1.5.0-windows,what PX4 is waiting for when it is running in TCP mode.  Here the serverEndPoint is different from the
v1.5.0-windows,offboardEndPoint.  The serverEndPoint specifies which local address to use in case your computer has
v1.5.0-windows,multiple network interfaces.
v1.5.0-windows,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.5.0-windows,this switch controls whether we turn off the RC remote active link loss detection
v1.5.0-windows,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.5.0-windows,from kicking in when you try and fly.
v1.5.0-windows,parse the json
v1.5.0-windows,flatten inner mavlink object
v1.5.0-windows,flatten inner mavlink object
v1.5.0-windows,todo
v1.5.0-windows,todo
v1.5.0-windows,"const char* outLogFileOption = ""outlogfile"";"
v1.5.0-windows,parse command line
v1.5.0-windows,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.5.0-windows,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.5.0-windows,"no local serial connection, so this is the primary droneConnection."
v1.5.0-windows,need a retry loop here because we don't know how quickly px4 will start accepting these connections...
v1.5.0-windows,failed to connect
v1.5.0-windows,"then we need 2 mavlink channels, one for sending/receiving HIL_* messages and the other"
v1.5.0-windows,for controlling the drone.
v1.5.0-windows,this is the control channel.
v1.5.0-windows,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.5.0-windows,cmdTable.push_back(new AltHoldCommand());
v1.5.0-windows,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.5.0-windows,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.5.0-windows,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.5.0-windows,this stops us from being able to connect to SITL mode PX4.
v1.5.0-windows,checkPulse();
v1.5.0-windows,add command text in log
v1.5.0-windows,close previous command.
v1.5.0-windows,FilterLogFiles(logDirectory);
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,send a heartbeat
v1.5.0-windows,accept one incoming connection
v1.5.0-windows,send a heartbeat to the client
v1.5.0-windows,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.5.0-windows,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.5.0-windows,for this unit test we are expecting a request to send an image.
v1.5.0-windows,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.5.0-windows,hmmm
v1.5.0-windows,================ ls
v1.5.0-windows,================ put file
v1.5.0-windows,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.5.0-windows,================ get file
v1.5.0-windows,verify the file contents.
v1.5.0-windows,================ remove file
v1.5.0-windows,================ make directory
v1.5.0-windows,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.5.0-windows,================ remove directory
v1.5.0-windows,Now verification
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,you must call this method if you want HandleMessage to be called subsequently.
v1.5.0-windows,treat literals as one word
v1.5.0-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.5.0-windows,request gps info
v1.5.0-windows,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.5.0-windows,find relative position since command start so we can compare two commands better
v1.5.0-windows,"these PID values are important, so set these to match"
v1.5.0-windows,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.5.0-windows,we can skip ahead.
v1.5.0-windows,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.5.0-windows,TODO: avoid passing hadcoded HIL flag
v1.5.0-windows,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.5.0-windows,"The global position, as returned by the Global Positioning System (GPS)."
v1.5.0-windows,Provides state for additional features
v1.5.0-windows,The general system state
v1.5.0-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.5.0-windows,Provides state for additional features
v1.5.0-windows,The general system state
v1.5.0-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.5.0-windows,Provides state for additional features
v1.5.0-windows,The general system state
v1.5.0-windows,Provides state for additional features
v1.5.0-windows,The general system state
v1.5.0-windows,note: we do not reset com when Close() is called because we want to keep running.
v1.5.0-windows,"user has to invoke ""hil stop"" to stop the hil thread."
v1.5.0-windows,generate random between 0 and 1
v1.5.0-windows,move to range -1 to 1
v1.5.0-windows,scale it
v1.5.0-windows,apply iy
v1.5.0-windows,wait for the Execute method to be called.
v1.5.0-windows,gps is much slower frequency than IMU.
v1.5.0-windows,MAVLINK_MSG_ID_HIL_GPS
v1.5.0-windows,disable MAV_USEHILGPS
v1.5.0-windows,note: we do not reset com when Close() is called because we want to keep running.
v1.5.0-windows,"user has to invoke ""hil stop"" to stop the hil thread."
v1.5.0-windows,generate random between 0 and 1
v1.5.0-windows,move to range -1 to 1
v1.5.0-windows,scale it
v1.5.0-windows,apply iy
v1.5.0-windows,wait for the Execute method to be called.
v1.5.0-windows,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.5.0-windows,gps is much slower frequency than IMU.
v1.5.0-windows,MAVLINK_MSG_ID_HIL_GPS
v1.5.0-windows,disable HIL mode
v1.5.0-windows,Enumeration of landed detector states
v1.5.0-windows,MAV landed state is unknown
v1.5.0-windows,MAV is landed (on ground)
v1.5.0-windows,MAV is in air
v1.5.0-windows,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.5.0-windows,The filtered local position
v1.5.0-windows,must send these regularly to keep offboard control.
v1.5.0-windows,"ok, now we can safely switch to loiter."
v1.5.0-windows,must send these regularly to keep offboard control.
v1.5.0-windows,integrate the heading so it is smoother.
v1.5.0-windows,must send these regularly to keep offboard control.
v1.5.0-windows,integrate the heading so it is smoother.
v1.5.0-windows,fly to radius
v1.5.0-windows,it takes about 10 cm to stop and turn.
v1.5.0-windows,next time around switch to orbiting!
v1.5.0-windows,heading points to center of circle.
v1.5.0-windows,interpoloate the speed ramp up time over 2 seconds from start time
v1.5.0-windows,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.5.0-windows,monitor the sin curves so we can see how on track or off track it actually is.
v1.5.0-windows,the shape of the curve will also tell us if we are progressing at a consistent
v1.5.0-windows,"speed, the more deformed the sin curve the worse our progress."
v1.5.0-windows,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.5.0-windows,degrees just flipped from 359 to 0.
v1.5.0-windows,this enables us to test what happens when offboard control is lost and resumed.
v1.5.0-windows,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.5.0-windows,"ok, now we can start moving by velocity"
v1.5.0-windows,recompute to new target.
v1.5.0-windows,start by moving right with 10 degree roll.
v1.5.0-windows,haven't started yet.
v1.5.0-windows,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.5.0-windows,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.5.0-windows,track how our actual pitch is coming along compared to our target
v1.5.0-windows,and check position
v1.5.0-windows,the amount of pitch should depend on our speed in that direction.
v1.5.0-windows,passed the midpoint.
v1.5.0-windows,fade out the pitch as we pick up speed so we don't overshoot.
v1.5.0-windows,see if we just crossed the wiggle distance threshold.
v1.5.0-windows,(pitch affects the x-position).
v1.5.0-windows,reverse direction with a -30 degrees quick stop
v1.5.0-windows,reverse direction with a 30 degrees quick stop
v1.5.0-windows,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.5.0-windows,too much in that direction.
v1.5.0-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.5.0-windows,track how our actual roll is coming along compared to our target
v1.5.0-windows,and check position
v1.5.0-windows,the amount of roll should depend on our speed in that direction.
v1.5.0-windows,passed the midpoint.
v1.5.0-windows,fade out the roll as we pick up speed so we don't overshoot.
v1.5.0-windows,see if we just crossed the wiggle distance threshold.
v1.5.0-windows,(roll affects the y-position).
v1.5.0-windows,reverse direction with a -30 degrees quick stop
v1.5.0-windows,reverse direction with a 30 degrees quick stop
v1.5.0-windows,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.5.0-windows,too much in that direction.
v1.5.0-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.5.0-windows,for testing PID controller.
v1.5.0-windows,class AltHoldCommand : public Command
v1.5.0-windows,{
v1.5.0-windows,std::shared_ptr<MavLinkVehicle> channel;
v1.5.0-windows,"float sx_, sy_, sz_;"
v1.5.0-windows,MavLinkAttitudeTarget _current;
v1.5.0-windows,PidController thrust_controller_;
v1.5.0-windows,public:
v1.5.0-windows,this->sz_ = pos.z; // user defined target.
v1.5.0-windows,move to local position keeps the offboard control happy.
v1.5.0-windows,haven't started yet.
v1.5.0-windows,and check position
v1.5.0-windows,double dx = this->sx_ - pos.x;
v1.5.0-windows,double dy = this->sy_ - pos.y;
v1.5.0-windows,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.5.0-windows,too much in that direction.
v1.5.0-windows,adjust thrust so we keep steady height target
v1.5.0-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.5.0-windows,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.5.0-windows,local remote
v1.5.0-windows,already handled by the parse method.
v1.5.0-windows,we only support very simple patterns for now.
v1.5.0-windows,each wildcard must be separated by literal.
v1.5.0-windows,back to back wildcards with no literal in between is too complex.
v1.5.0-windows,"we only support simple matching for now, we can add full regex later if we need it."
v1.5.0-windows,yep!
v1.5.0-windows,'*' is done we found the next matching char
v1.5.0-windows,this is ok.
v1.5.0-windows,this is an ERASE_END_LINE command which we ignore.
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,pack the payload buffer.
v1.5.0-windows,calculate checksum
v1.5.0-windows,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.5.0-windows,are variable length as a result.
v1.5.0-windows,form the header as a byte array for the crc
v1.5.0-windows,unpack the message...
v1.5.0-windows,pack the payload buffer.
v1.5.0-windows,"json can't handle ""nan"", so we convert it to null."
v1.5.0-windows,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.5.0-windows,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,start listening to this connection
v1.5.0-windows,Send heartbeat to drone.  You should not do this if some other node is
v1.5.0-windows,already doing it.
v1.5.0-windows,stop listening to the connection.
v1.5.0-windows,get the connection
v1.5.0-windows,Get the local system and component id
v1.5.0-windows,send a command to the remote node
v1.5.0-windows,MavLinkNode::MavLinkNode() = default;
v1.5.0-windows,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.5.0-windows,decrementing the count so the next WaitOne may block.
v1.5.0-windows,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.5.0-windows,convert to absolute time.
v1.5.0-windows,use mach_timespec
v1.5.0-windows,convert to absolute time.
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,return true if we still have offboard control (can lose this if user flips the switch).
v1.5.0-windows,MavLinkVehicle::MavLinkVehicle() = default;
v1.5.0-windows,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.5.0-windows,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,============================== CLIENT ============================================
v1.5.0-windows,image APIs
v1.5.0-windows,or if you are implementing the client side call this function to get the most recent frame.
v1.5.0-windows,returns false if there is no new frame available.
v1.5.0-windows,============================== SERVER ============================================
v1.5.0-windows,call this to send the image back over the connection given to start function.
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,"log every message that is ""sent"" using sendMessage."
v1.5.0-windows,"log every message that is ""received"""
v1.5.0-windows,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.5.0-windows,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.5.0-windows,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.5.0-windows,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,for compatibility with QGroundControl we have to save the time field in big endian.
v1.5.0-windows,todo: mavlink2 support?
v1.5.0-windows,has to be one or the other!
v1.5.0-windows,24 bits.
v1.5.0-windows,24 bits.
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,start listening to this connection
v1.5.0-windows,Send heartbeat to drone.  You should not do this if some other node is
v1.5.0-windows,already doing it.
v1.5.0-windows,this is called for all messages received on the connection.
v1.5.0-windows,"we received a heartbeat, so let's get the capabilities."
v1.5.0-windows,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.5.0-windows,subclasses remembering to call this base implementation.
v1.5.0-windows,stop listening to the connection.
v1.5.0-windows,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.5.0-windows,wait for a heartbeat msg since this will give us the port to send commands to...
v1.5.0-windows,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.5.0-windows,send a heart beat so that the remote node knows we are still alive
v1.5.0-windows,(otherwise drone will trigger a failsafe operation).
v1.5.0-windows,ignore any failures here because we are running in our own thread here.
v1.5.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.5.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.5.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.5.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.5.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.5.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.5.0-windows,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.5.0-windows,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.5.0-windows,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.5.0-windows,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.5.0-windows,"ok, now fetch the missing parameters."
v1.5.0-windows,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.5.0-windows,silently fail since we are on a background thread here...
v1.5.0-windows,tell the caller this is complete.
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,add our custom telemetry message length.
v1.5.0-windows,todo: if we support signing then initialize
v1.5.0-windows,mavlink_intermediate_status_.signing callbacks
v1.5.0-windows,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.5.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.5.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.5.0-windows,send this right away just in case serial link is not already configured
v1.5.0-windows,"log every message that is ""sent"" using sendMessage."
v1.5.0-windows,"log every message that is ""sent"" using sendMessage."
v1.5.0-windows,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.5.0-windows,pack the payload buffer.
v1.5.0-windows,calculate checksum
v1.5.0-windows,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.5.0-windows,are variable length as a result.
v1.5.0-windows,form the header as a byte array for the crc
v1.5.0-windows,these macros use old style cast.
v1.5.0-windows,forward messages from our connected node to the remote proxy.
v1.5.0-windows,tell the remote connection to expect mavlink2 messages.
v1.5.0-windows,forward messages from remote proxy to local connected node
v1.5.0-windows,CurrentThread::setMaximumPriority();
v1.5.0-windows,"hmmm, wait till it is opened?"
v1.5.0-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.5.0-windows,pick up the sysid/compid of the remote node we are connected to.
v1.5.0-windows,then this is a mavlink 1 message
v1.5.0-windows,then this mavlink sender supports mavlink 2
v1.5.0-windows,queue event for publishing.
v1.5.0-windows,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.5.0-windows,as it ensures we don't lose messages if the listener is slow.
v1.5.0-windows,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.5.0-windows,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.5.0-windows,we would get a deadlock.
v1.5.0-windows,CurrentThread::setMaximumPriority();
v1.5.0-windows,reset counters
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,------------------------------------------------------------------------------
v1.5.0-windows,Defines
v1.5.0-windows,------------------------------------------------------------------------------
v1.5.0-windows,bit number  876543210987654321
v1.5.0-windows,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.5.0-windows,in future it would be good to have ability to add system IDs we are interested in
v1.5.0-windows,if (msg.sysid != getTargetSystemId())
v1.5.0-windows,{
v1.5.0-windows,// we only care about messages from our intended remote node.
v1.5.0-windows,return;
v1.5.0-windows,}
v1.5.0-windows,user may have changed modes on us! So we need to honor that and not
v1.5.0-windows,try and take it back.
v1.5.0-windows,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.5.0-windows,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.5.0-windows,we can store up to 16 channels in rc_channels_scaled.
v1.5.0-windows,The RAW values of the servo outputs
v1.5.0-windows,Metrics typically displayed on a HUD for fixed wing aircraft
v1.5.0-windows,The IMU readings in SI units in NED body frame
v1.5.0-windows,printSystemStatus(&msg);
v1.5.0-windows,todo: use this to determine when we need to do emergency landing...
v1.5.0-windows,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.5.0-windows,Provides state for additional features
v1.5.0-windows,The general system state
v1.5.0-windows,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.5.0-windows,but we do want to know when we get the ack.  So this is async ACK processing!
v1.5.0-windows,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.5.0-windows,if threshold < 0 then the threshold is inverted.
v1.5.0-windows,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.5.0-windows,Convert it to a floating point number between -1 and 1.
v1.5.0-windows,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.5.0-windows,until the move commands start happening.
v1.5.0-windows,return true if user calls requestControl and has not called releaseControl.
v1.5.0-windows,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.5.0-windows,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.5.0-windows,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.5.0-windows,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.5.0-windows,send a few to make sure it gets through...
v1.5.0-windows,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.5.0-windows,us by which time the PX4 times out offboard mode!!
v1.5.0-windows,"assume this was successful, we'll find out if so in the next heartbeat."
v1.5.0-windows,this mode change take precedence over offboard mode.
v1.5.0-windows,thrust must be between -1 and 1.
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,These definitions are copied from PX4 implementation
v1.5.0-windows,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.5.0-windows,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.5.0-windows,/ @brief Command opcodes
v1.5.0-windows,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.5.0-windows,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.5.0-windows,must trim trailing slashes so PX4 doesn't hang!
v1.5.0-windows,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.5.0-windows,from the source.
v1.5.0-windows,check if directory exists.
v1.5.0-windows,perfect.
v1.5.0-windows,use last_message_ so we preserve the sessionid.
v1.5.0-windows,"could not create the local file, so stop."
v1.5.0-windows,must use last_message_ so we preserve the session id.
v1.5.0-windows,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.5.0-windows,todo: error handling here? sequence is out of order...
v1.5.0-windows,"directory must be empty then, can't do nextStep because"
v1.5.0-windows,it will just loop for ever re-requesting zero offset into
v1.5.0-windows,empty directory.
v1.5.0-windows,result should be a list of null terminated file names.
v1.5.0-windows,skipping this entry
v1.5.0-windows,remove the file size field.
v1.5.0-windows,"printf(""%s\n"", name.c_str());"
v1.5.0-windows,request the next batch.
v1.5.0-windows,"perhaps this was a late response after we did a retry, so ignore it."
v1.5.0-windows,"perhaps this was a late response after we did a retry, so ignore it."
v1.5.0-windows,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.5.0-windows,reached the end of the list or the file.
v1.5.0-windows,end of file or directory listing.
v1.5.0-windows,"success, data should be following..."
v1.5.0-windows,ack on this cmd is a noop
v1.5.0-windows,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.5.0-windows,give up then.
v1.5.0-windows,tell watchdog we are sending a request
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,================================= CLIENT ==============================================================
v1.5.0-windows,Check if we have a valid transaction
v1.5.0-windows,emit signal if all packets arrived
v1.5.0-windows,Restart statemachine
v1.5.0-windows,image APIs
v1.5.0-windows,================================= SERVER ==============================================================
v1.5.0-windows,Prepare and send acknowledgment packet
v1.5.0-windows,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.5.0-windows,Send ENCAPSULATED_IMAGE packet
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.5.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.5.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.5.0-windows,send this right away just in case serial link is not already configured
v1.5.0-windows,CurrentThread::setMaximumPriority();
v1.5.0-windows,"hmmm, wait till it is opened?"
v1.5.0-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.5.0-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.5.0-windows,queue event for publishing.
v1.5.0-windows,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.5.0-windows,as it ensures we don't lose messages if the listener is slow.
v1.5.0-windows,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.5.0-windows,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.5.0-windows,we would get a deadlock.
v1.5.0-windows,CurrentThread::setMaximumPriority();
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.5.0-windows,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.5.0-windows,parse out the VID number
v1.5.0-windows,now the PID
v1.5.0-windows,parse out the VID number
v1.5.0-windows,examples:
v1.5.0-windows,PX4: USB\VID_26AC&PID_0011\0
v1.5.0-windows,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.5.0-windows,"printf(""Found: %S\n"", buffer.c_str());"
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.5.0-windows,parse out the VID number
v1.5.0-windows,now the PID
v1.5.0-windows,parse out the VID number
v1.5.0-windows,suppress
v1.5.0-windows,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,This has not been properly tested
v1.5.0-windows,struct iw_statistics stats;
v1.5.0-windows,struct iwreq req;
v1.5.0-windows,"memset(&stats, 0, sizeof(stats));"
v1.5.0-windows,"memset(&req, 0, sizeof(iwreq));"
v1.5.0-windows,
v1.5.0-windows,"strncpy(req.ifr_name, ifaceName, 16);"
v1.5.0-windows,req.u.data.pointer = &stats;
v1.5.0-windows,req.u.data.length = sizeof(iw_statistics);
v1.5.0-windows,
v1.5.0-windows,#ifdef CLEAR_UPDATED
v1.5.0-windows,req.u.data.flags = 1;
v1.5.0-windows,#endif
v1.5.0-windows,
v1.5.0-windows,/* Perform the ioctl */
v1.5.0-windows,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.5.0-windows,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.5.0-windows,return -127;
v1.5.0-windows,}
v1.5.0-windows,
v1.5.0-windows,return stats.qual.level;
v1.5.0-windows,todo: windows version of this...
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,windows
v1.5.0-windows,Need to link with Ws2_32.lib
v1.5.0-windows,posix
v1.5.0-windows,found it!
v1.5.0-windows,bind socket to local address.
v1.5.0-windows,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.5.0-windows,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.5.0-windows,write to the serial port
v1.5.0-windows,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.5.0-windows,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.5.0-windows,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.5.0-windows,"try and receive something, up until port is closed anyway."
v1.5.0-windows,"message was too large for the buffer, no problem, return what we have."
v1.5.0-windows,try again - this can happen if server recreates the socket on their side.
v1.5.0-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.5.0-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.5.0-windows,"printf(""#### recv failed with error: %d\n"", hr);"
v1.5.0-windows,we now have it.
v1.5.0-windows,this is from someone we are not interested in.
v1.5.0-windows,-----------------------------------------------------------------------------------------
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,Initialize Winsock
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,windows
v1.5.0-windows,Need to link with Ws2_32.lib
v1.5.0-windows,posix
v1.5.0-windows,found it!
v1.5.0-windows,bind socket to local address.
v1.5.0-windows,bind socket to local address.
v1.5.0-windows,start listening for incoming connection
v1.5.0-windows,accept 1
v1.5.0-windows,"don't need to accept any more, so we can close this one."
v1.5.0-windows,write to the serial port
v1.5.0-windows,"try and receive something, up until port is closed anyway."
v1.5.0-windows,"message was too large for the buffer, no problem, return what we have."
v1.5.0-windows,try again - this can happen if server recreates the socket on their side.
v1.5.0-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.5.0-windows,try again - this can happen if server recreates the socket on their side.
v1.5.0-windows,-----------------------------------------------------------------------------------------
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.5.0-windows,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.5.0-windows,set signal
v1.5.0-windows,Clear Handshake flags
v1.5.0-windows,Set Handshake flags
v1.5.0-windows,return GetLastError();
v1.5.0-windows,return GetLastError();
v1.5.0-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.5.0-windows,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.5.0-windows,enable reading
v1.5.0-windows,posix doesn't have mark/space parity.
v1.5.0-windows,posix doesn't have mark/space parity.
v1.5.0-windows,this is the default.
v1.5.0-windows,not sure this is supported...
v1.5.0-windows,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.5.0-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.5.0-windows,First do those specified by POSIX.
v1.5.0-windows,Now conditionally handle a bunch of extended rates.
v1.5.0-windows,First do those specified by POSIX.
v1.5.0-windows,Now conditionally handle a bunch of extended rates.
v1.5.0-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.5.0-windows,import airsim
v1.5.0-windows,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v1.5.0-windows,self.args = args
v1.5.0-windows,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v1.5.0-windows,pdb.set_trace()
v1.5.0-windows,#include <pluginlib/class_list_macros.h>
v1.5.0-windows,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v1.5.0-windows,todo do not reset if already in air?
v1.5.0-windows,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.5.0-windows,ros params
v1.5.0-windows,todo enforce dynamics constraints in this node as well?
v1.5.0-windows,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v1.5.0-windows,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v1.5.0-windows,XmlRpc::XmlRpcValue can't be const in this case
v1.5.0-windows,subscribe to control commands on global nodehandle
v1.5.0-windows,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.5.0-windows,bind to a single callback. todo optimal subs queue length
v1.5.0-windows,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.5.0-windows,"vehicle_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.5.0-windows,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.5.0-windows,camera_setting.gimbal
v1.5.0-windows,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.5.0-windows,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.5.0-windows,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.5.0-windows,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.5.0-windows,"if {DepthPlanar, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.5.0-windows,"push back pair (vector of image captures, current vehicle name)"
v1.5.0-windows,iterate over sensors
v1.5.0-windows,"we want fast access to the lidar sensors for callback handling, sort them out now"
v1.5.0-windows,add takeoff and land all services if more than 2 drones
v1.5.0-windows,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v1.5.0-windows,todo add per vehicle reset in AirLib API
v1.5.0-windows,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.5.0-windows,lidars update on their own callback/thread at a given rate
v1.5.0-windows,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v1.5.0-windows,"todo: error check. if state is not landed, return error."
v1.5.0-windows,response.success =
v1.5.0-windows,response.success =
v1.5.0-windows,response.success =
v1.5.0-windows,response.success =
v1.5.0-windows,response.success =
v1.5.0-windows,response.success =
v1.5.0-windows,todo add reset by vehicle_name API to airlib
v1.5.0-windows,todo not async remove waitonlasttask
v1.5.0-windows,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v1.5.0-windows,todo do actual body frame?
v1.5.0-windows,airsim uses degrees
v1.5.0-windows,todo do actual body frame?
v1.5.0-windows,airsim uses degrees
v1.5.0-windows,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v1.5.0-windows,todo expose waitOnLastTask or nah?
v1.5.0-windows,todo do actual body frame?
v1.5.0-windows,airsim uses degrees
v1.5.0-windows,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.5.0-windows,todo expose waitOnLastTask or nah?
v1.5.0-windows,todo support multiple gimbal commands
v1.5.0-windows,todo support multiple gimbal commands
v1.5.0-windows,1. find quaternion of default gimbal pose
v1.5.0-windows,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.5.0-windows,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.5.0-windows,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.5.0-windows,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.5.0-windows,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.5.0-windows,msg = []
v1.5.0-windows,todo covariances
v1.5.0-windows,gps_msg.position_covariance_type =
v1.5.0-windows,gps_msg.position_covariance =
v1.5.0-windows,todo covariances
v1.5.0-windows,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.5.0-windows,todo radians per second
v1.5.0-windows,meters/s2^m
v1.5.0-windows,imu_msg.orientation_covariance = ;
v1.5.0-windows,imu_msg.angular_velocity_covariance = ;
v1.5.0-windows,imu_msg.linear_acceleration_covariance = ;
v1.5.0-windows,airsim appears to use chrono::system_clock with nanosecond precision
v1.5.0-windows,todo this is global origin
v1.5.0-windows,get the basic vehicle pose and environmental state
v1.5.0-windows,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.5.0-windows,airsim_client needs to provide the simulation time in a future version of the API
v1.5.0-windows,publish the simulation clock
v1.5.0-windows,"publish vehicle state, odom, and all basic sensor types"
v1.5.0-windows,send any commands out to the vehicles
v1.5.0-windows,"should be easier way to get the sim time through API, something like:"
v1.5.0-windows,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.5.0-windows,curr_ros_time = airsim_timestamp_to_ros(env.clock().nowNanos());
v1.5.0-windows,iterate over drones
v1.5.0-windows,get drone state from airsim
v1.5.0-windows,"vehicle environment, we can get ambient temperature here and other truths"
v1.5.0-windows,convert airsim drone state to ROS msgs
v1.5.0-windows,simulation environment truth
v1.5.0-windows,"dashboard reading from car, RPM, gear, etc"
v1.5.0-windows,odom and transforms
v1.5.0-windows,ground truth GPS position from sim/HITL
v1.5.0-windows,handled via callback
v1.5.0-windows,send control commands from the last callback to airsim
v1.5.0-windows,send control commands from the last callback to airsim
v1.5.0-windows,"Only camera rotation, no translation movement of camera"
v1.5.0-windows,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.5.0-windows,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.5.0-windows,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.5.0-windows,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.5.0-windows,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.5.0-windows,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.5.0-windows,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.5.0-windows,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.5.0-windows,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.5.0-windows,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.5.0-windows,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.5.0-windows,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.5.0-windows,update timestamp of saved cam info msgs
v1.5.0-windows,DepthPlanar / DepthPerspective / DepthVis / DisparityNormalized
v1.5.0-windows,Scene / Segmentation / SurfaceNormals / Infrared
v1.5.0-windows,publish camera transforms
v1.5.0-windows,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.5.0-windows,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.5.0-windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.5.0-windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.5.0-windows,ROS params
v1.5.0-windows,ROS publishers
v1.5.0-windows,ROS subscribers
v1.5.0-windows,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.5.0-windows,ROS timers
v1.5.0-windows,todo maintain internal representation as eigen vec?
v1.5.0-windows,todo check if low velocity if within thresh?
v1.5.0-windows,todo maintain separate errors for XY and Z
v1.5.0-windows,todo save this in degrees somewhere to avoid repeated conversion
v1.5.0-windows,this tells the update timer callback to not do active hovering
v1.5.0-windows,todo maintain array of position goals
v1.5.0-windows,todo error checks
v1.5.0-windows,todo fill response
v1.5.0-windows,"Already have goal, and have reached it"
v1.5.0-windows,this tells the update timer callback to not do active hovering
v1.5.0-windows,todo error checks
v1.5.0-windows,todo fill response
v1.5.0-windows,"todo do relative altitude, or add an option for the same?"
v1.5.0-windows,convert GPS goal to NED goal
v1.5.0-windows,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.5.0-windows,todo error checks
v1.5.0-windows,todo fill response
v1.5.0-windows,"Already have goal, this shouldn't happen"
v1.5.0-windows,"todo do relative altitude, or add an option for the same?"
v1.5.0-windows,convert GPS goal to NED goal
v1.5.0-windows,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.5.0-windows,todo error checks
v1.5.0-windows,todo fill response
v1.5.0-windows,todo check if odometry is too old!!
v1.5.0-windows,"if no odom, don't do anything."
v1.5.0-windows,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.5.0-windows,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.5.0-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.5.0-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.5.0-windows,todo yaw limits
v1.5.0-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.5.0-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.5.0-windows,mimics void ASimHUD::initializeSettings()
v1.5.0-windows,int num_threads = 1;
v1.5.0-windows,ros::MultiThreadedSpinner multi_thread(num_threads);
v1.5.0-windows,multi_thread.spin();
v1.5.0-windows,ros::AsyncSpinner async_spinner(num_threads);
v1.5.0-windows,async_spinner.start();
v1.5.0-windows,single threaded spinner
v1.5.0-windows,connect to the AirSim simulator
v1.5.0-windows,","
v1.5.0-windows,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.5.0-windows,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,"in header only mode, control library is not available"
v1.5.0-windows,TODO: something defines max macro which interfears with code here
v1.5.0-windows,is cur_pos within fence?
v1.5.0-windows,destination risk is not available then consider it zero
v1.5.0-windows,if dest risk is lower than its more safe
v1.5.0-windows,are we doing better than closest obstacle?
v1.5.0-windows,"if we stay where we are, what is the risk distance?"
v1.5.0-windows,else we are better of moving to dest
v1.5.0-windows,this function should work even when dest_pos == cur_pos
v1.5.0-windows,is this dest_pos cur_pos within the fence?
v1.5.0-windows,transform dest_pos vector to body frame
v1.5.0-windows,check for approx zero vectors to avoid random yaw angles
v1.5.0-windows,we are hovering
v1.5.0-windows,"get yaw in body frame, ie, front is always 0 radians"
v1.5.0-windows,yaw to ticks
v1.5.0-windows,get obstacles in the window at the tick direction around the window
v1.5.0-windows,less risk distance is better
v1.5.0-windows,check obstacles around current position and see if it has lower risk
v1.5.0-windows,else obstacle is too far
v1.5.0-windows,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.5.0-windows,look for each surrounding tick to see if we have obstacle free angle
v1.5.0-windows,else no suggestions required
v1.5.0-windows,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.5.0-windows,evaluate right and left side of circle
v1.5.0-windows,find right and left risk distances
v1.5.0-windows,at this point we have already determined hover is better than going to dest
v1.5.0-windows,we now determine is moving to suggested angle better than hovering?
v1.5.0-windows,check if dest_pos is safe
v1.5.0-windows,breaking distance at this velocity
v1.5.0-windows,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.5.0-windows,check if dest_pos is safe
v1.5.0-windows,float/vec parameters can have NaN which makes them optional
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,"in header only mode, control library is not available"
v1.5.0-windows,handles +/- tick and wraps around circle
v1.5.0-windows,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.5.0-windows,update the specified window on the map
v1.5.0-windows,make sure from <= to
v1.5.0-windows,normalize the ticks so both are valid indices
v1.5.0-windows,if from is still larger then
v1.5.0-windows,to ticks is then added one full circle to make it larger than from_tick
v1.5.0-windows,find closest obstacle in given window
v1.5.0-windows,search whole map to find closest obstacle
v1.5.0-windows,"in header only mode, control library is not available"
v1.5.0-windows,#include <fileapi.h>
v1.5.0-windows,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.5.0-windows,"Windows, OSX and Linux."
v1.5.0-windows,Windows users can move the Documents folder to any location they want
v1.5.0-windows,SHGetFolderPath knows how to find it.
v1.5.0-windows,fall back in case SHGetFolderPath failed for some reason.
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,"in header only mode, control library is not available"
v1.5.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.5.0-windows,if using Unreal Build system then include precompiled header file first
v1.5.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.5.0-windows,this deadlocks UI thread if async_run was called while there are pending rpc calls.
v1.5.0-windows,Exit if already resetting.
v1.5.0-windows,Reset
v1.5.0-windows,if we don't suppress then server will bomb out for exceptions raised by any method
v1.5.0-windows,required for pimpl
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,"in header only mode, control library is not available"
v1.5.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.5.0-windows,if using Unreal Build system then include precompiled header file first
v1.5.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.5.0-windows,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.5.0-windows,make sure we can talk to the DroneServer
v1.5.0-windows,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.5.0-windows,command_context.client.ping();
v1.5.0-windows,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.5.0-windows,sim only
v1.5.0-windows,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.5.0-windows,return value of last task. It should be true if task completed without
v1.5.0-windows,cancellation or timeout
v1.5.0-windows,"should be implemented by derived class if it supports async task,"
v1.5.0-windows,for example using futures
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,"in header only mode, control library is not available"
v1.5.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.5.0-windows,if using Unreal Build system then include precompiled header file first
v1.5.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,"in header only mode, control library is not available"
v1.5.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.5.0-windows,if using Unreal Build system then include precompiled header file first
v1.5.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.5.0-windows,required for pimpl
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,"in header only mode, control library is not available"
v1.5.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.5.0-windows,if using Unreal Build system then include precompiled header file first
v1.5.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.5.0-windows,status getters
v1.5.0-windows,Rotor state getter
v1.5.0-windows,Multirotor state getter
v1.5.0-windows,return value of last task. It should be true if task completed without
v1.5.0-windows,cancellation or timeout
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,"in header only mode, control library is not available"
v1.5.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.5.0-windows,if using Unreal Build system then include pre-compiled header file first
v1.5.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.5.0-windows,getters
v1.5.0-windows,Rotor state
v1.5.0-windows,Multirotor state
v1.5.0-windows,required for pimpl
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,"in header only mode, control library is not available"
v1.5.0-windows,last command is to hold on to position
v1.5.0-windows,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.5.0-windows,after landing we detect if drone has stopped moving
v1.5.0-windows,validate path size
v1.5.0-windows,validate yaw mode
v1.5.0-windows,validate and set auto-lookahead value
v1.5.0-windows,if auto mode requested for lookahead then calculate based on velocity
v1.5.0-windows,add current position as starting point
v1.5.0-windows,append the input path and compute segments
v1.5.0-windows,add last segment as zero length segment so we have equal number of segments and points.
v1.5.0-windows,path_segs[i] refers to segment that starts at point i
v1.5.0-windows,"when path ends, we want to slow down"
v1.5.0-windows,else no need to change velocities for last segments
v1.5.0-windows,setup current position on path to 0 offset
v1.5.0-windows,initialize next path position
v1.5.0-windows,until we are at the end of the path (last seg is always zero size)
v1.5.0-windows,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.5.0-windows,send drone command to get to next lookahead
v1.5.0-windows,sleep for rest of the cycle
v1.5.0-windows,how much have we moved towards last goal?
v1.5.0-windows,project actual vector on goal vector
v1.5.0-windows,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.5.0-windows,TODO: below should be lower than 1E3 and configurable
v1.5.0-windows,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.5.0-windows,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.5.0-windows,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.5.0-windows,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.5.0-windows,"if drone moved backward, we don't want goal to move backward as well"
v1.5.0-windows,"so only climb forward on the path, never back. Also note >= which means"
v1.5.0-windows,we climb path even if distance was 0 to take care of duplicated points on path
v1.5.0-windows,else
v1.5.0-windows,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.5.0-windows,compute next target on path
v1.5.0-windows,freeze the quaternion
v1.5.0-windows,convert RC commands to velocity vector
v1.5.0-windows,find yaw as per terrain and remote setting
v1.5.0-windows,execute command
v1.5.0-windows,if timeout occurred then command completed successfully otherwise it was interrupted
v1.5.0-windows,yaw is not within margin
v1.5.0-windows,by default we say that this command is not supported
v1.5.0-windows,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.5.0-windows,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.5.0-windows,get trims
v1.5.0-windows,take average
v1.5.0-windows,validate dest
v1.5.0-windows,what is the distance we will travel at this velocity?
v1.5.0-windows,get velocity vector
v1.5.0-windows,yaw for the direction of travel
v1.5.0-windows,find velocity vector
v1.5.0-windows,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.5.0-windows,generate velocity vector that is same size as cur_dest_norm / command period
v1.5.0-windows,this velocity vect when executed for command period would yield cur_dest_norm
v1.5.0-windows,send commands
v1.5.0-windows,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.5.0-windows,default strategy is for move. In hover mode we set new strategy temporarily
v1.5.0-windows,are we supposed to do EM?
v1.5.0-windows,get suggested velocity vector
v1.5.0-windows,use the unchecked command
v1.5.0-windows,tell caller not to execute planned command
v1.5.0-windows,other wise throw exception
v1.5.0-windows,otherwise there is some other reason why we are in unsafe situation
v1.5.0-windows,send last command to come to full stop
v1.5.0-windows,else no unsafe situation
v1.5.0-windows,note: cur_path_loc and next_path_loc may both point to same object
v1.5.0-windows,"otherwise use up this segment, move on to next one"
v1.5.0-windows,if we are here then we ran out of segments
v1.5.0-windows,consider last segment as zero length segment
v1.5.0-windows,adjust yaw for the direction of travel in forward-only mode
v1.5.0-windows,else no adjustment needed
v1.5.0-windows,if auto mode requested for lookahead then calculate based on velocity
v1.5.0-windows,Create a spring arm component for our chase camera
v1.5.0-windows,"do nothing, spring arm is pulling the camera with it"
v1.5.0-windows,"do nothing, we have camera turned off"
v1.5.0-windows,set initial view mode
v1.5.0-windows,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.5.0-windows,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.5.0-windows,"If the lag is missing, the camera will also occasionally shake."
v1.5.0-windows,"But, lag is not desired when piloting a drone"
v1.5.0-windows,attach spring arm to actor
v1.5.0-windows,remember current parent for external camera. Later when we remove external
v1.5.0-windows,"camera from spring arm, we will attach it back to its last parent"
v1.5.0-windows,now attach camera to spring arm
v1.5.0-windows,"For car, we need to move the camera back a little more than for a drone."
v1.5.0-windows,"Otherwise, the camera will be stuck inside the car"
v1.5.0-windows,ExternalCamera->bUsePawnControlRotation = false;
v1.5.0-windows,detach spring arm
v1.5.0-windows,Re-enable rendering
v1.5.0-windows,Remove any existing key bindings for manual mode
v1.5.0-windows,"else someone else is bound to manual pose controller, leave it alone"
v1.5.0-windows,if new mode is manual mode then add key bindings
v1.5.0-windows,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.5.0-windows,other modes don't need special setup
v1.5.0-windows,make switch official
v1.5.0-windows,Add loading screen to viewport
v1.5.0-windows,Remove Loading screen from viewport
v1.5.0-windows,Create struct for Location and Rotation of actor in Unreal
v1.5.0-windows,new_actor_spawn_params.NameMode = FActorSpawnParameters::ESpawnActorNameMode::Required_ReturnNull;
v1.5.0-windows,Write the binvox file using run-length encoding
v1.5.0-windows,"where each pair of bytes is of the format (run value, run length)"
v1.5.0-windows,This is a run (repeated bit value)
v1.5.0-windows,End of a run
v1.5.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.5.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.5.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.5.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.5.0-windows,Split the tag string into individual tags.
v1.5.0-windows,Texture swap on actors that have all of those tags.
v1.5.0-windows,----------- Plotting APIs ----------/
v1.5.0-windows,"plot line for points 0-1, 1-2, 2-3"
v1.5.0-windows,"plot line for points 0-1, 2-3, 4-5... must be even number of points"
v1.5.0-windows,assert points_start.size() == poinst_end.size()
v1.5.0-windows,assert positions.size() == strings.size()
v1.5.0-windows,assert poses.size() == names.size()
v1.5.0-windows,Recording APIs
v1.5.0-windows,by default all image types are disabled
v1.5.0-windows,use final color for all calculations
v1.5.0-windows,TODO: avoid the need to override const cast here
v1.5.0-windows,if the viewport is taller than it is wide
v1.5.0-windows,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v1.5.0-windows,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v1.5.0-windows,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v1.5.0-windows,use final color for all calculations
v1.5.0-windows,TODO: should we be ignoring position and orientation settings here?
v1.5.0-windows,TODO: can we eliminate storing NedTransform?
v1.5.0-windows,if (!std::isnan(setting.target_gamma))
v1.5.0-windows,camera-> = setting.target_gamma;
v1.5.0-windows,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.5.0-windows,else nothing to enable
v1.5.0-windows,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.5.0-windows,if (controller && controller->GetViewTarget() == this)
v1.5.0-windows,controller->SetViewTarget(nullptr);
v1.5.0-windows,"Check whether requested map exists, this could be very slow if LevelName is a short package name"
v1.5.0-windows,Create Unique Name for sub-level package
v1.5.0-windows,Setup streaming level object that will load specified map
v1.5.0-windows,Transform
v1.5.0-windows,Map to Load
v1.5.0-windows,Add the new level to world.
v1.5.0-windows,TODO: explore screenshot option
v1.5.0-windows,addScreenCaptureHandler(camera->GetWorld());
v1.5.0-windows,TODO: may be we should have these methods non-const?
v1.5.0-windows,We don't do game/render thread synchronization for safe method.
v1.5.0-windows,We just blindly sleep for 200ms (the old way)
v1.5.0-windows,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.5.0-windows,Make sure that all alpha values are opaque.
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,TODO: change naming conventions to same as other files?
v1.5.0-windows,"context->GetWorld()->SetNewWorldOrigin(FIntVector(0, 0, 0));"
v1.5.0-windows,Enable/disable primary viewport rendering flag
v1.5.0-windows,This disables rendering of the main viewport in the same way as the
v1.5.0-windows,"console command ""show rendering"" would do."
v1.5.0-windows,"When getting an image through the API, the image is produced after the render"
v1.5.0-windows,thread has finished rendering the current and the subsequent frame. This means
v1.5.0-windows,that the frame rate for obtaining images through the API is only half as high as
v1.5.0-windows,"it could be, since only every other image is actually captured. We work around"
v1.5.0-windows,this by telling the viewport to flush the rendering queue at the end of each
v1.5.0-windows,drawn frame so that it executes our render request at that point already.
v1.5.0-windows,Do this only if the main viewport is not being rendered anyway in case there are
v1.5.0-windows,any adverse performance effects during main rendering.
v1.5.0-windows,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v1.5.0-windows,nothing to do for now
v1.5.0-windows,"if hidden, clear any existing messages"
v1.5.0-windows,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.5.0-windows,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.5.0-windows,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.5.0-windows,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.5.0-windows,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.5.0-windows,Find mesh in /Game and /AirSim asset registry. When more plugins are added this function will have to change
v1.5.0-windows,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.5.0-windows,{
v1.5.0-windows,InitializeObjectStencilID(*comp);
v1.5.0-windows,}
v1.5.0-windows,"Takes a UStaticMeshComponent, USkinnedMeshComponent or ALandscapeProxy and returns their custom stencil ID if"
v1.5.0-windows,their meshes's name or their owner's name (depending on the naming method in mesh_naming_method_) equals mesh_name
v1.5.0-windows,"The skybox is ignored here as it is huge, and really is of no use to the end user typically. Also the associated meshes with the cameras"
v1.5.0-windows,Various checks if there is even a valid mesh
v1.5.0-windows,Need to force the render command to go through cause on the next iteration the buffer no longer exists
v1.5.0-windows,Unreal stores more vertices than triangles. So here we find the highest referenced vertex and ignore any after that
v1.5.0-windows,can we see followee?
v1.5.0-windows,remove mapping
v1.5.0-windows,removing binding
v1.5.0-windows,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.5.0-windows,"some point. At the moment, manually swapping Red and Blue"
v1.5.0-windows,Copy scaled image into destination thumb
v1.5.0-windows,Compress data - convert into a .png
v1.5.0-windows,if we already have attached actor
v1.5.0-windows,#ifdef _MSC_VER
v1.5.0-windows,//print to VS output window
v1.5.0-windows,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.5.0-windows,#endif
v1.5.0-windows,also do default logging
v1.5.0-windows,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.5.0-windows,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.5.0-windows,{
v1.5.0-windows,if (GEngine != nullptr)
v1.5.0-windows,{
v1.5.0-windows,return GEngine->GameUserSettings;
v1.5.0-windows,}
v1.5.0-windows,return nullptr;
v1.5.0-windows,}
v1.5.0-windows,UGameUserSettings* game_settings = GetGameUserSettings();
v1.5.0-windows,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.5.0-windows,game_settings->ApplySettings(true);
v1.5.0-windows,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.5.0-windows,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.5.0-windows,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.5.0-windows,todo unused. need to manually plots tf axes' line in right handed FLU instead of using DrawDebugCoordinateSystem
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,plugin startup
v1.5.0-windows,plugin shutdown
v1.5.0-windows,initialize state
v1.5.0-windows,add listener for pawn's collision event
v1.5.0-windows,compute our home point
v1.5.0-windows,default behavior is to call update every tick
v1.5.0-windows,"for custom physics engine, this method should be overridden and update should be"
v1.5.0-windows,called from every physics tick
v1.5.0-windows,add cameras that already exists in pawn
v1.5.0-windows,create or replace cameras specified in settings
v1.5.0-windows,setup individual cameras
v1.5.0-windows,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.5.0-windows,for each camera in settings
v1.5.0-windows,get pose
v1.5.0-windows,spawn and attach camera to pawn
v1.5.0-windows,add on to our collection
v1.5.0-windows,Deflect along the surface when we collide.
v1.5.0-windows,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.5.0-windows,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.5.0-windows,-1 to 1 --> 0 to 1
v1.5.0-windows,-1 to 1
v1.5.0-windows,these will be available for devices like steering wheels
v1.5.0-windows,switch index 0 to 7 for FrSky Taranis RC is:
v1.5.0-windows,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.5.0-windows,TODO: should below be at controller level info?
v1.5.0-windows,else don't waste time
v1.5.0-windows,sync environment from kinematics
v1.5.0-windows,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.5.0-windows,void playBack()
v1.5.0-windows,{
v1.5.0-windows,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.5.0-windows,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.5.0-windows,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.5.0-windows,}
v1.5.0-windows,TODO: refactor below code used for playback
v1.5.0-windows,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.5.0-windows,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.5.0-windows,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.5.0-windows,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.5.0-windows,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.5.0-windows,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.5.0-windows,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.5.0-windows,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.5.0-windows,}
v1.5.0-windows,parameters in NED frame
v1.5.0-windows,translate to new PawnSimApi position & orientation from NED to NEU
v1.5.0-windows,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.5.0-windows,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.5.0-windows,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.5.0-windows,checked at the start of next tick
v1.5.0-windows,allow teleportation
v1.5.0-windows,if collisions are not enabled
v1.5.0-windows,or we have collided but passthrough is enabled
v1.5.0-windows,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.5.0-windows,"without flip flopping, collisions can't be detected"
v1.5.0-windows,update kinematics from pawn's movement instead of physics engine
v1.5.0-windows,by default we update kinematics from UE pawn
v1.5.0-windows,if SimMod uses its own physics engine then this should be overriden
v1.5.0-windows,no default action in this base class
v1.5.0-windows,"read pixels from render target using render thread, then compress the result into PNG"
v1.5.0-windows,argument on the thread that calls this method.
v1.5.0-windows,TODO: is below really needed?
v1.5.0-windows,make sure we are not on the rendering thread
v1.5.0-windows,TODO: below doesn't work right now because it must be running in game thread
v1.5.0-windows,below is documented method but more expensive because it forces flush
v1.5.0-windows,wait for render thread to pick up our task
v1.5.0-windows,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.5.0-windows,capture CameraPose for this frame
v1.5.0-windows,The completion is called immeidately after GameThread sends the
v1.5.0-windows,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.5.0-windows,execute *immediately* after RenderThread renders the scene!
v1.5.0-windows,"while we're still on GameThread, enqueue request for capture the scene!"
v1.5.0-windows,wait for this task to complete
v1.5.0-windows,log a message and continue wait
v1.5.0-windows,lamda function still references a few objects for which there is no refcount.
v1.5.0-windows,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.5.0-windows,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.5.0-windows,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.5.0-windows,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.5.0-windows,Fill out your copyright notice in the Description page of Project Settings.
v1.5.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.5.0-windows,UWorld* World = GetWorld();
v1.5.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.5.0-windows,still need the menu class for f10
v1.5.0-windows,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v1.5.0-windows,showWeatherMenu(WorldContextObject);
v1.5.0-windows,"if weather is not enabled, dont allow any weather values to be set"
v1.5.0-windows,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v1.5.0-windows,and must be set to true or false before this.
v1.5.0-windows,WeatherEnabled will always be false
v1.5.0-windows,"NOTE: weather enabled must be set first, before other params for this to work"
v1.5.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.5.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.5.0-windows,"get all menu actors, if any"
v1.5.0-windows,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.5.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.5.0-windows,"get all menu actors, if any"
v1.5.0-windows,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.5.0-windows,"get all menu actors, if any, then hide the menu"
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,Stuff to filter out XInput devices
v1.5.0-windows,-----------------------------------------------------------------------------
v1.5.0-windows,"Defines, constants, and global variables"
v1.5.0-windows,-----------------------------------------------------------------------------
v1.5.0-windows,Magnitude ranges from -1 to 1
v1.5.0-windows,Strength ranges from 0 to 1
v1.5.0-windows,Autocenter
v1.5.0-windows,Rumble
v1.5.0-windows,Register with the DirectInput subsystem and get a pointer
v1.5.0-windows,to a IDirectInput interface we can use.
v1.5.0-windows,Create a DInput object
v1.5.0-windows,Look for a simple joystick we can use for this sample program.
v1.5.0-windows,Make sure we got a joystick
v1.5.0-windows,"Set the data format to ""simple joystick"" - a predefined data format"
v1.5.0-windows,
v1.5.0-windows,"A data format specifies which controls on a device we are interested in,"
v1.5.0-windows,and how they should be reported. This tells DInput that we will be
v1.5.0-windows,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.5.0-windows,Set the cooperative level to let DInput know how this device should
v1.5.0-windows,interact with the system and with other DInput applications.
v1.5.0-windows,Enumerate the joystick objects. The callback function enabled user
v1.5.0-windows,"interface elements for objects that are found, and sets the min/max"
v1.5.0-windows,values property for discovered axes.
v1.5.0-windows,-----------------------------------------------------------------------------
v1.5.0-windows,Enum each PNP device using WMI and check each device ID to see if it contains
v1.5.0-windows,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.5.0-windows,Unfortunately this information can not be found by just using DirectInput.
v1.5.0-windows,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.5.0-windows,XInput devices.
v1.5.0-windows,
v1.5.0-windows,This function stores the list of xinput devices in a linked list
v1.5.0-windows,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.5.0-windows,-----------------------------------------------------------------------------
v1.5.0-windows,CoInit if needed
v1.5.0-windows,Create WMI
v1.5.0-windows,Create BSTRs for WMI
v1.5.0-windows,Connect to WMI
v1.5.0-windows,Switch security level to IMPERSONATE
v1.5.0-windows,Get list of Win32_PNPEntity devices
v1.5.0-windows,Loop over all devices
v1.5.0-windows,Get 20 at a time
v1.5.0-windows,"For each device, get its device ID"
v1.5.0-windows,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.5.0-windows,Unfortunately this information can not be found by just using DirectInput
v1.5.0-windows,"If it does, then get the VID/PID from var.bstrVal"
v1.5.0-windows,Add the VID/PID to a linked list
v1.5.0-windows,-----------------------------------------------------------------------------
v1.5.0-windows,Returns true if the DirectInput device is also an XInput device.
v1.5.0-windows,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.5.0-windows,-----------------------------------------------------------------------------
v1.5.0-windows,Check each xinput device to see if this device's vid/pid matches
v1.5.0-windows,-----------------------------------------------------------------------------
v1.5.0-windows,Cleanup needed for IsXInputDevice()
v1.5.0-windows,-----------------------------------------------------------------------------
v1.5.0-windows,Cleanup linked list
v1.5.0-windows,-----------------------------------------------------------------------------
v1.5.0-windows,Name: EnumJoysticksCallback()
v1.5.0-windows,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.5.0-windows,device interface on it so we can play with it.
v1.5.0-windows,-----------------------------------------------------------------------------
v1.5.0-windows,Skip anything other than the perferred joystick device as defined by the control panel.
v1.5.0-windows,Instead you could store all the enumerated joysticks and let the user pick.
v1.5.0-windows,Obtain an interface to the enumerated joystick.
v1.5.0-windows,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.5.0-windows,it while we were in the middle of enumerating it.)
v1.5.0-windows,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.5.0-windows,could store all the enumerated joysticks and let the user pick.
v1.5.0-windows,-----------------------------------------------------------------------------
v1.5.0-windows,Name: EnumObjectsCallback()
v1.5.0-windows,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.5.0-windows,joystick. This function enables user interface elements for objects
v1.5.0-windows,"that are found to exist, and scales axes min/max values."
v1.5.0-windows,-----------------------------------------------------------------------------
v1.5.0-windows,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.5.0-windows,enumerated axis in order to scale min/max values.
v1.5.0-windows,Set the range for the axis
v1.5.0-windows,Set the UI to reflect what objects the joystick supports
v1.5.0-windows,-----------------------------------------------------------------------------
v1.5.0-windows,Name: UpdateInputState()
v1.5.0-windows,Desc: Get the input device's state and display it.
v1.5.0-windows,-----------------------------------------------------------------------------
v1.5.0-windows,Poll the device to read the current state
v1.5.0-windows,DInput is telling us that the input stream has been
v1.5.0-windows,"interrupted. We aren't tracking any state between polls, so"
v1.5.0-windows,we don't have any special reset that needs to be done. We
v1.5.0-windows,just re-acquire and try again.
v1.5.0-windows,while (hr == DIERR_INPUTLOST)
v1.5.0-windows,hr = g_pJoystick->Acquire();
v1.5.0-windows,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.5.0-windows,may occur when the app is minimized or in the process of
v1.5.0-windows,"switching, so just try again later"
v1.5.0-windows,Get the input's device state
v1.5.0-windows,Axes
v1.5.0-windows,Slider controls
v1.5.0-windows,Points of view
v1.5.0-windows,Buttons
v1.5.0-windows,-----------------------------------------------------------------------------
v1.5.0-windows,Name: FreeDirectInput()
v1.5.0-windows,Desc: Initialize the DirectInput variables.
v1.5.0-windows,-----------------------------------------------------------------------------
v1.5.0-windows,Unacquire the device one last time just in case
v1.5.0-windows,the app tried to exit while the device is still acquired.
v1.5.0-windows,Release any DirectInput objects.
v1.5.0-windows,nop
v1.5.0-windows,normalize min to max --> 0 to 1
v1.5.0-windows,normalize 0 to 1 --> -1 to 1
v1.5.0-windows,#include <libudev.h>
v1.5.0-windows,implementation for unsupported OS
v1.5.0-windows,if this is new index
v1.5.0-windows,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.5.0-windows,close previous one
v1.5.0-windows,open new device
v1.5.0-windows,if open was successful
v1.5.0-windows,read the device
v1.5.0-windows,if we didn't had valid read
v1.5.0-windows,"NOTE if this condition is not met, we're probably out of sync and this"
v1.5.0-windows,Joystick instance is likely unusable
v1.5.0-windows,TODO: set below to false?
v1.5.0-windows,state.is_valid = false;
v1.5.0-windows,else ignore
v1.5.0-windows,TODO: implement this for linux
v1.5.0-windows,TODO: implement this for linux
v1.5.0-windows,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.5.0-windows,{
v1.5.0-windows,"manufacturerID = productID = """";"
v1.5.0-windows,// Use udev to look up the product and manufacturer IDs
v1.5.0-windows,struct udev *udev = udev_new();
v1.5.0-windows,if (udev) {
v1.5.0-windows,char sysname[32];
v1.5.0-windows,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.5.0-windows,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.5.0-windows,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.5.0-windows,if (!dev)
v1.5.0-windows,{
v1.5.0-windows,"message = ""Unable to find parent USB device"";"
v1.5.0-windows,return false;
v1.5.0-windows,}
v1.5.0-windows,std::stringstream ss;
v1.5.0-windows,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.5.0-windows,ss >> manufacturerID;
v1.5.0-windows,ss.clear();
v1.5.0-windows,"ss.str("""");"
v1.5.0-windows,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.5.0-windows,ss >> productID;
v1.5.0-windows,udev_device_unref(dev);
v1.5.0-windows,}
v1.5.0-windows,else
v1.5.0-windows,{
v1.5.0-windows,"message = ""Cannot create udev"";"
v1.5.0-windows,return false;
v1.5.0-windows,}
v1.5.0-windows,udev_unref(udev);
v1.5.0-windows,return true;
v1.5.0-windows,}
v1.5.0-windows,required for pimpl
v1.5.0-windows,TODO: anyway to workaround const_cast?
v1.5.0-windows,FGenericPlatformMisc::PlatformInit();
v1.5.0-windows,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.5.0-windows,TODO: index check
v1.5.0-windows,create main widget
v1.5.0-windows,synchronize PIP views
v1.5.0-windows,TODO: should we only do below on SceneCapture2D components and cameras?
v1.5.0-windows,avoid motion blur so capture images don't get
v1.5.0-windows,use two different methods to set console var because sometime it doesn't seem to work
v1.5.0-windows,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.5.0-windows,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.5.0-windows,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.5.0-windows,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.5.0-windows,setup defaults
v1.5.0-windows,Attempts to parse the settings text from one of multiple locations.
v1.5.0-windows,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.5.0-windows,"Next, check the executable's working directory for the settings file."
v1.5.0-windows,"Finally, check the user's documents folder."
v1.5.0-windows,"If the settings file cannot be read, throw an exception"
v1.5.0-windows,Attempts to parse the settings file path or the settings text from the command line
v1.5.0-windows,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.5.0-windows,"Example (Path): AirSim.exe --settings ""C:\path\to\settings.json"""
v1.5.0-windows,"Example (Text): AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.5.0-windows,"Returns true if the argument is present, false otherwise."
v1.5.0-windows,build image file name
v1.5.0-windows,write image file
v1.5.0-windows,"Write PNG image, already compressed in binary"
v1.5.0-windows,write to CSV file
v1.5.0-windows,"Either images were saved successfully, or there were no images"
v1.5.0-windows,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.5.0-windows,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.5.0-windows,"Just need any 1 instance, to set the header line of the record file"
v1.5.0-windows,"Set is_ready at the end, setting this before can cause a race when the file isn't open yet"
v1.5.0-windows,make sure all vars are set up
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,decide which derived BP to use
v1.5.0-windows,we don't have real vehicle so no vehicle API
v1.5.0-windows,put camera little bit above vehicle
v1.5.0-windows,update ground level
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,let base class setup physics world
v1.5.0-windows,stop physics thread before we dismantle
v1.5.0-windows,setup clock in ClockFactory
v1.5.0-windows,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.5.0-windows,steppable clock returns interval that is a constant number irrespective of wall clock
v1.5.0-windows,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.5.0-windows,but that would cause vehicles like quadrotors to become unstable
v1.5.0-windows,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.5.0-windows,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.5.0-windows,get increase in clock speed
v1.5.0-windows,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.5.0-windows,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.5.0-windows,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.5.0-windows,Approach 2: scale control loop frequency if clock is speeded up
v1.5.0-windows,"for slowing down, this don't generate instability"
v1.5.0-windows,-------------------------------- overrides -----------------------------------------------//
v1.5.0-windows,decide which derived BP to use
v1.5.0-windows,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.5.0-windows,vehicle_sim_api->reset();
v1.5.0-windows,create vehicle API
v1.5.0-windows,setup physics vehicle
v1.5.0-windows,initialize private vars
v1.5.0-windows,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.5.0-windows,calls to update* are handled by physics engine and in SimModeWorldBase
v1.5.0-windows,"Utils::log(""------Render tick-------"");"
v1.5.0-windows,"if reset is pending then do it first, no need to do other things until next tick"
v1.5.0-windows,move collision info from rendering engine to vehicle
v1.5.0-windows,update rotor poses
v1.5.0-windows,update private rotor variable
v1.5.0-windows,if we did reset then don't worry about synchronizing states for this tick
v1.5.0-windows,Continue to wait for reset
v1.5.0-windows,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.5.0-windows,*** Start: UpdatableState implementation ***//
v1.5.0-windows,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.5.0-windows,environment update for current position
v1.5.0-windows,update forces on vertices
v1.5.0-windows,update to controller must be done after kinematics have been updated by physics engine
v1.5.0-windows,*** End: UpdatableState implementation ***//
v1.5.0-windows,get references of existing camera
v1.5.0-windows,setup clock in PhysX
v1.5.0-windows,-------------------------------- overrides -----------------------------------------------//
v1.5.0-windows,decide which derived BP to use
v1.5.0-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.5.0-windows,Setup suspension forces
v1.5.0-windows,Find the tire object and set the data for it
v1.5.0-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.5.0-windows,Setup suspension forces
v1.5.0-windows,Find the tire object and set the data for it
v1.5.0-windows,Create In-Car camera component
v1.5.0-windows,In car HUD
v1.5.0-windows,Create text render component for in car speed display
v1.5.0-windows,Create text render component for in car gear display
v1.5.0-windows,Setup the audio component and allocate it a sound cue
v1.5.0-windows,Colors for the in-car gear display. One for normal one for reverse
v1.5.0-windows,Wheels/Tires
v1.5.0-windows,Setup the wheels
v1.5.0-windows,Adjust the tire loading
v1.5.0-windows,Engine
v1.5.0-windows,Torque setup
v1.5.0-windows,Adjust the steering
v1.5.0-windows,Transmission
v1.5.0-windows,We want 4wd
v1.5.0-windows,Drive the front wheels a little more than the rear
v1.5.0-windows,Automatic gearbox
v1.5.0-windows,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.5.0-windows,Physics settings
v1.5.0-windows,Adjust the center of mass - the buggy is quite low
v1.5.0-windows,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.5.0-windows,put camera little bit above vehicle
v1.5.0-windows,update physics material
v1.5.0-windows,Update the strings used in the HUD (in-car and on-screen)
v1.5.0-windows,Set the string in the in-car HUD
v1.5.0-windows,Pass the engine RPM to the sound component
v1.5.0-windows,Start an engine sound playing
v1.5.0-windows,Using FText because this is display text that should be localizable
v1.5.0-windows,Setup the text render component strings
v1.5.0-windows,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.5.0-windows,below is not needed
v1.5.0-windows,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.5.0-windows,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.5.0-windows,TODO: should do reset() here?
v1.5.0-windows,create vehicle params
v1.5.0-windows,these are called on render ticks
v1.5.0-windows,TODO: do we need this for cars?
v1.5.0-windows,TODO: move this to SimModeBase?
v1.5.0-windows,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.5.0-windows,reset();
v1.5.0-windows,return;
v1.5.0-windows,}
v1.5.0-windows,Thrustmaster devices
v1.5.0-windows,"Anything else, typically Logitech G920 wheel"
v1.5.0-windows,Two steel levers behind wheel
v1.5.0-windows,if API-client control is not active then we route keyboard/joystick control to car
v1.5.0-windows,all car controls from anywhere must be routed through API component
v1.5.0-windows,*** Start: UpdatableState implementation ***//
v1.5.0-windows,physics tick
v1.5.0-windows,*** End: UpdatableState implementation ***//
v1.5.0-windows,TODO: directly accept getVehicleSimApis() using generic container
v1.5.0-windows,remove everything that we created in BeginPlay
v1.5.0-windows,we use custom debug reporting for this class
v1.5.0-windows,perform any expensive rendering update outside of lock region
v1.5.0-windows,no need to call base reset because of our custom implementation
v1.5.0-windows,TODO: this is going to cause circular references which is fine here but
v1.5.0-windows,in future we should consider moving SimMode not derived from AActor and move
v1.5.0-windows,it to AirLib and directly implement WorldSimApiBase interface
v1.5.0-windows,get player start
v1.5.0-windows,this must be done from within actor otherwise we don't get player start
v1.5.0-windows,Grab player location
v1.5.0-windows,Move the world origin to the player's location (this moves the coordinate system and adds
v1.5.0-windows,a corresponding offset to all positions to compensate for the shift)
v1.5.0-windows,"Regrab the player's position after the offset has been added (which should be 0,0,0 now)"
v1.5.0-windows,UWeatherLib::showWeatherMenu(World);
v1.5.0-windows,else don't init
v1.5.0-windows,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v1.5.0-windows,tod_sim_clock_start_ needs to be reset here.
v1.5.0-windows,Going from enabled to disabled
v1.5.0-windows,do these in the end to ensure that advanceTimeOfDay() doesn't see
v1.5.0-windows,any inconsistent state.
v1.5.0-windows,should be overridden by derived class
v1.5.0-windows,should be overridden by derived class
v1.5.0-windows,should be overriden by derived class
v1.5.0-windows,should be overridden by derived class
v1.5.0-windows,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.5.0-windows,default setup - this should be overridden in derived modes as needed
v1.5.0-windows,setup clock in ClockFactory
v1.5.0-windows,default implementation
v1.5.0-windows,create director
v1.5.0-windows,create external camera required for the director
v1.5.0-windows,API server start/stop
v1.5.0-windows,get UU origin of global NED frame
v1.5.0-windows,compute initial pose
v1.5.0-windows,spawn vehicle pawn
v1.5.0-windows,create vehicle sim api
v1.5.0-windows,TODO: Figure out a better way to add more fields
v1.5.0-windows,Maybe allow passing a JSON string for the vehicle settings?
v1.5.0-windows,"Retroactively adjust AirSimSettings, so it's like we knew about this vehicle all along"
v1.5.0-windows,"Usually physics registration happens at init, in ASimModeWorldBase::initializeForPlay(), but not in this case"
v1.5.0-windows,Can't be done before the vehicle apis have been created
v1.5.0-windows,get UU origin of global NED frame
v1.5.0-windows,determine camera director camera default pose and spawn it
v1.5.0-windows,find all vehicle pawns
v1.5.0-windows,add vehicles from settings
v1.5.0-windows,if vehicle is of type for derived SimMode and auto creatable
v1.5.0-windows,create API objects for each pawn we have
v1.5.0-windows,TODO: better handle no FPV vehicles scenario
v1.5.0-windows,derived class shoudl override this method to add new vehicle to the physics engine
v1.5.0-windows,derived class should override this method to retrieve types of pawns they support
v1.5.0-windows,derived class should override this method to retrieve types of pawns they support
v1.5.0-windows,derived class should override this method to retrieve types of pawns they support
v1.5.0-windows,derived class should override this method to retrieve types of pawns they support
v1.5.0-windows,derived class should override this method to retrieve types of pawns they support
v1.5.0-windows,derived class should override this method to retrieve types of pawns they support
v1.5.0-windows,derived class should override this method to retrieve types of pawns they support
v1.5.0-windows,Draws debug-points on main viewport for Lidar laser hits.
v1.5.0-windows,Used for debugging only.
v1.5.0-windows,Currently we are checking the sensor-collection instead of sensor-settings.
v1.5.0-windows,Also using variables to optimize not checking the collection if not needed.
v1.5.0-windows,TODO: Is it incorrect to assume LidarSimple here?
v1.5.0-windows,Draw debug-point on main viewport for Distance sensor hit
v1.5.0-windows,Find position of point hit
v1.5.0-windows,Similar to UnrealDistanceSensor.cpp#L19
v1.5.0-windows,order of Pose addition is important here because it also adds quaternions which is not commutative!
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,ctor
v1.5.0-windows,initializes information based on lidar configuration
v1.5.0-windows,calculate verticle angle distance between each laser
v1.5.0-windows,store vertical angles for each laser
v1.5.0-windows,returns a point-cloud for the tick
v1.5.0-windows,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.5.0-windows,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.5.0-windows,calculate number of points needed for each laser/channel
v1.5.0-windows,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.5.0-windows,calculate needed angle/distance between each point
v1.5.0-windows,normalize FOV start/end
v1.5.0-windows,shoot lasers
v1.5.0-windows,check if the laser is outside the requested horizontal FOV
v1.5.0-windows,"shoot laser and get the impact point, if any"
v1.5.0-windows,simulate shooting a laser via Unreal ray-tracing.
v1.5.0-windows,start position
v1.5.0-windows,We need to compose rotations here rather than rotate a vector by a quaternion
v1.5.0-windows,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.5.0-windows,get ray quaternion in lidar frame (angles must be in radians)
v1.5.0-windows,get ray quaternion in body frame
v1.5.0-windows,get ray quaternion in world frame
v1.5.0-windows,get ray vector (end position)
v1.5.0-windows,Store the segmentation id of the hit object.
v1.5.0-windows,Debug code for very specific cases.
v1.5.0-windows,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.5.0-windows,decide the frame for the point-cloud
v1.5.0-windows,current detault behavior; though it is probably not very useful.
v1.5.0-windows,not changing the default for now to maintain backwards-compat.
v1.5.0-windows,point in vehicle intertial frame
v1.5.0-windows,tranform to lidar frame
v1.5.0-windows,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.5.0-windows,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.5.0-windows,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.5.0-windows,"On the client side, if it is needed to transform this data back to the world frame,"
v1.5.0-windows,"then do the equivalent of following,"
v1.5.0-windows,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.5.0-windows,See SimModeBase::drawLidarDebugPoints()
v1.5.0-windows,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.5.0-windows,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,update ray tracing
v1.5.0-windows,"FString hit_name = FString(""None"");"
v1.5.0-windows,if (dist_hit.GetActor())
v1.5.0-windows,hit_name=dist_hit.GetActor()->GetName();
v1.5.0-windows,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.5.0-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,This assumes you are running DroneServer already on the same machine.
v1.5.0-windows,DroneServer must be running first.
v1.5.0-windows,enable API control
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,move commands
v1.5.0-windows,else leave as it is
v1.5.0-windows,TODO: get these in one call
v1.5.0-windows,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.5.0-windows,TODO: shouldn't we pass folder path?
v1.5.0-windows,parse
v1.5.0-windows,group the images by the current date.
v1.5.0-windows,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.5.0-windows,{
v1.5.0-windows,"return """";"
v1.5.0-windows,}
v1.5.0-windows,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.5.0-windows,{
v1.5.0-windows,return false;
v1.5.0-windows,}
v1.5.0-windows,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.5.0-windows,params.context->client.newTask();
v1.5.0-windows,}
v1.5.0-windows,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.5.0-windows,params.context->client.WaitForCompletion(0);
v1.5.0-windows,}
v1.5.0-windows,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.5.0-windows,{
v1.5.0-windows,}
v1.5.0-windows,parse command line
v1.5.0-windows,Shell callbacks
v1.5.0-windows,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.5.0-windows,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.5.0-windows,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.5.0-windows,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.5.0-windows,Add shell commands
v1.5.0-windows,TODO: add WaitForCompletion command
v1.5.0-windows,"TODO: add command line args help, arg count validation"
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v1.5.0-windows,switch to explicit hover mode so that this is the fall back when
v1.5.0-windows,move* commands are finished.
v1.5.0-windows,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.5.0-windows,TODO: implement weather for Unity
v1.5.0-windows,TODO: implement weather for Unity
v1.5.0-windows,----------------Plotting APIs-----------/
v1.5.0-windows,Recording APIs
v1.5.0-windows,Function pointers to hold the addresses of the functions that are defined in Unity
v1.5.0-windows,"Enabling all LogLevels,"
v1.5.0-windows,"Enabling all LogLevels,"
v1.5.0-windows,delete ltm;
v1.5.0-windows,initialize state
v1.5.0-windows,compute our home point
v1.5.0-windows,default behavior is to call update every tick
v1.5.0-windows,"for custom physics engine, this method should be overridden and update should be"
v1.5.0-windows,called from every physics tick
v1.5.0-windows,these will be available for devices like steering wheels
v1.5.0-windows,sync environment from kinematics
v1.5.0-windows,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.5.0-windows,FVector unrealPosition = getUUPosition();
v1.5.0-windows,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v1.5.0-windows,not implemented
v1.5.0-windows,not implemented
v1.5.0-windows,parameters in NED frame
v1.5.0-windows,allow teleportation
v1.5.0-windows,if collisions are not enabled
v1.5.0-windows,or we have collided but passthrough is enabled
v1.5.0-windows,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.5.0-windows,"without flip flopping, collisions can't be detected"
v1.5.0-windows,by default we update kinematics from UE pawn
v1.5.0-windows,if SimMod uses its own physics engine then this should be overriden
v1.5.0-windows,no default action in this base class
v1.5.0-windows,TODO: because this bug we are using alternative code with stringstream
v1.5.0-windows,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.5.0-windows,update kinematics from pawn's movement instead of physics engine
v1.5.0-windows,TODO: update other fields?
v1.5.0-windows,implements getImages() method in the ImageCaptureBase class.
v1.5.0-windows,update ray tracing
v1.5.0-windows,TODO: index check
v1.5.0-windows,Attempts to parse the settings text from one of multiple locations.
v1.5.0-windows,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.5.0-windows,"Next, check the executable's working directory for the settings file."
v1.5.0-windows,"Finally, check the user's documents folder."
v1.5.0-windows,"If the settings file cannot be read, throw an exception"
v1.5.0-windows,let base class setup physics world
v1.5.0-windows,stop physics thread before we dismantle
v1.5.0-windows,setup clock in ClockFactory
v1.5.0-windows,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.5.0-windows,steppable clock returns interval that is a constant number irrespective of wall clock
v1.5.0-windows,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.5.0-windows,but that would cause vehicles like quadrotors to become unstable
v1.5.0-windows,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.5.0-windows,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.5.0-windows,get increase in clock speed
v1.5.0-windows,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.5.0-windows,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.5.0-windows,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.5.0-windows,Approach 2: scale control loop frequency if clock is speeded up
v1.5.0-windows,"for slowing down, this don't generate instability"
v1.5.0-windows,-------------------------------- overrides -----------------------------------------------//
v1.5.0-windows,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.5.0-windows,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.5.0-windows,create vehicle API
v1.5.0-windows,setup physics vehicle
v1.5.0-windows,initialize private vars
v1.5.0-windows,"if reset is pending then do it first, no need to do other things until next tick"
v1.5.0-windows,move collision info from rendering engine to vehicle
v1.5.0-windows,update rotor poses
v1.5.0-windows,if we did reset then don't worry about synchronizing states for this tick
v1.5.0-windows,Continue to wait for reset
v1.5.0-windows,*** Start: UpdatableState implementation ***//
v1.5.0-windows,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.5.0-windows,environment update for current position
v1.5.0-windows,update forces on vertices
v1.5.0-windows,update to controller must be done after kinematics have been updated by physics engine
v1.5.0-windows,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.5.0-windows,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.5.0-windows,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.5.0-windows,*** End: UpdatableState implementation ***//
v1.5.0-windows,TODO: should do reset() here?
v1.5.0-windows,these are called on render ticks
v1.5.0-windows,TODO: do we need this for cars?
v1.5.0-windows,Thrustmaster devices
v1.5.0-windows,"Anything else, typically Logitech G920 wheel"
v1.5.0-windows,Two steel levers behind wheel
v1.5.0-windows,if API-client control is not active then we route keyboard/joystick control to car
v1.5.0-windows,all car controls from anywhere must be routed through API component
v1.5.0-windows,*** Start: UpdatableState implementation ***//
v1.5.0-windows,physics tick
v1.5.0-windows,void CarPawnSimApi::reportState(StateReporter& reporter)
v1.5.0-windows,{
v1.5.0-windows,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.5.0-windows,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.5.0-windows,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.5.0-windows,}
v1.5.0-windows,*** End: UpdatableState implementation ***//
v1.5.0-windows,remove everything that we created in BeginPlay
v1.5.0-windows,we use custom debug reporting for this class
v1.5.0-windows,perform any expensive rendering update outside of lock region
v1.5.0-windows,no need to call base reset because of our custom implementation
v1.5.0-windows,should be overridden by derived class
v1.5.0-windows,should be overridden by derived class
v1.5.0-windows,should be overridden by derived class
v1.5.0-windows,commenting this out for now to avoid unintentional Unity startup failure
v1.5.0-windows,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v1.5.0-windows,should be overridden by derived class
v1.5.0-windows,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.5.0-windows,default setup - this should be overridden in derived modes as needed
v1.5.0-windows,setup clock in ClockFactory
v1.5.0-windows,API server start/stop
v1.5.0-windows,determine camera director camera default pose and spawn it
v1.5.0-windows,derived class should override this method to retrieve types of pawns they support
v1.5.0-windows,derived class should override this method to retrieve types of pawns they support
v1.5.0-windows,60 acres park:
v1.5.0-windows,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.5.0-windows,marymoore park
v1.5.0-windows,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.5.0-windows,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.5.0-windows,DepthNavThreshold depthNav;
v1.5.0-windows,DepthNavOptAStar depthNav;
v1.5.0-windows,DepthNavThreshold depthNav;
v1.5.0-windows,DepthNavOptAStar depthNav;
v1.5.0-windows,Cleanup
v1.5.0-windows,runDepthNavGT();
v1.5.0-windows,runDepthNavSGM();
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,by Sudipta Sinha
v1.5.0-windows,adapted for AirSim by Matthias Mueller
v1.5.0-windows,first row
v1.5.0-windows,last row
v1.5.0-windows,Local quadratic fit of cost and subpixel refinement.
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,by Sudipta Sinha
v1.5.0-windows,adapted for AirSim by Matthias Mueller
v1.5.0-windows,uint64_t x64 = (uint64_t)x;
v1.5.0-windows,uint64_t y64 = (uint64_t)y;
v1.5.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-windows,Licensed under the MIT License.
v1.5.0-windows,by Sudipta Sinha
v1.5.0-windows,adapted for AirSim by Matthias Mueller
v1.5.0-windows,ensure that disparity range is a multiple of 8
v1.5.0-windows,sgm stereo
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,read settings and override defaults
v1.5.0-linux,allow json overrides on a per-vehicle basis.
v1.5.0-linux,start server in async mode
v1.5.0-linux,check messages
v1.5.0-linux,plot red arrows for 30 seconds
v1.5.0-linux,plot magenta arrows for 15 seconds
v1.5.0-linux,plot red arrows for 10 seconds
v1.5.0-linux,plot 2 white arrows which are persistent
v1.5.0-linux,plot points
v1.5.0-linux,"plot line strip. 0-1, 1-2, 2-3"
v1.5.0-linux,"plot line list. 0-1, 2-3, 4-5. Must be even."
v1.5.0-linux,plot transforms
v1.5.0-linux,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=0.0, yaw=yaw)) for x, y, yaw in zip(np.linspace(0,10,10), np.linspace(0,0,10), np.linspace(0,np.pi,10))],"
v1.5.0-linux,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.5.0-linux,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=roll, yaw=0.0)) for x, y, roll in zip(np.linspace(0,10,10), np.linspace(1,1,10), np.linspace(0,np.pi,10))],"
v1.5.0-linux,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.5.0-linux,In settings.json first activate computer vision mode:
v1.5.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.5.0-linux,monitor car state while you drive it manually.
v1.5.0-linux,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v1.5.0-linux,denominator from microns^3 to microns * m^2)
v1.5.0-linux,First set everything to 0.
v1.5.0-linux,Next set all objects of interest provided to corresponding object IDs
v1.5.0-linux,segIdDict values MUST match tempEmissivityNew labels.
v1.5.0-linux,"Connect to AirSim, UAV mode."
v1.5.0-linux,Choose temperature values for winter or summer.
v1.5.0-linux,""""""""
v1.5.0-linux,winter
v1.5.0-linux,""""""""
v1.5.0-linux,summer
v1.5.0-linux,Read camera response.
v1.5.0-linux,Calculate radiance.
v1.5.0-linux,Set IDs in AirSim environment.
v1.5.0-linux,In settings.json first activate computer vision mode:
v1.5.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.5.0-linux,"define abstract class to return next vector in the format (x,y,yaw)"
v1.5.0-linux,"compute vector, distance and angle to goal"
v1.5.0-linux,compute box of interest
v1.5.0-linux,scale by weight matrix (optional)
v1.5.0-linux,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.5.0-linux,detect collision
v1.5.0-linux,compute box of interest
v1.5.0-linux,detect collision
v1.5.0-linux,Same as above but decide to go left or right based on average or some metric like that
v1.5.0-linux,"compute resultant normalized vector, distance and angle"
v1.5.0-linux,compute bounding box size
v1.5.0-linux,convert horizonal fov to vertical fov
v1.5.0-linux,matrix with all ones
v1.5.0-linux,matrix with max weight in center and decreasing linearly with distance from center
v1.5.0-linux,matrix with max weight in center and decreasing quadratically with distance from center
v1.5.0-linux,"print (""Saving images to %s"" % tmp_dir)"
v1.5.0-linux,airsim.wait_key('Press any key to start')
v1.5.0-linux,"Define start position, goal and size of UAV"
v1.5.0-linux,Define parameters and thresholds
v1.5.0-linux,initial position
v1.5.0-linux,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.5.0-linux,time.sleep(1)
v1.5.0-linux,get response
v1.5.0-linux,get numpy array
v1.5.0-linux,reshape array to 2D array H X W
v1.5.0-linux,write to png
v1.5.0-linux,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.5.0-linux,pose = client.simGetPose()
v1.5.0-linux,pp.pprint(pose)
v1.5.0-linux,time.sleep(5)
v1.5.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.5.0-linux,################### OLD CODE
v1.5.0-linux,timer = 0
v1.5.0-linux,time_obs = 50
v1.5.0-linux,bObstacle = False
v1.5.0-linux,if (bObstacle):
v1.5.0-linux,timer = timer + 1
v1.5.0-linux,if timer > time_obs:
v1.5.0-linux,bObstacle = False
v1.5.0-linux,timer = 0
v1.5.0-linux,else:
v1.5.0-linux,yaw = target_angle
v1.5.0-linux,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.5.0-linux,if (np.average(img2d_box) < coll_thres):
v1.5.0-linux,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.5.0-linux,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.5.0-linux,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.5.0-linux,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.5.0-linux,"print('left: ', img2d_box_l_avg)"
v1.5.0-linux,"print('right: ', img2d_box_r_avg)"
v1.5.0-linux,if img2d_box_l_avg > img2d_box_r_avg:
v1.5.0-linux,##Go LEFT
v1.5.0-linux,#y_offset = y_offset-1
v1.5.0-linux,yaw = yaw - radians(10)
v1.5.0-linux,bObstacle = True
v1.5.0-linux,else:
v1.5.0-linux,##Go RIGHT
v1.5.0-linux,#y_offset = y_offset+1
v1.5.0-linux,yaw = yaw + radians(10)
v1.5.0-linux,bObstacle = true
v1.5.0-linux,"print('yaw: ', yaw)"
v1.5.0-linux,In settings.json first activate computer vision mode:
v1.5.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.5.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.5.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.5.0-linux,pip install opencv-python
v1.5.0-linux,In settings.json first activate computer vision mode:
v1.5.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.5.0-linux,In settings.json first activate computer vision mode:
v1.5.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.5.0-linux,for block environment
v1.5.0-linux,regex are case insensitive
v1.5.0-linux,#for neighborhood environment
v1.5.0-linux,set object ID for sky
v1.5.0-linux,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.5.0-linux,get segmentation image in various formats
v1.5.0-linux,save segmentation images in various formats
v1.5.0-linux,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.5.0-linux,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.5.0-linux,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v1.5.0-linux,find unique colors
v1.5.0-linux,In settings.json first activate computer vision mode:
v1.5.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.5.0-linux,objects can be named in two ways:
v1.5.0-linux,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.5.0-linux,default name is auto-generated and varies from run-to-run.
v1.5.0-linux,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.5.0-linux,
v1.5.0-linux,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.5.0-linux,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.5.0-linux,https://answers.unrealengine.com/revisions/790629.html
v1.5.0-linux,below works in Blocks environment
v1.5.0-linux,------------------------------------ Get current pose ------------------------------------------------
v1.5.0-linux,search object by name:
v1.5.0-linux,search another object by tag
v1.5.0-linux,search non-existent object
v1.5.0-linux,------------------------------------ Set new pose ------------------------------------------------
v1.5.0-linux,here we move with teleport enabled so collisions are ignored
v1.5.0-linux,here we move with teleport enabled so collisions are not ignored
v1.5.0-linux,move non-existent object
v1.5.0-linux,------------------------------------ Get new pose ------------------------------------------------
v1.5.0-linux,search another object by tag
v1.5.0-linux,search non-existent object
v1.5.0-linux,Import this module to automatically setup path to local airsim module
v1.5.0-linux,This module first tries to see if airsim module is installed via pip
v1.5.0-linux,If it does then we don't do anything else
v1.5.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.5.0-linux,and if it does then we add that in sys.path
v1.5.0-linux,this class simply tries to see if airsim
v1.5.0-linux,if airsim module is installed then don't do anything else
v1.5.0-linux,import pkgutil
v1.5.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.5.0-linux,if airsim_loader is not None:
v1.5.0-linux,return
v1.5.0-linux,"Roll is applied first, then pitch, then yaw."
v1.5.0-linux,Turn the camera position into a column vector.
v1.5.0-linux,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v1.5.0-linux,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v1.5.0-linux,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v1.5.0-linux,Recreate the perspective projection of the camera.
v1.5.0-linux,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v1.5.0-linux,Set pose and sleep after to ensure the pose sticks before capturing image.
v1.5.0-linux,Capture segmentation (IR) and scene images.
v1.5.0-linux,Change images into numpy arrays.
v1.5.0-linux,Capture images for a certain amount of time in seconds (half hour now)
v1.5.0-linux,Capture image - pose.position x_val access may change w/ AirSim
v1.5.0-linux,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v1.5.0-linux,Convert color scene image to BGR for write out with cv2.
v1.5.0-linux,"Connect to AirSim, UAV mode."
v1.5.0-linux,Look for objects with names that match a regular expression.
v1.5.0-linux,"Sample calls to main, varying camera angle and altitude."
v1.5.0-linux,"straight down, 400ft"
v1.5.0-linux,"straight down, 200ft"
v1.5.0-linux,"45 degrees, 200ft -- note that often object won't be scene since position"
v1.5.0-linux,is set exactly to object's
v1.5.0-linux,"45 degrees, 400ft -- note that often object won't be scene since position"
v1.5.0-linux,is set exactly to object's
v1.5.0-linux,In settings.json first activate computer vision mode:
v1.5.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.5.0-linux,xn = 1 + x*5  # some random number
v1.5.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,monitor car state while you drive it manually.
v1.5.0-linux,get state of the car
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,go forward
v1.5.0-linux,get state of the car
v1.5.0-linux,Python client example to change time-of-day using APIs
v1.5.0-linux,
v1.5.0-linux,Changes time of the day and makes the car move around
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,flip between specific time and default time
v1.5.0-linux,go forward
v1.5.0-linux,Go forward + steer right
v1.5.0-linux,main
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,get state of the car
v1.5.0-linux,go forward
v1.5.0-linux,Go forward + steer right
v1.5.0-linux,go reverse
v1.5.0-linux,apply brakes
v1.5.0-linux,get camera images from the car
v1.5.0-linux,restore to original state
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,go forward
v1.5.0-linux,Python client example to get Lidar data from a car
v1.5.0-linux,
v1.5.0-linux,Makes the drone fly and get Lidar data
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,"print(""state: %s"" % s)"
v1.5.0-linux,go forward
v1.5.0-linux,Go forward + steer right
v1.5.0-linux,"reshape array of floats to array of [X,Y,Z]"
v1.5.0-linux,TODO
v1.5.0-linux,main
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,get state of the car
v1.5.0-linux,go forward
v1.5.0-linux,Go forward + steer right
v1.5.0-linux,go reverse
v1.5.0-linux,apply breaks
v1.5.0-linux,restore to original state
v1.5.0-linux,Import this module to automatically setup path to local airsim module
v1.5.0-linux,This module first tries to see if airsim module is installed via pip
v1.5.0-linux,If it does then we don't do anything else
v1.5.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.5.0-linux,and if it does then we add that in sys.path
v1.5.0-linux,this class simply tries to see if airsim
v1.5.0-linux,if airsim module is installed then don't do anything else
v1.5.0-linux,import pkgutil
v1.5.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.5.0-linux,if airsim_loader is not None:
v1.5.0-linux,return
v1.5.0-linux,Use below in settings.json with blocks environment
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,get state of the car
v1.5.0-linux,go forward
v1.5.0-linux,go reverse
v1.5.0-linux,apply breaks
v1.5.0-linux,get camera images from the car
v1.5.0-linux,restore to original state
v1.5.0-linux,from keras.models import load_model
v1.5.0-linux,if (len(sys.argv) != 2):
v1.5.0-linux,print('usage: python drive.py <modelName>')
v1.5.0-linux,sys.exit()
v1.5.0-linux,print('Loading model...')
v1.5.0-linux,model = load_model(sys.argv[1])
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.5.0-linux,"model_output = model.predict([image_buf, state_buf])"
v1.5.0-linux,car_controls.steering = float(model_output[0][0])
v1.5.0-linux,-*- coding: utf-8 -*-
v1.5.0-linux,
v1.5.0-linux,Configuration file for the Sphinx documentation builder.
v1.5.0-linux,
v1.5.0-linux,This file does only contain a selection of the most common options. For a
v1.5.0-linux,full list see the documentation:
v1.5.0-linux,http://www.sphinx-doc.org/en/master/config
v1.5.0-linux,-- Path setup --------------------------------------------------------------
v1.5.0-linux,"If extensions (or modules to document with autodoc) are in another directory,"
v1.5.0-linux,add these directories to sys.path here. If the directory is relative to the
v1.5.0-linux,"documentation root, use os.path.abspath to make it absolute, like shown here."
v1.5.0-linux,
v1.5.0-linux,-- Project information -----------------------------------------------------
v1.5.0-linux,The short X.Y version
v1.5.0-linux,"The full version, including alpha/beta/rc tags"
v1.5.0-linux,-- General configuration ---------------------------------------------------
v1.5.0-linux,"If your documentation needs a minimal Sphinx version, state it here."
v1.5.0-linux,
v1.5.0-linux,needs_sphinx = '1.0'
v1.5.0-linux,"Add any Sphinx extension module names here, as strings. They can be"
v1.5.0-linux,extensions coming with Sphinx (named 'sphinx.ext.*') or your custom
v1.5.0-linux,ones.
v1.5.0-linux,"Add any paths that contain templates here, relative to this directory."
v1.5.0-linux,The suffix(es) of source filenames.
v1.5.0-linux,You can specify multiple suffix as a list of string:
v1.5.0-linux,
v1.5.0-linux,"source_suffix = ['.rst', '.md']"
v1.5.0-linux,The master toctree document.
v1.5.0-linux,The language for content autogenerated by Sphinx. Refer to documentation
v1.5.0-linux,for a list of supported languages.
v1.5.0-linux,
v1.5.0-linux,This is also used if you do content translation via gettext catalogs.
v1.5.0-linux,"Usually you set ""language"" from the command line for these cases."
v1.5.0-linux,"List of patterns, relative to source directory, that match files and"
v1.5.0-linux,directories to ignore when looking for source files.
v1.5.0-linux,This pattern also affects html_static_path and html_extra_path.
v1.5.0-linux,The name of the Pygments (syntax highlighting) style to use.
v1.5.0-linux,-- Options for HTML output -------------------------------------------------
v1.5.0-linux,The theme to use for HTML and HTML Help pages.  See the documentation for
v1.5.0-linux,a list of builtin themes.
v1.5.0-linux,
v1.5.0-linux,html_theme = 'alabaster'
v1.5.0-linux,Theme options are theme-specific and customize the look and feel of a theme
v1.5.0-linux,"further.  For a list of options available for each theme, see the"
v1.5.0-linux,documentation.
v1.5.0-linux,
v1.5.0-linux,html_theme_options = {}
v1.5.0-linux,"Add any paths that contain custom static files (such as style sheets) here,"
v1.5.0-linux,"relative to this directory. They are copied after the builtin static files,"
v1.5.0-linux,"so a file named ""default.css"" will overwrite the builtin ""default.css""."
v1.5.0-linux,"Custom sidebar templates, must be a dictionary that maps document names"
v1.5.0-linux,to template names.
v1.5.0-linux,
v1.5.0-linux,The default sidebars (for documents that don't match any pattern) are
v1.5.0-linux,defined by theme itself.  Builtin themes are using these templates by
v1.5.0-linux,"default: ``['localtoc.html', 'relations.html', 'sourcelink.html',"
v1.5.0-linux,'searchbox.html']``.
v1.5.0-linux,
v1.5.0-linux,html_sidebars = {}
v1.5.0-linux,-- Options for HTMLHelp output ---------------------------------------------
v1.5.0-linux,Output file base name for HTML help builder.
v1.5.0-linux,-- Options for LaTeX output ------------------------------------------------
v1.5.0-linux,The paper size ('letterpaper' or 'a4paper').
v1.5.0-linux,
v1.5.0-linux,"'papersize': 'letterpaper',"
v1.5.0-linux,"The font size ('10pt', '11pt' or '12pt')."
v1.5.0-linux,
v1.5.0-linux,"'pointsize': '10pt',"
v1.5.0-linux,Additional stuff for the LaTeX preamble.
v1.5.0-linux,
v1.5.0-linux,"'preamble': '',"
v1.5.0-linux,Latex figure (float) alignment
v1.5.0-linux,
v1.5.0-linux,"'figure_align': 'htbp',"
v1.5.0-linux,Grouping the document tree into LaTeX files. List of tuples
v1.5.0-linux,"(source start file, target name, title,"
v1.5.0-linux,"author, documentclass [howto, manual, or own class])."
v1.5.0-linux,-- Options for manual page output ------------------------------------------
v1.5.0-linux,One entry per manual page. List of tuples
v1.5.0-linux,"(source start file, name, description, authors, manual section)."
v1.5.0-linux,-- Options for Texinfo output ----------------------------------------------
v1.5.0-linux,Grouping the document tree into Texinfo files. List of tuples
v1.5.0-linux,"(source start file, target name, title, author,"
v1.5.0-linux,"dir menu entry, description, category)"
v1.5.0-linux,-- Options for Epub output -------------------------------------------------
v1.5.0-linux,Bibliographic Dublin Core info.
v1.5.0-linux,The unique identifier of the text. This can be a ISBN number
v1.5.0-linux,or the project homepage.
v1.5.0-linux,
v1.5.0-linux,epub_identifier = ''
v1.5.0-linux,A unique identification for the text.
v1.5.0-linux,
v1.5.0-linux,epub_uid = ''
v1.5.0-linux,A list of files that should not be packed into the epub file.
v1.5.0-linux,-- Extension configuration -------------------------------------------------
v1.5.0-linux,-- Options for intersphinx extension ---------------------------------------
v1.5.0-linux,Example configuration for intersphinx: refer to the Python standard library.
v1.5.0-linux,-- Options for todo extension ----------------------------------------------
v1.5.0-linux,"If true, `todo` and `todoList` produce output, else they produce nothing."
v1.5.0-linux,We ignore the 2D nature of the problem as it is not relevant here
v1.5.0-linux,It makes multi-core processing more straightforward
v1.5.0-linux,Allocations
v1.5.0-linux,Add small number to avoid issues with log(I)
v1.5.0-linux,Event sim keeps track of previous image automatically
v1.5.0-linux,"Using pickle dump in a per-frame fashion to save time, instead of savetxt"
v1.5.0-linux,Optimizations possible
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,MultirotorClient.wait_key('Press any key to takeoff')
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,get camera images from the car
v1.5.0-linux,that's enough fun for now. let's quit cleanly
v1.5.0-linux,##################################################################################################
v1.5.0-linux,
v1.5.0-linux,Project:  Embedded Learning Library (ELL)
v1.5.0-linux,File:     speaker.py
v1.5.0-linux,Authors:  Chris Lovett
v1.5.0-linux,
v1.5.0-linux,Requires: Python 3.x
v1.5.0-linux,
v1.5.0-linux,##################################################################################################
v1.5.0-linux,open speakers so we can hear what it is processing...
v1.5.0-linux,teleport the drone + 10 meters in x-direction
v1.5.0-linux,teleport the drone back
v1.5.0-linux,This example shows how to use the External Physics Engine
v1.5.0-linux,It allows you to control the drone through setVehiclePose and obtain collision information.
v1.5.0-linux,It is especially useful for injecting your own flight dynamics model to the AirSim drone.
v1.5.0-linux,Use Blocks environment to see the drone colliding and seeing the collision information
v1.5.0-linux,in the command prompt.
v1.5.0-linux,Add this line to your settings.json before running AirSim:
v1.5.0-linux,"""PhysicsEngineName"":""ExternalPhysicsEngine"""
v1.5.0-linux,use open cv to create point cloud from depth image.
v1.5.0-linux,###########################################
v1.5.0-linux,######### This is work in progress! #######
v1.5.0-linux,###########################################
v1.5.0-linux,file will be saved in PythonClient folder (i.e. same folder as script)
v1.5.0-linux,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.5.0-linux,skip it
v1.5.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.5.0-linux,z of -7 is 7 meters above the original launch point.
v1.5.0-linux,Fly given velocity vector for 5 seconds
v1.5.0-linux,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.5.0-linux,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.5.0-linux,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.5.0-linux,Make the drone fly in a circle.
v1.5.0-linux,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.5.0-linux,check that our home position is stable
v1.5.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.5.0-linux,ramp up time
v1.5.0-linux,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.5.0-linux,compute current angle
v1.5.0-linux,compute lookahead
v1.5.0-linux,if we did the takeoff then also do the landing.
v1.5.0-linux,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.5.0-linux,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.5.0-linux,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.5.0-linux,ignore the click over from 360 back to 0
v1.5.0-linux,watch direction this diff is moving if it switches from shrinking to growing
v1.5.0-linux,then we passed the starting point.
v1.5.0-linux,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.5.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.5.0-linux,z of -5 is 5 meters above the original launch point.
v1.5.0-linux,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.5.0-linux,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.5.0-linux,drone will over-shoot so we bring it back to the start point before landing.
v1.5.0-linux,Run this script with clock speed in settings.json
v1.5.0-linux,"""ClockSpeed"": 1 then change it to 0.5"
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,with ClockSpeed = 0.5 you will see that this takes 6s (system time) and not 3s
v1.5.0-linux,with ClockSpeed = 0.5 you will see that this takes 10s (system time)
v1.5.0-linux,and not 5s in each iteration
v1.5.0-linux,that's enough fun for now. let's quit cleanly
v1.5.0-linux,Takeoff or hover
v1.5.0-linux,Set wind to 0
v1.5.0-linux,Takeoff or hover
v1.5.0-linux,In settings.json first activate computer vision mode:
v1.5.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.5.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.5.0-linux,pip install opencv-python
v1.5.0-linux,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.5.0-linux,fly for 2 minutes
v1.5.0-linux,more than 50 centimeter drift is unacceptable.
v1.5.0-linux,Python client example to get Lidar data from a drone
v1.5.0-linux,
v1.5.0-linux,Makes the drone fly and get Lidar data
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,"print(""state: %s"" % s)"
v1.5.0-linux,"print(""state: %s"" % pprint.pformat(state))"
v1.5.0-linux,"reshape array of floats to array of [X,Y,Z]"
v1.5.0-linux,TODO
v1.5.0-linux,main
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.5.0-linux,let it settle there a bit.
v1.5.0-linux,after hovering we need to re-enabled api control for next leg of the trip
v1.5.0-linux,now compute the survey path required to fill the box
v1.5.0-linux,##################################################################################################
v1.5.0-linux,
v1.5.0-linux,Project:  Embedded Learning Library (ELL)
v1.5.0-linux,File:     wav_reader.py
v1.5.0-linux,Authors:  Chris Lovett
v1.5.0-linux,
v1.5.0-linux,Requires: Python 3.x
v1.5.0-linux,
v1.5.0-linux,##################################################################################################
v1.5.0-linux,open a stream on the audio input file.
v1.5.0-linux,"assumes signed integer used in raw audio, so for example, the max for 16bit is 2^15 (32768)"
v1.5.0-linux,convert int16 data to scaled floats
v1.5.0-linux,configure output stream to match what we are resampling to...
v1.5.0-linux,convert the audio to the desired recording rate
v1.5.0-linux,split into separate channels
v1.5.0-linux,drop the channels we don't want
v1.5.0-linux,zip the resulting channels back up.
v1.5.0-linux,convert back to packed bytes in PCM 16 format
v1.5.0-linux,"deal with any accumulation of tails, if the tail grows to a full"
v1.5.0-linux,buffer then return it!
v1.5.0-linux,"we have a tail from previous frame, so prepend it"
v1.5.0-linux,"now the caller needs us to stick to our sample_size contract, but when"
v1.5.0-linux,rate conversion happens we can't be sure that 'data' is exactly that size.
v1.5.0-linux,usually one byte extra so add this to our accumulating tail
v1.5.0-linux,"might have reached the end of a file, so pad with zeros."
v1.5.0-linux,"Please add ""EnableTrace"": true to your setting.json as shown below"
v1.5.0-linux,{
v1.5.0-linux,"""SettingsVersion"": 1.2,"
v1.5.0-linux,"""SimMode"": ""Multirotor"","
v1.5.0-linux,"""Vehicles"": {"
v1.5.0-linux,"""Drone"": {"
v1.5.0-linux,"""VehicleType"": ""SimpleFlight"","
v1.5.0-linux,"""EnableTrace"": true"
v1.5.0-linux,}
v1.5.0-linux,}
v1.5.0-linux,}
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,add new vehicle
v1.5.0-linux,Use below in settings.json with Blocks environment
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,get camera images from the car
v1.5.0-linux,that's enough fun for now. let's quit cleanly
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,Import this module to automatically setup path to local airsim module
v1.5.0-linux,This module first tries to see if airsim module is installed via pip
v1.5.0-linux,If it does then we don't do anything else
v1.5.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.5.0-linux,and if it does then we add that in sys.path
v1.5.0-linux,this class simply tries to see if airsim
v1.5.0-linux,if airsim module is installed then don't do anything else
v1.5.0-linux,import pkgutil
v1.5.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.5.0-linux,if airsim_loader is not None:
v1.5.0-linux,return
v1.5.0-linux,"this script moves the drone to a location, then rests it thousands of time"
v1.5.0-linux,purpose of this script is to stress test reset API
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,that's enough fun for now. let's quite cleanly
v1.5.0-linux,For high speed ascent and descent on PX4 you may need to set these properties:
v1.5.0-linux,param set MPC_Z_VEL_MAX_UP 5
v1.5.0-linux,param set MPC_Z_VEL_MAX_DN 5
v1.5.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.5.0-linux,z of -50 is 50 meters above the original launch point.
v1.5.0-linux,use open cv to show new images from AirSim
v1.5.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.5.0-linux,pip install opencv-python
v1.5.0-linux,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.5.0-linux,get depth image
v1.5.0-linux,"this will return png width= 256, height= 144"
v1.5.0-linux,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.5.0-linux,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.5.0-linux,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.5.0-linux,to get an estimate of distance.
v1.5.0-linux,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.5.0-linux,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.5.0-linux,an angular delta of the following pi/10.
v1.5.0-linux,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.5.0-linux,Remove alpha channel if exists
v1.5.0-linux,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.5.0-linux,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.5.0-linux,Flatten and yield as tuple
v1.5.0-linux,Initialize a resizable dataset to hold the output
v1.5.0-linux,Resize the dataset to accommodate the next chunk of rows
v1.5.0-linux,Create the next chunk
v1.5.0-linux,Increment the row count
v1.5.0-linux,Arguments
v1.5.0-linux,Returns
v1.5.0-linux,use composition of homographies
v1.5.0-linux,to generate final transform that needs to be applied
v1.5.0-linux,Arguments
v1.5.0-linux,Returns
v1.5.0-linux,Keeps under lock only the mechanism which advances
v1.5.0-linux,the indexing of each batch.
v1.5.0-linux,The transformation of images is not under thread lock
v1.5.0-linux,so it can be done in parallel
v1.5.0-linux,Trained model path
v1.5.0-linux,Connect to AirSim
v1.5.0-linux,Start driving
v1.5.0-linux,Initialize image buffer
v1.5.0-linux,Update throttle value according to steering angle
v1.5.0-linux,Prediction
v1.5.0-linux,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.5.0-linux,Print progress
v1.5.0-linux,Update next car state
v1.5.0-linux,Wait a bit between iterations
v1.5.0-linux,%matplotlib inline
v1.5.0-linux,chunk size for training batches
v1.5.0-linux,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.5.0-linux,Point this to the directory containing the raw data
v1.5.0-linux,Point this to the desired output directory for the cooked (.h5) data
v1.5.0-linux,Choose The folders to search for data under RAW_DATA_DIR
v1.5.0-linux,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.5.0-linux,data_folder.append('folder_name1')
v1.5.0-linux,data_folder.append('folder_name2')
v1.5.0-linux,...
v1.5.0-linux,Hyper-parameters
v1.5.0-linux,Activation functions
v1.5.0-linux,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.5.0-linux,<< The directory containing the cooked data from the previous step >>
v1.5.0-linux,<< The directory in which the model output will be placed >>
v1.5.0-linux,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.5.0-linux,Network definition
v1.5.0-linux,Import this module to automatically setup path to local airsim module
v1.5.0-linux,This module first tries to see if airsim module is installed via pip
v1.5.0-linux,If it does then we don't do anything else
v1.5.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.5.0-linux,and if it does then we add that in sys.path
v1.5.0-linux,this class simply tries to see if airsim
v1.5.0-linux,if airsim module is installed then don't do anything else
v1.5.0-linux,import pkgutil
v1.5.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.5.0-linux,if airsim_loader is not None:
v1.5.0-linux,return
v1.5.0-linux,DEY: I don't know why this was there.
v1.5.0-linux,-----------------------------------  Common vehicle APIs ---------------------------------------------
v1.5.0-linux,basic flight control
v1.5.0-linux,time-of-day control
v1.5.0-linux,weather
v1.5.0-linux,camera control
v1.5.0-linux,simGetImage returns compressed png in array of bytes
v1.5.0-linux,image_type uses one of the ImageType members
v1.5.0-linux,"todo: in future remove below, it's only for compatibility to pre v1.2"
v1.5.0-linux,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.5.0-linux,camera control
v1.5.0-linux,simGetImage returns compressed png in array of bytes
v1.5.0-linux,image_type uses one of the ImageType members
v1.5.0-linux,gets the static meshes in the unreal scene
v1.5.0-linux,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.5.0-linux,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.5.0-linux,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.5.0-linux,sensor APIs
v1.5.0-linux,Plotting APIs
v1.5.0-linux,Recording APIs
v1.5.0-linux,Add new vehicle via RPC
v1.5.0-linux,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.5.0-linux,APIs for control
v1.5.0-linux,low-level control API
v1.5.0-linux,query vehicle state
v1.5.0-linux,query rotor states
v1.5.0-linux,-----------------------------------  Car APIs ---------------------------------------------
v1.5.0-linux,helper method for converting getOrientation to roll/pitch/yaw
v1.5.0-linux,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.5.0-linux,roll (x-axis rotation)
v1.5.0-linux,pitch (y-axis rotation)
v1.5.0-linux,yaw (z-axis rotation)
v1.5.0-linux,DEY: I don't know why this was there.
v1.5.0-linux,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.5.0-linux,return cls(**msgpack.unpack(encoded))
v1.5.0-linux,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.5.0-linux,Create a DummyVecEnv for main airsim gym env
v1.5.0-linux,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.5.0-linux,Initialize RL algorithm type and parameters
v1.5.0-linux,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.5.0-linux,Train for a certain number of timesteps
v1.5.0-linux,Save policy weights
v1.5.0-linux,Create a DummyVecEnv for main airsim gym env
v1.5.0-linux,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.5.0-linux,Initialize RL algorithm type and parameters
v1.5.0-linux,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.5.0-linux,Train for a certain number of timesteps
v1.5.0-linux,Save policy weights
v1.5.0-linux,Import this module to automatically setup path to local airsim module
v1.5.0-linux,This module first tries to see if airsim module is installed via pip
v1.5.0-linux,If it does then we don't do anything else
v1.5.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.5.0-linux,and if it does then we add that in sys.path
v1.5.0-linux,this class simply tries to see if airsim
v1.5.0-linux,if airsim module is installed then don't do anything else
v1.5.0-linux,import pkgutil
v1.5.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.5.0-linux,if airsim_loader is not None:
v1.5.0-linux,return
v1.5.0-linux,Set home position and velocity
v1.5.0-linux,print(dist)
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,"This is a bit crude, but give it a moment to settle on the ground, else takeoff will fail"
v1.5.0-linux,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.5.0-linux,switch to explicit hover mode so that this is the fallback when
v1.5.0-linux,move* commands are finished.
v1.5.0-linux,"Altitude difference between each platform, in meters"
v1.5.0-linux,"Count down, so the first one can easily go the highest (without knowing count)"
v1.5.0-linux,"in header only mode, control library is not available"
v1.5.0-linux,if using Unreal Build system then include precompiled header file first
v1.5.0-linux,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.5.0-linux,"Windows, OSX and Linux."
v1.5.0-linux,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.5.0-linux,Windows users can move the Documents folder to any location they want
v1.5.0-linux,SHGetFolderPath knows how to find it.
v1.5.0-linux,fall back in case SHGetFolderPath failed for some reason.
v1.5.0-linux,convert from std::path '/' to windows backslash.
v1.5.0-linux,make the current thread run with maximum priority.
v1.5.0-linux,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.5.0-linux,TODO: How to handle POSIX thread priorities on OSX?
v1.5.0-linux,setThreadName is a helper function that is useful when debugging because your threads
v1.5.0-linux,show up in the debugger with the name you set which makes it easier to find the threads
v1.5.0-linux,that you are interested in.
v1.5.0-linux,"unfortunately this is only available on Windows 10, and AirSim is not limited to that."
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.5.0-linux,
v1.5.0-linux,Treat all errors as failure conditions.
v1.5.0-linux,parse command line
v1.5.0-linux,"motive gives a weird error if the project is not found, so we look for it."
v1.5.0-linux,Do an update to pick up any recently-arrived cameras.
v1.5.0-linux,List all detected cameras.
v1.5.0-linux,List all defined rigid bodies.
v1.5.0-linux,throttle to 50 messages per second.
v1.5.0-linux,OptiTrack uses 'y' axis for vertical.
v1.5.0-linux,stdafx.cpp : source file that includes just the standard includes
v1.5.0-linux,MavlinkMoCap.pch will be the pre-compiled header
v1.5.0-linux,stdafx.obj will contain the pre-compiled type information
v1.5.0-linux,TODO: reference any additional headers you need in STDAFX.H
v1.5.0-linux,and not in this file
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,PX4.cpp : Defines the entry point for the console application.
v1.5.0-linux,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.5.0-linux,how do you write to the debug output windows on Unix ?
v1.5.0-linux,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.5.0-linux,connection to create to talke to that server.
v1.5.0-linux,SITL setup info
v1.5.0-linux,The local ethernet interface to use (default localhost).
v1.5.0-linux,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.5.0-linux,server mode on UDP is when you want another app to connect to Pixhawk and publish data back to this process.
v1.5.0-linux,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.5.0-linux,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.5.0-linux,"using their the -qgc option.  Server mode on TCP means mavlinktest will do an ""accept"" socket which is"
v1.5.0-linux,what PX4 is waiting for when it is running in TCP mode.  Here the serverEndPoint is different from the
v1.5.0-linux,offboardEndPoint.  The serverEndPoint specifies which local address to use in case your computer has
v1.5.0-linux,multiple network interfaces.
v1.5.0-linux,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.5.0-linux,this switch controls whether we turn off the RC remote active link loss detection
v1.5.0-linux,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.5.0-linux,from kicking in when you try and fly.
v1.5.0-linux,parse the json
v1.5.0-linux,flatten inner mavlink object
v1.5.0-linux,flatten inner mavlink object
v1.5.0-linux,todo
v1.5.0-linux,todo
v1.5.0-linux,"const char* outLogFileOption = ""outlogfile"";"
v1.5.0-linux,parse command line
v1.5.0-linux,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.5.0-linux,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.5.0-linux,"no local serial connection, so this is the primary droneConnection."
v1.5.0-linux,need a retry loop here because we don't know how quickly px4 will start accepting these connections...
v1.5.0-linux,failed to connect
v1.5.0-linux,"then we need 2 mavlink channels, one for sending/receiving HIL_* messages and the other"
v1.5.0-linux,for controlling the drone.
v1.5.0-linux,this is the control channel.
v1.5.0-linux,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.5.0-linux,cmdTable.push_back(new AltHoldCommand());
v1.5.0-linux,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.5.0-linux,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.5.0-linux,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.5.0-linux,this stops us from being able to connect to SITL mode PX4.
v1.5.0-linux,checkPulse();
v1.5.0-linux,add command text in log
v1.5.0-linux,close previous command.
v1.5.0-linux,FilterLogFiles(logDirectory);
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,send a heartbeat
v1.5.0-linux,accept one incoming connection
v1.5.0-linux,send a heartbeat to the client
v1.5.0-linux,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.5.0-linux,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.5.0-linux,for this unit test we are expecting a request to send an image.
v1.5.0-linux,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.5.0-linux,hmmm
v1.5.0-linux,================ ls
v1.5.0-linux,================ put file
v1.5.0-linux,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.5.0-linux,================ get file
v1.5.0-linux,verify the file contents.
v1.5.0-linux,================ remove file
v1.5.0-linux,================ make directory
v1.5.0-linux,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.5.0-linux,================ remove directory
v1.5.0-linux,Now verification
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,you must call this method if you want HandleMessage to be called subsequently.
v1.5.0-linux,treat literals as one word
v1.5.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.5.0-linux,request gps info
v1.5.0-linux,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.5.0-linux,find relative position since command start so we can compare two commands better
v1.5.0-linux,"these PID values are important, so set these to match"
v1.5.0-linux,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.5.0-linux,we can skip ahead.
v1.5.0-linux,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.5.0-linux,TODO: avoid passing hadcoded HIL flag
v1.5.0-linux,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.5.0-linux,"The global position, as returned by the Global Positioning System (GPS)."
v1.5.0-linux,Provides state for additional features
v1.5.0-linux,The general system state
v1.5.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.5.0-linux,Provides state for additional features
v1.5.0-linux,The general system state
v1.5.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.5.0-linux,Provides state for additional features
v1.5.0-linux,The general system state
v1.5.0-linux,Provides state for additional features
v1.5.0-linux,The general system state
v1.5.0-linux,note: we do not reset com when Close() is called because we want to keep running.
v1.5.0-linux,"user has to invoke ""hil stop"" to stop the hil thread."
v1.5.0-linux,generate random between 0 and 1
v1.5.0-linux,move to range -1 to 1
v1.5.0-linux,scale it
v1.5.0-linux,apply iy
v1.5.0-linux,wait for the Execute method to be called.
v1.5.0-linux,gps is much slower frequency than IMU.
v1.5.0-linux,MAVLINK_MSG_ID_HIL_GPS
v1.5.0-linux,disable MAV_USEHILGPS
v1.5.0-linux,note: we do not reset com when Close() is called because we want to keep running.
v1.5.0-linux,"user has to invoke ""hil stop"" to stop the hil thread."
v1.5.0-linux,generate random between 0 and 1
v1.5.0-linux,move to range -1 to 1
v1.5.0-linux,scale it
v1.5.0-linux,apply iy
v1.5.0-linux,wait for the Execute method to be called.
v1.5.0-linux,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.5.0-linux,gps is much slower frequency than IMU.
v1.5.0-linux,MAVLINK_MSG_ID_HIL_GPS
v1.5.0-linux,disable HIL mode
v1.5.0-linux,Enumeration of landed detector states
v1.5.0-linux,MAV landed state is unknown
v1.5.0-linux,MAV is landed (on ground)
v1.5.0-linux,MAV is in air
v1.5.0-linux,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.5.0-linux,The filtered local position
v1.5.0-linux,must send these regularly to keep offboard control.
v1.5.0-linux,"ok, now we can safely switch to loiter."
v1.5.0-linux,must send these regularly to keep offboard control.
v1.5.0-linux,integrate the heading so it is smoother.
v1.5.0-linux,must send these regularly to keep offboard control.
v1.5.0-linux,integrate the heading so it is smoother.
v1.5.0-linux,fly to radius
v1.5.0-linux,it takes about 10 cm to stop and turn.
v1.5.0-linux,next time around switch to orbiting!
v1.5.0-linux,heading points to center of circle.
v1.5.0-linux,interpoloate the speed ramp up time over 2 seconds from start time
v1.5.0-linux,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.5.0-linux,monitor the sin curves so we can see how on track or off track it actually is.
v1.5.0-linux,the shape of the curve will also tell us if we are progressing at a consistent
v1.5.0-linux,"speed, the more deformed the sin curve the worse our progress."
v1.5.0-linux,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.5.0-linux,degrees just flipped from 359 to 0.
v1.5.0-linux,this enables us to test what happens when offboard control is lost and resumed.
v1.5.0-linux,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.5.0-linux,"ok, now we can start moving by velocity"
v1.5.0-linux,recompute to new target.
v1.5.0-linux,start by moving right with 10 degree roll.
v1.5.0-linux,haven't started yet.
v1.5.0-linux,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.5.0-linux,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.5.0-linux,track how our actual pitch is coming along compared to our target
v1.5.0-linux,and check position
v1.5.0-linux,the amount of pitch should depend on our speed in that direction.
v1.5.0-linux,passed the midpoint.
v1.5.0-linux,fade out the pitch as we pick up speed so we don't overshoot.
v1.5.0-linux,see if we just crossed the wiggle distance threshold.
v1.5.0-linux,(pitch affects the x-position).
v1.5.0-linux,reverse direction with a -30 degrees quick stop
v1.5.0-linux,reverse direction with a 30 degrees quick stop
v1.5.0-linux,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.5.0-linux,too much in that direction.
v1.5.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.5.0-linux,track how our actual roll is coming along compared to our target
v1.5.0-linux,and check position
v1.5.0-linux,the amount of roll should depend on our speed in that direction.
v1.5.0-linux,passed the midpoint.
v1.5.0-linux,fade out the roll as we pick up speed so we don't overshoot.
v1.5.0-linux,see if we just crossed the wiggle distance threshold.
v1.5.0-linux,(roll affects the y-position).
v1.5.0-linux,reverse direction with a -30 degrees quick stop
v1.5.0-linux,reverse direction with a 30 degrees quick stop
v1.5.0-linux,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.5.0-linux,too much in that direction.
v1.5.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.5.0-linux,for testing PID controller.
v1.5.0-linux,class AltHoldCommand : public Command
v1.5.0-linux,{
v1.5.0-linux,std::shared_ptr<MavLinkVehicle> channel;
v1.5.0-linux,"float sx_, sy_, sz_;"
v1.5.0-linux,MavLinkAttitudeTarget _current;
v1.5.0-linux,PidController thrust_controller_;
v1.5.0-linux,public:
v1.5.0-linux,this->sz_ = pos.z; // user defined target.
v1.5.0-linux,move to local position keeps the offboard control happy.
v1.5.0-linux,haven't started yet.
v1.5.0-linux,and check position
v1.5.0-linux,double dx = this->sx_ - pos.x;
v1.5.0-linux,double dy = this->sy_ - pos.y;
v1.5.0-linux,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.5.0-linux,too much in that direction.
v1.5.0-linux,adjust thrust so we keep steady height target
v1.5.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.5.0-linux,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.5.0-linux,local remote
v1.5.0-linux,already handled by the parse method.
v1.5.0-linux,we only support very simple patterns for now.
v1.5.0-linux,each wildcard must be separated by literal.
v1.5.0-linux,back to back wildcards with no literal in between is too complex.
v1.5.0-linux,"we only support simple matching for now, we can add full regex later if we need it."
v1.5.0-linux,yep!
v1.5.0-linux,'*' is done we found the next matching char
v1.5.0-linux,this is ok.
v1.5.0-linux,this is an ERASE_END_LINE command which we ignore.
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,pack the payload buffer.
v1.5.0-linux,calculate checksum
v1.5.0-linux,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.5.0-linux,are variable length as a result.
v1.5.0-linux,form the header as a byte array for the crc
v1.5.0-linux,unpack the message...
v1.5.0-linux,pack the payload buffer.
v1.5.0-linux,"json can't handle ""nan"", so we convert it to null."
v1.5.0-linux,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.5.0-linux,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,start listening to this connection
v1.5.0-linux,Send heartbeat to drone.  You should not do this if some other node is
v1.5.0-linux,already doing it.
v1.5.0-linux,stop listening to the connection.
v1.5.0-linux,get the connection
v1.5.0-linux,Get the local system and component id
v1.5.0-linux,send a command to the remote node
v1.5.0-linux,MavLinkNode::MavLinkNode() = default;
v1.5.0-linux,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.5.0-linux,decrementing the count so the next WaitOne may block.
v1.5.0-linux,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.5.0-linux,convert to absolute time.
v1.5.0-linux,use mach_timespec
v1.5.0-linux,convert to absolute time.
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,return true if we still have offboard control (can lose this if user flips the switch).
v1.5.0-linux,MavLinkVehicle::MavLinkVehicle() = default;
v1.5.0-linux,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.5.0-linux,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,============================== CLIENT ============================================
v1.5.0-linux,image APIs
v1.5.0-linux,or if you are implementing the client side call this function to get the most recent frame.
v1.5.0-linux,returns false if there is no new frame available.
v1.5.0-linux,============================== SERVER ============================================
v1.5.0-linux,call this to send the image back over the connection given to start function.
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,"log every message that is ""sent"" using sendMessage."
v1.5.0-linux,"log every message that is ""received"""
v1.5.0-linux,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.5.0-linux,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.5.0-linux,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.5.0-linux,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,for compatibility with QGroundControl we have to save the time field in big endian.
v1.5.0-linux,todo: mavlink2 support?
v1.5.0-linux,has to be one or the other!
v1.5.0-linux,24 bits.
v1.5.0-linux,24 bits.
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,start listening to this connection
v1.5.0-linux,Send heartbeat to drone.  You should not do this if some other node is
v1.5.0-linux,already doing it.
v1.5.0-linux,this is called for all messages received on the connection.
v1.5.0-linux,"we received a heartbeat, so let's get the capabilities."
v1.5.0-linux,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.5.0-linux,subclasses remembering to call this base implementation.
v1.5.0-linux,stop listening to the connection.
v1.5.0-linux,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.5.0-linux,wait for a heartbeat msg since this will give us the port to send commands to...
v1.5.0-linux,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.5.0-linux,send a heart beat so that the remote node knows we are still alive
v1.5.0-linux,(otherwise drone will trigger a failsafe operation).
v1.5.0-linux,ignore any failures here because we are running in our own thread here.
v1.5.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.5.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.5.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.5.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.5.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.5.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.5.0-linux,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.5.0-linux,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.5.0-linux,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.5.0-linux,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.5.0-linux,"ok, now fetch the missing parameters."
v1.5.0-linux,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.5.0-linux,silently fail since we are on a background thread here...
v1.5.0-linux,tell the caller this is complete.
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,add our custom telemetry message length.
v1.5.0-linux,todo: if we support signing then initialize
v1.5.0-linux,mavlink_intermediate_status_.signing callbacks
v1.5.0-linux,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.5.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.5.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.5.0-linux,send this right away just in case serial link is not already configured
v1.5.0-linux,"log every message that is ""sent"" using sendMessage."
v1.5.0-linux,"log every message that is ""sent"" using sendMessage."
v1.5.0-linux,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.5.0-linux,pack the payload buffer.
v1.5.0-linux,calculate checksum
v1.5.0-linux,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.5.0-linux,are variable length as a result.
v1.5.0-linux,form the header as a byte array for the crc
v1.5.0-linux,these macros use old style cast.
v1.5.0-linux,forward messages from our connected node to the remote proxy.
v1.5.0-linux,tell the remote connection to expect mavlink2 messages.
v1.5.0-linux,forward messages from remote proxy to local connected node
v1.5.0-linux,CurrentThread::setMaximumPriority();
v1.5.0-linux,"hmmm, wait till it is opened?"
v1.5.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.5.0-linux,pick up the sysid/compid of the remote node we are connected to.
v1.5.0-linux,then this is a mavlink 1 message
v1.5.0-linux,then this mavlink sender supports mavlink 2
v1.5.0-linux,queue event for publishing.
v1.5.0-linux,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.5.0-linux,as it ensures we don't lose messages if the listener is slow.
v1.5.0-linux,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.5.0-linux,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.5.0-linux,we would get a deadlock.
v1.5.0-linux,CurrentThread::setMaximumPriority();
v1.5.0-linux,reset counters
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,------------------------------------------------------------------------------
v1.5.0-linux,Defines
v1.5.0-linux,------------------------------------------------------------------------------
v1.5.0-linux,bit number  876543210987654321
v1.5.0-linux,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.5.0-linux,in future it would be good to have ability to add system IDs we are interested in
v1.5.0-linux,if (msg.sysid != getTargetSystemId())
v1.5.0-linux,{
v1.5.0-linux,// we only care about messages from our intended remote node.
v1.5.0-linux,return;
v1.5.0-linux,}
v1.5.0-linux,user may have changed modes on us! So we need to honor that and not
v1.5.0-linux,try and take it back.
v1.5.0-linux,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.5.0-linux,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.5.0-linux,we can store up to 16 channels in rc_channels_scaled.
v1.5.0-linux,The RAW values of the servo outputs
v1.5.0-linux,Metrics typically displayed on a HUD for fixed wing aircraft
v1.5.0-linux,The IMU readings in SI units in NED body frame
v1.5.0-linux,printSystemStatus(&msg);
v1.5.0-linux,todo: use this to determine when we need to do emergency landing...
v1.5.0-linux,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.5.0-linux,Provides state for additional features
v1.5.0-linux,The general system state
v1.5.0-linux,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.5.0-linux,but we do want to know when we get the ack.  So this is async ACK processing!
v1.5.0-linux,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.5.0-linux,if threshold < 0 then the threshold is inverted.
v1.5.0-linux,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.5.0-linux,Convert it to a floating point number between -1 and 1.
v1.5.0-linux,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.5.0-linux,until the move commands start happening.
v1.5.0-linux,return true if user calls requestControl and has not called releaseControl.
v1.5.0-linux,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.5.0-linux,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.5.0-linux,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.5.0-linux,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.5.0-linux,send a few to make sure it gets through...
v1.5.0-linux,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.5.0-linux,us by which time the PX4 times out offboard mode!!
v1.5.0-linux,"assume this was successful, we'll find out if so in the next heartbeat."
v1.5.0-linux,this mode change take precedence over offboard mode.
v1.5.0-linux,thrust must be between -1 and 1.
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,These definitions are copied from PX4 implementation
v1.5.0-linux,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.5.0-linux,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.5.0-linux,/ @brief Command opcodes
v1.5.0-linux,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.5.0-linux,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.5.0-linux,must trim trailing slashes so PX4 doesn't hang!
v1.5.0-linux,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.5.0-linux,from the source.
v1.5.0-linux,check if directory exists.
v1.5.0-linux,perfect.
v1.5.0-linux,use last_message_ so we preserve the sessionid.
v1.5.0-linux,"could not create the local file, so stop."
v1.5.0-linux,must use last_message_ so we preserve the session id.
v1.5.0-linux,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.5.0-linux,todo: error handling here? sequence is out of order...
v1.5.0-linux,"directory must be empty then, can't do nextStep because"
v1.5.0-linux,it will just loop for ever re-requesting zero offset into
v1.5.0-linux,empty directory.
v1.5.0-linux,result should be a list of null terminated file names.
v1.5.0-linux,skipping this entry
v1.5.0-linux,remove the file size field.
v1.5.0-linux,"printf(""%s\n"", name.c_str());"
v1.5.0-linux,request the next batch.
v1.5.0-linux,"perhaps this was a late response after we did a retry, so ignore it."
v1.5.0-linux,"perhaps this was a late response after we did a retry, so ignore it."
v1.5.0-linux,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.5.0-linux,reached the end of the list or the file.
v1.5.0-linux,end of file or directory listing.
v1.5.0-linux,"success, data should be following..."
v1.5.0-linux,ack on this cmd is a noop
v1.5.0-linux,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.5.0-linux,give up then.
v1.5.0-linux,tell watchdog we are sending a request
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,================================= CLIENT ==============================================================
v1.5.0-linux,Check if we have a valid transaction
v1.5.0-linux,emit signal if all packets arrived
v1.5.0-linux,Restart statemachine
v1.5.0-linux,image APIs
v1.5.0-linux,================================= SERVER ==============================================================
v1.5.0-linux,Prepare and send acknowledgment packet
v1.5.0-linux,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.5.0-linux,Send ENCAPSULATED_IMAGE packet
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.5.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.5.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.5.0-linux,send this right away just in case serial link is not already configured
v1.5.0-linux,CurrentThread::setMaximumPriority();
v1.5.0-linux,"hmmm, wait till it is opened?"
v1.5.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.5.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.5.0-linux,queue event for publishing.
v1.5.0-linux,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.5.0-linux,as it ensures we don't lose messages if the listener is slow.
v1.5.0-linux,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.5.0-linux,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.5.0-linux,we would get a deadlock.
v1.5.0-linux,CurrentThread::setMaximumPriority();
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.5.0-linux,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.5.0-linux,parse out the VID number
v1.5.0-linux,now the PID
v1.5.0-linux,parse out the VID number
v1.5.0-linux,examples:
v1.5.0-linux,PX4: USB\VID_26AC&PID_0011\0
v1.5.0-linux,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.5.0-linux,"printf(""Found: %S\n"", buffer.c_str());"
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.5.0-linux,parse out the VID number
v1.5.0-linux,now the PID
v1.5.0-linux,parse out the VID number
v1.5.0-linux,suppress
v1.5.0-linux,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,This has not been properly tested
v1.5.0-linux,struct iw_statistics stats;
v1.5.0-linux,struct iwreq req;
v1.5.0-linux,"memset(&stats, 0, sizeof(stats));"
v1.5.0-linux,"memset(&req, 0, sizeof(iwreq));"
v1.5.0-linux,
v1.5.0-linux,"strncpy(req.ifr_name, ifaceName, 16);"
v1.5.0-linux,req.u.data.pointer = &stats;
v1.5.0-linux,req.u.data.length = sizeof(iw_statistics);
v1.5.0-linux,
v1.5.0-linux,#ifdef CLEAR_UPDATED
v1.5.0-linux,req.u.data.flags = 1;
v1.5.0-linux,#endif
v1.5.0-linux,
v1.5.0-linux,/* Perform the ioctl */
v1.5.0-linux,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.5.0-linux,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.5.0-linux,return -127;
v1.5.0-linux,}
v1.5.0-linux,
v1.5.0-linux,return stats.qual.level;
v1.5.0-linux,todo: windows version of this...
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,windows
v1.5.0-linux,Need to link with Ws2_32.lib
v1.5.0-linux,posix
v1.5.0-linux,found it!
v1.5.0-linux,bind socket to local address.
v1.5.0-linux,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.5.0-linux,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.5.0-linux,write to the serial port
v1.5.0-linux,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.5.0-linux,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.5.0-linux,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.5.0-linux,"try and receive something, up until port is closed anyway."
v1.5.0-linux,"message was too large for the buffer, no problem, return what we have."
v1.5.0-linux,try again - this can happen if server recreates the socket on their side.
v1.5.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.5.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.5.0-linux,"printf(""#### recv failed with error: %d\n"", hr);"
v1.5.0-linux,we now have it.
v1.5.0-linux,this is from someone we are not interested in.
v1.5.0-linux,-----------------------------------------------------------------------------------------
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,Initialize Winsock
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,windows
v1.5.0-linux,Need to link with Ws2_32.lib
v1.5.0-linux,posix
v1.5.0-linux,found it!
v1.5.0-linux,bind socket to local address.
v1.5.0-linux,bind socket to local address.
v1.5.0-linux,start listening for incoming connection
v1.5.0-linux,accept 1
v1.5.0-linux,"don't need to accept any more, so we can close this one."
v1.5.0-linux,write to the serial port
v1.5.0-linux,"try and receive something, up until port is closed anyway."
v1.5.0-linux,"message was too large for the buffer, no problem, return what we have."
v1.5.0-linux,try again - this can happen if server recreates the socket on their side.
v1.5.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.5.0-linux,try again - this can happen if server recreates the socket on their side.
v1.5.0-linux,-----------------------------------------------------------------------------------------
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.5.0-linux,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.5.0-linux,set signal
v1.5.0-linux,Clear Handshake flags
v1.5.0-linux,Set Handshake flags
v1.5.0-linux,return GetLastError();
v1.5.0-linux,return GetLastError();
v1.5.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.5.0-linux,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.5.0-linux,enable reading
v1.5.0-linux,posix doesn't have mark/space parity.
v1.5.0-linux,posix doesn't have mark/space parity.
v1.5.0-linux,this is the default.
v1.5.0-linux,not sure this is supported...
v1.5.0-linux,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.5.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.5.0-linux,First do those specified by POSIX.
v1.5.0-linux,Now conditionally handle a bunch of extended rates.
v1.5.0-linux,First do those specified by POSIX.
v1.5.0-linux,Now conditionally handle a bunch of extended rates.
v1.5.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.5.0-linux,import airsim
v1.5.0-linux,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v1.5.0-linux,self.args = args
v1.5.0-linux,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v1.5.0-linux,pdb.set_trace()
v1.5.0-linux,#include <pluginlib/class_list_macros.h>
v1.5.0-linux,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v1.5.0-linux,todo do not reset if already in air?
v1.5.0-linux,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.5.0-linux,ros params
v1.5.0-linux,todo enforce dynamics constraints in this node as well?
v1.5.0-linux,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v1.5.0-linux,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v1.5.0-linux,XmlRpc::XmlRpcValue can't be const in this case
v1.5.0-linux,subscribe to control commands on global nodehandle
v1.5.0-linux,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.5.0-linux,bind to a single callback. todo optimal subs queue length
v1.5.0-linux,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.5.0-linux,"vehicle_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.5.0-linux,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.5.0-linux,camera_setting.gimbal
v1.5.0-linux,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.5.0-linux,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.5.0-linux,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.5.0-linux,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.5.0-linux,"if {DepthPlanar, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.5.0-linux,"push back pair (vector of image captures, current vehicle name)"
v1.5.0-linux,iterate over sensors
v1.5.0-linux,"we want fast access to the lidar sensors for callback handling, sort them out now"
v1.5.0-linux,add takeoff and land all services if more than 2 drones
v1.5.0-linux,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v1.5.0-linux,todo add per vehicle reset in AirLib API
v1.5.0-linux,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.5.0-linux,lidars update on their own callback/thread at a given rate
v1.5.0-linux,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v1.5.0-linux,"todo: error check. if state is not landed, return error."
v1.5.0-linux,response.success =
v1.5.0-linux,response.success =
v1.5.0-linux,response.success =
v1.5.0-linux,response.success =
v1.5.0-linux,response.success =
v1.5.0-linux,response.success =
v1.5.0-linux,todo add reset by vehicle_name API to airlib
v1.5.0-linux,todo not async remove waitonlasttask
v1.5.0-linux,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v1.5.0-linux,todo do actual body frame?
v1.5.0-linux,airsim uses degrees
v1.5.0-linux,todo do actual body frame?
v1.5.0-linux,airsim uses degrees
v1.5.0-linux,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v1.5.0-linux,todo expose waitOnLastTask or nah?
v1.5.0-linux,todo do actual body frame?
v1.5.0-linux,airsim uses degrees
v1.5.0-linux,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.5.0-linux,todo expose waitOnLastTask or nah?
v1.5.0-linux,todo support multiple gimbal commands
v1.5.0-linux,todo support multiple gimbal commands
v1.5.0-linux,1. find quaternion of default gimbal pose
v1.5.0-linux,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.5.0-linux,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.5.0-linux,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.5.0-linux,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.5.0-linux,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.5.0-linux,msg = []
v1.5.0-linux,todo covariances
v1.5.0-linux,gps_msg.position_covariance_type =
v1.5.0-linux,gps_msg.position_covariance =
v1.5.0-linux,todo covariances
v1.5.0-linux,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.5.0-linux,todo radians per second
v1.5.0-linux,meters/s2^m
v1.5.0-linux,imu_msg.orientation_covariance = ;
v1.5.0-linux,imu_msg.angular_velocity_covariance = ;
v1.5.0-linux,imu_msg.linear_acceleration_covariance = ;
v1.5.0-linux,airsim appears to use chrono::system_clock with nanosecond precision
v1.5.0-linux,todo this is global origin
v1.5.0-linux,get the basic vehicle pose and environmental state
v1.5.0-linux,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.5.0-linux,airsim_client needs to provide the simulation time in a future version of the API
v1.5.0-linux,publish the simulation clock
v1.5.0-linux,"publish vehicle state, odom, and all basic sensor types"
v1.5.0-linux,send any commands out to the vehicles
v1.5.0-linux,"should be easier way to get the sim time through API, something like:"
v1.5.0-linux,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.5.0-linux,curr_ros_time = airsim_timestamp_to_ros(env.clock().nowNanos());
v1.5.0-linux,iterate over drones
v1.5.0-linux,get drone state from airsim
v1.5.0-linux,"vehicle environment, we can get ambient temperature here and other truths"
v1.5.0-linux,convert airsim drone state to ROS msgs
v1.5.0-linux,simulation environment truth
v1.5.0-linux,"dashboard reading from car, RPM, gear, etc"
v1.5.0-linux,odom and transforms
v1.5.0-linux,ground truth GPS position from sim/HITL
v1.5.0-linux,handled via callback
v1.5.0-linux,send control commands from the last callback to airsim
v1.5.0-linux,send control commands from the last callback to airsim
v1.5.0-linux,"Only camera rotation, no translation movement of camera"
v1.5.0-linux,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.5.0-linux,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.5.0-linux,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.5.0-linux,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.5.0-linux,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.5.0-linux,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.5.0-linux,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.5.0-linux,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.5.0-linux,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.5.0-linux,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.5.0-linux,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.5.0-linux,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.5.0-linux,update timestamp of saved cam info msgs
v1.5.0-linux,DepthPlanar / DepthPerspective / DepthVis / DisparityNormalized
v1.5.0-linux,Scene / Segmentation / SurfaceNormals / Infrared
v1.5.0-linux,publish camera transforms
v1.5.0-linux,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.5.0-linux,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.5.0-linux,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.5.0-linux,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.5.0-linux,ROS params
v1.5.0-linux,ROS publishers
v1.5.0-linux,ROS subscribers
v1.5.0-linux,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.5.0-linux,ROS timers
v1.5.0-linux,todo maintain internal representation as eigen vec?
v1.5.0-linux,todo check if low velocity if within thresh?
v1.5.0-linux,todo maintain separate errors for XY and Z
v1.5.0-linux,todo save this in degrees somewhere to avoid repeated conversion
v1.5.0-linux,this tells the update timer callback to not do active hovering
v1.5.0-linux,todo maintain array of position goals
v1.5.0-linux,todo error checks
v1.5.0-linux,todo fill response
v1.5.0-linux,"Already have goal, and have reached it"
v1.5.0-linux,this tells the update timer callback to not do active hovering
v1.5.0-linux,todo error checks
v1.5.0-linux,todo fill response
v1.5.0-linux,"todo do relative altitude, or add an option for the same?"
v1.5.0-linux,convert GPS goal to NED goal
v1.5.0-linux,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.5.0-linux,todo error checks
v1.5.0-linux,todo fill response
v1.5.0-linux,"Already have goal, this shouldn't happen"
v1.5.0-linux,"todo do relative altitude, or add an option for the same?"
v1.5.0-linux,convert GPS goal to NED goal
v1.5.0-linux,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.5.0-linux,todo error checks
v1.5.0-linux,todo fill response
v1.5.0-linux,todo check if odometry is too old!!
v1.5.0-linux,"if no odom, don't do anything."
v1.5.0-linux,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.5.0-linux,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.5.0-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.5.0-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.5.0-linux,todo yaw limits
v1.5.0-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.5.0-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.5.0-linux,mimics void ASimHUD::initializeSettings()
v1.5.0-linux,int num_threads = 1;
v1.5.0-linux,ros::MultiThreadedSpinner multi_thread(num_threads);
v1.5.0-linux,multi_thread.spin();
v1.5.0-linux,ros::AsyncSpinner async_spinner(num_threads);
v1.5.0-linux,async_spinner.start();
v1.5.0-linux,single threaded spinner
v1.5.0-linux,connect to the AirSim simulator
v1.5.0-linux,","
v1.5.0-linux,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.5.0-linux,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,"in header only mode, control library is not available"
v1.5.0-linux,TODO: something defines max macro which interfears with code here
v1.5.0-linux,is cur_pos within fence?
v1.5.0-linux,destination risk is not available then consider it zero
v1.5.0-linux,if dest risk is lower than its more safe
v1.5.0-linux,are we doing better than closest obstacle?
v1.5.0-linux,"if we stay where we are, what is the risk distance?"
v1.5.0-linux,else we are better of moving to dest
v1.5.0-linux,this function should work even when dest_pos == cur_pos
v1.5.0-linux,is this dest_pos cur_pos within the fence?
v1.5.0-linux,transform dest_pos vector to body frame
v1.5.0-linux,check for approx zero vectors to avoid random yaw angles
v1.5.0-linux,we are hovering
v1.5.0-linux,"get yaw in body frame, ie, front is always 0 radians"
v1.5.0-linux,yaw to ticks
v1.5.0-linux,get obstacles in the window at the tick direction around the window
v1.5.0-linux,less risk distance is better
v1.5.0-linux,check obstacles around current position and see if it has lower risk
v1.5.0-linux,else obstacle is too far
v1.5.0-linux,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.5.0-linux,look for each surrounding tick to see if we have obstacle free angle
v1.5.0-linux,else no suggestions required
v1.5.0-linux,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.5.0-linux,evaluate right and left side of circle
v1.5.0-linux,find right and left risk distances
v1.5.0-linux,at this point we have already determined hover is better than going to dest
v1.5.0-linux,we now determine is moving to suggested angle better than hovering?
v1.5.0-linux,check if dest_pos is safe
v1.5.0-linux,breaking distance at this velocity
v1.5.0-linux,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.5.0-linux,check if dest_pos is safe
v1.5.0-linux,float/vec parameters can have NaN which makes them optional
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,"in header only mode, control library is not available"
v1.5.0-linux,handles +/- tick and wraps around circle
v1.5.0-linux,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.5.0-linux,update the specified window on the map
v1.5.0-linux,make sure from <= to
v1.5.0-linux,normalize the ticks so both are valid indices
v1.5.0-linux,if from is still larger then
v1.5.0-linux,to ticks is then added one full circle to make it larger than from_tick
v1.5.0-linux,find closest obstacle in given window
v1.5.0-linux,search whole map to find closest obstacle
v1.5.0-linux,"in header only mode, control library is not available"
v1.5.0-linux,#include <fileapi.h>
v1.5.0-linux,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.5.0-linux,"Windows, OSX and Linux."
v1.5.0-linux,Windows users can move the Documents folder to any location they want
v1.5.0-linux,SHGetFolderPath knows how to find it.
v1.5.0-linux,fall back in case SHGetFolderPath failed for some reason.
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,"in header only mode, control library is not available"
v1.5.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.5.0-linux,if using Unreal Build system then include precompiled header file first
v1.5.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.5.0-linux,this deadlocks UI thread if async_run was called while there are pending rpc calls.
v1.5.0-linux,Exit if already resetting.
v1.5.0-linux,Reset
v1.5.0-linux,if we don't suppress then server will bomb out for exceptions raised by any method
v1.5.0-linux,required for pimpl
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,"in header only mode, control library is not available"
v1.5.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.5.0-linux,if using Unreal Build system then include precompiled header file first
v1.5.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.5.0-linux,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.5.0-linux,make sure we can talk to the DroneServer
v1.5.0-linux,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.5.0-linux,command_context.client.ping();
v1.5.0-linux,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.5.0-linux,sim only
v1.5.0-linux,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.5.0-linux,return value of last task. It should be true if task completed without
v1.5.0-linux,cancellation or timeout
v1.5.0-linux,"should be implemented by derived class if it supports async task,"
v1.5.0-linux,for example using futures
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,"in header only mode, control library is not available"
v1.5.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.5.0-linux,if using Unreal Build system then include precompiled header file first
v1.5.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,"in header only mode, control library is not available"
v1.5.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.5.0-linux,if using Unreal Build system then include precompiled header file first
v1.5.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.5.0-linux,required for pimpl
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,"in header only mode, control library is not available"
v1.5.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.5.0-linux,if using Unreal Build system then include precompiled header file first
v1.5.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.5.0-linux,status getters
v1.5.0-linux,Rotor state getter
v1.5.0-linux,Multirotor state getter
v1.5.0-linux,return value of last task. It should be true if task completed without
v1.5.0-linux,cancellation or timeout
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,"in header only mode, control library is not available"
v1.5.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.5.0-linux,if using Unreal Build system then include pre-compiled header file first
v1.5.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.5.0-linux,getters
v1.5.0-linux,Rotor state
v1.5.0-linux,Multirotor state
v1.5.0-linux,required for pimpl
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,"in header only mode, control library is not available"
v1.5.0-linux,last command is to hold on to position
v1.5.0-linux,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.5.0-linux,after landing we detect if drone has stopped moving
v1.5.0-linux,validate path size
v1.5.0-linux,validate yaw mode
v1.5.0-linux,validate and set auto-lookahead value
v1.5.0-linux,if auto mode requested for lookahead then calculate based on velocity
v1.5.0-linux,add current position as starting point
v1.5.0-linux,append the input path and compute segments
v1.5.0-linux,add last segment as zero length segment so we have equal number of segments and points.
v1.5.0-linux,path_segs[i] refers to segment that starts at point i
v1.5.0-linux,"when path ends, we want to slow down"
v1.5.0-linux,else no need to change velocities for last segments
v1.5.0-linux,setup current position on path to 0 offset
v1.5.0-linux,initialize next path position
v1.5.0-linux,until we are at the end of the path (last seg is always zero size)
v1.5.0-linux,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.5.0-linux,send drone command to get to next lookahead
v1.5.0-linux,sleep for rest of the cycle
v1.5.0-linux,how much have we moved towards last goal?
v1.5.0-linux,project actual vector on goal vector
v1.5.0-linux,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.5.0-linux,TODO: below should be lower than 1E3 and configurable
v1.5.0-linux,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.5.0-linux,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.5.0-linux,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.5.0-linux,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.5.0-linux,"if drone moved backward, we don't want goal to move backward as well"
v1.5.0-linux,"so only climb forward on the path, never back. Also note >= which means"
v1.5.0-linux,we climb path even if distance was 0 to take care of duplicated points on path
v1.5.0-linux,else
v1.5.0-linux,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.5.0-linux,compute next target on path
v1.5.0-linux,freeze the quaternion
v1.5.0-linux,convert RC commands to velocity vector
v1.5.0-linux,find yaw as per terrain and remote setting
v1.5.0-linux,execute command
v1.5.0-linux,if timeout occurred then command completed successfully otherwise it was interrupted
v1.5.0-linux,yaw is not within margin
v1.5.0-linux,by default we say that this command is not supported
v1.5.0-linux,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.5.0-linux,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.5.0-linux,get trims
v1.5.0-linux,take average
v1.5.0-linux,validate dest
v1.5.0-linux,what is the distance we will travel at this velocity?
v1.5.0-linux,get velocity vector
v1.5.0-linux,yaw for the direction of travel
v1.5.0-linux,find velocity vector
v1.5.0-linux,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.5.0-linux,generate velocity vector that is same size as cur_dest_norm / command period
v1.5.0-linux,this velocity vect when executed for command period would yield cur_dest_norm
v1.5.0-linux,send commands
v1.5.0-linux,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.5.0-linux,default strategy is for move. In hover mode we set new strategy temporarily
v1.5.0-linux,are we supposed to do EM?
v1.5.0-linux,get suggested velocity vector
v1.5.0-linux,use the unchecked command
v1.5.0-linux,tell caller not to execute planned command
v1.5.0-linux,other wise throw exception
v1.5.0-linux,otherwise there is some other reason why we are in unsafe situation
v1.5.0-linux,send last command to come to full stop
v1.5.0-linux,else no unsafe situation
v1.5.0-linux,note: cur_path_loc and next_path_loc may both point to same object
v1.5.0-linux,"otherwise use up this segment, move on to next one"
v1.5.0-linux,if we are here then we ran out of segments
v1.5.0-linux,consider last segment as zero length segment
v1.5.0-linux,adjust yaw for the direction of travel in forward-only mode
v1.5.0-linux,else no adjustment needed
v1.5.0-linux,if auto mode requested for lookahead then calculate based on velocity
v1.5.0-linux,Create a spring arm component for our chase camera
v1.5.0-linux,"do nothing, spring arm is pulling the camera with it"
v1.5.0-linux,"do nothing, we have camera turned off"
v1.5.0-linux,set initial view mode
v1.5.0-linux,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.5.0-linux,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.5.0-linux,"If the lag is missing, the camera will also occasionally shake."
v1.5.0-linux,"But, lag is not desired when piloting a drone"
v1.5.0-linux,attach spring arm to actor
v1.5.0-linux,remember current parent for external camera. Later when we remove external
v1.5.0-linux,"camera from spring arm, we will attach it back to its last parent"
v1.5.0-linux,now attach camera to spring arm
v1.5.0-linux,"For car, we need to move the camera back a little more than for a drone."
v1.5.0-linux,"Otherwise, the camera will be stuck inside the car"
v1.5.0-linux,ExternalCamera->bUsePawnControlRotation = false;
v1.5.0-linux,detach spring arm
v1.5.0-linux,Re-enable rendering
v1.5.0-linux,Remove any existing key bindings for manual mode
v1.5.0-linux,"else someone else is bound to manual pose controller, leave it alone"
v1.5.0-linux,if new mode is manual mode then add key bindings
v1.5.0-linux,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.5.0-linux,other modes don't need special setup
v1.5.0-linux,make switch official
v1.5.0-linux,Add loading screen to viewport
v1.5.0-linux,Remove Loading screen from viewport
v1.5.0-linux,Create struct for Location and Rotation of actor in Unreal
v1.5.0-linux,new_actor_spawn_params.NameMode = FActorSpawnParameters::ESpawnActorNameMode::Required_ReturnNull;
v1.5.0-linux,Write the binvox file using run-length encoding
v1.5.0-linux,"where each pair of bytes is of the format (run value, run length)"
v1.5.0-linux,This is a run (repeated bit value)
v1.5.0-linux,End of a run
v1.5.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.5.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.5.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.5.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.5.0-linux,Split the tag string into individual tags.
v1.5.0-linux,Texture swap on actors that have all of those tags.
v1.5.0-linux,----------- Plotting APIs ----------/
v1.5.0-linux,"plot line for points 0-1, 1-2, 2-3"
v1.5.0-linux,"plot line for points 0-1, 2-3, 4-5... must be even number of points"
v1.5.0-linux,assert points_start.size() == poinst_end.size()
v1.5.0-linux,assert positions.size() == strings.size()
v1.5.0-linux,assert poses.size() == names.size()
v1.5.0-linux,Recording APIs
v1.5.0-linux,by default all image types are disabled
v1.5.0-linux,use final color for all calculations
v1.5.0-linux,TODO: avoid the need to override const cast here
v1.5.0-linux,if the viewport is taller than it is wide
v1.5.0-linux,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v1.5.0-linux,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v1.5.0-linux,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v1.5.0-linux,use final color for all calculations
v1.5.0-linux,TODO: should we be ignoring position and orientation settings here?
v1.5.0-linux,TODO: can we eliminate storing NedTransform?
v1.5.0-linux,if (!std::isnan(setting.target_gamma))
v1.5.0-linux,camera-> = setting.target_gamma;
v1.5.0-linux,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.5.0-linux,else nothing to enable
v1.5.0-linux,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.5.0-linux,if (controller && controller->GetViewTarget() == this)
v1.5.0-linux,controller->SetViewTarget(nullptr);
v1.5.0-linux,"Check whether requested map exists, this could be very slow if LevelName is a short package name"
v1.5.0-linux,Create Unique Name for sub-level package
v1.5.0-linux,Setup streaming level object that will load specified map
v1.5.0-linux,Transform
v1.5.0-linux,Map to Load
v1.5.0-linux,Add the new level to world.
v1.5.0-linux,TODO: explore screenshot option
v1.5.0-linux,addScreenCaptureHandler(camera->GetWorld());
v1.5.0-linux,TODO: may be we should have these methods non-const?
v1.5.0-linux,We don't do game/render thread synchronization for safe method.
v1.5.0-linux,We just blindly sleep for 200ms (the old way)
v1.5.0-linux,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.5.0-linux,Make sure that all alpha values are opaque.
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,TODO: change naming conventions to same as other files?
v1.5.0-linux,"context->GetWorld()->SetNewWorldOrigin(FIntVector(0, 0, 0));"
v1.5.0-linux,Enable/disable primary viewport rendering flag
v1.5.0-linux,This disables rendering of the main viewport in the same way as the
v1.5.0-linux,"console command ""show rendering"" would do."
v1.5.0-linux,"When getting an image through the API, the image is produced after the render"
v1.5.0-linux,thread has finished rendering the current and the subsequent frame. This means
v1.5.0-linux,that the frame rate for obtaining images through the API is only half as high as
v1.5.0-linux,"it could be, since only every other image is actually captured. We work around"
v1.5.0-linux,this by telling the viewport to flush the rendering queue at the end of each
v1.5.0-linux,drawn frame so that it executes our render request at that point already.
v1.5.0-linux,Do this only if the main viewport is not being rendered anyway in case there are
v1.5.0-linux,any adverse performance effects during main rendering.
v1.5.0-linux,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v1.5.0-linux,nothing to do for now
v1.5.0-linux,"if hidden, clear any existing messages"
v1.5.0-linux,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.5.0-linux,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.5.0-linux,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.5.0-linux,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.5.0-linux,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.5.0-linux,Find mesh in /Game and /AirSim asset registry. When more plugins are added this function will have to change
v1.5.0-linux,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.5.0-linux,{
v1.5.0-linux,InitializeObjectStencilID(*comp);
v1.5.0-linux,}
v1.5.0-linux,"Takes a UStaticMeshComponent, USkinnedMeshComponent or ALandscapeProxy and returns their custom stencil ID if"
v1.5.0-linux,their meshes's name or their owner's name (depending on the naming method in mesh_naming_method_) equals mesh_name
v1.5.0-linux,"The skybox is ignored here as it is huge, and really is of no use to the end user typically. Also the associated meshes with the cameras"
v1.5.0-linux,Various checks if there is even a valid mesh
v1.5.0-linux,Need to force the render command to go through cause on the next iteration the buffer no longer exists
v1.5.0-linux,Unreal stores more vertices than triangles. So here we find the highest referenced vertex and ignore any after that
v1.5.0-linux,can we see followee?
v1.5.0-linux,remove mapping
v1.5.0-linux,removing binding
v1.5.0-linux,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.5.0-linux,"some point. At the moment, manually swapping Red and Blue"
v1.5.0-linux,Copy scaled image into destination thumb
v1.5.0-linux,Compress data - convert into a .png
v1.5.0-linux,if we already have attached actor
v1.5.0-linux,#ifdef _MSC_VER
v1.5.0-linux,//print to VS output window
v1.5.0-linux,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.5.0-linux,#endif
v1.5.0-linux,also do default logging
v1.5.0-linux,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.5.0-linux,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.5.0-linux,{
v1.5.0-linux,if (GEngine != nullptr)
v1.5.0-linux,{
v1.5.0-linux,return GEngine->GameUserSettings;
v1.5.0-linux,}
v1.5.0-linux,return nullptr;
v1.5.0-linux,}
v1.5.0-linux,UGameUserSettings* game_settings = GetGameUserSettings();
v1.5.0-linux,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.5.0-linux,game_settings->ApplySettings(true);
v1.5.0-linux,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.5.0-linux,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.5.0-linux,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.5.0-linux,todo unused. need to manually plots tf axes' line in right handed FLU instead of using DrawDebugCoordinateSystem
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,plugin startup
v1.5.0-linux,plugin shutdown
v1.5.0-linux,initialize state
v1.5.0-linux,add listener for pawn's collision event
v1.5.0-linux,compute our home point
v1.5.0-linux,default behavior is to call update every tick
v1.5.0-linux,"for custom physics engine, this method should be overridden and update should be"
v1.5.0-linux,called from every physics tick
v1.5.0-linux,add cameras that already exists in pawn
v1.5.0-linux,create or replace cameras specified in settings
v1.5.0-linux,setup individual cameras
v1.5.0-linux,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.5.0-linux,for each camera in settings
v1.5.0-linux,get pose
v1.5.0-linux,spawn and attach camera to pawn
v1.5.0-linux,add on to our collection
v1.5.0-linux,Deflect along the surface when we collide.
v1.5.0-linux,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.5.0-linux,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.5.0-linux,-1 to 1 --> 0 to 1
v1.5.0-linux,-1 to 1
v1.5.0-linux,these will be available for devices like steering wheels
v1.5.0-linux,switch index 0 to 7 for FrSky Taranis RC is:
v1.5.0-linux,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.5.0-linux,TODO: should below be at controller level info?
v1.5.0-linux,else don't waste time
v1.5.0-linux,sync environment from kinematics
v1.5.0-linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.5.0-linux,void playBack()
v1.5.0-linux,{
v1.5.0-linux,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.5.0-linux,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.5.0-linux,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.5.0-linux,}
v1.5.0-linux,TODO: refactor below code used for playback
v1.5.0-linux,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.5.0-linux,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.5.0-linux,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.5.0-linux,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.5.0-linux,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.5.0-linux,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.5.0-linux,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.5.0-linux,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.5.0-linux,}
v1.5.0-linux,parameters in NED frame
v1.5.0-linux,translate to new PawnSimApi position & orientation from NED to NEU
v1.5.0-linux,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.5.0-linux,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.5.0-linux,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.5.0-linux,checked at the start of next tick
v1.5.0-linux,allow teleportation
v1.5.0-linux,if collisions are not enabled
v1.5.0-linux,or we have collided but passthrough is enabled
v1.5.0-linux,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.5.0-linux,"without flip flopping, collisions can't be detected"
v1.5.0-linux,update kinematics from pawn's movement instead of physics engine
v1.5.0-linux,by default we update kinematics from UE pawn
v1.5.0-linux,if SimMod uses its own physics engine then this should be overriden
v1.5.0-linux,no default action in this base class
v1.5.0-linux,"read pixels from render target using render thread, then compress the result into PNG"
v1.5.0-linux,argument on the thread that calls this method.
v1.5.0-linux,TODO: is below really needed?
v1.5.0-linux,make sure we are not on the rendering thread
v1.5.0-linux,TODO: below doesn't work right now because it must be running in game thread
v1.5.0-linux,below is documented method but more expensive because it forces flush
v1.5.0-linux,wait for render thread to pick up our task
v1.5.0-linux,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.5.0-linux,capture CameraPose for this frame
v1.5.0-linux,The completion is called immeidately after GameThread sends the
v1.5.0-linux,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.5.0-linux,execute *immediately* after RenderThread renders the scene!
v1.5.0-linux,"while we're still on GameThread, enqueue request for capture the scene!"
v1.5.0-linux,wait for this task to complete
v1.5.0-linux,log a message and continue wait
v1.5.0-linux,lamda function still references a few objects for which there is no refcount.
v1.5.0-linux,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.5.0-linux,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.5.0-linux,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.5.0-linux,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.5.0-linux,Fill out your copyright notice in the Description page of Project Settings.
v1.5.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.5.0-linux,UWorld* World = GetWorld();
v1.5.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.5.0-linux,still need the menu class for f10
v1.5.0-linux,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v1.5.0-linux,showWeatherMenu(WorldContextObject);
v1.5.0-linux,"if weather is not enabled, dont allow any weather values to be set"
v1.5.0-linux,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v1.5.0-linux,and must be set to true or false before this.
v1.5.0-linux,WeatherEnabled will always be false
v1.5.0-linux,"NOTE: weather enabled must be set first, before other params for this to work"
v1.5.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.5.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.5.0-linux,"get all menu actors, if any"
v1.5.0-linux,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.5.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.5.0-linux,"get all menu actors, if any"
v1.5.0-linux,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.5.0-linux,"get all menu actors, if any, then hide the menu"
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,Stuff to filter out XInput devices
v1.5.0-linux,-----------------------------------------------------------------------------
v1.5.0-linux,"Defines, constants, and global variables"
v1.5.0-linux,-----------------------------------------------------------------------------
v1.5.0-linux,Magnitude ranges from -1 to 1
v1.5.0-linux,Strength ranges from 0 to 1
v1.5.0-linux,Autocenter
v1.5.0-linux,Rumble
v1.5.0-linux,Register with the DirectInput subsystem and get a pointer
v1.5.0-linux,to a IDirectInput interface we can use.
v1.5.0-linux,Create a DInput object
v1.5.0-linux,Look for a simple joystick we can use for this sample program.
v1.5.0-linux,Make sure we got a joystick
v1.5.0-linux,"Set the data format to ""simple joystick"" - a predefined data format"
v1.5.0-linux,
v1.5.0-linux,"A data format specifies which controls on a device we are interested in,"
v1.5.0-linux,and how they should be reported. This tells DInput that we will be
v1.5.0-linux,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.5.0-linux,Set the cooperative level to let DInput know how this device should
v1.5.0-linux,interact with the system and with other DInput applications.
v1.5.0-linux,Enumerate the joystick objects. The callback function enabled user
v1.5.0-linux,"interface elements for objects that are found, and sets the min/max"
v1.5.0-linux,values property for discovered axes.
v1.5.0-linux,-----------------------------------------------------------------------------
v1.5.0-linux,Enum each PNP device using WMI and check each device ID to see if it contains
v1.5.0-linux,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.5.0-linux,Unfortunately this information can not be found by just using DirectInput.
v1.5.0-linux,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.5.0-linux,XInput devices.
v1.5.0-linux,
v1.5.0-linux,This function stores the list of xinput devices in a linked list
v1.5.0-linux,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.5.0-linux,-----------------------------------------------------------------------------
v1.5.0-linux,CoInit if needed
v1.5.0-linux,Create WMI
v1.5.0-linux,Create BSTRs for WMI
v1.5.0-linux,Connect to WMI
v1.5.0-linux,Switch security level to IMPERSONATE
v1.5.0-linux,Get list of Win32_PNPEntity devices
v1.5.0-linux,Loop over all devices
v1.5.0-linux,Get 20 at a time
v1.5.0-linux,"For each device, get its device ID"
v1.5.0-linux,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.5.0-linux,Unfortunately this information can not be found by just using DirectInput
v1.5.0-linux,"If it does, then get the VID/PID from var.bstrVal"
v1.5.0-linux,Add the VID/PID to a linked list
v1.5.0-linux,-----------------------------------------------------------------------------
v1.5.0-linux,Returns true if the DirectInput device is also an XInput device.
v1.5.0-linux,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.5.0-linux,-----------------------------------------------------------------------------
v1.5.0-linux,Check each xinput device to see if this device's vid/pid matches
v1.5.0-linux,-----------------------------------------------------------------------------
v1.5.0-linux,Cleanup needed for IsXInputDevice()
v1.5.0-linux,-----------------------------------------------------------------------------
v1.5.0-linux,Cleanup linked list
v1.5.0-linux,-----------------------------------------------------------------------------
v1.5.0-linux,Name: EnumJoysticksCallback()
v1.5.0-linux,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.5.0-linux,device interface on it so we can play with it.
v1.5.0-linux,-----------------------------------------------------------------------------
v1.5.0-linux,Skip anything other than the perferred joystick device as defined by the control panel.
v1.5.0-linux,Instead you could store all the enumerated joysticks and let the user pick.
v1.5.0-linux,Obtain an interface to the enumerated joystick.
v1.5.0-linux,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.5.0-linux,it while we were in the middle of enumerating it.)
v1.5.0-linux,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.5.0-linux,could store all the enumerated joysticks and let the user pick.
v1.5.0-linux,-----------------------------------------------------------------------------
v1.5.0-linux,Name: EnumObjectsCallback()
v1.5.0-linux,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.5.0-linux,joystick. This function enables user interface elements for objects
v1.5.0-linux,"that are found to exist, and scales axes min/max values."
v1.5.0-linux,-----------------------------------------------------------------------------
v1.5.0-linux,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.5.0-linux,enumerated axis in order to scale min/max values.
v1.5.0-linux,Set the range for the axis
v1.5.0-linux,Set the UI to reflect what objects the joystick supports
v1.5.0-linux,-----------------------------------------------------------------------------
v1.5.0-linux,Name: UpdateInputState()
v1.5.0-linux,Desc: Get the input device's state and display it.
v1.5.0-linux,-----------------------------------------------------------------------------
v1.5.0-linux,Poll the device to read the current state
v1.5.0-linux,DInput is telling us that the input stream has been
v1.5.0-linux,"interrupted. We aren't tracking any state between polls, so"
v1.5.0-linux,we don't have any special reset that needs to be done. We
v1.5.0-linux,just re-acquire and try again.
v1.5.0-linux,while (hr == DIERR_INPUTLOST)
v1.5.0-linux,hr = g_pJoystick->Acquire();
v1.5.0-linux,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.5.0-linux,may occur when the app is minimized or in the process of
v1.5.0-linux,"switching, so just try again later"
v1.5.0-linux,Get the input's device state
v1.5.0-linux,Axes
v1.5.0-linux,Slider controls
v1.5.0-linux,Points of view
v1.5.0-linux,Buttons
v1.5.0-linux,-----------------------------------------------------------------------------
v1.5.0-linux,Name: FreeDirectInput()
v1.5.0-linux,Desc: Initialize the DirectInput variables.
v1.5.0-linux,-----------------------------------------------------------------------------
v1.5.0-linux,Unacquire the device one last time just in case
v1.5.0-linux,the app tried to exit while the device is still acquired.
v1.5.0-linux,Release any DirectInput objects.
v1.5.0-linux,nop
v1.5.0-linux,normalize min to max --> 0 to 1
v1.5.0-linux,normalize 0 to 1 --> -1 to 1
v1.5.0-linux,#include <libudev.h>
v1.5.0-linux,implementation for unsupported OS
v1.5.0-linux,if this is new index
v1.5.0-linux,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.5.0-linux,close previous one
v1.5.0-linux,open new device
v1.5.0-linux,if open was successful
v1.5.0-linux,read the device
v1.5.0-linux,if we didn't had valid read
v1.5.0-linux,"NOTE if this condition is not met, we're probably out of sync and this"
v1.5.0-linux,Joystick instance is likely unusable
v1.5.0-linux,TODO: set below to false?
v1.5.0-linux,state.is_valid = false;
v1.5.0-linux,else ignore
v1.5.0-linux,TODO: implement this for linux
v1.5.0-linux,TODO: implement this for linux
v1.5.0-linux,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.5.0-linux,{
v1.5.0-linux,"manufacturerID = productID = """";"
v1.5.0-linux,// Use udev to look up the product and manufacturer IDs
v1.5.0-linux,struct udev *udev = udev_new();
v1.5.0-linux,if (udev) {
v1.5.0-linux,char sysname[32];
v1.5.0-linux,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.5.0-linux,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.5.0-linux,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.5.0-linux,if (!dev)
v1.5.0-linux,{
v1.5.0-linux,"message = ""Unable to find parent USB device"";"
v1.5.0-linux,return false;
v1.5.0-linux,}
v1.5.0-linux,std::stringstream ss;
v1.5.0-linux,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.5.0-linux,ss >> manufacturerID;
v1.5.0-linux,ss.clear();
v1.5.0-linux,"ss.str("""");"
v1.5.0-linux,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.5.0-linux,ss >> productID;
v1.5.0-linux,udev_device_unref(dev);
v1.5.0-linux,}
v1.5.0-linux,else
v1.5.0-linux,{
v1.5.0-linux,"message = ""Cannot create udev"";"
v1.5.0-linux,return false;
v1.5.0-linux,}
v1.5.0-linux,udev_unref(udev);
v1.5.0-linux,return true;
v1.5.0-linux,}
v1.5.0-linux,required for pimpl
v1.5.0-linux,TODO: anyway to workaround const_cast?
v1.5.0-linux,FGenericPlatformMisc::PlatformInit();
v1.5.0-linux,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.5.0-linux,TODO: index check
v1.5.0-linux,create main widget
v1.5.0-linux,synchronize PIP views
v1.5.0-linux,TODO: should we only do below on SceneCapture2D components and cameras?
v1.5.0-linux,avoid motion blur so capture images don't get
v1.5.0-linux,use two different methods to set console var because sometime it doesn't seem to work
v1.5.0-linux,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.5.0-linux,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.5.0-linux,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.5.0-linux,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.5.0-linux,setup defaults
v1.5.0-linux,Attempts to parse the settings text from one of multiple locations.
v1.5.0-linux,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.5.0-linux,"Next, check the executable's working directory for the settings file."
v1.5.0-linux,"Finally, check the user's documents folder."
v1.5.0-linux,"If the settings file cannot be read, throw an exception"
v1.5.0-linux,Attempts to parse the settings file path or the settings text from the command line
v1.5.0-linux,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.5.0-linux,"Example (Path): AirSim.exe --settings ""C:\path\to\settings.json"""
v1.5.0-linux,"Example (Text): AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.5.0-linux,"Returns true if the argument is present, false otherwise."
v1.5.0-linux,build image file name
v1.5.0-linux,write image file
v1.5.0-linux,"Write PNG image, already compressed in binary"
v1.5.0-linux,write to CSV file
v1.5.0-linux,"Either images were saved successfully, or there were no images"
v1.5.0-linux,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.5.0-linux,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.5.0-linux,"Just need any 1 instance, to set the header line of the record file"
v1.5.0-linux,"Set is_ready at the end, setting this before can cause a race when the file isn't open yet"
v1.5.0-linux,make sure all vars are set up
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,decide which derived BP to use
v1.5.0-linux,we don't have real vehicle so no vehicle API
v1.5.0-linux,put camera little bit above vehicle
v1.5.0-linux,update ground level
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,let base class setup physics world
v1.5.0-linux,stop physics thread before we dismantle
v1.5.0-linux,setup clock in ClockFactory
v1.5.0-linux,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.5.0-linux,steppable clock returns interval that is a constant number irrespective of wall clock
v1.5.0-linux,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.5.0-linux,but that would cause vehicles like quadrotors to become unstable
v1.5.0-linux,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.5.0-linux,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.5.0-linux,get increase in clock speed
v1.5.0-linux,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.5.0-linux,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.5.0-linux,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.5.0-linux,Approach 2: scale control loop frequency if clock is speeded up
v1.5.0-linux,"for slowing down, this don't generate instability"
v1.5.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.5.0-linux,decide which derived BP to use
v1.5.0-linux,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.5.0-linux,vehicle_sim_api->reset();
v1.5.0-linux,create vehicle API
v1.5.0-linux,setup physics vehicle
v1.5.0-linux,initialize private vars
v1.5.0-linux,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.5.0-linux,calls to update* are handled by physics engine and in SimModeWorldBase
v1.5.0-linux,"Utils::log(""------Render tick-------"");"
v1.5.0-linux,"if reset is pending then do it first, no need to do other things until next tick"
v1.5.0-linux,move collision info from rendering engine to vehicle
v1.5.0-linux,update rotor poses
v1.5.0-linux,update private rotor variable
v1.5.0-linux,if we did reset then don't worry about synchronizing states for this tick
v1.5.0-linux,Continue to wait for reset
v1.5.0-linux,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.5.0-linux,*** Start: UpdatableState implementation ***//
v1.5.0-linux,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.5.0-linux,environment update for current position
v1.5.0-linux,update forces on vertices
v1.5.0-linux,update to controller must be done after kinematics have been updated by physics engine
v1.5.0-linux,*** End: UpdatableState implementation ***//
v1.5.0-linux,get references of existing camera
v1.5.0-linux,setup clock in PhysX
v1.5.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.5.0-linux,decide which derived BP to use
v1.5.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.5.0-linux,Setup suspension forces
v1.5.0-linux,Find the tire object and set the data for it
v1.5.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.5.0-linux,Setup suspension forces
v1.5.0-linux,Find the tire object and set the data for it
v1.5.0-linux,Create In-Car camera component
v1.5.0-linux,In car HUD
v1.5.0-linux,Create text render component for in car speed display
v1.5.0-linux,Create text render component for in car gear display
v1.5.0-linux,Setup the audio component and allocate it a sound cue
v1.5.0-linux,Colors for the in-car gear display. One for normal one for reverse
v1.5.0-linux,Wheels/Tires
v1.5.0-linux,Setup the wheels
v1.5.0-linux,Adjust the tire loading
v1.5.0-linux,Engine
v1.5.0-linux,Torque setup
v1.5.0-linux,Adjust the steering
v1.5.0-linux,Transmission
v1.5.0-linux,We want 4wd
v1.5.0-linux,Drive the front wheels a little more than the rear
v1.5.0-linux,Automatic gearbox
v1.5.0-linux,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.5.0-linux,Physics settings
v1.5.0-linux,Adjust the center of mass - the buggy is quite low
v1.5.0-linux,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.5.0-linux,put camera little bit above vehicle
v1.5.0-linux,update physics material
v1.5.0-linux,Update the strings used in the HUD (in-car and on-screen)
v1.5.0-linux,Set the string in the in-car HUD
v1.5.0-linux,Pass the engine RPM to the sound component
v1.5.0-linux,Start an engine sound playing
v1.5.0-linux,Using FText because this is display text that should be localizable
v1.5.0-linux,Setup the text render component strings
v1.5.0-linux,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.5.0-linux,below is not needed
v1.5.0-linux,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.5.0-linux,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.5.0-linux,TODO: should do reset() here?
v1.5.0-linux,create vehicle params
v1.5.0-linux,these are called on render ticks
v1.5.0-linux,TODO: do we need this for cars?
v1.5.0-linux,TODO: move this to SimModeBase?
v1.5.0-linux,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.5.0-linux,reset();
v1.5.0-linux,return;
v1.5.0-linux,}
v1.5.0-linux,Thrustmaster devices
v1.5.0-linux,"Anything else, typically Logitech G920 wheel"
v1.5.0-linux,Two steel levers behind wheel
v1.5.0-linux,if API-client control is not active then we route keyboard/joystick control to car
v1.5.0-linux,all car controls from anywhere must be routed through API component
v1.5.0-linux,*** Start: UpdatableState implementation ***//
v1.5.0-linux,physics tick
v1.5.0-linux,*** End: UpdatableState implementation ***//
v1.5.0-linux,TODO: directly accept getVehicleSimApis() using generic container
v1.5.0-linux,remove everything that we created in BeginPlay
v1.5.0-linux,we use custom debug reporting for this class
v1.5.0-linux,perform any expensive rendering update outside of lock region
v1.5.0-linux,no need to call base reset because of our custom implementation
v1.5.0-linux,TODO: this is going to cause circular references which is fine here but
v1.5.0-linux,in future we should consider moving SimMode not derived from AActor and move
v1.5.0-linux,it to AirLib and directly implement WorldSimApiBase interface
v1.5.0-linux,get player start
v1.5.0-linux,this must be done from within actor otherwise we don't get player start
v1.5.0-linux,Grab player location
v1.5.0-linux,Move the world origin to the player's location (this moves the coordinate system and adds
v1.5.0-linux,a corresponding offset to all positions to compensate for the shift)
v1.5.0-linux,"Regrab the player's position after the offset has been added (which should be 0,0,0 now)"
v1.5.0-linux,UWeatherLib::showWeatherMenu(World);
v1.5.0-linux,else don't init
v1.5.0-linux,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v1.5.0-linux,tod_sim_clock_start_ needs to be reset here.
v1.5.0-linux,Going from enabled to disabled
v1.5.0-linux,do these in the end to ensure that advanceTimeOfDay() doesn't see
v1.5.0-linux,any inconsistent state.
v1.5.0-linux,should be overridden by derived class
v1.5.0-linux,should be overridden by derived class
v1.5.0-linux,should be overriden by derived class
v1.5.0-linux,should be overridden by derived class
v1.5.0-linux,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.5.0-linux,default setup - this should be overridden in derived modes as needed
v1.5.0-linux,setup clock in ClockFactory
v1.5.0-linux,default implementation
v1.5.0-linux,create director
v1.5.0-linux,create external camera required for the director
v1.5.0-linux,API server start/stop
v1.5.0-linux,get UU origin of global NED frame
v1.5.0-linux,compute initial pose
v1.5.0-linux,spawn vehicle pawn
v1.5.0-linux,create vehicle sim api
v1.5.0-linux,TODO: Figure out a better way to add more fields
v1.5.0-linux,Maybe allow passing a JSON string for the vehicle settings?
v1.5.0-linux,"Retroactively adjust AirSimSettings, so it's like we knew about this vehicle all along"
v1.5.0-linux,"Usually physics registration happens at init, in ASimModeWorldBase::initializeForPlay(), but not in this case"
v1.5.0-linux,Can't be done before the vehicle apis have been created
v1.5.0-linux,get UU origin of global NED frame
v1.5.0-linux,determine camera director camera default pose and spawn it
v1.5.0-linux,find all vehicle pawns
v1.5.0-linux,add vehicles from settings
v1.5.0-linux,if vehicle is of type for derived SimMode and auto creatable
v1.5.0-linux,create API objects for each pawn we have
v1.5.0-linux,TODO: better handle no FPV vehicles scenario
v1.5.0-linux,derived class shoudl override this method to add new vehicle to the physics engine
v1.5.0-linux,derived class should override this method to retrieve types of pawns they support
v1.5.0-linux,derived class should override this method to retrieve types of pawns they support
v1.5.0-linux,derived class should override this method to retrieve types of pawns they support
v1.5.0-linux,derived class should override this method to retrieve types of pawns they support
v1.5.0-linux,derived class should override this method to retrieve types of pawns they support
v1.5.0-linux,derived class should override this method to retrieve types of pawns they support
v1.5.0-linux,derived class should override this method to retrieve types of pawns they support
v1.5.0-linux,Draws debug-points on main viewport for Lidar laser hits.
v1.5.0-linux,Used for debugging only.
v1.5.0-linux,Currently we are checking the sensor-collection instead of sensor-settings.
v1.5.0-linux,Also using variables to optimize not checking the collection if not needed.
v1.5.0-linux,TODO: Is it incorrect to assume LidarSimple here?
v1.5.0-linux,Draw debug-point on main viewport for Distance sensor hit
v1.5.0-linux,Find position of point hit
v1.5.0-linux,Similar to UnrealDistanceSensor.cpp#L19
v1.5.0-linux,order of Pose addition is important here because it also adds quaternions which is not commutative!
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,ctor
v1.5.0-linux,initializes information based on lidar configuration
v1.5.0-linux,calculate verticle angle distance between each laser
v1.5.0-linux,store vertical angles for each laser
v1.5.0-linux,returns a point-cloud for the tick
v1.5.0-linux,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.5.0-linux,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.5.0-linux,calculate number of points needed for each laser/channel
v1.5.0-linux,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.5.0-linux,calculate needed angle/distance between each point
v1.5.0-linux,normalize FOV start/end
v1.5.0-linux,shoot lasers
v1.5.0-linux,check if the laser is outside the requested horizontal FOV
v1.5.0-linux,"shoot laser and get the impact point, if any"
v1.5.0-linux,simulate shooting a laser via Unreal ray-tracing.
v1.5.0-linux,start position
v1.5.0-linux,We need to compose rotations here rather than rotate a vector by a quaternion
v1.5.0-linux,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.5.0-linux,get ray quaternion in lidar frame (angles must be in radians)
v1.5.0-linux,get ray quaternion in body frame
v1.5.0-linux,get ray quaternion in world frame
v1.5.0-linux,get ray vector (end position)
v1.5.0-linux,Store the segmentation id of the hit object.
v1.5.0-linux,Debug code for very specific cases.
v1.5.0-linux,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.5.0-linux,decide the frame for the point-cloud
v1.5.0-linux,current detault behavior; though it is probably not very useful.
v1.5.0-linux,not changing the default for now to maintain backwards-compat.
v1.5.0-linux,point in vehicle intertial frame
v1.5.0-linux,tranform to lidar frame
v1.5.0-linux,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.5.0-linux,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.5.0-linux,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.5.0-linux,"On the client side, if it is needed to transform this data back to the world frame,"
v1.5.0-linux,"then do the equivalent of following,"
v1.5.0-linux,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.5.0-linux,See SimModeBase::drawLidarDebugPoints()
v1.5.0-linux,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.5.0-linux,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,update ray tracing
v1.5.0-linux,"FString hit_name = FString(""None"");"
v1.5.0-linux,if (dist_hit.GetActor())
v1.5.0-linux,hit_name=dist_hit.GetActor()->GetName();
v1.5.0-linux,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.5.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,This assumes you are running DroneServer already on the same machine.
v1.5.0-linux,DroneServer must be running first.
v1.5.0-linux,enable API control
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,move commands
v1.5.0-linux,else leave as it is
v1.5.0-linux,TODO: get these in one call
v1.5.0-linux,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.5.0-linux,TODO: shouldn't we pass folder path?
v1.5.0-linux,parse
v1.5.0-linux,group the images by the current date.
v1.5.0-linux,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.5.0-linux,{
v1.5.0-linux,"return """";"
v1.5.0-linux,}
v1.5.0-linux,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.5.0-linux,{
v1.5.0-linux,return false;
v1.5.0-linux,}
v1.5.0-linux,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.5.0-linux,params.context->client.newTask();
v1.5.0-linux,}
v1.5.0-linux,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.5.0-linux,params.context->client.WaitForCompletion(0);
v1.5.0-linux,}
v1.5.0-linux,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.5.0-linux,{
v1.5.0-linux,}
v1.5.0-linux,parse command line
v1.5.0-linux,Shell callbacks
v1.5.0-linux,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.5.0-linux,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.5.0-linux,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.5.0-linux,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.5.0-linux,Add shell commands
v1.5.0-linux,TODO: add WaitForCompletion command
v1.5.0-linux,"TODO: add command line args help, arg count validation"
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v1.5.0-linux,switch to explicit hover mode so that this is the fall back when
v1.5.0-linux,move* commands are finished.
v1.5.0-linux,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.5.0-linux,TODO: implement weather for Unity
v1.5.0-linux,TODO: implement weather for Unity
v1.5.0-linux,----------------Plotting APIs-----------/
v1.5.0-linux,Recording APIs
v1.5.0-linux,Function pointers to hold the addresses of the functions that are defined in Unity
v1.5.0-linux,"Enabling all LogLevels,"
v1.5.0-linux,"Enabling all LogLevels,"
v1.5.0-linux,delete ltm;
v1.5.0-linux,initialize state
v1.5.0-linux,compute our home point
v1.5.0-linux,default behavior is to call update every tick
v1.5.0-linux,"for custom physics engine, this method should be overridden and update should be"
v1.5.0-linux,called from every physics tick
v1.5.0-linux,these will be available for devices like steering wheels
v1.5.0-linux,sync environment from kinematics
v1.5.0-linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.5.0-linux,FVector unrealPosition = getUUPosition();
v1.5.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v1.5.0-linux,not implemented
v1.5.0-linux,not implemented
v1.5.0-linux,parameters in NED frame
v1.5.0-linux,allow teleportation
v1.5.0-linux,if collisions are not enabled
v1.5.0-linux,or we have collided but passthrough is enabled
v1.5.0-linux,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.5.0-linux,"without flip flopping, collisions can't be detected"
v1.5.0-linux,by default we update kinematics from UE pawn
v1.5.0-linux,if SimMod uses its own physics engine then this should be overriden
v1.5.0-linux,no default action in this base class
v1.5.0-linux,TODO: because this bug we are using alternative code with stringstream
v1.5.0-linux,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.5.0-linux,update kinematics from pawn's movement instead of physics engine
v1.5.0-linux,TODO: update other fields?
v1.5.0-linux,implements getImages() method in the ImageCaptureBase class.
v1.5.0-linux,update ray tracing
v1.5.0-linux,TODO: index check
v1.5.0-linux,Attempts to parse the settings text from one of multiple locations.
v1.5.0-linux,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.5.0-linux,"Next, check the executable's working directory for the settings file."
v1.5.0-linux,"Finally, check the user's documents folder."
v1.5.0-linux,"If the settings file cannot be read, throw an exception"
v1.5.0-linux,let base class setup physics world
v1.5.0-linux,stop physics thread before we dismantle
v1.5.0-linux,setup clock in ClockFactory
v1.5.0-linux,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.5.0-linux,steppable clock returns interval that is a constant number irrespective of wall clock
v1.5.0-linux,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.5.0-linux,but that would cause vehicles like quadrotors to become unstable
v1.5.0-linux,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.5.0-linux,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.5.0-linux,get increase in clock speed
v1.5.0-linux,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.5.0-linux,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.5.0-linux,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.5.0-linux,Approach 2: scale control loop frequency if clock is speeded up
v1.5.0-linux,"for slowing down, this don't generate instability"
v1.5.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.5.0-linux,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.5.0-linux,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.5.0-linux,create vehicle API
v1.5.0-linux,setup physics vehicle
v1.5.0-linux,initialize private vars
v1.5.0-linux,"if reset is pending then do it first, no need to do other things until next tick"
v1.5.0-linux,move collision info from rendering engine to vehicle
v1.5.0-linux,update rotor poses
v1.5.0-linux,if we did reset then don't worry about synchronizing states for this tick
v1.5.0-linux,Continue to wait for reset
v1.5.0-linux,*** Start: UpdatableState implementation ***//
v1.5.0-linux,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.5.0-linux,environment update for current position
v1.5.0-linux,update forces on vertices
v1.5.0-linux,update to controller must be done after kinematics have been updated by physics engine
v1.5.0-linux,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.5.0-linux,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.5.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.5.0-linux,*** End: UpdatableState implementation ***//
v1.5.0-linux,TODO: should do reset() here?
v1.5.0-linux,these are called on render ticks
v1.5.0-linux,TODO: do we need this for cars?
v1.5.0-linux,Thrustmaster devices
v1.5.0-linux,"Anything else, typically Logitech G920 wheel"
v1.5.0-linux,Two steel levers behind wheel
v1.5.0-linux,if API-client control is not active then we route keyboard/joystick control to car
v1.5.0-linux,all car controls from anywhere must be routed through API component
v1.5.0-linux,*** Start: UpdatableState implementation ***//
v1.5.0-linux,physics tick
v1.5.0-linux,void CarPawnSimApi::reportState(StateReporter& reporter)
v1.5.0-linux,{
v1.5.0-linux,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.5.0-linux,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.5.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.5.0-linux,}
v1.5.0-linux,*** End: UpdatableState implementation ***//
v1.5.0-linux,remove everything that we created in BeginPlay
v1.5.0-linux,we use custom debug reporting for this class
v1.5.0-linux,perform any expensive rendering update outside of lock region
v1.5.0-linux,no need to call base reset because of our custom implementation
v1.5.0-linux,should be overridden by derived class
v1.5.0-linux,should be overridden by derived class
v1.5.0-linux,should be overridden by derived class
v1.5.0-linux,commenting this out for now to avoid unintentional Unity startup failure
v1.5.0-linux,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v1.5.0-linux,should be overridden by derived class
v1.5.0-linux,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.5.0-linux,default setup - this should be overridden in derived modes as needed
v1.5.0-linux,setup clock in ClockFactory
v1.5.0-linux,API server start/stop
v1.5.0-linux,determine camera director camera default pose and spawn it
v1.5.0-linux,derived class should override this method to retrieve types of pawns they support
v1.5.0-linux,derived class should override this method to retrieve types of pawns they support
v1.5.0-linux,60 acres park:
v1.5.0-linux,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.5.0-linux,marymoore park
v1.5.0-linux,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.5.0-linux,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.5.0-linux,DepthNavThreshold depthNav;
v1.5.0-linux,DepthNavOptAStar depthNav;
v1.5.0-linux,DepthNavThreshold depthNav;
v1.5.0-linux,DepthNavOptAStar depthNav;
v1.5.0-linux,Cleanup
v1.5.0-linux,runDepthNavGT();
v1.5.0-linux,runDepthNavSGM();
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,by Sudipta Sinha
v1.5.0-linux,adapted for AirSim by Matthias Mueller
v1.5.0-linux,first row
v1.5.0-linux,last row
v1.5.0-linux,Local quadratic fit of cost and subpixel refinement.
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,by Sudipta Sinha
v1.5.0-linux,adapted for AirSim by Matthias Mueller
v1.5.0-linux,uint64_t x64 = (uint64_t)x;
v1.5.0-linux,uint64_t y64 = (uint64_t)y;
v1.5.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.5.0-linux,Licensed under the MIT License.
v1.5.0-linux,by Sudipta Sinha
v1.5.0-linux,adapted for AirSim by Matthias Mueller
v1.5.0-linux,ensure that disparity range is a multiple of 8
v1.5.0-linux,sgm stereo
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,read settings and override defaults
v1.4.0-windows,allow json overrides on a per-vehicle basis.
v1.4.0-windows,start server in async mode
v1.4.0-windows,check messages
v1.4.0-windows,plot red arrows for 30 seconds
v1.4.0-windows,plot magenta arrows for 15 seconds
v1.4.0-windows,plot red arrows for 10 seconds
v1.4.0-windows,plot 2 white arrows which are persistent
v1.4.0-windows,plot points
v1.4.0-windows,"plot line strip. 0-1, 1-2, 2-3"
v1.4.0-windows,"plot line list. 0-1, 2-3, 4-5. Must be even."
v1.4.0-windows,plot transforms
v1.4.0-windows,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=0.0, yaw=yaw)) for x, y, yaw in zip(np.linspace(0,10,10), np.linspace(0,0,10), np.linspace(0,np.pi,10))],"
v1.4.0-windows,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.4.0-windows,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=roll, yaw=0.0)) for x, y, roll in zip(np.linspace(0,10,10), np.linspace(1,1,10), np.linspace(0,np.pi,10))],"
v1.4.0-windows,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.4.0-windows,In settings.json first activate computer vision mode:
v1.4.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.4.0-windows,monitor car state while you drive it manually.
v1.4.0-windows,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v1.4.0-windows,denominator from microns^3 to microns * m^2)
v1.4.0-windows,First set everything to 0.
v1.4.0-windows,Next set all objects of interest provided to corresponding object IDs
v1.4.0-windows,segIdDict values MUST match tempEmissivityNew labels.
v1.4.0-windows,"Connect to AirSim, UAV mode."
v1.4.0-windows,Choose temperature values for winter or summer.
v1.4.0-windows,""""""""
v1.4.0-windows,winter
v1.4.0-windows,""""""""
v1.4.0-windows,summer
v1.4.0-windows,Read camera response.
v1.4.0-windows,Calculate radiance.
v1.4.0-windows,Set IDs in AirSim environment.
v1.4.0-windows,In settings.json first activate computer vision mode:
v1.4.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.4.0-windows,"define abstract class to return next vector in the format (x,y,yaw)"
v1.4.0-windows,"compute vector, distance and angle to goal"
v1.4.0-windows,compute box of interest
v1.4.0-windows,scale by weight matrix (optional)
v1.4.0-windows,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.4.0-windows,detect collision
v1.4.0-windows,compute box of interest
v1.4.0-windows,detect collision
v1.4.0-windows,Same as above but decide to go left or right based on average or some metric like that
v1.4.0-windows,"compute resultant normalized vector, distance and angle"
v1.4.0-windows,compute bounding box size
v1.4.0-windows,convert horizonal fov to vertical fov
v1.4.0-windows,matrix with all ones
v1.4.0-windows,matrix with max weight in center and decreasing linearly with distance from center
v1.4.0-windows,matrix with max weight in center and decreasing quadratically with distance from center
v1.4.0-windows,"print (""Saving images to %s"" % tmp_dir)"
v1.4.0-windows,airsim.wait_key('Press any key to start')
v1.4.0-windows,"Define start position, goal and size of UAV"
v1.4.0-windows,Define parameters and thresholds
v1.4.0-windows,initial position
v1.4.0-windows,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.4.0-windows,time.sleep(1)
v1.4.0-windows,get response
v1.4.0-windows,get numpy array
v1.4.0-windows,reshape array to 2D array H X W
v1.4.0-windows,write to png
v1.4.0-windows,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.4.0-windows,pose = client.simGetPose()
v1.4.0-windows,pp.pprint(pose)
v1.4.0-windows,time.sleep(5)
v1.4.0-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.4.0-windows,################### OLD CODE
v1.4.0-windows,timer = 0
v1.4.0-windows,time_obs = 50
v1.4.0-windows,bObstacle = False
v1.4.0-windows,if (bObstacle):
v1.4.0-windows,timer = timer + 1
v1.4.0-windows,if timer > time_obs:
v1.4.0-windows,bObstacle = False
v1.4.0-windows,timer = 0
v1.4.0-windows,else:
v1.4.0-windows,yaw = target_angle
v1.4.0-windows,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.4.0-windows,if (np.average(img2d_box) < coll_thres):
v1.4.0-windows,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.4.0-windows,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.4.0-windows,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.4.0-windows,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.4.0-windows,"print('left: ', img2d_box_l_avg)"
v1.4.0-windows,"print('right: ', img2d_box_r_avg)"
v1.4.0-windows,if img2d_box_l_avg > img2d_box_r_avg:
v1.4.0-windows,##Go LEFT
v1.4.0-windows,#y_offset = y_offset-1
v1.4.0-windows,yaw = yaw - radians(10)
v1.4.0-windows,bObstacle = True
v1.4.0-windows,else:
v1.4.0-windows,##Go RIGHT
v1.4.0-windows,#y_offset = y_offset+1
v1.4.0-windows,yaw = yaw + radians(10)
v1.4.0-windows,bObstacle = true
v1.4.0-windows,"print('yaw: ', yaw)"
v1.4.0-windows,In settings.json first activate computer vision mode:
v1.4.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.4.0-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.4.0-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.4.0-windows,pip install opencv-python
v1.4.0-windows,In settings.json first activate computer vision mode:
v1.4.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.4.0-windows,In settings.json first activate computer vision mode:
v1.4.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.4.0-windows,for block environment
v1.4.0-windows,regex are case insensitive
v1.4.0-windows,#for neighborhood environment
v1.4.0-windows,set object ID for sky
v1.4.0-windows,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.4.0-windows,get segmentation image in various formats
v1.4.0-windows,save segmentation images in various formats
v1.4.0-windows,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.4.0-windows,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.4.0-windows,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v1.4.0-windows,find unique colors
v1.4.0-windows,In settings.json first activate computer vision mode:
v1.4.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.4.0-windows,objects can be named in two ways:
v1.4.0-windows,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.4.0-windows,default name is auto-generated and varies from run-to-run.
v1.4.0-windows,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.4.0-windows,
v1.4.0-windows,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.4.0-windows,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.4.0-windows,https://answers.unrealengine.com/revisions/790629.html
v1.4.0-windows,below works in Blocks environment
v1.4.0-windows,------------------------------------ Get current pose ------------------------------------------------
v1.4.0-windows,search object by name:
v1.4.0-windows,search another object by tag
v1.4.0-windows,search non-existent object
v1.4.0-windows,------------------------------------ Set new pose ------------------------------------------------
v1.4.0-windows,here we move with teleport enabled so collisions are ignored
v1.4.0-windows,here we move with teleport enabled so collisions are not ignored
v1.4.0-windows,move non-existent object
v1.4.0-windows,------------------------------------ Get new pose ------------------------------------------------
v1.4.0-windows,search another object by tag
v1.4.0-windows,search non-existent object
v1.4.0-windows,Import this module to automatically setup path to local airsim module
v1.4.0-windows,This module first tries to see if airsim module is installed via pip
v1.4.0-windows,If it does then we don't do anything else
v1.4.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.4.0-windows,and if it does then we add that in sys.path
v1.4.0-windows,this class simply tries to see if airsim
v1.4.0-windows,if airsim module is installed then don't do anything else
v1.4.0-windows,import pkgutil
v1.4.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.4.0-windows,if airsim_loader is not None:
v1.4.0-windows,return
v1.4.0-windows,"Roll is applied first, then pitch, then yaw."
v1.4.0-windows,Turn the camera position into a column vector.
v1.4.0-windows,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v1.4.0-windows,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v1.4.0-windows,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v1.4.0-windows,Recreate the perspective projection of the camera.
v1.4.0-windows,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v1.4.0-windows,Set pose and sleep after to ensure the pose sticks before capturing image.
v1.4.0-windows,Capture segmentation (IR) and scene images.
v1.4.0-windows,Change images into numpy arrays.
v1.4.0-windows,Capture images for a certain amount of time in seconds (half hour now)
v1.4.0-windows,Capture image - pose.position x_val access may change w/ AirSim
v1.4.0-windows,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v1.4.0-windows,Convert color scene image to BGR for write out with cv2.
v1.4.0-windows,"Connect to AirSim, UAV mode."
v1.4.0-windows,Look for objects with names that match a regular expression.
v1.4.0-windows,"Sample calls to main, varying camera angle and altitude."
v1.4.0-windows,"straight down, 400ft"
v1.4.0-windows,"straight down, 200ft"
v1.4.0-windows,"45 degrees, 200ft -- note that often object won't be scene since position"
v1.4.0-windows,is set exactly to object's
v1.4.0-windows,"45 degrees, 400ft -- note that often object won't be scene since position"
v1.4.0-windows,is set exactly to object's
v1.4.0-windows,In settings.json first activate computer vision mode:
v1.4.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.4.0-windows,xn = 1 + x*5  # some random number
v1.4.0-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,monitor car state while you drive it manually.
v1.4.0-windows,get state of the car
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,go forward
v1.4.0-windows,get state of the car
v1.4.0-windows,Python client example to change time-of-day using APIs
v1.4.0-windows,
v1.4.0-windows,Changes time of the day and makes the car move around
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,flip between specific time and default time
v1.4.0-windows,go forward
v1.4.0-windows,Go forward + steer right
v1.4.0-windows,main
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,get state of the car
v1.4.0-windows,go forward
v1.4.0-windows,Go forward + steer right
v1.4.0-windows,go reverse
v1.4.0-windows,apply brakes
v1.4.0-windows,get camera images from the car
v1.4.0-windows,restore to original state
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,go forward
v1.4.0-windows,Python client example to get Lidar data from a car
v1.4.0-windows,
v1.4.0-windows,Makes the drone fly and get Lidar data
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,"print(""state: %s"" % s)"
v1.4.0-windows,go forward
v1.4.0-windows,Go forward + steer right
v1.4.0-windows,"reshape array of floats to array of [X,Y,Z]"
v1.4.0-windows,TODO
v1.4.0-windows,main
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,get state of the car
v1.4.0-windows,go forward
v1.4.0-windows,Go forward + steer right
v1.4.0-windows,go reverse
v1.4.0-windows,apply breaks
v1.4.0-windows,restore to original state
v1.4.0-windows,Import this module to automatically setup path to local airsim module
v1.4.0-windows,This module first tries to see if airsim module is installed via pip
v1.4.0-windows,If it does then we don't do anything else
v1.4.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.4.0-windows,and if it does then we add that in sys.path
v1.4.0-windows,this class simply tries to see if airsim
v1.4.0-windows,if airsim module is installed then don't do anything else
v1.4.0-windows,import pkgutil
v1.4.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.4.0-windows,if airsim_loader is not None:
v1.4.0-windows,return
v1.4.0-windows,Use below in settings.json with blocks environment
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,get state of the car
v1.4.0-windows,go forward
v1.4.0-windows,go reverse
v1.4.0-windows,apply breaks
v1.4.0-windows,get camera images from the car
v1.4.0-windows,restore to original state
v1.4.0-windows,from keras.models import load_model
v1.4.0-windows,if (len(sys.argv) != 2):
v1.4.0-windows,print('usage: python drive.py <modelName>')
v1.4.0-windows,sys.exit()
v1.4.0-windows,print('Loading model...')
v1.4.0-windows,model = load_model(sys.argv[1])
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.4.0-windows,"model_output = model.predict([image_buf, state_buf])"
v1.4.0-windows,car_controls.steering = float(model_output[0][0])
v1.4.0-windows,-*- coding: utf-8 -*-
v1.4.0-windows,
v1.4.0-windows,Configuration file for the Sphinx documentation builder.
v1.4.0-windows,
v1.4.0-windows,This file does only contain a selection of the most common options. For a
v1.4.0-windows,full list see the documentation:
v1.4.0-windows,http://www.sphinx-doc.org/en/master/config
v1.4.0-windows,-- Path setup --------------------------------------------------------------
v1.4.0-windows,"If extensions (or modules to document with autodoc) are in another directory,"
v1.4.0-windows,add these directories to sys.path here. If the directory is relative to the
v1.4.0-windows,"documentation root, use os.path.abspath to make it absolute, like shown here."
v1.4.0-windows,
v1.4.0-windows,-- Project information -----------------------------------------------------
v1.4.0-windows,The short X.Y version
v1.4.0-windows,"The full version, including alpha/beta/rc tags"
v1.4.0-windows,-- General configuration ---------------------------------------------------
v1.4.0-windows,"If your documentation needs a minimal Sphinx version, state it here."
v1.4.0-windows,
v1.4.0-windows,needs_sphinx = '1.0'
v1.4.0-windows,"Add any Sphinx extension module names here, as strings. They can be"
v1.4.0-windows,extensions coming with Sphinx (named 'sphinx.ext.*') or your custom
v1.4.0-windows,ones.
v1.4.0-windows,"Add any paths that contain templates here, relative to this directory."
v1.4.0-windows,The suffix(es) of source filenames.
v1.4.0-windows,You can specify multiple suffix as a list of string:
v1.4.0-windows,
v1.4.0-windows,"source_suffix = ['.rst', '.md']"
v1.4.0-windows,The master toctree document.
v1.4.0-windows,The language for content autogenerated by Sphinx. Refer to documentation
v1.4.0-windows,for a list of supported languages.
v1.4.0-windows,
v1.4.0-windows,This is also used if you do content translation via gettext catalogs.
v1.4.0-windows,"Usually you set ""language"" from the command line for these cases."
v1.4.0-windows,"List of patterns, relative to source directory, that match files and"
v1.4.0-windows,directories to ignore when looking for source files.
v1.4.0-windows,This pattern also affects html_static_path and html_extra_path.
v1.4.0-windows,The name of the Pygments (syntax highlighting) style to use.
v1.4.0-windows,-- Options for HTML output -------------------------------------------------
v1.4.0-windows,The theme to use for HTML and HTML Help pages.  See the documentation for
v1.4.0-windows,a list of builtin themes.
v1.4.0-windows,
v1.4.0-windows,html_theme = 'alabaster'
v1.4.0-windows,Theme options are theme-specific and customize the look and feel of a theme
v1.4.0-windows,"further.  For a list of options available for each theme, see the"
v1.4.0-windows,documentation.
v1.4.0-windows,
v1.4.0-windows,html_theme_options = {}
v1.4.0-windows,"Add any paths that contain custom static files (such as style sheets) here,"
v1.4.0-windows,"relative to this directory. They are copied after the builtin static files,"
v1.4.0-windows,"so a file named ""default.css"" will overwrite the builtin ""default.css""."
v1.4.0-windows,"Custom sidebar templates, must be a dictionary that maps document names"
v1.4.0-windows,to template names.
v1.4.0-windows,
v1.4.0-windows,The default sidebars (for documents that don't match any pattern) are
v1.4.0-windows,defined by theme itself.  Builtin themes are using these templates by
v1.4.0-windows,"default: ``['localtoc.html', 'relations.html', 'sourcelink.html',"
v1.4.0-windows,'searchbox.html']``.
v1.4.0-windows,
v1.4.0-windows,html_sidebars = {}
v1.4.0-windows,-- Options for HTMLHelp output ---------------------------------------------
v1.4.0-windows,Output file base name for HTML help builder.
v1.4.0-windows,-- Options for LaTeX output ------------------------------------------------
v1.4.0-windows,The paper size ('letterpaper' or 'a4paper').
v1.4.0-windows,
v1.4.0-windows,"'papersize': 'letterpaper',"
v1.4.0-windows,"The font size ('10pt', '11pt' or '12pt')."
v1.4.0-windows,
v1.4.0-windows,"'pointsize': '10pt',"
v1.4.0-windows,Additional stuff for the LaTeX preamble.
v1.4.0-windows,
v1.4.0-windows,"'preamble': '',"
v1.4.0-windows,Latex figure (float) alignment
v1.4.0-windows,
v1.4.0-windows,"'figure_align': 'htbp',"
v1.4.0-windows,Grouping the document tree into LaTeX files. List of tuples
v1.4.0-windows,"(source start file, target name, title,"
v1.4.0-windows,"author, documentclass [howto, manual, or own class])."
v1.4.0-windows,-- Options for manual page output ------------------------------------------
v1.4.0-windows,One entry per manual page. List of tuples
v1.4.0-windows,"(source start file, name, description, authors, manual section)."
v1.4.0-windows,-- Options for Texinfo output ----------------------------------------------
v1.4.0-windows,Grouping the document tree into Texinfo files. List of tuples
v1.4.0-windows,"(source start file, target name, title, author,"
v1.4.0-windows,"dir menu entry, description, category)"
v1.4.0-windows,-- Options for Epub output -------------------------------------------------
v1.4.0-windows,Bibliographic Dublin Core info.
v1.4.0-windows,The unique identifier of the text. This can be a ISBN number
v1.4.0-windows,or the project homepage.
v1.4.0-windows,
v1.4.0-windows,epub_identifier = ''
v1.4.0-windows,A unique identification for the text.
v1.4.0-windows,
v1.4.0-windows,epub_uid = ''
v1.4.0-windows,A list of files that should not be packed into the epub file.
v1.4.0-windows,-- Extension configuration -------------------------------------------------
v1.4.0-windows,-- Options for intersphinx extension ---------------------------------------
v1.4.0-windows,Example configuration for intersphinx: refer to the Python standard library.
v1.4.0-windows,-- Options for todo extension ----------------------------------------------
v1.4.0-windows,"If true, `todo` and `todoList` produce output, else they produce nothing."
v1.4.0-windows,We ignore the 2D nature of the problem as it is not relevant here
v1.4.0-windows,It makes multi-core processing more straightforward
v1.4.0-windows,Allocations
v1.4.0-windows,Add small number to avoid issues with log(I)
v1.4.0-windows,Event sim keeps track of previous image automatically
v1.4.0-windows,"Using pickle dump in a per-frame fashion to save time, instead of savetxt"
v1.4.0-windows,Optimizations possible
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,MultirotorClient.wait_key('Press any key to takeoff')
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,get camera images from the car
v1.4.0-windows,that's enough fun for now. let's quit cleanly
v1.4.0-windows,teleport the drone + 10 meters in x-direction
v1.4.0-windows,teleport the drone back
v1.4.0-windows,use open cv to create point cloud from depth image.
v1.4.0-windows,###########################################
v1.4.0-windows,######### This is work in progress! #######
v1.4.0-windows,###########################################
v1.4.0-windows,file will be saved in PythonClient folder (i.e. same folder as script)
v1.4.0-windows,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.4.0-windows,skip it
v1.4.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.4.0-windows,z of -7 is 7 meters above the original launch point.
v1.4.0-windows,Fly given velocity vector for 5 seconds
v1.4.0-windows,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.4.0-windows,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.4.0-windows,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.4.0-windows,Make the drone fly in a circle.
v1.4.0-windows,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.4.0-windows,check that our home position is stable
v1.4.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.4.0-windows,ramp up time
v1.4.0-windows,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.4.0-windows,compute current angle
v1.4.0-windows,compute lookahead
v1.4.0-windows,if we did the takeoff then also do the landing.
v1.4.0-windows,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.4.0-windows,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.4.0-windows,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.4.0-windows,ignore the click over from 360 back to 0
v1.4.0-windows,watch direction this diff is moving if it switches from shrinking to growing
v1.4.0-windows,then we passed the starting point.
v1.4.0-windows,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.4.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.4.0-windows,z of -7 is 7 meters above the original launch point.
v1.4.0-windows,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.4.0-windows,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.4.0-windows,drone will over-shoot so we bring it back to the start point before landing.
v1.4.0-windows,Run this script with clock speed in settings.json
v1.4.0-windows,"""ClockSpeed"": 1 then change it to 0.5"
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,with ClockSpeed = 0.5 you will see that this takes 6s (system time) and not 3s
v1.4.0-windows,with ClockSpeed = 0.5 you will see that this takes 10s (system time)
v1.4.0-windows,and not 5s in each iteration
v1.4.0-windows,that's enough fun for now. let's quit cleanly
v1.4.0-windows,Takeoff or hover
v1.4.0-windows,Set wind to 0
v1.4.0-windows,In settings.json first activate computer vision mode:
v1.4.0-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.4.0-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.4.0-windows,pip install opencv-python
v1.4.0-windows,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.4.0-windows,Python client example to get Lidar data from a drone
v1.4.0-windows,
v1.4.0-windows,Makes the drone fly and get Lidar data
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,"print(""state: %s"" % s)"
v1.4.0-windows,"print(""state: %s"" % pprint.pformat(state))"
v1.4.0-windows,"reshape array of floats to array of [X,Y,Z]"
v1.4.0-windows,TODO
v1.4.0-windows,main
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,AirSim uses NED coordinates so negative axis is up.
v1.4.0-windows,let it settle there a bit.
v1.4.0-windows,after hovering we need to re-enabled api control for next leg of the trip
v1.4.0-windows,now compute the survey path required to fill the box
v1.4.0-windows,"Please add ""EnableTrace"": true to your setting.json as shown below"
v1.4.0-windows,{
v1.4.0-windows,"""SettingsVersion"": 1.2,"
v1.4.0-windows,"""SimMode"": ""Multirotor"","
v1.4.0-windows,"""Vehicles"": {"
v1.4.0-windows,"""Drone"": {"
v1.4.0-windows,"""VehicleType"": ""SimpleFlight"","
v1.4.0-windows,"""EnableTrace"": true"
v1.4.0-windows,}
v1.4.0-windows,}
v1.4.0-windows,}
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,Use below in settings.json with Blocks environment
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,get camera images from the car
v1.4.0-windows,that's enough fun for now. let's quit cleanly
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,Import this module to automatically setup path to local airsim module
v1.4.0-windows,This module first tries to see if airsim module is installed via pip
v1.4.0-windows,If it does then we don't do anything else
v1.4.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.4.0-windows,and if it does then we add that in sys.path
v1.4.0-windows,this class simply tries to see if airsim
v1.4.0-windows,if airsim module is installed then don't do anything else
v1.4.0-windows,import pkgutil
v1.4.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.4.0-windows,if airsim_loader is not None:
v1.4.0-windows,return
v1.4.0-windows,"this script moves the drone to a location, then rests it thousands of time"
v1.4.0-windows,purpose of this script is to stress test reset API
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,that's enough fun for now. let's quite cleanly
v1.4.0-windows,use open cv to show new images from AirSim
v1.4.0-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.4.0-windows,pip install opencv-python
v1.4.0-windows,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.4.0-windows,get depth image
v1.4.0-windows,"this will return png width= 256, height= 144"
v1.4.0-windows,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.4.0-windows,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.4.0-windows,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.4.0-windows,to get an estimate of distance.
v1.4.0-windows,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.4.0-windows,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.4.0-windows,an angular delta of the following pi/10.
v1.4.0-windows,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.4.0-windows,Remove alpha channel if exists
v1.4.0-windows,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.4.0-windows,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.4.0-windows,Flatten and yield as tuple
v1.4.0-windows,Initialize a resizable dataset to hold the output
v1.4.0-windows,Resize the dataset to accommodate the next chunk of rows
v1.4.0-windows,Create the next chunk
v1.4.0-windows,Increment the row count
v1.4.0-windows,Arguments
v1.4.0-windows,Returns
v1.4.0-windows,use composition of homographies
v1.4.0-windows,to generate final transform that needs to be applied
v1.4.0-windows,Arguments
v1.4.0-windows,Returns
v1.4.0-windows,Keeps under lock only the mechanism which advances
v1.4.0-windows,the indexing of each batch.
v1.4.0-windows,The transformation of images is not under thread lock
v1.4.0-windows,so it can be done in parallel
v1.4.0-windows,Trained model path
v1.4.0-windows,Connect to AirSim
v1.4.0-windows,Start driving
v1.4.0-windows,Initialize image buffer
v1.4.0-windows,Update throttle value according to steering angle
v1.4.0-windows,Prediction
v1.4.0-windows,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.4.0-windows,Print progress
v1.4.0-windows,Update next car state
v1.4.0-windows,Wait a bit between iterations
v1.4.0-windows,%matplotlib inline
v1.4.0-windows,chunk size for training batches
v1.4.0-windows,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.4.0-windows,Point this to the directory containing the raw data
v1.4.0-windows,Point this to the desired output directory for the cooked (.h5) data
v1.4.0-windows,Choose The folders to search for data under RAW_DATA_DIR
v1.4.0-windows,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.4.0-windows,data_folder.append('folder_name1')
v1.4.0-windows,data_folder.append('folder_name2')
v1.4.0-windows,...
v1.4.0-windows,Hyper-parameters
v1.4.0-windows,Activation functions
v1.4.0-windows,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.4.0-windows,<< The directory containing the cooked data from the previous step >>
v1.4.0-windows,<< The directory in which the model output will be placed >>
v1.4.0-windows,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.4.0-windows,Network definition
v1.4.0-windows,Import this module to automatically setup path to local airsim module
v1.4.0-windows,This module first tries to see if airsim module is installed via pip
v1.4.0-windows,If it does then we don't do anything else
v1.4.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.4.0-windows,and if it does then we add that in sys.path
v1.4.0-windows,this class simply tries to see if airsim
v1.4.0-windows,if airsim module is installed then don't do anything else
v1.4.0-windows,import pkgutil
v1.4.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.4.0-windows,if airsim_loader is not None:
v1.4.0-windows,return
v1.4.0-windows,DEY: I don't know why this was there.
v1.4.0-windows,-----------------------------------  Common vehicle APIs ---------------------------------------------
v1.4.0-windows,basic flight control
v1.4.0-windows,time-of-day control
v1.4.0-windows,weather
v1.4.0-windows,camera control
v1.4.0-windows,simGetImage returns compressed png in array of bytes
v1.4.0-windows,image_type uses one of the ImageType members
v1.4.0-windows,"todo: in future remove below, it's only for compatibility to pre v1.2"
v1.4.0-windows,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.4.0-windows,camera control
v1.4.0-windows,simGetImage returns compressed png in array of bytes
v1.4.0-windows,image_type uses one of the ImageType members
v1.4.0-windows,gets the static meshes in the unreal scene
v1.4.0-windows,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.4.0-windows,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.4.0-windows,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.4.0-windows,sensor APIs
v1.4.0-windows,Plotting APIs
v1.4.0-windows,Recording APIs
v1.4.0-windows,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.4.0-windows,APIs for control
v1.4.0-windows,low-level control API
v1.4.0-windows,query vehicle state
v1.4.0-windows,-----------------------------------  Car APIs ---------------------------------------------
v1.4.0-windows,helper method for converting getOrientation to roll/pitch/yaw
v1.4.0-windows,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.4.0-windows,roll (x-axis rotation)
v1.4.0-windows,pitch (y-axis rotation)
v1.4.0-windows,yaw (z-axis rotation)
v1.4.0-windows,DEY: I don't know why this was there.
v1.4.0-windows,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.4.0-windows,return cls(**msgpack.unpack(encoded))
v1.4.0-windows,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.4.0-windows,Create a DummyVecEnv for main airsim gym env
v1.4.0-windows,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.4.0-windows,Initialize RL algorithm type and parameters
v1.4.0-windows,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.4.0-windows,Train for a certain number of timesteps
v1.4.0-windows,Save policy weights
v1.4.0-windows,Create a DummyVecEnv for main airsim gym env
v1.4.0-windows,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.4.0-windows,Initialize RL algorithm type and parameters
v1.4.0-windows,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.4.0-windows,Train for a certain number of timesteps
v1.4.0-windows,Save policy weights
v1.4.0-windows,Import this module to automatically setup path to local airsim module
v1.4.0-windows,This module first tries to see if airsim module is installed via pip
v1.4.0-windows,If it does then we don't do anything else
v1.4.0-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.4.0-windows,and if it does then we add that in sys.path
v1.4.0-windows,this class simply tries to see if airsim
v1.4.0-windows,if airsim module is installed then don't do anything else
v1.4.0-windows,import pkgutil
v1.4.0-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.4.0-windows,if airsim_loader is not None:
v1.4.0-windows,return
v1.4.0-windows,Set home position and velocity
v1.4.0-windows,print(dist)
v1.4.0-windows,"in header only mode, control library is not available"
v1.4.0-windows,if using Unreal Build system then include precompiled header file first
v1.4.0-windows,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.4.0-windows,"Windows, OSX and Linux."
v1.4.0-windows,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.4.0-windows,Windows users can move the Documents folder to any location they want
v1.4.0-windows,SHGetFolderPath knows how to find it.
v1.4.0-windows,fall back in case SHGetFolderPath failed for some reason.
v1.4.0-windows,convert from std::path '/' to windows backslash.
v1.4.0-windows,make the current thread run with maximum priority.
v1.4.0-windows,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.4.0-windows,TODO: How to handle POSIX thread priorities on OSX?
v1.4.0-windows,setThreadName is a helper function that is useful when debugging because your threads
v1.4.0-windows,show up in the debugger with the name you set which makes it easier to find the threads
v1.4.0-windows,that you are interested in.
v1.4.0-windows,"unfortunately this is only available on Windows 10, and AirSim is not limited to that."
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.4.0-windows,
v1.4.0-windows,Treat all errors as failure conditions.
v1.4.0-windows,parse command line
v1.4.0-windows,"motive gives a weird error if the project is not found, so we look for it."
v1.4.0-windows,Do an update to pick up any recently-arrived cameras.
v1.4.0-windows,List all detected cameras.
v1.4.0-windows,List all defined rigid bodies.
v1.4.0-windows,throttle to 50 messages per second.
v1.4.0-windows,OptiTrack uses 'y' axis for vertical.
v1.4.0-windows,stdafx.cpp : source file that includes just the standard includes
v1.4.0-windows,MavlinkMoCap.pch will be the pre-compiled header
v1.4.0-windows,stdafx.obj will contain the pre-compiled type information
v1.4.0-windows,TODO: reference any additional headers you need in STDAFX.H
v1.4.0-windows,and not in this file
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,PX4.cpp : Defines the entry point for the console application.
v1.4.0-windows,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.4.0-windows,how do you write to the debug output windows on Unix ?
v1.4.0-windows,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.4.0-windows,connection to create to talke to that server.
v1.4.0-windows,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.4.0-windows,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.4.0-windows,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.4.0-windows,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.4.0-windows,using their the -qgc option.
v1.4.0-windows,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.4.0-windows,this switch controls whether we turn off the RC remote active link loss detection
v1.4.0-windows,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.4.0-windows,from kicking in when you try and fly.
v1.4.0-windows,parse the json
v1.4.0-windows,flatten inner mavlink object
v1.4.0-windows,flatten inner mavlink object
v1.4.0-windows,todo
v1.4.0-windows,todo
v1.4.0-windows,"const char* outLogFileOption = ""outlogfile"";"
v1.4.0-windows,parse command line
v1.4.0-windows,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.4.0-windows,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.4.0-windows,"no local serial connection, so this is the primary droneConnection."
v1.4.0-windows,failed to connect
v1.4.0-windows,"local connection, then we own sending the heartbeat."
v1.4.0-windows,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.4.0-windows,cmdTable.push_back(new AltHoldCommand());
v1.4.0-windows,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.4.0-windows,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.4.0-windows,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.4.0-windows,this stops us from being able to connect to SITL mode PX4.
v1.4.0-windows,checkPulse();
v1.4.0-windows,add command text in log
v1.4.0-windows,close previous command.
v1.4.0-windows,FilterLogFiles(logDirectory);
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,send a heartbeat
v1.4.0-windows,accept one incoming connection
v1.4.0-windows,send a heartbeat to the client
v1.4.0-windows,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.4.0-windows,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.4.0-windows,for this unit test we are expecting a request to send an image.
v1.4.0-windows,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.4.0-windows,hmmm
v1.4.0-windows,================ ls
v1.4.0-windows,================ put file
v1.4.0-windows,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.4.0-windows,================ get file
v1.4.0-windows,verify the file contents.
v1.4.0-windows,================ remove file
v1.4.0-windows,================ make directory
v1.4.0-windows,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.4.0-windows,================ remove directory
v1.4.0-windows,Now verification
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,you must call this method if you want HandleMessage to be called subsequently.
v1.4.0-windows,treat literals as one word
v1.4.0-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.4.0-windows,request gps info
v1.4.0-windows,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.4.0-windows,find relative position since command start so we can compare two commands better
v1.4.0-windows,"these PID values are important, so set these to match"
v1.4.0-windows,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.4.0-windows,we can skip ahead.
v1.4.0-windows,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.4.0-windows,TODO: avoid passing hadcoded HIL flag
v1.4.0-windows,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.4.0-windows,"The global position, as returned by the Global Positioning System (GPS)."
v1.4.0-windows,Provides state for additional features
v1.4.0-windows,The general system state
v1.4.0-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.4.0-windows,Provides state for additional features
v1.4.0-windows,The general system state
v1.4.0-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.4.0-windows,Provides state for additional features
v1.4.0-windows,The general system state
v1.4.0-windows,Provides state for additional features
v1.4.0-windows,The general system state
v1.4.0-windows,note: we do not reset com when Close() is called because we want to keep running.
v1.4.0-windows,"user has to invoke ""hil stop"" to stop the hil thread."
v1.4.0-windows,generate random between 0 and 1
v1.4.0-windows,move to range -1 to 1
v1.4.0-windows,scale it
v1.4.0-windows,apply iy
v1.4.0-windows,wait for the Execute method to be called.
v1.4.0-windows,gps is much slower frequency than IMU.
v1.4.0-windows,MAVLINK_MSG_ID_HIL_GPS
v1.4.0-windows,disable MAV_USEHILGPS
v1.4.0-windows,note: we do not reset com when Close() is called because we want to keep running.
v1.4.0-windows,"user has to invoke ""hil stop"" to stop the hil thread."
v1.4.0-windows,generate random between 0 and 1
v1.4.0-windows,move to range -1 to 1
v1.4.0-windows,scale it
v1.4.0-windows,apply iy
v1.4.0-windows,wait for the Execute method to be called.
v1.4.0-windows,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.4.0-windows,gps is much slower frequency than IMU.
v1.4.0-windows,MAVLINK_MSG_ID_HIL_GPS
v1.4.0-windows,disable HIL mode
v1.4.0-windows,Enumeration of landed detector states
v1.4.0-windows,MAV landed state is unknown
v1.4.0-windows,MAV is landed (on ground)
v1.4.0-windows,MAV is in air
v1.4.0-windows,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.4.0-windows,The filtered local position
v1.4.0-windows,must send these regularly to keep offboard control.
v1.4.0-windows,"ok, now we can safely switch to loiter."
v1.4.0-windows,must send these regularly to keep offboard control.
v1.4.0-windows,integrate the heading so it is smoother.
v1.4.0-windows,must send these regularly to keep offboard control.
v1.4.0-windows,integrate the heading so it is smoother.
v1.4.0-windows,fly to radius
v1.4.0-windows,it takes about 10 cm to stop and turn.
v1.4.0-windows,next time around switch to orbiting!
v1.4.0-windows,heading points to center of circle.
v1.4.0-windows,interpoloate the speed ramp up time over 2 seconds from start time
v1.4.0-windows,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.4.0-windows,monitor the sin curves so we can see how on track or off track it actually is.
v1.4.0-windows,the shape of the curve will also tell us if we are progressing at a consistent
v1.4.0-windows,"speed, the more deformed the sin curve the worse our progress."
v1.4.0-windows,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.4.0-windows,degrees just flipped from 359 to 0.
v1.4.0-windows,this enables us to test what happens when offboard control is lost and resumed.
v1.4.0-windows,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.4.0-windows,"ok, now we can start moving by velocity"
v1.4.0-windows,recompute to new target.
v1.4.0-windows,start by moving right with 10 degree roll.
v1.4.0-windows,haven't started yet.
v1.4.0-windows,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.4.0-windows,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.4.0-windows,track how our actual pitch is coming along compared to our target
v1.4.0-windows,and check position
v1.4.0-windows,the amount of pitch should depend on our speed in that direction.
v1.4.0-windows,passed the midpoint.
v1.4.0-windows,fade out the pitch as we pick up speed so we don't overshoot.
v1.4.0-windows,see if we just crossed the wiggle distance threshold.
v1.4.0-windows,(pitch affects the x-position).
v1.4.0-windows,reverse direction with a -30 degrees quick stop
v1.4.0-windows,reverse direction with a 30 degrees quick stop
v1.4.0-windows,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.4.0-windows,too much in that direction.
v1.4.0-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.4.0-windows,track how our actual roll is coming along compared to our target
v1.4.0-windows,and check position
v1.4.0-windows,the amount of roll should depend on our speed in that direction.
v1.4.0-windows,passed the midpoint.
v1.4.0-windows,fade out the roll as we pick up speed so we don't overshoot.
v1.4.0-windows,see if we just crossed the wiggle distance threshold.
v1.4.0-windows,(roll affects the y-position).
v1.4.0-windows,reverse direction with a -30 degrees quick stop
v1.4.0-windows,reverse direction with a 30 degrees quick stop
v1.4.0-windows,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.4.0-windows,too much in that direction.
v1.4.0-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.4.0-windows,for testing PID controller.
v1.4.0-windows,class AltHoldCommand : public Command
v1.4.0-windows,{
v1.4.0-windows,std::shared_ptr<MavLinkVehicle> channel;
v1.4.0-windows,"float sx_, sy_, sz_;"
v1.4.0-windows,MavLinkAttitudeTarget _current;
v1.4.0-windows,PidController thrust_controller_;
v1.4.0-windows,public:
v1.4.0-windows,this->sz_ = pos.z; // user defined target.
v1.4.0-windows,move to local position keeps the offboard control happy.
v1.4.0-windows,haven't started yet.
v1.4.0-windows,and check position
v1.4.0-windows,double dx = this->sx_ - pos.x;
v1.4.0-windows,double dy = this->sy_ - pos.y;
v1.4.0-windows,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.4.0-windows,too much in that direction.
v1.4.0-windows,adjust thrust so we keep steady height target
v1.4.0-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.4.0-windows,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.4.0-windows,local remote
v1.4.0-windows,already handled by the parse method.
v1.4.0-windows,we only support very simple patterns for now.
v1.4.0-windows,each wildcard must be separated by literal.
v1.4.0-windows,back to back wildcards with no literal in between is too complex.
v1.4.0-windows,"we only support simple matching for now, we can add full regex later if we need it."
v1.4.0-windows,yep!
v1.4.0-windows,'*' is done we found the next matching char
v1.4.0-windows,this is ok.
v1.4.0-windows,this is an ERASE_END_LINE command which we ignore.
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,unpack the message...
v1.4.0-windows,pack the payload buffer.
v1.4.0-windows,"json can't handle ""nan"", so we convert it to null."
v1.4.0-windows,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.4.0-windows,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,start listening to this connection
v1.4.0-windows,Send heartbeat to drone.  You should not do this if some other node is
v1.4.0-windows,already doing it.
v1.4.0-windows,stop listening to the connection.
v1.4.0-windows,get the connection
v1.4.0-windows,Get the local system and component id
v1.4.0-windows,send a command to the remote node
v1.4.0-windows,MavLinkNode::MavLinkNode() = default;
v1.4.0-windows,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.4.0-windows,decrementing the count so the next WaitOne may block.
v1.4.0-windows,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.4.0-windows,convert to absolute time.
v1.4.0-windows,use mach_timespec
v1.4.0-windows,convert to absolute time.
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,return true if we still have offboard control (can lose this if user flips the switch).
v1.4.0-windows,MavLinkVehicle::MavLinkVehicle() = default;
v1.4.0-windows,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.4.0-windows,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,============================== CLIENT ============================================
v1.4.0-windows,image APIs
v1.4.0-windows,or if you are implementing the client side call this function to get the most recent frame.
v1.4.0-windows,returns false if there is no new frame available.
v1.4.0-windows,============================== SERVER ============================================
v1.4.0-windows,call this to send the image back over the connection given to start function.
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,"log every message that is ""sent"" using sendMessage."
v1.4.0-windows,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.4.0-windows,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.4.0-windows,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.4.0-windows,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,for compatibility with QGroundControl we have to save the time field in big endian.
v1.4.0-windows,todo: mavlink2 support?
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,start listening to this connection
v1.4.0-windows,Send heartbeat to drone.  You should not do this if some other node is
v1.4.0-windows,already doing it.
v1.4.0-windows,this is called for all messages received on the connection.
v1.4.0-windows,"we received a heartbeat, so let's get the capabilities."
v1.4.0-windows,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.4.0-windows,subclasses remembering to call this base implementation.
v1.4.0-windows,stop listening to the connection.
v1.4.0-windows,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.4.0-windows,wait for a heartbeat msg since this will give us the port to send commands to...
v1.4.0-windows,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.4.0-windows,send a heart beat so that the remote node knows we are still alive
v1.4.0-windows,(otherwise drone will trigger a failsafe operation).
v1.4.0-windows,ignore any failures here because we are running in our own thread here.
v1.4.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.4.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.4.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.4.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.4.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.4.0-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.4.0-windows,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.4.0-windows,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.4.0-windows,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.4.0-windows,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.4.0-windows,"ok, now fetch the missing parameters."
v1.4.0-windows,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.4.0-windows,silently fail since we are on a background thread here...
v1.4.0-windows,tell the caller this is complete.
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,add our custom telemetry message length.
v1.4.0-windows,todo: if we support signing then initialize
v1.4.0-windows,mavlink_intermediate_status_.signing callbacks
v1.4.0-windows,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.4.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.4.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.4.0-windows,send this right away just in case serial link is not already configured
v1.4.0-windows,"log every message that is ""sent"" using sendMessage."
v1.4.0-windows,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.4.0-windows,pack the payload buffer.
v1.4.0-windows,calculate checksum
v1.4.0-windows,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.4.0-windows,are variable length as a result.
v1.4.0-windows,form the header as a byte array for the crc
v1.4.0-windows,these macros use old style cast.
v1.4.0-windows,forward messages from our connected node to the remote proxy.
v1.4.0-windows,tell the remote connection to expect mavlink2 messages.
v1.4.0-windows,forward messages from remote proxy to local connected node
v1.4.0-windows,CurrentThread::setMaximumPriority();
v1.4.0-windows,"hmmm, wait till it is opened?"
v1.4.0-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.4.0-windows,pick up the sysid/compid of the remote node we are connected to.
v1.4.0-windows,then this is a mavlink 1 message
v1.4.0-windows,then this mavlink sender supports mavlink 2
v1.4.0-windows,queue event for publishing.
v1.4.0-windows,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.4.0-windows,as it ensures we don't lose messages if the listener is slow.
v1.4.0-windows,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.4.0-windows,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.4.0-windows,we would get a deadlock.
v1.4.0-windows,CurrentThread::setMaximumPriority();
v1.4.0-windows,reset counters
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,------------------------------------------------------------------------------
v1.4.0-windows,Defines
v1.4.0-windows,------------------------------------------------------------------------------
v1.4.0-windows,bit number  876543210987654321
v1.4.0-windows,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.4.0-windows,in future it would be good to have ability to add system IDs we are interested in
v1.4.0-windows,if (msg.sysid != getTargetSystemId())
v1.4.0-windows,{
v1.4.0-windows,// we only care about messages from our intended remote node.
v1.4.0-windows,return;
v1.4.0-windows,}
v1.4.0-windows,user may have changed modes on us! So we need to honor that and not
v1.4.0-windows,try and take it back.
v1.4.0-windows,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.4.0-windows,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.4.0-windows,we can store up to 16 channels in rc_channels_scaled.
v1.4.0-windows,The RAW values of the servo outputs
v1.4.0-windows,Metrics typically displayed on a HUD for fixed wing aircraft
v1.4.0-windows,The IMU readings in SI units in NED body frame
v1.4.0-windows,printSystemStatus(&msg);
v1.4.0-windows,todo: use this to determine when we need to do emergency landing...
v1.4.0-windows,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.4.0-windows,Provides state for additional features
v1.4.0-windows,The general system state
v1.4.0-windows,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.4.0-windows,but we do want to know when we get the ack.  So this is async ACK processing!
v1.4.0-windows,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.4.0-windows,if threshold < 0 then the threshold is inverted.
v1.4.0-windows,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.4.0-windows,Convert it to a floating point number between -1 and 1.
v1.4.0-windows,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.4.0-windows,until the move commands start happening.
v1.4.0-windows,return true if user calls requestControl and has not called releaseControl.
v1.4.0-windows,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.4.0-windows,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.4.0-windows,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.4.0-windows,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.4.0-windows,send a few to make sure it gets through...
v1.4.0-windows,now the command should succeed.
v1.4.0-windows,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.4.0-windows,us by which time the PX4 times out offboard mode!!
v1.4.0-windows,this mode change take precedence over offboard mode.
v1.4.0-windows,thrust must be between -1 and 1.
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,These definitions are copied from PX4 implementation
v1.4.0-windows,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.4.0-windows,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.4.0-windows,/ @brief Command opcodes
v1.4.0-windows,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.4.0-windows,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.4.0-windows,must trim trailing slashes so PX4 doesn't hang!
v1.4.0-windows,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.4.0-windows,from the source.
v1.4.0-windows,check if directory exists.
v1.4.0-windows,perfect.
v1.4.0-windows,use last_message_ so we preserve the sessionid.
v1.4.0-windows,"could not create the local file, so stop."
v1.4.0-windows,must use last_message_ so we preserve the session id.
v1.4.0-windows,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.4.0-windows,todo: error handling here? sequence is out of order...
v1.4.0-windows,"directory must be empty then, can't do nextStep because"
v1.4.0-windows,it will just loop for ever re-requesting zero offset into
v1.4.0-windows,empty directory.
v1.4.0-windows,result should be a list of null terminated file names.
v1.4.0-windows,skipping this entry
v1.4.0-windows,remove the file size field.
v1.4.0-windows,"printf(""%s\n"", name.c_str());"
v1.4.0-windows,request the next batch.
v1.4.0-windows,"perhaps this was a late response after we did a retry, so ignore it."
v1.4.0-windows,"perhaps this was a late response after we did a retry, so ignore it."
v1.4.0-windows,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.4.0-windows,reached the end of the list or the file.
v1.4.0-windows,end of file or directory listing.
v1.4.0-windows,"success, data should be following..."
v1.4.0-windows,ack on this cmd is a noop
v1.4.0-windows,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.4.0-windows,give up then.
v1.4.0-windows,tell watchdog we are sending a request
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,================================= CLIENT ==============================================================
v1.4.0-windows,Check if we have a valid transaction
v1.4.0-windows,emit signal if all packets arrived
v1.4.0-windows,Restart statemachine
v1.4.0-windows,image APIs
v1.4.0-windows,================================= SERVER ==============================================================
v1.4.0-windows,Prepare and send acknowledgment packet
v1.4.0-windows,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.4.0-windows,Send ENCAPSULATED_IMAGE packet
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.4.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.4.0-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.4.0-windows,send this right away just in case serial link is not already configured
v1.4.0-windows,CurrentThread::setMaximumPriority();
v1.4.0-windows,"hmmm, wait till it is opened?"
v1.4.0-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.4.0-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.4.0-windows,queue event for publishing.
v1.4.0-windows,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.4.0-windows,as it ensures we don't lose messages if the listener is slow.
v1.4.0-windows,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.4.0-windows,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.4.0-windows,we would get a deadlock.
v1.4.0-windows,CurrentThread::setMaximumPriority();
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.4.0-windows,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.4.0-windows,parse out the VID number
v1.4.0-windows,now the PID
v1.4.0-windows,parse out the VID number
v1.4.0-windows,examples:
v1.4.0-windows,PX4: USB\VID_26AC&PID_0011\0
v1.4.0-windows,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.4.0-windows,"printf(""Found: %S\n"", buffer.c_str());"
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.4.0-windows,parse out the VID number
v1.4.0-windows,now the PID
v1.4.0-windows,parse out the VID number
v1.4.0-windows,suppress
v1.4.0-windows,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,This has not been properly tested
v1.4.0-windows,struct iw_statistics stats;
v1.4.0-windows,struct iwreq req;
v1.4.0-windows,"memset(&stats, 0, sizeof(stats));"
v1.4.0-windows,"memset(&req, 0, sizeof(iwreq));"
v1.4.0-windows,
v1.4.0-windows,"strncpy(req.ifr_name, ifaceName, 16);"
v1.4.0-windows,req.u.data.pointer = &stats;
v1.4.0-windows,req.u.data.length = sizeof(iw_statistics);
v1.4.0-windows,
v1.4.0-windows,#ifdef CLEAR_UPDATED
v1.4.0-windows,req.u.data.flags = 1;
v1.4.0-windows,#endif
v1.4.0-windows,
v1.4.0-windows,/* Perform the ioctl */
v1.4.0-windows,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.4.0-windows,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.4.0-windows,return -127;
v1.4.0-windows,}
v1.4.0-windows,
v1.4.0-windows,return stats.qual.level;
v1.4.0-windows,todo: windows version of this...
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,windows
v1.4.0-windows,Need to link with Ws2_32.lib
v1.4.0-windows,posix
v1.4.0-windows,found it!
v1.4.0-windows,bind socket to local address.
v1.4.0-windows,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.4.0-windows,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.4.0-windows,write to the serial port
v1.4.0-windows,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.4.0-windows,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.4.0-windows,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.4.0-windows,"try and receive something, up until port is closed anyway."
v1.4.0-windows,"message was too large for the buffer, no problem, return what we have."
v1.4.0-windows,try again - this can happen if server recreates the socket on their side.
v1.4.0-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.4.0-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.4.0-windows,"printf(""#### recv failed with error: %d\n"", hr);"
v1.4.0-windows,we now have it.
v1.4.0-windows,this is from someone we are not interested in.
v1.4.0-windows,-----------------------------------------------------------------------------------------
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,Initialize Winsock
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,windows
v1.4.0-windows,Need to link with Ws2_32.lib
v1.4.0-windows,posix
v1.4.0-windows,found it!
v1.4.0-windows,bind socket to local address.
v1.4.0-windows,bind socket to local address.
v1.4.0-windows,start listening for incoming connection
v1.4.0-windows,accept 1
v1.4.0-windows,"don't need to accept any more, so we can close this one."
v1.4.0-windows,write to the serial port
v1.4.0-windows,"try and receive something, up until port is closed anyway."
v1.4.0-windows,"message was too large for the buffer, no problem, return what we have."
v1.4.0-windows,try again - this can happen if server recreates the socket on their side.
v1.4.0-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.4.0-windows,try again - this can happen if server recreates the socket on their side.
v1.4.0-windows,-----------------------------------------------------------------------------------------
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.4.0-windows,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.4.0-windows,set signal
v1.4.0-windows,Clear Handshake flags
v1.4.0-windows,Set Handshake flags
v1.4.0-windows,return GetLastError();
v1.4.0-windows,return GetLastError();
v1.4.0-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.4.0-windows,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.4.0-windows,enable reading
v1.4.0-windows,posix doesn't have mark/space parity.
v1.4.0-windows,posix doesn't have mark/space parity.
v1.4.0-windows,this is the default.
v1.4.0-windows,not sure this is supported...
v1.4.0-windows,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.4.0-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.4.0-windows,First do those specified by POSIX.
v1.4.0-windows,Now conditionally handle a bunch of extended rates.
v1.4.0-windows,First do those specified by POSIX.
v1.4.0-windows,Now conditionally handle a bunch of extended rates.
v1.4.0-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.4.0-windows,import airsim
v1.4.0-windows,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v1.4.0-windows,self.args = args
v1.4.0-windows,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v1.4.0-windows,pdb.set_trace()
v1.4.0-windows,#include <pluginlib/class_list_macros.h>
v1.4.0-windows,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v1.4.0-windows,todo do not reset if already in air?
v1.4.0-windows,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.4.0-windows,ros params
v1.4.0-windows,todo enforce dynamics constraints in this node as well?
v1.4.0-windows,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v1.4.0-windows,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v1.4.0-windows,XmlRpc::XmlRpcValue can't be const in this case
v1.4.0-windows,subscribe to control commands on global nodehandle
v1.4.0-windows,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.4.0-windows,bind to a single callback. todo optimal subs queue length
v1.4.0-windows,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.4.0-windows,"vehicle_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.4.0-windows,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.4.0-windows,vehicle_setting_vec_.push_back(*vehicle_setting.get());
v1.4.0-windows,camera_setting.gimbal
v1.4.0-windows,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.4.0-windows,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.4.0-windows,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.4.0-windows,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.4.0-windows,"if {DepthPlanner, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.4.0-windows,"push back pair (vector of image captures, current vehicle name)"
v1.4.0-windows,iterate over sensors
v1.4.0-windows,"we want fast access to the lidar sensors for callback handling, sort them out now"
v1.4.0-windows,add takeoff and land all services if more than 2 drones
v1.4.0-windows,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v1.4.0-windows,todo add per vehicle reset in AirLib API
v1.4.0-windows,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.4.0-windows,lidars update on their own callback/thread at a given rate
v1.4.0-windows,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v1.4.0-windows,"todo: error check. if state is not landed, return error."
v1.4.0-windows,response.success =
v1.4.0-windows,response.success =
v1.4.0-windows,response.success =
v1.4.0-windows,response.success =
v1.4.0-windows,response.success =
v1.4.0-windows,response.success =
v1.4.0-windows,todo add reset by vehicle_name API to airlib
v1.4.0-windows,todo not async remove waitonlasttask
v1.4.0-windows,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v1.4.0-windows,todo do actual body frame?
v1.4.0-windows,airsim uses degrees
v1.4.0-windows,todo do actual body frame?
v1.4.0-windows,airsim uses degrees
v1.4.0-windows,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v1.4.0-windows,todo expose waitOnLastTask or nah?
v1.4.0-windows,todo do actual body frame?
v1.4.0-windows,airsim uses degrees
v1.4.0-windows,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.4.0-windows,todo expose waitOnLastTask or nah?
v1.4.0-windows,todo support multiple gimbal commands
v1.4.0-windows,todo support multiple gimbal commands
v1.4.0-windows,1. find quaternion of default gimbal pose
v1.4.0-windows,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.4.0-windows,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.4.0-windows,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.4.0-windows,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.4.0-windows,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.4.0-windows,msg = []
v1.4.0-windows,todo covariances
v1.4.0-windows,gps_msg.position_covariance_type =
v1.4.0-windows,gps_msg.position_covariance =
v1.4.0-windows,todo covariances
v1.4.0-windows,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.4.0-windows,todo radians per second
v1.4.0-windows,meters/s2^m
v1.4.0-windows,imu_msg.orientation_covariance = ;
v1.4.0-windows,imu_msg.angular_velocity_covariance = ;
v1.4.0-windows,imu_msg.linear_acceleration_covariance = ;
v1.4.0-windows,airsim appears to use chrono::system_clock with nanosecond precision
v1.4.0-windows,todo this is global origin
v1.4.0-windows,get the basic vehicle pose and environmental state
v1.4.0-windows,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.4.0-windows,airsim_client needs to provide the simulation time in a future version of the API
v1.4.0-windows,publish the simulation clock
v1.4.0-windows,"publish vehicle state, odom, and all basic sensor types"
v1.4.0-windows,send any commands out to the vehicles
v1.4.0-windows,"should be easier way to get the sim time through API, something like:"
v1.4.0-windows,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.4.0-windows,curr_ros_time = airsim_timestamp_to_ros(env.clock().nowNanos());
v1.4.0-windows,iterate over drones
v1.4.0-windows,get drone state from airsim
v1.4.0-windows,"vehicle environment, we can get ambient temperature here and other truths"
v1.4.0-windows,convert airsim drone state to ROS msgs
v1.4.0-windows,simulation environment truth
v1.4.0-windows,"dashboard reading from car, RPM, gear, etc"
v1.4.0-windows,odom and transforms
v1.4.0-windows,ground truth GPS position from sim/HITL
v1.4.0-windows,handled via callback
v1.4.0-windows,send control commands from the last callback to airsim
v1.4.0-windows,send control commands from the last callback to airsim
v1.4.0-windows,"Only camera rotation, no translation movement of camera"
v1.4.0-windows,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.4.0-windows,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.4.0-windows,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.4.0-windows,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.4.0-windows,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.4.0-windows,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.4.0-windows,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.4.0-windows,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.4.0-windows,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.4.0-windows,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.4.0-windows,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.4.0-windows,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.4.0-windows,update timestamp of saved cam info msgs
v1.4.0-windows,DepthPlanner / DepthPerspective / DepthVis / DisparityNormalized
v1.4.0-windows,Scene / Segmentation / SurfaceNormals / Infrared
v1.4.0-windows,publish camera transforms
v1.4.0-windows,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.4.0-windows,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.4.0-windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.4.0-windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.4.0-windows,ROS params
v1.4.0-windows,ROS publishers
v1.4.0-windows,ROS subscribers
v1.4.0-windows,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.4.0-windows,ROS timers
v1.4.0-windows,todo maintain internal representation as eigen vec?
v1.4.0-windows,todo check if low velocity if within thresh?
v1.4.0-windows,todo maintain separate errors for XY and Z
v1.4.0-windows,todo save this in degrees somewhere to avoid repeated conversion
v1.4.0-windows,this tells the update timer callback to not do active hovering
v1.4.0-windows,todo maintain array of position goals
v1.4.0-windows,todo error checks
v1.4.0-windows,todo fill response
v1.4.0-windows,"Already have goal, and have reached it"
v1.4.0-windows,this tells the update timer callback to not do active hovering
v1.4.0-windows,todo error checks
v1.4.0-windows,todo fill response
v1.4.0-windows,"todo do relative altitude, or add an option for the same?"
v1.4.0-windows,convert GPS goal to NED goal
v1.4.0-windows,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.4.0-windows,todo error checks
v1.4.0-windows,todo fill response
v1.4.0-windows,"Already have goal, this shouldn't happen"
v1.4.0-windows,"todo do relative altitude, or add an option for the same?"
v1.4.0-windows,convert GPS goal to NED goal
v1.4.0-windows,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.4.0-windows,todo error checks
v1.4.0-windows,todo fill response
v1.4.0-windows,todo check if odometry is too old!!
v1.4.0-windows,"if no odom, don't do anything."
v1.4.0-windows,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.4.0-windows,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.4.0-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.4.0-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.4.0-windows,todo yaw limits
v1.4.0-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.4.0-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.4.0-windows,check if path exists
v1.4.0-windows,todo airsim's simhud.cpp does error checking here
v1.4.0-windows,mimics void ASimHUD::initializeSettings()
v1.4.0-windows,not sure where settings_json initialized in AirSimSettings::initializeSettings() is actually used
v1.4.0-windows,int num_threads = 1;
v1.4.0-windows,ros::MultiThreadedSpinner multi_thread(num_threads);
v1.4.0-windows,multi_thread.spin();
v1.4.0-windows,ros::AsyncSpinner async_spinner(num_threads);
v1.4.0-windows,async_spinner.start();
v1.4.0-windows,single threaded spinner
v1.4.0-windows,connect to the AirSim simulator
v1.4.0-windows,","
v1.4.0-windows,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.4.0-windows,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,"in header only mode, control library is not available"
v1.4.0-windows,TODO: something defines max macro which interfears with code here
v1.4.0-windows,is cur_pos within fence?
v1.4.0-windows,destination risk is not available then consider it zero
v1.4.0-windows,if dest risk is lower than its more safe
v1.4.0-windows,are we doing better than closest obstacle?
v1.4.0-windows,"if we stay where we are, what is the risk distance?"
v1.4.0-windows,else we are better of moving to dest
v1.4.0-windows,this function should work even when dest_pos == cur_pos
v1.4.0-windows,is this dest_pos cur_pos within the fence?
v1.4.0-windows,transform dest_pos vector to body frame
v1.4.0-windows,check for approx zero vectors to avoid random yaw angles
v1.4.0-windows,we are hovering
v1.4.0-windows,"get yaw in body frame, ie, front is always 0 radians"
v1.4.0-windows,yaw to ticks
v1.4.0-windows,get obstacles in the window at the tick direction around the window
v1.4.0-windows,less risk distance is better
v1.4.0-windows,check obstacles around current position and see if it has lower risk
v1.4.0-windows,else obstacle is too far
v1.4.0-windows,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.4.0-windows,look for each surrounding tick to see if we have obstacle free angle
v1.4.0-windows,else no suggestions required
v1.4.0-windows,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.4.0-windows,evaluate right and left side of circle
v1.4.0-windows,find right and left risk distances
v1.4.0-windows,at this point we have already determined hover is better than going to dest
v1.4.0-windows,we now determine is moving to suggested angle better than hovering?
v1.4.0-windows,check if dest_pos is safe
v1.4.0-windows,breaking distance at this velocity
v1.4.0-windows,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.4.0-windows,check if dest_pos is safe
v1.4.0-windows,float/vec parameters can have NaN which makes them optional
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,"in header only mode, control library is not available"
v1.4.0-windows,handles +/- tick and wraps around circle
v1.4.0-windows,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.4.0-windows,update the specified window on the map
v1.4.0-windows,make sure from <= to
v1.4.0-windows,normalize the ticks so both are valid indices
v1.4.0-windows,if from is still larger then
v1.4.0-windows,to ticks is then added one full circle to make it larger than from_tick
v1.4.0-windows,find closest obstacle in given window
v1.4.0-windows,search whole map to find closest obstacle
v1.4.0-windows,"in header only mode, control library is not available"
v1.4.0-windows,#include <fileapi.h>
v1.4.0-windows,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.4.0-windows,"Windows, OSX and Linux."
v1.4.0-windows,Windows users can move the Documents folder to any location they want
v1.4.0-windows,SHGetFolderPath knows how to find it.
v1.4.0-windows,fall back in case SHGetFolderPath failed for some reason.
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,"in header only mode, control library is not available"
v1.4.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.4.0-windows,if using Unreal Build system then include precompiled header file first
v1.4.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.4.0-windows,this deadlocks UI thread if async_run was called while there are pending rpc calls.
v1.4.0-windows,Exit if already resetting.
v1.4.0-windows,Reset
v1.4.0-windows,if we don't suppress then server will bomb out for exceptions raised by any method
v1.4.0-windows,required for pimpl
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,"in header only mode, control library is not available"
v1.4.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.4.0-windows,if using Unreal Build system then include precompiled header file first
v1.4.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.4.0-windows,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.4.0-windows,make sure we can talk to the DroneServer
v1.4.0-windows,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.4.0-windows,command_context.client.ping();
v1.4.0-windows,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.4.0-windows,sim only
v1.4.0-windows,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.4.0-windows,return value of last task. It should be true if task completed without
v1.4.0-windows,cancellation or timeout
v1.4.0-windows,"should be implemented by derived class if it supports async task,"
v1.4.0-windows,for example using futures
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,"in header only mode, control library is not available"
v1.4.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.4.0-windows,if using Unreal Build system then include precompiled header file first
v1.4.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,"in header only mode, control library is not available"
v1.4.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.4.0-windows,if using Unreal Build system then include precompiled header file first
v1.4.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.4.0-windows,required for pimpl
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,"in header only mode, control library is not available"
v1.4.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.4.0-windows,if using Unreal Build system then include precompiled header file first
v1.4.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.4.0-windows,status getters
v1.4.0-windows,return value of last task. It should be true if task completed without
v1.4.0-windows,cancellation or timeout
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,"in header only mode, control library is not available"
v1.4.0-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.4.0-windows,if using Unreal Build system then include pre-compiled header file first
v1.4.0-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.4.0-windows,getters
v1.4.0-windows,required for pimpl
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,"in header only mode, control library is not available"
v1.4.0-windows,last command is to hold on to position
v1.4.0-windows,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.4.0-windows,after landing we detect if drone has stopped moving
v1.4.0-windows,validate path size
v1.4.0-windows,validate yaw mode
v1.4.0-windows,validate and set auto-lookahead value
v1.4.0-windows,if auto mode requested for lookahead then calculate based on velocity
v1.4.0-windows,add current position as starting point
v1.4.0-windows,append the input path and compute segments
v1.4.0-windows,add last segment as zero length segment so we have equal number of segments and points.
v1.4.0-windows,path_segs[i] refers to segment that starts at point i
v1.4.0-windows,"when path ends, we want to slow down"
v1.4.0-windows,else no need to change velocities for last segments
v1.4.0-windows,setup current position on path to 0 offset
v1.4.0-windows,initialize next path position
v1.4.0-windows,until we are at the end of the path (last seg is always zero size)
v1.4.0-windows,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.4.0-windows,send drone command to get to next lookahead
v1.4.0-windows,sleep for rest of the cycle
v1.4.0-windows,how much have we moved towards last goal?
v1.4.0-windows,project actual vector on goal vector
v1.4.0-windows,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.4.0-windows,TODO: below should be lower than 1E3 and configurable
v1.4.0-windows,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.4.0-windows,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.4.0-windows,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.4.0-windows,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.4.0-windows,"if drone moved backward, we don't want goal to move backward as well"
v1.4.0-windows,"so only climb forward on the path, never back. Also note >= which means"
v1.4.0-windows,we climb path even if distance was 0 to take care of duplicated points on path
v1.4.0-windows,else
v1.4.0-windows,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.4.0-windows,compute next target on path
v1.4.0-windows,freeze the quaternion
v1.4.0-windows,convert RC commands to velocity vector
v1.4.0-windows,find yaw as per terrain and remote setting
v1.4.0-windows,execute command
v1.4.0-windows,if timeout occurred then command completed successfully otherwise it was interrupted
v1.4.0-windows,yaw is not within margin
v1.4.0-windows,by default we say that this command is not supported
v1.4.0-windows,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.4.0-windows,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.4.0-windows,get trims
v1.4.0-windows,take average
v1.4.0-windows,validate dest
v1.4.0-windows,what is the distance we will travel at this velocity?
v1.4.0-windows,get velocity vector
v1.4.0-windows,yaw for the direction of travel
v1.4.0-windows,find velocity vector
v1.4.0-windows,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.4.0-windows,generate velocity vector that is same size as cur_dest_norm / command period
v1.4.0-windows,this velocity vect when executed for command period would yield cur_dest_norm
v1.4.0-windows,send commands
v1.4.0-windows,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.4.0-windows,default strategy is for move. In hover mode we set new strategy temporarily
v1.4.0-windows,are we supposed to do EM?
v1.4.0-windows,get suggested velocity vector
v1.4.0-windows,use the unchecked command
v1.4.0-windows,tell caller not to execute planned command
v1.4.0-windows,other wise throw exception
v1.4.0-windows,otherwise there is some other reason why we are in unsafe situation
v1.4.0-windows,send last command to come to full stop
v1.4.0-windows,else no unsafe situation
v1.4.0-windows,note: cur_path_loc and next_path_loc may both point to same object
v1.4.0-windows,"otherwise use up this segment, move on to next one"
v1.4.0-windows,if we are here then we ran out of segments
v1.4.0-windows,consider last segment as zero length segment
v1.4.0-windows,adjust yaw for the direction of travel in forward-only mode
v1.4.0-windows,else no adjustment needed
v1.4.0-windows,if auto mode requested for lookahead then calculate based on velocity
v1.4.0-windows,Create a spring arm component for our chase camera
v1.4.0-windows,"do nothing, spring arm is pulling the camera with it"
v1.4.0-windows,"do nothing, we have camera turned off"
v1.4.0-windows,set initial view mode
v1.4.0-windows,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.4.0-windows,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.4.0-windows,"If the lag is missing, the camera will also occasionally shake."
v1.4.0-windows,"But, lag is not desired when piloting a drone"
v1.4.0-windows,attach spring arm to actor
v1.4.0-windows,remember current parent for external camera. Later when we remove external
v1.4.0-windows,"camera from spring arm, we will attach it back to its last parent"
v1.4.0-windows,now attach camera to spring arm
v1.4.0-windows,"For car, we need to move the camera back a little more than for a drone."
v1.4.0-windows,"Otherwise, the camera will be stuck inside the car"
v1.4.0-windows,ExternalCamera->bUsePawnControlRotation = false;
v1.4.0-windows,detach spring arm
v1.4.0-windows,Re-enable rendering
v1.4.0-windows,Remove any existing key bindings for manual mode
v1.4.0-windows,"else someone else is bound to manual pose controller, leave it alone"
v1.4.0-windows,if new mode is manual mode then add key bindings
v1.4.0-windows,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.4.0-windows,other modes don't need special setup
v1.4.0-windows,make switch official
v1.4.0-windows,Add loading screen to viewport
v1.4.0-windows,Remove Loading screen from viewport
v1.4.0-windows,Create struct for Location and Rotation of actor in Unreal
v1.4.0-windows,new_actor_spawn_params.NameMode = FActorSpawnParameters::ESpawnActorNameMode::Required_ReturnNull;
v1.4.0-windows,Write the binvox file using run-length encoding
v1.4.0-windows,"where each pair of bytes is of the format (run value, run length)"
v1.4.0-windows,This is a run (repeated bit value)
v1.4.0-windows,End of a run
v1.4.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.4.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.4.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.4.0-windows,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.4.0-windows,Split the tag string into individual tags.
v1.4.0-windows,Texture swap on actors that have all of those tags.
v1.4.0-windows,----------- Plotting APIs ----------/
v1.4.0-windows,"plot line for points 0-1, 1-2, 2-3"
v1.4.0-windows,"plot line for points 0-1, 2-3, 4-5... must be even number of points"
v1.4.0-windows,assert points_start.size() == poinst_end.size()
v1.4.0-windows,assert positions.size() == strings.size()
v1.4.0-windows,assert poses.size() == names.size()
v1.4.0-windows,Recording APIs
v1.4.0-windows,by default all image types are disabled
v1.4.0-windows,use final color for all calculations
v1.4.0-windows,TODO: avoid the need to override const cast here
v1.4.0-windows,if the viewport is taller than it is wide
v1.4.0-windows,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v1.4.0-windows,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v1.4.0-windows,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v1.4.0-windows,use final color for all calculations
v1.4.0-windows,TODO: should we be ignoring position and orientation settings here?
v1.4.0-windows,TODO: can we eliminate storing NedTransform?
v1.4.0-windows,if (!std::isnan(setting.target_gamma))
v1.4.0-windows,camera-> = setting.target_gamma;
v1.4.0-windows,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.4.0-windows,else nothing to enable
v1.4.0-windows,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.4.0-windows,if (controller && controller->GetViewTarget() == this)
v1.4.0-windows,controller->SetViewTarget(nullptr);
v1.4.0-windows,"Check whether requested map exists, this could be very slow if LevelName is a short package name"
v1.4.0-windows,Create Unique Name for sub-level package
v1.4.0-windows,Setup streaming level object that will load specified map
v1.4.0-windows,Transform
v1.4.0-windows,Map to Load
v1.4.0-windows,Add the new level to world.
v1.4.0-windows,TODO: explore screenshot option
v1.4.0-windows,addScreenCaptureHandler(camera->GetWorld());
v1.4.0-windows,TODO: may be we should have these methods non-const?
v1.4.0-windows,We don't do game/render thread synchronization for safe method.
v1.4.0-windows,We just blindly sleep for 200ms (the old way)
v1.4.0-windows,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.4.0-windows,Make sure that all alpha values are opaque.
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,TODO: change naming conventions to same as other files?
v1.4.0-windows,"context->GetWorld()->SetNewWorldOrigin(FIntVector(0, 0, 0));"
v1.4.0-windows,Enable/disable primary viewport rendering flag
v1.4.0-windows,This disables rendering of the main viewport in the same way as the
v1.4.0-windows,"console command ""show rendering"" would do."
v1.4.0-windows,"When getting an image through the API, the image is produced after the render"
v1.4.0-windows,thread has finished rendering the current and the subsequent frame. This means
v1.4.0-windows,that the frame rate for obtaining images through the API is only half as high as
v1.4.0-windows,"it could be, since only every other image is actually captured. We work around"
v1.4.0-windows,this by telling the viewport to flush the rendering queue at the end of each
v1.4.0-windows,drawn frame so that it executes our render request at that point already.
v1.4.0-windows,Do this only if the main viewport is not being rendered anyway in case there are
v1.4.0-windows,any adverse performance effects during main rendering.
v1.4.0-windows,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v1.4.0-windows,nothing to do for now
v1.4.0-windows,"if hidden, clear any existing messages"
v1.4.0-windows,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.4.0-windows,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.4.0-windows,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.4.0-windows,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.4.0-windows,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.4.0-windows,Find mesh in /Game and /AirSim asset registry. When more plugins are added this function will have to change
v1.4.0-windows,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.4.0-windows,{
v1.4.0-windows,InitializeObjectStencilID(*comp);
v1.4.0-windows,}
v1.4.0-windows,"Takes a UStaticMeshComponent, USkinnedMeshComponent or ALandscapeProxy and returns their custom stencil ID if"
v1.4.0-windows,their meshes's name or their owner's name (depending on the naming method in mesh_naming_method_) equals mesh_name
v1.4.0-windows,"The skybox is ignored here as it is huge, and really is of no use to the end user typically. Also the associated meshes with the cameras"
v1.4.0-windows,Various checks if there is even a valid mesh
v1.4.0-windows,Need to force the render command to go through cause on the next iteration the buffer no longer exists
v1.4.0-windows,Unreal stores more vertices than triangles. So here we find the highest referenced vertex and ignore any after that
v1.4.0-windows,can we see followee?
v1.4.0-windows,remove mapping
v1.4.0-windows,removing binding
v1.4.0-windows,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.4.0-windows,"some point. At the moment, manually swapping Red and Blue"
v1.4.0-windows,Copy scaled image into destination thumb
v1.4.0-windows,Compress data - convert into a .png
v1.4.0-windows,if we already have attached actor
v1.4.0-windows,#ifdef _MSC_VER
v1.4.0-windows,//print to VS output window
v1.4.0-windows,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.4.0-windows,#endif
v1.4.0-windows,also do default logging
v1.4.0-windows,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.4.0-windows,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.4.0-windows,{
v1.4.0-windows,if (GEngine != nullptr)
v1.4.0-windows,{
v1.4.0-windows,return GEngine->GameUserSettings;
v1.4.0-windows,}
v1.4.0-windows,return nullptr;
v1.4.0-windows,}
v1.4.0-windows,UGameUserSettings* game_settings = GetGameUserSettings();
v1.4.0-windows,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.4.0-windows,game_settings->ApplySettings(true);
v1.4.0-windows,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.4.0-windows,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.4.0-windows,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.4.0-windows,todo unused. need to manually plots tf axes' line in right handed FLU instead of using DrawDebugCoordinateSystem
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,plugin startup
v1.4.0-windows,plugin shutdown
v1.4.0-windows,initialize state
v1.4.0-windows,add listener for pawn's collision event
v1.4.0-windows,compute our home point
v1.4.0-windows,default behavior is to call update every tick
v1.4.0-windows,"for custom physics engine, this method should be overridden and update should be"
v1.4.0-windows,called from every physics tick
v1.4.0-windows,add cameras that already exists in pawn
v1.4.0-windows,create or replace cameras specified in settings
v1.4.0-windows,setup individual cameras
v1.4.0-windows,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.4.0-windows,for each camera in settings
v1.4.0-windows,get pose
v1.4.0-windows,spawn and attach camera to pawn
v1.4.0-windows,add on to our collection
v1.4.0-windows,Deflect along the surface when we collide.
v1.4.0-windows,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.4.0-windows,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.4.0-windows,-1 to 1 --> 0 to 1
v1.4.0-windows,-1 to 1
v1.4.0-windows,these will be available for devices like steering wheels
v1.4.0-windows,switch index 0 to 7 for FrSky Taranis RC is:
v1.4.0-windows,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.4.0-windows,TODO: should below be at controller level info?
v1.4.0-windows,else don't waste time
v1.4.0-windows,sync environment from kinematics
v1.4.0-windows,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.4.0-windows,void playBack()
v1.4.0-windows,{
v1.4.0-windows,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.4.0-windows,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.4.0-windows,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.4.0-windows,}
v1.4.0-windows,TODO: refactor below code used for playback
v1.4.0-windows,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.4.0-windows,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.4.0-windows,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.4.0-windows,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.4.0-windows,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.4.0-windows,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.4.0-windows,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.4.0-windows,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.4.0-windows,}
v1.4.0-windows,parameters in NED frame
v1.4.0-windows,translate to new PawnSimApi position & orientation from NED to NEU
v1.4.0-windows,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.4.0-windows,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.4.0-windows,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.4.0-windows,checked at the start of next tick
v1.4.0-windows,allow teleportation
v1.4.0-windows,if collisions are not enabled
v1.4.0-windows,or we have collided but passthrough is enabled
v1.4.0-windows,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.4.0-windows,"without flip flopping, collisions can't be detected"
v1.4.0-windows,update kinematics from pawn's movement instead of physics engine
v1.4.0-windows,by default we update kinematics from UE pawn
v1.4.0-windows,if SimMod uses its own physics engine then this should be overriden
v1.4.0-windows,no default action in this base class
v1.4.0-windows,TODO: because this bug we are using alternative code with stringstream
v1.4.0-windows,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.4.0-windows,std::stringstream ss;
v1.4.0-windows,"ss << timestamp_millis << ""\t"";"
v1.4.0-windows,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.4.0-windows,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.4.0-windows,"ss << ""\n"";"
v1.4.0-windows,return ss.str();
v1.4.0-windows,"read pixels from render target using render thread, then compress the result into PNG"
v1.4.0-windows,argument on the thread that calls this method.
v1.4.0-windows,TODO: is below really needed?
v1.4.0-windows,make sure we are not on the rendering thread
v1.4.0-windows,TODO: below doesn't work right now because it must be running in game thread
v1.4.0-windows,below is documented method but more expensive because it forces flush
v1.4.0-windows,wait for render thread to pick up our task
v1.4.0-windows,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.4.0-windows,capture CameraPose for this frame
v1.4.0-windows,The completion is called immeidately after GameThread sends the
v1.4.0-windows,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.4.0-windows,execute *immediately* after RenderThread renders the scene!
v1.4.0-windows,"while we're still on GameThread, enqueue request for capture the scene!"
v1.4.0-windows,wait for this task to complete
v1.4.0-windows,log a message and continue wait
v1.4.0-windows,lamda function still references a few objects for which there is no refcount.
v1.4.0-windows,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.4.0-windows,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.4.0-windows,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.4.0-windows,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.4.0-windows,Fill out your copyright notice in the Description page of Project Settings.
v1.4.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.4.0-windows,UWorld* World = GetWorld();
v1.4.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.4.0-windows,still need the menu class for f10
v1.4.0-windows,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v1.4.0-windows,showWeatherMenu(WorldContextObject);
v1.4.0-windows,"if weather is not enabled, dont allow any weather values to be set"
v1.4.0-windows,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v1.4.0-windows,and must be set to true or false before this.
v1.4.0-windows,WeatherEnabled will always be false
v1.4.0-windows,"NOTE: weather enabled must be set first, before other params for this to work"
v1.4.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.4.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.4.0-windows,"get all menu actors, if any"
v1.4.0-windows,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.4.0-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.4.0-windows,"get all menu actors, if any"
v1.4.0-windows,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.4.0-windows,"get all menu actors, if any, then hide the menu"
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,Stuff to filter out XInput devices
v1.4.0-windows,-----------------------------------------------------------------------------
v1.4.0-windows,"Defines, constants, and global variables"
v1.4.0-windows,-----------------------------------------------------------------------------
v1.4.0-windows,Magnitude ranges from -1 to 1
v1.4.0-windows,Strength ranges from 0 to 1
v1.4.0-windows,Autocenter
v1.4.0-windows,Rumble
v1.4.0-windows,Register with the DirectInput subsystem and get a pointer
v1.4.0-windows,to a IDirectInput interface we can use.
v1.4.0-windows,Create a DInput object
v1.4.0-windows,Look for a simple joystick we can use for this sample program.
v1.4.0-windows,Make sure we got a joystick
v1.4.0-windows,"Set the data format to ""simple joystick"" - a predefined data format"
v1.4.0-windows,
v1.4.0-windows,"A data format specifies which controls on a device we are interested in,"
v1.4.0-windows,and how they should be reported. This tells DInput that we will be
v1.4.0-windows,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.4.0-windows,Set the cooperative level to let DInput know how this device should
v1.4.0-windows,interact with the system and with other DInput applications.
v1.4.0-windows,Enumerate the joystick objects. The callback function enabled user
v1.4.0-windows,"interface elements for objects that are found, and sets the min/max"
v1.4.0-windows,values property for discovered axes.
v1.4.0-windows,-----------------------------------------------------------------------------
v1.4.0-windows,Enum each PNP device using WMI and check each device ID to see if it contains
v1.4.0-windows,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.4.0-windows,Unfortunately this information can not be found by just using DirectInput.
v1.4.0-windows,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.4.0-windows,XInput devices.
v1.4.0-windows,
v1.4.0-windows,This function stores the list of xinput devices in a linked list
v1.4.0-windows,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.4.0-windows,-----------------------------------------------------------------------------
v1.4.0-windows,CoInit if needed
v1.4.0-windows,Create WMI
v1.4.0-windows,Create BSTRs for WMI
v1.4.0-windows,Connect to WMI
v1.4.0-windows,Switch security level to IMPERSONATE
v1.4.0-windows,Get list of Win32_PNPEntity devices
v1.4.0-windows,Loop over all devices
v1.4.0-windows,Get 20 at a time
v1.4.0-windows,"For each device, get its device ID"
v1.4.0-windows,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.4.0-windows,Unfortunately this information can not be found by just using DirectInput
v1.4.0-windows,"If it does, then get the VID/PID from var.bstrVal"
v1.4.0-windows,Add the VID/PID to a linked list
v1.4.0-windows,-----------------------------------------------------------------------------
v1.4.0-windows,Returns true if the DirectInput device is also an XInput device.
v1.4.0-windows,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.4.0-windows,-----------------------------------------------------------------------------
v1.4.0-windows,Check each xinput device to see if this device's vid/pid matches
v1.4.0-windows,-----------------------------------------------------------------------------
v1.4.0-windows,Cleanup needed for IsXInputDevice()
v1.4.0-windows,-----------------------------------------------------------------------------
v1.4.0-windows,Cleanup linked list
v1.4.0-windows,-----------------------------------------------------------------------------
v1.4.0-windows,Name: EnumJoysticksCallback()
v1.4.0-windows,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.4.0-windows,device interface on it so we can play with it.
v1.4.0-windows,-----------------------------------------------------------------------------
v1.4.0-windows,Skip anything other than the perferred joystick device as defined by the control panel.
v1.4.0-windows,Instead you could store all the enumerated joysticks and let the user pick.
v1.4.0-windows,Obtain an interface to the enumerated joystick.
v1.4.0-windows,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.4.0-windows,it while we were in the middle of enumerating it.)
v1.4.0-windows,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.4.0-windows,could store all the enumerated joysticks and let the user pick.
v1.4.0-windows,-----------------------------------------------------------------------------
v1.4.0-windows,Name: EnumObjectsCallback()
v1.4.0-windows,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.4.0-windows,joystick. This function enables user interface elements for objects
v1.4.0-windows,"that are found to exist, and scales axes min/max values."
v1.4.0-windows,-----------------------------------------------------------------------------
v1.4.0-windows,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.4.0-windows,enumerated axis in order to scale min/max values.
v1.4.0-windows,Set the range for the axis
v1.4.0-windows,Set the UI to reflect what objects the joystick supports
v1.4.0-windows,-----------------------------------------------------------------------------
v1.4.0-windows,Name: UpdateInputState()
v1.4.0-windows,Desc: Get the input device's state and display it.
v1.4.0-windows,-----------------------------------------------------------------------------
v1.4.0-windows,Poll the device to read the current state
v1.4.0-windows,DInput is telling us that the input stream has been
v1.4.0-windows,"interrupted. We aren't tracking any state between polls, so"
v1.4.0-windows,we don't have any special reset that needs to be done. We
v1.4.0-windows,just re-acquire and try again.
v1.4.0-windows,while (hr == DIERR_INPUTLOST)
v1.4.0-windows,hr = g_pJoystick->Acquire();
v1.4.0-windows,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.4.0-windows,may occur when the app is minimized or in the process of
v1.4.0-windows,"switching, so just try again later"
v1.4.0-windows,Get the input's device state
v1.4.0-windows,Axes
v1.4.0-windows,Slider controls
v1.4.0-windows,Points of view
v1.4.0-windows,Buttons
v1.4.0-windows,-----------------------------------------------------------------------------
v1.4.0-windows,Name: FreeDirectInput()
v1.4.0-windows,Desc: Initialize the DirectInput variables.
v1.4.0-windows,-----------------------------------------------------------------------------
v1.4.0-windows,Unacquire the device one last time just in case
v1.4.0-windows,the app tried to exit while the device is still acquired.
v1.4.0-windows,Release any DirectInput objects.
v1.4.0-windows,nop
v1.4.0-windows,normalize min to max --> 0 to 1
v1.4.0-windows,normalize 0 to 1 --> -1 to 1
v1.4.0-windows,#include <libudev.h>
v1.4.0-windows,implementation for unsupported OS
v1.4.0-windows,if this is new index
v1.4.0-windows,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.4.0-windows,close previous one
v1.4.0-windows,open new device
v1.4.0-windows,if open was successful
v1.4.0-windows,read the device
v1.4.0-windows,if we didn't had valid read
v1.4.0-windows,"NOTE if this condition is not met, we're probably out of sync and this"
v1.4.0-windows,Joystick instance is likely unusable
v1.4.0-windows,TODO: set below to false?
v1.4.0-windows,state.is_valid = false;
v1.4.0-windows,else ignore
v1.4.0-windows,TODO: implement this for linux
v1.4.0-windows,TODO: implement this for linux
v1.4.0-windows,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.4.0-windows,{
v1.4.0-windows,"manufacturerID = productID = """";"
v1.4.0-windows,// Use udev to look up the product and manufacturer IDs
v1.4.0-windows,struct udev *udev = udev_new();
v1.4.0-windows,if (udev) {
v1.4.0-windows,char sysname[32];
v1.4.0-windows,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.4.0-windows,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.4.0-windows,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.4.0-windows,if (!dev)
v1.4.0-windows,{
v1.4.0-windows,"message = ""Unable to find parent USB device"";"
v1.4.0-windows,return false;
v1.4.0-windows,}
v1.4.0-windows,std::stringstream ss;
v1.4.0-windows,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.4.0-windows,ss >> manufacturerID;
v1.4.0-windows,ss.clear();
v1.4.0-windows,"ss.str("""");"
v1.4.0-windows,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.4.0-windows,ss >> productID;
v1.4.0-windows,udev_device_unref(dev);
v1.4.0-windows,}
v1.4.0-windows,else
v1.4.0-windows,{
v1.4.0-windows,"message = ""Cannot create udev"";"
v1.4.0-windows,return false;
v1.4.0-windows,}
v1.4.0-windows,udev_unref(udev);
v1.4.0-windows,return true;
v1.4.0-windows,}
v1.4.0-windows,required for pimpl
v1.4.0-windows,TODO: anyway to workaround const_cast?
v1.4.0-windows,FGenericPlatformMisc::PlatformInit();
v1.4.0-windows,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.4.0-windows,TODO: index check
v1.4.0-windows,create main widget
v1.4.0-windows,synchronize PIP views
v1.4.0-windows,TODO: should we only do below on SceneCapture2D components and cameras?
v1.4.0-windows,avoid motion blur so capture images don't get
v1.4.0-windows,use two different methods to set console var because sometime it doesn't seem to work
v1.4.0-windows,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.4.0-windows,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.4.0-windows,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.4.0-windows,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.4.0-windows,setup defaults
v1.4.0-windows,Attempts to parse the settings text from one of multiple locations.
v1.4.0-windows,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.4.0-windows,"Next, check the executable's working directory for the settings file."
v1.4.0-windows,"Finally, check the user's documents folder."
v1.4.0-windows,"If the settings file cannot be read, throw an exception"
v1.4.0-windows,Attempts to parse the settings file path or the settings text from the command line
v1.4.0-windows,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.4.0-windows,"Example (Path): AirSim.exe --settings ""C:\path\to\settings.json"""
v1.4.0-windows,"Example (Text): AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.4.0-windows,"Returns true if the argument is present, false otherwise."
v1.4.0-windows,build image file name
v1.4.0-windows,write image file
v1.4.0-windows,write to CSV file
v1.4.0-windows,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.4.0-windows,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.4.0-windows,make sire all vars are set up
v1.4.0-windows,"TODO: should we go as fast as possible, or should we limit this to a particular number of"
v1.4.0-windows,frames per second?
v1.4.0-windows,BG: Workaround to get sync ground truth. See https://github.com/Microsoft/AirSim/issues/1494 for details
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,decide which derived BP to use
v1.4.0-windows,we don't have real vehicle so no vehicle API
v1.4.0-windows,put camera little bit above vehicle
v1.4.0-windows,update ground level
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,let base class setup physics world
v1.4.0-windows,stop physics thread before we dismantle
v1.4.0-windows,setup clock in ClockFactory
v1.4.0-windows,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.4.0-windows,steppable clock returns interval that is a constant number irrespective of wall clock
v1.4.0-windows,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.4.0-windows,but that would cause vehicles like quadrotors to become unstable
v1.4.0-windows,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.4.0-windows,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.4.0-windows,get increase in clock speed
v1.4.0-windows,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.4.0-windows,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.4.0-windows,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.4.0-windows,Approach 2: scale control loop frequency if clock is speeded up
v1.4.0-windows,"for slowing down, this don't generate instability"
v1.4.0-windows,-------------------------------- overrides -----------------------------------------------//
v1.4.0-windows,decide which derived BP to use
v1.4.0-windows,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.4.0-windows,vehicle_sim_api->reset();
v1.4.0-windows,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.4.0-windows,create vehicle API
v1.4.0-windows,setup physics vehicle
v1.4.0-windows,initialize private vars
v1.4.0-windows,calls to update* are handled by physics engine and in SimModeWorldBase
v1.4.0-windows,"Utils::log(""------Render tick-------"");"
v1.4.0-windows,"if reset is pending then do it first, no need to do other things until next tick"
v1.4.0-windows,move collision info from rendering engine to vehicle
v1.4.0-windows,update rotor poses
v1.4.0-windows,if we did reset then don't worry about synchronizing states for this tick
v1.4.0-windows,Continue to wait for reset
v1.4.0-windows,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.4.0-windows,*** Start: UpdatableState implementation ***//
v1.4.0-windows,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.4.0-windows,environment update for current position
v1.4.0-windows,update forces on vertices
v1.4.0-windows,update to controller must be done after kinematics have been updated by physics engine
v1.4.0-windows,*** End: UpdatableState implementation ***//
v1.4.0-windows,get references of existing camera
v1.4.0-windows,setup clock in PhysX
v1.4.0-windows,-------------------------------- overrides -----------------------------------------------//
v1.4.0-windows,decide which derived BP to use
v1.4.0-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.4.0-windows,Setup suspension forces
v1.4.0-windows,Find the tire object and set the data for it
v1.4.0-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.4.0-windows,Setup suspension forces
v1.4.0-windows,Find the tire object and set the data for it
v1.4.0-windows,Create In-Car camera component
v1.4.0-windows,In car HUD
v1.4.0-windows,Create text render component for in car speed display
v1.4.0-windows,Create text render component for in car gear display
v1.4.0-windows,Setup the audio component and allocate it a sound cue
v1.4.0-windows,Colors for the in-car gear display. One for normal one for reverse
v1.4.0-windows,Wheels/Tires
v1.4.0-windows,Setup the wheels
v1.4.0-windows,Adjust the tire loading
v1.4.0-windows,Engine
v1.4.0-windows,Torque setup
v1.4.0-windows,Adjust the steering
v1.4.0-windows,Transmission
v1.4.0-windows,We want 4wd
v1.4.0-windows,Drive the front wheels a little more than the rear
v1.4.0-windows,Automatic gearbox
v1.4.0-windows,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.4.0-windows,Physics settings
v1.4.0-windows,Adjust the center of mass - the buggy is quite low
v1.4.0-windows,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.4.0-windows,put camera little bit above vehicle
v1.4.0-windows,update physics material
v1.4.0-windows,Update the strings used in the HUD (in-car and on-screen)
v1.4.0-windows,Set the string in the in-car HUD
v1.4.0-windows,Pass the engine RPM to the sound component
v1.4.0-windows,Start an engine sound playing
v1.4.0-windows,Using FText because this is display text that should be localizable
v1.4.0-windows,Setup the text render component strings
v1.4.0-windows,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.4.0-windows,below is not needed
v1.4.0-windows,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.4.0-windows,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.4.0-windows,TODO: should do reset() here?
v1.4.0-windows,create vehicle params
v1.4.0-windows,these are called on render ticks
v1.4.0-windows,TODO: do we need this for cars?
v1.4.0-windows,TODO: move this to SimModeBase?
v1.4.0-windows,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.4.0-windows,reset();
v1.4.0-windows,return;
v1.4.0-windows,}
v1.4.0-windows,Thrustmaster devices
v1.4.0-windows,"Anything else, typically Logitech G920 wheel"
v1.4.0-windows,Two steel levers behind wheel
v1.4.0-windows,if API-client control is not active then we route keyboard/joystick control to car
v1.4.0-windows,all car controls from anywhere must be routed through API component
v1.4.0-windows,*** Start: UpdatableState implementation ***//
v1.4.0-windows,physics tick
v1.4.0-windows,*** End: UpdatableState implementation ***//
v1.4.0-windows,TODO: directly accept getVehicleSimApis() using generic container
v1.4.0-windows,remove everything that we created in BeginPlay
v1.4.0-windows,we use custom debug reporting for this class
v1.4.0-windows,perform any expensive rendering update outside of lock region
v1.4.0-windows,no need to call base reset because of our custom implementation
v1.4.0-windows,TODO: this is going to cause circular references which is fine here but
v1.4.0-windows,in future we should consider moving SimMode not derived from AActor and move
v1.4.0-windows,it to AirLib and directly implement WorldSimApiBase interface
v1.4.0-windows,get player start
v1.4.0-windows,this must be done from within actor otherwise we don't get player start
v1.4.0-windows,Grab player location
v1.4.0-windows,Move the world origin to the player's location (this moves the coordinate system and adds
v1.4.0-windows,a corresponding offset to all positions to compensate for the shift)
v1.4.0-windows,"Regrab the player's position after the offset has been added (which should be 0,0,0 now)"
v1.4.0-windows,UWeatherLib::showWeatherMenu(World);
v1.4.0-windows,else don't init
v1.4.0-windows,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v1.4.0-windows,tod_sim_clock_start_ needs to be reset here.
v1.4.0-windows,Going from enabled to disabled
v1.4.0-windows,do these in the end to ensure that advanceTimeOfDay() doesn't see
v1.4.0-windows,any inconsistent state.
v1.4.0-windows,should be overridden by derived class
v1.4.0-windows,should be overridden by derived class
v1.4.0-windows,should be overridden by derived class
v1.4.0-windows,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.4.0-windows,default setup - this should be overridden in derived modes as needed
v1.4.0-windows,setup clock in ClockFactory
v1.4.0-windows,default implementation
v1.4.0-windows,create director
v1.4.0-windows,create external camera required for the director
v1.4.0-windows,API server start/stop
v1.4.0-windows,get UU origin of global NED frame
v1.4.0-windows,determine camera director camera default pose and spawn it
v1.4.0-windows,find all vehicle pawns
v1.4.0-windows,add vehicles from settings
v1.4.0-windows,if vehicle is of type for derived SimMode and auto creatable
v1.4.0-windows,compute initial pose
v1.4.0-windows,spawn vehicle pawn
v1.4.0-windows,create API objects for each pawn we have
v1.4.0-windows,create vehicle sim api
v1.4.0-windows,TODO: better handle no FPV vehicles scenario
v1.4.0-windows,derived class should override this method to retrieve types of pawns they support
v1.4.0-windows,derived class should override this method to retrieve types of pawns they support
v1.4.0-windows,derived class should override this method to retrieve types of pawns they support
v1.4.0-windows,derived class should override this method to retrieve types of pawns they support
v1.4.0-windows,derived class should override this method to retrieve types of pawns they support
v1.4.0-windows,derived class should override this method to retrieve types of pawns they support
v1.4.0-windows,derived class should override this method to retrieve types of pawns they support
v1.4.0-windows,Draws debug-points on main viewport for Lidar laser hits.
v1.4.0-windows,Used for debugging only.
v1.4.0-windows,Currently we are checking the sensor-collection instead of sensor-settings.
v1.4.0-windows,Also using variables to optimize not checking the collection if not needed.
v1.4.0-windows,TODO: Is it incorrect to assume LidarSimple here?
v1.4.0-windows,Draw debug-point on main viewport for Distance sensor hit
v1.4.0-windows,Find position of point hit
v1.4.0-windows,Similar to UnrealDistanceSensor.cpp#L19
v1.4.0-windows,order of Pose addition is important here because it also adds quaternions which is not commutative!
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,ctor
v1.4.0-windows,initializes information based on lidar configuration
v1.4.0-windows,calculate verticle angle distance between each laser
v1.4.0-windows,store vertical angles for each laser
v1.4.0-windows,returns a point-cloud for the tick
v1.4.0-windows,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.4.0-windows,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.4.0-windows,calculate number of points needed for each laser/channel
v1.4.0-windows,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.4.0-windows,calculate needed angle/distance between each point
v1.4.0-windows,normalize FOV start/end
v1.4.0-windows,shoot lasers
v1.4.0-windows,check if the laser is outside the requested horizontal FOV
v1.4.0-windows,"shoot laser and get the impact point, if any"
v1.4.0-windows,simulate shooting a laser via Unreal ray-tracing.
v1.4.0-windows,start position
v1.4.0-windows,We need to compose rotations here rather than rotate a vector by a quaternion
v1.4.0-windows,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.4.0-windows,get ray quaternion in lidar frame (angles must be in radians)
v1.4.0-windows,get ray quaternion in body frame
v1.4.0-windows,get ray quaternion in world frame
v1.4.0-windows,get ray vector (end position)
v1.4.0-windows,Store the segmentation id of the hit object.
v1.4.0-windows,Debug code for very specific cases.
v1.4.0-windows,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.4.0-windows,decide the frame for the point-cloud
v1.4.0-windows,current detault behavior; though it is probably not very useful.
v1.4.0-windows,not changing the default for now to maintain backwards-compat.
v1.4.0-windows,point in vehicle intertial frame
v1.4.0-windows,tranform to lidar frame
v1.4.0-windows,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.4.0-windows,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.4.0-windows,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.4.0-windows,"On the client side, if it is needed to transform this data back to the world frame,"
v1.4.0-windows,"then do the equivalent of following,"
v1.4.0-windows,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.4.0-windows,See SimModeBase::drawLidarDebugPoints()
v1.4.0-windows,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.4.0-windows,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,update ray tracing
v1.4.0-windows,"FString hit_name = FString(""None"");"
v1.4.0-windows,if (dist_hit.GetActor())
v1.4.0-windows,hit_name=dist_hit.GetActor()->GetName();
v1.4.0-windows,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.4.0-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,This assumes you are running DroneServer already on the same machine.
v1.4.0-windows,DroneServer must be running first.
v1.4.0-windows,enable API control
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,move commands
v1.4.0-windows,else leave as it is
v1.4.0-windows,TODO: get these in one call
v1.4.0-windows,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.4.0-windows,TODO: shouldn't we pass folder path?
v1.4.0-windows,parse
v1.4.0-windows,group the images by the current date.
v1.4.0-windows,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.4.0-windows,{
v1.4.0-windows,"return """";"
v1.4.0-windows,}
v1.4.0-windows,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.4.0-windows,{
v1.4.0-windows,return false;
v1.4.0-windows,}
v1.4.0-windows,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.4.0-windows,params.context->client.newTask();
v1.4.0-windows,}
v1.4.0-windows,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.4.0-windows,params.context->client.WaitForCompletion(0);
v1.4.0-windows,}
v1.4.0-windows,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.4.0-windows,{
v1.4.0-windows,}
v1.4.0-windows,parse command line
v1.4.0-windows,Shell callbacks
v1.4.0-windows,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.4.0-windows,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.4.0-windows,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.4.0-windows,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.4.0-windows,Add shell commands
v1.4.0-windows,TODO: add WaitForCompletion command
v1.4.0-windows,"TODO: add command line args help, arg count validation"
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v1.4.0-windows,switch to explicit hover mode so that this is the fall back when
v1.4.0-windows,move* commands are finished.
v1.4.0-windows,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.4.0-windows,TODO: implement weather for Unity
v1.4.0-windows,TODO: implement weather for Unity
v1.4.0-windows,----------------Plotting APIs-----------/
v1.4.0-windows,Recording APIs
v1.4.0-windows,Function pointers to hold the addresses of the functions that are defined in Unity
v1.4.0-windows,"Enabling all LogLevels,"
v1.4.0-windows,"Enabling all LogLevels,"
v1.4.0-windows,delete ltm;
v1.4.0-windows,initialize state
v1.4.0-windows,compute our home point
v1.4.0-windows,default behavior is to call update every tick
v1.4.0-windows,"for custom physics engine, this method should be overridden and update should be"
v1.4.0-windows,called from every physics tick
v1.4.0-windows,these will be available for devices like steering wheels
v1.4.0-windows,sync environment from kinematics
v1.4.0-windows,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.4.0-windows,FVector unrealPosition = getUUPosition();
v1.4.0-windows,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v1.4.0-windows,not implemented
v1.4.0-windows,not implemented
v1.4.0-windows,parameters in NED frame
v1.4.0-windows,allow teleportation
v1.4.0-windows,if collisions are not enabled
v1.4.0-windows,or we have collided but passthrough is enabled
v1.4.0-windows,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.4.0-windows,"without flip flopping, collisions can't be detected"
v1.4.0-windows,by default we update kinematics from UE pawn
v1.4.0-windows,if SimMod uses its own physics engine then this should be overriden
v1.4.0-windows,no default action in this base class
v1.4.0-windows,TODO: because this bug we are using alternative code with stringstream
v1.4.0-windows,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.4.0-windows,update kinematics from pawn's movement instead of physics engine
v1.4.0-windows,TODO: update other fields?
v1.4.0-windows,implements getImages() method in the ImageCaptureBase class.
v1.4.0-windows,update ray tracing
v1.4.0-windows,TODO: index check
v1.4.0-windows,Attempts to parse the settings text from one of multiple locations.
v1.4.0-windows,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.4.0-windows,"Next, check the executable's working directory for the settings file."
v1.4.0-windows,"Finally, check the user's documents folder."
v1.4.0-windows,"If the settings file cannot be read, throw an exception"
v1.4.0-windows,let base class setup physics world
v1.4.0-windows,stop physics thread before we dismantle
v1.4.0-windows,setup clock in ClockFactory
v1.4.0-windows,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.4.0-windows,steppable clock returns interval that is a constant number irrespective of wall clock
v1.4.0-windows,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.4.0-windows,but that would cause vehicles like quadrotors to become unstable
v1.4.0-windows,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.4.0-windows,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.4.0-windows,get increase in clock speed
v1.4.0-windows,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.4.0-windows,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.4.0-windows,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.4.0-windows,Approach 2: scale control loop frequency if clock is speeded up
v1.4.0-windows,"for slowing down, this don't generate instability"
v1.4.0-windows,-------------------------------- overrides -----------------------------------------------//
v1.4.0-windows,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.4.0-windows,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.4.0-windows,create vehicle API
v1.4.0-windows,setup physics vehicle
v1.4.0-windows,initialize private vars
v1.4.0-windows,"if reset is pending then do it first, no need to do other things until next tick"
v1.4.0-windows,move collision info from rendering engine to vehicle
v1.4.0-windows,update rotor poses
v1.4.0-windows,if we did reset then don't worry about synchronizing states for this tick
v1.4.0-windows,Continue to wait for reset
v1.4.0-windows,*** Start: UpdatableState implementation ***//
v1.4.0-windows,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.4.0-windows,environment update for current position
v1.4.0-windows,update forces on vertices
v1.4.0-windows,update to controller must be done after kinematics have been updated by physics engine
v1.4.0-windows,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.4.0-windows,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.4.0-windows,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.4.0-windows,*** End: UpdatableState implementation ***//
v1.4.0-windows,TODO: should do reset() here?
v1.4.0-windows,these are called on render ticks
v1.4.0-windows,TODO: do we need this for cars?
v1.4.0-windows,Thrustmaster devices
v1.4.0-windows,"Anything else, typically Logitech G920 wheel"
v1.4.0-windows,Two steel levers behind wheel
v1.4.0-windows,if API-client control is not active then we route keyboard/joystick control to car
v1.4.0-windows,all car controls from anywhere must be routed through API component
v1.4.0-windows,*** Start: UpdatableState implementation ***//
v1.4.0-windows,physics tick
v1.4.0-windows,void CarPawnSimApi::reportState(StateReporter& reporter)
v1.4.0-windows,{
v1.4.0-windows,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.4.0-windows,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.4.0-windows,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.4.0-windows,}
v1.4.0-windows,*** End: UpdatableState implementation ***//
v1.4.0-windows,remove everything that we created in BeginPlay
v1.4.0-windows,we use custom debug reporting for this class
v1.4.0-windows,perform any expensive rendering update outside of lock region
v1.4.0-windows,no need to call base reset because of our custom implementation
v1.4.0-windows,should be overridden by derived class
v1.4.0-windows,should be overridden by derived class
v1.4.0-windows,commenting this out for now to avoid unintentional Unity startup failure
v1.4.0-windows,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v1.4.0-windows,should be overridden by derived class
v1.4.0-windows,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.4.0-windows,default setup - this should be overridden in derived modes as needed
v1.4.0-windows,setup clock in ClockFactory
v1.4.0-windows,API server start/stop
v1.4.0-windows,determine camera director camera default pose and spawn it
v1.4.0-windows,derived class should override this method to retrieve types of pawns they support
v1.4.0-windows,derived class should override this method to retrieve types of pawns they support
v1.4.0-windows,60 acres park:
v1.4.0-windows,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.4.0-windows,marymoore park
v1.4.0-windows,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.4.0-windows,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.4.0-windows,DepthNavThreshold depthNav;
v1.4.0-windows,DepthNavOptAStar depthNav;
v1.4.0-windows,DepthNavThreshold depthNav;
v1.4.0-windows,DepthNavOptAStar depthNav;
v1.4.0-windows,Cleanup
v1.4.0-windows,runDepthNavGT();
v1.4.0-windows,runDepthNavSGM();
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,by Sudipta Sinha
v1.4.0-windows,adapted for AirSim by Matthias Mueller
v1.4.0-windows,first row
v1.4.0-windows,last row
v1.4.0-windows,Local quadratic fit of cost and subpixel refinement.
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,by Sudipta Sinha
v1.4.0-windows,adapted for AirSim by Matthias Mueller
v1.4.0-windows,uint64_t x64 = (uint64_t)x;
v1.4.0-windows,uint64_t y64 = (uint64_t)y;
v1.4.0-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-windows,Licensed under the MIT License.
v1.4.0-windows,by Sudipta Sinha
v1.4.0-windows,adapted for AirSim by Matthias Mueller
v1.4.0-windows,ensure that disparity range is a multiple of 8
v1.4.0-windows,sgm stereo
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,read settings and override defaults
v1.4.0-linux,allow json overrides on a per-vehicle basis.
v1.4.0-linux,start server in async mode
v1.4.0-linux,check messages
v1.4.0-linux,plot red arrows for 30 seconds
v1.4.0-linux,plot magenta arrows for 15 seconds
v1.4.0-linux,plot red arrows for 10 seconds
v1.4.0-linux,plot 2 white arrows which are persistent
v1.4.0-linux,plot points
v1.4.0-linux,"plot line strip. 0-1, 1-2, 2-3"
v1.4.0-linux,"plot line list. 0-1, 2-3, 4-5. Must be even."
v1.4.0-linux,plot transforms
v1.4.0-linux,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=0.0, yaw=yaw)) for x, y, yaw in zip(np.linspace(0,10,10), np.linspace(0,0,10), np.linspace(0,np.pi,10))],"
v1.4.0-linux,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.4.0-linux,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=roll, yaw=0.0)) for x, y, roll in zip(np.linspace(0,10,10), np.linspace(1,1,10), np.linspace(0,np.pi,10))],"
v1.4.0-linux,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.4.0-linux,In settings.json first activate computer vision mode:
v1.4.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.4.0-linux,monitor car state while you drive it manually.
v1.4.0-linux,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v1.4.0-linux,denominator from microns^3 to microns * m^2)
v1.4.0-linux,First set everything to 0.
v1.4.0-linux,Next set all objects of interest provided to corresponding object IDs
v1.4.0-linux,segIdDict values MUST match tempEmissivityNew labels.
v1.4.0-linux,"Connect to AirSim, UAV mode."
v1.4.0-linux,Choose temperature values for winter or summer.
v1.4.0-linux,""""""""
v1.4.0-linux,winter
v1.4.0-linux,""""""""
v1.4.0-linux,summer
v1.4.0-linux,Read camera response.
v1.4.0-linux,Calculate radiance.
v1.4.0-linux,Set IDs in AirSim environment.
v1.4.0-linux,In settings.json first activate computer vision mode:
v1.4.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.4.0-linux,"define abstract class to return next vector in the format (x,y,yaw)"
v1.4.0-linux,"compute vector, distance and angle to goal"
v1.4.0-linux,compute box of interest
v1.4.0-linux,scale by weight matrix (optional)
v1.4.0-linux,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.4.0-linux,detect collision
v1.4.0-linux,compute box of interest
v1.4.0-linux,detect collision
v1.4.0-linux,Same as above but decide to go left or right based on average or some metric like that
v1.4.0-linux,"compute resultant normalized vector, distance and angle"
v1.4.0-linux,compute bounding box size
v1.4.0-linux,convert horizonal fov to vertical fov
v1.4.0-linux,matrix with all ones
v1.4.0-linux,matrix with max weight in center and decreasing linearly with distance from center
v1.4.0-linux,matrix with max weight in center and decreasing quadratically with distance from center
v1.4.0-linux,"print (""Saving images to %s"" % tmp_dir)"
v1.4.0-linux,airsim.wait_key('Press any key to start')
v1.4.0-linux,"Define start position, goal and size of UAV"
v1.4.0-linux,Define parameters and thresholds
v1.4.0-linux,initial position
v1.4.0-linux,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.4.0-linux,time.sleep(1)
v1.4.0-linux,get response
v1.4.0-linux,get numpy array
v1.4.0-linux,reshape array to 2D array H X W
v1.4.0-linux,write to png
v1.4.0-linux,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.4.0-linux,pose = client.simGetPose()
v1.4.0-linux,pp.pprint(pose)
v1.4.0-linux,time.sleep(5)
v1.4.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.4.0-linux,################### OLD CODE
v1.4.0-linux,timer = 0
v1.4.0-linux,time_obs = 50
v1.4.0-linux,bObstacle = False
v1.4.0-linux,if (bObstacle):
v1.4.0-linux,timer = timer + 1
v1.4.0-linux,if timer > time_obs:
v1.4.0-linux,bObstacle = False
v1.4.0-linux,timer = 0
v1.4.0-linux,else:
v1.4.0-linux,yaw = target_angle
v1.4.0-linux,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.4.0-linux,if (np.average(img2d_box) < coll_thres):
v1.4.0-linux,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.4.0-linux,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.4.0-linux,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.4.0-linux,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.4.0-linux,"print('left: ', img2d_box_l_avg)"
v1.4.0-linux,"print('right: ', img2d_box_r_avg)"
v1.4.0-linux,if img2d_box_l_avg > img2d_box_r_avg:
v1.4.0-linux,##Go LEFT
v1.4.0-linux,#y_offset = y_offset-1
v1.4.0-linux,yaw = yaw - radians(10)
v1.4.0-linux,bObstacle = True
v1.4.0-linux,else:
v1.4.0-linux,##Go RIGHT
v1.4.0-linux,#y_offset = y_offset+1
v1.4.0-linux,yaw = yaw + radians(10)
v1.4.0-linux,bObstacle = true
v1.4.0-linux,"print('yaw: ', yaw)"
v1.4.0-linux,In settings.json first activate computer vision mode:
v1.4.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.4.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.4.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.4.0-linux,pip install opencv-python
v1.4.0-linux,In settings.json first activate computer vision mode:
v1.4.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.4.0-linux,In settings.json first activate computer vision mode:
v1.4.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.4.0-linux,for block environment
v1.4.0-linux,regex are case insensitive
v1.4.0-linux,#for neighborhood environment
v1.4.0-linux,set object ID for sky
v1.4.0-linux,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.4.0-linux,get segmentation image in various formats
v1.4.0-linux,save segmentation images in various formats
v1.4.0-linux,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.4.0-linux,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.4.0-linux,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v1.4.0-linux,find unique colors
v1.4.0-linux,In settings.json first activate computer vision mode:
v1.4.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.4.0-linux,objects can be named in two ways:
v1.4.0-linux,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.4.0-linux,default name is auto-generated and varies from run-to-run.
v1.4.0-linux,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.4.0-linux,
v1.4.0-linux,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.4.0-linux,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.4.0-linux,https://answers.unrealengine.com/revisions/790629.html
v1.4.0-linux,below works in Blocks environment
v1.4.0-linux,------------------------------------ Get current pose ------------------------------------------------
v1.4.0-linux,search object by name:
v1.4.0-linux,search another object by tag
v1.4.0-linux,search non-existent object
v1.4.0-linux,------------------------------------ Set new pose ------------------------------------------------
v1.4.0-linux,here we move with teleport enabled so collisions are ignored
v1.4.0-linux,here we move with teleport enabled so collisions are not ignored
v1.4.0-linux,move non-existent object
v1.4.0-linux,------------------------------------ Get new pose ------------------------------------------------
v1.4.0-linux,search another object by tag
v1.4.0-linux,search non-existent object
v1.4.0-linux,Import this module to automatically setup path to local airsim module
v1.4.0-linux,This module first tries to see if airsim module is installed via pip
v1.4.0-linux,If it does then we don't do anything else
v1.4.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.4.0-linux,and if it does then we add that in sys.path
v1.4.0-linux,this class simply tries to see if airsim
v1.4.0-linux,if airsim module is installed then don't do anything else
v1.4.0-linux,import pkgutil
v1.4.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.4.0-linux,if airsim_loader is not None:
v1.4.0-linux,return
v1.4.0-linux,"Roll is applied first, then pitch, then yaw."
v1.4.0-linux,Turn the camera position into a column vector.
v1.4.0-linux,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v1.4.0-linux,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v1.4.0-linux,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v1.4.0-linux,Recreate the perspective projection of the camera.
v1.4.0-linux,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v1.4.0-linux,Set pose and sleep after to ensure the pose sticks before capturing image.
v1.4.0-linux,Capture segmentation (IR) and scene images.
v1.4.0-linux,Change images into numpy arrays.
v1.4.0-linux,Capture images for a certain amount of time in seconds (half hour now)
v1.4.0-linux,Capture image - pose.position x_val access may change w/ AirSim
v1.4.0-linux,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v1.4.0-linux,Convert color scene image to BGR for write out with cv2.
v1.4.0-linux,"Connect to AirSim, UAV mode."
v1.4.0-linux,Look for objects with names that match a regular expression.
v1.4.0-linux,"Sample calls to main, varying camera angle and altitude."
v1.4.0-linux,"straight down, 400ft"
v1.4.0-linux,"straight down, 200ft"
v1.4.0-linux,"45 degrees, 200ft -- note that often object won't be scene since position"
v1.4.0-linux,is set exactly to object's
v1.4.0-linux,"45 degrees, 400ft -- note that often object won't be scene since position"
v1.4.0-linux,is set exactly to object's
v1.4.0-linux,In settings.json first activate computer vision mode:
v1.4.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.4.0-linux,xn = 1 + x*5  # some random number
v1.4.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,monitor car state while you drive it manually.
v1.4.0-linux,get state of the car
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,go forward
v1.4.0-linux,get state of the car
v1.4.0-linux,Python client example to change time-of-day using APIs
v1.4.0-linux,
v1.4.0-linux,Changes time of the day and makes the car move around
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,flip between specific time and default time
v1.4.0-linux,go forward
v1.4.0-linux,Go forward + steer right
v1.4.0-linux,main
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,get state of the car
v1.4.0-linux,go forward
v1.4.0-linux,Go forward + steer right
v1.4.0-linux,go reverse
v1.4.0-linux,apply brakes
v1.4.0-linux,get camera images from the car
v1.4.0-linux,restore to original state
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,go forward
v1.4.0-linux,Python client example to get Lidar data from a car
v1.4.0-linux,
v1.4.0-linux,Makes the drone fly and get Lidar data
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,"print(""state: %s"" % s)"
v1.4.0-linux,go forward
v1.4.0-linux,Go forward + steer right
v1.4.0-linux,"reshape array of floats to array of [X,Y,Z]"
v1.4.0-linux,TODO
v1.4.0-linux,main
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,get state of the car
v1.4.0-linux,go forward
v1.4.0-linux,Go forward + steer right
v1.4.0-linux,go reverse
v1.4.0-linux,apply breaks
v1.4.0-linux,restore to original state
v1.4.0-linux,Import this module to automatically setup path to local airsim module
v1.4.0-linux,This module first tries to see if airsim module is installed via pip
v1.4.0-linux,If it does then we don't do anything else
v1.4.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.4.0-linux,and if it does then we add that in sys.path
v1.4.0-linux,this class simply tries to see if airsim
v1.4.0-linux,if airsim module is installed then don't do anything else
v1.4.0-linux,import pkgutil
v1.4.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.4.0-linux,if airsim_loader is not None:
v1.4.0-linux,return
v1.4.0-linux,Use below in settings.json with blocks environment
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,get state of the car
v1.4.0-linux,go forward
v1.4.0-linux,go reverse
v1.4.0-linux,apply breaks
v1.4.0-linux,get camera images from the car
v1.4.0-linux,restore to original state
v1.4.0-linux,from keras.models import load_model
v1.4.0-linux,if (len(sys.argv) != 2):
v1.4.0-linux,print('usage: python drive.py <modelName>')
v1.4.0-linux,sys.exit()
v1.4.0-linux,print('Loading model...')
v1.4.0-linux,model = load_model(sys.argv[1])
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.4.0-linux,"model_output = model.predict([image_buf, state_buf])"
v1.4.0-linux,car_controls.steering = float(model_output[0][0])
v1.4.0-linux,-*- coding: utf-8 -*-
v1.4.0-linux,
v1.4.0-linux,Configuration file for the Sphinx documentation builder.
v1.4.0-linux,
v1.4.0-linux,This file does only contain a selection of the most common options. For a
v1.4.0-linux,full list see the documentation:
v1.4.0-linux,http://www.sphinx-doc.org/en/master/config
v1.4.0-linux,-- Path setup --------------------------------------------------------------
v1.4.0-linux,"If extensions (or modules to document with autodoc) are in another directory,"
v1.4.0-linux,add these directories to sys.path here. If the directory is relative to the
v1.4.0-linux,"documentation root, use os.path.abspath to make it absolute, like shown here."
v1.4.0-linux,
v1.4.0-linux,-- Project information -----------------------------------------------------
v1.4.0-linux,The short X.Y version
v1.4.0-linux,"The full version, including alpha/beta/rc tags"
v1.4.0-linux,-- General configuration ---------------------------------------------------
v1.4.0-linux,"If your documentation needs a minimal Sphinx version, state it here."
v1.4.0-linux,
v1.4.0-linux,needs_sphinx = '1.0'
v1.4.0-linux,"Add any Sphinx extension module names here, as strings. They can be"
v1.4.0-linux,extensions coming with Sphinx (named 'sphinx.ext.*') or your custom
v1.4.0-linux,ones.
v1.4.0-linux,"Add any paths that contain templates here, relative to this directory."
v1.4.0-linux,The suffix(es) of source filenames.
v1.4.0-linux,You can specify multiple suffix as a list of string:
v1.4.0-linux,
v1.4.0-linux,"source_suffix = ['.rst', '.md']"
v1.4.0-linux,The master toctree document.
v1.4.0-linux,The language for content autogenerated by Sphinx. Refer to documentation
v1.4.0-linux,for a list of supported languages.
v1.4.0-linux,
v1.4.0-linux,This is also used if you do content translation via gettext catalogs.
v1.4.0-linux,"Usually you set ""language"" from the command line for these cases."
v1.4.0-linux,"List of patterns, relative to source directory, that match files and"
v1.4.0-linux,directories to ignore when looking for source files.
v1.4.0-linux,This pattern also affects html_static_path and html_extra_path.
v1.4.0-linux,The name of the Pygments (syntax highlighting) style to use.
v1.4.0-linux,-- Options for HTML output -------------------------------------------------
v1.4.0-linux,The theme to use for HTML and HTML Help pages.  See the documentation for
v1.4.0-linux,a list of builtin themes.
v1.4.0-linux,
v1.4.0-linux,html_theme = 'alabaster'
v1.4.0-linux,Theme options are theme-specific and customize the look and feel of a theme
v1.4.0-linux,"further.  For a list of options available for each theme, see the"
v1.4.0-linux,documentation.
v1.4.0-linux,
v1.4.0-linux,html_theme_options = {}
v1.4.0-linux,"Add any paths that contain custom static files (such as style sheets) here,"
v1.4.0-linux,"relative to this directory. They are copied after the builtin static files,"
v1.4.0-linux,"so a file named ""default.css"" will overwrite the builtin ""default.css""."
v1.4.0-linux,"Custom sidebar templates, must be a dictionary that maps document names"
v1.4.0-linux,to template names.
v1.4.0-linux,
v1.4.0-linux,The default sidebars (for documents that don't match any pattern) are
v1.4.0-linux,defined by theme itself.  Builtin themes are using these templates by
v1.4.0-linux,"default: ``['localtoc.html', 'relations.html', 'sourcelink.html',"
v1.4.0-linux,'searchbox.html']``.
v1.4.0-linux,
v1.4.0-linux,html_sidebars = {}
v1.4.0-linux,-- Options for HTMLHelp output ---------------------------------------------
v1.4.0-linux,Output file base name for HTML help builder.
v1.4.0-linux,-- Options for LaTeX output ------------------------------------------------
v1.4.0-linux,The paper size ('letterpaper' or 'a4paper').
v1.4.0-linux,
v1.4.0-linux,"'papersize': 'letterpaper',"
v1.4.0-linux,"The font size ('10pt', '11pt' or '12pt')."
v1.4.0-linux,
v1.4.0-linux,"'pointsize': '10pt',"
v1.4.0-linux,Additional stuff for the LaTeX preamble.
v1.4.0-linux,
v1.4.0-linux,"'preamble': '',"
v1.4.0-linux,Latex figure (float) alignment
v1.4.0-linux,
v1.4.0-linux,"'figure_align': 'htbp',"
v1.4.0-linux,Grouping the document tree into LaTeX files. List of tuples
v1.4.0-linux,"(source start file, target name, title,"
v1.4.0-linux,"author, documentclass [howto, manual, or own class])."
v1.4.0-linux,-- Options for manual page output ------------------------------------------
v1.4.0-linux,One entry per manual page. List of tuples
v1.4.0-linux,"(source start file, name, description, authors, manual section)."
v1.4.0-linux,-- Options for Texinfo output ----------------------------------------------
v1.4.0-linux,Grouping the document tree into Texinfo files. List of tuples
v1.4.0-linux,"(source start file, target name, title, author,"
v1.4.0-linux,"dir menu entry, description, category)"
v1.4.0-linux,-- Options for Epub output -------------------------------------------------
v1.4.0-linux,Bibliographic Dublin Core info.
v1.4.0-linux,The unique identifier of the text. This can be a ISBN number
v1.4.0-linux,or the project homepage.
v1.4.0-linux,
v1.4.0-linux,epub_identifier = ''
v1.4.0-linux,A unique identification for the text.
v1.4.0-linux,
v1.4.0-linux,epub_uid = ''
v1.4.0-linux,A list of files that should not be packed into the epub file.
v1.4.0-linux,-- Extension configuration -------------------------------------------------
v1.4.0-linux,-- Options for intersphinx extension ---------------------------------------
v1.4.0-linux,Example configuration for intersphinx: refer to the Python standard library.
v1.4.0-linux,-- Options for todo extension ----------------------------------------------
v1.4.0-linux,"If true, `todo` and `todoList` produce output, else they produce nothing."
v1.4.0-linux,We ignore the 2D nature of the problem as it is not relevant here
v1.4.0-linux,It makes multi-core processing more straightforward
v1.4.0-linux,Allocations
v1.4.0-linux,Add small number to avoid issues with log(I)
v1.4.0-linux,Event sim keeps track of previous image automatically
v1.4.0-linux,"Using pickle dump in a per-frame fashion to save time, instead of savetxt"
v1.4.0-linux,Optimizations possible
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,MultirotorClient.wait_key('Press any key to takeoff')
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,get camera images from the car
v1.4.0-linux,that's enough fun for now. let's quit cleanly
v1.4.0-linux,teleport the drone + 10 meters in x-direction
v1.4.0-linux,teleport the drone back
v1.4.0-linux,use open cv to create point cloud from depth image.
v1.4.0-linux,###########################################
v1.4.0-linux,######### This is work in progress! #######
v1.4.0-linux,###########################################
v1.4.0-linux,file will be saved in PythonClient folder (i.e. same folder as script)
v1.4.0-linux,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.4.0-linux,skip it
v1.4.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.4.0-linux,z of -7 is 7 meters above the original launch point.
v1.4.0-linux,Fly given velocity vector for 5 seconds
v1.4.0-linux,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.4.0-linux,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.4.0-linux,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.4.0-linux,Make the drone fly in a circle.
v1.4.0-linux,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.4.0-linux,check that our home position is stable
v1.4.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.4.0-linux,ramp up time
v1.4.0-linux,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.4.0-linux,compute current angle
v1.4.0-linux,compute lookahead
v1.4.0-linux,if we did the takeoff then also do the landing.
v1.4.0-linux,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.4.0-linux,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.4.0-linux,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.4.0-linux,ignore the click over from 360 back to 0
v1.4.0-linux,watch direction this diff is moving if it switches from shrinking to growing
v1.4.0-linux,then we passed the starting point.
v1.4.0-linux,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.4.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.4.0-linux,z of -7 is 7 meters above the original launch point.
v1.4.0-linux,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.4.0-linux,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.4.0-linux,drone will over-shoot so we bring it back to the start point before landing.
v1.4.0-linux,Run this script with clock speed in settings.json
v1.4.0-linux,"""ClockSpeed"": 1 then change it to 0.5"
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,with ClockSpeed = 0.5 you will see that this takes 6s (system time) and not 3s
v1.4.0-linux,with ClockSpeed = 0.5 you will see that this takes 10s (system time)
v1.4.0-linux,and not 5s in each iteration
v1.4.0-linux,that's enough fun for now. let's quit cleanly
v1.4.0-linux,Takeoff or hover
v1.4.0-linux,Set wind to 0
v1.4.0-linux,In settings.json first activate computer vision mode:
v1.4.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.4.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.4.0-linux,pip install opencv-python
v1.4.0-linux,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.4.0-linux,Python client example to get Lidar data from a drone
v1.4.0-linux,
v1.4.0-linux,Makes the drone fly and get Lidar data
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,"print(""state: %s"" % s)"
v1.4.0-linux,"print(""state: %s"" % pprint.pformat(state))"
v1.4.0-linux,"reshape array of floats to array of [X,Y,Z]"
v1.4.0-linux,TODO
v1.4.0-linux,main
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.4.0-linux,let it settle there a bit.
v1.4.0-linux,after hovering we need to re-enabled api control for next leg of the trip
v1.4.0-linux,now compute the survey path required to fill the box
v1.4.0-linux,"Please add ""EnableTrace"": true to your setting.json as shown below"
v1.4.0-linux,{
v1.4.0-linux,"""SettingsVersion"": 1.2,"
v1.4.0-linux,"""SimMode"": ""Multirotor"","
v1.4.0-linux,"""Vehicles"": {"
v1.4.0-linux,"""Drone"": {"
v1.4.0-linux,"""VehicleType"": ""SimpleFlight"","
v1.4.0-linux,"""EnableTrace"": true"
v1.4.0-linux,}
v1.4.0-linux,}
v1.4.0-linux,}
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,Use below in settings.json with Blocks environment
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,get camera images from the car
v1.4.0-linux,that's enough fun for now. let's quit cleanly
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,Import this module to automatically setup path to local airsim module
v1.4.0-linux,This module first tries to see if airsim module is installed via pip
v1.4.0-linux,If it does then we don't do anything else
v1.4.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.4.0-linux,and if it does then we add that in sys.path
v1.4.0-linux,this class simply tries to see if airsim
v1.4.0-linux,if airsim module is installed then don't do anything else
v1.4.0-linux,import pkgutil
v1.4.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.4.0-linux,if airsim_loader is not None:
v1.4.0-linux,return
v1.4.0-linux,"this script moves the drone to a location, then rests it thousands of time"
v1.4.0-linux,purpose of this script is to stress test reset API
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,that's enough fun for now. let's quite cleanly
v1.4.0-linux,use open cv to show new images from AirSim
v1.4.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.4.0-linux,pip install opencv-python
v1.4.0-linux,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.4.0-linux,get depth image
v1.4.0-linux,"this will return png width= 256, height= 144"
v1.4.0-linux,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.4.0-linux,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.4.0-linux,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.4.0-linux,to get an estimate of distance.
v1.4.0-linux,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.4.0-linux,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.4.0-linux,an angular delta of the following pi/10.
v1.4.0-linux,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.4.0-linux,Remove alpha channel if exists
v1.4.0-linux,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.4.0-linux,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.4.0-linux,Flatten and yield as tuple
v1.4.0-linux,Initialize a resizable dataset to hold the output
v1.4.0-linux,Resize the dataset to accommodate the next chunk of rows
v1.4.0-linux,Create the next chunk
v1.4.0-linux,Increment the row count
v1.4.0-linux,Arguments
v1.4.0-linux,Returns
v1.4.0-linux,use composition of homographies
v1.4.0-linux,to generate final transform that needs to be applied
v1.4.0-linux,Arguments
v1.4.0-linux,Returns
v1.4.0-linux,Keeps under lock only the mechanism which advances
v1.4.0-linux,the indexing of each batch.
v1.4.0-linux,The transformation of images is not under thread lock
v1.4.0-linux,so it can be done in parallel
v1.4.0-linux,Trained model path
v1.4.0-linux,Connect to AirSim
v1.4.0-linux,Start driving
v1.4.0-linux,Initialize image buffer
v1.4.0-linux,Update throttle value according to steering angle
v1.4.0-linux,Prediction
v1.4.0-linux,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.4.0-linux,Print progress
v1.4.0-linux,Update next car state
v1.4.0-linux,Wait a bit between iterations
v1.4.0-linux,%matplotlib inline
v1.4.0-linux,chunk size for training batches
v1.4.0-linux,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.4.0-linux,Point this to the directory containing the raw data
v1.4.0-linux,Point this to the desired output directory for the cooked (.h5) data
v1.4.0-linux,Choose The folders to search for data under RAW_DATA_DIR
v1.4.0-linux,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.4.0-linux,data_folder.append('folder_name1')
v1.4.0-linux,data_folder.append('folder_name2')
v1.4.0-linux,...
v1.4.0-linux,Hyper-parameters
v1.4.0-linux,Activation functions
v1.4.0-linux,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.4.0-linux,<< The directory containing the cooked data from the previous step >>
v1.4.0-linux,<< The directory in which the model output will be placed >>
v1.4.0-linux,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.4.0-linux,Network definition
v1.4.0-linux,Import this module to automatically setup path to local airsim module
v1.4.0-linux,This module first tries to see if airsim module is installed via pip
v1.4.0-linux,If it does then we don't do anything else
v1.4.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.4.0-linux,and if it does then we add that in sys.path
v1.4.0-linux,this class simply tries to see if airsim
v1.4.0-linux,if airsim module is installed then don't do anything else
v1.4.0-linux,import pkgutil
v1.4.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.4.0-linux,if airsim_loader is not None:
v1.4.0-linux,return
v1.4.0-linux,DEY: I don't know why this was there.
v1.4.0-linux,-----------------------------------  Common vehicle APIs ---------------------------------------------
v1.4.0-linux,basic flight control
v1.4.0-linux,time-of-day control
v1.4.0-linux,weather
v1.4.0-linux,camera control
v1.4.0-linux,simGetImage returns compressed png in array of bytes
v1.4.0-linux,image_type uses one of the ImageType members
v1.4.0-linux,"todo: in future remove below, it's only for compatibility to pre v1.2"
v1.4.0-linux,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.4.0-linux,camera control
v1.4.0-linux,simGetImage returns compressed png in array of bytes
v1.4.0-linux,image_type uses one of the ImageType members
v1.4.0-linux,gets the static meshes in the unreal scene
v1.4.0-linux,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.4.0-linux,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.4.0-linux,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.4.0-linux,sensor APIs
v1.4.0-linux,Plotting APIs
v1.4.0-linux,Recording APIs
v1.4.0-linux,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.4.0-linux,APIs for control
v1.4.0-linux,low-level control API
v1.4.0-linux,query vehicle state
v1.4.0-linux,-----------------------------------  Car APIs ---------------------------------------------
v1.4.0-linux,helper method for converting getOrientation to roll/pitch/yaw
v1.4.0-linux,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.4.0-linux,roll (x-axis rotation)
v1.4.0-linux,pitch (y-axis rotation)
v1.4.0-linux,yaw (z-axis rotation)
v1.4.0-linux,DEY: I don't know why this was there.
v1.4.0-linux,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.4.0-linux,return cls(**msgpack.unpack(encoded))
v1.4.0-linux,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.4.0-linux,Create a DummyVecEnv for main airsim gym env
v1.4.0-linux,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.4.0-linux,Initialize RL algorithm type and parameters
v1.4.0-linux,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.4.0-linux,Train for a certain number of timesteps
v1.4.0-linux,Save policy weights
v1.4.0-linux,Create a DummyVecEnv for main airsim gym env
v1.4.0-linux,Wrap env as VecTransposeImage to allow SB to handle frame observations
v1.4.0-linux,Initialize RL algorithm type and parameters
v1.4.0-linux,"Create an evaluation callback with the same env, called every 10000 iterations"
v1.4.0-linux,Train for a certain number of timesteps
v1.4.0-linux,Save policy weights
v1.4.0-linux,Import this module to automatically setup path to local airsim module
v1.4.0-linux,This module first tries to see if airsim module is installed via pip
v1.4.0-linux,If it does then we don't do anything else
v1.4.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.4.0-linux,and if it does then we add that in sys.path
v1.4.0-linux,this class simply tries to see if airsim
v1.4.0-linux,if airsim module is installed then don't do anything else
v1.4.0-linux,import pkgutil
v1.4.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.4.0-linux,if airsim_loader is not None:
v1.4.0-linux,return
v1.4.0-linux,Set home position and velocity
v1.4.0-linux,print(dist)
v1.4.0-linux,"in header only mode, control library is not available"
v1.4.0-linux,if using Unreal Build system then include precompiled header file first
v1.4.0-linux,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.4.0-linux,"Windows, OSX and Linux."
v1.4.0-linux,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.4.0-linux,Windows users can move the Documents folder to any location they want
v1.4.0-linux,SHGetFolderPath knows how to find it.
v1.4.0-linux,fall back in case SHGetFolderPath failed for some reason.
v1.4.0-linux,convert from std::path '/' to windows backslash.
v1.4.0-linux,make the current thread run with maximum priority.
v1.4.0-linux,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.4.0-linux,TODO: How to handle POSIX thread priorities on OSX?
v1.4.0-linux,setThreadName is a helper function that is useful when debugging because your threads
v1.4.0-linux,show up in the debugger with the name you set which makes it easier to find the threads
v1.4.0-linux,that you are interested in.
v1.4.0-linux,"unfortunately this is only available on Windows 10, and AirSim is not limited to that."
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.4.0-linux,
v1.4.0-linux,Treat all errors as failure conditions.
v1.4.0-linux,parse command line
v1.4.0-linux,"motive gives a weird error if the project is not found, so we look for it."
v1.4.0-linux,Do an update to pick up any recently-arrived cameras.
v1.4.0-linux,List all detected cameras.
v1.4.0-linux,List all defined rigid bodies.
v1.4.0-linux,throttle to 50 messages per second.
v1.4.0-linux,OptiTrack uses 'y' axis for vertical.
v1.4.0-linux,stdafx.cpp : source file that includes just the standard includes
v1.4.0-linux,MavlinkMoCap.pch will be the pre-compiled header
v1.4.0-linux,stdafx.obj will contain the pre-compiled type information
v1.4.0-linux,TODO: reference any additional headers you need in STDAFX.H
v1.4.0-linux,and not in this file
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,PX4.cpp : Defines the entry point for the console application.
v1.4.0-linux,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.4.0-linux,how do you write to the debug output windows on Unix ?
v1.4.0-linux,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.4.0-linux,connection to create to talke to that server.
v1.4.0-linux,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.4.0-linux,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.4.0-linux,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.4.0-linux,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.4.0-linux,using their the -qgc option.
v1.4.0-linux,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.4.0-linux,this switch controls whether we turn off the RC remote active link loss detection
v1.4.0-linux,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.4.0-linux,from kicking in when you try and fly.
v1.4.0-linux,parse the json
v1.4.0-linux,flatten inner mavlink object
v1.4.0-linux,flatten inner mavlink object
v1.4.0-linux,todo
v1.4.0-linux,todo
v1.4.0-linux,"const char* outLogFileOption = ""outlogfile"";"
v1.4.0-linux,parse command line
v1.4.0-linux,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.4.0-linux,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.4.0-linux,"no local serial connection, so this is the primary droneConnection."
v1.4.0-linux,failed to connect
v1.4.0-linux,"local connection, then we own sending the heartbeat."
v1.4.0-linux,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.4.0-linux,cmdTable.push_back(new AltHoldCommand());
v1.4.0-linux,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.4.0-linux,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.4.0-linux,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.4.0-linux,this stops us from being able to connect to SITL mode PX4.
v1.4.0-linux,checkPulse();
v1.4.0-linux,add command text in log
v1.4.0-linux,close previous command.
v1.4.0-linux,FilterLogFiles(logDirectory);
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,send a heartbeat
v1.4.0-linux,accept one incoming connection
v1.4.0-linux,send a heartbeat to the client
v1.4.0-linux,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.4.0-linux,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.4.0-linux,for this unit test we are expecting a request to send an image.
v1.4.0-linux,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.4.0-linux,hmmm
v1.4.0-linux,================ ls
v1.4.0-linux,================ put file
v1.4.0-linux,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.4.0-linux,================ get file
v1.4.0-linux,verify the file contents.
v1.4.0-linux,================ remove file
v1.4.0-linux,================ make directory
v1.4.0-linux,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.4.0-linux,================ remove directory
v1.4.0-linux,Now verification
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,you must call this method if you want HandleMessage to be called subsequently.
v1.4.0-linux,treat literals as one word
v1.4.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.4.0-linux,request gps info
v1.4.0-linux,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.4.0-linux,find relative position since command start so we can compare two commands better
v1.4.0-linux,"these PID values are important, so set these to match"
v1.4.0-linux,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.4.0-linux,we can skip ahead.
v1.4.0-linux,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.4.0-linux,TODO: avoid passing hadcoded HIL flag
v1.4.0-linux,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.4.0-linux,"The global position, as returned by the Global Positioning System (GPS)."
v1.4.0-linux,Provides state for additional features
v1.4.0-linux,The general system state
v1.4.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.4.0-linux,Provides state for additional features
v1.4.0-linux,The general system state
v1.4.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.4.0-linux,Provides state for additional features
v1.4.0-linux,The general system state
v1.4.0-linux,Provides state for additional features
v1.4.0-linux,The general system state
v1.4.0-linux,note: we do not reset com when Close() is called because we want to keep running.
v1.4.0-linux,"user has to invoke ""hil stop"" to stop the hil thread."
v1.4.0-linux,generate random between 0 and 1
v1.4.0-linux,move to range -1 to 1
v1.4.0-linux,scale it
v1.4.0-linux,apply iy
v1.4.0-linux,wait for the Execute method to be called.
v1.4.0-linux,gps is much slower frequency than IMU.
v1.4.0-linux,MAVLINK_MSG_ID_HIL_GPS
v1.4.0-linux,disable MAV_USEHILGPS
v1.4.0-linux,note: we do not reset com when Close() is called because we want to keep running.
v1.4.0-linux,"user has to invoke ""hil stop"" to stop the hil thread."
v1.4.0-linux,generate random between 0 and 1
v1.4.0-linux,move to range -1 to 1
v1.4.0-linux,scale it
v1.4.0-linux,apply iy
v1.4.0-linux,wait for the Execute method to be called.
v1.4.0-linux,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.4.0-linux,gps is much slower frequency than IMU.
v1.4.0-linux,MAVLINK_MSG_ID_HIL_GPS
v1.4.0-linux,disable HIL mode
v1.4.0-linux,Enumeration of landed detector states
v1.4.0-linux,MAV landed state is unknown
v1.4.0-linux,MAV is landed (on ground)
v1.4.0-linux,MAV is in air
v1.4.0-linux,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.4.0-linux,The filtered local position
v1.4.0-linux,must send these regularly to keep offboard control.
v1.4.0-linux,"ok, now we can safely switch to loiter."
v1.4.0-linux,must send these regularly to keep offboard control.
v1.4.0-linux,integrate the heading so it is smoother.
v1.4.0-linux,must send these regularly to keep offboard control.
v1.4.0-linux,integrate the heading so it is smoother.
v1.4.0-linux,fly to radius
v1.4.0-linux,it takes about 10 cm to stop and turn.
v1.4.0-linux,next time around switch to orbiting!
v1.4.0-linux,heading points to center of circle.
v1.4.0-linux,interpoloate the speed ramp up time over 2 seconds from start time
v1.4.0-linux,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.4.0-linux,monitor the sin curves so we can see how on track or off track it actually is.
v1.4.0-linux,the shape of the curve will also tell us if we are progressing at a consistent
v1.4.0-linux,"speed, the more deformed the sin curve the worse our progress."
v1.4.0-linux,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.4.0-linux,degrees just flipped from 359 to 0.
v1.4.0-linux,this enables us to test what happens when offboard control is lost and resumed.
v1.4.0-linux,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.4.0-linux,"ok, now we can start moving by velocity"
v1.4.0-linux,recompute to new target.
v1.4.0-linux,start by moving right with 10 degree roll.
v1.4.0-linux,haven't started yet.
v1.4.0-linux,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.4.0-linux,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.4.0-linux,track how our actual pitch is coming along compared to our target
v1.4.0-linux,and check position
v1.4.0-linux,the amount of pitch should depend on our speed in that direction.
v1.4.0-linux,passed the midpoint.
v1.4.0-linux,fade out the pitch as we pick up speed so we don't overshoot.
v1.4.0-linux,see if we just crossed the wiggle distance threshold.
v1.4.0-linux,(pitch affects the x-position).
v1.4.0-linux,reverse direction with a -30 degrees quick stop
v1.4.0-linux,reverse direction with a 30 degrees quick stop
v1.4.0-linux,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.4.0-linux,too much in that direction.
v1.4.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.4.0-linux,track how our actual roll is coming along compared to our target
v1.4.0-linux,and check position
v1.4.0-linux,the amount of roll should depend on our speed in that direction.
v1.4.0-linux,passed the midpoint.
v1.4.0-linux,fade out the roll as we pick up speed so we don't overshoot.
v1.4.0-linux,see if we just crossed the wiggle distance threshold.
v1.4.0-linux,(roll affects the y-position).
v1.4.0-linux,reverse direction with a -30 degrees quick stop
v1.4.0-linux,reverse direction with a 30 degrees quick stop
v1.4.0-linux,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.4.0-linux,too much in that direction.
v1.4.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.4.0-linux,for testing PID controller.
v1.4.0-linux,class AltHoldCommand : public Command
v1.4.0-linux,{
v1.4.0-linux,std::shared_ptr<MavLinkVehicle> channel;
v1.4.0-linux,"float sx_, sy_, sz_;"
v1.4.0-linux,MavLinkAttitudeTarget _current;
v1.4.0-linux,PidController thrust_controller_;
v1.4.0-linux,public:
v1.4.0-linux,this->sz_ = pos.z; // user defined target.
v1.4.0-linux,move to local position keeps the offboard control happy.
v1.4.0-linux,haven't started yet.
v1.4.0-linux,and check position
v1.4.0-linux,double dx = this->sx_ - pos.x;
v1.4.0-linux,double dy = this->sy_ - pos.y;
v1.4.0-linux,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.4.0-linux,too much in that direction.
v1.4.0-linux,adjust thrust so we keep steady height target
v1.4.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.4.0-linux,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.4.0-linux,local remote
v1.4.0-linux,already handled by the parse method.
v1.4.0-linux,we only support very simple patterns for now.
v1.4.0-linux,each wildcard must be separated by literal.
v1.4.0-linux,back to back wildcards with no literal in between is too complex.
v1.4.0-linux,"we only support simple matching for now, we can add full regex later if we need it."
v1.4.0-linux,yep!
v1.4.0-linux,'*' is done we found the next matching char
v1.4.0-linux,this is ok.
v1.4.0-linux,this is an ERASE_END_LINE command which we ignore.
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,unpack the message...
v1.4.0-linux,pack the payload buffer.
v1.4.0-linux,"json can't handle ""nan"", so we convert it to null."
v1.4.0-linux,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.4.0-linux,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,start listening to this connection
v1.4.0-linux,Send heartbeat to drone.  You should not do this if some other node is
v1.4.0-linux,already doing it.
v1.4.0-linux,stop listening to the connection.
v1.4.0-linux,get the connection
v1.4.0-linux,Get the local system and component id
v1.4.0-linux,send a command to the remote node
v1.4.0-linux,MavLinkNode::MavLinkNode() = default;
v1.4.0-linux,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.4.0-linux,decrementing the count so the next WaitOne may block.
v1.4.0-linux,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.4.0-linux,convert to absolute time.
v1.4.0-linux,use mach_timespec
v1.4.0-linux,convert to absolute time.
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,return true if we still have offboard control (can lose this if user flips the switch).
v1.4.0-linux,MavLinkVehicle::MavLinkVehicle() = default;
v1.4.0-linux,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.4.0-linux,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,============================== CLIENT ============================================
v1.4.0-linux,image APIs
v1.4.0-linux,or if you are implementing the client side call this function to get the most recent frame.
v1.4.0-linux,returns false if there is no new frame available.
v1.4.0-linux,============================== SERVER ============================================
v1.4.0-linux,call this to send the image back over the connection given to start function.
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,"log every message that is ""sent"" using sendMessage."
v1.4.0-linux,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.4.0-linux,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.4.0-linux,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.4.0-linux,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,for compatibility with QGroundControl we have to save the time field in big endian.
v1.4.0-linux,todo: mavlink2 support?
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,start listening to this connection
v1.4.0-linux,Send heartbeat to drone.  You should not do this if some other node is
v1.4.0-linux,already doing it.
v1.4.0-linux,this is called for all messages received on the connection.
v1.4.0-linux,"we received a heartbeat, so let's get the capabilities."
v1.4.0-linux,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.4.0-linux,subclasses remembering to call this base implementation.
v1.4.0-linux,stop listening to the connection.
v1.4.0-linux,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.4.0-linux,wait for a heartbeat msg since this will give us the port to send commands to...
v1.4.0-linux,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.4.0-linux,send a heart beat so that the remote node knows we are still alive
v1.4.0-linux,(otherwise drone will trigger a failsafe operation).
v1.4.0-linux,ignore any failures here because we are running in our own thread here.
v1.4.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.4.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.4.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.4.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.4.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.4.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.4.0-linux,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.4.0-linux,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.4.0-linux,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.4.0-linux,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.4.0-linux,"ok, now fetch the missing parameters."
v1.4.0-linux,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.4.0-linux,silently fail since we are on a background thread here...
v1.4.0-linux,tell the caller this is complete.
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,add our custom telemetry message length.
v1.4.0-linux,todo: if we support signing then initialize
v1.4.0-linux,mavlink_intermediate_status_.signing callbacks
v1.4.0-linux,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.4.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.4.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.4.0-linux,send this right away just in case serial link is not already configured
v1.4.0-linux,"log every message that is ""sent"" using sendMessage."
v1.4.0-linux,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.4.0-linux,pack the payload buffer.
v1.4.0-linux,calculate checksum
v1.4.0-linux,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.4.0-linux,are variable length as a result.
v1.4.0-linux,form the header as a byte array for the crc
v1.4.0-linux,these macros use old style cast.
v1.4.0-linux,forward messages from our connected node to the remote proxy.
v1.4.0-linux,tell the remote connection to expect mavlink2 messages.
v1.4.0-linux,forward messages from remote proxy to local connected node
v1.4.0-linux,CurrentThread::setMaximumPriority();
v1.4.0-linux,"hmmm, wait till it is opened?"
v1.4.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.4.0-linux,pick up the sysid/compid of the remote node we are connected to.
v1.4.0-linux,then this is a mavlink 1 message
v1.4.0-linux,then this mavlink sender supports mavlink 2
v1.4.0-linux,queue event for publishing.
v1.4.0-linux,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.4.0-linux,as it ensures we don't lose messages if the listener is slow.
v1.4.0-linux,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.4.0-linux,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.4.0-linux,we would get a deadlock.
v1.4.0-linux,CurrentThread::setMaximumPriority();
v1.4.0-linux,reset counters
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,------------------------------------------------------------------------------
v1.4.0-linux,Defines
v1.4.0-linux,------------------------------------------------------------------------------
v1.4.0-linux,bit number  876543210987654321
v1.4.0-linux,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.4.0-linux,in future it would be good to have ability to add system IDs we are interested in
v1.4.0-linux,if (msg.sysid != getTargetSystemId())
v1.4.0-linux,{
v1.4.0-linux,// we only care about messages from our intended remote node.
v1.4.0-linux,return;
v1.4.0-linux,}
v1.4.0-linux,user may have changed modes on us! So we need to honor that and not
v1.4.0-linux,try and take it back.
v1.4.0-linux,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.4.0-linux,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.4.0-linux,we can store up to 16 channels in rc_channels_scaled.
v1.4.0-linux,The RAW values of the servo outputs
v1.4.0-linux,Metrics typically displayed on a HUD for fixed wing aircraft
v1.4.0-linux,The IMU readings in SI units in NED body frame
v1.4.0-linux,printSystemStatus(&msg);
v1.4.0-linux,todo: use this to determine when we need to do emergency landing...
v1.4.0-linux,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.4.0-linux,Provides state for additional features
v1.4.0-linux,The general system state
v1.4.0-linux,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.4.0-linux,but we do want to know when we get the ack.  So this is async ACK processing!
v1.4.0-linux,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.4.0-linux,if threshold < 0 then the threshold is inverted.
v1.4.0-linux,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.4.0-linux,Convert it to a floating point number between -1 and 1.
v1.4.0-linux,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.4.0-linux,until the move commands start happening.
v1.4.0-linux,return true if user calls requestControl and has not called releaseControl.
v1.4.0-linux,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.4.0-linux,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.4.0-linux,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.4.0-linux,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.4.0-linux,send a few to make sure it gets through...
v1.4.0-linux,now the command should succeed.
v1.4.0-linux,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.4.0-linux,us by which time the PX4 times out offboard mode!!
v1.4.0-linux,this mode change take precedence over offboard mode.
v1.4.0-linux,thrust must be between -1 and 1.
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,These definitions are copied from PX4 implementation
v1.4.0-linux,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.4.0-linux,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.4.0-linux,/ @brief Command opcodes
v1.4.0-linux,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.4.0-linux,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.4.0-linux,must trim trailing slashes so PX4 doesn't hang!
v1.4.0-linux,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.4.0-linux,from the source.
v1.4.0-linux,check if directory exists.
v1.4.0-linux,perfect.
v1.4.0-linux,use last_message_ so we preserve the sessionid.
v1.4.0-linux,"could not create the local file, so stop."
v1.4.0-linux,must use last_message_ so we preserve the session id.
v1.4.0-linux,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.4.0-linux,todo: error handling here? sequence is out of order...
v1.4.0-linux,"directory must be empty then, can't do nextStep because"
v1.4.0-linux,it will just loop for ever re-requesting zero offset into
v1.4.0-linux,empty directory.
v1.4.0-linux,result should be a list of null terminated file names.
v1.4.0-linux,skipping this entry
v1.4.0-linux,remove the file size field.
v1.4.0-linux,"printf(""%s\n"", name.c_str());"
v1.4.0-linux,request the next batch.
v1.4.0-linux,"perhaps this was a late response after we did a retry, so ignore it."
v1.4.0-linux,"perhaps this was a late response after we did a retry, so ignore it."
v1.4.0-linux,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.4.0-linux,reached the end of the list or the file.
v1.4.0-linux,end of file or directory listing.
v1.4.0-linux,"success, data should be following..."
v1.4.0-linux,ack on this cmd is a noop
v1.4.0-linux,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.4.0-linux,give up then.
v1.4.0-linux,tell watchdog we are sending a request
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,================================= CLIENT ==============================================================
v1.4.0-linux,Check if we have a valid transaction
v1.4.0-linux,emit signal if all packets arrived
v1.4.0-linux,Restart statemachine
v1.4.0-linux,image APIs
v1.4.0-linux,================================= SERVER ==============================================================
v1.4.0-linux,Prepare and send acknowledgment packet
v1.4.0-linux,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.4.0-linux,Send ENCAPSULATED_IMAGE packet
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.4.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.4.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.4.0-linux,send this right away just in case serial link is not already configured
v1.4.0-linux,CurrentThread::setMaximumPriority();
v1.4.0-linux,"hmmm, wait till it is opened?"
v1.4.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.4.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.4.0-linux,queue event for publishing.
v1.4.0-linux,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.4.0-linux,as it ensures we don't lose messages if the listener is slow.
v1.4.0-linux,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.4.0-linux,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.4.0-linux,we would get a deadlock.
v1.4.0-linux,CurrentThread::setMaximumPriority();
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.4.0-linux,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.4.0-linux,parse out the VID number
v1.4.0-linux,now the PID
v1.4.0-linux,parse out the VID number
v1.4.0-linux,examples:
v1.4.0-linux,PX4: USB\VID_26AC&PID_0011\0
v1.4.0-linux,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.4.0-linux,"printf(""Found: %S\n"", buffer.c_str());"
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.4.0-linux,parse out the VID number
v1.4.0-linux,now the PID
v1.4.0-linux,parse out the VID number
v1.4.0-linux,suppress
v1.4.0-linux,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,This has not been properly tested
v1.4.0-linux,struct iw_statistics stats;
v1.4.0-linux,struct iwreq req;
v1.4.0-linux,"memset(&stats, 0, sizeof(stats));"
v1.4.0-linux,"memset(&req, 0, sizeof(iwreq));"
v1.4.0-linux,
v1.4.0-linux,"strncpy(req.ifr_name, ifaceName, 16);"
v1.4.0-linux,req.u.data.pointer = &stats;
v1.4.0-linux,req.u.data.length = sizeof(iw_statistics);
v1.4.0-linux,
v1.4.0-linux,#ifdef CLEAR_UPDATED
v1.4.0-linux,req.u.data.flags = 1;
v1.4.0-linux,#endif
v1.4.0-linux,
v1.4.0-linux,/* Perform the ioctl */
v1.4.0-linux,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.4.0-linux,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.4.0-linux,return -127;
v1.4.0-linux,}
v1.4.0-linux,
v1.4.0-linux,return stats.qual.level;
v1.4.0-linux,todo: windows version of this...
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,windows
v1.4.0-linux,Need to link with Ws2_32.lib
v1.4.0-linux,posix
v1.4.0-linux,found it!
v1.4.0-linux,bind socket to local address.
v1.4.0-linux,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.4.0-linux,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.4.0-linux,write to the serial port
v1.4.0-linux,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.4.0-linux,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.4.0-linux,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.4.0-linux,"try and receive something, up until port is closed anyway."
v1.4.0-linux,"message was too large for the buffer, no problem, return what we have."
v1.4.0-linux,try again - this can happen if server recreates the socket on their side.
v1.4.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.4.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.4.0-linux,"printf(""#### recv failed with error: %d\n"", hr);"
v1.4.0-linux,we now have it.
v1.4.0-linux,this is from someone we are not interested in.
v1.4.0-linux,-----------------------------------------------------------------------------------------
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,Initialize Winsock
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,windows
v1.4.0-linux,Need to link with Ws2_32.lib
v1.4.0-linux,posix
v1.4.0-linux,found it!
v1.4.0-linux,bind socket to local address.
v1.4.0-linux,bind socket to local address.
v1.4.0-linux,start listening for incoming connection
v1.4.0-linux,accept 1
v1.4.0-linux,"don't need to accept any more, so we can close this one."
v1.4.0-linux,write to the serial port
v1.4.0-linux,"try and receive something, up until port is closed anyway."
v1.4.0-linux,"message was too large for the buffer, no problem, return what we have."
v1.4.0-linux,try again - this can happen if server recreates the socket on their side.
v1.4.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.4.0-linux,try again - this can happen if server recreates the socket on their side.
v1.4.0-linux,-----------------------------------------------------------------------------------------
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.4.0-linux,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.4.0-linux,set signal
v1.4.0-linux,Clear Handshake flags
v1.4.0-linux,Set Handshake flags
v1.4.0-linux,return GetLastError();
v1.4.0-linux,return GetLastError();
v1.4.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.4.0-linux,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.4.0-linux,enable reading
v1.4.0-linux,posix doesn't have mark/space parity.
v1.4.0-linux,posix doesn't have mark/space parity.
v1.4.0-linux,this is the default.
v1.4.0-linux,not sure this is supported...
v1.4.0-linux,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.4.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.4.0-linux,First do those specified by POSIX.
v1.4.0-linux,Now conditionally handle a bunch of extended rates.
v1.4.0-linux,First do those specified by POSIX.
v1.4.0-linux,Now conditionally handle a bunch of extended rates.
v1.4.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.4.0-linux,import airsim
v1.4.0-linux,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v1.4.0-linux,self.args = args
v1.4.0-linux,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v1.4.0-linux,pdb.set_trace()
v1.4.0-linux,#include <pluginlib/class_list_macros.h>
v1.4.0-linux,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v1.4.0-linux,todo do not reset if already in air?
v1.4.0-linux,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.4.0-linux,ros params
v1.4.0-linux,todo enforce dynamics constraints in this node as well?
v1.4.0-linux,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v1.4.0-linux,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v1.4.0-linux,XmlRpc::XmlRpcValue can't be const in this case
v1.4.0-linux,subscribe to control commands on global nodehandle
v1.4.0-linux,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.4.0-linux,bind to a single callback. todo optimal subs queue length
v1.4.0-linux,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.4.0-linux,"vehicle_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.4.0-linux,"iterate over camera map std::map<std::string, CameraSetting> .cameras;"
v1.4.0-linux,vehicle_setting_vec_.push_back(*vehicle_setting.get());
v1.4.0-linux,camera_setting.gimbal
v1.4.0-linux,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.4.0-linux,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.4.0-linux,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.4.0-linux,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.4.0-linux,"if {DepthPlanner, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.4.0-linux,"push back pair (vector of image captures, current vehicle name)"
v1.4.0-linux,iterate over sensors
v1.4.0-linux,"we want fast access to the lidar sensors for callback handling, sort them out now"
v1.4.0-linux,add takeoff and land all services if more than 2 drones
v1.4.0-linux,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v1.4.0-linux,todo add per vehicle reset in AirLib API
v1.4.0-linux,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.4.0-linux,lidars update on their own callback/thread at a given rate
v1.4.0-linux,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v1.4.0-linux,"todo: error check. if state is not landed, return error."
v1.4.0-linux,response.success =
v1.4.0-linux,response.success =
v1.4.0-linux,response.success =
v1.4.0-linux,response.success =
v1.4.0-linux,response.success =
v1.4.0-linux,response.success =
v1.4.0-linux,todo add reset by vehicle_name API to airlib
v1.4.0-linux,todo not async remove waitonlasttask
v1.4.0-linux,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v1.4.0-linux,todo do actual body frame?
v1.4.0-linux,airsim uses degrees
v1.4.0-linux,todo do actual body frame?
v1.4.0-linux,airsim uses degrees
v1.4.0-linux,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v1.4.0-linux,todo expose waitOnLastTask or nah?
v1.4.0-linux,todo do actual body frame?
v1.4.0-linux,airsim uses degrees
v1.4.0-linux,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.4.0-linux,todo expose waitOnLastTask or nah?
v1.4.0-linux,todo support multiple gimbal commands
v1.4.0-linux,todo support multiple gimbal commands
v1.4.0-linux,1. find quaternion of default gimbal pose
v1.4.0-linux,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.4.0-linux,3. call airsim client's setCameraPose which sets camera pose wrt world (or takeoff?) ned frame. todo
v1.4.0-linux,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.4.0-linux,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.4.0-linux,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.4.0-linux,msg = []
v1.4.0-linux,todo covariances
v1.4.0-linux,gps_msg.position_covariance_type =
v1.4.0-linux,gps_msg.position_covariance =
v1.4.0-linux,todo covariances
v1.4.0-linux,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.4.0-linux,todo radians per second
v1.4.0-linux,meters/s2^m
v1.4.0-linux,imu_msg.orientation_covariance = ;
v1.4.0-linux,imu_msg.angular_velocity_covariance = ;
v1.4.0-linux,imu_msg.linear_acceleration_covariance = ;
v1.4.0-linux,airsim appears to use chrono::system_clock with nanosecond precision
v1.4.0-linux,todo this is global origin
v1.4.0-linux,get the basic vehicle pose and environmental state
v1.4.0-linux,"on init, will publish 0 to /clock as expected for use_sim_time compatibility"
v1.4.0-linux,airsim_client needs to provide the simulation time in a future version of the API
v1.4.0-linux,publish the simulation clock
v1.4.0-linux,"publish vehicle state, odom, and all basic sensor types"
v1.4.0-linux,send any commands out to the vehicles
v1.4.0-linux,"should be easier way to get the sim time through API, something like:"
v1.4.0-linux,"msr::airlib::Environment::State env = airsim_client_->simGetGroundTruthEnvironment("""");"
v1.4.0-linux,curr_ros_time = airsim_timestamp_to_ros(env.clock().nowNanos());
v1.4.0-linux,iterate over drones
v1.4.0-linux,get drone state from airsim
v1.4.0-linux,"vehicle environment, we can get ambient temperature here and other truths"
v1.4.0-linux,convert airsim drone state to ROS msgs
v1.4.0-linux,simulation environment truth
v1.4.0-linux,"dashboard reading from car, RPM, gear, etc"
v1.4.0-linux,odom and transforms
v1.4.0-linux,ground truth GPS position from sim/HITL
v1.4.0-linux,handled via callback
v1.4.0-linux,send control commands from the last callback to airsim
v1.4.0-linux,send control commands from the last callback to airsim
v1.4.0-linux,"Only camera rotation, no translation movement of camera"
v1.4.0-linux,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.4.0-linux,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.4.0-linux,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.4.0-linux,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.4.0-linux,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.4.0-linux,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.4.0-linux,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.4.0-linux,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.4.0-linux,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.4.0-linux,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.4.0-linux,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.4.0-linux,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.4.0-linux,update timestamp of saved cam info msgs
v1.4.0-linux,DepthPlanner / DepthPerspective / DepthVis / DisparityNormalized
v1.4.0-linux,Scene / Segmentation / SurfaceNormals / Infrared
v1.4.0-linux,publish camera transforms
v1.4.0-linux,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.4.0-linux,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.4.0-linux,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.4.0-linux,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.4.0-linux,ROS params
v1.4.0-linux,ROS publishers
v1.4.0-linux,ROS subscribers
v1.4.0-linux,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.4.0-linux,ROS timers
v1.4.0-linux,todo maintain internal representation as eigen vec?
v1.4.0-linux,todo check if low velocity if within thresh?
v1.4.0-linux,todo maintain separate errors for XY and Z
v1.4.0-linux,todo save this in degrees somewhere to avoid repeated conversion
v1.4.0-linux,this tells the update timer callback to not do active hovering
v1.4.0-linux,todo maintain array of position goals
v1.4.0-linux,todo error checks
v1.4.0-linux,todo fill response
v1.4.0-linux,"Already have goal, and have reached it"
v1.4.0-linux,this tells the update timer callback to not do active hovering
v1.4.0-linux,todo error checks
v1.4.0-linux,todo fill response
v1.4.0-linux,"todo do relative altitude, or add an option for the same?"
v1.4.0-linux,convert GPS goal to NED goal
v1.4.0-linux,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.4.0-linux,todo error checks
v1.4.0-linux,todo fill response
v1.4.0-linux,"Already have goal, this shouldn't happen"
v1.4.0-linux,"todo do relative altitude, or add an option for the same?"
v1.4.0-linux,convert GPS goal to NED goal
v1.4.0-linux,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.4.0-linux,todo error checks
v1.4.0-linux,todo fill response
v1.4.0-linux,todo check if odometry is too old!!
v1.4.0-linux,"if no odom, don't do anything."
v1.4.0-linux,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.4.0-linux,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.4.0-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.4.0-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.4.0-linux,todo yaw limits
v1.4.0-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.4.0-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.4.0-linux,check if path exists
v1.4.0-linux,todo airsim's simhud.cpp does error checking here
v1.4.0-linux,mimics void ASimHUD::initializeSettings()
v1.4.0-linux,not sure where settings_json initialized in AirSimSettings::initializeSettings() is actually used
v1.4.0-linux,int num_threads = 1;
v1.4.0-linux,ros::MultiThreadedSpinner multi_thread(num_threads);
v1.4.0-linux,multi_thread.spin();
v1.4.0-linux,ros::AsyncSpinner async_spinner(num_threads);
v1.4.0-linux,async_spinner.start();
v1.4.0-linux,single threaded spinner
v1.4.0-linux,connect to the AirSim simulator
v1.4.0-linux,","
v1.4.0-linux,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.4.0-linux,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,"in header only mode, control library is not available"
v1.4.0-linux,TODO: something defines max macro which interfears with code here
v1.4.0-linux,is cur_pos within fence?
v1.4.0-linux,destination risk is not available then consider it zero
v1.4.0-linux,if dest risk is lower than its more safe
v1.4.0-linux,are we doing better than closest obstacle?
v1.4.0-linux,"if we stay where we are, what is the risk distance?"
v1.4.0-linux,else we are better of moving to dest
v1.4.0-linux,this function should work even when dest_pos == cur_pos
v1.4.0-linux,is this dest_pos cur_pos within the fence?
v1.4.0-linux,transform dest_pos vector to body frame
v1.4.0-linux,check for approx zero vectors to avoid random yaw angles
v1.4.0-linux,we are hovering
v1.4.0-linux,"get yaw in body frame, ie, front is always 0 radians"
v1.4.0-linux,yaw to ticks
v1.4.0-linux,get obstacles in the window at the tick direction around the window
v1.4.0-linux,less risk distance is better
v1.4.0-linux,check obstacles around current position and see if it has lower risk
v1.4.0-linux,else obstacle is too far
v1.4.0-linux,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.4.0-linux,look for each surrounding tick to see if we have obstacle free angle
v1.4.0-linux,else no suggestions required
v1.4.0-linux,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.4.0-linux,evaluate right and left side of circle
v1.4.0-linux,find right and left risk distances
v1.4.0-linux,at this point we have already determined hover is better than going to dest
v1.4.0-linux,we now determine is moving to suggested angle better than hovering?
v1.4.0-linux,check if dest_pos is safe
v1.4.0-linux,breaking distance at this velocity
v1.4.0-linux,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.4.0-linux,check if dest_pos is safe
v1.4.0-linux,float/vec parameters can have NaN which makes them optional
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,"in header only mode, control library is not available"
v1.4.0-linux,handles +/- tick and wraps around circle
v1.4.0-linux,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.4.0-linux,update the specified window on the map
v1.4.0-linux,make sure from <= to
v1.4.0-linux,normalize the ticks so both are valid indices
v1.4.0-linux,if from is still larger then
v1.4.0-linux,to ticks is then added one full circle to make it larger than from_tick
v1.4.0-linux,find closest obstacle in given window
v1.4.0-linux,search whole map to find closest obstacle
v1.4.0-linux,"in header only mode, control library is not available"
v1.4.0-linux,#include <fileapi.h>
v1.4.0-linux,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.4.0-linux,"Windows, OSX and Linux."
v1.4.0-linux,Windows users can move the Documents folder to any location they want
v1.4.0-linux,SHGetFolderPath knows how to find it.
v1.4.0-linux,fall back in case SHGetFolderPath failed for some reason.
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,"in header only mode, control library is not available"
v1.4.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.4.0-linux,if using Unreal Build system then include precompiled header file first
v1.4.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.4.0-linux,this deadlocks UI thread if async_run was called while there are pending rpc calls.
v1.4.0-linux,Exit if already resetting.
v1.4.0-linux,Reset
v1.4.0-linux,if we don't suppress then server will bomb out for exceptions raised by any method
v1.4.0-linux,required for pimpl
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,"in header only mode, control library is not available"
v1.4.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.4.0-linux,if using Unreal Build system then include precompiled header file first
v1.4.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.4.0-linux,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.4.0-linux,make sure we can talk to the DroneServer
v1.4.0-linux,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.4.0-linux,command_context.client.ping();
v1.4.0-linux,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.4.0-linux,sim only
v1.4.0-linux,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.4.0-linux,return value of last task. It should be true if task completed without
v1.4.0-linux,cancellation or timeout
v1.4.0-linux,"should be implemented by derived class if it supports async task,"
v1.4.0-linux,for example using futures
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,"in header only mode, control library is not available"
v1.4.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.4.0-linux,if using Unreal Build system then include precompiled header file first
v1.4.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,"in header only mode, control library is not available"
v1.4.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.4.0-linux,if using Unreal Build system then include precompiled header file first
v1.4.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.4.0-linux,required for pimpl
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,"in header only mode, control library is not available"
v1.4.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.4.0-linux,if using Unreal Build system then include precompiled header file first
v1.4.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.4.0-linux,status getters
v1.4.0-linux,return value of last task. It should be true if task completed without
v1.4.0-linux,cancellation or timeout
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,"in header only mode, control library is not available"
v1.4.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.4.0-linux,if using Unreal Build system then include pre-compiled header file first
v1.4.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.4.0-linux,getters
v1.4.0-linux,required for pimpl
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,"in header only mode, control library is not available"
v1.4.0-linux,last command is to hold on to position
v1.4.0-linux,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.4.0-linux,after landing we detect if drone has stopped moving
v1.4.0-linux,validate path size
v1.4.0-linux,validate yaw mode
v1.4.0-linux,validate and set auto-lookahead value
v1.4.0-linux,if auto mode requested for lookahead then calculate based on velocity
v1.4.0-linux,add current position as starting point
v1.4.0-linux,append the input path and compute segments
v1.4.0-linux,add last segment as zero length segment so we have equal number of segments and points.
v1.4.0-linux,path_segs[i] refers to segment that starts at point i
v1.4.0-linux,"when path ends, we want to slow down"
v1.4.0-linux,else no need to change velocities for last segments
v1.4.0-linux,setup current position on path to 0 offset
v1.4.0-linux,initialize next path position
v1.4.0-linux,until we are at the end of the path (last seg is always zero size)
v1.4.0-linux,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.4.0-linux,send drone command to get to next lookahead
v1.4.0-linux,sleep for rest of the cycle
v1.4.0-linux,how much have we moved towards last goal?
v1.4.0-linux,project actual vector on goal vector
v1.4.0-linux,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.4.0-linux,TODO: below should be lower than 1E3 and configurable
v1.4.0-linux,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.4.0-linux,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.4.0-linux,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.4.0-linux,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.4.0-linux,"if drone moved backward, we don't want goal to move backward as well"
v1.4.0-linux,"so only climb forward on the path, never back. Also note >= which means"
v1.4.0-linux,we climb path even if distance was 0 to take care of duplicated points on path
v1.4.0-linux,else
v1.4.0-linux,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.4.0-linux,compute next target on path
v1.4.0-linux,freeze the quaternion
v1.4.0-linux,convert RC commands to velocity vector
v1.4.0-linux,find yaw as per terrain and remote setting
v1.4.0-linux,execute command
v1.4.0-linux,if timeout occurred then command completed successfully otherwise it was interrupted
v1.4.0-linux,yaw is not within margin
v1.4.0-linux,by default we say that this command is not supported
v1.4.0-linux,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.4.0-linux,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.4.0-linux,get trims
v1.4.0-linux,take average
v1.4.0-linux,validate dest
v1.4.0-linux,what is the distance we will travel at this velocity?
v1.4.0-linux,get velocity vector
v1.4.0-linux,yaw for the direction of travel
v1.4.0-linux,find velocity vector
v1.4.0-linux,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.4.0-linux,generate velocity vector that is same size as cur_dest_norm / command period
v1.4.0-linux,this velocity vect when executed for command period would yield cur_dest_norm
v1.4.0-linux,send commands
v1.4.0-linux,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.4.0-linux,default strategy is for move. In hover mode we set new strategy temporarily
v1.4.0-linux,are we supposed to do EM?
v1.4.0-linux,get suggested velocity vector
v1.4.0-linux,use the unchecked command
v1.4.0-linux,tell caller not to execute planned command
v1.4.0-linux,other wise throw exception
v1.4.0-linux,otherwise there is some other reason why we are in unsafe situation
v1.4.0-linux,send last command to come to full stop
v1.4.0-linux,else no unsafe situation
v1.4.0-linux,note: cur_path_loc and next_path_loc may both point to same object
v1.4.0-linux,"otherwise use up this segment, move on to next one"
v1.4.0-linux,if we are here then we ran out of segments
v1.4.0-linux,consider last segment as zero length segment
v1.4.0-linux,adjust yaw for the direction of travel in forward-only mode
v1.4.0-linux,else no adjustment needed
v1.4.0-linux,if auto mode requested for lookahead then calculate based on velocity
v1.4.0-linux,Create a spring arm component for our chase camera
v1.4.0-linux,"do nothing, spring arm is pulling the camera with it"
v1.4.0-linux,"do nothing, we have camera turned off"
v1.4.0-linux,set initial view mode
v1.4.0-linux,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.4.0-linux,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.4.0-linux,"If the lag is missing, the camera will also occasionally shake."
v1.4.0-linux,"But, lag is not desired when piloting a drone"
v1.4.0-linux,attach spring arm to actor
v1.4.0-linux,remember current parent for external camera. Later when we remove external
v1.4.0-linux,"camera from spring arm, we will attach it back to its last parent"
v1.4.0-linux,now attach camera to spring arm
v1.4.0-linux,"For car, we need to move the camera back a little more than for a drone."
v1.4.0-linux,"Otherwise, the camera will be stuck inside the car"
v1.4.0-linux,ExternalCamera->bUsePawnControlRotation = false;
v1.4.0-linux,detach spring arm
v1.4.0-linux,Re-enable rendering
v1.4.0-linux,Remove any existing key bindings for manual mode
v1.4.0-linux,"else someone else is bound to manual pose controller, leave it alone"
v1.4.0-linux,if new mode is manual mode then add key bindings
v1.4.0-linux,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.4.0-linux,other modes don't need special setup
v1.4.0-linux,make switch official
v1.4.0-linux,Add loading screen to viewport
v1.4.0-linux,Remove Loading screen from viewport
v1.4.0-linux,Create struct for Location and Rotation of actor in Unreal
v1.4.0-linux,new_actor_spawn_params.NameMode = FActorSpawnParameters::ESpawnActorNameMode::Required_ReturnNull;
v1.4.0-linux,Write the binvox file using run-length encoding
v1.4.0-linux,"where each pair of bytes is of the format (run value, run length)"
v1.4.0-linux,This is a run (repeated bit value)
v1.4.0-linux,End of a run
v1.4.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.4.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.4.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.4.0-linux,"AActor* actor = UAirBlueprintLib::FindActor<AActor>(simmode_, FString(object_name.c_str()));"
v1.4.0-linux,Split the tag string into individual tags.
v1.4.0-linux,Texture swap on actors that have all of those tags.
v1.4.0-linux,----------- Plotting APIs ----------/
v1.4.0-linux,"plot line for points 0-1, 1-2, 2-3"
v1.4.0-linux,"plot line for points 0-1, 2-3, 4-5... must be even number of points"
v1.4.0-linux,assert points_start.size() == poinst_end.size()
v1.4.0-linux,assert positions.size() == strings.size()
v1.4.0-linux,assert poses.size() == names.size()
v1.4.0-linux,Recording APIs
v1.4.0-linux,by default all image types are disabled
v1.4.0-linux,use final color for all calculations
v1.4.0-linux,TODO: avoid the need to override const cast here
v1.4.0-linux,if the viewport is taller than it is wide
v1.4.0-linux,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v1.4.0-linux,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v1.4.0-linux,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v1.4.0-linux,use final color for all calculations
v1.4.0-linux,TODO: should we be ignoring position and orientation settings here?
v1.4.0-linux,TODO: can we eliminate storing NedTransform?
v1.4.0-linux,if (!std::isnan(setting.target_gamma))
v1.4.0-linux,camera-> = setting.target_gamma;
v1.4.0-linux,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.4.0-linux,else nothing to enable
v1.4.0-linux,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.4.0-linux,if (controller && controller->GetViewTarget() == this)
v1.4.0-linux,controller->SetViewTarget(nullptr);
v1.4.0-linux,"Check whether requested map exists, this could be very slow if LevelName is a short package name"
v1.4.0-linux,Create Unique Name for sub-level package
v1.4.0-linux,Setup streaming level object that will load specified map
v1.4.0-linux,Transform
v1.4.0-linux,Map to Load
v1.4.0-linux,Add the new level to world.
v1.4.0-linux,TODO: explore screenshot option
v1.4.0-linux,addScreenCaptureHandler(camera->GetWorld());
v1.4.0-linux,TODO: may be we should have these methods non-const?
v1.4.0-linux,We don't do game/render thread synchronization for safe method.
v1.4.0-linux,We just blindly sleep for 200ms (the old way)
v1.4.0-linux,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.4.0-linux,Make sure that all alpha values are opaque.
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,TODO: change naming conventions to same as other files?
v1.4.0-linux,"context->GetWorld()->SetNewWorldOrigin(FIntVector(0, 0, 0));"
v1.4.0-linux,Enable/disable primary viewport rendering flag
v1.4.0-linux,This disables rendering of the main viewport in the same way as the
v1.4.0-linux,"console command ""show rendering"" would do."
v1.4.0-linux,"When getting an image through the API, the image is produced after the render"
v1.4.0-linux,thread has finished rendering the current and the subsequent frame. This means
v1.4.0-linux,that the frame rate for obtaining images through the API is only half as high as
v1.4.0-linux,"it could be, since only every other image is actually captured. We work around"
v1.4.0-linux,this by telling the viewport to flush the rendering queue at the end of each
v1.4.0-linux,drawn frame so that it executes our render request at that point already.
v1.4.0-linux,Do this only if the main viewport is not being rendered anyway in case there are
v1.4.0-linux,any adverse performance effects during main rendering.
v1.4.0-linux,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v1.4.0-linux,nothing to do for now
v1.4.0-linux,"if hidden, clear any existing messages"
v1.4.0-linux,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.4.0-linux,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.4.0-linux,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.4.0-linux,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.4.0-linux,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.4.0-linux,Find mesh in /Game and /AirSim asset registry. When more plugins are added this function will have to change
v1.4.0-linux,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.4.0-linux,{
v1.4.0-linux,InitializeObjectStencilID(*comp);
v1.4.0-linux,}
v1.4.0-linux,"Takes a UStaticMeshComponent, USkinnedMeshComponent or ALandscapeProxy and returns their custom stencil ID if"
v1.4.0-linux,their meshes's name or their owner's name (depending on the naming method in mesh_naming_method_) equals mesh_name
v1.4.0-linux,"The skybox is ignored here as it is huge, and really is of no use to the end user typically. Also the associated meshes with the cameras"
v1.4.0-linux,Various checks if there is even a valid mesh
v1.4.0-linux,Need to force the render command to go through cause on the next iteration the buffer no longer exists
v1.4.0-linux,Unreal stores more vertices than triangles. So here we find the highest referenced vertex and ignore any after that
v1.4.0-linux,can we see followee?
v1.4.0-linux,remove mapping
v1.4.0-linux,removing binding
v1.4.0-linux,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.4.0-linux,"some point. At the moment, manually swapping Red and Blue"
v1.4.0-linux,Copy scaled image into destination thumb
v1.4.0-linux,Compress data - convert into a .png
v1.4.0-linux,if we already have attached actor
v1.4.0-linux,#ifdef _MSC_VER
v1.4.0-linux,//print to VS output window
v1.4.0-linux,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.4.0-linux,#endif
v1.4.0-linux,also do default logging
v1.4.0-linux,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.4.0-linux,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.4.0-linux,{
v1.4.0-linux,if (GEngine != nullptr)
v1.4.0-linux,{
v1.4.0-linux,return GEngine->GameUserSettings;
v1.4.0-linux,}
v1.4.0-linux,return nullptr;
v1.4.0-linux,}
v1.4.0-linux,UGameUserSettings* game_settings = GetGameUserSettings();
v1.4.0-linux,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.4.0-linux,game_settings->ApplySettings(true);
v1.4.0-linux,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.4.0-linux,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.4.0-linux,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.4.0-linux,todo unused. need to manually plots tf axes' line in right handed FLU instead of using DrawDebugCoordinateSystem
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,plugin startup
v1.4.0-linux,plugin shutdown
v1.4.0-linux,initialize state
v1.4.0-linux,add listener for pawn's collision event
v1.4.0-linux,compute our home point
v1.4.0-linux,default behavior is to call update every tick
v1.4.0-linux,"for custom physics engine, this method should be overridden and update should be"
v1.4.0-linux,called from every physics tick
v1.4.0-linux,add cameras that already exists in pawn
v1.4.0-linux,create or replace cameras specified in settings
v1.4.0-linux,setup individual cameras
v1.4.0-linux,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.4.0-linux,for each camera in settings
v1.4.0-linux,get pose
v1.4.0-linux,spawn and attach camera to pawn
v1.4.0-linux,add on to our collection
v1.4.0-linux,Deflect along the surface when we collide.
v1.4.0-linux,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.4.0-linux,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.4.0-linux,-1 to 1 --> 0 to 1
v1.4.0-linux,-1 to 1
v1.4.0-linux,these will be available for devices like steering wheels
v1.4.0-linux,switch index 0 to 7 for FrSky Taranis RC is:
v1.4.0-linux,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.4.0-linux,TODO: should below be at controller level info?
v1.4.0-linux,else don't waste time
v1.4.0-linux,sync environment from kinematics
v1.4.0-linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.4.0-linux,void playBack()
v1.4.0-linux,{
v1.4.0-linux,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.4.0-linux,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.4.0-linux,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.4.0-linux,}
v1.4.0-linux,TODO: refactor below code used for playback
v1.4.0-linux,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.4.0-linux,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.4.0-linux,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.4.0-linux,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.4.0-linux,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.4.0-linux,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.4.0-linux,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.4.0-linux,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.4.0-linux,}
v1.4.0-linux,parameters in NED frame
v1.4.0-linux,translate to new PawnSimApi position & orientation from NED to NEU
v1.4.0-linux,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.4.0-linux,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.4.0-linux,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.4.0-linux,checked at the start of next tick
v1.4.0-linux,allow teleportation
v1.4.0-linux,if collisions are not enabled
v1.4.0-linux,or we have collided but passthrough is enabled
v1.4.0-linux,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.4.0-linux,"without flip flopping, collisions can't be detected"
v1.4.0-linux,update kinematics from pawn's movement instead of physics engine
v1.4.0-linux,by default we update kinematics from UE pawn
v1.4.0-linux,if SimMod uses its own physics engine then this should be overriden
v1.4.0-linux,no default action in this base class
v1.4.0-linux,TODO: because this bug we are using alternative code with stringstream
v1.4.0-linux,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.4.0-linux,std::stringstream ss;
v1.4.0-linux,"ss << timestamp_millis << ""\t"";"
v1.4.0-linux,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.4.0-linux,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.4.0-linux,"ss << ""\n"";"
v1.4.0-linux,return ss.str();
v1.4.0-linux,"read pixels from render target using render thread, then compress the result into PNG"
v1.4.0-linux,argument on the thread that calls this method.
v1.4.0-linux,TODO: is below really needed?
v1.4.0-linux,make sure we are not on the rendering thread
v1.4.0-linux,TODO: below doesn't work right now because it must be running in game thread
v1.4.0-linux,below is documented method but more expensive because it forces flush
v1.4.0-linux,wait for render thread to pick up our task
v1.4.0-linux,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.4.0-linux,capture CameraPose for this frame
v1.4.0-linux,The completion is called immeidately after GameThread sends the
v1.4.0-linux,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.4.0-linux,execute *immediately* after RenderThread renders the scene!
v1.4.0-linux,"while we're still on GameThread, enqueue request for capture the scene!"
v1.4.0-linux,wait for this task to complete
v1.4.0-linux,log a message and continue wait
v1.4.0-linux,lamda function still references a few objects for which there is no refcount.
v1.4.0-linux,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.4.0-linux,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.4.0-linux,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.4.0-linux,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.4.0-linux,Fill out your copyright notice in the Description page of Project Settings.
v1.4.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.4.0-linux,UWorld* World = GetWorld();
v1.4.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.4.0-linux,still need the menu class for f10
v1.4.0-linux,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v1.4.0-linux,showWeatherMenu(WorldContextObject);
v1.4.0-linux,"if weather is not enabled, dont allow any weather values to be set"
v1.4.0-linux,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v1.4.0-linux,and must be set to true or false before this.
v1.4.0-linux,WeatherEnabled will always be false
v1.4.0-linux,"NOTE: weather enabled must be set first, before other params for this to work"
v1.4.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.4.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.4.0-linux,"get all menu actors, if any"
v1.4.0-linux,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.4.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.4.0-linux,"get all menu actors, if any"
v1.4.0-linux,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.4.0-linux,"get all menu actors, if any, then hide the menu"
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,Stuff to filter out XInput devices
v1.4.0-linux,-----------------------------------------------------------------------------
v1.4.0-linux,"Defines, constants, and global variables"
v1.4.0-linux,-----------------------------------------------------------------------------
v1.4.0-linux,Magnitude ranges from -1 to 1
v1.4.0-linux,Strength ranges from 0 to 1
v1.4.0-linux,Autocenter
v1.4.0-linux,Rumble
v1.4.0-linux,Register with the DirectInput subsystem and get a pointer
v1.4.0-linux,to a IDirectInput interface we can use.
v1.4.0-linux,Create a DInput object
v1.4.0-linux,Look for a simple joystick we can use for this sample program.
v1.4.0-linux,Make sure we got a joystick
v1.4.0-linux,"Set the data format to ""simple joystick"" - a predefined data format"
v1.4.0-linux,
v1.4.0-linux,"A data format specifies which controls on a device we are interested in,"
v1.4.0-linux,and how they should be reported. This tells DInput that we will be
v1.4.0-linux,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.4.0-linux,Set the cooperative level to let DInput know how this device should
v1.4.0-linux,interact with the system and with other DInput applications.
v1.4.0-linux,Enumerate the joystick objects. The callback function enabled user
v1.4.0-linux,"interface elements for objects that are found, and sets the min/max"
v1.4.0-linux,values property for discovered axes.
v1.4.0-linux,-----------------------------------------------------------------------------
v1.4.0-linux,Enum each PNP device using WMI and check each device ID to see if it contains
v1.4.0-linux,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.4.0-linux,Unfortunately this information can not be found by just using DirectInput.
v1.4.0-linux,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.4.0-linux,XInput devices.
v1.4.0-linux,
v1.4.0-linux,This function stores the list of xinput devices in a linked list
v1.4.0-linux,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.4.0-linux,-----------------------------------------------------------------------------
v1.4.0-linux,CoInit if needed
v1.4.0-linux,Create WMI
v1.4.0-linux,Create BSTRs for WMI
v1.4.0-linux,Connect to WMI
v1.4.0-linux,Switch security level to IMPERSONATE
v1.4.0-linux,Get list of Win32_PNPEntity devices
v1.4.0-linux,Loop over all devices
v1.4.0-linux,Get 20 at a time
v1.4.0-linux,"For each device, get its device ID"
v1.4.0-linux,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.4.0-linux,Unfortunately this information can not be found by just using DirectInput
v1.4.0-linux,"If it does, then get the VID/PID from var.bstrVal"
v1.4.0-linux,Add the VID/PID to a linked list
v1.4.0-linux,-----------------------------------------------------------------------------
v1.4.0-linux,Returns true if the DirectInput device is also an XInput device.
v1.4.0-linux,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.4.0-linux,-----------------------------------------------------------------------------
v1.4.0-linux,Check each xinput device to see if this device's vid/pid matches
v1.4.0-linux,-----------------------------------------------------------------------------
v1.4.0-linux,Cleanup needed for IsXInputDevice()
v1.4.0-linux,-----------------------------------------------------------------------------
v1.4.0-linux,Cleanup linked list
v1.4.0-linux,-----------------------------------------------------------------------------
v1.4.0-linux,Name: EnumJoysticksCallback()
v1.4.0-linux,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.4.0-linux,device interface on it so we can play with it.
v1.4.0-linux,-----------------------------------------------------------------------------
v1.4.0-linux,Skip anything other than the perferred joystick device as defined by the control panel.
v1.4.0-linux,Instead you could store all the enumerated joysticks and let the user pick.
v1.4.0-linux,Obtain an interface to the enumerated joystick.
v1.4.0-linux,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.4.0-linux,it while we were in the middle of enumerating it.)
v1.4.0-linux,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.4.0-linux,could store all the enumerated joysticks and let the user pick.
v1.4.0-linux,-----------------------------------------------------------------------------
v1.4.0-linux,Name: EnumObjectsCallback()
v1.4.0-linux,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.4.0-linux,joystick. This function enables user interface elements for objects
v1.4.0-linux,"that are found to exist, and scales axes min/max values."
v1.4.0-linux,-----------------------------------------------------------------------------
v1.4.0-linux,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.4.0-linux,enumerated axis in order to scale min/max values.
v1.4.0-linux,Set the range for the axis
v1.4.0-linux,Set the UI to reflect what objects the joystick supports
v1.4.0-linux,-----------------------------------------------------------------------------
v1.4.0-linux,Name: UpdateInputState()
v1.4.0-linux,Desc: Get the input device's state and display it.
v1.4.0-linux,-----------------------------------------------------------------------------
v1.4.0-linux,Poll the device to read the current state
v1.4.0-linux,DInput is telling us that the input stream has been
v1.4.0-linux,"interrupted. We aren't tracking any state between polls, so"
v1.4.0-linux,we don't have any special reset that needs to be done. We
v1.4.0-linux,just re-acquire and try again.
v1.4.0-linux,while (hr == DIERR_INPUTLOST)
v1.4.0-linux,hr = g_pJoystick->Acquire();
v1.4.0-linux,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.4.0-linux,may occur when the app is minimized or in the process of
v1.4.0-linux,"switching, so just try again later"
v1.4.0-linux,Get the input's device state
v1.4.0-linux,Axes
v1.4.0-linux,Slider controls
v1.4.0-linux,Points of view
v1.4.0-linux,Buttons
v1.4.0-linux,-----------------------------------------------------------------------------
v1.4.0-linux,Name: FreeDirectInput()
v1.4.0-linux,Desc: Initialize the DirectInput variables.
v1.4.0-linux,-----------------------------------------------------------------------------
v1.4.0-linux,Unacquire the device one last time just in case
v1.4.0-linux,the app tried to exit while the device is still acquired.
v1.4.0-linux,Release any DirectInput objects.
v1.4.0-linux,nop
v1.4.0-linux,normalize min to max --> 0 to 1
v1.4.0-linux,normalize 0 to 1 --> -1 to 1
v1.4.0-linux,#include <libudev.h>
v1.4.0-linux,implementation for unsupported OS
v1.4.0-linux,if this is new index
v1.4.0-linux,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.4.0-linux,close previous one
v1.4.0-linux,open new device
v1.4.0-linux,if open was successful
v1.4.0-linux,read the device
v1.4.0-linux,if we didn't had valid read
v1.4.0-linux,"NOTE if this condition is not met, we're probably out of sync and this"
v1.4.0-linux,Joystick instance is likely unusable
v1.4.0-linux,TODO: set below to false?
v1.4.0-linux,state.is_valid = false;
v1.4.0-linux,else ignore
v1.4.0-linux,TODO: implement this for linux
v1.4.0-linux,TODO: implement this for linux
v1.4.0-linux,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.4.0-linux,{
v1.4.0-linux,"manufacturerID = productID = """";"
v1.4.0-linux,// Use udev to look up the product and manufacturer IDs
v1.4.0-linux,struct udev *udev = udev_new();
v1.4.0-linux,if (udev) {
v1.4.0-linux,char sysname[32];
v1.4.0-linux,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.4.0-linux,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.4.0-linux,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.4.0-linux,if (!dev)
v1.4.0-linux,{
v1.4.0-linux,"message = ""Unable to find parent USB device"";"
v1.4.0-linux,return false;
v1.4.0-linux,}
v1.4.0-linux,std::stringstream ss;
v1.4.0-linux,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.4.0-linux,ss >> manufacturerID;
v1.4.0-linux,ss.clear();
v1.4.0-linux,"ss.str("""");"
v1.4.0-linux,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.4.0-linux,ss >> productID;
v1.4.0-linux,udev_device_unref(dev);
v1.4.0-linux,}
v1.4.0-linux,else
v1.4.0-linux,{
v1.4.0-linux,"message = ""Cannot create udev"";"
v1.4.0-linux,return false;
v1.4.0-linux,}
v1.4.0-linux,udev_unref(udev);
v1.4.0-linux,return true;
v1.4.0-linux,}
v1.4.0-linux,required for pimpl
v1.4.0-linux,TODO: anyway to workaround const_cast?
v1.4.0-linux,FGenericPlatformMisc::PlatformInit();
v1.4.0-linux,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.4.0-linux,TODO: index check
v1.4.0-linux,create main widget
v1.4.0-linux,synchronize PIP views
v1.4.0-linux,TODO: should we only do below on SceneCapture2D components and cameras?
v1.4.0-linux,avoid motion blur so capture images don't get
v1.4.0-linux,use two different methods to set console var because sometime it doesn't seem to work
v1.4.0-linux,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.4.0-linux,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.4.0-linux,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.4.0-linux,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.4.0-linux,setup defaults
v1.4.0-linux,Attempts to parse the settings text from one of multiple locations.
v1.4.0-linux,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.4.0-linux,"Next, check the executable's working directory for the settings file."
v1.4.0-linux,"Finally, check the user's documents folder."
v1.4.0-linux,"If the settings file cannot be read, throw an exception"
v1.4.0-linux,Attempts to parse the settings file path or the settings text from the command line
v1.4.0-linux,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.4.0-linux,"Example (Path): AirSim.exe --settings ""C:\path\to\settings.json"""
v1.4.0-linux,"Example (Text): AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.4.0-linux,"Returns true if the argument is present, false otherwise."
v1.4.0-linux,build image file name
v1.4.0-linux,write image file
v1.4.0-linux,write to CSV file
v1.4.0-linux,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.4.0-linux,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.4.0-linux,make sire all vars are set up
v1.4.0-linux,"TODO: should we go as fast as possible, or should we limit this to a particular number of"
v1.4.0-linux,frames per second?
v1.4.0-linux,BG: Workaround to get sync ground truth. See https://github.com/Microsoft/AirSim/issues/1494 for details
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,decide which derived BP to use
v1.4.0-linux,we don't have real vehicle so no vehicle API
v1.4.0-linux,put camera little bit above vehicle
v1.4.0-linux,update ground level
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,let base class setup physics world
v1.4.0-linux,stop physics thread before we dismantle
v1.4.0-linux,setup clock in ClockFactory
v1.4.0-linux,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.4.0-linux,steppable clock returns interval that is a constant number irrespective of wall clock
v1.4.0-linux,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.4.0-linux,but that would cause vehicles like quadrotors to become unstable
v1.4.0-linux,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.4.0-linux,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.4.0-linux,get increase in clock speed
v1.4.0-linux,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.4.0-linux,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.4.0-linux,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.4.0-linux,Approach 2: scale control loop frequency if clock is speeded up
v1.4.0-linux,"for slowing down, this don't generate instability"
v1.4.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.4.0-linux,decide which derived BP to use
v1.4.0-linux,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.4.0-linux,vehicle_sim_api->reset();
v1.4.0-linux,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.4.0-linux,create vehicle API
v1.4.0-linux,setup physics vehicle
v1.4.0-linux,initialize private vars
v1.4.0-linux,calls to update* are handled by physics engine and in SimModeWorldBase
v1.4.0-linux,"Utils::log(""------Render tick-------"");"
v1.4.0-linux,"if reset is pending then do it first, no need to do other things until next tick"
v1.4.0-linux,move collision info from rendering engine to vehicle
v1.4.0-linux,update rotor poses
v1.4.0-linux,if we did reset then don't worry about synchronizing states for this tick
v1.4.0-linux,Continue to wait for reset
v1.4.0-linux,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.4.0-linux,*** Start: UpdatableState implementation ***//
v1.4.0-linux,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.4.0-linux,environment update for current position
v1.4.0-linux,update forces on vertices
v1.4.0-linux,update to controller must be done after kinematics have been updated by physics engine
v1.4.0-linux,*** End: UpdatableState implementation ***//
v1.4.0-linux,get references of existing camera
v1.4.0-linux,setup clock in PhysX
v1.4.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.4.0-linux,decide which derived BP to use
v1.4.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.4.0-linux,Setup suspension forces
v1.4.0-linux,Find the tire object and set the data for it
v1.4.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.4.0-linux,Setup suspension forces
v1.4.0-linux,Find the tire object and set the data for it
v1.4.0-linux,Create In-Car camera component
v1.4.0-linux,In car HUD
v1.4.0-linux,Create text render component for in car speed display
v1.4.0-linux,Create text render component for in car gear display
v1.4.0-linux,Setup the audio component and allocate it a sound cue
v1.4.0-linux,Colors for the in-car gear display. One for normal one for reverse
v1.4.0-linux,Wheels/Tires
v1.4.0-linux,Setup the wheels
v1.4.0-linux,Adjust the tire loading
v1.4.0-linux,Engine
v1.4.0-linux,Torque setup
v1.4.0-linux,Adjust the steering
v1.4.0-linux,Transmission
v1.4.0-linux,We want 4wd
v1.4.0-linux,Drive the front wheels a little more than the rear
v1.4.0-linux,Automatic gearbox
v1.4.0-linux,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.4.0-linux,Physics settings
v1.4.0-linux,Adjust the center of mass - the buggy is quite low
v1.4.0-linux,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.4.0-linux,put camera little bit above vehicle
v1.4.0-linux,update physics material
v1.4.0-linux,Update the strings used in the HUD (in-car and on-screen)
v1.4.0-linux,Set the string in the in-car HUD
v1.4.0-linux,Pass the engine RPM to the sound component
v1.4.0-linux,Start an engine sound playing
v1.4.0-linux,Using FText because this is display text that should be localizable
v1.4.0-linux,Setup the text render component strings
v1.4.0-linux,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.4.0-linux,below is not needed
v1.4.0-linux,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.4.0-linux,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.4.0-linux,TODO: should do reset() here?
v1.4.0-linux,create vehicle params
v1.4.0-linux,these are called on render ticks
v1.4.0-linux,TODO: do we need this for cars?
v1.4.0-linux,TODO: move this to SimModeBase?
v1.4.0-linux,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.4.0-linux,reset();
v1.4.0-linux,return;
v1.4.0-linux,}
v1.4.0-linux,Thrustmaster devices
v1.4.0-linux,"Anything else, typically Logitech G920 wheel"
v1.4.0-linux,Two steel levers behind wheel
v1.4.0-linux,if API-client control is not active then we route keyboard/joystick control to car
v1.4.0-linux,all car controls from anywhere must be routed through API component
v1.4.0-linux,*** Start: UpdatableState implementation ***//
v1.4.0-linux,physics tick
v1.4.0-linux,*** End: UpdatableState implementation ***//
v1.4.0-linux,TODO: directly accept getVehicleSimApis() using generic container
v1.4.0-linux,remove everything that we created in BeginPlay
v1.4.0-linux,we use custom debug reporting for this class
v1.4.0-linux,perform any expensive rendering update outside of lock region
v1.4.0-linux,no need to call base reset because of our custom implementation
v1.4.0-linux,TODO: this is going to cause circular references which is fine here but
v1.4.0-linux,in future we should consider moving SimMode not derived from AActor and move
v1.4.0-linux,it to AirLib and directly implement WorldSimApiBase interface
v1.4.0-linux,get player start
v1.4.0-linux,this must be done from within actor otherwise we don't get player start
v1.4.0-linux,Grab player location
v1.4.0-linux,Move the world origin to the player's location (this moves the coordinate system and adds
v1.4.0-linux,a corresponding offset to all positions to compensate for the shift)
v1.4.0-linux,"Regrab the player's position after the offset has been added (which should be 0,0,0 now)"
v1.4.0-linux,UWeatherLib::showWeatherMenu(World);
v1.4.0-linux,else don't init
v1.4.0-linux,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v1.4.0-linux,tod_sim_clock_start_ needs to be reset here.
v1.4.0-linux,Going from enabled to disabled
v1.4.0-linux,do these in the end to ensure that advanceTimeOfDay() doesn't see
v1.4.0-linux,any inconsistent state.
v1.4.0-linux,should be overridden by derived class
v1.4.0-linux,should be overridden by derived class
v1.4.0-linux,should be overridden by derived class
v1.4.0-linux,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.4.0-linux,default setup - this should be overridden in derived modes as needed
v1.4.0-linux,setup clock in ClockFactory
v1.4.0-linux,default implementation
v1.4.0-linux,create director
v1.4.0-linux,create external camera required for the director
v1.4.0-linux,API server start/stop
v1.4.0-linux,get UU origin of global NED frame
v1.4.0-linux,determine camera director camera default pose and spawn it
v1.4.0-linux,find all vehicle pawns
v1.4.0-linux,add vehicles from settings
v1.4.0-linux,if vehicle is of type for derived SimMode and auto creatable
v1.4.0-linux,compute initial pose
v1.4.0-linux,spawn vehicle pawn
v1.4.0-linux,create API objects for each pawn we have
v1.4.0-linux,create vehicle sim api
v1.4.0-linux,TODO: better handle no FPV vehicles scenario
v1.4.0-linux,derived class should override this method to retrieve types of pawns they support
v1.4.0-linux,derived class should override this method to retrieve types of pawns they support
v1.4.0-linux,derived class should override this method to retrieve types of pawns they support
v1.4.0-linux,derived class should override this method to retrieve types of pawns they support
v1.4.0-linux,derived class should override this method to retrieve types of pawns they support
v1.4.0-linux,derived class should override this method to retrieve types of pawns they support
v1.4.0-linux,derived class should override this method to retrieve types of pawns they support
v1.4.0-linux,Draws debug-points on main viewport for Lidar laser hits.
v1.4.0-linux,Used for debugging only.
v1.4.0-linux,Currently we are checking the sensor-collection instead of sensor-settings.
v1.4.0-linux,Also using variables to optimize not checking the collection if not needed.
v1.4.0-linux,TODO: Is it incorrect to assume LidarSimple here?
v1.4.0-linux,Draw debug-point on main viewport for Distance sensor hit
v1.4.0-linux,Find position of point hit
v1.4.0-linux,Similar to UnrealDistanceSensor.cpp#L19
v1.4.0-linux,order of Pose addition is important here because it also adds quaternions which is not commutative!
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,ctor
v1.4.0-linux,initializes information based on lidar configuration
v1.4.0-linux,calculate verticle angle distance between each laser
v1.4.0-linux,store vertical angles for each laser
v1.4.0-linux,returns a point-cloud for the tick
v1.4.0-linux,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.4.0-linux,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.4.0-linux,calculate number of points needed for each laser/channel
v1.4.0-linux,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.4.0-linux,calculate needed angle/distance between each point
v1.4.0-linux,normalize FOV start/end
v1.4.0-linux,shoot lasers
v1.4.0-linux,check if the laser is outside the requested horizontal FOV
v1.4.0-linux,"shoot laser and get the impact point, if any"
v1.4.0-linux,simulate shooting a laser via Unreal ray-tracing.
v1.4.0-linux,start position
v1.4.0-linux,We need to compose rotations here rather than rotate a vector by a quaternion
v1.4.0-linux,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.4.0-linux,get ray quaternion in lidar frame (angles must be in radians)
v1.4.0-linux,get ray quaternion in body frame
v1.4.0-linux,get ray quaternion in world frame
v1.4.0-linux,get ray vector (end position)
v1.4.0-linux,Store the segmentation id of the hit object.
v1.4.0-linux,Debug code for very specific cases.
v1.4.0-linux,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.4.0-linux,decide the frame for the point-cloud
v1.4.0-linux,current detault behavior; though it is probably not very useful.
v1.4.0-linux,not changing the default for now to maintain backwards-compat.
v1.4.0-linux,point in vehicle intertial frame
v1.4.0-linux,tranform to lidar frame
v1.4.0-linux,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.4.0-linux,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.4.0-linux,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.4.0-linux,"On the client side, if it is needed to transform this data back to the world frame,"
v1.4.0-linux,"then do the equivalent of following,"
v1.4.0-linux,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.4.0-linux,See SimModeBase::drawLidarDebugPoints()
v1.4.0-linux,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.4.0-linux,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,update ray tracing
v1.4.0-linux,"FString hit_name = FString(""None"");"
v1.4.0-linux,if (dist_hit.GetActor())
v1.4.0-linux,hit_name=dist_hit.GetActor()->GetName();
v1.4.0-linux,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.4.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,This assumes you are running DroneServer already on the same machine.
v1.4.0-linux,DroneServer must be running first.
v1.4.0-linux,enable API control
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,move commands
v1.4.0-linux,else leave as it is
v1.4.0-linux,TODO: get these in one call
v1.4.0-linux,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.4.0-linux,TODO: shouldn't we pass folder path?
v1.4.0-linux,parse
v1.4.0-linux,group the images by the current date.
v1.4.0-linux,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.4.0-linux,{
v1.4.0-linux,"return """";"
v1.4.0-linux,}
v1.4.0-linux,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.4.0-linux,{
v1.4.0-linux,return false;
v1.4.0-linux,}
v1.4.0-linux,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.4.0-linux,params.context->client.newTask();
v1.4.0-linux,}
v1.4.0-linux,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.4.0-linux,params.context->client.WaitForCompletion(0);
v1.4.0-linux,}
v1.4.0-linux,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.4.0-linux,{
v1.4.0-linux,}
v1.4.0-linux,parse command line
v1.4.0-linux,Shell callbacks
v1.4.0-linux,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.4.0-linux,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.4.0-linux,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.4.0-linux,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.4.0-linux,Add shell commands
v1.4.0-linux,TODO: add WaitForCompletion command
v1.4.0-linux,"TODO: add command line args help, arg count validation"
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v1.4.0-linux,switch to explicit hover mode so that this is the fall back when
v1.4.0-linux,move* commands are finished.
v1.4.0-linux,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.4.0-linux,TODO: implement weather for Unity
v1.4.0-linux,TODO: implement weather for Unity
v1.4.0-linux,----------------Plotting APIs-----------/
v1.4.0-linux,Recording APIs
v1.4.0-linux,Function pointers to hold the addresses of the functions that are defined in Unity
v1.4.0-linux,"Enabling all LogLevels,"
v1.4.0-linux,"Enabling all LogLevels,"
v1.4.0-linux,delete ltm;
v1.4.0-linux,initialize state
v1.4.0-linux,compute our home point
v1.4.0-linux,default behavior is to call update every tick
v1.4.0-linux,"for custom physics engine, this method should be overridden and update should be"
v1.4.0-linux,called from every physics tick
v1.4.0-linux,these will be available for devices like steering wheels
v1.4.0-linux,sync environment from kinematics
v1.4.0-linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.4.0-linux,FVector unrealPosition = getUUPosition();
v1.4.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v1.4.0-linux,not implemented
v1.4.0-linux,not implemented
v1.4.0-linux,parameters in NED frame
v1.4.0-linux,allow teleportation
v1.4.0-linux,if collisions are not enabled
v1.4.0-linux,or we have collided but passthrough is enabled
v1.4.0-linux,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.4.0-linux,"without flip flopping, collisions can't be detected"
v1.4.0-linux,by default we update kinematics from UE pawn
v1.4.0-linux,if SimMod uses its own physics engine then this should be overriden
v1.4.0-linux,no default action in this base class
v1.4.0-linux,TODO: because this bug we are using alternative code with stringstream
v1.4.0-linux,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.4.0-linux,update kinematics from pawn's movement instead of physics engine
v1.4.0-linux,TODO: update other fields?
v1.4.0-linux,implements getImages() method in the ImageCaptureBase class.
v1.4.0-linux,update ray tracing
v1.4.0-linux,TODO: index check
v1.4.0-linux,Attempts to parse the settings text from one of multiple locations.
v1.4.0-linux,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.4.0-linux,"Next, check the executable's working directory for the settings file."
v1.4.0-linux,"Finally, check the user's documents folder."
v1.4.0-linux,"If the settings file cannot be read, throw an exception"
v1.4.0-linux,let base class setup physics world
v1.4.0-linux,stop physics thread before we dismantle
v1.4.0-linux,setup clock in ClockFactory
v1.4.0-linux,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.4.0-linux,steppable clock returns interval that is a constant number irrespective of wall clock
v1.4.0-linux,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.4.0-linux,but that would cause vehicles like quadrotors to become unstable
v1.4.0-linux,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.4.0-linux,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.4.0-linux,get increase in clock speed
v1.4.0-linux,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.4.0-linux,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.4.0-linux,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.4.0-linux,Approach 2: scale control loop frequency if clock is speeded up
v1.4.0-linux,"for slowing down, this don't generate instability"
v1.4.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.4.0-linux,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.4.0-linux,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.4.0-linux,create vehicle API
v1.4.0-linux,setup physics vehicle
v1.4.0-linux,initialize private vars
v1.4.0-linux,"if reset is pending then do it first, no need to do other things until next tick"
v1.4.0-linux,move collision info from rendering engine to vehicle
v1.4.0-linux,update rotor poses
v1.4.0-linux,if we did reset then don't worry about synchronizing states for this tick
v1.4.0-linux,Continue to wait for reset
v1.4.0-linux,*** Start: UpdatableState implementation ***//
v1.4.0-linux,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.4.0-linux,environment update for current position
v1.4.0-linux,update forces on vertices
v1.4.0-linux,update to controller must be done after kinematics have been updated by physics engine
v1.4.0-linux,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.4.0-linux,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.4.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.4.0-linux,*** End: UpdatableState implementation ***//
v1.4.0-linux,TODO: should do reset() here?
v1.4.0-linux,these are called on render ticks
v1.4.0-linux,TODO: do we need this for cars?
v1.4.0-linux,Thrustmaster devices
v1.4.0-linux,"Anything else, typically Logitech G920 wheel"
v1.4.0-linux,Two steel levers behind wheel
v1.4.0-linux,if API-client control is not active then we route keyboard/joystick control to car
v1.4.0-linux,all car controls from anywhere must be routed through API component
v1.4.0-linux,*** Start: UpdatableState implementation ***//
v1.4.0-linux,physics tick
v1.4.0-linux,void CarPawnSimApi::reportState(StateReporter& reporter)
v1.4.0-linux,{
v1.4.0-linux,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.4.0-linux,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.4.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.4.0-linux,}
v1.4.0-linux,*** End: UpdatableState implementation ***//
v1.4.0-linux,remove everything that we created in BeginPlay
v1.4.0-linux,we use custom debug reporting for this class
v1.4.0-linux,perform any expensive rendering update outside of lock region
v1.4.0-linux,no need to call base reset because of our custom implementation
v1.4.0-linux,should be overridden by derived class
v1.4.0-linux,should be overridden by derived class
v1.4.0-linux,commenting this out for now to avoid unintentional Unity startup failure
v1.4.0-linux,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v1.4.0-linux,should be overridden by derived class
v1.4.0-linux,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.4.0-linux,default setup - this should be overridden in derived modes as needed
v1.4.0-linux,setup clock in ClockFactory
v1.4.0-linux,API server start/stop
v1.4.0-linux,determine camera director camera default pose and spawn it
v1.4.0-linux,derived class should override this method to retrieve types of pawns they support
v1.4.0-linux,derived class should override this method to retrieve types of pawns they support
v1.4.0-linux,60 acres park:
v1.4.0-linux,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.4.0-linux,marymoore park
v1.4.0-linux,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.4.0-linux,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.4.0-linux,DepthNavThreshold depthNav;
v1.4.0-linux,DepthNavOptAStar depthNav;
v1.4.0-linux,DepthNavThreshold depthNav;
v1.4.0-linux,DepthNavOptAStar depthNav;
v1.4.0-linux,Cleanup
v1.4.0-linux,runDepthNavGT();
v1.4.0-linux,runDepthNavSGM();
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,by Sudipta Sinha
v1.4.0-linux,adapted for AirSim by Matthias Mueller
v1.4.0-linux,first row
v1.4.0-linux,last row
v1.4.0-linux,Local quadratic fit of cost and subpixel refinement.
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,by Sudipta Sinha
v1.4.0-linux,adapted for AirSim by Matthias Mueller
v1.4.0-linux,uint64_t x64 = (uint64_t)x;
v1.4.0-linux,uint64_t y64 = (uint64_t)y;
v1.4.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.4.0-linux,Licensed under the MIT License.
v1.4.0-linux,by Sudipta Sinha
v1.4.0-linux,adapted for AirSim by Matthias Mueller
v1.4.0-linux,ensure that disparity range is a multiple of 8
v1.4.0-linux,sgm stereo
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,read settings and override defaults
v1.3.1-windows,allow json overrides on a per-vehicle basis.
v1.3.1-windows,start server in async mode
v1.3.1-windows,check messages
v1.3.1-windows,In settings.json first activate computer vision mode:
v1.3.1-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.1-windows,monitor car state while you drive it manually.
v1.3.1-windows,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v1.3.1-windows,denominator from microns^3 to microns * m^2)
v1.3.1-windows,First set everything to 0.
v1.3.1-windows,Next set all objects of interest provided to corresponding object IDs
v1.3.1-windows,segIdDict values MUST match tempEmissivityNew labels.
v1.3.1-windows,"Connect to AirSim, UAV mode."
v1.3.1-windows,Choose temperature values for winter or summer.
v1.3.1-windows,""""""""
v1.3.1-windows,winter
v1.3.1-windows,""""""""
v1.3.1-windows,summer
v1.3.1-windows,Read camera response.
v1.3.1-windows,Calculate radiance.
v1.3.1-windows,Set IDs in AirSim environment.
v1.3.1-windows,plot red arrows for 30 seconds
v1.3.1-windows,plot magenta arrows for 15 seconds
v1.3.1-windows,plot red arrows for 10 seconds
v1.3.1-windows,plot 2 white arrows which are persistent
v1.3.1-windows,plot points
v1.3.1-windows,"plot line strip. 0-1, 1-2, 2-3"
v1.3.1-windows,"plot line list. 0-1, 2-3, 4-5. Must be even."
v1.3.1-windows,plot transforms
v1.3.1-windows,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=0.0, yaw=yaw)) for x, y, yaw in zip(np.linspace(0,10,10), np.linspace(0,0,10), np.linspace(0,np.pi,10))],"
v1.3.1-windows,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.3.1-windows,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=roll, yaw=0.0)) for x, y, roll in zip(np.linspace(0,10,10), np.linspace(1,1,10), np.linspace(0,np.pi,10))],"
v1.3.1-windows,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.3.1-windows,In settings.json first activate computer vision mode:
v1.3.1-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.1-windows,"define abstract class to return next vector in the format (x,y,yaw)"
v1.3.1-windows,"compute vector, distance and angle to goal"
v1.3.1-windows,compute box of interest
v1.3.1-windows,scale by weight matrix (optional)
v1.3.1-windows,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.3.1-windows,detect collision
v1.3.1-windows,compute box of interest
v1.3.1-windows,detect collision
v1.3.1-windows,Same as above but decide to go left or right based on average or some metric like that
v1.3.1-windows,"compute resultant normalized vector, distance and angle"
v1.3.1-windows,compute bounding box size
v1.3.1-windows,convert horizonal fov to vertical fov
v1.3.1-windows,matrix with all ones
v1.3.1-windows,matrix with max weight in center and decreasing linearly with distance from center
v1.3.1-windows,matrix with max weight in center and decreasing quadratically with distance from center
v1.3.1-windows,"print (""Saving images to %s"" % tmp_dir)"
v1.3.1-windows,airsim.wait_key('Press any key to start')
v1.3.1-windows,"Define start position, goal and size of UAV"
v1.3.1-windows,Define parameters and thresholds
v1.3.1-windows,initial position
v1.3.1-windows,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.3.1-windows,time.sleep(1)
v1.3.1-windows,get response
v1.3.1-windows,get numpy array
v1.3.1-windows,reshape array to 2D array H X W
v1.3.1-windows,write to png
v1.3.1-windows,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.3.1-windows,pose = client.simGetPose()
v1.3.1-windows,pp.pprint(pose)
v1.3.1-windows,time.sleep(5)
v1.3.1-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.3.1-windows,################### OLD CODE
v1.3.1-windows,timer = 0
v1.3.1-windows,time_obs = 50
v1.3.1-windows,bObstacle = False
v1.3.1-windows,if (bObstacle):
v1.3.1-windows,timer = timer + 1
v1.3.1-windows,if timer > time_obs:
v1.3.1-windows,bObstacle = False
v1.3.1-windows,timer = 0
v1.3.1-windows,else:
v1.3.1-windows,yaw = target_angle
v1.3.1-windows,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.3.1-windows,if (np.average(img2d_box) < coll_thres):
v1.3.1-windows,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.3.1-windows,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.3.1-windows,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.3.1-windows,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.3.1-windows,"print('left: ', img2d_box_l_avg)"
v1.3.1-windows,"print('right: ', img2d_box_r_avg)"
v1.3.1-windows,if img2d_box_l_avg > img2d_box_r_avg:
v1.3.1-windows,##Go LEFT
v1.3.1-windows,#y_offset = y_offset-1
v1.3.1-windows,yaw = yaw - radians(10)
v1.3.1-windows,bObstacle = True
v1.3.1-windows,else:
v1.3.1-windows,##Go RIGHT
v1.3.1-windows,#y_offset = y_offset+1
v1.3.1-windows,yaw = yaw + radians(10)
v1.3.1-windows,bObstacle = true
v1.3.1-windows,"print('yaw: ', yaw)"
v1.3.1-windows,In settings.json first activate computer vision mode:
v1.3.1-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.1-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.3.1-windows,In settings.json first activate computer vision mode:
v1.3.1-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.1-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.3.1-windows,pip install opencv-python
v1.3.1-windows,In settings.json first activate computer vision mode:
v1.3.1-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.1-windows,for block environment
v1.3.1-windows,regex are case insensitive
v1.3.1-windows,#for neighborhood environment
v1.3.1-windows,set object ID for sky
v1.3.1-windows,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.3.1-windows,get segmentation image in various formats
v1.3.1-windows,save segmentation images in various formats
v1.3.1-windows,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.3.1-windows,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.3.1-windows,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v1.3.1-windows,find unique colors
v1.3.1-windows,In settings.json first activate computer vision mode:
v1.3.1-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.1-windows,objects can be named in two ways:
v1.3.1-windows,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.3.1-windows,default name is auto-generated and varies from run-to-run.
v1.3.1-windows,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.3.1-windows,
v1.3.1-windows,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.3.1-windows,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.3.1-windows,https://answers.unrealengine.com/revisions/790629.html
v1.3.1-windows,below works in Blocks environment
v1.3.1-windows,------------------------------------ Get current pose ------------------------------------------------
v1.3.1-windows,search object by name:
v1.3.1-windows,search another object by tag
v1.3.1-windows,search non-existent object
v1.3.1-windows,------------------------------------ Set new pose ------------------------------------------------
v1.3.1-windows,here we move with teleport enabled so collisions are ignored
v1.3.1-windows,here we move with teleport enabled so collisions are not ignored
v1.3.1-windows,move non-existent object
v1.3.1-windows,------------------------------------ Get new pose ------------------------------------------------
v1.3.1-windows,search another object by tag
v1.3.1-windows,search non-existent object
v1.3.1-windows,Import this module to automatically setup path to local airsim module
v1.3.1-windows,This module first tries to see if airsim module is installed via pip
v1.3.1-windows,If it does then we don't do anything else
v1.3.1-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.3.1-windows,and if it does then we add that in sys.path
v1.3.1-windows,this class simply tries to see if airsim
v1.3.1-windows,if airsim module is installed then don't do anything else
v1.3.1-windows,import pkgutil
v1.3.1-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.3.1-windows,if airsim_loader is not None:
v1.3.1-windows,return
v1.3.1-windows,"Roll is applied first, then pitch, then yaw."
v1.3.1-windows,Turn the camera position into a column vector.
v1.3.1-windows,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v1.3.1-windows,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v1.3.1-windows,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v1.3.1-windows,Recreate the perspective projection of the camera.
v1.3.1-windows,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v1.3.1-windows,Set pose and sleep after to ensure the pose sticks before capturing image.
v1.3.1-windows,Capture segmentation (IR) and scene images.
v1.3.1-windows,Change images into numpy arrays.
v1.3.1-windows,Capture images for a certain amount of time in seconds (half hour now)
v1.3.1-windows,Capture image - pose.position x_val access may change w/ AirSim
v1.3.1-windows,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v1.3.1-windows,Convert color scene image to BGR for write out with cv2.
v1.3.1-windows,"Connect to AirSim, UAV mode."
v1.3.1-windows,Look for objects with names that match a regular expression.
v1.3.1-windows,"Sample calls to main, varying camera angle and altitude."
v1.3.1-windows,"straight down, 400ft"
v1.3.1-windows,"straight down, 200ft"
v1.3.1-windows,"45 degrees, 200ft -- note that often object won't be scene since position"
v1.3.1-windows,is set exactly to object's
v1.3.1-windows,"45 degrees, 400ft -- note that often object won't be scene since position"
v1.3.1-windows,is set exactly to object's
v1.3.1-windows,In settings.json first activate computer vision mode:
v1.3.1-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.1-windows,xn = 1 + x*5  # some random number
v1.3.1-windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,monitor car state while you drive it manually.
v1.3.1-windows,get state of the car
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,go forward
v1.3.1-windows,get state of the car
v1.3.1-windows,Python client example to change time-of-day using APIs
v1.3.1-windows,
v1.3.1-windows,Changes time of the day and makes the car move around
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,flip between specific time and default time
v1.3.1-windows,go forward
v1.3.1-windows,Go forward + steer right
v1.3.1-windows,main
v1.3.1-windows,import gym #pip install gym
v1.3.1-windows,Local variable access is faster in loops
v1.3.1-windows,"if not wrapping over current pointer,"
v1.3.1-windows,then check if there is terminal state wrapped inside
v1.3.1-windows,"If index > history_length, take from a slice"
v1.3.1-windows,Metrics accumulator
v1.3.1-windows,Action Value model (used by agent to interact with the environment)
v1.3.1-windows,"Target model used to compute the target Q-values in training, updated"
v1.3.1-windows,less frequently for increased stability.
v1.3.1-windows,Function computing Q-values targets as part of the computation graph
v1.3.1-windows,"Define the loss, using Huber Loss (more robust to outliers)"
v1.3.1-windows,Compute the q_targets
v1.3.1-windows,actions is a 1-hot encoding of the action done by the agent
v1.3.1-windows,Define training criterion as the Huber Loss function
v1.3.1-windows,Adam based SGD
v1.3.1-windows,self._trainer.restore_from_checkpoint('models/oldmodels/model800000')
v1.3.1-windows,Append the state to the short term memory (ie. History)
v1.3.1-windows,"If policy requires agent to explore, sample random action"
v1.3.1-windows,Use the network to output the best action
v1.3.1-windows,Append batch axis with only one sample to evaluate
v1.3.1-windows,Return the value maximizing the expected reward
v1.3.1-windows,Keep track of interval action counter
v1.3.1-windows,"If done, reset short term memory (ie. History)"
v1.3.1-windows,Plot the metrics through Tensorboard and reset buffers
v1.3.1-windows,Reset the short term memory
v1.3.1-windows,Append to long term memory
v1.3.1-windows,Update the Target Network if needed
v1.3.1-windows,print(dist)
v1.3.1-windows,Make RL agent
v1.3.1-windows,Train
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,get state of the car
v1.3.1-windows,go forward
v1.3.1-windows,Go forward + steer right
v1.3.1-windows,go reverse
v1.3.1-windows,apply brakes
v1.3.1-windows,get camera images from the car
v1.3.1-windows,restore to original state
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,go forward
v1.3.1-windows,Python client example to get Lidar data from a car
v1.3.1-windows,
v1.3.1-windows,Makes the drone fly and get Lidar data
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,"print(""state: %s"" % s)"
v1.3.1-windows,go forward
v1.3.1-windows,Go forward + steer right
v1.3.1-windows,"reshape array of floats to array of [X,Y,Z]"
v1.3.1-windows,TODO
v1.3.1-windows,main
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,get state of the car
v1.3.1-windows,go forward
v1.3.1-windows,Go forward + steer right
v1.3.1-windows,go reverse
v1.3.1-windows,apply breaks
v1.3.1-windows,restore to original state
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,get camera images from the car
v1.3.1-windows,that's enough fun for now. let's quit cleanly
v1.3.1-windows,Import this module to automatically setup path to local airsim module
v1.3.1-windows,This module first tries to see if airsim module is installed via pip
v1.3.1-windows,If it does then we don't do anything else
v1.3.1-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.3.1-windows,and if it does then we add that in sys.path
v1.3.1-windows,this class simply tries to see if airsim
v1.3.1-windows,if airsim module is installed then don't do anything else
v1.3.1-windows,import pkgutil
v1.3.1-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.3.1-windows,if airsim_loader is not None:
v1.3.1-windows,return
v1.3.1-windows,Use below in settings.json with blocks environment
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,get state of the car
v1.3.1-windows,go forward
v1.3.1-windows,go reverse
v1.3.1-windows,apply breaks
v1.3.1-windows,get camera images from the car
v1.3.1-windows,restore to original state
v1.3.1-windows,from keras.models import load_model
v1.3.1-windows,if (len(sys.argv) != 2):
v1.3.1-windows,print('usage: python drive.py <modelName>')
v1.3.1-windows,sys.exit()
v1.3.1-windows,print('Loading model...')
v1.3.1-windows,model = load_model(sys.argv[1])
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.3.1-windows,"model_output = model.predict([image_buf, state_buf])"
v1.3.1-windows,car_controls.steering = float(model_output[0][0])
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,MultirotorClient.wait_key('Press any key to takeoff')
v1.3.1-windows,Local variable access is faster in loops
v1.3.1-windows,"if not wrapping over current pointer,"
v1.3.1-windows,then check if there is terminal state wrapped inside
v1.3.1-windows,"If index > history_length, take from a slice"
v1.3.1-windows,Metrics accumulator
v1.3.1-windows,Action Value model (used by agent to interact with the environment)
v1.3.1-windows,"Target model used to compute the target Q-values in training, updated"
v1.3.1-windows,less frequently for increased stability.
v1.3.1-windows,Function computing Q-values targets as part of the computation graph
v1.3.1-windows,"Define the loss, using Huber Loss (more robust to outliers)"
v1.3.1-windows,Compute the q_targets
v1.3.1-windows,actions is a 1-hot encoding of the action done by the agent
v1.3.1-windows,Define training criterion as the Huber Loss function
v1.3.1-windows,Adam based SGD
v1.3.1-windows,Append the state to the short term memory (ie. History)
v1.3.1-windows,"If policy requires agent to explore, sample random action"
v1.3.1-windows,Use the network to output the best action
v1.3.1-windows,Append batch axis with only one sample to evaluate
v1.3.1-windows,Return the value maximizing the expected reward
v1.3.1-windows,Keep track of interval action counter
v1.3.1-windows,"If done, reset short term memory (ie. History)"
v1.3.1-windows,Plot the metrics through Tensorboard and reset buffers
v1.3.1-windows,Reset the short term memory
v1.3.1-windows,Append to long term memory
v1.3.1-windows,Update the Target Network if needed
v1.3.1-windows,print(dist)
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,Make RL agent
v1.3.1-windows,Train
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,get camera images from the car
v1.3.1-windows,that's enough fun for now. let's quit cleanly
v1.3.1-windows,teleport the drone + 10 meters in x-direction
v1.3.1-windows,teleport the drone back
v1.3.1-windows,use open cv to create point cloud from depth image.
v1.3.1-windows,###########################################
v1.3.1-windows,######### This is work in progress! #######
v1.3.1-windows,###########################################
v1.3.1-windows,file will be saved in PythonClient folder (i.e. same folder as script)
v1.3.1-windows,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.3.1-windows,skip it
v1.3.1-windows,AirSim uses NED coordinates so negative axis is up.
v1.3.1-windows,z of -7 is 7 meters above the original launch point.
v1.3.1-windows,Fly given velocity vector for 5 seconds
v1.3.1-windows,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.3.1-windows,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.3.1-windows,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.3.1-windows,Make the drone fly in a circle.
v1.3.1-windows,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.3.1-windows,check that our home position is stable
v1.3.1-windows,AirSim uses NED coordinates so negative axis is up.
v1.3.1-windows,ramp up time
v1.3.1-windows,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.3.1-windows,compute current angle
v1.3.1-windows,compute lookahead
v1.3.1-windows,if we did the takeoff then also do the landing.
v1.3.1-windows,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.3.1-windows,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.3.1-windows,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.3.1-windows,ignore the click over from 360 back to 0
v1.3.1-windows,watch direction this diff is moving if it switches from shrinking to growing
v1.3.1-windows,then we passed the starting point.
v1.3.1-windows,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.3.1-windows,AirSim uses NED coordinates so negative axis is up.
v1.3.1-windows,z of -7 is 7 meters above the original launch point.
v1.3.1-windows,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.3.1-windows,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.3.1-windows,drone will over-shoot so we bring it back to the start point before landing.
v1.3.1-windows,change clock speed in settings.json
v1.3.1-windows,"""ClockSpeed"": 0.5"
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,that's enough fun for now. let's quit cleanly
v1.3.1-windows,In settings.json first activate computer vision mode:
v1.3.1-windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.1-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.3.1-windows,pip install opencv-python
v1.3.1-windows,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.3.1-windows,Python client example to get Lidar data from a drone
v1.3.1-windows,
v1.3.1-windows,Makes the drone fly and get Lidar data
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,"print(""state: %s"" % s)"
v1.3.1-windows,"print(""state: %s"" % pprint.pformat(state))"
v1.3.1-windows,"reshape array of floats to array of [X,Y,Z]"
v1.3.1-windows,TODO
v1.3.1-windows,main
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,AirSim uses NED coordinates so negative axis is up.
v1.3.1-windows,let it settle there a bit.
v1.3.1-windows,after hovering we need to re-enabled api control for next leg of the trip
v1.3.1-windows,now compute the survey path required to fill the box
v1.3.1-windows,Use below in settings.json with Blocks environment
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,get camera images from the car
v1.3.1-windows,that's enough fun for now. let's quit cleanly
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,Import this module to automatically setup path to local airsim module
v1.3.1-windows,This module first tries to see if airsim module is installed via pip
v1.3.1-windows,If it does then we don't do anything else
v1.3.1-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.3.1-windows,and if it does then we add that in sys.path
v1.3.1-windows,this class simply tries to see if airsim
v1.3.1-windows,if airsim module is installed then don't do anything else
v1.3.1-windows,import pkgutil
v1.3.1-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.3.1-windows,if airsim_loader is not None:
v1.3.1-windows,return
v1.3.1-windows,"this script moves the drone to a location, then rests it thousands of time"
v1.3.1-windows,purpose of this script is to stress test reset API
v1.3.1-windows,connect to the AirSim simulator
v1.3.1-windows,that's enough fun for now. let's quite cleanly
v1.3.1-windows,use open cv to show new images from AirSim
v1.3.1-windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.3.1-windows,pip install opencv-python
v1.3.1-windows,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.3.1-windows,get depth image
v1.3.1-windows,"this will return png width= 256, height= 144"
v1.3.1-windows,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.3.1-windows,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.3.1-windows,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.3.1-windows,to get an estimate of distance.
v1.3.1-windows,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.3.1-windows,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.3.1-windows,an angular delta of the following pi/10.
v1.3.1-windows,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.3.1-windows,Remove alpha channel if exists
v1.3.1-windows,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.3.1-windows,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.3.1-windows,Flatten and yield as tuple
v1.3.1-windows,Initialize a resizable dataset to hold the output
v1.3.1-windows,Resize the dataset to accommodate the next chunk of rows
v1.3.1-windows,Create the next chunk
v1.3.1-windows,Increment the row count
v1.3.1-windows,Arguments
v1.3.1-windows,Returns
v1.3.1-windows,use composition of homographies
v1.3.1-windows,to generate final transform that needs to be applied
v1.3.1-windows,Arguments
v1.3.1-windows,Returns
v1.3.1-windows,Keeps under lock only the mechanism which advances
v1.3.1-windows,the indexing of each batch.
v1.3.1-windows,The transformation of images is not under thread lock
v1.3.1-windows,so it can be done in parallel
v1.3.1-windows,Trained model path
v1.3.1-windows,Connect to AirSim
v1.3.1-windows,Start driving
v1.3.1-windows,Initialize image buffer
v1.3.1-windows,Update throttle value according to steering angle
v1.3.1-windows,Prediction
v1.3.1-windows,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.3.1-windows,Print progress
v1.3.1-windows,Update next car state
v1.3.1-windows,Wait a bit between iterations
v1.3.1-windows,%matplotlib inline
v1.3.1-windows,chunk size for training batches
v1.3.1-windows,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.3.1-windows,Point this to the directory containing the raw data
v1.3.1-windows,Point this to the desired output directory for the cooked (.h5) data
v1.3.1-windows,Choose The folders to search for data under RAW_DATA_DIR
v1.3.1-windows,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.3.1-windows,data_folder.append('folder_name1')
v1.3.1-windows,data_folder.append('folder_name2')
v1.3.1-windows,...
v1.3.1-windows,Hyper-parameters
v1.3.1-windows,Activation functions
v1.3.1-windows,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.3.1-windows,<< The directory containing the cooked data from the previous step >>
v1.3.1-windows,<< The directory in which the model output will be placed >>
v1.3.1-windows,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.3.1-windows,Network definition
v1.3.1-windows,Import this module to automatically setup path to local airsim module
v1.3.1-windows,This module first tries to see if airsim module is installed via pip
v1.3.1-windows,If it does then we don't do anything else
v1.3.1-windows,Else we look up grand-parent folder to see if it has airsim folder
v1.3.1-windows,and if it does then we add that in sys.path
v1.3.1-windows,this class simply tries to see if airsim
v1.3.1-windows,if airsim module is installed then don't do anything else
v1.3.1-windows,import pkgutil
v1.3.1-windows,airsim_loader = pkgutil.find_loader('airsim')
v1.3.1-windows,if airsim_loader is not None:
v1.3.1-windows,return
v1.3.1-windows,DEY: I don't know why this was there.
v1.3.1-windows,-----------------------------------  Common vehicle APIs ---------------------------------------------
v1.3.1-windows,basic flight control
v1.3.1-windows,time-of-day control
v1.3.1-windows,weather
v1.3.1-windows,camera control
v1.3.1-windows,simGetImage returns compressed png in array of bytes
v1.3.1-windows,image_type uses one of the ImageType members
v1.3.1-windows,"todo: in future remove below, it's only for compatibility to pre v1.2"
v1.3.1-windows,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.3.1-windows,camera control
v1.3.1-windows,simGetImage returns compressed png in array of bytes
v1.3.1-windows,image_type uses one of the ImageType members
v1.3.1-windows,gets the static meshes in the unreal scene
v1.3.1-windows,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.3.1-windows,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.3.1-windows,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.3.1-windows,sensor APIs
v1.3.1-windows,Plotting APIs
v1.3.1-windows,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.3.1-windows,APIs for control
v1.3.1-windows,low-level control API
v1.3.1-windows,query vehicle state
v1.3.1-windows,-----------------------------------  Car APIs ---------------------------------------------
v1.3.1-windows,helper method for converting getOrientation to roll/pitch/yaw
v1.3.1-windows,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.3.1-windows,roll (x-axis rotation)
v1.3.1-windows,pitch (y-axis rotation)
v1.3.1-windows,yaw (z-axis rotation)
v1.3.1-windows,DEY: I don't know why this was there.
v1.3.1-windows,reverse the vertical line order and add null bytes at the start
v1.3.1-windows,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.3.1-windows,return cls(**msgpack.unpack(encoded))
v1.3.1-windows,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.3.1-windows,"in header only mode, control library is not available"
v1.3.1-windows,if using Unreal Build system then include precompiled header file first
v1.3.1-windows,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.3.1-windows,"Windows, OSX and Linux."
v1.3.1-windows,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.3.1-windows,Windows users can move the Documents folder to any location they want
v1.3.1-windows,SHGetFolderPath knows how to find it.
v1.3.1-windows,fall back in case SHGetFolderPath failed for some reason.
v1.3.1-windows,convert from std::path '/' to windows backslash.
v1.3.1-windows,make the current thread run with maximum priority.
v1.3.1-windows,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.3.1-windows,TODO: How to handle POSIX thread priorities on OSX?
v1.3.1-windows,setThreadName is a helper function that is useful when debugging because your threads
v1.3.1-windows,show up in the debugger with the name you set which makes it easier to find the threads
v1.3.1-windows,that you are interested in.
v1.3.1-windows,"unfortunately this is only available on Windows 10, and AirSim is not limited to that."
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.3.1-windows,
v1.3.1-windows,Treat all errors as failure conditions.
v1.3.1-windows,parse command line
v1.3.1-windows,"motive gives a weird error if the project is not found, so we look for it."
v1.3.1-windows,Do an update to pick up any recently-arrived cameras.
v1.3.1-windows,List all detected cameras.
v1.3.1-windows,List all defined rigid bodies.
v1.3.1-windows,throttle to 50 messages per second.
v1.3.1-windows,OptiTrack uses 'y' axis for vertical.
v1.3.1-windows,stdafx.cpp : source file that includes just the standard includes
v1.3.1-windows,MavlinkMoCap.pch will be the pre-compiled header
v1.3.1-windows,stdafx.obj will contain the pre-compiled type information
v1.3.1-windows,TODO: reference any additional headers you need in STDAFX.H
v1.3.1-windows,and not in this file
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,PX4.cpp : Defines the entry point for the console application.
v1.3.1-windows,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.3.1-windows,how do you write to the debug output windows on Unix ?
v1.3.1-windows,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.3.1-windows,connection to create to talke to that server.
v1.3.1-windows,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.3.1-windows,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.3.1-windows,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.3.1-windows,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.3.1-windows,using their the -qgc option.
v1.3.1-windows,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.3.1-windows,this switch controls whether we turn off the RC remote active link loss detection
v1.3.1-windows,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.3.1-windows,from kicking in when you try and fly.
v1.3.1-windows,parse the json
v1.3.1-windows,flatten inner mavlink object
v1.3.1-windows,flatten inner mavlink object
v1.3.1-windows,todo
v1.3.1-windows,todo
v1.3.1-windows,"const char* outLogFileOption = ""outlogfile"";"
v1.3.1-windows,parse command line
v1.3.1-windows,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.3.1-windows,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.3.1-windows,"no local serial connection, so this is the primary droneConnection."
v1.3.1-windows,failed to connect
v1.3.1-windows,"local connection, then we own sending the heartbeat."
v1.3.1-windows,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.3.1-windows,cmdTable.push_back(new AltHoldCommand());
v1.3.1-windows,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.3.1-windows,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.3.1-windows,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.3.1-windows,this stops us from being able to connect to SITL mode PX4.
v1.3.1-windows,checkPulse();
v1.3.1-windows,add command text in log
v1.3.1-windows,close previous command.
v1.3.1-windows,FilterLogFiles(logDirectory);
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,send a heartbeat
v1.3.1-windows,accept one incoming connection
v1.3.1-windows,send a heartbeat to the client
v1.3.1-windows,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.3.1-windows,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.3.1-windows,for this unit test we are expecting a request to send an image.
v1.3.1-windows,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.3.1-windows,hmmm
v1.3.1-windows,================ ls
v1.3.1-windows,================ put file
v1.3.1-windows,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.3.1-windows,================ get file
v1.3.1-windows,verify the file contents.
v1.3.1-windows,================ remove file
v1.3.1-windows,================ make directory
v1.3.1-windows,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.3.1-windows,================ remove directory
v1.3.1-windows,Now verification
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,you must call this method if you want HandleMessage to be called subsequently.
v1.3.1-windows,treat literals as one word
v1.3.1-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.3.1-windows,request gps info
v1.3.1-windows,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.3.1-windows,find relative position since command start so we can compare two commands better
v1.3.1-windows,"these PID values are important, so set these to match"
v1.3.1-windows,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.3.1-windows,we can skip ahead.
v1.3.1-windows,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.3.1-windows,TODO: avoid passing hadcoded HIL flag
v1.3.1-windows,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.3.1-windows,"The global position, as returned by the Global Positioning System (GPS)."
v1.3.1-windows,Provides state for additional features
v1.3.1-windows,The general system state
v1.3.1-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.3.1-windows,Provides state for additional features
v1.3.1-windows,The general system state
v1.3.1-windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.3.1-windows,Provides state for additional features
v1.3.1-windows,The general system state
v1.3.1-windows,Provides state for additional features
v1.3.1-windows,The general system state
v1.3.1-windows,note: we do not reset com when Close() is called because we want to keep running.
v1.3.1-windows,"user has to invoke ""hil stop"" to stop the hil thread."
v1.3.1-windows,generate random between 0 and 1
v1.3.1-windows,move to range -1 to 1
v1.3.1-windows,scale it
v1.3.1-windows,apply iy
v1.3.1-windows,wait for the Execute method to be called.
v1.3.1-windows,gps is much slower frequency than IMU.
v1.3.1-windows,MAVLINK_MSG_ID_HIL_GPS
v1.3.1-windows,disable MAV_USEHILGPS
v1.3.1-windows,note: we do not reset com when Close() is called because we want to keep running.
v1.3.1-windows,"user has to invoke ""hil stop"" to stop the hil thread."
v1.3.1-windows,generate random between 0 and 1
v1.3.1-windows,move to range -1 to 1
v1.3.1-windows,scale it
v1.3.1-windows,apply iy
v1.3.1-windows,wait for the Execute method to be called.
v1.3.1-windows,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.3.1-windows,gps is much slower frequency than IMU.
v1.3.1-windows,MAVLINK_MSG_ID_HIL_GPS
v1.3.1-windows,disable HIL mode
v1.3.1-windows,Enumeration of landed detector states
v1.3.1-windows,MAV landed state is unknown
v1.3.1-windows,MAV is landed (on ground)
v1.3.1-windows,MAV is in air
v1.3.1-windows,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.3.1-windows,The filtered local position
v1.3.1-windows,must send these regularly to keep offboard control.
v1.3.1-windows,"ok, now we can safely switch to loiter."
v1.3.1-windows,must send these regularly to keep offboard control.
v1.3.1-windows,integrate the heading so it is smoother.
v1.3.1-windows,must send these regularly to keep offboard control.
v1.3.1-windows,integrate the heading so it is smoother.
v1.3.1-windows,fly to radius
v1.3.1-windows,it takes about 10 cm to stop and turn.
v1.3.1-windows,next time around switch to orbiting!
v1.3.1-windows,heading points to center of circle.
v1.3.1-windows,interpoloate the speed ramp up time over 2 seconds from start time
v1.3.1-windows,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.3.1-windows,monitor the sin curves so we can see how on track or off track it actually is.
v1.3.1-windows,the shape of the curve will also tell us if we are progressing at a consistent
v1.3.1-windows,"speed, the more deformed the sin curve the worse our progress."
v1.3.1-windows,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.3.1-windows,degrees just flipped from 359 to 0.
v1.3.1-windows,this enables us to test what happens when offboard control is lost and resumed.
v1.3.1-windows,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.3.1-windows,"ok, now we can start moving by velocity"
v1.3.1-windows,recompute to new target.
v1.3.1-windows,start by moving right with 10 degree roll.
v1.3.1-windows,haven't started yet.
v1.3.1-windows,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.3.1-windows,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.3.1-windows,track how our actual pitch is coming along compared to our target
v1.3.1-windows,and check position
v1.3.1-windows,the amount of pitch should depend on our speed in that direction.
v1.3.1-windows,passed the midpoint.
v1.3.1-windows,fade out the pitch as we pick up speed so we don't overshoot.
v1.3.1-windows,see if we just crossed the wiggle distance threshold.
v1.3.1-windows,(pitch affects the x-position).
v1.3.1-windows,reverse direction with a -30 degrees quick stop
v1.3.1-windows,reverse direction with a 30 degrees quick stop
v1.3.1-windows,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.3.1-windows,too much in that direction.
v1.3.1-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.3.1-windows,track how our actual roll is coming along compared to our target
v1.3.1-windows,and check position
v1.3.1-windows,the amount of roll should depend on our speed in that direction.
v1.3.1-windows,passed the midpoint.
v1.3.1-windows,fade out the roll as we pick up speed so we don't overshoot.
v1.3.1-windows,see if we just crossed the wiggle distance threshold.
v1.3.1-windows,(roll affects the y-position).
v1.3.1-windows,reverse direction with a -30 degrees quick stop
v1.3.1-windows,reverse direction with a 30 degrees quick stop
v1.3.1-windows,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.3.1-windows,too much in that direction.
v1.3.1-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.3.1-windows,for testing PID controller.
v1.3.1-windows,class AltHoldCommand : public Command
v1.3.1-windows,{
v1.3.1-windows,std::shared_ptr<MavLinkVehicle> channel;
v1.3.1-windows,"float sx_, sy_, sz_;"
v1.3.1-windows,MavLinkAttitudeTarget _current;
v1.3.1-windows,PidController thrust_controller_;
v1.3.1-windows,public:
v1.3.1-windows,this->sz_ = pos.z; // user defined target.
v1.3.1-windows,move to local position keeps the offboard control happy.
v1.3.1-windows,haven't started yet.
v1.3.1-windows,and check position
v1.3.1-windows,double dx = this->sx_ - pos.x;
v1.3.1-windows,double dy = this->sy_ - pos.y;
v1.3.1-windows,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.3.1-windows,too much in that direction.
v1.3.1-windows,adjust thrust so we keep steady height target
v1.3.1-windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.3.1-windows,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.3.1-windows,local remote
v1.3.1-windows,already handled by the parse method.
v1.3.1-windows,we only support very simple patterns for now.
v1.3.1-windows,each wildcard must be separated by literal.
v1.3.1-windows,back to back wildcards with no literal in between is too complex.
v1.3.1-windows,"we only support simple matching for now, we can add full regex later if we need it."
v1.3.1-windows,yep!
v1.3.1-windows,'*' is done we found the next matching char
v1.3.1-windows,this is ok.
v1.3.1-windows,this is an ERASE_END_LINE command which we ignore.
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,unpack the message...
v1.3.1-windows,pack the payload buffer.
v1.3.1-windows,"json can't handle ""nan"", so we convert it to null."
v1.3.1-windows,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.3.1-windows,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,start listening to this connection
v1.3.1-windows,Send heartbeat to drone.  You should not do this if some other node is
v1.3.1-windows,already doing it.
v1.3.1-windows,stop listening to the connection.
v1.3.1-windows,get the connection
v1.3.1-windows,Get the local system and component id
v1.3.1-windows,send a command to the remote node
v1.3.1-windows,MavLinkNode::MavLinkNode() = default;
v1.3.1-windows,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.3.1-windows,decrementing the count so the next WaitOne may block.
v1.3.1-windows,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.3.1-windows,convert to absolute time.
v1.3.1-windows,use mach_timespec
v1.3.1-windows,convert to absolute time.
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,return true if we still have offboard control (can lose this if user flips the switch).
v1.3.1-windows,MavLinkVehicle::MavLinkVehicle() = default;
v1.3.1-windows,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.3.1-windows,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,============================== CLIENT ============================================
v1.3.1-windows,image APIs
v1.3.1-windows,or if you are implementing the client side call this function to get the most recent frame.
v1.3.1-windows,returns false if there is no new frame available.
v1.3.1-windows,============================== SERVER ============================================
v1.3.1-windows,call this to send the image back over the connection given to start function.
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,"log every message that is ""sent"" using sendMessage."
v1.3.1-windows,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.3.1-windows,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.3.1-windows,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.3.1-windows,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,for compatibility with QGroundControl we have to save the time field in big endian.
v1.3.1-windows,todo: mavlink2 support?
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,start listening to this connection
v1.3.1-windows,Send heartbeat to drone.  You should not do this if some other node is
v1.3.1-windows,already doing it.
v1.3.1-windows,this is called for all messages received on the connection.
v1.3.1-windows,"we received a heartbeat, so let's get the capabilities."
v1.3.1-windows,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.3.1-windows,subclasses remembering to call this base implementation.
v1.3.1-windows,stop listening to the connection.
v1.3.1-windows,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.3.1-windows,wait for a heartbeat msg since this will give us the port to send commands to...
v1.3.1-windows,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.3.1-windows,send a heart beat so that the remote node knows we are still alive
v1.3.1-windows,(otherwise drone will trigger a failsafe operation).
v1.3.1-windows,ignore any failures here because we are running in our own thread here.
v1.3.1-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.1-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.1-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.1-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.1-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.1-windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.1-windows,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.3.1-windows,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.3.1-windows,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.3.1-windows,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.3.1-windows,"ok, now fetch the missing parameters."
v1.3.1-windows,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.3.1-windows,silently fail since we are on a background thread here...
v1.3.1-windows,tell the caller this is complete.
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,add our custom telemetry message length.
v1.3.1-windows,todo: if we support signing then initialize
v1.3.1-windows,mavlink_intermediate_status_.signing callbacks
v1.3.1-windows,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.3.1-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.3.1-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.3.1-windows,send this right away just in case serial link is not already configured
v1.3.1-windows,"log every message that is ""sent"" using sendMessage."
v1.3.1-windows,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.3.1-windows,pack the payload buffer.
v1.3.1-windows,calculate checksum
v1.3.1-windows,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.3.1-windows,are variable length as a result.
v1.3.1-windows,form the header as a byte array for the crc
v1.3.1-windows,these macros use old style cast.
v1.3.1-windows,forward messages from our connected node to the remote proxy.
v1.3.1-windows,tell the remote connection to expect mavlink2 messages.
v1.3.1-windows,forward messages from remote proxy to local connected node
v1.3.1-windows,CurrentThread::setMaximumPriority();
v1.3.1-windows,"hmmm, wait till it is opened?"
v1.3.1-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.3.1-windows,pick up the sysid/compid of the remote node we are connected to.
v1.3.1-windows,then this is a mavlink 1 message
v1.3.1-windows,then this mavlink sender supports mavlink 2
v1.3.1-windows,queue event for publishing.
v1.3.1-windows,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.3.1-windows,as it ensures we don't lose messages if the listener is slow.
v1.3.1-windows,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.3.1-windows,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.3.1-windows,we would get a deadlock.
v1.3.1-windows,CurrentThread::setMaximumPriority();
v1.3.1-windows,reset counters
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,------------------------------------------------------------------------------
v1.3.1-windows,Defines
v1.3.1-windows,------------------------------------------------------------------------------
v1.3.1-windows,bit number  876543210987654321
v1.3.1-windows,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.3.1-windows,in future it would be good to have ability to add system IDs we are interested in
v1.3.1-windows,if (msg.sysid != getTargetSystemId())
v1.3.1-windows,{
v1.3.1-windows,// we only care about messages from our intended remote node.
v1.3.1-windows,return;
v1.3.1-windows,}
v1.3.1-windows,user may have changed modes on us! So we need to honor that and not
v1.3.1-windows,try and take it back.
v1.3.1-windows,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.3.1-windows,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.3.1-windows,we can store up to 16 channels in rc_channels_scaled.
v1.3.1-windows,The RAW values of the servo outputs
v1.3.1-windows,Metrics typically displayed on a HUD for fixed wing aircraft
v1.3.1-windows,The IMU readings in SI units in NED body frame
v1.3.1-windows,printSystemStatus(&msg);
v1.3.1-windows,todo: use this to determine when we need to do emergency landing...
v1.3.1-windows,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.3.1-windows,Provides state for additional features
v1.3.1-windows,The general system state
v1.3.1-windows,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.3.1-windows,but we do want to know when we get the ack.  So this is async ACK processing!
v1.3.1-windows,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.3.1-windows,if threshold < 0 then the threshold is inverted.
v1.3.1-windows,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.3.1-windows,Convert it to a floating point number between -1 and 1.
v1.3.1-windows,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.3.1-windows,until the move commands start happening.
v1.3.1-windows,return true if user calls requestControl and has not called releaseControl.
v1.3.1-windows,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.3.1-windows,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.3.1-windows,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.3.1-windows,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.3.1-windows,send a few to make sure it gets through...
v1.3.1-windows,now the command should succeed.
v1.3.1-windows,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.3.1-windows,us by which time the PX4 times out offboard mode!!
v1.3.1-windows,this mode change take precedence over offboard mode.
v1.3.1-windows,thrust must be between -1 and 1.
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,These definitions are copied from PX4 implementation
v1.3.1-windows,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.3.1-windows,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.3.1-windows,/ @brief Command opcodes
v1.3.1-windows,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.3.1-windows,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.3.1-windows,must trim trailing slashes so PX4 doesn't hang!
v1.3.1-windows,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.3.1-windows,from the source.
v1.3.1-windows,check if directory exists.
v1.3.1-windows,perfect.
v1.3.1-windows,use last_message_ so we preserve the sessionid.
v1.3.1-windows,"could not create the local file, so stop."
v1.3.1-windows,must use last_message_ so we preserve the session id.
v1.3.1-windows,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.3.1-windows,todo: error handling here? sequence is out of order...
v1.3.1-windows,"directory must be empty then, can't do nextStep because"
v1.3.1-windows,it will just loop for ever re-requesting zero offset into
v1.3.1-windows,empty directory.
v1.3.1-windows,result should be a list of null terminated file names.
v1.3.1-windows,skipping this entry
v1.3.1-windows,remove the file size field.
v1.3.1-windows,"printf(""%s\n"", name.c_str());"
v1.3.1-windows,request the next batch.
v1.3.1-windows,"perhaps this was a late response after we did a retry, so ignore it."
v1.3.1-windows,"perhaps this was a late response after we did a retry, so ignore it."
v1.3.1-windows,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.3.1-windows,reached the end of the list or the file.
v1.3.1-windows,end of file or directory listing.
v1.3.1-windows,"success, data should be following..."
v1.3.1-windows,ack on this cmd is a noop
v1.3.1-windows,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.3.1-windows,give up then.
v1.3.1-windows,tell watchdog we are sending a request
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,================================= CLIENT ==============================================================
v1.3.1-windows,Check if we have a valid transaction
v1.3.1-windows,emit signal if all packets arrived
v1.3.1-windows,Restart statemachine
v1.3.1-windows,image APIs
v1.3.1-windows,================================= SERVER ==============================================================
v1.3.1-windows,Prepare and send acknowledgment packet
v1.3.1-windows,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.3.1-windows,Send ENCAPSULATED_IMAGE packet
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.3.1-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.3.1-windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.3.1-windows,send this right away just in case serial link is not already configured
v1.3.1-windows,CurrentThread::setMaximumPriority();
v1.3.1-windows,"hmmm, wait till it is opened?"
v1.3.1-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.3.1-windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.3.1-windows,queue event for publishing.
v1.3.1-windows,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.3.1-windows,as it ensures we don't lose messages if the listener is slow.
v1.3.1-windows,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.3.1-windows,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.3.1-windows,we would get a deadlock.
v1.3.1-windows,CurrentThread::setMaximumPriority();
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.3.1-windows,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.3.1-windows,parse out the VID number
v1.3.1-windows,now the PID
v1.3.1-windows,parse out the VID number
v1.3.1-windows,examples:
v1.3.1-windows,PX4: USB\VID_26AC&PID_0011\0
v1.3.1-windows,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.3.1-windows,"printf(""Found: %S\n"", buffer.c_str());"
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.3.1-windows,parse out the VID number
v1.3.1-windows,now the PID
v1.3.1-windows,parse out the VID number
v1.3.1-windows,suppress
v1.3.1-windows,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,This has not been properly tested
v1.3.1-windows,struct iw_statistics stats;
v1.3.1-windows,struct iwreq req;
v1.3.1-windows,"memset(&stats, 0, sizeof(stats));"
v1.3.1-windows,"memset(&req, 0, sizeof(iwreq));"
v1.3.1-windows,
v1.3.1-windows,"strncpy(req.ifr_name, ifaceName, 16);"
v1.3.1-windows,req.u.data.pointer = &stats;
v1.3.1-windows,req.u.data.length = sizeof(iw_statistics);
v1.3.1-windows,
v1.3.1-windows,#ifdef CLEAR_UPDATED
v1.3.1-windows,req.u.data.flags = 1;
v1.3.1-windows,#endif
v1.3.1-windows,
v1.3.1-windows,/* Perform the ioctl */
v1.3.1-windows,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.3.1-windows,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.3.1-windows,return -127;
v1.3.1-windows,}
v1.3.1-windows,
v1.3.1-windows,return stats.qual.level;
v1.3.1-windows,todo: windows version of this...
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,windows
v1.3.1-windows,Need to link with Ws2_32.lib
v1.3.1-windows,posix
v1.3.1-windows,found it!
v1.3.1-windows,bind socket to local address.
v1.3.1-windows,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.3.1-windows,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.3.1-windows,write to the serial port
v1.3.1-windows,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.3.1-windows,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.3.1-windows,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.3.1-windows,"try and receive something, up until port is closed anyway."
v1.3.1-windows,"message was too large for the buffer, no problem, return what we have."
v1.3.1-windows,try again - this can happen if server recreates the socket on their side.
v1.3.1-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.3.1-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.3.1-windows,"printf(""#### recv failed with error: %d\n"", hr);"
v1.3.1-windows,we now have it.
v1.3.1-windows,this is from someone we are not interested in.
v1.3.1-windows,-----------------------------------------------------------------------------------------
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,Initialize Winsock
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,windows
v1.3.1-windows,Need to link with Ws2_32.lib
v1.3.1-windows,posix
v1.3.1-windows,found it!
v1.3.1-windows,bind socket to local address.
v1.3.1-windows,bind socket to local address.
v1.3.1-windows,start listening for incoming connection
v1.3.1-windows,accept 1
v1.3.1-windows,"don't need to accept any more, so we can close this one."
v1.3.1-windows,write to the serial port
v1.3.1-windows,"try and receive something, up until port is closed anyway."
v1.3.1-windows,"message was too large for the buffer, no problem, return what we have."
v1.3.1-windows,try again - this can happen if server recreates the socket on their side.
v1.3.1-windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.3.1-windows,try again - this can happen if server recreates the socket on their side.
v1.3.1-windows,-----------------------------------------------------------------------------------------
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.3.1-windows,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.3.1-windows,set signal
v1.3.1-windows,Clear Handshake flags
v1.3.1-windows,Set Handshake flags
v1.3.1-windows,return GetLastError();
v1.3.1-windows,return GetLastError();
v1.3.1-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.3.1-windows,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.3.1-windows,enable reading
v1.3.1-windows,posix doesn't have mark/space parity.
v1.3.1-windows,posix doesn't have mark/space parity.
v1.3.1-windows,this is the default.
v1.3.1-windows,not sure this is supported...
v1.3.1-windows,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.3.1-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.3.1-windows,First do those specified by POSIX.
v1.3.1-windows,Now conditionally handle a bunch of extended rates.
v1.3.1-windows,First do those specified by POSIX.
v1.3.1-windows,Now conditionally handle a bunch of extended rates.
v1.3.1-windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.3.1-windows,import airsim
v1.3.1-windows,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v1.3.1-windows,self.args = args
v1.3.1-windows,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v1.3.1-windows,pdb.set_trace()
v1.3.1-windows,#include <pluginlib/class_list_macros.h>
v1.3.1-windows,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v1.3.1-windows,intitialize placeholder control commands
v1.3.1-windows,vel_cmd_ = VelCmd();
v1.3.1-windows,gimbal_cmd_ = GimbalCmd();
v1.3.1-windows,todo do not reset if already in air?
v1.3.1-windows,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.3.1-windows,ros params
v1.3.1-windows,todo enforce dynamics constraints in this node as well?
v1.3.1-windows,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v1.3.1-windows,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v1.3.1-windows,XmlRpc::XmlRpcValue can't be const in this case
v1.3.1-windows,subscribe to control commands on global nodehandle
v1.3.1-windows,vehicle_setting_vec_.clear();
v1.3.1-windows,vehicle_imu_map_;
v1.3.1-windows,callback_queues_.clear();
v1.3.1-windows,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.3.1-windows,auto vehicle_setting_local = vehicle_setting.get();
v1.3.1-windows,bind to a single callback. todo optimal subs queue length
v1.3.1-windows,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.3.1-windows,"multirotor_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.3.1-windows,"iterate over camera map std::map<std::string, CameraSetting> cameras;"
v1.3.1-windows,vehicle_setting_vec_.push_back(*vehicle_setting.get());
v1.3.1-windows,camera_setting.gimbal
v1.3.1-windows,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.3.1-windows,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.3.1-windows,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.3.1-windows,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.3.1-windows,"if {DepthPlanner, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.3.1-windows,"push back pair (vector of image captures, current vehicle name)"
v1.3.1-windows,"iterate over sensors std::map<std::string, std::unique_ptr<SensorSetting>> sensors;"
v1.3.1-windows,"todo this is pretty non scalable, refactor airsim and ros api and maintain a vehicle <-> sensor (setting) map"
v1.3.1-windows,add takeoff and land all services if more than 2 drones
v1.3.1-windows,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v1.3.1-windows,todo add per vehicle reset in AirLib API
v1.3.1-windows,todo mimic gazebo's /use_sim_time feature which publishes airsim's clock time..via an rpc call?!
v1.3.1-windows,"clock_pub_ = nh_private_.advertise<rosgraph_msgs::Clock>(""clock"", 10);"
v1.3.1-windows,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.3.1-windows,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v1.3.1-windows,"todo: error check. if state is not landed, return error."
v1.3.1-windows,response.success =
v1.3.1-windows,response.success =
v1.3.1-windows,response.success =
v1.3.1-windows,response.success =
v1.3.1-windows,response.success =
v1.3.1-windows,response.success =
v1.3.1-windows,todo add reset by vehicle_name API to airlib
v1.3.1-windows,todo not async remove waitonlasttask
v1.3.1-windows,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v1.3.1-windows,todo do actual body frame?
v1.3.1-windows,airsim uses degrees
v1.3.1-windows,todo do actual body frame?
v1.3.1-windows,airsim uses degrees
v1.3.1-windows,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v1.3.1-windows,todo expose waitOnLastTask or nah?
v1.3.1-windows,todo do actual body frame?
v1.3.1-windows,airsim uses degrees
v1.3.1-windows,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.3.1-windows,todo expose waitOnLastTask or nah?
v1.3.1-windows,todo support multiple gimbal commands
v1.3.1-windows,todo support multiple gimbal commands
v1.3.1-windows,1. find quaternion of default gimbal pose
v1.3.1-windows,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.3.1-windows,3. call airsim client's setcameraorientation which sets camera orientation wrt world (or takeoff?) ned frame. todo
v1.3.1-windows,odom_ned_msg.header.frame_id = world_frame_id_;
v1.3.1-windows,"odom_ned_msg.child_frame_id = ""/airsim/odom_local_ned""; // todo make param"
v1.3.1-windows,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.3.1-windows,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.3.1-windows,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.3.1-windows,msg = []
v1.3.1-windows,todo covariances
v1.3.1-windows,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.3.1-windows,todo radians per second
v1.3.1-windows,meters/s2^m
v1.3.1-windows,imu_msg.orientation_covariance = ;
v1.3.1-windows,imu_msg.angular_velocity_covariance = ;
v1.3.1-windows,imu_msg.linear_acceleration_covariance = ;
v1.3.1-windows,todo unused
v1.3.1-windows,void AirsimROSWrapper::set_zero_vel_cmd()
v1.3.1-windows,{
v1.3.1-windows,vel_cmd_.x = 0.0;
v1.3.1-windows,vel_cmd_.y = 0.0;
v1.3.1-windows,vel_cmd_.z = 0.0;
v1.3.1-windows,vel_cmd_.drivetrain = msr::airlib::DrivetrainType::MaxDegreeOfFreedom;
v1.3.1-windows,vel_cmd_.yaw_mode.is_rate = false;
v1.3.1-windows,// todo make class member or a fucntion
v1.3.1-windows,"double roll, pitch, yaw;"
v1.3.1-windows,"tf2::Matrix3x3(get_tf2_quat(curr_drone_state_.kinematics_estimated.pose.orientation)).getRPY(roll, pitch, yaw); // ros uses xyzw"
v1.3.1-windows,vel_cmd_.yaw_mode.yaw_or_rate = yaw;
v1.3.1-windows,}
v1.3.1-windows,todo this is global origin
v1.3.1-windows,iterate over drones
v1.3.1-windows,get drone state from airsim
v1.3.1-windows,convert airsim drone state to ROS msgs
v1.3.1-windows,publish to ROS!
v1.3.1-windows,send control commands from the last callback to airsim
v1.3.1-windows,"""clear"" control cmds"
v1.3.1-windows,IMUS
v1.3.1-windows,imu_msg.header.stamp = ros::Time::now();
v1.3.1-windows,"we've sent these static transforms, so no need to keep sending them"
v1.3.1-windows,todo add and expose a gimbal angular velocity to airlib
v1.3.1-windows,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.3.1-windows,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.3.1-windows,std::lock_guard<std::recursive_mutex> guard(drone_control_mutex_);
v1.3.1-windows,std::lock_guard<std::recursive_mutex> guard(lidar_mutex_);
v1.3.1-windows,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.3.1-windows,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.3.1-windows,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.3.1-windows,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.3.1-windows,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.3.1-windows,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.3.1-windows,"if a render request failed for whatever reason, this img will be empty."
v1.3.1-windows,Attempting to use a make_ts(0) results in ros::Duration runtime error.
v1.3.1-windows,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.3.1-windows,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.3.1-windows,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.3.1-windows,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.3.1-windows,update timestamp of saved cam info msgs
v1.3.1-windows,DepthPlanner / DepthPerspective / DepthVis / DisparityNormalized
v1.3.1-windows,Scene / Segmentation / SurfaceNormals / Infrared
v1.3.1-windows,publish camera transforms
v1.3.1-windows,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.3.1-windows,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.3.1-windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.3.1-windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.3.1-windows,ROS params
v1.3.1-windows,ROS publishers
v1.3.1-windows,ROS subscribers
v1.3.1-windows,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.3.1-windows,ROS timers
v1.3.1-windows,todo maintain internal representation as eigen vec?
v1.3.1-windows,todo check if low velocity if within thresh?
v1.3.1-windows,todo maintain separate errors for XY and Z
v1.3.1-windows,todo save this in degrees somewhere to avoid repeated conversion
v1.3.1-windows,this tells the update timer callback to not do active hovering
v1.3.1-windows,todo maintain array of position goals
v1.3.1-windows,todo error checks
v1.3.1-windows,todo fill response
v1.3.1-windows,this tells the update timer callback to not do active hovering
v1.3.1-windows,todo error checks
v1.3.1-windows,todo fill response
v1.3.1-windows,"todo do relative altitude, or add an option for the same?"
v1.3.1-windows,convert GPS goal to NED goal
v1.3.1-windows,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.3.1-windows,todo error checks
v1.3.1-windows,todo fill response
v1.3.1-windows,"todo do relative altitude, or add an option for the same?"
v1.3.1-windows,convert GPS goal to NED goal
v1.3.1-windows,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.3.1-windows,todo error checks
v1.3.1-windows,todo fill response
v1.3.1-windows,todo check if odometry is too old!!
v1.3.1-windows,"if no odom, don't do anything."
v1.3.1-windows,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.3.1-windows,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.3.1-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.3.1-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.3.1-windows,todo yaw limits
v1.3.1-windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.3.1-windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.3.1-windows,check if path exists
v1.3.1-windows,todo airsim's simhud.cpp does error checking here
v1.3.1-windows,mimics void ASimHUD::initializeSettings()
v1.3.1-windows,not sure where settings_json initialized in AirSimSettings::initializeSettings() is actually used
v1.3.1-windows,int num_threads = 1;
v1.3.1-windows,ros::MultiThreadedSpinner multi_thread(num_threads);
v1.3.1-windows,multi_thread.spin();
v1.3.1-windows,ros::AsyncSpinner async_spinner(num_threads);
v1.3.1-windows,async_spinner.start();
v1.3.1-windows,single threaded spinner
v1.3.1-windows,","
v1.3.1-windows,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.3.1-windows,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,"in header only mode, control library is not available"
v1.3.1-windows,TODO: something defines max macro which interfears with code here
v1.3.1-windows,is cur_pos within fence?
v1.3.1-windows,destination risk is not available then consider it zero
v1.3.1-windows,if dest risk is lower than its more safe
v1.3.1-windows,are we doing better than closest obstacle?
v1.3.1-windows,"if we stay where we are, what is the risk distance?"
v1.3.1-windows,else we are better of moving to dest
v1.3.1-windows,this function should work even when dest_pos == cur_pos
v1.3.1-windows,is this dest_pos cur_pos within the fence?
v1.3.1-windows,transform dest_pos vector to body frame
v1.3.1-windows,check for approx zero vectors to avoid random yaw angles
v1.3.1-windows,we are hovering
v1.3.1-windows,"get yaw in body frame, ie, front is always 0 radians"
v1.3.1-windows,yaw to ticks
v1.3.1-windows,get obstacles in the window at the tick direction around the window
v1.3.1-windows,less risk distance is better
v1.3.1-windows,check obstacles around current position and see if it has lower risk
v1.3.1-windows,else obstacle is too far
v1.3.1-windows,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.3.1-windows,look for each surrounding tick to see if we have obstacle free angle
v1.3.1-windows,else no suggestions required
v1.3.1-windows,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.3.1-windows,evaluate right and left side of circle
v1.3.1-windows,find right and left risk distances
v1.3.1-windows,at this point we have already determined hover is better than going to dest
v1.3.1-windows,we now determine is moving to suggested angle better than hovering?
v1.3.1-windows,check if dest_pos is safe
v1.3.1-windows,breaking distance at this velocity
v1.3.1-windows,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.3.1-windows,check if dest_pos is safe
v1.3.1-windows,float/vec parameters can have NaN which makes them optional
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,"in header only mode, control library is not available"
v1.3.1-windows,handles +/- tick and wraps around circle
v1.3.1-windows,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.3.1-windows,update the specified window on the map
v1.3.1-windows,make sure from <= to
v1.3.1-windows,normalize the ticks so both are valid indices
v1.3.1-windows,if from is still larger then
v1.3.1-windows,to ticks is then added one full circle to make it larger than from_tick
v1.3.1-windows,find closest obstacle in given window
v1.3.1-windows,search whole map to find closest obstacle
v1.3.1-windows,"in header only mode, control library is not available"
v1.3.1-windows,#include <fileapi.h>
v1.3.1-windows,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.3.1-windows,"Windows, OSX and Linux."
v1.3.1-windows,Windows users can move the Documents folder to any location they want
v1.3.1-windows,SHGetFolderPath knows how to find it.
v1.3.1-windows,fall back in case SHGetFolderPath failed for some reason.
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,"in header only mode, control library is not available"
v1.3.1-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.1-windows,if using Unreal Build system then include precompiled header file first
v1.3.1-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.1-windows,this deadlocks UI thread if async_run was called while there are pending rpc calls.
v1.3.1-windows,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.3.1-windows,Exit if already resetting.
v1.3.1-windows,Reset
v1.3.1-windows,if we don't suppress then server will bomb out for exceptions raised by any method
v1.3.1-windows,required for pimpl
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,"in header only mode, control library is not available"
v1.3.1-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.1-windows,if using Unreal Build system then include precompiled header file first
v1.3.1-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.1-windows,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.3.1-windows,make sure we can talk to the DroneServer
v1.3.1-windows,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.3.1-windows,command_context.client.ping();
v1.3.1-windows,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.3.1-windows,sim only
v1.3.1-windows,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.3.1-windows,return value of last task. It should be true if task completed without
v1.3.1-windows,cancellation or timeout
v1.3.1-windows,"should be implemented by derived class if it supports async task,"
v1.3.1-windows,for example using futures
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,"in header only mode, control library is not available"
v1.3.1-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.1-windows,if using Unreal Build system then include precompiled header file first
v1.3.1-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,"in header only mode, control library is not available"
v1.3.1-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.1-windows,if using Unreal Build system then include precompiled header file first
v1.3.1-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.1-windows,required for pimpl
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,"in header only mode, control library is not available"
v1.3.1-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.1-windows,if using Unreal Build system then include precompiled header file first
v1.3.1-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.1-windows,status getters
v1.3.1-windows,return value of last task. It should be true if task completed without
v1.3.1-windows,cancellation or timeout
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,"in header only mode, control library is not available"
v1.3.1-windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.1-windows,if using Unreal Build system then include pre-compiled header file first
v1.3.1-windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.1-windows,getters
v1.3.1-windows,required for pimpl
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,"in header only mode, control library is not available"
v1.3.1-windows,last command is to hold on to position
v1.3.1-windows,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.3.1-windows,after landing we detect if drone has stopped moving
v1.3.1-windows,validate path size
v1.3.1-windows,validate yaw mode
v1.3.1-windows,validate and set auto-lookahead value
v1.3.1-windows,if auto mode requested for lookahead then calculate based on velocity
v1.3.1-windows,add current position as starting point
v1.3.1-windows,append the input path and compute segments
v1.3.1-windows,add last segment as zero length segment so we have equal number of segments and points.
v1.3.1-windows,path_segs[i] refers to segment that starts at point i
v1.3.1-windows,"when path ends, we want to slow down"
v1.3.1-windows,else no need to change velocities for last segments
v1.3.1-windows,setup current position on path to 0 offset
v1.3.1-windows,initialize next path position
v1.3.1-windows,until we are at the end of the path (last seg is always zero size)
v1.3.1-windows,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.3.1-windows,send drone command to get to next lookahead
v1.3.1-windows,sleep for rest of the cycle
v1.3.1-windows,how much have we moved towards last goal?
v1.3.1-windows,project actual vector on goal vector
v1.3.1-windows,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.3.1-windows,TODO: below should be lower than 1E3 and configurable
v1.3.1-windows,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.3.1-windows,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.3.1-windows,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.3.1-windows,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.3.1-windows,"if drone moved backward, we don't want goal to move backward as well"
v1.3.1-windows,"so only climb forward on the path, never back. Also note >= which means"
v1.3.1-windows,we climb path even if distance was 0 to take care of duplicated points on path
v1.3.1-windows,else
v1.3.1-windows,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.3.1-windows,compute next target on path
v1.3.1-windows,freeze the quaternion
v1.3.1-windows,convert RC commands to velocity vector
v1.3.1-windows,find yaw as per terrain and remote setting
v1.3.1-windows,execute command
v1.3.1-windows,if timeout occurred then command completed successfully otherwise it was interrupted
v1.3.1-windows,yaw is not within margin
v1.3.1-windows,by default we say that this command is not supported
v1.3.1-windows,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.3.1-windows,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.3.1-windows,get trims
v1.3.1-windows,take average
v1.3.1-windows,validate dest
v1.3.1-windows,what is the distance we will travel at this velocity?
v1.3.1-windows,get velocity vector
v1.3.1-windows,yaw for the direction of travel
v1.3.1-windows,find velocity vector
v1.3.1-windows,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.3.1-windows,generate velocity vector that is same size as cur_dest_norm / command period
v1.3.1-windows,this velocity vect when executed for command period would yield cur_dest_norm
v1.3.1-windows,send commands
v1.3.1-windows,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.3.1-windows,default strategy is for move. In hover mode we set new strategy temporarily
v1.3.1-windows,are we supposed to do EM?
v1.3.1-windows,get suggested velocity vector
v1.3.1-windows,use the unchecked command
v1.3.1-windows,tell caller not to execute planned command
v1.3.1-windows,other wise throw exception
v1.3.1-windows,otherwise there is some other reason why we are in unsafe situation
v1.3.1-windows,send last command to come to full stop
v1.3.1-windows,else no unsafe situation
v1.3.1-windows,note: cur_path_loc and next_path_loc may both point to same object
v1.3.1-windows,"otherwise use up this segment, move on to next one"
v1.3.1-windows,if we are here then we ran out of segments
v1.3.1-windows,consider last segment as zero length segment
v1.3.1-windows,adjust yaw for the direction of travel in forward-only mode
v1.3.1-windows,else no adjustment needed
v1.3.1-windows,if auto mode requested for lookahead then calculate based on velocity
v1.3.1-windows,Create a spring arm component for our chase camera
v1.3.1-windows,"do nothing, spring arm is pulling the camera with it"
v1.3.1-windows,"do nothing, we have camera turned off"
v1.3.1-windows,set initial view mode
v1.3.1-windows,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.3.1-windows,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.3.1-windows,"If the lag is missing, the camera will also occasionally shake."
v1.3.1-windows,"But, lag is not desired when piloting a drone"
v1.3.1-windows,attach spring arm to actor
v1.3.1-windows,remember current parent for external camera. Later when we remove external
v1.3.1-windows,"camera from spring arm, we will attach it back to its last parent"
v1.3.1-windows,now attach camera to spring arm
v1.3.1-windows,"For car, we need to move the camera back a little more than for a drone."
v1.3.1-windows,"Otherwise, the camera will be stuck inside the car"
v1.3.1-windows,ExternalCamera->bUsePawnControlRotation = false;
v1.3.1-windows,detach spring arm
v1.3.1-windows,Re-enable rendering
v1.3.1-windows,Remove any existing key bindings for manual mode
v1.3.1-windows,"else someone else is bound to manual pose controller, leave it alone"
v1.3.1-windows,if new mode is manual mode then add key bindings
v1.3.1-windows,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.3.1-windows,other modes don't need special setup
v1.3.1-windows,make switch official
v1.3.1-windows,Split the tag string into individual tags.
v1.3.1-windows,Texture swap on actors that have all of those tags.
v1.3.1-windows,----------- Plotting APIs ----------/
v1.3.1-windows,"plot line for points 0-1, 1-2, 2-3"
v1.3.1-windows,"plot line for points 0-1, 2-3, 4-5... must be even number of points"
v1.3.1-windows,assert points_start.size() == poinst_end.size()
v1.3.1-windows,assert positions.size() == strings.size()
v1.3.1-windows,assert poses.size() == names.size()
v1.3.1-windows,by default all image types are disabled
v1.3.1-windows,use final color for all calculations
v1.3.1-windows,TODO: avoid the need to override const cast here
v1.3.1-windows,if the viewport is taller than it is wide
v1.3.1-windows,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v1.3.1-windows,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v1.3.1-windows,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v1.3.1-windows,use final color for all calculations
v1.3.1-windows,TODO: should we be ignoring position and orientation settings here?
v1.3.1-windows,TODO: can we eliminate storing NedTransform?
v1.3.1-windows,if (!std::isnan(setting.target_gamma))
v1.3.1-windows,camera-> = setting.target_gamma;
v1.3.1-windows,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.3.1-windows,else nothing to enable
v1.3.1-windows,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.3.1-windows,if (controller && controller->GetViewTarget() == this)
v1.3.1-windows,controller->SetViewTarget(nullptr);
v1.3.1-windows,TODO: explore screenshot option
v1.3.1-windows,addScreenCaptureHandler(camera->GetWorld());
v1.3.1-windows,TODO: may be we should have these methods non-const?
v1.3.1-windows,We don't do game/render thread synchronization for safe method.
v1.3.1-windows,We just blindly sleep for 200ms (the old way)
v1.3.1-windows,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.3.1-windows,Make sure that all alpha values are opaque.
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,"#include ""Runtime/Foliage/Public/FoliageType.h"""
v1.3.1-windows,TODO: change naming conventions to same as other files?
v1.3.1-windows,Enable/disable primary viewport rendering flag
v1.3.1-windows,This disables rendering of the main viewport in the same way as the
v1.3.1-windows,"console command ""show rendering"" would do."
v1.3.1-windows,"When getting an image through the API, the image is produced after the render"
v1.3.1-windows,thread has finished rendering the current and the subsequent frame. This means
v1.3.1-windows,that the frame rate for obtaining images through the API is only half as high as
v1.3.1-windows,"it could be, since only every other image is actually captured. We work around"
v1.3.1-windows,this by telling the viewport to flush the rendering queue at the end of each
v1.3.1-windows,drawn frame so that it executes our render request at that point already.
v1.3.1-windows,Do this only if the main viewport is not being rendered anyway in case there are
v1.3.1-windows,any adverse performance effects during main rendering.
v1.3.1-windows,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v1.3.1-windows,nothing to do for now
v1.3.1-windows,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.3.1-windows,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.3.1-windows,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.3.1-windows,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.3.1-windows,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.3.1-windows,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.3.1-windows,{
v1.3.1-windows,InitializeObjectStencilID(*comp);
v1.3.1-windows,}
v1.3.1-windows,Access the subclass instance with the * or -> operators.
v1.3.1-windows,"The skybox is ignored here as it is huge, and really is of no use to the end user typically. Also the associated meshes with the cameras"
v1.3.1-windows,Various checks if there is even a valid mesh
v1.3.1-windows,Need to force the render command to go through cause on the next iteration the buffer no longer exists
v1.3.1-windows,Unreal stores more vertices than triangles. So here we find the highest referenced vertex and ignore any after that
v1.3.1-windows,can we see followee?
v1.3.1-windows,remove mapping
v1.3.1-windows,removing binding
v1.3.1-windows,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.3.1-windows,"some point. At the moment, manually swapping Red and Blue"
v1.3.1-windows,Copy scaled image into destination thumb
v1.3.1-windows,Compress data - convert into a .png
v1.3.1-windows,if we already have attached actor
v1.3.1-windows,#ifdef _MSC_VER
v1.3.1-windows,//print to VS output window
v1.3.1-windows,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.3.1-windows,#endif
v1.3.1-windows,also do default logging
v1.3.1-windows,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.3.1-windows,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.3.1-windows,{
v1.3.1-windows,if (GEngine != nullptr)
v1.3.1-windows,{
v1.3.1-windows,return GEngine->GameUserSettings;
v1.3.1-windows,}
v1.3.1-windows,return nullptr;
v1.3.1-windows,}
v1.3.1-windows,UGameUserSettings* game_settings = GetGameUserSettings();
v1.3.1-windows,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.3.1-windows,game_settings->ApplySettings(true);
v1.3.1-windows,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.3.1-windows,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.3.1-windows,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.3.1-windows,todo unused. need to manually plots tf axes' line in right handed FLU instead of using DrawDebugCoordinateSystem
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,plugin startup
v1.3.1-windows,plugin shutdown
v1.3.1-windows,initialize state
v1.3.1-windows,add listener for pawn's collision event
v1.3.1-windows,compute our home point
v1.3.1-windows,default behavior is to call update every tick
v1.3.1-windows,"for custom physics engine, this method should be overridden and update should be"
v1.3.1-windows,called from every physics tick
v1.3.1-windows,add cameras that already exists in pawn
v1.3.1-windows,create or replace cameras specified in settings
v1.3.1-windows,setup individual cameras
v1.3.1-windows,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.3.1-windows,for each camera in settings
v1.3.1-windows,get pose
v1.3.1-windows,spawn and attach camera to pawn
v1.3.1-windows,add on to our collection
v1.3.1-windows,Deflect along the surface when we collide.
v1.3.1-windows,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.3.1-windows,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.3.1-windows,-1 to 1 --> 0 to 1
v1.3.1-windows,-1 to 1
v1.3.1-windows,these will be available for devices like steering wheels
v1.3.1-windows,switch index 0 to 7 for FrSky Taranis RC is:
v1.3.1-windows,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.3.1-windows,TODO: should below be at controller level info?
v1.3.1-windows,else don't waste time
v1.3.1-windows,sync environment from kinematics
v1.3.1-windows,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.3.1-windows,void playBack()
v1.3.1-windows,{
v1.3.1-windows,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.3.1-windows,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.3.1-windows,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.3.1-windows,}
v1.3.1-windows,TODO: refactor below code used for playback
v1.3.1-windows,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.3.1-windows,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.3.1-windows,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.3.1-windows,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.3.1-windows,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.3.1-windows,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.3.1-windows,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.3.1-windows,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.3.1-windows,}
v1.3.1-windows,parameters in NED frame
v1.3.1-windows,translate to new PawnSimApi position & orientation from NED to NEU
v1.3.1-windows,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.3.1-windows,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.3.1-windows,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.3.1-windows,checked at the start of next tick
v1.3.1-windows,allow teleportation
v1.3.1-windows,if collisions are not enabled
v1.3.1-windows,or we have collided but passthrough is enabled
v1.3.1-windows,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.3.1-windows,"without flip flopping, collisions can't be detected"
v1.3.1-windows,update kinematics from pawn's movement instead of physics engine
v1.3.1-windows,by default we update kinematics from UE pawn
v1.3.1-windows,if SimMod uses its own physics engine then this should be overriden
v1.3.1-windows,no default action in this base class
v1.3.1-windows,TODO: because this bug we are using alternative code with stringstream
v1.3.1-windows,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.3.1-windows,std::stringstream ss;
v1.3.1-windows,"ss << timestamp_millis << ""\t"";"
v1.3.1-windows,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.3.1-windows,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.3.1-windows,"ss << ""\n"";"
v1.3.1-windows,return ss.str();
v1.3.1-windows,"read pixels from render target using render thread, then compress the result into PNG"
v1.3.1-windows,argument on the thread that calls this method.
v1.3.1-windows,TODO: is below really needed?
v1.3.1-windows,make sure we are not on the rendering thread
v1.3.1-windows,TODO: below doesn't work right now because it must be running in game thread
v1.3.1-windows,below is documented method but more expensive because it forces flush
v1.3.1-windows,wait for render thread to pick up our task
v1.3.1-windows,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.3.1-windows,capture CameraPose for this frame
v1.3.1-windows,The completion is called immeidately after GameThread sends the
v1.3.1-windows,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.3.1-windows,execute *immediately* after RenderThread renders the scene!
v1.3.1-windows,"while we're still on GameThread, enqueue request for capture the scene!"
v1.3.1-windows,wait for this task to complete
v1.3.1-windows,log a message and continue wait
v1.3.1-windows,lamda function still references a few objects for which there is no refcount.
v1.3.1-windows,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.3.1-windows,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.3.1-windows,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.3.1-windows,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.3.1-windows,Fill out your copyright notice in the Description page of Project Settings.
v1.3.1-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.1-windows,UWorld* World = GetWorld();
v1.3.1-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.1-windows,still need the menu class for f10
v1.3.1-windows,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v1.3.1-windows,showWeatherMenu(WorldContextObject);
v1.3.1-windows,"if weather is not enabled, dont allow any weather values to be set"
v1.3.1-windows,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v1.3.1-windows,and must be set to true or false before this.
v1.3.1-windows,WeatherEnabled will always be false
v1.3.1-windows,"NOTE: weather enabled must be set first, before other params for this to work"
v1.3.1-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.1-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.1-windows,"get all menu actors, if any"
v1.3.1-windows,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.3.1-windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.1-windows,"get all menu actors, if any"
v1.3.1-windows,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.3.1-windows,"get all menu actors, if any, then hide the menu"
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,Stuff to filter out XInput devices
v1.3.1-windows,-----------------------------------------------------------------------------
v1.3.1-windows,"Defines, constants, and global variables"
v1.3.1-windows,-----------------------------------------------------------------------------
v1.3.1-windows,Magnitude ranges from -1 to 1
v1.3.1-windows,Strength ranges from 0 to 1
v1.3.1-windows,Autocenter
v1.3.1-windows,Rumble
v1.3.1-windows,Register with the DirectInput subsystem and get a pointer
v1.3.1-windows,to a IDirectInput interface we can use.
v1.3.1-windows,Create a DInput object
v1.3.1-windows,Look for a simple joystick we can use for this sample program.
v1.3.1-windows,Make sure we got a joystick
v1.3.1-windows,"Set the data format to ""simple joystick"" - a predefined data format"
v1.3.1-windows,
v1.3.1-windows,"A data format specifies which controls on a device we are interested in,"
v1.3.1-windows,and how they should be reported. This tells DInput that we will be
v1.3.1-windows,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.3.1-windows,Set the cooperative level to let DInput know how this device should
v1.3.1-windows,interact with the system and with other DInput applications.
v1.3.1-windows,Enumerate the joystick objects. The callback function enabled user
v1.3.1-windows,"interface elements for objects that are found, and sets the min/max"
v1.3.1-windows,values property for discovered axes.
v1.3.1-windows,-----------------------------------------------------------------------------
v1.3.1-windows,Enum each PNP device using WMI and check each device ID to see if it contains
v1.3.1-windows,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.3.1-windows,Unfortunately this information can not be found by just using DirectInput.
v1.3.1-windows,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.3.1-windows,XInput devices.
v1.3.1-windows,
v1.3.1-windows,This function stores the list of xinput devices in a linked list
v1.3.1-windows,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.3.1-windows,-----------------------------------------------------------------------------
v1.3.1-windows,CoInit if needed
v1.3.1-windows,Create WMI
v1.3.1-windows,Create BSTRs for WMI
v1.3.1-windows,Connect to WMI
v1.3.1-windows,Switch security level to IMPERSONATE
v1.3.1-windows,Get list of Win32_PNPEntity devices
v1.3.1-windows,Loop over all devices
v1.3.1-windows,Get 20 at a time
v1.3.1-windows,"For each device, get its device ID"
v1.3.1-windows,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.3.1-windows,Unfortunately this information can not be found by just using DirectInput
v1.3.1-windows,"If it does, then get the VID/PID from var.bstrVal"
v1.3.1-windows,Add the VID/PID to a linked list
v1.3.1-windows,-----------------------------------------------------------------------------
v1.3.1-windows,Returns true if the DirectInput device is also an XInput device.
v1.3.1-windows,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.3.1-windows,-----------------------------------------------------------------------------
v1.3.1-windows,Check each xinput device to see if this device's vid/pid matches
v1.3.1-windows,-----------------------------------------------------------------------------
v1.3.1-windows,Cleanup needed for IsXInputDevice()
v1.3.1-windows,-----------------------------------------------------------------------------
v1.3.1-windows,Cleanup linked list
v1.3.1-windows,-----------------------------------------------------------------------------
v1.3.1-windows,Name: EnumJoysticksCallback()
v1.3.1-windows,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.3.1-windows,device interface on it so we can play with it.
v1.3.1-windows,-----------------------------------------------------------------------------
v1.3.1-windows,Skip anything other than the perferred joystick device as defined by the control panel.
v1.3.1-windows,Instead you could store all the enumerated joysticks and let the user pick.
v1.3.1-windows,Obtain an interface to the enumerated joystick.
v1.3.1-windows,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.3.1-windows,it while we were in the middle of enumerating it.)
v1.3.1-windows,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.3.1-windows,could store all the enumerated joysticks and let the user pick.
v1.3.1-windows,-----------------------------------------------------------------------------
v1.3.1-windows,Name: EnumObjectsCallback()
v1.3.1-windows,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.3.1-windows,joystick. This function enables user interface elements for objects
v1.3.1-windows,"that are found to exist, and scales axes min/max values."
v1.3.1-windows,-----------------------------------------------------------------------------
v1.3.1-windows,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.3.1-windows,enumerated axis in order to scale min/max values.
v1.3.1-windows,Set the range for the axis
v1.3.1-windows,Set the UI to reflect what objects the joystick supports
v1.3.1-windows,-----------------------------------------------------------------------------
v1.3.1-windows,Name: UpdateInputState()
v1.3.1-windows,Desc: Get the input device's state and display it.
v1.3.1-windows,-----------------------------------------------------------------------------
v1.3.1-windows,Poll the device to read the current state
v1.3.1-windows,DInput is telling us that the input stream has been
v1.3.1-windows,"interrupted. We aren't tracking any state between polls, so"
v1.3.1-windows,we don't have any special reset that needs to be done. We
v1.3.1-windows,just re-acquire and try again.
v1.3.1-windows,while (hr == DIERR_INPUTLOST)
v1.3.1-windows,hr = g_pJoystick->Acquire();
v1.3.1-windows,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.3.1-windows,may occur when the app is minimized or in the process of
v1.3.1-windows,"switching, so just try again later"
v1.3.1-windows,Get the input's device state
v1.3.1-windows,Axes
v1.3.1-windows,Slider controls
v1.3.1-windows,Points of view
v1.3.1-windows,Buttons
v1.3.1-windows,-----------------------------------------------------------------------------
v1.3.1-windows,Name: FreeDirectInput()
v1.3.1-windows,Desc: Initialize the DirectInput variables.
v1.3.1-windows,-----------------------------------------------------------------------------
v1.3.1-windows,Unacquire the device one last time just in case
v1.3.1-windows,the app tried to exit while the device is still acquired.
v1.3.1-windows,Release any DirectInput objects.
v1.3.1-windows,nop
v1.3.1-windows,normalize min to max --> 0 to 1
v1.3.1-windows,normalize 0 to 1 --> -1 to 1
v1.3.1-windows,#include <libudev.h>
v1.3.1-windows,implementation for unsupported OS
v1.3.1-windows,if this is new index
v1.3.1-windows,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.3.1-windows,close previous one
v1.3.1-windows,open new device
v1.3.1-windows,if open was successful
v1.3.1-windows,read the device
v1.3.1-windows,if we didn't had valid read
v1.3.1-windows,"NOTE if this condition is not met, we're probably out of sync and this"
v1.3.1-windows,Joystick instance is likely unusable
v1.3.1-windows,TODO: set below to false?
v1.3.1-windows,state.is_valid = false;
v1.3.1-windows,else ignore
v1.3.1-windows,TODO: implement this for linux
v1.3.1-windows,TODO: implement this for linux
v1.3.1-windows,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.3.1-windows,{
v1.3.1-windows,"manufacturerID = productID = """";"
v1.3.1-windows,// Use udev to look up the product and manufacturer IDs
v1.3.1-windows,struct udev *udev = udev_new();
v1.3.1-windows,if (udev) {
v1.3.1-windows,char sysname[32];
v1.3.1-windows,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.3.1-windows,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.3.1-windows,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.3.1-windows,if (!dev)
v1.3.1-windows,{
v1.3.1-windows,"message = ""Unable to find parent USB device"";"
v1.3.1-windows,return false;
v1.3.1-windows,}
v1.3.1-windows,std::stringstream ss;
v1.3.1-windows,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.3.1-windows,ss >> manufacturerID;
v1.3.1-windows,ss.clear();
v1.3.1-windows,"ss.str("""");"
v1.3.1-windows,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.3.1-windows,ss >> productID;
v1.3.1-windows,udev_device_unref(dev);
v1.3.1-windows,}
v1.3.1-windows,else
v1.3.1-windows,{
v1.3.1-windows,"message = ""Cannot create udev"";"
v1.3.1-windows,return false;
v1.3.1-windows,}
v1.3.1-windows,udev_unref(udev);
v1.3.1-windows,return true;
v1.3.1-windows,}
v1.3.1-windows,required for pimpl
v1.3.1-windows,TODO: anyway to workaround const_cast?
v1.3.1-windows,FGenericPlatformMisc::PlatformInit();
v1.3.1-windows,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.3.1-windows,TODO: index check
v1.3.1-windows,create main widget
v1.3.1-windows,synchronize PIP views
v1.3.1-windows,TODO: should we only do below on SceneCapture2D components and cameras?
v1.3.1-windows,avoid motion blur so capture images don't get
v1.3.1-windows,use two different methods to set console var because sometime it doesn't seem to work
v1.3.1-windows,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.3.1-windows,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.3.1-windows,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.3.1-windows,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.3.1-windows,setup defaults
v1.3.1-windows,Attempts to parse the settings text from one of multiple locations.
v1.3.1-windows,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.3.1-windows,"Next, check the executable's working directory for the settings file."
v1.3.1-windows,"Finally, check the user's documents folder."
v1.3.1-windows,"If the settings file cannot be read, throw an exception"
v1.3.1-windows,Attempts to parse the settings text from the command line
v1.3.1-windows,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.3.1-windows,"Example: AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.3.1-windows,"Returns true if the argument is present, false otherwise."
v1.3.1-windows,build image file name
v1.3.1-windows,write image file
v1.3.1-windows,write to CSV file
v1.3.1-windows,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.3.1-windows,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.3.1-windows,make sire all vars are set up
v1.3.1-windows,"TODO: should we go as fast as possible, or should we limit this to a particular number of"
v1.3.1-windows,frames per second?
v1.3.1-windows,BG: Workaround to get sync ground truth. See https://github.com/Microsoft/AirSim/issues/1494 for details
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,decide which derived BP to use
v1.3.1-windows,we don't have real vehicle so no vehicle API
v1.3.1-windows,put camera little bit above vehicle
v1.3.1-windows,update ground level
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,let base class setup physics world
v1.3.1-windows,stop physics thread before we dismantle
v1.3.1-windows,setup clock in ClockFactory
v1.3.1-windows,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.3.1-windows,steppable clock returns interval that is a constant number irrespective of wall clock
v1.3.1-windows,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.3.1-windows,but that would cause vehicles like quadrotors to become unstable
v1.3.1-windows,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.3.1-windows,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.3.1-windows,get increase in clock speed
v1.3.1-windows,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.3.1-windows,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.3.1-windows,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.3.1-windows,Approach 2: scale control loop frequency if clock is speeded up
v1.3.1-windows,"for slowing down, this don't generate instability"
v1.3.1-windows,-------------------------------- overrides -----------------------------------------------//
v1.3.1-windows,decide which derived BP to use
v1.3.1-windows,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.3.1-windows,vehicle_sim_api->reset();
v1.3.1-windows,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.3.1-windows,create vehicle API
v1.3.1-windows,setup physics vehicle
v1.3.1-windows,initialize private vars
v1.3.1-windows,calls to update* are handled by physics engine and in SimModeWorldBase
v1.3.1-windows,"Utils::log(""------Render tick-------"");"
v1.3.1-windows,"if reset is pending then do it first, no need to do other things until next tick"
v1.3.1-windows,move collision info from rendering engine to vehicle
v1.3.1-windows,update rotor poses
v1.3.1-windows,if we did reset then don't worry about synchronizing states for this tick
v1.3.1-windows,Continue to wait for reset
v1.3.1-windows,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.3.1-windows,*** Start: UpdatableState implementation ***//
v1.3.1-windows,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.3.1-windows,environment update for current position
v1.3.1-windows,update forces on vertices
v1.3.1-windows,update to controller must be done after kinematics have been updated by physics engine
v1.3.1-windows,*** End: UpdatableState implementation ***//
v1.3.1-windows,get references of existing camera
v1.3.1-windows,setup clock in PhysX
v1.3.1-windows,-------------------------------- overrides -----------------------------------------------//
v1.3.1-windows,decide which derived BP to use
v1.3.1-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.3.1-windows,Setup suspension forces
v1.3.1-windows,Find the tire object and set the data for it
v1.3.1-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.3.1-windows,Setup suspension forces
v1.3.1-windows,Find the tire object and set the data for it
v1.3.1-windows,Create In-Car camera component
v1.3.1-windows,In car HUD
v1.3.1-windows,Create text render component for in car speed display
v1.3.1-windows,Create text render component for in car gear display
v1.3.1-windows,Setup the audio component and allocate it a sound cue
v1.3.1-windows,Colors for the in-car gear display. One for normal one for reverse
v1.3.1-windows,Wheels/Tires
v1.3.1-windows,Setup the wheels
v1.3.1-windows,Adjust the tire loading
v1.3.1-windows,Engine
v1.3.1-windows,Torque setup
v1.3.1-windows,Adjust the steering
v1.3.1-windows,Transmission
v1.3.1-windows,We want 4wd
v1.3.1-windows,Drive the front wheels a little more than the rear
v1.3.1-windows,Automatic gearbox
v1.3.1-windows,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.3.1-windows,Physics settings
v1.3.1-windows,Adjust the center of mass - the buggy is quite low
v1.3.1-windows,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.3.1-windows,put camera little bit above vehicle
v1.3.1-windows,update physics material
v1.3.1-windows,Update the strings used in the HUD (in-car and on-screen)
v1.3.1-windows,Set the string in the in-car HUD
v1.3.1-windows,Pass the engine RPM to the sound component
v1.3.1-windows,Start an engine sound playing
v1.3.1-windows,Using FText because this is display text that should be localizable
v1.3.1-windows,Setup the text render component strings
v1.3.1-windows,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.3.1-windows,below is not needed
v1.3.1-windows,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.3.1-windows,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.3.1-windows,TODO: should do reset() here?
v1.3.1-windows,create vehicle params
v1.3.1-windows,these are called on render ticks
v1.3.1-windows,TODO: do we need this for cars?
v1.3.1-windows,TODO: move this to SimModeBase?
v1.3.1-windows,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.3.1-windows,reset();
v1.3.1-windows,return;
v1.3.1-windows,}
v1.3.1-windows,Thrustmaster devices
v1.3.1-windows,"Anything else, typically Logitech G920 wheel"
v1.3.1-windows,Two steel levers behind wheel
v1.3.1-windows,if API-client control is not active then we route keyboard/joystick control to car
v1.3.1-windows,all car controls from anywhere must be routed through API component
v1.3.1-windows,*** Start: UpdatableState implementation ***//
v1.3.1-windows,physics tick
v1.3.1-windows,*** End: UpdatableState implementation ***//
v1.3.1-windows,TODO: directly accept getVehicleSimApis() using generic container
v1.3.1-windows,remove everything that we created in BeginPlay
v1.3.1-windows,we use custom debug reporting for this class
v1.3.1-windows,perform any expensive rendering update outside of lock region
v1.3.1-windows,no need to call base reset because of our custom implementation
v1.3.1-windows,TODO: this is going to cause circular references which is fine here but
v1.3.1-windows,in future we should consider moving SimMode not derived from AActor and move
v1.3.1-windows,it to AirLib and directly implement WorldSimApiBase interface
v1.3.1-windows,get player start
v1.3.1-windows,this must be done from within actor otherwise we don't get player start
v1.3.1-windows,UWeatherLib::showWeatherMenu(World);
v1.3.1-windows,else don't init
v1.3.1-windows,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v1.3.1-windows,tod_sim_clock_start_ needs to be reset here.
v1.3.1-windows,Going from enabled to disabled
v1.3.1-windows,do these in the end to ensure that advanceTimeOfDay() doesn't see
v1.3.1-windows,any inconsistent state.
v1.3.1-windows,should be overridden by derived class
v1.3.1-windows,should be overridden by derived class
v1.3.1-windows,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.3.1-windows,default setup - this should be overridden in derived modes as needed
v1.3.1-windows,setup clock in ClockFactory
v1.3.1-windows,default implementation
v1.3.1-windows,create director
v1.3.1-windows,create external camera required for the director
v1.3.1-windows,API server start/stop
v1.3.1-windows,get UU origin of global NED frame
v1.3.1-windows,determine camera director camera default pose and spawn it
v1.3.1-windows,find all vehicle pawns
v1.3.1-windows,add vehicles from settings
v1.3.1-windows,if vehicle is of type for derived SimMode and auto creatable
v1.3.1-windows,compute initial pose
v1.3.1-windows,spawn vehicle pawn
v1.3.1-windows,create API objects for each pawn we have
v1.3.1-windows,create vehicle sim api
v1.3.1-windows,TODO: better handle no FPV vehicles scenario
v1.3.1-windows,derived class should override this method to retrieve types of pawns they support
v1.3.1-windows,derived class should override this method to retrieve types of pawns they support
v1.3.1-windows,derived class should override this method to retrieve types of pawns they support
v1.3.1-windows,derived class should override this method to retrieve types of pawns they support
v1.3.1-windows,derived class should override this method to retrieve types of pawns they support
v1.3.1-windows,derived class should override this method to retrieve types of pawns they support
v1.3.1-windows,derived class should override this method to retrieve types of pawns they support
v1.3.1-windows,Draws debug-points on main viewport for Lidar laser hits.
v1.3.1-windows,Used for debugging only.
v1.3.1-windows,Currently we are checking the sensor-collection instead of sensor-settings.
v1.3.1-windows,Also using variables to optimize not checking the collection if not needed.
v1.3.1-windows,TODO: Is it incorrect to assume LidarSimple here?
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,ctor
v1.3.1-windows,initializes information based on lidar configuration
v1.3.1-windows,calculate verticle angle distance between each laser
v1.3.1-windows,store vertical angles for each laser
v1.3.1-windows,returns a point-cloud for the tick
v1.3.1-windows,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.3.1-windows,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.3.1-windows,calculate number of points needed for each laser/channel
v1.3.1-windows,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.3.1-windows,calculate needed angle/distance between each point
v1.3.1-windows,normalize FOV start/end
v1.3.1-windows,shoot lasers
v1.3.1-windows,check if the laser is outside the requested horizontal FOV
v1.3.1-windows,"shoot laser and get the impact point, if any"
v1.3.1-windows,simulate shooting a laser via Unreal ray-tracing.
v1.3.1-windows,start position
v1.3.1-windows,We need to compose rotations here rather than rotate a vector by a quaternion
v1.3.1-windows,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.3.1-windows,get ray quaternion in lidar frame (angles must be in radians)
v1.3.1-windows,get ray quaternion in body frame
v1.3.1-windows,get ray quaternion in world frame
v1.3.1-windows,get ray vector (end position)
v1.3.1-windows,Store the segmentation id of the hit object.
v1.3.1-windows,Debug code for very specific cases.
v1.3.1-windows,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.3.1-windows,decide the frame for the point-cloud
v1.3.1-windows,current detault behavior; though it is probably not very useful.
v1.3.1-windows,not changing the default for now to maintain backwards-compat.
v1.3.1-windows,point in vehicle intertial frame
v1.3.1-windows,tranform to lidar frame
v1.3.1-windows,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.3.1-windows,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.3.1-windows,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.3.1-windows,"On the client side, if it is needed to transform this data back to the world frame,"
v1.3.1-windows,"then do the equivalent of following,"
v1.3.1-windows,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.3.1-windows,See SimModeBase::drawLidarDebugPoints()
v1.3.1-windows,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.3.1-windows,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,update ray tracing
v1.3.1-windows,"FString hit_name = FString(""None"");"
v1.3.1-windows,if (dist_hit.GetActor())
v1.3.1-windows,hit_name=dist_hit.GetActor()->GetName();
v1.3.1-windows,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.3.1-windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,This assumes you are running DroneServer already on the same machine.
v1.3.1-windows,DroneServer must be running first.
v1.3.1-windows,enable API control
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,move commands
v1.3.1-windows,else leave as it is
v1.3.1-windows,TODO: get these in one call
v1.3.1-windows,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.3.1-windows,TODO: shouldn't we pass folder path?
v1.3.1-windows,parse
v1.3.1-windows,group the images by the current date.
v1.3.1-windows,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.3.1-windows,{
v1.3.1-windows,"return """";"
v1.3.1-windows,}
v1.3.1-windows,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.3.1-windows,{
v1.3.1-windows,return false;
v1.3.1-windows,}
v1.3.1-windows,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.3.1-windows,params.context->client.newTask();
v1.3.1-windows,}
v1.3.1-windows,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.3.1-windows,params.context->client.WaitForCompletion(0);
v1.3.1-windows,}
v1.3.1-windows,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.3.1-windows,{
v1.3.1-windows,}
v1.3.1-windows,parse command line
v1.3.1-windows,Shell callbacks
v1.3.1-windows,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.3.1-windows,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.3.1-windows,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.3.1-windows,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.3.1-windows,Add shell commands
v1.3.1-windows,TODO: add WaitForCompletion command
v1.3.1-windows,"TODO: add command line args help, arg count validation"
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v1.3.1-windows,switch to explicit hover mode so that this is the fall back when
v1.3.1-windows,move* commands are finished.
v1.3.1-windows,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.3.1-windows,TODO: implement weather for Unity
v1.3.1-windows,TODO: implement weather for Unity
v1.3.1-windows,----------------Plotting APIs-----------/
v1.3.1-windows,Function pointers to hold the addresses of the functions that are defined in Unity
v1.3.1-windows,"Enabling all LogLevels,"
v1.3.1-windows,"Enabling all LogLevels,"
v1.3.1-windows,delete ltm;
v1.3.1-windows,initialize state
v1.3.1-windows,compute our home point
v1.3.1-windows,default behavior is to call update every tick
v1.3.1-windows,"for custom physics engine, this method should be overridden and update should be"
v1.3.1-windows,called from every physics tick
v1.3.1-windows,these will be available for devices like steering wheels
v1.3.1-windows,sync environment from kinematics
v1.3.1-windows,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.3.1-windows,FVector unrealPosition = getUUPosition();
v1.3.1-windows,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v1.3.1-windows,parameters in NED frame
v1.3.1-windows,allow teleportation
v1.3.1-windows,if collisions are not enabled
v1.3.1-windows,or we have collided but passthrough is enabled
v1.3.1-windows,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.3.1-windows,"without flip flopping, collisions can't be detected"
v1.3.1-windows,by default we update kinematics from UE pawn
v1.3.1-windows,if SimMod uses its own physics engine then this should be overriden
v1.3.1-windows,no default action in this base class
v1.3.1-windows,TODO: because this bug we are using alternative code with stringstream
v1.3.1-windows,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.3.1-windows,update kinematics from pawn's movement instead of physics engine
v1.3.1-windows,TODO: update other fields?
v1.3.1-windows,implements getImages() method in the ImageCaptureBase class.
v1.3.1-windows,update ray tracing
v1.3.1-windows,TODO: index check
v1.3.1-windows,Attempts to parse the settings text from one of multiple locations.
v1.3.1-windows,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.3.1-windows,"Next, check the executable's working directory for the settings file."
v1.3.1-windows,"Finally, check the user's documents folder."
v1.3.1-windows,"If the settings file cannot be read, throw an exception"
v1.3.1-windows,let base class setup physics world
v1.3.1-windows,stop physics thread before we dismantle
v1.3.1-windows,setup clock in ClockFactory
v1.3.1-windows,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.3.1-windows,steppable clock returns interval that is a constant number irrespective of wall clock
v1.3.1-windows,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.3.1-windows,but that would cause vehicles like quadrotors to become unstable
v1.3.1-windows,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.3.1-windows,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.3.1-windows,get increase in clock speed
v1.3.1-windows,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.3.1-windows,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.3.1-windows,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.3.1-windows,Approach 2: scale control loop frequency if clock is speeded up
v1.3.1-windows,"for slowing down, this don't generate instability"
v1.3.1-windows,-------------------------------- overrides -----------------------------------------------//
v1.3.1-windows,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.3.1-windows,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.3.1-windows,create vehicle API
v1.3.1-windows,setup physics vehicle
v1.3.1-windows,initialize private vars
v1.3.1-windows,"if reset is pending then do it first, no need to do other things until next tick"
v1.3.1-windows,move collision info from rendering engine to vehicle
v1.3.1-windows,update rotor poses
v1.3.1-windows,if we did reset then don't worry about synchronizing states for this tick
v1.3.1-windows,Continue to wait for reset
v1.3.1-windows,*** Start: UpdatableState implementation ***//
v1.3.1-windows,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.3.1-windows,environment update for current position
v1.3.1-windows,update forces on vertices
v1.3.1-windows,update to controller must be done after kinematics have been updated by physics engine
v1.3.1-windows,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.3.1-windows,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.3.1-windows,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.3.1-windows,*** End: UpdatableState implementation ***//
v1.3.1-windows,TODO: should do reset() here?
v1.3.1-windows,these are called on render ticks
v1.3.1-windows,TODO: do we need this for cars?
v1.3.1-windows,Thrustmaster devices
v1.3.1-windows,"Anything else, typically Logitech G920 wheel"
v1.3.1-windows,Two steel levers behind wheel
v1.3.1-windows,if API-client control is not active then we route keyboard/joystick control to car
v1.3.1-windows,all car controls from anywhere must be routed through API component
v1.3.1-windows,*** Start: UpdatableState implementation ***//
v1.3.1-windows,physics tick
v1.3.1-windows,void CarPawnSimApi::reportState(StateReporter& reporter)
v1.3.1-windows,{
v1.3.1-windows,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.3.1-windows,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.3.1-windows,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.3.1-windows,}
v1.3.1-windows,*** End: UpdatableState implementation ***//
v1.3.1-windows,remove everything that we created in BeginPlay
v1.3.1-windows,we use custom debug reporting for this class
v1.3.1-windows,perform any expensive rendering update outside of lock region
v1.3.1-windows,no need to call base reset because of our custom implementation
v1.3.1-windows,should be overridden by derived class
v1.3.1-windows,should be overridden by derived class
v1.3.1-windows,commenting this out for now to avoid unintentional Unity startup failure
v1.3.1-windows,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v1.3.1-windows,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.3.1-windows,default setup - this should be overridden in derived modes as needed
v1.3.1-windows,setup clock in ClockFactory
v1.3.1-windows,API server start/stop
v1.3.1-windows,determine camera director camera default pose and spawn it
v1.3.1-windows,derived class should override this method to retrieve types of pawns they support
v1.3.1-windows,derived class should override this method to retrieve types of pawns they support
v1.3.1-windows,60 acres park:
v1.3.1-windows,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.3.1-windows,marymoore park
v1.3.1-windows,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.3.1-windows,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.3.1-windows,DepthNavThreshold depthNav;
v1.3.1-windows,DepthNavOptAStar depthNav;
v1.3.1-windows,DepthNavThreshold depthNav;
v1.3.1-windows,DepthNavOptAStar depthNav;
v1.3.1-windows,Cleanup
v1.3.1-windows,runDepthNavGT();
v1.3.1-windows,runDepthNavSGM();
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,by Sudipta Sinha
v1.3.1-windows,adapted for AirSim by Matthias Mueller
v1.3.1-windows,first row
v1.3.1-windows,last row
v1.3.1-windows,Local quadratic fit of cost and subpixel refinement.
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,by Sudipta Sinha
v1.3.1-windows,adapted for AirSim by Matthias Mueller
v1.3.1-windows,uint64_t x64 = (uint64_t)x;
v1.3.1-windows,uint64_t y64 = (uint64_t)y;
v1.3.1-windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-windows,Licensed under the MIT License.
v1.3.1-windows,by Sudipta Sinha
v1.3.1-windows,adapted for AirSim by Matthias Mueller
v1.3.1-windows,ensure that disparity range is a multiple of 8
v1.3.1-windows,sgm stereo
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,read settings and override defaults
v1.3.1-linux,allow json overrides on a per-vehicle basis.
v1.3.1-linux,start server in async mode
v1.3.1-linux,check messages
v1.3.1-linux,In settings.json first activate computer vision mode:
v1.3.1-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.1-linux,monitor car state while you drive it manually.
v1.3.1-linux,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v1.3.1-linux,denominator from microns^3 to microns * m^2)
v1.3.1-linux,First set everything to 0.
v1.3.1-linux,Next set all objects of interest provided to corresponding object IDs
v1.3.1-linux,segIdDict values MUST match tempEmissivityNew labels.
v1.3.1-linux,"Connect to AirSim, UAV mode."
v1.3.1-linux,Choose temperature values for winter or summer.
v1.3.1-linux,""""""""
v1.3.1-linux,winter
v1.3.1-linux,""""""""
v1.3.1-linux,summer
v1.3.1-linux,Read camera response.
v1.3.1-linux,Calculate radiance.
v1.3.1-linux,Set IDs in AirSim environment.
v1.3.1-linux,plot red arrows for 30 seconds
v1.3.1-linux,plot magenta arrows for 15 seconds
v1.3.1-linux,plot red arrows for 10 seconds
v1.3.1-linux,plot 2 white arrows which are persistent
v1.3.1-linux,plot points
v1.3.1-linux,"plot line strip. 0-1, 1-2, 2-3"
v1.3.1-linux,"plot line list. 0-1, 2-3, 4-5. Must be even."
v1.3.1-linux,plot transforms
v1.3.1-linux,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=0.0, yaw=yaw)) for x, y, yaw in zip(np.linspace(0,10,10), np.linspace(0,0,10), np.linspace(0,np.pi,10))],"
v1.3.1-linux,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.3.1-linux,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=roll, yaw=0.0)) for x, y, roll in zip(np.linspace(0,10,10), np.linspace(1,1,10), np.linspace(0,np.pi,10))],"
v1.3.1-linux,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.3.1-linux,In settings.json first activate computer vision mode:
v1.3.1-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.1-linux,"define abstract class to return next vector in the format (x,y,yaw)"
v1.3.1-linux,"compute vector, distance and angle to goal"
v1.3.1-linux,compute box of interest
v1.3.1-linux,scale by weight matrix (optional)
v1.3.1-linux,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.3.1-linux,detect collision
v1.3.1-linux,compute box of interest
v1.3.1-linux,detect collision
v1.3.1-linux,Same as above but decide to go left or right based on average or some metric like that
v1.3.1-linux,"compute resultant normalized vector, distance and angle"
v1.3.1-linux,compute bounding box size
v1.3.1-linux,convert horizonal fov to vertical fov
v1.3.1-linux,matrix with all ones
v1.3.1-linux,matrix with max weight in center and decreasing linearly with distance from center
v1.3.1-linux,matrix with max weight in center and decreasing quadratically with distance from center
v1.3.1-linux,"print (""Saving images to %s"" % tmp_dir)"
v1.3.1-linux,airsim.wait_key('Press any key to start')
v1.3.1-linux,"Define start position, goal and size of UAV"
v1.3.1-linux,Define parameters and thresholds
v1.3.1-linux,initial position
v1.3.1-linux,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.3.1-linux,time.sleep(1)
v1.3.1-linux,get response
v1.3.1-linux,get numpy array
v1.3.1-linux,reshape array to 2D array H X W
v1.3.1-linux,write to png
v1.3.1-linux,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.3.1-linux,pose = client.simGetPose()
v1.3.1-linux,pp.pprint(pose)
v1.3.1-linux,time.sleep(5)
v1.3.1-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.3.1-linux,################### OLD CODE
v1.3.1-linux,timer = 0
v1.3.1-linux,time_obs = 50
v1.3.1-linux,bObstacle = False
v1.3.1-linux,if (bObstacle):
v1.3.1-linux,timer = timer + 1
v1.3.1-linux,if timer > time_obs:
v1.3.1-linux,bObstacle = False
v1.3.1-linux,timer = 0
v1.3.1-linux,else:
v1.3.1-linux,yaw = target_angle
v1.3.1-linux,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.3.1-linux,if (np.average(img2d_box) < coll_thres):
v1.3.1-linux,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.3.1-linux,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.3.1-linux,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.3.1-linux,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.3.1-linux,"print('left: ', img2d_box_l_avg)"
v1.3.1-linux,"print('right: ', img2d_box_r_avg)"
v1.3.1-linux,if img2d_box_l_avg > img2d_box_r_avg:
v1.3.1-linux,##Go LEFT
v1.3.1-linux,#y_offset = y_offset-1
v1.3.1-linux,yaw = yaw - radians(10)
v1.3.1-linux,bObstacle = True
v1.3.1-linux,else:
v1.3.1-linux,##Go RIGHT
v1.3.1-linux,#y_offset = y_offset+1
v1.3.1-linux,yaw = yaw + radians(10)
v1.3.1-linux,bObstacle = true
v1.3.1-linux,"print('yaw: ', yaw)"
v1.3.1-linux,In settings.json first activate computer vision mode:
v1.3.1-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.1-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.3.1-linux,In settings.json first activate computer vision mode:
v1.3.1-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.1-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.3.1-linux,pip install opencv-python
v1.3.1-linux,In settings.json first activate computer vision mode:
v1.3.1-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.1-linux,for block environment
v1.3.1-linux,regex are case insensitive
v1.3.1-linux,#for neighborhood environment
v1.3.1-linux,set object ID for sky
v1.3.1-linux,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.3.1-linux,get segmentation image in various formats
v1.3.1-linux,save segmentation images in various formats
v1.3.1-linux,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.3.1-linux,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.3.1-linux,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v1.3.1-linux,find unique colors
v1.3.1-linux,In settings.json first activate computer vision mode:
v1.3.1-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.1-linux,objects can be named in two ways:
v1.3.1-linux,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.3.1-linux,default name is auto-generated and varies from run-to-run.
v1.3.1-linux,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.3.1-linux,
v1.3.1-linux,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.3.1-linux,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.3.1-linux,https://answers.unrealengine.com/revisions/790629.html
v1.3.1-linux,below works in Blocks environment
v1.3.1-linux,------------------------------------ Get current pose ------------------------------------------------
v1.3.1-linux,search object by name:
v1.3.1-linux,search another object by tag
v1.3.1-linux,search non-existent object
v1.3.1-linux,------------------------------------ Set new pose ------------------------------------------------
v1.3.1-linux,here we move with teleport enabled so collisions are ignored
v1.3.1-linux,here we move with teleport enabled so collisions are not ignored
v1.3.1-linux,move non-existent object
v1.3.1-linux,------------------------------------ Get new pose ------------------------------------------------
v1.3.1-linux,search another object by tag
v1.3.1-linux,search non-existent object
v1.3.1-linux,Import this module to automatically setup path to local airsim module
v1.3.1-linux,This module first tries to see if airsim module is installed via pip
v1.3.1-linux,If it does then we don't do anything else
v1.3.1-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.3.1-linux,and if it does then we add that in sys.path
v1.3.1-linux,this class simply tries to see if airsim
v1.3.1-linux,if airsim module is installed then don't do anything else
v1.3.1-linux,import pkgutil
v1.3.1-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.3.1-linux,if airsim_loader is not None:
v1.3.1-linux,return
v1.3.1-linux,"Roll is applied first, then pitch, then yaw."
v1.3.1-linux,Turn the camera position into a column vector.
v1.3.1-linux,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v1.3.1-linux,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v1.3.1-linux,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v1.3.1-linux,Recreate the perspective projection of the camera.
v1.3.1-linux,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v1.3.1-linux,Set pose and sleep after to ensure the pose sticks before capturing image.
v1.3.1-linux,Capture segmentation (IR) and scene images.
v1.3.1-linux,Change images into numpy arrays.
v1.3.1-linux,Capture images for a certain amount of time in seconds (half hour now)
v1.3.1-linux,Capture image - pose.position x_val access may change w/ AirSim
v1.3.1-linux,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v1.3.1-linux,Convert color scene image to BGR for write out with cv2.
v1.3.1-linux,"Connect to AirSim, UAV mode."
v1.3.1-linux,Look for objects with names that match a regular expression.
v1.3.1-linux,"Sample calls to main, varying camera angle and altitude."
v1.3.1-linux,"straight down, 400ft"
v1.3.1-linux,"straight down, 200ft"
v1.3.1-linux,"45 degrees, 200ft -- note that often object won't be scene since position"
v1.3.1-linux,is set exactly to object's
v1.3.1-linux,"45 degrees, 400ft -- note that often object won't be scene since position"
v1.3.1-linux,is set exactly to object's
v1.3.1-linux,In settings.json first activate computer vision mode:
v1.3.1-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.1-linux,xn = 1 + x*5  # some random number
v1.3.1-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,monitor car state while you drive it manually.
v1.3.1-linux,get state of the car
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,go forward
v1.3.1-linux,get state of the car
v1.3.1-linux,Python client example to change time-of-day using APIs
v1.3.1-linux,
v1.3.1-linux,Changes time of the day and makes the car move around
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,flip between specific time and default time
v1.3.1-linux,go forward
v1.3.1-linux,Go forward + steer right
v1.3.1-linux,main
v1.3.1-linux,import gym #pip install gym
v1.3.1-linux,Local variable access is faster in loops
v1.3.1-linux,"if not wrapping over current pointer,"
v1.3.1-linux,then check if there is terminal state wrapped inside
v1.3.1-linux,"If index > history_length, take from a slice"
v1.3.1-linux,Metrics accumulator
v1.3.1-linux,Action Value model (used by agent to interact with the environment)
v1.3.1-linux,"Target model used to compute the target Q-values in training, updated"
v1.3.1-linux,less frequently for increased stability.
v1.3.1-linux,Function computing Q-values targets as part of the computation graph
v1.3.1-linux,"Define the loss, using Huber Loss (more robust to outliers)"
v1.3.1-linux,Compute the q_targets
v1.3.1-linux,actions is a 1-hot encoding of the action done by the agent
v1.3.1-linux,Define training criterion as the Huber Loss function
v1.3.1-linux,Adam based SGD
v1.3.1-linux,self._trainer.restore_from_checkpoint('models/oldmodels/model800000')
v1.3.1-linux,Append the state to the short term memory (ie. History)
v1.3.1-linux,"If policy requires agent to explore, sample random action"
v1.3.1-linux,Use the network to output the best action
v1.3.1-linux,Append batch axis with only one sample to evaluate
v1.3.1-linux,Return the value maximizing the expected reward
v1.3.1-linux,Keep track of interval action counter
v1.3.1-linux,"If done, reset short term memory (ie. History)"
v1.3.1-linux,Plot the metrics through Tensorboard and reset buffers
v1.3.1-linux,Reset the short term memory
v1.3.1-linux,Append to long term memory
v1.3.1-linux,Update the Target Network if needed
v1.3.1-linux,print(dist)
v1.3.1-linux,Make RL agent
v1.3.1-linux,Train
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,get state of the car
v1.3.1-linux,go forward
v1.3.1-linux,Go forward + steer right
v1.3.1-linux,go reverse
v1.3.1-linux,apply brakes
v1.3.1-linux,get camera images from the car
v1.3.1-linux,restore to original state
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,go forward
v1.3.1-linux,Python client example to get Lidar data from a car
v1.3.1-linux,
v1.3.1-linux,Makes the drone fly and get Lidar data
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,"print(""state: %s"" % s)"
v1.3.1-linux,go forward
v1.3.1-linux,Go forward + steer right
v1.3.1-linux,"reshape array of floats to array of [X,Y,Z]"
v1.3.1-linux,TODO
v1.3.1-linux,main
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,get state of the car
v1.3.1-linux,go forward
v1.3.1-linux,Go forward + steer right
v1.3.1-linux,go reverse
v1.3.1-linux,apply breaks
v1.3.1-linux,restore to original state
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,get camera images from the car
v1.3.1-linux,that's enough fun for now. let's quit cleanly
v1.3.1-linux,Import this module to automatically setup path to local airsim module
v1.3.1-linux,This module first tries to see if airsim module is installed via pip
v1.3.1-linux,If it does then we don't do anything else
v1.3.1-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.3.1-linux,and if it does then we add that in sys.path
v1.3.1-linux,this class simply tries to see if airsim
v1.3.1-linux,if airsim module is installed then don't do anything else
v1.3.1-linux,import pkgutil
v1.3.1-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.3.1-linux,if airsim_loader is not None:
v1.3.1-linux,return
v1.3.1-linux,Use below in settings.json with blocks environment
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,get state of the car
v1.3.1-linux,go forward
v1.3.1-linux,go reverse
v1.3.1-linux,apply breaks
v1.3.1-linux,get camera images from the car
v1.3.1-linux,restore to original state
v1.3.1-linux,from keras.models import load_model
v1.3.1-linux,if (len(sys.argv) != 2):
v1.3.1-linux,print('usage: python drive.py <modelName>')
v1.3.1-linux,sys.exit()
v1.3.1-linux,print('Loading model...')
v1.3.1-linux,model = load_model(sys.argv[1])
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.3.1-linux,"model_output = model.predict([image_buf, state_buf])"
v1.3.1-linux,car_controls.steering = float(model_output[0][0])
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,MultirotorClient.wait_key('Press any key to takeoff')
v1.3.1-linux,Local variable access is faster in loops
v1.3.1-linux,"if not wrapping over current pointer,"
v1.3.1-linux,then check if there is terminal state wrapped inside
v1.3.1-linux,"If index > history_length, take from a slice"
v1.3.1-linux,Metrics accumulator
v1.3.1-linux,Action Value model (used by agent to interact with the environment)
v1.3.1-linux,"Target model used to compute the target Q-values in training, updated"
v1.3.1-linux,less frequently for increased stability.
v1.3.1-linux,Function computing Q-values targets as part of the computation graph
v1.3.1-linux,"Define the loss, using Huber Loss (more robust to outliers)"
v1.3.1-linux,Compute the q_targets
v1.3.1-linux,actions is a 1-hot encoding of the action done by the agent
v1.3.1-linux,Define training criterion as the Huber Loss function
v1.3.1-linux,Adam based SGD
v1.3.1-linux,Append the state to the short term memory (ie. History)
v1.3.1-linux,"If policy requires agent to explore, sample random action"
v1.3.1-linux,Use the network to output the best action
v1.3.1-linux,Append batch axis with only one sample to evaluate
v1.3.1-linux,Return the value maximizing the expected reward
v1.3.1-linux,Keep track of interval action counter
v1.3.1-linux,"If done, reset short term memory (ie. History)"
v1.3.1-linux,Plot the metrics through Tensorboard and reset buffers
v1.3.1-linux,Reset the short term memory
v1.3.1-linux,Append to long term memory
v1.3.1-linux,Update the Target Network if needed
v1.3.1-linux,print(dist)
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,Make RL agent
v1.3.1-linux,Train
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,get camera images from the car
v1.3.1-linux,that's enough fun for now. let's quit cleanly
v1.3.1-linux,teleport the drone + 10 meters in x-direction
v1.3.1-linux,teleport the drone back
v1.3.1-linux,use open cv to create point cloud from depth image.
v1.3.1-linux,###########################################
v1.3.1-linux,######### This is work in progress! #######
v1.3.1-linux,###########################################
v1.3.1-linux,file will be saved in PythonClient folder (i.e. same folder as script)
v1.3.1-linux,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.3.1-linux,skip it
v1.3.1-linux,AirSim uses NED coordinates so negative axis is up.
v1.3.1-linux,z of -7 is 7 meters above the original launch point.
v1.3.1-linux,Fly given velocity vector for 5 seconds
v1.3.1-linux,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.3.1-linux,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.3.1-linux,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.3.1-linux,Make the drone fly in a circle.
v1.3.1-linux,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.3.1-linux,check that our home position is stable
v1.3.1-linux,AirSim uses NED coordinates so negative axis is up.
v1.3.1-linux,ramp up time
v1.3.1-linux,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.3.1-linux,compute current angle
v1.3.1-linux,compute lookahead
v1.3.1-linux,if we did the takeoff then also do the landing.
v1.3.1-linux,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.3.1-linux,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.3.1-linux,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.3.1-linux,ignore the click over from 360 back to 0
v1.3.1-linux,watch direction this diff is moving if it switches from shrinking to growing
v1.3.1-linux,then we passed the starting point.
v1.3.1-linux,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.3.1-linux,AirSim uses NED coordinates so negative axis is up.
v1.3.1-linux,z of -7 is 7 meters above the original launch point.
v1.3.1-linux,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.3.1-linux,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.3.1-linux,drone will over-shoot so we bring it back to the start point before landing.
v1.3.1-linux,change clock speed in settings.json
v1.3.1-linux,"""ClockSpeed"": 0.5"
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,that's enough fun for now. let's quit cleanly
v1.3.1-linux,In settings.json first activate computer vision mode:
v1.3.1-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.1-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.3.1-linux,pip install opencv-python
v1.3.1-linux,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.3.1-linux,Python client example to get Lidar data from a drone
v1.3.1-linux,
v1.3.1-linux,Makes the drone fly and get Lidar data
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,"print(""state: %s"" % s)"
v1.3.1-linux,"print(""state: %s"" % pprint.pformat(state))"
v1.3.1-linux,"reshape array of floats to array of [X,Y,Z]"
v1.3.1-linux,TODO
v1.3.1-linux,main
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,AirSim uses NED coordinates so negative axis is up.
v1.3.1-linux,let it settle there a bit.
v1.3.1-linux,after hovering we need to re-enabled api control for next leg of the trip
v1.3.1-linux,now compute the survey path required to fill the box
v1.3.1-linux,Use below in settings.json with Blocks environment
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,get camera images from the car
v1.3.1-linux,that's enough fun for now. let's quit cleanly
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,Import this module to automatically setup path to local airsim module
v1.3.1-linux,This module first tries to see if airsim module is installed via pip
v1.3.1-linux,If it does then we don't do anything else
v1.3.1-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.3.1-linux,and if it does then we add that in sys.path
v1.3.1-linux,this class simply tries to see if airsim
v1.3.1-linux,if airsim module is installed then don't do anything else
v1.3.1-linux,import pkgutil
v1.3.1-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.3.1-linux,if airsim_loader is not None:
v1.3.1-linux,return
v1.3.1-linux,"this script moves the drone to a location, then rests it thousands of time"
v1.3.1-linux,purpose of this script is to stress test reset API
v1.3.1-linux,connect to the AirSim simulator
v1.3.1-linux,that's enough fun for now. let's quite cleanly
v1.3.1-linux,use open cv to show new images from AirSim
v1.3.1-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.3.1-linux,pip install opencv-python
v1.3.1-linux,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.3.1-linux,get depth image
v1.3.1-linux,"this will return png width= 256, height= 144"
v1.3.1-linux,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.3.1-linux,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.3.1-linux,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.3.1-linux,to get an estimate of distance.
v1.3.1-linux,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.3.1-linux,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.3.1-linux,an angular delta of the following pi/10.
v1.3.1-linux,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.3.1-linux,Remove alpha channel if exists
v1.3.1-linux,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.3.1-linux,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.3.1-linux,Flatten and yield as tuple
v1.3.1-linux,Initialize a resizable dataset to hold the output
v1.3.1-linux,Resize the dataset to accommodate the next chunk of rows
v1.3.1-linux,Create the next chunk
v1.3.1-linux,Increment the row count
v1.3.1-linux,Arguments
v1.3.1-linux,Returns
v1.3.1-linux,use composition of homographies
v1.3.1-linux,to generate final transform that needs to be applied
v1.3.1-linux,Arguments
v1.3.1-linux,Returns
v1.3.1-linux,Keeps under lock only the mechanism which advances
v1.3.1-linux,the indexing of each batch.
v1.3.1-linux,The transformation of images is not under thread lock
v1.3.1-linux,so it can be done in parallel
v1.3.1-linux,Trained model path
v1.3.1-linux,Connect to AirSim
v1.3.1-linux,Start driving
v1.3.1-linux,Initialize image buffer
v1.3.1-linux,Update throttle value according to steering angle
v1.3.1-linux,Prediction
v1.3.1-linux,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.3.1-linux,Print progress
v1.3.1-linux,Update next car state
v1.3.1-linux,Wait a bit between iterations
v1.3.1-linux,%matplotlib inline
v1.3.1-linux,chunk size for training batches
v1.3.1-linux,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.3.1-linux,Point this to the directory containing the raw data
v1.3.1-linux,Point this to the desired output directory for the cooked (.h5) data
v1.3.1-linux,Choose The folders to search for data under RAW_DATA_DIR
v1.3.1-linux,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.3.1-linux,data_folder.append('folder_name1')
v1.3.1-linux,data_folder.append('folder_name2')
v1.3.1-linux,...
v1.3.1-linux,Hyper-parameters
v1.3.1-linux,Activation functions
v1.3.1-linux,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.3.1-linux,<< The directory containing the cooked data from the previous step >>
v1.3.1-linux,<< The directory in which the model output will be placed >>
v1.3.1-linux,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.3.1-linux,Network definition
v1.3.1-linux,Import this module to automatically setup path to local airsim module
v1.3.1-linux,This module first tries to see if airsim module is installed via pip
v1.3.1-linux,If it does then we don't do anything else
v1.3.1-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.3.1-linux,and if it does then we add that in sys.path
v1.3.1-linux,this class simply tries to see if airsim
v1.3.1-linux,if airsim module is installed then don't do anything else
v1.3.1-linux,import pkgutil
v1.3.1-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.3.1-linux,if airsim_loader is not None:
v1.3.1-linux,return
v1.3.1-linux,DEY: I don't know why this was there.
v1.3.1-linux,-----------------------------------  Common vehicle APIs ---------------------------------------------
v1.3.1-linux,basic flight control
v1.3.1-linux,time-of-day control
v1.3.1-linux,weather
v1.3.1-linux,camera control
v1.3.1-linux,simGetImage returns compressed png in array of bytes
v1.3.1-linux,image_type uses one of the ImageType members
v1.3.1-linux,"todo: in future remove below, it's only for compatibility to pre v1.2"
v1.3.1-linux,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.3.1-linux,camera control
v1.3.1-linux,simGetImage returns compressed png in array of bytes
v1.3.1-linux,image_type uses one of the ImageType members
v1.3.1-linux,gets the static meshes in the unreal scene
v1.3.1-linux,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.3.1-linux,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.3.1-linux,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.3.1-linux,sensor APIs
v1.3.1-linux,Plotting APIs
v1.3.1-linux,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.3.1-linux,APIs for control
v1.3.1-linux,low-level control API
v1.3.1-linux,query vehicle state
v1.3.1-linux,-----------------------------------  Car APIs ---------------------------------------------
v1.3.1-linux,helper method for converting getOrientation to roll/pitch/yaw
v1.3.1-linux,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.3.1-linux,roll (x-axis rotation)
v1.3.1-linux,pitch (y-axis rotation)
v1.3.1-linux,yaw (z-axis rotation)
v1.3.1-linux,DEY: I don't know why this was there.
v1.3.1-linux,reverse the vertical line order and add null bytes at the start
v1.3.1-linux,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.3.1-linux,return cls(**msgpack.unpack(encoded))
v1.3.1-linux,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.3.1-linux,"in header only mode, control library is not available"
v1.3.1-linux,if using Unreal Build system then include precompiled header file first
v1.3.1-linux,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.3.1-linux,"Windows, OSX and Linux."
v1.3.1-linux,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.3.1-linux,Windows users can move the Documents folder to any location they want
v1.3.1-linux,SHGetFolderPath knows how to find it.
v1.3.1-linux,fall back in case SHGetFolderPath failed for some reason.
v1.3.1-linux,convert from std::path '/' to windows backslash.
v1.3.1-linux,make the current thread run with maximum priority.
v1.3.1-linux,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.3.1-linux,TODO: How to handle POSIX thread priorities on OSX?
v1.3.1-linux,setThreadName is a helper function that is useful when debugging because your threads
v1.3.1-linux,show up in the debugger with the name you set which makes it easier to find the threads
v1.3.1-linux,that you are interested in.
v1.3.1-linux,"unfortunately this is only available on Windows 10, and AirSim is not limited to that."
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.3.1-linux,
v1.3.1-linux,Treat all errors as failure conditions.
v1.3.1-linux,parse command line
v1.3.1-linux,"motive gives a weird error if the project is not found, so we look for it."
v1.3.1-linux,Do an update to pick up any recently-arrived cameras.
v1.3.1-linux,List all detected cameras.
v1.3.1-linux,List all defined rigid bodies.
v1.3.1-linux,throttle to 50 messages per second.
v1.3.1-linux,OptiTrack uses 'y' axis for vertical.
v1.3.1-linux,stdafx.cpp : source file that includes just the standard includes
v1.3.1-linux,MavlinkMoCap.pch will be the pre-compiled header
v1.3.1-linux,stdafx.obj will contain the pre-compiled type information
v1.3.1-linux,TODO: reference any additional headers you need in STDAFX.H
v1.3.1-linux,and not in this file
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,PX4.cpp : Defines the entry point for the console application.
v1.3.1-linux,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.3.1-linux,how do you write to the debug output windows on Unix ?
v1.3.1-linux,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.3.1-linux,connection to create to talke to that server.
v1.3.1-linux,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.3.1-linux,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.3.1-linux,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.3.1-linux,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.3.1-linux,using their the -qgc option.
v1.3.1-linux,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.3.1-linux,this switch controls whether we turn off the RC remote active link loss detection
v1.3.1-linux,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.3.1-linux,from kicking in when you try and fly.
v1.3.1-linux,parse the json
v1.3.1-linux,flatten inner mavlink object
v1.3.1-linux,flatten inner mavlink object
v1.3.1-linux,todo
v1.3.1-linux,todo
v1.3.1-linux,"const char* outLogFileOption = ""outlogfile"";"
v1.3.1-linux,parse command line
v1.3.1-linux,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.3.1-linux,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.3.1-linux,"no local serial connection, so this is the primary droneConnection."
v1.3.1-linux,failed to connect
v1.3.1-linux,"local connection, then we own sending the heartbeat."
v1.3.1-linux,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.3.1-linux,cmdTable.push_back(new AltHoldCommand());
v1.3.1-linux,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.3.1-linux,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.3.1-linux,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.3.1-linux,this stops us from being able to connect to SITL mode PX4.
v1.3.1-linux,checkPulse();
v1.3.1-linux,add command text in log
v1.3.1-linux,close previous command.
v1.3.1-linux,FilterLogFiles(logDirectory);
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,send a heartbeat
v1.3.1-linux,accept one incoming connection
v1.3.1-linux,send a heartbeat to the client
v1.3.1-linux,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.3.1-linux,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.3.1-linux,for this unit test we are expecting a request to send an image.
v1.3.1-linux,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.3.1-linux,hmmm
v1.3.1-linux,================ ls
v1.3.1-linux,================ put file
v1.3.1-linux,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.3.1-linux,================ get file
v1.3.1-linux,verify the file contents.
v1.3.1-linux,================ remove file
v1.3.1-linux,================ make directory
v1.3.1-linux,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.3.1-linux,================ remove directory
v1.3.1-linux,Now verification
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,you must call this method if you want HandleMessage to be called subsequently.
v1.3.1-linux,treat literals as one word
v1.3.1-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.3.1-linux,request gps info
v1.3.1-linux,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.3.1-linux,find relative position since command start so we can compare two commands better
v1.3.1-linux,"these PID values are important, so set these to match"
v1.3.1-linux,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.3.1-linux,we can skip ahead.
v1.3.1-linux,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.3.1-linux,TODO: avoid passing hadcoded HIL flag
v1.3.1-linux,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.3.1-linux,"The global position, as returned by the Global Positioning System (GPS)."
v1.3.1-linux,Provides state for additional features
v1.3.1-linux,The general system state
v1.3.1-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.3.1-linux,Provides state for additional features
v1.3.1-linux,The general system state
v1.3.1-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.3.1-linux,Provides state for additional features
v1.3.1-linux,The general system state
v1.3.1-linux,Provides state for additional features
v1.3.1-linux,The general system state
v1.3.1-linux,note: we do not reset com when Close() is called because we want to keep running.
v1.3.1-linux,"user has to invoke ""hil stop"" to stop the hil thread."
v1.3.1-linux,generate random between 0 and 1
v1.3.1-linux,move to range -1 to 1
v1.3.1-linux,scale it
v1.3.1-linux,apply iy
v1.3.1-linux,wait for the Execute method to be called.
v1.3.1-linux,gps is much slower frequency than IMU.
v1.3.1-linux,MAVLINK_MSG_ID_HIL_GPS
v1.3.1-linux,disable MAV_USEHILGPS
v1.3.1-linux,note: we do not reset com when Close() is called because we want to keep running.
v1.3.1-linux,"user has to invoke ""hil stop"" to stop the hil thread."
v1.3.1-linux,generate random between 0 and 1
v1.3.1-linux,move to range -1 to 1
v1.3.1-linux,scale it
v1.3.1-linux,apply iy
v1.3.1-linux,wait for the Execute method to be called.
v1.3.1-linux,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.3.1-linux,gps is much slower frequency than IMU.
v1.3.1-linux,MAVLINK_MSG_ID_HIL_GPS
v1.3.1-linux,disable HIL mode
v1.3.1-linux,Enumeration of landed detector states
v1.3.1-linux,MAV landed state is unknown
v1.3.1-linux,MAV is landed (on ground)
v1.3.1-linux,MAV is in air
v1.3.1-linux,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.3.1-linux,The filtered local position
v1.3.1-linux,must send these regularly to keep offboard control.
v1.3.1-linux,"ok, now we can safely switch to loiter."
v1.3.1-linux,must send these regularly to keep offboard control.
v1.3.1-linux,integrate the heading so it is smoother.
v1.3.1-linux,must send these regularly to keep offboard control.
v1.3.1-linux,integrate the heading so it is smoother.
v1.3.1-linux,fly to radius
v1.3.1-linux,it takes about 10 cm to stop and turn.
v1.3.1-linux,next time around switch to orbiting!
v1.3.1-linux,heading points to center of circle.
v1.3.1-linux,interpoloate the speed ramp up time over 2 seconds from start time
v1.3.1-linux,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.3.1-linux,monitor the sin curves so we can see how on track or off track it actually is.
v1.3.1-linux,the shape of the curve will also tell us if we are progressing at a consistent
v1.3.1-linux,"speed, the more deformed the sin curve the worse our progress."
v1.3.1-linux,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.3.1-linux,degrees just flipped from 359 to 0.
v1.3.1-linux,this enables us to test what happens when offboard control is lost and resumed.
v1.3.1-linux,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.3.1-linux,"ok, now we can start moving by velocity"
v1.3.1-linux,recompute to new target.
v1.3.1-linux,start by moving right with 10 degree roll.
v1.3.1-linux,haven't started yet.
v1.3.1-linux,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.3.1-linux,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.3.1-linux,track how our actual pitch is coming along compared to our target
v1.3.1-linux,and check position
v1.3.1-linux,the amount of pitch should depend on our speed in that direction.
v1.3.1-linux,passed the midpoint.
v1.3.1-linux,fade out the pitch as we pick up speed so we don't overshoot.
v1.3.1-linux,see if we just crossed the wiggle distance threshold.
v1.3.1-linux,(pitch affects the x-position).
v1.3.1-linux,reverse direction with a -30 degrees quick stop
v1.3.1-linux,reverse direction with a 30 degrees quick stop
v1.3.1-linux,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.3.1-linux,too much in that direction.
v1.3.1-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.3.1-linux,track how our actual roll is coming along compared to our target
v1.3.1-linux,and check position
v1.3.1-linux,the amount of roll should depend on our speed in that direction.
v1.3.1-linux,passed the midpoint.
v1.3.1-linux,fade out the roll as we pick up speed so we don't overshoot.
v1.3.1-linux,see if we just crossed the wiggle distance threshold.
v1.3.1-linux,(roll affects the y-position).
v1.3.1-linux,reverse direction with a -30 degrees quick stop
v1.3.1-linux,reverse direction with a 30 degrees quick stop
v1.3.1-linux,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.3.1-linux,too much in that direction.
v1.3.1-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.3.1-linux,for testing PID controller.
v1.3.1-linux,class AltHoldCommand : public Command
v1.3.1-linux,{
v1.3.1-linux,std::shared_ptr<MavLinkVehicle> channel;
v1.3.1-linux,"float sx_, sy_, sz_;"
v1.3.1-linux,MavLinkAttitudeTarget _current;
v1.3.1-linux,PidController thrust_controller_;
v1.3.1-linux,public:
v1.3.1-linux,this->sz_ = pos.z; // user defined target.
v1.3.1-linux,move to local position keeps the offboard control happy.
v1.3.1-linux,haven't started yet.
v1.3.1-linux,and check position
v1.3.1-linux,double dx = this->sx_ - pos.x;
v1.3.1-linux,double dy = this->sy_ - pos.y;
v1.3.1-linux,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.3.1-linux,too much in that direction.
v1.3.1-linux,adjust thrust so we keep steady height target
v1.3.1-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.3.1-linux,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.3.1-linux,local remote
v1.3.1-linux,already handled by the parse method.
v1.3.1-linux,we only support very simple patterns for now.
v1.3.1-linux,each wildcard must be separated by literal.
v1.3.1-linux,back to back wildcards with no literal in between is too complex.
v1.3.1-linux,"we only support simple matching for now, we can add full regex later if we need it."
v1.3.1-linux,yep!
v1.3.1-linux,'*' is done we found the next matching char
v1.3.1-linux,this is ok.
v1.3.1-linux,this is an ERASE_END_LINE command which we ignore.
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,unpack the message...
v1.3.1-linux,pack the payload buffer.
v1.3.1-linux,"json can't handle ""nan"", so we convert it to null."
v1.3.1-linux,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.3.1-linux,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,start listening to this connection
v1.3.1-linux,Send heartbeat to drone.  You should not do this if some other node is
v1.3.1-linux,already doing it.
v1.3.1-linux,stop listening to the connection.
v1.3.1-linux,get the connection
v1.3.1-linux,Get the local system and component id
v1.3.1-linux,send a command to the remote node
v1.3.1-linux,MavLinkNode::MavLinkNode() = default;
v1.3.1-linux,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.3.1-linux,decrementing the count so the next WaitOne may block.
v1.3.1-linux,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.3.1-linux,convert to absolute time.
v1.3.1-linux,use mach_timespec
v1.3.1-linux,convert to absolute time.
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,return true if we still have offboard control (can lose this if user flips the switch).
v1.3.1-linux,MavLinkVehicle::MavLinkVehicle() = default;
v1.3.1-linux,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.3.1-linux,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,============================== CLIENT ============================================
v1.3.1-linux,image APIs
v1.3.1-linux,or if you are implementing the client side call this function to get the most recent frame.
v1.3.1-linux,returns false if there is no new frame available.
v1.3.1-linux,============================== SERVER ============================================
v1.3.1-linux,call this to send the image back over the connection given to start function.
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,"log every message that is ""sent"" using sendMessage."
v1.3.1-linux,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.3.1-linux,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.3.1-linux,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.3.1-linux,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,for compatibility with QGroundControl we have to save the time field in big endian.
v1.3.1-linux,todo: mavlink2 support?
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,start listening to this connection
v1.3.1-linux,Send heartbeat to drone.  You should not do this if some other node is
v1.3.1-linux,already doing it.
v1.3.1-linux,this is called for all messages received on the connection.
v1.3.1-linux,"we received a heartbeat, so let's get the capabilities."
v1.3.1-linux,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.3.1-linux,subclasses remembering to call this base implementation.
v1.3.1-linux,stop listening to the connection.
v1.3.1-linux,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.3.1-linux,wait for a heartbeat msg since this will give us the port to send commands to...
v1.3.1-linux,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.3.1-linux,send a heart beat so that the remote node knows we are still alive
v1.3.1-linux,(otherwise drone will trigger a failsafe operation).
v1.3.1-linux,ignore any failures here because we are running in our own thread here.
v1.3.1-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.1-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.1-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.1-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.1-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.1-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.1-linux,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.3.1-linux,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.3.1-linux,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.3.1-linux,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.3.1-linux,"ok, now fetch the missing parameters."
v1.3.1-linux,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.3.1-linux,silently fail since we are on a background thread here...
v1.3.1-linux,tell the caller this is complete.
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,add our custom telemetry message length.
v1.3.1-linux,todo: if we support signing then initialize
v1.3.1-linux,mavlink_intermediate_status_.signing callbacks
v1.3.1-linux,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.3.1-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.3.1-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.3.1-linux,send this right away just in case serial link is not already configured
v1.3.1-linux,"log every message that is ""sent"" using sendMessage."
v1.3.1-linux,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.3.1-linux,pack the payload buffer.
v1.3.1-linux,calculate checksum
v1.3.1-linux,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.3.1-linux,are variable length as a result.
v1.3.1-linux,form the header as a byte array for the crc
v1.3.1-linux,these macros use old style cast.
v1.3.1-linux,forward messages from our connected node to the remote proxy.
v1.3.1-linux,tell the remote connection to expect mavlink2 messages.
v1.3.1-linux,forward messages from remote proxy to local connected node
v1.3.1-linux,CurrentThread::setMaximumPriority();
v1.3.1-linux,"hmmm, wait till it is opened?"
v1.3.1-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.3.1-linux,pick up the sysid/compid of the remote node we are connected to.
v1.3.1-linux,then this is a mavlink 1 message
v1.3.1-linux,then this mavlink sender supports mavlink 2
v1.3.1-linux,queue event for publishing.
v1.3.1-linux,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.3.1-linux,as it ensures we don't lose messages if the listener is slow.
v1.3.1-linux,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.3.1-linux,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.3.1-linux,we would get a deadlock.
v1.3.1-linux,CurrentThread::setMaximumPriority();
v1.3.1-linux,reset counters
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,------------------------------------------------------------------------------
v1.3.1-linux,Defines
v1.3.1-linux,------------------------------------------------------------------------------
v1.3.1-linux,bit number  876543210987654321
v1.3.1-linux,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.3.1-linux,in future it would be good to have ability to add system IDs we are interested in
v1.3.1-linux,if (msg.sysid != getTargetSystemId())
v1.3.1-linux,{
v1.3.1-linux,// we only care about messages from our intended remote node.
v1.3.1-linux,return;
v1.3.1-linux,}
v1.3.1-linux,user may have changed modes on us! So we need to honor that and not
v1.3.1-linux,try and take it back.
v1.3.1-linux,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.3.1-linux,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.3.1-linux,we can store up to 16 channels in rc_channels_scaled.
v1.3.1-linux,The RAW values of the servo outputs
v1.3.1-linux,Metrics typically displayed on a HUD for fixed wing aircraft
v1.3.1-linux,The IMU readings in SI units in NED body frame
v1.3.1-linux,printSystemStatus(&msg);
v1.3.1-linux,todo: use this to determine when we need to do emergency landing...
v1.3.1-linux,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.3.1-linux,Provides state for additional features
v1.3.1-linux,The general system state
v1.3.1-linux,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.3.1-linux,but we do want to know when we get the ack.  So this is async ACK processing!
v1.3.1-linux,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.3.1-linux,if threshold < 0 then the threshold is inverted.
v1.3.1-linux,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.3.1-linux,Convert it to a floating point number between -1 and 1.
v1.3.1-linux,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.3.1-linux,until the move commands start happening.
v1.3.1-linux,return true if user calls requestControl and has not called releaseControl.
v1.3.1-linux,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.3.1-linux,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.3.1-linux,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.3.1-linux,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.3.1-linux,send a few to make sure it gets through...
v1.3.1-linux,now the command should succeed.
v1.3.1-linux,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.3.1-linux,us by which time the PX4 times out offboard mode!!
v1.3.1-linux,this mode change take precedence over offboard mode.
v1.3.1-linux,thrust must be between -1 and 1.
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,These definitions are copied from PX4 implementation
v1.3.1-linux,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.3.1-linux,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.3.1-linux,/ @brief Command opcodes
v1.3.1-linux,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.3.1-linux,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.3.1-linux,must trim trailing slashes so PX4 doesn't hang!
v1.3.1-linux,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.3.1-linux,from the source.
v1.3.1-linux,check if directory exists.
v1.3.1-linux,perfect.
v1.3.1-linux,use last_message_ so we preserve the sessionid.
v1.3.1-linux,"could not create the local file, so stop."
v1.3.1-linux,must use last_message_ so we preserve the session id.
v1.3.1-linux,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.3.1-linux,todo: error handling here? sequence is out of order...
v1.3.1-linux,"directory must be empty then, can't do nextStep because"
v1.3.1-linux,it will just loop for ever re-requesting zero offset into
v1.3.1-linux,empty directory.
v1.3.1-linux,result should be a list of null terminated file names.
v1.3.1-linux,skipping this entry
v1.3.1-linux,remove the file size field.
v1.3.1-linux,"printf(""%s\n"", name.c_str());"
v1.3.1-linux,request the next batch.
v1.3.1-linux,"perhaps this was a late response after we did a retry, so ignore it."
v1.3.1-linux,"perhaps this was a late response after we did a retry, so ignore it."
v1.3.1-linux,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.3.1-linux,reached the end of the list or the file.
v1.3.1-linux,end of file or directory listing.
v1.3.1-linux,"success, data should be following..."
v1.3.1-linux,ack on this cmd is a noop
v1.3.1-linux,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.3.1-linux,give up then.
v1.3.1-linux,tell watchdog we are sending a request
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,================================= CLIENT ==============================================================
v1.3.1-linux,Check if we have a valid transaction
v1.3.1-linux,emit signal if all packets arrived
v1.3.1-linux,Restart statemachine
v1.3.1-linux,image APIs
v1.3.1-linux,================================= SERVER ==============================================================
v1.3.1-linux,Prepare and send acknowledgment packet
v1.3.1-linux,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.3.1-linux,Send ENCAPSULATED_IMAGE packet
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.3.1-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.3.1-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.3.1-linux,send this right away just in case serial link is not already configured
v1.3.1-linux,CurrentThread::setMaximumPriority();
v1.3.1-linux,"hmmm, wait till it is opened?"
v1.3.1-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.3.1-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.3.1-linux,queue event for publishing.
v1.3.1-linux,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.3.1-linux,as it ensures we don't lose messages if the listener is slow.
v1.3.1-linux,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.3.1-linux,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.3.1-linux,we would get a deadlock.
v1.3.1-linux,CurrentThread::setMaximumPriority();
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.3.1-linux,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.3.1-linux,parse out the VID number
v1.3.1-linux,now the PID
v1.3.1-linux,parse out the VID number
v1.3.1-linux,examples:
v1.3.1-linux,PX4: USB\VID_26AC&PID_0011\0
v1.3.1-linux,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.3.1-linux,"printf(""Found: %S\n"", buffer.c_str());"
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.3.1-linux,parse out the VID number
v1.3.1-linux,now the PID
v1.3.1-linux,parse out the VID number
v1.3.1-linux,suppress
v1.3.1-linux,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,This has not been properly tested
v1.3.1-linux,struct iw_statistics stats;
v1.3.1-linux,struct iwreq req;
v1.3.1-linux,"memset(&stats, 0, sizeof(stats));"
v1.3.1-linux,"memset(&req, 0, sizeof(iwreq));"
v1.3.1-linux,
v1.3.1-linux,"strncpy(req.ifr_name, ifaceName, 16);"
v1.3.1-linux,req.u.data.pointer = &stats;
v1.3.1-linux,req.u.data.length = sizeof(iw_statistics);
v1.3.1-linux,
v1.3.1-linux,#ifdef CLEAR_UPDATED
v1.3.1-linux,req.u.data.flags = 1;
v1.3.1-linux,#endif
v1.3.1-linux,
v1.3.1-linux,/* Perform the ioctl */
v1.3.1-linux,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.3.1-linux,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.3.1-linux,return -127;
v1.3.1-linux,}
v1.3.1-linux,
v1.3.1-linux,return stats.qual.level;
v1.3.1-linux,todo: windows version of this...
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,windows
v1.3.1-linux,Need to link with Ws2_32.lib
v1.3.1-linux,posix
v1.3.1-linux,found it!
v1.3.1-linux,bind socket to local address.
v1.3.1-linux,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.3.1-linux,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.3.1-linux,write to the serial port
v1.3.1-linux,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.3.1-linux,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.3.1-linux,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.3.1-linux,"try and receive something, up until port is closed anyway."
v1.3.1-linux,"message was too large for the buffer, no problem, return what we have."
v1.3.1-linux,try again - this can happen if server recreates the socket on their side.
v1.3.1-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.3.1-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.3.1-linux,"printf(""#### recv failed with error: %d\n"", hr);"
v1.3.1-linux,we now have it.
v1.3.1-linux,this is from someone we are not interested in.
v1.3.1-linux,-----------------------------------------------------------------------------------------
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,Initialize Winsock
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,windows
v1.3.1-linux,Need to link with Ws2_32.lib
v1.3.1-linux,posix
v1.3.1-linux,found it!
v1.3.1-linux,bind socket to local address.
v1.3.1-linux,bind socket to local address.
v1.3.1-linux,start listening for incoming connection
v1.3.1-linux,accept 1
v1.3.1-linux,"don't need to accept any more, so we can close this one."
v1.3.1-linux,write to the serial port
v1.3.1-linux,"try and receive something, up until port is closed anyway."
v1.3.1-linux,"message was too large for the buffer, no problem, return what we have."
v1.3.1-linux,try again - this can happen if server recreates the socket on their side.
v1.3.1-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.3.1-linux,try again - this can happen if server recreates the socket on their side.
v1.3.1-linux,-----------------------------------------------------------------------------------------
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.3.1-linux,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.3.1-linux,set signal
v1.3.1-linux,Clear Handshake flags
v1.3.1-linux,Set Handshake flags
v1.3.1-linux,return GetLastError();
v1.3.1-linux,return GetLastError();
v1.3.1-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.3.1-linux,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.3.1-linux,enable reading
v1.3.1-linux,posix doesn't have mark/space parity.
v1.3.1-linux,posix doesn't have mark/space parity.
v1.3.1-linux,this is the default.
v1.3.1-linux,not sure this is supported...
v1.3.1-linux,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.3.1-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.3.1-linux,First do those specified by POSIX.
v1.3.1-linux,Now conditionally handle a bunch of extended rates.
v1.3.1-linux,First do those specified by POSIX.
v1.3.1-linux,Now conditionally handle a bunch of extended rates.
v1.3.1-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.3.1-linux,import airsim
v1.3.1-linux,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v1.3.1-linux,self.args = args
v1.3.1-linux,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v1.3.1-linux,pdb.set_trace()
v1.3.1-linux,#include <pluginlib/class_list_macros.h>
v1.3.1-linux,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v1.3.1-linux,intitialize placeholder control commands
v1.3.1-linux,vel_cmd_ = VelCmd();
v1.3.1-linux,gimbal_cmd_ = GimbalCmd();
v1.3.1-linux,todo do not reset if already in air?
v1.3.1-linux,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.3.1-linux,ros params
v1.3.1-linux,todo enforce dynamics constraints in this node as well?
v1.3.1-linux,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v1.3.1-linux,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v1.3.1-linux,XmlRpc::XmlRpcValue can't be const in this case
v1.3.1-linux,subscribe to control commands on global nodehandle
v1.3.1-linux,vehicle_setting_vec_.clear();
v1.3.1-linux,vehicle_imu_map_;
v1.3.1-linux,callback_queues_.clear();
v1.3.1-linux,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.3.1-linux,auto vehicle_setting_local = vehicle_setting.get();
v1.3.1-linux,bind to a single callback. todo optimal subs queue length
v1.3.1-linux,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.3.1-linux,"multirotor_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.3.1-linux,"iterate over camera map std::map<std::string, CameraSetting> cameras;"
v1.3.1-linux,vehicle_setting_vec_.push_back(*vehicle_setting.get());
v1.3.1-linux,camera_setting.gimbal
v1.3.1-linux,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.3.1-linux,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.3.1-linux,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.3.1-linux,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.3.1-linux,"if {DepthPlanner, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.3.1-linux,"push back pair (vector of image captures, current vehicle name)"
v1.3.1-linux,"iterate over sensors std::map<std::string, std::unique_ptr<SensorSetting>> sensors;"
v1.3.1-linux,"todo this is pretty non scalable, refactor airsim and ros api and maintain a vehicle <-> sensor (setting) map"
v1.3.1-linux,add takeoff and land all services if more than 2 drones
v1.3.1-linux,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v1.3.1-linux,todo add per vehicle reset in AirLib API
v1.3.1-linux,todo mimic gazebo's /use_sim_time feature which publishes airsim's clock time..via an rpc call?!
v1.3.1-linux,"clock_pub_ = nh_private_.advertise<rosgraph_msgs::Clock>(""clock"", 10);"
v1.3.1-linux,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.3.1-linux,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v1.3.1-linux,"todo: error check. if state is not landed, return error."
v1.3.1-linux,response.success =
v1.3.1-linux,response.success =
v1.3.1-linux,response.success =
v1.3.1-linux,response.success =
v1.3.1-linux,response.success =
v1.3.1-linux,response.success =
v1.3.1-linux,todo add reset by vehicle_name API to airlib
v1.3.1-linux,todo not async remove waitonlasttask
v1.3.1-linux,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v1.3.1-linux,todo do actual body frame?
v1.3.1-linux,airsim uses degrees
v1.3.1-linux,todo do actual body frame?
v1.3.1-linux,airsim uses degrees
v1.3.1-linux,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v1.3.1-linux,todo expose waitOnLastTask or nah?
v1.3.1-linux,todo do actual body frame?
v1.3.1-linux,airsim uses degrees
v1.3.1-linux,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.3.1-linux,todo expose waitOnLastTask or nah?
v1.3.1-linux,todo support multiple gimbal commands
v1.3.1-linux,todo support multiple gimbal commands
v1.3.1-linux,1. find quaternion of default gimbal pose
v1.3.1-linux,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.3.1-linux,3. call airsim client's setcameraorientation which sets camera orientation wrt world (or takeoff?) ned frame. todo
v1.3.1-linux,odom_ned_msg.header.frame_id = world_frame_id_;
v1.3.1-linux,"odom_ned_msg.child_frame_id = ""/airsim/odom_local_ned""; // todo make param"
v1.3.1-linux,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.3.1-linux,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.3.1-linux,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.3.1-linux,msg = []
v1.3.1-linux,todo covariances
v1.3.1-linux,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.3.1-linux,todo radians per second
v1.3.1-linux,meters/s2^m
v1.3.1-linux,imu_msg.orientation_covariance = ;
v1.3.1-linux,imu_msg.angular_velocity_covariance = ;
v1.3.1-linux,imu_msg.linear_acceleration_covariance = ;
v1.3.1-linux,todo unused
v1.3.1-linux,void AirsimROSWrapper::set_zero_vel_cmd()
v1.3.1-linux,{
v1.3.1-linux,vel_cmd_.x = 0.0;
v1.3.1-linux,vel_cmd_.y = 0.0;
v1.3.1-linux,vel_cmd_.z = 0.0;
v1.3.1-linux,vel_cmd_.drivetrain = msr::airlib::DrivetrainType::MaxDegreeOfFreedom;
v1.3.1-linux,vel_cmd_.yaw_mode.is_rate = false;
v1.3.1-linux,// todo make class member or a fucntion
v1.3.1-linux,"double roll, pitch, yaw;"
v1.3.1-linux,"tf2::Matrix3x3(get_tf2_quat(curr_drone_state_.kinematics_estimated.pose.orientation)).getRPY(roll, pitch, yaw); // ros uses xyzw"
v1.3.1-linux,vel_cmd_.yaw_mode.yaw_or_rate = yaw;
v1.3.1-linux,}
v1.3.1-linux,todo this is global origin
v1.3.1-linux,iterate over drones
v1.3.1-linux,get drone state from airsim
v1.3.1-linux,convert airsim drone state to ROS msgs
v1.3.1-linux,publish to ROS!
v1.3.1-linux,send control commands from the last callback to airsim
v1.3.1-linux,"""clear"" control cmds"
v1.3.1-linux,IMUS
v1.3.1-linux,imu_msg.header.stamp = ros::Time::now();
v1.3.1-linux,"we've sent these static transforms, so no need to keep sending them"
v1.3.1-linux,todo add and expose a gimbal angular velocity to airlib
v1.3.1-linux,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.3.1-linux,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.3.1-linux,std::lock_guard<std::recursive_mutex> guard(drone_control_mutex_);
v1.3.1-linux,std::lock_guard<std::recursive_mutex> guard(lidar_mutex_);
v1.3.1-linux,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.3.1-linux,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.3.1-linux,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.3.1-linux,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.3.1-linux,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.3.1-linux,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.3.1-linux,"if a render request failed for whatever reason, this img will be empty."
v1.3.1-linux,Attempting to use a make_ts(0) results in ros::Duration runtime error.
v1.3.1-linux,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.3.1-linux,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.3.1-linux,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.3.1-linux,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.3.1-linux,update timestamp of saved cam info msgs
v1.3.1-linux,DepthPlanner / DepthPerspective / DepthVis / DisparityNormalized
v1.3.1-linux,Scene / Segmentation / SurfaceNormals / Infrared
v1.3.1-linux,publish camera transforms
v1.3.1-linux,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.3.1-linux,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.3.1-linux,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.3.1-linux,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.3.1-linux,ROS params
v1.3.1-linux,ROS publishers
v1.3.1-linux,ROS subscribers
v1.3.1-linux,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.3.1-linux,ROS timers
v1.3.1-linux,todo maintain internal representation as eigen vec?
v1.3.1-linux,todo check if low velocity if within thresh?
v1.3.1-linux,todo maintain separate errors for XY and Z
v1.3.1-linux,todo save this in degrees somewhere to avoid repeated conversion
v1.3.1-linux,this tells the update timer callback to not do active hovering
v1.3.1-linux,todo maintain array of position goals
v1.3.1-linux,todo error checks
v1.3.1-linux,todo fill response
v1.3.1-linux,this tells the update timer callback to not do active hovering
v1.3.1-linux,todo error checks
v1.3.1-linux,todo fill response
v1.3.1-linux,"todo do relative altitude, or add an option for the same?"
v1.3.1-linux,convert GPS goal to NED goal
v1.3.1-linux,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.3.1-linux,todo error checks
v1.3.1-linux,todo fill response
v1.3.1-linux,"todo do relative altitude, or add an option for the same?"
v1.3.1-linux,convert GPS goal to NED goal
v1.3.1-linux,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.3.1-linux,todo error checks
v1.3.1-linux,todo fill response
v1.3.1-linux,todo check if odometry is too old!!
v1.3.1-linux,"if no odom, don't do anything."
v1.3.1-linux,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.3.1-linux,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.3.1-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.3.1-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.3.1-linux,todo yaw limits
v1.3.1-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.3.1-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.3.1-linux,check if path exists
v1.3.1-linux,todo airsim's simhud.cpp does error checking here
v1.3.1-linux,mimics void ASimHUD::initializeSettings()
v1.3.1-linux,not sure where settings_json initialized in AirSimSettings::initializeSettings() is actually used
v1.3.1-linux,int num_threads = 1;
v1.3.1-linux,ros::MultiThreadedSpinner multi_thread(num_threads);
v1.3.1-linux,multi_thread.spin();
v1.3.1-linux,ros::AsyncSpinner async_spinner(num_threads);
v1.3.1-linux,async_spinner.start();
v1.3.1-linux,single threaded spinner
v1.3.1-linux,","
v1.3.1-linux,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.3.1-linux,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,"in header only mode, control library is not available"
v1.3.1-linux,TODO: something defines max macro which interfears with code here
v1.3.1-linux,is cur_pos within fence?
v1.3.1-linux,destination risk is not available then consider it zero
v1.3.1-linux,if dest risk is lower than its more safe
v1.3.1-linux,are we doing better than closest obstacle?
v1.3.1-linux,"if we stay where we are, what is the risk distance?"
v1.3.1-linux,else we are better of moving to dest
v1.3.1-linux,this function should work even when dest_pos == cur_pos
v1.3.1-linux,is this dest_pos cur_pos within the fence?
v1.3.1-linux,transform dest_pos vector to body frame
v1.3.1-linux,check for approx zero vectors to avoid random yaw angles
v1.3.1-linux,we are hovering
v1.3.1-linux,"get yaw in body frame, ie, front is always 0 radians"
v1.3.1-linux,yaw to ticks
v1.3.1-linux,get obstacles in the window at the tick direction around the window
v1.3.1-linux,less risk distance is better
v1.3.1-linux,check obstacles around current position and see if it has lower risk
v1.3.1-linux,else obstacle is too far
v1.3.1-linux,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.3.1-linux,look for each surrounding tick to see if we have obstacle free angle
v1.3.1-linux,else no suggestions required
v1.3.1-linux,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.3.1-linux,evaluate right and left side of circle
v1.3.1-linux,find right and left risk distances
v1.3.1-linux,at this point we have already determined hover is better than going to dest
v1.3.1-linux,we now determine is moving to suggested angle better than hovering?
v1.3.1-linux,check if dest_pos is safe
v1.3.1-linux,breaking distance at this velocity
v1.3.1-linux,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.3.1-linux,check if dest_pos is safe
v1.3.1-linux,float/vec parameters can have NaN which makes them optional
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,"in header only mode, control library is not available"
v1.3.1-linux,handles +/- tick and wraps around circle
v1.3.1-linux,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.3.1-linux,update the specified window on the map
v1.3.1-linux,make sure from <= to
v1.3.1-linux,normalize the ticks so both are valid indices
v1.3.1-linux,if from is still larger then
v1.3.1-linux,to ticks is then added one full circle to make it larger than from_tick
v1.3.1-linux,find closest obstacle in given window
v1.3.1-linux,search whole map to find closest obstacle
v1.3.1-linux,"in header only mode, control library is not available"
v1.3.1-linux,#include <fileapi.h>
v1.3.1-linux,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.3.1-linux,"Windows, OSX and Linux."
v1.3.1-linux,Windows users can move the Documents folder to any location they want
v1.3.1-linux,SHGetFolderPath knows how to find it.
v1.3.1-linux,fall back in case SHGetFolderPath failed for some reason.
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,"in header only mode, control library is not available"
v1.3.1-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.1-linux,if using Unreal Build system then include precompiled header file first
v1.3.1-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.1-linux,this deadlocks UI thread if async_run was called while there are pending rpc calls.
v1.3.1-linux,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.3.1-linux,Exit if already resetting.
v1.3.1-linux,Reset
v1.3.1-linux,if we don't suppress then server will bomb out for exceptions raised by any method
v1.3.1-linux,required for pimpl
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,"in header only mode, control library is not available"
v1.3.1-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.1-linux,if using Unreal Build system then include precompiled header file first
v1.3.1-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.1-linux,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.3.1-linux,make sure we can talk to the DroneServer
v1.3.1-linux,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.3.1-linux,command_context.client.ping();
v1.3.1-linux,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.3.1-linux,sim only
v1.3.1-linux,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.3.1-linux,return value of last task. It should be true if task completed without
v1.3.1-linux,cancellation or timeout
v1.3.1-linux,"should be implemented by derived class if it supports async task,"
v1.3.1-linux,for example using futures
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,"in header only mode, control library is not available"
v1.3.1-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.1-linux,if using Unreal Build system then include precompiled header file first
v1.3.1-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,"in header only mode, control library is not available"
v1.3.1-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.1-linux,if using Unreal Build system then include precompiled header file first
v1.3.1-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.1-linux,required for pimpl
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,"in header only mode, control library is not available"
v1.3.1-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.1-linux,if using Unreal Build system then include precompiled header file first
v1.3.1-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.1-linux,status getters
v1.3.1-linux,return value of last task. It should be true if task completed without
v1.3.1-linux,cancellation or timeout
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,"in header only mode, control library is not available"
v1.3.1-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.1-linux,if using Unreal Build system then include pre-compiled header file first
v1.3.1-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.1-linux,getters
v1.3.1-linux,required for pimpl
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,"in header only mode, control library is not available"
v1.3.1-linux,last command is to hold on to position
v1.3.1-linux,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.3.1-linux,after landing we detect if drone has stopped moving
v1.3.1-linux,validate path size
v1.3.1-linux,validate yaw mode
v1.3.1-linux,validate and set auto-lookahead value
v1.3.1-linux,if auto mode requested for lookahead then calculate based on velocity
v1.3.1-linux,add current position as starting point
v1.3.1-linux,append the input path and compute segments
v1.3.1-linux,add last segment as zero length segment so we have equal number of segments and points.
v1.3.1-linux,path_segs[i] refers to segment that starts at point i
v1.3.1-linux,"when path ends, we want to slow down"
v1.3.1-linux,else no need to change velocities for last segments
v1.3.1-linux,setup current position on path to 0 offset
v1.3.1-linux,initialize next path position
v1.3.1-linux,until we are at the end of the path (last seg is always zero size)
v1.3.1-linux,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.3.1-linux,send drone command to get to next lookahead
v1.3.1-linux,sleep for rest of the cycle
v1.3.1-linux,how much have we moved towards last goal?
v1.3.1-linux,project actual vector on goal vector
v1.3.1-linux,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.3.1-linux,TODO: below should be lower than 1E3 and configurable
v1.3.1-linux,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.3.1-linux,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.3.1-linux,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.3.1-linux,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.3.1-linux,"if drone moved backward, we don't want goal to move backward as well"
v1.3.1-linux,"so only climb forward on the path, never back. Also note >= which means"
v1.3.1-linux,we climb path even if distance was 0 to take care of duplicated points on path
v1.3.1-linux,else
v1.3.1-linux,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.3.1-linux,compute next target on path
v1.3.1-linux,freeze the quaternion
v1.3.1-linux,convert RC commands to velocity vector
v1.3.1-linux,find yaw as per terrain and remote setting
v1.3.1-linux,execute command
v1.3.1-linux,if timeout occurred then command completed successfully otherwise it was interrupted
v1.3.1-linux,yaw is not within margin
v1.3.1-linux,by default we say that this command is not supported
v1.3.1-linux,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.3.1-linux,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.3.1-linux,get trims
v1.3.1-linux,take average
v1.3.1-linux,validate dest
v1.3.1-linux,what is the distance we will travel at this velocity?
v1.3.1-linux,get velocity vector
v1.3.1-linux,yaw for the direction of travel
v1.3.1-linux,find velocity vector
v1.3.1-linux,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.3.1-linux,generate velocity vector that is same size as cur_dest_norm / command period
v1.3.1-linux,this velocity vect when executed for command period would yield cur_dest_norm
v1.3.1-linux,send commands
v1.3.1-linux,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.3.1-linux,default strategy is for move. In hover mode we set new strategy temporarily
v1.3.1-linux,are we supposed to do EM?
v1.3.1-linux,get suggested velocity vector
v1.3.1-linux,use the unchecked command
v1.3.1-linux,tell caller not to execute planned command
v1.3.1-linux,other wise throw exception
v1.3.1-linux,otherwise there is some other reason why we are in unsafe situation
v1.3.1-linux,send last command to come to full stop
v1.3.1-linux,else no unsafe situation
v1.3.1-linux,note: cur_path_loc and next_path_loc may both point to same object
v1.3.1-linux,"otherwise use up this segment, move on to next one"
v1.3.1-linux,if we are here then we ran out of segments
v1.3.1-linux,consider last segment as zero length segment
v1.3.1-linux,adjust yaw for the direction of travel in forward-only mode
v1.3.1-linux,else no adjustment needed
v1.3.1-linux,if auto mode requested for lookahead then calculate based on velocity
v1.3.1-linux,Create a spring arm component for our chase camera
v1.3.1-linux,"do nothing, spring arm is pulling the camera with it"
v1.3.1-linux,"do nothing, we have camera turned off"
v1.3.1-linux,set initial view mode
v1.3.1-linux,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.3.1-linux,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.3.1-linux,"If the lag is missing, the camera will also occasionally shake."
v1.3.1-linux,"But, lag is not desired when piloting a drone"
v1.3.1-linux,attach spring arm to actor
v1.3.1-linux,remember current parent for external camera. Later when we remove external
v1.3.1-linux,"camera from spring arm, we will attach it back to its last parent"
v1.3.1-linux,now attach camera to spring arm
v1.3.1-linux,"For car, we need to move the camera back a little more than for a drone."
v1.3.1-linux,"Otherwise, the camera will be stuck inside the car"
v1.3.1-linux,ExternalCamera->bUsePawnControlRotation = false;
v1.3.1-linux,detach spring arm
v1.3.1-linux,Re-enable rendering
v1.3.1-linux,Remove any existing key bindings for manual mode
v1.3.1-linux,"else someone else is bound to manual pose controller, leave it alone"
v1.3.1-linux,if new mode is manual mode then add key bindings
v1.3.1-linux,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.3.1-linux,other modes don't need special setup
v1.3.1-linux,make switch official
v1.3.1-linux,Split the tag string into individual tags.
v1.3.1-linux,Texture swap on actors that have all of those tags.
v1.3.1-linux,----------- Plotting APIs ----------/
v1.3.1-linux,"plot line for points 0-1, 1-2, 2-3"
v1.3.1-linux,"plot line for points 0-1, 2-3, 4-5... must be even number of points"
v1.3.1-linux,assert points_start.size() == poinst_end.size()
v1.3.1-linux,assert positions.size() == strings.size()
v1.3.1-linux,assert poses.size() == names.size()
v1.3.1-linux,by default all image types are disabled
v1.3.1-linux,use final color for all calculations
v1.3.1-linux,TODO: avoid the need to override const cast here
v1.3.1-linux,if the viewport is taller than it is wide
v1.3.1-linux,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v1.3.1-linux,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v1.3.1-linux,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v1.3.1-linux,use final color for all calculations
v1.3.1-linux,TODO: should we be ignoring position and orientation settings here?
v1.3.1-linux,TODO: can we eliminate storing NedTransform?
v1.3.1-linux,if (!std::isnan(setting.target_gamma))
v1.3.1-linux,camera-> = setting.target_gamma;
v1.3.1-linux,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.3.1-linux,else nothing to enable
v1.3.1-linux,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.3.1-linux,if (controller && controller->GetViewTarget() == this)
v1.3.1-linux,controller->SetViewTarget(nullptr);
v1.3.1-linux,TODO: explore screenshot option
v1.3.1-linux,addScreenCaptureHandler(camera->GetWorld());
v1.3.1-linux,TODO: may be we should have these methods non-const?
v1.3.1-linux,We don't do game/render thread synchronization for safe method.
v1.3.1-linux,We just blindly sleep for 200ms (the old way)
v1.3.1-linux,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.3.1-linux,Make sure that all alpha values are opaque.
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,"#include ""Runtime/Foliage/Public/FoliageType.h"""
v1.3.1-linux,TODO: change naming conventions to same as other files?
v1.3.1-linux,Enable/disable primary viewport rendering flag
v1.3.1-linux,This disables rendering of the main viewport in the same way as the
v1.3.1-linux,"console command ""show rendering"" would do."
v1.3.1-linux,"When getting an image through the API, the image is produced after the render"
v1.3.1-linux,thread has finished rendering the current and the subsequent frame. This means
v1.3.1-linux,that the frame rate for obtaining images through the API is only half as high as
v1.3.1-linux,"it could be, since only every other image is actually captured. We work around"
v1.3.1-linux,this by telling the viewport to flush the rendering queue at the end of each
v1.3.1-linux,drawn frame so that it executes our render request at that point already.
v1.3.1-linux,Do this only if the main viewport is not being rendered anyway in case there are
v1.3.1-linux,any adverse performance effects during main rendering.
v1.3.1-linux,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v1.3.1-linux,nothing to do for now
v1.3.1-linux,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.3.1-linux,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.3.1-linux,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.3.1-linux,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.3.1-linux,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.3.1-linux,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.3.1-linux,{
v1.3.1-linux,InitializeObjectStencilID(*comp);
v1.3.1-linux,}
v1.3.1-linux,Access the subclass instance with the * or -> operators.
v1.3.1-linux,"The skybox is ignored here as it is huge, and really is of no use to the end user typically. Also the associated meshes with the cameras"
v1.3.1-linux,Various checks if there is even a valid mesh
v1.3.1-linux,Need to force the render command to go through cause on the next iteration the buffer no longer exists
v1.3.1-linux,Unreal stores more vertices than triangles. So here we find the highest referenced vertex and ignore any after that
v1.3.1-linux,can we see followee?
v1.3.1-linux,remove mapping
v1.3.1-linux,removing binding
v1.3.1-linux,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.3.1-linux,"some point. At the moment, manually swapping Red and Blue"
v1.3.1-linux,Copy scaled image into destination thumb
v1.3.1-linux,Compress data - convert into a .png
v1.3.1-linux,if we already have attached actor
v1.3.1-linux,#ifdef _MSC_VER
v1.3.1-linux,//print to VS output window
v1.3.1-linux,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.3.1-linux,#endif
v1.3.1-linux,also do default logging
v1.3.1-linux,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.3.1-linux,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.3.1-linux,{
v1.3.1-linux,if (GEngine != nullptr)
v1.3.1-linux,{
v1.3.1-linux,return GEngine->GameUserSettings;
v1.3.1-linux,}
v1.3.1-linux,return nullptr;
v1.3.1-linux,}
v1.3.1-linux,UGameUserSettings* game_settings = GetGameUserSettings();
v1.3.1-linux,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.3.1-linux,game_settings->ApplySettings(true);
v1.3.1-linux,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.3.1-linux,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.3.1-linux,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.3.1-linux,todo unused. need to manually plots tf axes' line in right handed FLU instead of using DrawDebugCoordinateSystem
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,plugin startup
v1.3.1-linux,plugin shutdown
v1.3.1-linux,initialize state
v1.3.1-linux,add listener for pawn's collision event
v1.3.1-linux,compute our home point
v1.3.1-linux,default behavior is to call update every tick
v1.3.1-linux,"for custom physics engine, this method should be overridden and update should be"
v1.3.1-linux,called from every physics tick
v1.3.1-linux,add cameras that already exists in pawn
v1.3.1-linux,create or replace cameras specified in settings
v1.3.1-linux,setup individual cameras
v1.3.1-linux,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.3.1-linux,for each camera in settings
v1.3.1-linux,get pose
v1.3.1-linux,spawn and attach camera to pawn
v1.3.1-linux,add on to our collection
v1.3.1-linux,Deflect along the surface when we collide.
v1.3.1-linux,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.3.1-linux,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.3.1-linux,-1 to 1 --> 0 to 1
v1.3.1-linux,-1 to 1
v1.3.1-linux,these will be available for devices like steering wheels
v1.3.1-linux,switch index 0 to 7 for FrSky Taranis RC is:
v1.3.1-linux,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.3.1-linux,TODO: should below be at controller level info?
v1.3.1-linux,else don't waste time
v1.3.1-linux,sync environment from kinematics
v1.3.1-linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.3.1-linux,void playBack()
v1.3.1-linux,{
v1.3.1-linux,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.3.1-linux,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.3.1-linux,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.3.1-linux,}
v1.3.1-linux,TODO: refactor below code used for playback
v1.3.1-linux,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.3.1-linux,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.3.1-linux,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.3.1-linux,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.3.1-linux,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.3.1-linux,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.3.1-linux,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.3.1-linux,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.3.1-linux,}
v1.3.1-linux,parameters in NED frame
v1.3.1-linux,translate to new PawnSimApi position & orientation from NED to NEU
v1.3.1-linux,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.3.1-linux,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.3.1-linux,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.3.1-linux,checked at the start of next tick
v1.3.1-linux,allow teleportation
v1.3.1-linux,if collisions are not enabled
v1.3.1-linux,or we have collided but passthrough is enabled
v1.3.1-linux,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.3.1-linux,"without flip flopping, collisions can't be detected"
v1.3.1-linux,update kinematics from pawn's movement instead of physics engine
v1.3.1-linux,by default we update kinematics from UE pawn
v1.3.1-linux,if SimMod uses its own physics engine then this should be overriden
v1.3.1-linux,no default action in this base class
v1.3.1-linux,TODO: because this bug we are using alternative code with stringstream
v1.3.1-linux,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.3.1-linux,std::stringstream ss;
v1.3.1-linux,"ss << timestamp_millis << ""\t"";"
v1.3.1-linux,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.3.1-linux,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.3.1-linux,"ss << ""\n"";"
v1.3.1-linux,return ss.str();
v1.3.1-linux,"read pixels from render target using render thread, then compress the result into PNG"
v1.3.1-linux,argument on the thread that calls this method.
v1.3.1-linux,TODO: is below really needed?
v1.3.1-linux,make sure we are not on the rendering thread
v1.3.1-linux,TODO: below doesn't work right now because it must be running in game thread
v1.3.1-linux,below is documented method but more expensive because it forces flush
v1.3.1-linux,wait for render thread to pick up our task
v1.3.1-linux,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.3.1-linux,capture CameraPose for this frame
v1.3.1-linux,The completion is called immeidately after GameThread sends the
v1.3.1-linux,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.3.1-linux,execute *immediately* after RenderThread renders the scene!
v1.3.1-linux,"while we're still on GameThread, enqueue request for capture the scene!"
v1.3.1-linux,wait for this task to complete
v1.3.1-linux,log a message and continue wait
v1.3.1-linux,lamda function still references a few objects for which there is no refcount.
v1.3.1-linux,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.3.1-linux,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.3.1-linux,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.3.1-linux,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.3.1-linux,Fill out your copyright notice in the Description page of Project Settings.
v1.3.1-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.1-linux,UWorld* World = GetWorld();
v1.3.1-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.1-linux,still need the menu class for f10
v1.3.1-linux,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v1.3.1-linux,showWeatherMenu(WorldContextObject);
v1.3.1-linux,"if weather is not enabled, dont allow any weather values to be set"
v1.3.1-linux,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v1.3.1-linux,and must be set to true or false before this.
v1.3.1-linux,WeatherEnabled will always be false
v1.3.1-linux,"NOTE: weather enabled must be set first, before other params for this to work"
v1.3.1-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.1-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.1-linux,"get all menu actors, if any"
v1.3.1-linux,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.3.1-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.1-linux,"get all menu actors, if any"
v1.3.1-linux,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.3.1-linux,"get all menu actors, if any, then hide the menu"
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,Stuff to filter out XInput devices
v1.3.1-linux,-----------------------------------------------------------------------------
v1.3.1-linux,"Defines, constants, and global variables"
v1.3.1-linux,-----------------------------------------------------------------------------
v1.3.1-linux,Magnitude ranges from -1 to 1
v1.3.1-linux,Strength ranges from 0 to 1
v1.3.1-linux,Autocenter
v1.3.1-linux,Rumble
v1.3.1-linux,Register with the DirectInput subsystem and get a pointer
v1.3.1-linux,to a IDirectInput interface we can use.
v1.3.1-linux,Create a DInput object
v1.3.1-linux,Look for a simple joystick we can use for this sample program.
v1.3.1-linux,Make sure we got a joystick
v1.3.1-linux,"Set the data format to ""simple joystick"" - a predefined data format"
v1.3.1-linux,
v1.3.1-linux,"A data format specifies which controls on a device we are interested in,"
v1.3.1-linux,and how they should be reported. This tells DInput that we will be
v1.3.1-linux,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.3.1-linux,Set the cooperative level to let DInput know how this device should
v1.3.1-linux,interact with the system and with other DInput applications.
v1.3.1-linux,Enumerate the joystick objects. The callback function enabled user
v1.3.1-linux,"interface elements for objects that are found, and sets the min/max"
v1.3.1-linux,values property for discovered axes.
v1.3.1-linux,-----------------------------------------------------------------------------
v1.3.1-linux,Enum each PNP device using WMI and check each device ID to see if it contains
v1.3.1-linux,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.3.1-linux,Unfortunately this information can not be found by just using DirectInput.
v1.3.1-linux,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.3.1-linux,XInput devices.
v1.3.1-linux,
v1.3.1-linux,This function stores the list of xinput devices in a linked list
v1.3.1-linux,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.3.1-linux,-----------------------------------------------------------------------------
v1.3.1-linux,CoInit if needed
v1.3.1-linux,Create WMI
v1.3.1-linux,Create BSTRs for WMI
v1.3.1-linux,Connect to WMI
v1.3.1-linux,Switch security level to IMPERSONATE
v1.3.1-linux,Get list of Win32_PNPEntity devices
v1.3.1-linux,Loop over all devices
v1.3.1-linux,Get 20 at a time
v1.3.1-linux,"For each device, get its device ID"
v1.3.1-linux,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.3.1-linux,Unfortunately this information can not be found by just using DirectInput
v1.3.1-linux,"If it does, then get the VID/PID from var.bstrVal"
v1.3.1-linux,Add the VID/PID to a linked list
v1.3.1-linux,-----------------------------------------------------------------------------
v1.3.1-linux,Returns true if the DirectInput device is also an XInput device.
v1.3.1-linux,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.3.1-linux,-----------------------------------------------------------------------------
v1.3.1-linux,Check each xinput device to see if this device's vid/pid matches
v1.3.1-linux,-----------------------------------------------------------------------------
v1.3.1-linux,Cleanup needed for IsXInputDevice()
v1.3.1-linux,-----------------------------------------------------------------------------
v1.3.1-linux,Cleanup linked list
v1.3.1-linux,-----------------------------------------------------------------------------
v1.3.1-linux,Name: EnumJoysticksCallback()
v1.3.1-linux,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.3.1-linux,device interface on it so we can play with it.
v1.3.1-linux,-----------------------------------------------------------------------------
v1.3.1-linux,Skip anything other than the perferred joystick device as defined by the control panel.
v1.3.1-linux,Instead you could store all the enumerated joysticks and let the user pick.
v1.3.1-linux,Obtain an interface to the enumerated joystick.
v1.3.1-linux,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.3.1-linux,it while we were in the middle of enumerating it.)
v1.3.1-linux,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.3.1-linux,could store all the enumerated joysticks and let the user pick.
v1.3.1-linux,-----------------------------------------------------------------------------
v1.3.1-linux,Name: EnumObjectsCallback()
v1.3.1-linux,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.3.1-linux,joystick. This function enables user interface elements for objects
v1.3.1-linux,"that are found to exist, and scales axes min/max values."
v1.3.1-linux,-----------------------------------------------------------------------------
v1.3.1-linux,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.3.1-linux,enumerated axis in order to scale min/max values.
v1.3.1-linux,Set the range for the axis
v1.3.1-linux,Set the UI to reflect what objects the joystick supports
v1.3.1-linux,-----------------------------------------------------------------------------
v1.3.1-linux,Name: UpdateInputState()
v1.3.1-linux,Desc: Get the input device's state and display it.
v1.3.1-linux,-----------------------------------------------------------------------------
v1.3.1-linux,Poll the device to read the current state
v1.3.1-linux,DInput is telling us that the input stream has been
v1.3.1-linux,"interrupted. We aren't tracking any state between polls, so"
v1.3.1-linux,we don't have any special reset that needs to be done. We
v1.3.1-linux,just re-acquire and try again.
v1.3.1-linux,while (hr == DIERR_INPUTLOST)
v1.3.1-linux,hr = g_pJoystick->Acquire();
v1.3.1-linux,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.3.1-linux,may occur when the app is minimized or in the process of
v1.3.1-linux,"switching, so just try again later"
v1.3.1-linux,Get the input's device state
v1.3.1-linux,Axes
v1.3.1-linux,Slider controls
v1.3.1-linux,Points of view
v1.3.1-linux,Buttons
v1.3.1-linux,-----------------------------------------------------------------------------
v1.3.1-linux,Name: FreeDirectInput()
v1.3.1-linux,Desc: Initialize the DirectInput variables.
v1.3.1-linux,-----------------------------------------------------------------------------
v1.3.1-linux,Unacquire the device one last time just in case
v1.3.1-linux,the app tried to exit while the device is still acquired.
v1.3.1-linux,Release any DirectInput objects.
v1.3.1-linux,nop
v1.3.1-linux,normalize min to max --> 0 to 1
v1.3.1-linux,normalize 0 to 1 --> -1 to 1
v1.3.1-linux,#include <libudev.h>
v1.3.1-linux,implementation for unsupported OS
v1.3.1-linux,if this is new index
v1.3.1-linux,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.3.1-linux,close previous one
v1.3.1-linux,open new device
v1.3.1-linux,if open was successful
v1.3.1-linux,read the device
v1.3.1-linux,if we didn't had valid read
v1.3.1-linux,"NOTE if this condition is not met, we're probably out of sync and this"
v1.3.1-linux,Joystick instance is likely unusable
v1.3.1-linux,TODO: set below to false?
v1.3.1-linux,state.is_valid = false;
v1.3.1-linux,else ignore
v1.3.1-linux,TODO: implement this for linux
v1.3.1-linux,TODO: implement this for linux
v1.3.1-linux,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.3.1-linux,{
v1.3.1-linux,"manufacturerID = productID = """";"
v1.3.1-linux,// Use udev to look up the product and manufacturer IDs
v1.3.1-linux,struct udev *udev = udev_new();
v1.3.1-linux,if (udev) {
v1.3.1-linux,char sysname[32];
v1.3.1-linux,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.3.1-linux,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.3.1-linux,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.3.1-linux,if (!dev)
v1.3.1-linux,{
v1.3.1-linux,"message = ""Unable to find parent USB device"";"
v1.3.1-linux,return false;
v1.3.1-linux,}
v1.3.1-linux,std::stringstream ss;
v1.3.1-linux,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.3.1-linux,ss >> manufacturerID;
v1.3.1-linux,ss.clear();
v1.3.1-linux,"ss.str("""");"
v1.3.1-linux,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.3.1-linux,ss >> productID;
v1.3.1-linux,udev_device_unref(dev);
v1.3.1-linux,}
v1.3.1-linux,else
v1.3.1-linux,{
v1.3.1-linux,"message = ""Cannot create udev"";"
v1.3.1-linux,return false;
v1.3.1-linux,}
v1.3.1-linux,udev_unref(udev);
v1.3.1-linux,return true;
v1.3.1-linux,}
v1.3.1-linux,required for pimpl
v1.3.1-linux,TODO: anyway to workaround const_cast?
v1.3.1-linux,FGenericPlatformMisc::PlatformInit();
v1.3.1-linux,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.3.1-linux,TODO: index check
v1.3.1-linux,create main widget
v1.3.1-linux,synchronize PIP views
v1.3.1-linux,TODO: should we only do below on SceneCapture2D components and cameras?
v1.3.1-linux,avoid motion blur so capture images don't get
v1.3.1-linux,use two different methods to set console var because sometime it doesn't seem to work
v1.3.1-linux,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.3.1-linux,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.3.1-linux,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.3.1-linux,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.3.1-linux,setup defaults
v1.3.1-linux,Attempts to parse the settings text from one of multiple locations.
v1.3.1-linux,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.3.1-linux,"Next, check the executable's working directory for the settings file."
v1.3.1-linux,"Finally, check the user's documents folder."
v1.3.1-linux,"If the settings file cannot be read, throw an exception"
v1.3.1-linux,Attempts to parse the settings text from the command line
v1.3.1-linux,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.3.1-linux,"Example: AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.3.1-linux,"Returns true if the argument is present, false otherwise."
v1.3.1-linux,build image file name
v1.3.1-linux,write image file
v1.3.1-linux,write to CSV file
v1.3.1-linux,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.3.1-linux,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.3.1-linux,make sire all vars are set up
v1.3.1-linux,"TODO: should we go as fast as possible, or should we limit this to a particular number of"
v1.3.1-linux,frames per second?
v1.3.1-linux,BG: Workaround to get sync ground truth. See https://github.com/Microsoft/AirSim/issues/1494 for details
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,decide which derived BP to use
v1.3.1-linux,we don't have real vehicle so no vehicle API
v1.3.1-linux,put camera little bit above vehicle
v1.3.1-linux,update ground level
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,let base class setup physics world
v1.3.1-linux,stop physics thread before we dismantle
v1.3.1-linux,setup clock in ClockFactory
v1.3.1-linux,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.3.1-linux,steppable clock returns interval that is a constant number irrespective of wall clock
v1.3.1-linux,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.3.1-linux,but that would cause vehicles like quadrotors to become unstable
v1.3.1-linux,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.3.1-linux,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.3.1-linux,get increase in clock speed
v1.3.1-linux,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.3.1-linux,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.3.1-linux,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.3.1-linux,Approach 2: scale control loop frequency if clock is speeded up
v1.3.1-linux,"for slowing down, this don't generate instability"
v1.3.1-linux,-------------------------------- overrides -----------------------------------------------//
v1.3.1-linux,decide which derived BP to use
v1.3.1-linux,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.3.1-linux,vehicle_sim_api->reset();
v1.3.1-linux,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.3.1-linux,create vehicle API
v1.3.1-linux,setup physics vehicle
v1.3.1-linux,initialize private vars
v1.3.1-linux,calls to update* are handled by physics engine and in SimModeWorldBase
v1.3.1-linux,"Utils::log(""------Render tick-------"");"
v1.3.1-linux,"if reset is pending then do it first, no need to do other things until next tick"
v1.3.1-linux,move collision info from rendering engine to vehicle
v1.3.1-linux,update rotor poses
v1.3.1-linux,if we did reset then don't worry about synchronizing states for this tick
v1.3.1-linux,Continue to wait for reset
v1.3.1-linux,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.3.1-linux,*** Start: UpdatableState implementation ***//
v1.3.1-linux,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.3.1-linux,environment update for current position
v1.3.1-linux,update forces on vertices
v1.3.1-linux,update to controller must be done after kinematics have been updated by physics engine
v1.3.1-linux,*** End: UpdatableState implementation ***//
v1.3.1-linux,get references of existing camera
v1.3.1-linux,setup clock in PhysX
v1.3.1-linux,-------------------------------- overrides -----------------------------------------------//
v1.3.1-linux,decide which derived BP to use
v1.3.1-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.3.1-linux,Setup suspension forces
v1.3.1-linux,Find the tire object and set the data for it
v1.3.1-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.3.1-linux,Setup suspension forces
v1.3.1-linux,Find the tire object and set the data for it
v1.3.1-linux,Create In-Car camera component
v1.3.1-linux,In car HUD
v1.3.1-linux,Create text render component for in car speed display
v1.3.1-linux,Create text render component for in car gear display
v1.3.1-linux,Setup the audio component and allocate it a sound cue
v1.3.1-linux,Colors for the in-car gear display. One for normal one for reverse
v1.3.1-linux,Wheels/Tires
v1.3.1-linux,Setup the wheels
v1.3.1-linux,Adjust the tire loading
v1.3.1-linux,Engine
v1.3.1-linux,Torque setup
v1.3.1-linux,Adjust the steering
v1.3.1-linux,Transmission
v1.3.1-linux,We want 4wd
v1.3.1-linux,Drive the front wheels a little more than the rear
v1.3.1-linux,Automatic gearbox
v1.3.1-linux,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.3.1-linux,Physics settings
v1.3.1-linux,Adjust the center of mass - the buggy is quite low
v1.3.1-linux,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.3.1-linux,put camera little bit above vehicle
v1.3.1-linux,update physics material
v1.3.1-linux,Update the strings used in the HUD (in-car and on-screen)
v1.3.1-linux,Set the string in the in-car HUD
v1.3.1-linux,Pass the engine RPM to the sound component
v1.3.1-linux,Start an engine sound playing
v1.3.1-linux,Using FText because this is display text that should be localizable
v1.3.1-linux,Setup the text render component strings
v1.3.1-linux,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.3.1-linux,below is not needed
v1.3.1-linux,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.3.1-linux,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.3.1-linux,TODO: should do reset() here?
v1.3.1-linux,create vehicle params
v1.3.1-linux,these are called on render ticks
v1.3.1-linux,TODO: do we need this for cars?
v1.3.1-linux,TODO: move this to SimModeBase?
v1.3.1-linux,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.3.1-linux,reset();
v1.3.1-linux,return;
v1.3.1-linux,}
v1.3.1-linux,Thrustmaster devices
v1.3.1-linux,"Anything else, typically Logitech G920 wheel"
v1.3.1-linux,Two steel levers behind wheel
v1.3.1-linux,if API-client control is not active then we route keyboard/joystick control to car
v1.3.1-linux,all car controls from anywhere must be routed through API component
v1.3.1-linux,*** Start: UpdatableState implementation ***//
v1.3.1-linux,physics tick
v1.3.1-linux,*** End: UpdatableState implementation ***//
v1.3.1-linux,TODO: directly accept getVehicleSimApis() using generic container
v1.3.1-linux,remove everything that we created in BeginPlay
v1.3.1-linux,we use custom debug reporting for this class
v1.3.1-linux,perform any expensive rendering update outside of lock region
v1.3.1-linux,no need to call base reset because of our custom implementation
v1.3.1-linux,TODO: this is going to cause circular references which is fine here but
v1.3.1-linux,in future we should consider moving SimMode not derived from AActor and move
v1.3.1-linux,it to AirLib and directly implement WorldSimApiBase interface
v1.3.1-linux,get player start
v1.3.1-linux,this must be done from within actor otherwise we don't get player start
v1.3.1-linux,UWeatherLib::showWeatherMenu(World);
v1.3.1-linux,else don't init
v1.3.1-linux,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v1.3.1-linux,tod_sim_clock_start_ needs to be reset here.
v1.3.1-linux,Going from enabled to disabled
v1.3.1-linux,do these in the end to ensure that advanceTimeOfDay() doesn't see
v1.3.1-linux,any inconsistent state.
v1.3.1-linux,should be overridden by derived class
v1.3.1-linux,should be overridden by derived class
v1.3.1-linux,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.3.1-linux,default setup - this should be overridden in derived modes as needed
v1.3.1-linux,setup clock in ClockFactory
v1.3.1-linux,default implementation
v1.3.1-linux,create director
v1.3.1-linux,create external camera required for the director
v1.3.1-linux,API server start/stop
v1.3.1-linux,get UU origin of global NED frame
v1.3.1-linux,determine camera director camera default pose and spawn it
v1.3.1-linux,find all vehicle pawns
v1.3.1-linux,add vehicles from settings
v1.3.1-linux,if vehicle is of type for derived SimMode and auto creatable
v1.3.1-linux,compute initial pose
v1.3.1-linux,spawn vehicle pawn
v1.3.1-linux,create API objects for each pawn we have
v1.3.1-linux,create vehicle sim api
v1.3.1-linux,TODO: better handle no FPV vehicles scenario
v1.3.1-linux,derived class should override this method to retrieve types of pawns they support
v1.3.1-linux,derived class should override this method to retrieve types of pawns they support
v1.3.1-linux,derived class should override this method to retrieve types of pawns they support
v1.3.1-linux,derived class should override this method to retrieve types of pawns they support
v1.3.1-linux,derived class should override this method to retrieve types of pawns they support
v1.3.1-linux,derived class should override this method to retrieve types of pawns they support
v1.3.1-linux,derived class should override this method to retrieve types of pawns they support
v1.3.1-linux,Draws debug-points on main viewport for Lidar laser hits.
v1.3.1-linux,Used for debugging only.
v1.3.1-linux,Currently we are checking the sensor-collection instead of sensor-settings.
v1.3.1-linux,Also using variables to optimize not checking the collection if not needed.
v1.3.1-linux,TODO: Is it incorrect to assume LidarSimple here?
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,ctor
v1.3.1-linux,initializes information based on lidar configuration
v1.3.1-linux,calculate verticle angle distance between each laser
v1.3.1-linux,store vertical angles for each laser
v1.3.1-linux,returns a point-cloud for the tick
v1.3.1-linux,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.3.1-linux,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.3.1-linux,calculate number of points needed for each laser/channel
v1.3.1-linux,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.3.1-linux,calculate needed angle/distance between each point
v1.3.1-linux,normalize FOV start/end
v1.3.1-linux,shoot lasers
v1.3.1-linux,check if the laser is outside the requested horizontal FOV
v1.3.1-linux,"shoot laser and get the impact point, if any"
v1.3.1-linux,simulate shooting a laser via Unreal ray-tracing.
v1.3.1-linux,start position
v1.3.1-linux,We need to compose rotations here rather than rotate a vector by a quaternion
v1.3.1-linux,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.3.1-linux,get ray quaternion in lidar frame (angles must be in radians)
v1.3.1-linux,get ray quaternion in body frame
v1.3.1-linux,get ray quaternion in world frame
v1.3.1-linux,get ray vector (end position)
v1.3.1-linux,Store the segmentation id of the hit object.
v1.3.1-linux,Debug code for very specific cases.
v1.3.1-linux,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.3.1-linux,decide the frame for the point-cloud
v1.3.1-linux,current detault behavior; though it is probably not very useful.
v1.3.1-linux,not changing the default for now to maintain backwards-compat.
v1.3.1-linux,point in vehicle intertial frame
v1.3.1-linux,tranform to lidar frame
v1.3.1-linux,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.3.1-linux,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.3.1-linux,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.3.1-linux,"On the client side, if it is needed to transform this data back to the world frame,"
v1.3.1-linux,"then do the equivalent of following,"
v1.3.1-linux,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.3.1-linux,See SimModeBase::drawLidarDebugPoints()
v1.3.1-linux,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.3.1-linux,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,update ray tracing
v1.3.1-linux,"FString hit_name = FString(""None"");"
v1.3.1-linux,if (dist_hit.GetActor())
v1.3.1-linux,hit_name=dist_hit.GetActor()->GetName();
v1.3.1-linux,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.3.1-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,This assumes you are running DroneServer already on the same machine.
v1.3.1-linux,DroneServer must be running first.
v1.3.1-linux,enable API control
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,move commands
v1.3.1-linux,else leave as it is
v1.3.1-linux,TODO: get these in one call
v1.3.1-linux,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.3.1-linux,TODO: shouldn't we pass folder path?
v1.3.1-linux,parse
v1.3.1-linux,group the images by the current date.
v1.3.1-linux,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.3.1-linux,{
v1.3.1-linux,"return """";"
v1.3.1-linux,}
v1.3.1-linux,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.3.1-linux,{
v1.3.1-linux,return false;
v1.3.1-linux,}
v1.3.1-linux,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.3.1-linux,params.context->client.newTask();
v1.3.1-linux,}
v1.3.1-linux,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.3.1-linux,params.context->client.WaitForCompletion(0);
v1.3.1-linux,}
v1.3.1-linux,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.3.1-linux,{
v1.3.1-linux,}
v1.3.1-linux,parse command line
v1.3.1-linux,Shell callbacks
v1.3.1-linux,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.3.1-linux,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.3.1-linux,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.3.1-linux,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.3.1-linux,Add shell commands
v1.3.1-linux,TODO: add WaitForCompletion command
v1.3.1-linux,"TODO: add command line args help, arg count validation"
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v1.3.1-linux,switch to explicit hover mode so that this is the fall back when
v1.3.1-linux,move* commands are finished.
v1.3.1-linux,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.3.1-linux,TODO: implement weather for Unity
v1.3.1-linux,TODO: implement weather for Unity
v1.3.1-linux,----------------Plotting APIs-----------/
v1.3.1-linux,Function pointers to hold the addresses of the functions that are defined in Unity
v1.3.1-linux,"Enabling all LogLevels,"
v1.3.1-linux,"Enabling all LogLevels,"
v1.3.1-linux,delete ltm;
v1.3.1-linux,initialize state
v1.3.1-linux,compute our home point
v1.3.1-linux,default behavior is to call update every tick
v1.3.1-linux,"for custom physics engine, this method should be overridden and update should be"
v1.3.1-linux,called from every physics tick
v1.3.1-linux,these will be available for devices like steering wheels
v1.3.1-linux,sync environment from kinematics
v1.3.1-linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.3.1-linux,FVector unrealPosition = getUUPosition();
v1.3.1-linux,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v1.3.1-linux,parameters in NED frame
v1.3.1-linux,allow teleportation
v1.3.1-linux,if collisions are not enabled
v1.3.1-linux,or we have collided but passthrough is enabled
v1.3.1-linux,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.3.1-linux,"without flip flopping, collisions can't be detected"
v1.3.1-linux,by default we update kinematics from UE pawn
v1.3.1-linux,if SimMod uses its own physics engine then this should be overriden
v1.3.1-linux,no default action in this base class
v1.3.1-linux,TODO: because this bug we are using alternative code with stringstream
v1.3.1-linux,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.3.1-linux,update kinematics from pawn's movement instead of physics engine
v1.3.1-linux,TODO: update other fields?
v1.3.1-linux,implements getImages() method in the ImageCaptureBase class.
v1.3.1-linux,update ray tracing
v1.3.1-linux,TODO: index check
v1.3.1-linux,Attempts to parse the settings text from one of multiple locations.
v1.3.1-linux,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.3.1-linux,"Next, check the executable's working directory for the settings file."
v1.3.1-linux,"Finally, check the user's documents folder."
v1.3.1-linux,"If the settings file cannot be read, throw an exception"
v1.3.1-linux,let base class setup physics world
v1.3.1-linux,stop physics thread before we dismantle
v1.3.1-linux,setup clock in ClockFactory
v1.3.1-linux,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.3.1-linux,steppable clock returns interval that is a constant number irrespective of wall clock
v1.3.1-linux,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.3.1-linux,but that would cause vehicles like quadrotors to become unstable
v1.3.1-linux,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.3.1-linux,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.3.1-linux,get increase in clock speed
v1.3.1-linux,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.3.1-linux,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.3.1-linux,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.3.1-linux,Approach 2: scale control loop frequency if clock is speeded up
v1.3.1-linux,"for slowing down, this don't generate instability"
v1.3.1-linux,-------------------------------- overrides -----------------------------------------------//
v1.3.1-linux,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.3.1-linux,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.3.1-linux,create vehicle API
v1.3.1-linux,setup physics vehicle
v1.3.1-linux,initialize private vars
v1.3.1-linux,"if reset is pending then do it first, no need to do other things until next tick"
v1.3.1-linux,move collision info from rendering engine to vehicle
v1.3.1-linux,update rotor poses
v1.3.1-linux,if we did reset then don't worry about synchronizing states for this tick
v1.3.1-linux,Continue to wait for reset
v1.3.1-linux,*** Start: UpdatableState implementation ***//
v1.3.1-linux,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.3.1-linux,environment update for current position
v1.3.1-linux,update forces on vertices
v1.3.1-linux,update to controller must be done after kinematics have been updated by physics engine
v1.3.1-linux,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.3.1-linux,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.3.1-linux,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.3.1-linux,*** End: UpdatableState implementation ***//
v1.3.1-linux,TODO: should do reset() here?
v1.3.1-linux,these are called on render ticks
v1.3.1-linux,TODO: do we need this for cars?
v1.3.1-linux,Thrustmaster devices
v1.3.1-linux,"Anything else, typically Logitech G920 wheel"
v1.3.1-linux,Two steel levers behind wheel
v1.3.1-linux,if API-client control is not active then we route keyboard/joystick control to car
v1.3.1-linux,all car controls from anywhere must be routed through API component
v1.3.1-linux,*** Start: UpdatableState implementation ***//
v1.3.1-linux,physics tick
v1.3.1-linux,void CarPawnSimApi::reportState(StateReporter& reporter)
v1.3.1-linux,{
v1.3.1-linux,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.3.1-linux,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.3.1-linux,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.3.1-linux,}
v1.3.1-linux,*** End: UpdatableState implementation ***//
v1.3.1-linux,remove everything that we created in BeginPlay
v1.3.1-linux,we use custom debug reporting for this class
v1.3.1-linux,perform any expensive rendering update outside of lock region
v1.3.1-linux,no need to call base reset because of our custom implementation
v1.3.1-linux,should be overridden by derived class
v1.3.1-linux,should be overridden by derived class
v1.3.1-linux,commenting this out for now to avoid unintentional Unity startup failure
v1.3.1-linux,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v1.3.1-linux,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.3.1-linux,default setup - this should be overridden in derived modes as needed
v1.3.1-linux,setup clock in ClockFactory
v1.3.1-linux,API server start/stop
v1.3.1-linux,determine camera director camera default pose and spawn it
v1.3.1-linux,derived class should override this method to retrieve types of pawns they support
v1.3.1-linux,derived class should override this method to retrieve types of pawns they support
v1.3.1-linux,60 acres park:
v1.3.1-linux,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.3.1-linux,marymoore park
v1.3.1-linux,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.3.1-linux,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.3.1-linux,DepthNavThreshold depthNav;
v1.3.1-linux,DepthNavOptAStar depthNav;
v1.3.1-linux,DepthNavThreshold depthNav;
v1.3.1-linux,DepthNavOptAStar depthNav;
v1.3.1-linux,Cleanup
v1.3.1-linux,runDepthNavGT();
v1.3.1-linux,runDepthNavSGM();
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,by Sudipta Sinha
v1.3.1-linux,adapted for AirSim by Matthias Mueller
v1.3.1-linux,first row
v1.3.1-linux,last row
v1.3.1-linux,Local quadratic fit of cost and subpixel refinement.
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,by Sudipta Sinha
v1.3.1-linux,adapted for AirSim by Matthias Mueller
v1.3.1-linux,uint64_t x64 = (uint64_t)x;
v1.3.1-linux,uint64_t y64 = (uint64_t)y;
v1.3.1-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.1-linux,Licensed under the MIT License.
v1.3.1-linux,by Sudipta Sinha
v1.3.1-linux,adapted for AirSim by Matthias Mueller
v1.3.1-linux,ensure that disparity range is a multiple of 8
v1.3.1-linux,sgm stereo
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,read settings and override defaults
v1.3.0-linux,allow json overrides on a per-vehicle basis.
v1.3.0-linux,start server in async mode
v1.3.0-linux,check messages
v1.3.0-linux,In settings.json first activate computer vision mode:
v1.3.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.0-linux,monitor car state while you drive it manually.
v1.3.0-linux,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v1.3.0-linux,denominator from microns^3 to microns * m^2)
v1.3.0-linux,First set everything to 0.
v1.3.0-linux,Next set all objects of interest provided to corresponding object IDs
v1.3.0-linux,segIdDict values MUST match tempEmissivityNew labels.
v1.3.0-linux,"Connect to AirSim, UAV mode."
v1.3.0-linux,Choose temperature values for winter or summer.
v1.3.0-linux,""""""""
v1.3.0-linux,winter
v1.3.0-linux,""""""""
v1.3.0-linux,summer
v1.3.0-linux,Read camera response.
v1.3.0-linux,Calculate radiance.
v1.3.0-linux,Set IDs in AirSim environment.
v1.3.0-linux,plot red arrows for 30 seconds
v1.3.0-linux,plot magenta arrows for 15 seconds
v1.3.0-linux,plot red arrows for 10 seconds
v1.3.0-linux,plot 2 white arrows which are persistent
v1.3.0-linux,plot points
v1.3.0-linux,"plot line strip. 0-1, 1-2, 2-3"
v1.3.0-linux,"plot line list. 0-1, 2-3, 4-5. Must be even."
v1.3.0-linux,plot transforms
v1.3.0-linux,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=0.0, yaw=yaw)) for x, y, yaw in zip(np.linspace(0,10,10), np.linspace(0,0,10), np.linspace(0,np.pi,10))],"
v1.3.0-linux,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.3.0-linux,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=roll, yaw=0.0)) for x, y, roll in zip(np.linspace(0,10,10), np.linspace(1,1,10), np.linspace(0,np.pi,10))],"
v1.3.0-linux,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.3.0-linux,In settings.json first activate computer vision mode:
v1.3.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.0-linux,"define abstract class to return next vector in the format (x,y,yaw)"
v1.3.0-linux,"compute vector, distance and angle to goal"
v1.3.0-linux,compute box of interest
v1.3.0-linux,scale by weight matrix (optional)
v1.3.0-linux,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.3.0-linux,detect collision
v1.3.0-linux,compute box of interest
v1.3.0-linux,detect collision
v1.3.0-linux,Same as above but decide to go left or right based on average or some metric like that
v1.3.0-linux,"compute resultant normalized vector, distance and angle"
v1.3.0-linux,compute bounding box size
v1.3.0-linux,convert horizonal fov to vertical fov
v1.3.0-linux,matrix with all ones
v1.3.0-linux,matrix with max weight in center and decreasing linearly with distance from center
v1.3.0-linux,matrix with max weight in center and decreasing quadratically with distance from center
v1.3.0-linux,"print (""Saving images to %s"" % tmp_dir)"
v1.3.0-linux,airsim.wait_key('Press any key to start')
v1.3.0-linux,"Define start position, goal and size of UAV"
v1.3.0-linux,Define parameters and thresholds
v1.3.0-linux,initial position
v1.3.0-linux,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.3.0-linux,time.sleep(1)
v1.3.0-linux,get response
v1.3.0-linux,get numpy array
v1.3.0-linux,reshape array to 2D array H X W
v1.3.0-linux,write to png
v1.3.0-linux,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.3.0-linux,pose = client.simGetPose()
v1.3.0-linux,pp.pprint(pose)
v1.3.0-linux,time.sleep(5)
v1.3.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.3.0-linux,################### OLD CODE
v1.3.0-linux,timer = 0
v1.3.0-linux,time_obs = 50
v1.3.0-linux,bObstacle = False
v1.3.0-linux,if (bObstacle):
v1.3.0-linux,timer = timer + 1
v1.3.0-linux,if timer > time_obs:
v1.3.0-linux,bObstacle = False
v1.3.0-linux,timer = 0
v1.3.0-linux,else:
v1.3.0-linux,yaw = target_angle
v1.3.0-linux,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.3.0-linux,if (np.average(img2d_box) < coll_thres):
v1.3.0-linux,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.3.0-linux,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.3.0-linux,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.3.0-linux,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.3.0-linux,"print('left: ', img2d_box_l_avg)"
v1.3.0-linux,"print('right: ', img2d_box_r_avg)"
v1.3.0-linux,if img2d_box_l_avg > img2d_box_r_avg:
v1.3.0-linux,##Go LEFT
v1.3.0-linux,#y_offset = y_offset-1
v1.3.0-linux,yaw = yaw - radians(10)
v1.3.0-linux,bObstacle = True
v1.3.0-linux,else:
v1.3.0-linux,##Go RIGHT
v1.3.0-linux,#y_offset = y_offset+1
v1.3.0-linux,yaw = yaw + radians(10)
v1.3.0-linux,bObstacle = true
v1.3.0-linux,"print('yaw: ', yaw)"
v1.3.0-linux,In settings.json first activate computer vision mode:
v1.3.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.3.0-linux,In settings.json first activate computer vision mode:
v1.3.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.3.0-linux,pip install opencv-python
v1.3.0-linux,In settings.json first activate computer vision mode:
v1.3.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.0-linux,for block environment
v1.3.0-linux,regex are case insensitive
v1.3.0-linux,#for neighborhood environment
v1.3.0-linux,set object ID for sky
v1.3.0-linux,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.3.0-linux,get segmentation image in various formats
v1.3.0-linux,save segmentation images in various formats
v1.3.0-linux,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.3.0-linux,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.3.0-linux,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v1.3.0-linux,find unique colors
v1.3.0-linux,In settings.json first activate computer vision mode:
v1.3.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.0-linux,objects can be named in two ways:
v1.3.0-linux,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.3.0-linux,default name is auto-generated and varies from run-to-run.
v1.3.0-linux,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.3.0-linux,
v1.3.0-linux,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.3.0-linux,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.3.0-linux,https://answers.unrealengine.com/revisions/790629.html
v1.3.0-linux,below works in Blocks environment
v1.3.0-linux,------------------------------------ Get current pose ------------------------------------------------
v1.3.0-linux,search object by name:
v1.3.0-linux,search another object by tag
v1.3.0-linux,search non-existent object
v1.3.0-linux,------------------------------------ Set new pose ------------------------------------------------
v1.3.0-linux,here we move with teleport enabled so collisions are ignored
v1.3.0-linux,here we move with teleport enabled so collisions are not ignored
v1.3.0-linux,move non-existent object
v1.3.0-linux,------------------------------------ Get new pose ------------------------------------------------
v1.3.0-linux,search another object by tag
v1.3.0-linux,search non-existent object
v1.3.0-linux,Import this module to automatically setup path to local airsim module
v1.3.0-linux,This module first tries to see if airsim module is installed via pip
v1.3.0-linux,If it does then we don't do anything else
v1.3.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.3.0-linux,and if it does then we add that in sys.path
v1.3.0-linux,this class simply tries to see if airsim
v1.3.0-linux,if airsim module is installed then don't do anything else
v1.3.0-linux,import pkgutil
v1.3.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.3.0-linux,if airsim_loader is not None:
v1.3.0-linux,return
v1.3.0-linux,"Roll is applied first, then pitch, then yaw."
v1.3.0-linux,Turn the camera position into a column vector.
v1.3.0-linux,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v1.3.0-linux,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v1.3.0-linux,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v1.3.0-linux,Recreate the perspective projection of the camera.
v1.3.0-linux,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v1.3.0-linux,Set pose and sleep after to ensure the pose sticks before capturing image.
v1.3.0-linux,Capture segmentation (IR) and scene images.
v1.3.0-linux,Change images into numpy arrays.
v1.3.0-linux,Capture images for a certain amount of time in seconds (half hour now)
v1.3.0-linux,Capture image - pose.position x_val access may change w/ AirSim
v1.3.0-linux,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v1.3.0-linux,Convert color scene image to BGR for write out with cv2.
v1.3.0-linux,"Connect to AirSim, UAV mode."
v1.3.0-linux,Look for objects with names that match a regular expression.
v1.3.0-linux,"Sample calls to main, varying camera angle and altitude."
v1.3.0-linux,"straight down, 400ft"
v1.3.0-linux,"straight down, 200ft"
v1.3.0-linux,"45 degrees, 200ft -- note that often object won't be scene since position"
v1.3.0-linux,is set exactly to object's
v1.3.0-linux,"45 degrees, 400ft -- note that often object won't be scene since position"
v1.3.0-linux,is set exactly to object's
v1.3.0-linux,In settings.json first activate computer vision mode:
v1.3.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.0-linux,xn = 1 + x*5  # some random number
v1.3.0-linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,monitor car state while you drive it manually.
v1.3.0-linux,get state of the car
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,go forward
v1.3.0-linux,get state of the car
v1.3.0-linux,Python client example to change time-of-day using APIs
v1.3.0-linux,
v1.3.0-linux,Changes time of the day and makes the car move around
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,flip between specific time and default time
v1.3.0-linux,go forward
v1.3.0-linux,Go forward + steer right
v1.3.0-linux,main
v1.3.0-linux,import gym #pip install gym
v1.3.0-linux,Local variable access is faster in loops
v1.3.0-linux,"if not wrapping over current pointer,"
v1.3.0-linux,then check if there is terminal state wrapped inside
v1.3.0-linux,"If index > history_length, take from a slice"
v1.3.0-linux,Metrics accumulator
v1.3.0-linux,Action Value model (used by agent to interact with the environment)
v1.3.0-linux,"Target model used to compute the target Q-values in training, updated"
v1.3.0-linux,less frequently for increased stability.
v1.3.0-linux,Function computing Q-values targets as part of the computation graph
v1.3.0-linux,"Define the loss, using Huber Loss (more robust to outliers)"
v1.3.0-linux,Compute the q_targets
v1.3.0-linux,actions is a 1-hot encoding of the action done by the agent
v1.3.0-linux,Define training criterion as the Huber Loss function
v1.3.0-linux,Adam based SGD
v1.3.0-linux,self._trainer.restore_from_checkpoint('models/oldmodels/model800000')
v1.3.0-linux,Append the state to the short term memory (ie. History)
v1.3.0-linux,"If policy requires agent to explore, sample random action"
v1.3.0-linux,Use the network to output the best action
v1.3.0-linux,Append batch axis with only one sample to evaluate
v1.3.0-linux,Return the value maximizing the expected reward
v1.3.0-linux,Keep track of interval action counter
v1.3.0-linux,"If done, reset short term memory (ie. History)"
v1.3.0-linux,Plot the metrics through Tensorboard and reset buffers
v1.3.0-linux,Reset the short term memory
v1.3.0-linux,Append to long term memory
v1.3.0-linux,Update the Target Network if needed
v1.3.0-linux,print(dist)
v1.3.0-linux,Make RL agent
v1.3.0-linux,Train
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,get state of the car
v1.3.0-linux,go forward
v1.3.0-linux,Go forward + steer right
v1.3.0-linux,go reverse
v1.3.0-linux,apply brakes
v1.3.0-linux,get camera images from the car
v1.3.0-linux,restore to original state
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,go forward
v1.3.0-linux,Python client example to get Lidar data from a car
v1.3.0-linux,
v1.3.0-linux,Makes the drone fly and get Lidar data
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,"print(""state: %s"" % s)"
v1.3.0-linux,go forward
v1.3.0-linux,Go forward + steer right
v1.3.0-linux,"reshape array of floats to array of [X,Y,Z]"
v1.3.0-linux,TODO
v1.3.0-linux,main
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,get state of the car
v1.3.0-linux,go forward
v1.3.0-linux,Go forward + steer right
v1.3.0-linux,go reverse
v1.3.0-linux,apply breaks
v1.3.0-linux,restore to original state
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,get camera images from the car
v1.3.0-linux,that's enough fun for now. let's quit cleanly
v1.3.0-linux,Import this module to automatically setup path to local airsim module
v1.3.0-linux,This module first tries to see if airsim module is installed via pip
v1.3.0-linux,If it does then we don't do anything else
v1.3.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.3.0-linux,and if it does then we add that in sys.path
v1.3.0-linux,this class simply tries to see if airsim
v1.3.0-linux,if airsim module is installed then don't do anything else
v1.3.0-linux,import pkgutil
v1.3.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.3.0-linux,if airsim_loader is not None:
v1.3.0-linux,return
v1.3.0-linux,Use below in settings.json with blocks environment
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,get state of the car
v1.3.0-linux,go forward
v1.3.0-linux,go reverse
v1.3.0-linux,apply breaks
v1.3.0-linux,get camera images from the car
v1.3.0-linux,restore to original state
v1.3.0-linux,from keras.models import load_model
v1.3.0-linux,if (len(sys.argv) != 2):
v1.3.0-linux,print('usage: python drive.py <modelName>')
v1.3.0-linux,sys.exit()
v1.3.0-linux,print('Loading model...')
v1.3.0-linux,model = load_model(sys.argv[1])
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.3.0-linux,"model_output = model.predict([image_buf, state_buf])"
v1.3.0-linux,car_controls.steering = float(model_output[0][0])
v1.3.0-linux,!/usr/bin/env python
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,start = time.time()
v1.3.0-linux,get state of the car
v1.3.0-linux,milliseconds = (time.time() - start) * 1000
v1.3.0-linux,populate PoseStamped ros message
v1.3.0-linux,log PoseStamped message
v1.3.0-linux,publish PoseStamped message
v1.3.0-linux,sleeps until next cycle
v1.3.0-linux,!/usr/bin/env python
v1.3.0-linux,Example ROS node for publishing AirSim images.
v1.3.0-linux,AirSim Python API
v1.3.0-linux,ROS Image message
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,get camera images from the car
v1.3.0-linux,Populate image message
v1.3.0-linux,log time and size of published image
v1.3.0-linux,publish image message
v1.3.0-linux,sleep until next cycle
v1.3.0-linux,!/usr/bin/env python
v1.3.0-linux,Example ROS node for publishing AirSim images.
v1.3.0-linux,ROS Image message
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,get camera images from the car
v1.3.0-linux,Populate image message
v1.3.0-linux,log time and size of published image
v1.3.0-linux,publish image message
v1.3.0-linux,sleep until next cycle
v1.3.0-linux,Import this module to automatically setup path to local airsim module
v1.3.0-linux,This module first tries to see if airsim module is installed via pip
v1.3.0-linux,If it does then we don't do anything else
v1.3.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.3.0-linux,and if it does then we add that in sys.path
v1.3.0-linux,this class simply tries to see if airsim
v1.3.0-linux,if airsim module is installed then don't do anything else
v1.3.0-linux,import pkgutil
v1.3.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.3.0-linux,if airsim_loader is not None:
v1.3.0-linux,return
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,MultirotorClient.wait_key('Press any key to takeoff')
v1.3.0-linux,Local variable access is faster in loops
v1.3.0-linux,"if not wrapping over current pointer,"
v1.3.0-linux,then check if there is terminal state wrapped inside
v1.3.0-linux,"If index > history_length, take from a slice"
v1.3.0-linux,Metrics accumulator
v1.3.0-linux,Action Value model (used by agent to interact with the environment)
v1.3.0-linux,"Target model used to compute the target Q-values in training, updated"
v1.3.0-linux,less frequently for increased stability.
v1.3.0-linux,Function computing Q-values targets as part of the computation graph
v1.3.0-linux,"Define the loss, using Huber Loss (more robust to outliers)"
v1.3.0-linux,Compute the q_targets
v1.3.0-linux,actions is a 1-hot encoding of the action done by the agent
v1.3.0-linux,Define training criterion as the Huber Loss function
v1.3.0-linux,Adam based SGD
v1.3.0-linux,Append the state to the short term memory (ie. History)
v1.3.0-linux,"If policy requires agent to explore, sample random action"
v1.3.0-linux,Use the network to output the best action
v1.3.0-linux,Append batch axis with only one sample to evaluate
v1.3.0-linux,Return the value maximizing the expected reward
v1.3.0-linux,Keep track of interval action counter
v1.3.0-linux,"If done, reset short term memory (ie. History)"
v1.3.0-linux,Plot the metrics through Tensorboard and reset buffers
v1.3.0-linux,Reset the short term memory
v1.3.0-linux,Append to long term memory
v1.3.0-linux,Update the Target Network if needed
v1.3.0-linux,print(dist)
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,Make RL agent
v1.3.0-linux,Train
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,get camera images from the car
v1.3.0-linux,that's enough fun for now. let's quit cleanly
v1.3.0-linux,teleport the drone + 10 meters in x-direction
v1.3.0-linux,teleport the drone back
v1.3.0-linux,use open cv to create point cloud from depth image.
v1.3.0-linux,###########################################
v1.3.0-linux,######### This is work in progress! #######
v1.3.0-linux,###########################################
v1.3.0-linux,file will be saved in PythonClient folder (i.e. same folder as script)
v1.3.0-linux,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.3.0-linux,skip it
v1.3.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.3.0-linux,z of -7 is 7 meters above the original launch point.
v1.3.0-linux,Fly given velocity vector for 5 seconds
v1.3.0-linux,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.3.0-linux,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.3.0-linux,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.3.0-linux,Make the drone fly in a circle.
v1.3.0-linux,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.3.0-linux,check that our home position is stable
v1.3.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.3.0-linux,ramp up time
v1.3.0-linux,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.3.0-linux,compute current angle
v1.3.0-linux,compute lookahead
v1.3.0-linux,if we did the takeoff then also do the landing.
v1.3.0-linux,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.3.0-linux,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.3.0-linux,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.3.0-linux,ignore the click over from 360 back to 0
v1.3.0-linux,watch direction this diff is moving if it switches from shrinking to growing
v1.3.0-linux,then we passed the starting point.
v1.3.0-linux,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.3.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.3.0-linux,z of -7 is 7 meters above the original launch point.
v1.3.0-linux,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.3.0-linux,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.3.0-linux,drone will over-shoot so we bring it back to the start point before landing.
v1.3.0-linux,change clock speed in settings.json
v1.3.0-linux,"""ClockSpeed"": 0.5"
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,that's enough fun for now. let's quit cleanly
v1.3.0-linux,In settings.json first activate computer vision mode:
v1.3.0-linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.3.0-linux,pip install opencv-python
v1.3.0-linux,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.3.0-linux,Python client example to get Lidar data from a drone
v1.3.0-linux,
v1.3.0-linux,Makes the drone fly and get Lidar data
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,"print(""state: %s"" % s)"
v1.3.0-linux,"print(""state: %s"" % pprint.pformat(state))"
v1.3.0-linux,"reshape array of floats to array of [X,Y,Z]"
v1.3.0-linux,TODO
v1.3.0-linux,main
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,AirSim uses NED coordinates so negative axis is up.
v1.3.0-linux,let it settle there a bit.
v1.3.0-linux,after hovering we need to re-enabled api control for next leg of the trip
v1.3.0-linux,now compute the survey path required to fill the box
v1.3.0-linux,Use below in settings.json with Blocks environment
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,get camera images from the car
v1.3.0-linux,that's enough fun for now. let's quit cleanly
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,Import this module to automatically setup path to local airsim module
v1.3.0-linux,This module first tries to see if airsim module is installed via pip
v1.3.0-linux,If it does then we don't do anything else
v1.3.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.3.0-linux,and if it does then we add that in sys.path
v1.3.0-linux,this class simply tries to see if airsim
v1.3.0-linux,if airsim module is installed then don't do anything else
v1.3.0-linux,import pkgutil
v1.3.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.3.0-linux,if airsim_loader is not None:
v1.3.0-linux,return
v1.3.0-linux,"this script moves the drone to a location, then rests it thousands of time"
v1.3.0-linux,purpose of this script is to stress test reset API
v1.3.0-linux,connect to the AirSim simulator
v1.3.0-linux,that's enough fun for now. let's quite cleanly
v1.3.0-linux,use open cv to show new images from AirSim
v1.3.0-linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.3.0-linux,pip install opencv-python
v1.3.0-linux,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.3.0-linux,get depth image
v1.3.0-linux,"this will return png width= 256, height= 144"
v1.3.0-linux,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.3.0-linux,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.3.0-linux,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.3.0-linux,to get an estimate of distance.
v1.3.0-linux,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.3.0-linux,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.3.0-linux,an angular delta of the following pi/10.
v1.3.0-linux,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.3.0-linux,Remove alpha channel if exists
v1.3.0-linux,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.3.0-linux,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.3.0-linux,Flatten and yield as tuple
v1.3.0-linux,Initialize a resizable dataset to hold the output
v1.3.0-linux,Resize the dataset to accommodate the next chunk of rows
v1.3.0-linux,Create the next chunk
v1.3.0-linux,Increment the row count
v1.3.0-linux,Arguments
v1.3.0-linux,Returns
v1.3.0-linux,use composition of homographies
v1.3.0-linux,to generate final transform that needs to be applied
v1.3.0-linux,Arguments
v1.3.0-linux,Returns
v1.3.0-linux,Keeps under lock only the mechanism which advances
v1.3.0-linux,the indexing of each batch.
v1.3.0-linux,The transformation of images is not under thread lock
v1.3.0-linux,so it can be done in parallel
v1.3.0-linux,Trained model path
v1.3.0-linux,Connect to AirSim
v1.3.0-linux,Start driving
v1.3.0-linux,Initialize image buffer
v1.3.0-linux,Update throttle value according to steering angle
v1.3.0-linux,Prediction
v1.3.0-linux,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.3.0-linux,Print progress
v1.3.0-linux,Update next car state
v1.3.0-linux,Wait a bit between iterations
v1.3.0-linux,%matplotlib inline
v1.3.0-linux,chunk size for training batches
v1.3.0-linux,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.3.0-linux,Point this to the directory containing the raw data
v1.3.0-linux,Point this to the desired output directory for the cooked (.h5) data
v1.3.0-linux,Choose The folders to search for data under RAW_DATA_DIR
v1.3.0-linux,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.3.0-linux,data_folder.append('folder_name1')
v1.3.0-linux,data_folder.append('folder_name2')
v1.3.0-linux,...
v1.3.0-linux,Hyper-parameters
v1.3.0-linux,Activation functions
v1.3.0-linux,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.3.0-linux,<< The directory containing the cooked data from the previous step >>
v1.3.0-linux,<< The directory in which the model output will be placed >>
v1.3.0-linux,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.3.0-linux,Network definition
v1.3.0-linux,Import this module to automatically setup path to local airsim module
v1.3.0-linux,This module first tries to see if airsim module is installed via pip
v1.3.0-linux,If it does then we don't do anything else
v1.3.0-linux,Else we look up grand-parent folder to see if it has airsim folder
v1.3.0-linux,and if it does then we add that in sys.path
v1.3.0-linux,this class simply tries to see if airsim
v1.3.0-linux,if airsim module is installed then don't do anything else
v1.3.0-linux,import pkgutil
v1.3.0-linux,airsim_loader = pkgutil.find_loader('airsim')
v1.3.0-linux,if airsim_loader is not None:
v1.3.0-linux,return
v1.3.0-linux,DEY: I don't know why this was there.
v1.3.0-linux,-----------------------------------  Common vehicle APIs ---------------------------------------------
v1.3.0-linux,basic flight control
v1.3.0-linux,time-of-day control
v1.3.0-linux,weather
v1.3.0-linux,camera control
v1.3.0-linux,simGetImage returns compressed png in array of bytes
v1.3.0-linux,image_type uses one of the ImageType members
v1.3.0-linux,"todo: in future remove below, it's only for compatibility to pre v1.2"
v1.3.0-linux,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.3.0-linux,camera control
v1.3.0-linux,simGetImage returns compressed png in array of bytes
v1.3.0-linux,image_type uses one of the ImageType members
v1.3.0-linux,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.3.0-linux,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.3.0-linux,sensor APIs
v1.3.0-linux,Plotting APIs
v1.3.0-linux,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.3.0-linux,APIs for control
v1.3.0-linux,low-level control API
v1.3.0-linux,query vehicle state
v1.3.0-linux,-----------------------------------  Car APIs ---------------------------------------------
v1.3.0-linux,helper method for converting getOrientation to roll/pitch/yaw
v1.3.0-linux,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.3.0-linux,roll (x-axis rotation)
v1.3.0-linux,pitch (y-axis rotation)
v1.3.0-linux,yaw (z-axis rotation)
v1.3.0-linux,DEY: I don't know why this was there.
v1.3.0-linux,reverse the vertical line order and add null bytes at the start
v1.3.0-linux,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.3.0-linux,return cls(**msgpack.unpack(encoded))
v1.3.0-linux,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.3.0-linux,"in header only mode, control library is not available"
v1.3.0-linux,if using Unreal Build system then include precompiled header file first
v1.3.0-linux,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.3.0-linux,"Windows, OSX and Linux."
v1.3.0-linux,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.3.0-linux,Windows users can move the Documents folder to any location they want
v1.3.0-linux,SHGetFolderPath knows how to find it.
v1.3.0-linux,fall back in case SHGetFolderPath failed for some reason.
v1.3.0-linux,convert from std::path '/' to windows backslash.
v1.3.0-linux,make the current thread run with maximum priority.
v1.3.0-linux,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.3.0-linux,TODO: How to handle POSIX thread priorities on OSX?
v1.3.0-linux,setThreadName is a helper function that is useful when debugging because your threads
v1.3.0-linux,show up in the debugger with the name you set which makes it easier to find the threads
v1.3.0-linux,that you are interested in.
v1.3.0-linux,"unfortunately this is only available on Windows 10, and AirSim is not limited to that."
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.3.0-linux,
v1.3.0-linux,Treat all errors as failure conditions.
v1.3.0-linux,parse command line
v1.3.0-linux,"motive gives a weird error if the project is not found, so we look for it."
v1.3.0-linux,Do an update to pick up any recently-arrived cameras.
v1.3.0-linux,List all detected cameras.
v1.3.0-linux,List all defined rigid bodies.
v1.3.0-linux,throttle to 50 messages per second.
v1.3.0-linux,OptiTrack uses 'y' axis for vertical.
v1.3.0-linux,stdafx.cpp : source file that includes just the standard includes
v1.3.0-linux,MavlinkMoCap.pch will be the pre-compiled header
v1.3.0-linux,stdafx.obj will contain the pre-compiled type information
v1.3.0-linux,TODO: reference any additional headers you need in STDAFX.H
v1.3.0-linux,and not in this file
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,PX4.cpp : Defines the entry point for the console application.
v1.3.0-linux,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.3.0-linux,how do you write to the debug output windows on Unix ?
v1.3.0-linux,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.3.0-linux,connection to create to talke to that server.
v1.3.0-linux,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.3.0-linux,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.3.0-linux,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.3.0-linux,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.3.0-linux,using their the -qgc option.
v1.3.0-linux,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.3.0-linux,this switch controls whether we turn off the RC remote active link loss detection
v1.3.0-linux,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.3.0-linux,from kicking in when you try and fly.
v1.3.0-linux,can't use experimental stuff on Linux because of potential ABI issues
v1.3.0-linux,parse the json
v1.3.0-linux,flatten inner mavlink object
v1.3.0-linux,flatten inner mavlink object
v1.3.0-linux,todo
v1.3.0-linux,todo
v1.3.0-linux,"const char* outLogFileOption = ""outlogfile"";"
v1.3.0-linux,parse command line
v1.3.0-linux,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.3.0-linux,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.3.0-linux,"no local serial connection, so this is the primary droneConnection."
v1.3.0-linux,failed to connect
v1.3.0-linux,"local connection, then we own sending the heartbeat."
v1.3.0-linux,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.3.0-linux,cmdTable.push_back(new AltHoldCommand());
v1.3.0-linux,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.3.0-linux,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.3.0-linux,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.3.0-linux,this stops us from being able to connect to SITL mode PX4.
v1.3.0-linux,checkPulse();
v1.3.0-linux,add command text in log
v1.3.0-linux,close previous command.
v1.3.0-linux,FilterLogFiles(logDirectory);
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,send a heartbeat
v1.3.0-linux,accept one incoming connection
v1.3.0-linux,send a heartbeat to the client
v1.3.0-linux,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.3.0-linux,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.3.0-linux,for this unit test we are expecting a request to send an image.
v1.3.0-linux,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.3.0-linux,hmmm
v1.3.0-linux,================ ls
v1.3.0-linux,================ put file
v1.3.0-linux,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.3.0-linux,================ get file
v1.3.0-linux,verify the file contents.
v1.3.0-linux,================ remove file
v1.3.0-linux,================ make directory
v1.3.0-linux,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.3.0-linux,================ remove directory
v1.3.0-linux,Now verification
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,from main.cpp.
v1.3.0-linux,you must call this method if you want HandleMessage to be called subsequently.
v1.3.0-linux,treat literals as one word
v1.3.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.3.0-linux,request gps info
v1.3.0-linux,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.3.0-linux,find relative position since command start so we can compare two commands better
v1.3.0-linux,TODO: make below future proof (i.e. usable by C++17 compiler) - also change same in main.cpp
v1.3.0-linux,can't use experimental stuff on Linux because of potential ABI issues
v1.3.0-linux,"these PID values are important, so set these to match"
v1.3.0-linux,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.3.0-linux,we can skip ahead.
v1.3.0-linux,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.3.0-linux,TODO: avoid passing hadcoded HIL flag
v1.3.0-linux,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.3.0-linux,"The global position, as returned by the Global Positioning System (GPS)."
v1.3.0-linux,Provides state for additional features
v1.3.0-linux,The general system state
v1.3.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.3.0-linux,Provides state for additional features
v1.3.0-linux,The general system state
v1.3.0-linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.3.0-linux,Provides state for additional features
v1.3.0-linux,The general system state
v1.3.0-linux,Provides state for additional features
v1.3.0-linux,The general system state
v1.3.0-linux,note: we do not reset com when Close() is called because we want to keep running.
v1.3.0-linux,"user has to invoke ""hil stop"" to stop the hil thread."
v1.3.0-linux,generate random between 0 and 1
v1.3.0-linux,move to range -1 to 1
v1.3.0-linux,scale it
v1.3.0-linux,apply iy
v1.3.0-linux,wait for the Execute method to be called.
v1.3.0-linux,gps is much slower frequency than IMU.
v1.3.0-linux,MAVLINK_MSG_ID_HIL_GPS
v1.3.0-linux,disable MAV_USEHILGPS
v1.3.0-linux,note: we do not reset com when Close() is called because we want to keep running.
v1.3.0-linux,"user has to invoke ""hil stop"" to stop the hil thread."
v1.3.0-linux,generate random between 0 and 1
v1.3.0-linux,move to range -1 to 1
v1.3.0-linux,scale it
v1.3.0-linux,apply iy
v1.3.0-linux,wait for the Execute method to be called.
v1.3.0-linux,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.3.0-linux,gps is much slower frequency than IMU.
v1.3.0-linux,MAVLINK_MSG_ID_HIL_GPS
v1.3.0-linux,disable HIL mode
v1.3.0-linux,Enumeration of landed detector states
v1.3.0-linux,MAV landed state is unknown
v1.3.0-linux,MAV is landed (on ground)
v1.3.0-linux,MAV is in air
v1.3.0-linux,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.3.0-linux,The filtered local position
v1.3.0-linux,must send these regularly to keep offboard control.
v1.3.0-linux,"ok, now we can safely switch to loiter."
v1.3.0-linux,must send these regularly to keep offboard control.
v1.3.0-linux,integrate the heading so it is smoother.
v1.3.0-linux,must send these regularly to keep offboard control.
v1.3.0-linux,integrate the heading so it is smoother.
v1.3.0-linux,fly to radius
v1.3.0-linux,it takes about 10 cm to stop and turn.
v1.3.0-linux,next time around switch to orbiting!
v1.3.0-linux,heading points to center of circle.
v1.3.0-linux,interpoloate the speed ramp up time over 2 seconds from start time
v1.3.0-linux,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.3.0-linux,monitor the sin curves so we can see how on track or off track it actually is.
v1.3.0-linux,the shape of the curve will also tell us if we are progressing at a consistent
v1.3.0-linux,"speed, the more deformed the sin curve the worse our progress."
v1.3.0-linux,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.3.0-linux,degrees just flipped from 359 to 0.
v1.3.0-linux,this enables us to test what happens when offboard control is lost and resumed.
v1.3.0-linux,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.3.0-linux,"ok, now we can start moving by velocity"
v1.3.0-linux,recompute to new target.
v1.3.0-linux,start by moving right with 10 degree roll.
v1.3.0-linux,haven't started yet.
v1.3.0-linux,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.3.0-linux,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.3.0-linux,track how our actual pitch is coming along compared to our target
v1.3.0-linux,and check position
v1.3.0-linux,the amount of pitch should depend on our speed in that direction.
v1.3.0-linux,passed the midpoint.
v1.3.0-linux,fade out the pitch as we pick up speed so we don't overshoot.
v1.3.0-linux,see if we just crossed the wiggle distance threshold.
v1.3.0-linux,(pitch affects the x-position).
v1.3.0-linux,reverse direction with a -30 degrees quick stop
v1.3.0-linux,reverse direction with a 30 degrees quick stop
v1.3.0-linux,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.3.0-linux,too much in that direction.
v1.3.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.3.0-linux,track how our actual roll is coming along compared to our target
v1.3.0-linux,and check position
v1.3.0-linux,the amount of roll should depend on our speed in that direction.
v1.3.0-linux,passed the midpoint.
v1.3.0-linux,fade out the roll as we pick up speed so we don't overshoot.
v1.3.0-linux,see if we just crossed the wiggle distance threshold.
v1.3.0-linux,(roll affects the y-position).
v1.3.0-linux,reverse direction with a -30 degrees quick stop
v1.3.0-linux,reverse direction with a 30 degrees quick stop
v1.3.0-linux,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.3.0-linux,too much in that direction.
v1.3.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.3.0-linux,for testing PID controller.
v1.3.0-linux,class AltHoldCommand : public Command
v1.3.0-linux,{
v1.3.0-linux,std::shared_ptr<MavLinkVehicle> channel;
v1.3.0-linux,"float sx_, sy_, sz_;"
v1.3.0-linux,MavLinkAttitudeTarget _current;
v1.3.0-linux,PidController thrust_controller_;
v1.3.0-linux,public:
v1.3.0-linux,this->sz_ = pos.z; // user defined target.
v1.3.0-linux,move to local position keeps the offboard control happy.
v1.3.0-linux,haven't started yet.
v1.3.0-linux,and check position
v1.3.0-linux,double dx = this->sx_ - pos.x;
v1.3.0-linux,double dy = this->sy_ - pos.y;
v1.3.0-linux,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.3.0-linux,too much in that direction.
v1.3.0-linux,adjust thrust so we keep steady height target
v1.3.0-linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.3.0-linux,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.3.0-linux,local remote
v1.3.0-linux,already handled by the parse method.
v1.3.0-linux,we only support very simple patterns for now.
v1.3.0-linux,each wildcard must be separated by literal.
v1.3.0-linux,back to back wildcards with no literal in between is too complex.
v1.3.0-linux,"we only support simple matching for now, we can add full regex later if we need it."
v1.3.0-linux,yep!
v1.3.0-linux,'*' is done we found the next matching char
v1.3.0-linux,this is ok.
v1.3.0-linux,this is an ERASE_END_LINE command which we ignore.
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,unpack the message...
v1.3.0-linux,pack the payload buffer.
v1.3.0-linux,"json can't handle ""nan"", so we convert it to null."
v1.3.0-linux,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.3.0-linux,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,start listening to this connection
v1.3.0-linux,Send heartbeat to drone.  You should not do this if some other node is
v1.3.0-linux,already doing it.
v1.3.0-linux,stop listening to the connection.
v1.3.0-linux,get the connection
v1.3.0-linux,Get the local system and component id
v1.3.0-linux,send a command to the remote node
v1.3.0-linux,MavLinkNode::MavLinkNode() = default;
v1.3.0-linux,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.3.0-linux,decrementing the count so the next WaitOne may block.
v1.3.0-linux,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.3.0-linux,convert to absolute time.
v1.3.0-linux,use mach_timespec
v1.3.0-linux,convert to absolute time.
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,return true if we still have offboard control (can lose this if user flips the switch).
v1.3.0-linux,MavLinkVehicle::MavLinkVehicle() = default;
v1.3.0-linux,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.3.0-linux,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,============================== CLIENT ============================================
v1.3.0-linux,image APIs
v1.3.0-linux,or if you are implementing the client side call this function to get the most recent frame.
v1.3.0-linux,returns false if there is no new frame available.
v1.3.0-linux,============================== SERVER ============================================
v1.3.0-linux,call this to send the image back over the connection given to start function.
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,"log every message that is ""sent"" using sendMessage."
v1.3.0-linux,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.3.0-linux,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.3.0-linux,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.3.0-linux,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,for compatibility with QGroundControl we have to save the time field in big endian.
v1.3.0-linux,todo: mavlink2 support?
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,start listening to this connection
v1.3.0-linux,Send heartbeat to drone.  You should not do this if some other node is
v1.3.0-linux,already doing it.
v1.3.0-linux,this is called for all messages received on the connection.
v1.3.0-linux,"we received a heartbeat, so let's get the capabilities."
v1.3.0-linux,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.3.0-linux,subclasses remembering to call this base implementation.
v1.3.0-linux,stop listening to the connection.
v1.3.0-linux,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.3.0-linux,wait for a heartbeat msg since this will give us the port to send commands to...
v1.3.0-linux,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.3.0-linux,send a heart beat so that the remote node knows we are still alive
v1.3.0-linux,(otherwise drone will trigger a failsafe operation).
v1.3.0-linux,ignore any failures here because we are running in our own thread here.
v1.3.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.0-linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.0-linux,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.3.0-linux,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.3.0-linux,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.3.0-linux,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.3.0-linux,"ok, now fetch the missing parameters."
v1.3.0-linux,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.3.0-linux,silently fail since we are on a background thread here...
v1.3.0-linux,tell the caller this is complete.
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,add our custom telemetry message length.
v1.3.0-linux,todo: if we support signing then initialize
v1.3.0-linux,mavlink_intermediate_status_.signing callbacks
v1.3.0-linux,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.3.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.3.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.3.0-linux,send this right away just in case serial link is not already configured
v1.3.0-linux,"log every message that is ""sent"" using sendMessage."
v1.3.0-linux,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.3.0-linux,pack the payload buffer.
v1.3.0-linux,calculate checksum
v1.3.0-linux,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.3.0-linux,are variable length as a result.
v1.3.0-linux,form the header as a byte array for the crc
v1.3.0-linux,these macros use old style cast.
v1.3.0-linux,forward messages from our connected node to the remote proxy.
v1.3.0-linux,tell the remote connection to expect mavlink2 messages.
v1.3.0-linux,forward messages from remote proxy to local connected node
v1.3.0-linux,CurrentThread::setMaximumPriority();
v1.3.0-linux,"hmmm, wait till it is opened?"
v1.3.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.3.0-linux,pick up the sysid/compid of the remote node we are connected to.
v1.3.0-linux,then this is a mavlink 1 message
v1.3.0-linux,then this mavlink sender supports mavlink 2
v1.3.0-linux,queue event for publishing.
v1.3.0-linux,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.3.0-linux,as it ensures we don't lose messages if the listener is slow.
v1.3.0-linux,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.3.0-linux,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.3.0-linux,we would get a deadlock.
v1.3.0-linux,CurrentThread::setMaximumPriority();
v1.3.0-linux,reset counters
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,------------------------------------------------------------------------------
v1.3.0-linux,Defines
v1.3.0-linux,------------------------------------------------------------------------------
v1.3.0-linux,bit number  876543210987654321
v1.3.0-linux,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.3.0-linux,in future it would be good to have ability to add system IDs we are interested in
v1.3.0-linux,if (msg.sysid != getTargetSystemId())
v1.3.0-linux,{
v1.3.0-linux,// we only care about messages from our intended remote node.
v1.3.0-linux,return;
v1.3.0-linux,}
v1.3.0-linux,user may have changed modes on us! So we need to honor that and not
v1.3.0-linux,try and take it back.
v1.3.0-linux,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.3.0-linux,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.3.0-linux,we can store up to 16 channels in rc_channels_scaled.
v1.3.0-linux,The RAW values of the servo outputs
v1.3.0-linux,Metrics typically displayed on a HUD for fixed wing aircraft
v1.3.0-linux,The IMU readings in SI units in NED body frame
v1.3.0-linux,printSystemStatus(&msg);
v1.3.0-linux,todo: use this to determine when we need to do emergency landing...
v1.3.0-linux,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.3.0-linux,Provides state for additional features
v1.3.0-linux,The general system state
v1.3.0-linux,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.3.0-linux,but we do want to know when we get the ack.  So this is async ACK processing!
v1.3.0-linux,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.3.0-linux,if threshold < 0 then the threshold is inverted.
v1.3.0-linux,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.3.0-linux,Convert it to a floating point number between -1 and 1.
v1.3.0-linux,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.3.0-linux,until the move commands start happening.
v1.3.0-linux,return true if user calls requestControl and has not called releaseControl.
v1.3.0-linux,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.3.0-linux,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.3.0-linux,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.3.0-linux,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.3.0-linux,send a few to make sure it gets through...
v1.3.0-linux,now the command should succeed.
v1.3.0-linux,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.3.0-linux,us by which time the PX4 times out offboard mode!!
v1.3.0-linux,this mode change take precedence over offboard mode.
v1.3.0-linux,thrust must be between -1 and 1.
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,These definitions are copied from PX4 implementation
v1.3.0-linux,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.3.0-linux,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.3.0-linux,/ @brief Command opcodes
v1.3.0-linux,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.3.0-linux,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.3.0-linux,must trim trailing slashes so PX4 doesn't hang!
v1.3.0-linux,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.3.0-linux,from the source.
v1.3.0-linux,check if directory exists.
v1.3.0-linux,perfect.
v1.3.0-linux,use last_message_ so we preserve the sessionid.
v1.3.0-linux,"could not create the local file, so stop."
v1.3.0-linux,must use last_message_ so we preserve the session id.
v1.3.0-linux,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.3.0-linux,todo: error handling here? sequence is out of order...
v1.3.0-linux,"directory must be empty then, can't do nextStep because"
v1.3.0-linux,it will just loop for ever re-requesting zero offset into
v1.3.0-linux,empty directory.
v1.3.0-linux,result should be a list of null terminated file names.
v1.3.0-linux,skipping this entry
v1.3.0-linux,remove the file size field.
v1.3.0-linux,"printf(""%s\n"", name.c_str());"
v1.3.0-linux,request the next batch.
v1.3.0-linux,"perhaps this was a late response after we did a retry, so ignore it."
v1.3.0-linux,"perhaps this was a late response after we did a retry, so ignore it."
v1.3.0-linux,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.3.0-linux,reached the end of the list or the file.
v1.3.0-linux,end of file or directory listing.
v1.3.0-linux,"success, data should be following..."
v1.3.0-linux,ack on this cmd is a noop
v1.3.0-linux,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.3.0-linux,give up then.
v1.3.0-linux,tell watchdog we are sending a request
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,================================= CLIENT ==============================================================
v1.3.0-linux,Check if we have a valid transaction
v1.3.0-linux,emit signal if all packets arrived
v1.3.0-linux,Restart statemachine
v1.3.0-linux,image APIs
v1.3.0-linux,================================= SERVER ==============================================================
v1.3.0-linux,Prepare and send acknowledgment packet
v1.3.0-linux,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.3.0-linux,Send ENCAPSULATED_IMAGE packet
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.3.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.3.0-linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.3.0-linux,send this right away just in case serial link is not already configured
v1.3.0-linux,CurrentThread::setMaximumPriority();
v1.3.0-linux,"hmmm, wait till it is opened?"
v1.3.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.3.0-linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.3.0-linux,queue event for publishing.
v1.3.0-linux,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.3.0-linux,as it ensures we don't lose messages if the listener is slow.
v1.3.0-linux,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.3.0-linux,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.3.0-linux,we would get a deadlock.
v1.3.0-linux,CurrentThread::setMaximumPriority();
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.3.0-linux,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.3.0-linux,parse out the VID number
v1.3.0-linux,now the PID
v1.3.0-linux,parse out the VID number
v1.3.0-linux,examples:
v1.3.0-linux,PX4: USB\VID_26AC&PID_0011\0
v1.3.0-linux,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.3.0-linux,"printf(""Found: %S\n"", buffer.c_str());"
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.3.0-linux,parse out the VID number
v1.3.0-linux,now the PID
v1.3.0-linux,parse out the VID number
v1.3.0-linux,suppress
v1.3.0-linux,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,This has not been properly tested
v1.3.0-linux,struct iw_statistics stats;
v1.3.0-linux,struct iwreq req;
v1.3.0-linux,"memset(&stats, 0, sizeof(stats));"
v1.3.0-linux,"memset(&req, 0, sizeof(iwreq));"
v1.3.0-linux,
v1.3.0-linux,"strncpy(req.ifr_name, ifaceName, 16);"
v1.3.0-linux,req.u.data.pointer = &stats;
v1.3.0-linux,req.u.data.length = sizeof(iw_statistics);
v1.3.0-linux,
v1.3.0-linux,#ifdef CLEAR_UPDATED
v1.3.0-linux,req.u.data.flags = 1;
v1.3.0-linux,#endif
v1.3.0-linux,
v1.3.0-linux,/* Perform the ioctl */
v1.3.0-linux,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.3.0-linux,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.3.0-linux,return -127;
v1.3.0-linux,}
v1.3.0-linux,
v1.3.0-linux,return stats.qual.level;
v1.3.0-linux,todo: windows version of this...
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,windows
v1.3.0-linux,Need to link with Ws2_32.lib
v1.3.0-linux,posix
v1.3.0-linux,found it!
v1.3.0-linux,bind socket to local address.
v1.3.0-linux,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.3.0-linux,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.3.0-linux,write to the serial port
v1.3.0-linux,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.3.0-linux,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.3.0-linux,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.3.0-linux,"try and receive something, up until port is closed anyway."
v1.3.0-linux,"message was too large for the buffer, no problem, return what we have."
v1.3.0-linux,try again - this can happen if server recreates the socket on their side.
v1.3.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.3.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.3.0-linux,"printf(""#### recv failed with error: %d\n"", hr);"
v1.3.0-linux,we now have it.
v1.3.0-linux,this is from someone we are not interested in.
v1.3.0-linux,-----------------------------------------------------------------------------------------
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,Initialize Winsock
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,windows
v1.3.0-linux,Need to link with Ws2_32.lib
v1.3.0-linux,posix
v1.3.0-linux,found it!
v1.3.0-linux,bind socket to local address.
v1.3.0-linux,bind socket to local address.
v1.3.0-linux,start listening for incoming connection
v1.3.0-linux,accept 1
v1.3.0-linux,"don't need to accept any more, so we can close this one."
v1.3.0-linux,write to the serial port
v1.3.0-linux,"try and receive something, up until port is closed anyway."
v1.3.0-linux,"message was too large for the buffer, no problem, return what we have."
v1.3.0-linux,try again - this can happen if server recreates the socket on their side.
v1.3.0-linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.3.0-linux,try again - this can happen if server recreates the socket on their side.
v1.3.0-linux,-----------------------------------------------------------------------------------------
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.3.0-linux,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.3.0-linux,set signal
v1.3.0-linux,Clear Handshake flags
v1.3.0-linux,Set Handshake flags
v1.3.0-linux,return GetLastError();
v1.3.0-linux,return GetLastError();
v1.3.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.3.0-linux,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.3.0-linux,enable reading
v1.3.0-linux,posix doesn't have mark/space parity.
v1.3.0-linux,posix doesn't have mark/space parity.
v1.3.0-linux,this is the default.
v1.3.0-linux,not sure this is supported...
v1.3.0-linux,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.3.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.3.0-linux,First do those specified by POSIX.
v1.3.0-linux,Now conditionally handle a bunch of extended rates.
v1.3.0-linux,First do those specified by POSIX.
v1.3.0-linux,Now conditionally handle a bunch of extended rates.
v1.3.0-linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.3.0-linux,import airsim
v1.3.0-linux,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v1.3.0-linux,self.args = args
v1.3.0-linux,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v1.3.0-linux,pdb.set_trace()
v1.3.0-linux,#include <pluginlib/class_list_macros.h>
v1.3.0-linux,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v1.3.0-linux,intitialize placeholder control commands
v1.3.0-linux,vel_cmd_ = VelCmd();
v1.3.0-linux,gimbal_cmd_ = GimbalCmd();
v1.3.0-linux,todo do not reset if already in air?
v1.3.0-linux,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.3.0-linux,ros params
v1.3.0-linux,todo enforce dynamics constraints in this node as well?
v1.3.0-linux,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v1.3.0-linux,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v1.3.0-linux,XmlRpc::XmlRpcValue can't be const in this case
v1.3.0-linux,subscribe to control commands on global nodehandle
v1.3.0-linux,vehicle_setting_vec_.clear();
v1.3.0-linux,vehicle_imu_map_;
v1.3.0-linux,callback_queues_.clear();
v1.3.0-linux,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.3.0-linux,auto vehicle_setting_local = vehicle_setting.get();
v1.3.0-linux,bind to a single callback. todo optimal subs queue length
v1.3.0-linux,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.3.0-linux,"multirotor_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.3.0-linux,"iterate over camera map std::map<std::string, CameraSetting> cameras;"
v1.3.0-linux,vehicle_setting_vec_.push_back(*vehicle_setting.get());
v1.3.0-linux,camera_setting.gimbal
v1.3.0-linux,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.3.0-linux,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.3.0-linux,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.3.0-linux,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.3.0-linux,"if {DepthPlanner, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.3.0-linux,"push back pair (vector of image captures, current vehicle name)"
v1.3.0-linux,"iterate over sensors std::map<std::string, std::unique_ptr<SensorSetting>> sensors;"
v1.3.0-linux,"todo this is pretty non scalable, refactor airsim and ros api and maintain a vehicle <-> sensor (setting) map"
v1.3.0-linux,add takeoff and land all services if more than 2 drones
v1.3.0-linux,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v1.3.0-linux,todo add per vehicle reset in AirLib API
v1.3.0-linux,todo mimic gazebo's /use_sim_time feature which publishes airsim's clock time..via an rpc call?!
v1.3.0-linux,"clock_pub_ = nh_private_.advertise<rosgraph_msgs::Clock>(""clock"", 10);"
v1.3.0-linux,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.3.0-linux,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v1.3.0-linux,"todo: error check. if state is not landed, return error."
v1.3.0-linux,response.success =
v1.3.0-linux,response.success =
v1.3.0-linux,response.success =
v1.3.0-linux,response.success =
v1.3.0-linux,response.success =
v1.3.0-linux,response.success =
v1.3.0-linux,todo add reset by vehicle_name API to airlib
v1.3.0-linux,todo not async remove waitonlasttask
v1.3.0-linux,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v1.3.0-linux,todo do actual body frame?
v1.3.0-linux,airsim uses degrees
v1.3.0-linux,todo do actual body frame?
v1.3.0-linux,airsim uses degrees
v1.3.0-linux,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v1.3.0-linux,todo expose waitOnLastTask or nah?
v1.3.0-linux,todo do actual body frame?
v1.3.0-linux,airsim uses degrees
v1.3.0-linux,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.3.0-linux,todo expose waitOnLastTask or nah?
v1.3.0-linux,todo support multiple gimbal commands
v1.3.0-linux,todo support multiple gimbal commands
v1.3.0-linux,1. find quaternion of default gimbal pose
v1.3.0-linux,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.3.0-linux,3. call airsim client's setcameraorientation which sets camera orientation wrt world (or takeoff?) ned frame. todo
v1.3.0-linux,odom_ned_msg.header.frame_id = world_frame_id_;
v1.3.0-linux,"odom_ned_msg.child_frame_id = ""/airsim/odom_local_ned""; // todo make param"
v1.3.0-linux,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.3.0-linux,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.3.0-linux,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.3.0-linux,msg = []
v1.3.0-linux,todo covariances
v1.3.0-linux,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.3.0-linux,todo radians per second
v1.3.0-linux,meters/s2^m
v1.3.0-linux,imu_msg.orientation_covariance = ;
v1.3.0-linux,imu_msg.angular_velocity_covariance = ;
v1.3.0-linux,imu_msg.linear_acceleration_covariance = ;
v1.3.0-linux,todo unused
v1.3.0-linux,void AirsimROSWrapper::set_zero_vel_cmd()
v1.3.0-linux,{
v1.3.0-linux,vel_cmd_.x = 0.0;
v1.3.0-linux,vel_cmd_.y = 0.0;
v1.3.0-linux,vel_cmd_.z = 0.0;
v1.3.0-linux,vel_cmd_.drivetrain = msr::airlib::DrivetrainType::MaxDegreeOfFreedom;
v1.3.0-linux,vel_cmd_.yaw_mode.is_rate = false;
v1.3.0-linux,// todo make class member or a fucntion
v1.3.0-linux,"double roll, pitch, yaw;"
v1.3.0-linux,"tf2::Matrix3x3(get_tf2_quat(curr_drone_state_.kinematics_estimated.pose.orientation)).getRPY(roll, pitch, yaw); // ros uses xyzw"
v1.3.0-linux,vel_cmd_.yaw_mode.yaw_or_rate = yaw;
v1.3.0-linux,}
v1.3.0-linux,todo this is global origin
v1.3.0-linux,iterate over drones
v1.3.0-linux,get drone state from airsim
v1.3.0-linux,convert airsim drone state to ROS msgs
v1.3.0-linux,publish to ROS!
v1.3.0-linux,send control commands from the last callback to airsim
v1.3.0-linux,"""clear"" control cmds"
v1.3.0-linux,IMUS
v1.3.0-linux,imu_msg.header.stamp = ros::Time::now();
v1.3.0-linux,"we've sent these static transforms, so no need to keep sending them"
v1.3.0-linux,todo add and expose a gimbal angular velocity to airlib
v1.3.0-linux,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.3.0-linux,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.3.0-linux,std::lock_guard<std::recursive_mutex> guard(drone_control_mutex_);
v1.3.0-linux,std::lock_guard<std::recursive_mutex> guard(lidar_mutex_);
v1.3.0-linux,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.3.0-linux,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.3.0-linux,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.3.0-linux,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.3.0-linux,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.3.0-linux,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.3.0-linux,"if a render request failed for whatever reason, this img will be empty."
v1.3.0-linux,Attempting to use a make_ts(0) results in ros::Duration runtime error.
v1.3.0-linux,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.3.0-linux,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.3.0-linux,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.3.0-linux,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.3.0-linux,update timestamp of saved cam info msgs
v1.3.0-linux,DepthPlanner / DepthPerspective / DepthVis / DisparityNormalized
v1.3.0-linux,Scene / Segmentation / SurfaceNormals / Infrared
v1.3.0-linux,publish camera transforms
v1.3.0-linux,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.3.0-linux,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.3.0-linux,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.3.0-linux,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.3.0-linux,ROS params
v1.3.0-linux,ROS publishers
v1.3.0-linux,ROS subscribers
v1.3.0-linux,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.3.0-linux,ROS timers
v1.3.0-linux,todo maintain internal representation as eigen vec?
v1.3.0-linux,todo check if low velocity if within thresh?
v1.3.0-linux,todo maintain separate errors for XY and Z
v1.3.0-linux,todo save this in degrees somewhere to avoid repeated conversion
v1.3.0-linux,this tells the update timer callback to not do active hovering
v1.3.0-linux,todo maintain array of position goals
v1.3.0-linux,todo error checks
v1.3.0-linux,todo fill response
v1.3.0-linux,this tells the update timer callback to not do active hovering
v1.3.0-linux,todo error checks
v1.3.0-linux,todo fill response
v1.3.0-linux,"todo do relative altitude, or add an option for the same?"
v1.3.0-linux,convert GPS goal to NED goal
v1.3.0-linux,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.3.0-linux,todo error checks
v1.3.0-linux,todo fill response
v1.3.0-linux,"todo do relative altitude, or add an option for the same?"
v1.3.0-linux,convert GPS goal to NED goal
v1.3.0-linux,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.3.0-linux,todo error checks
v1.3.0-linux,todo fill response
v1.3.0-linux,todo check if odometry is too old!!
v1.3.0-linux,"if no odom, don't do anything."
v1.3.0-linux,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.3.0-linux,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.3.0-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.3.0-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.3.0-linux,todo yaw limits
v1.3.0-linux,todo just add a sgn funciton in common utils? return double to be safe.
v1.3.0-linux,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.3.0-linux,check if path exists
v1.3.0-linux,todo airsim's simhud.cpp does error checking here
v1.3.0-linux,mimics void ASimHUD::initializeSettings()
v1.3.0-linux,not sure where settings_json initialized in AirSimSettings::initializeSettings() is actually used
v1.3.0-linux,int num_threads = 1;
v1.3.0-linux,ros::MultiThreadedSpinner multi_thread(num_threads);
v1.3.0-linux,multi_thread.spin();
v1.3.0-linux,ros::AsyncSpinner async_spinner(num_threads);
v1.3.0-linux,async_spinner.start();
v1.3.0-linux,single threaded spinner
v1.3.0-linux,","
v1.3.0-linux,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.3.0-linux,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,"in header only mode, control library is not available"
v1.3.0-linux,TODO: something defines max macro which interfears with code here
v1.3.0-linux,is cur_pos within fence?
v1.3.0-linux,destination risk is not available then consider it zero
v1.3.0-linux,if dest risk is lower than its more safe
v1.3.0-linux,are we doing better than closest obstacle?
v1.3.0-linux,"if we stay where we are, what is the risk distance?"
v1.3.0-linux,else we are better of moving to dest
v1.3.0-linux,this function should work even when dest_pos == cur_pos
v1.3.0-linux,is this dest_pos cur_pos within the fence?
v1.3.0-linux,transform dest_pos vector to body frame
v1.3.0-linux,check for approx zero vectors to avoid random yaw angles
v1.3.0-linux,we are hovering
v1.3.0-linux,"get yaw in body frame, ie, front is always 0 radians"
v1.3.0-linux,yaw to ticks
v1.3.0-linux,get obstacles in the window at the tick direction around the window
v1.3.0-linux,less risk distance is better
v1.3.0-linux,check obstacles around current position and see if it has lower risk
v1.3.0-linux,else obstacle is too far
v1.3.0-linux,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.3.0-linux,look for each surrounding tick to see if we have obstacle free angle
v1.3.0-linux,else no suggestions required
v1.3.0-linux,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.3.0-linux,evaluate right and left side of circle
v1.3.0-linux,find right and left risk distances
v1.3.0-linux,at this point we have already determined hover is better than going to dest
v1.3.0-linux,we now determine is moving to suggested angle better than hovering?
v1.3.0-linux,check if dest_pos is safe
v1.3.0-linux,breaking distance at this velocity
v1.3.0-linux,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.3.0-linux,check if dest_pos is safe
v1.3.0-linux,float/vec parameters can have NaN which makes them optional
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,"in header only mode, control library is not available"
v1.3.0-linux,handles +/- tick and wraps around circle
v1.3.0-linux,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.3.0-linux,update the specified window on the map
v1.3.0-linux,make sure from <= to
v1.3.0-linux,normalize the ticks so both are valid indices
v1.3.0-linux,if from is still larger then
v1.3.0-linux,to ticks is then added one full circle to make it larger than from_tick
v1.3.0-linux,find closest obstacle in given window
v1.3.0-linux,search whole map to find closest obstacle
v1.3.0-linux,"in header only mode, control library is not available"
v1.3.0-linux,#include <fileapi.h>
v1.3.0-linux,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.3.0-linux,"Windows, OSX and Linux."
v1.3.0-linux,Windows users can move the Documents folder to any location they want
v1.3.0-linux,SHGetFolderPath knows how to find it.
v1.3.0-linux,fall back in case SHGetFolderPath failed for some reason.
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,"in header only mode, control library is not available"
v1.3.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.0-linux,if using Unreal Build system then include precompiled header file first
v1.3.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.0-linux,this deadlocks UI thread if async_run was called while there are pending rpc calls.
v1.3.0-linux,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.3.0-linux,Exit if already resetting.
v1.3.0-linux,Reset
v1.3.0-linux,if we don't suppress then server will bomb out for exceptions raised by any method
v1.3.0-linux,required for pimpl
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,"in header only mode, control library is not available"
v1.3.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.0-linux,if using Unreal Build system then include precompiled header file first
v1.3.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.0-linux,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.3.0-linux,make sure we can talk to the DroneServer
v1.3.0-linux,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.3.0-linux,command_context.client.ping();
v1.3.0-linux,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.3.0-linux,sim only
v1.3.0-linux,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.3.0-linux,return value of last task. It should be true if task completed without
v1.3.0-linux,cancellation or timeout
v1.3.0-linux,"should be implemented by derived class if it supports async task,"
v1.3.0-linux,for example using futures
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,"in header only mode, control library is not available"
v1.3.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.0-linux,if using Unreal Build system then include precompiled header file first
v1.3.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,"in header only mode, control library is not available"
v1.3.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.0-linux,if using Unreal Build system then include precompiled header file first
v1.3.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.0-linux,required for pimpl
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,"in header only mode, control library is not available"
v1.3.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.0-linux,if using Unreal Build system then include precompiled header file first
v1.3.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.0-linux,status getters
v1.3.0-linux,return value of last task. It should be true if task completed without
v1.3.0-linux,cancellation or timeout
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,"in header only mode, control library is not available"
v1.3.0-linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.0-linux,if using Unreal Build system then include pre-compiled header file first
v1.3.0-linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.0-linux,getters
v1.3.0-linux,required for pimpl
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,"in header only mode, control library is not available"
v1.3.0-linux,last command is to hold on to position
v1.3.0-linux,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.3.0-linux,after landing we detect if drone has stopped moving
v1.3.0-linux,validate path size
v1.3.0-linux,validate yaw mode
v1.3.0-linux,validate and set auto-lookahead value
v1.3.0-linux,if auto mode requested for lookahead then calculate based on velocity
v1.3.0-linux,add current position as starting point
v1.3.0-linux,append the input path and compute segments
v1.3.0-linux,add last segment as zero length segment so we have equal number of segments and points.
v1.3.0-linux,path_segs[i] refers to segment that starts at point i
v1.3.0-linux,"when path ends, we want to slow down"
v1.3.0-linux,else no need to change velocities for last segments
v1.3.0-linux,setup current position on path to 0 offset
v1.3.0-linux,initialize next path position
v1.3.0-linux,until we are at the end of the path (last seg is always zero size)
v1.3.0-linux,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.3.0-linux,send drone command to get to next lookahead
v1.3.0-linux,sleep for rest of the cycle
v1.3.0-linux,how much have we moved towards last goal?
v1.3.0-linux,project actual vector on goal vector
v1.3.0-linux,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.3.0-linux,TODO: below should be lower than 1E3 and configurable
v1.3.0-linux,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.3.0-linux,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.3.0-linux,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.3.0-linux,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.3.0-linux,"if drone moved backward, we don't want goal to move backward as well"
v1.3.0-linux,"so only climb forward on the path, never back. Also note >= which means"
v1.3.0-linux,we climb path even if distance was 0 to take care of duplicated points on path
v1.3.0-linux,else
v1.3.0-linux,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.3.0-linux,compute next target on path
v1.3.0-linux,freeze the quaternion
v1.3.0-linux,convert RC commands to velocity vector
v1.3.0-linux,find yaw as per terrain and remote setting
v1.3.0-linux,execute command
v1.3.0-linux,if timeout occurred then command completed successfully otherwise it was interrupted
v1.3.0-linux,change yaw by moving to same position but constant yaw mode
v1.3.0-linux,by default we say that this command is not supported
v1.3.0-linux,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.3.0-linux,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.3.0-linux,get trims
v1.3.0-linux,take average
v1.3.0-linux,validate dest
v1.3.0-linux,what is the distance we will travel at this velocity?
v1.3.0-linux,get velocity vector
v1.3.0-linux,yaw for the direction of travel
v1.3.0-linux,find velocity vector
v1.3.0-linux,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.3.0-linux,generate velocity vector that is same size as cur_dest_norm / command period
v1.3.0-linux,this velocity vect when executed for command period would yield cur_dest_norm
v1.3.0-linux,send commands
v1.3.0-linux,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.3.0-linux,default strategy is for move. In hover mode we set new strategy temporarily
v1.3.0-linux,are we supposed to do EM?
v1.3.0-linux,get suggested velocity vector
v1.3.0-linux,use the unchecked command
v1.3.0-linux,tell caller not to execute planned command
v1.3.0-linux,other wise throw exception
v1.3.0-linux,otherwise there is some other reason why we are in unsafe situation
v1.3.0-linux,send last command to come to full stop
v1.3.0-linux,else no unsafe situation
v1.3.0-linux,note: cur_path_loc and next_path_loc may both point to same object
v1.3.0-linux,"otherwise use up this segment, move on to next one"
v1.3.0-linux,if we are here then we ran out of segments
v1.3.0-linux,consider last segment as zero length segment
v1.3.0-linux,adjust yaw for the direction of travel in forward-only mode
v1.3.0-linux,else no adjustment needed
v1.3.0-linux,if auto mode requested for lookahead then calculate based on velocity
v1.3.0-linux,Create a spring arm component for our chase camera
v1.3.0-linux,"do nothing, spring arm is pulling the camera with it"
v1.3.0-linux,"do nothing, we have camera turned off"
v1.3.0-linux,set initial view mode
v1.3.0-linux,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.3.0-linux,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.3.0-linux,"If the lag is missing, the camera will also occasionally shake."
v1.3.0-linux,"But, lag is not desired when piloting a drone"
v1.3.0-linux,attach spring arm to actor
v1.3.0-linux,remember current parent for external camera. Later when we remove external
v1.3.0-linux,"camera from spring arm, we will attach it back to its last parent"
v1.3.0-linux,now attach camera to spring arm
v1.3.0-linux,"For car, we need to move the camera back a little more than for a drone."
v1.3.0-linux,"Otherwise, the camera will be stuck inside the car"
v1.3.0-linux,ExternalCamera->bUsePawnControlRotation = false;
v1.3.0-linux,detach spring arm
v1.3.0-linux,Re-enable rendering
v1.3.0-linux,Remove any existing key bindings for manual mode
v1.3.0-linux,"else someone else is bound to manual pose controller, leave it alone"
v1.3.0-linux,if new mode is manual mode then add key bindings
v1.3.0-linux,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.3.0-linux,other modes don't need special setup
v1.3.0-linux,make switch official
v1.3.0-linux,Split the tag string into individual tags.
v1.3.0-linux,Texture swap on actors that have all of those tags.
v1.3.0-linux,----------- Plotting APIs ----------/
v1.3.0-linux,"plot line for points 0-1, 1-2, 2-3"
v1.3.0-linux,"plot line for points 0-1, 2-3, 4-5... must be even number of points"
v1.3.0-linux,assert points_start.size() == poinst_end.size()
v1.3.0-linux,assert positions.size() == strings.size()
v1.3.0-linux,assert poses.size() == names.size()
v1.3.0-linux,by default all image types are disabled
v1.3.0-linux,use final color for all calculations
v1.3.0-linux,TODO: avoid the need to override const cast here
v1.3.0-linux,if the viewport is taller than it is wide
v1.3.0-linux,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v1.3.0-linux,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v1.3.0-linux,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v1.3.0-linux,use final color for all calculations
v1.3.0-linux,TODO: should we be ignoring position and orientation settings here?
v1.3.0-linux,TODO: can we eliminate storing NedTransform?
v1.3.0-linux,if (!std::isnan(setting.target_gamma))
v1.3.0-linux,camera-> = setting.target_gamma;
v1.3.0-linux,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.3.0-linux,else nothing to enable
v1.3.0-linux,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.3.0-linux,if (controller && controller->GetViewTarget() == this)
v1.3.0-linux,controller->SetViewTarget(nullptr);
v1.3.0-linux,TODO: explore screenshot option
v1.3.0-linux,addScreenCaptureHandler(camera->GetWorld());
v1.3.0-linux,TODO: may be we should have these methods non-const?
v1.3.0-linux,We don't do game/render thread synchronization for safe method.
v1.3.0-linux,We just blindly sleep for 200ms (the old way)
v1.3.0-linux,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.3.0-linux,Make sure that all alpha values are opaque.
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,"#include ""Runtime/Foliage/Public/FoliageType.h"""
v1.3.0-linux,TODO: change naming conventions to same as other files?
v1.3.0-linux,Enable/disable primary viewport rendering flag
v1.3.0-linux,This disables rendering of the main viewport in the same way as the
v1.3.0-linux,"console command ""show rendering"" would do."
v1.3.0-linux,"When getting an image through the API, the image is produced after the render"
v1.3.0-linux,thread has finished rendering the current and the subsequent frame. This means
v1.3.0-linux,that the frame rate for obtaining images through the API is only half as high as
v1.3.0-linux,"it could be, since only every other image is actually captured. We work around"
v1.3.0-linux,this by telling the viewport to flush the rendering queue at the end of each
v1.3.0-linux,drawn frame so that it executes our render request at that point already.
v1.3.0-linux,Do this only if the main viewport is not being rendered anyway in case there are
v1.3.0-linux,any adverse performance effects during main rendering.
v1.3.0-linux,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v1.3.0-linux,nothing to do for now
v1.3.0-linux,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.3.0-linux,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.3.0-linux,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.3.0-linux,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.3.0-linux,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.3.0-linux,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.3.0-linux,{
v1.3.0-linux,InitializeObjectStencilID(*comp);
v1.3.0-linux,}
v1.3.0-linux,Access the subclass instance with the * or -> operators.
v1.3.0-linux,can we see followee?
v1.3.0-linux,remove mapping
v1.3.0-linux,removing binding
v1.3.0-linux,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.3.0-linux,"some point. At the moment, manually swapping Red and Blue"
v1.3.0-linux,Copy scaled image into destination thumb
v1.3.0-linux,Compress data - convert into a .png
v1.3.0-linux,if we already have attached actor
v1.3.0-linux,#ifdef _MSC_VER
v1.3.0-linux,//print to VS output window
v1.3.0-linux,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.3.0-linux,#endif
v1.3.0-linux,also do default logging
v1.3.0-linux,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.3.0-linux,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.3.0-linux,{
v1.3.0-linux,if (GEngine != nullptr)
v1.3.0-linux,{
v1.3.0-linux,return GEngine->GameUserSettings;
v1.3.0-linux,}
v1.3.0-linux,return nullptr;
v1.3.0-linux,}
v1.3.0-linux,UGameUserSettings* game_settings = GetGameUserSettings();
v1.3.0-linux,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.3.0-linux,game_settings->ApplySettings(true);
v1.3.0-linux,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.3.0-linux,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.3.0-linux,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.3.0-linux,todo unused. need to manually plots tf axes' line in right handed FLU instead of using DrawDebugCoordinateSystem
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,plugin startup
v1.3.0-linux,plugin shutdown
v1.3.0-linux,initialize state
v1.3.0-linux,add listener for pawn's collision event
v1.3.0-linux,compute our home point
v1.3.0-linux,default behavior is to call update every tick
v1.3.0-linux,"for custom physics engine, this method should be overridden and update should be"
v1.3.0-linux,called from every physics tick
v1.3.0-linux,add cameras that already exists in pawn
v1.3.0-linux,create or replace cameras specified in settings
v1.3.0-linux,setup individual cameras
v1.3.0-linux,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.3.0-linux,for each camera in settings
v1.3.0-linux,get pose
v1.3.0-linux,spawn and attach camera to pawn
v1.3.0-linux,add on to our collection
v1.3.0-linux,Deflect along the surface when we collide.
v1.3.0-linux,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.3.0-linux,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.3.0-linux,-1 to 1 --> 0 to 1
v1.3.0-linux,-1 to 1
v1.3.0-linux,these will be available for devices like steering wheels
v1.3.0-linux,switch index 0 to 7 for FrSky Taranis RC is:
v1.3.0-linux,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.3.0-linux,TODO: should below be at controller level info?
v1.3.0-linux,else don't waste time
v1.3.0-linux,sync environment from kinematics
v1.3.0-linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.3.0-linux,void playBack()
v1.3.0-linux,{
v1.3.0-linux,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.3.0-linux,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.3.0-linux,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.3.0-linux,}
v1.3.0-linux,TODO: refactor below code used for playback
v1.3.0-linux,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.3.0-linux,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.3.0-linux,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.3.0-linux,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.3.0-linux,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.3.0-linux,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.3.0-linux,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.3.0-linux,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.3.0-linux,}
v1.3.0-linux,parameters in NED frame
v1.3.0-linux,translate to new PawnSimApi position & orientation from NED to NEU
v1.3.0-linux,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.3.0-linux,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.3.0-linux,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.3.0-linux,checked at the start of next tick
v1.3.0-linux,allow teleportation
v1.3.0-linux,if collisions are not enabled
v1.3.0-linux,or we have collided but passthrough is enabled
v1.3.0-linux,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.3.0-linux,"without flip flopping, collisions can't be detected"
v1.3.0-linux,update kinematics from pawn's movement instead of physics engine
v1.3.0-linux,by default we update kinematics from UE pawn
v1.3.0-linux,if SimMod uses its own physics engine then this should be overriden
v1.3.0-linux,no default action in this base class
v1.3.0-linux,TODO: because this bug we are using alternative code with stringstream
v1.3.0-linux,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.3.0-linux,std::stringstream ss;
v1.3.0-linux,"ss << timestamp_millis << ""\t"";"
v1.3.0-linux,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.3.0-linux,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.3.0-linux,"ss << ""\n"";"
v1.3.0-linux,return ss.str();
v1.3.0-linux,"read pixels from render target using render thread, then compress the result into PNG"
v1.3.0-linux,argument on the thread that calls this method.
v1.3.0-linux,TODO: is below really needed?
v1.3.0-linux,make sure we are not on the rendering thread
v1.3.0-linux,TODO: below doesn't work right now because it must be running in game thread
v1.3.0-linux,below is documented method but more expensive because it forces flush
v1.3.0-linux,wait for render thread to pick up our task
v1.3.0-linux,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.3.0-linux,capture CameraPose for this frame
v1.3.0-linux,The completion is called immeidately after GameThread sends the
v1.3.0-linux,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.3.0-linux,execute *immediately* after RenderThread renders the scene!
v1.3.0-linux,"while we're still on GameThread, enqueue request for capture the scene!"
v1.3.0-linux,wait for this task to complete
v1.3.0-linux,log a message and continue wait
v1.3.0-linux,lamda function still references a few objects for which there is no refcount.
v1.3.0-linux,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.3.0-linux,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.3.0-linux,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.3.0-linux,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.3.0-linux,Fill out your copyright notice in the Description page of Project Settings.
v1.3.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.0-linux,UWorld* World = GetWorld();
v1.3.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.0-linux,still need the menu class for f10
v1.3.0-linux,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v1.3.0-linux,showWeatherMenu(WorldContextObject);
v1.3.0-linux,"if weather is not enabled, dont allow any weather values to be set"
v1.3.0-linux,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v1.3.0-linux,and must be set to true or false before this.
v1.3.0-linux,WeatherEnabled will always be false
v1.3.0-linux,"NOTE: weather enabled must be set first, before other params for this to work"
v1.3.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.0-linux,"get all menu actors, if any"
v1.3.0-linux,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.3.0-linux,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.0-linux,"get all menu actors, if any"
v1.3.0-linux,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.3.0-linux,"get all menu actors, if any, then hide the menu"
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,Stuff to filter out XInput devices
v1.3.0-linux,-----------------------------------------------------------------------------
v1.3.0-linux,"Defines, constants, and global variables"
v1.3.0-linux,-----------------------------------------------------------------------------
v1.3.0-linux,Magnitude ranges from -1 to 1
v1.3.0-linux,Strength ranges from 0 to 1
v1.3.0-linux,Autocenter
v1.3.0-linux,Rumble
v1.3.0-linux,Register with the DirectInput subsystem and get a pointer
v1.3.0-linux,to a IDirectInput interface we can use.
v1.3.0-linux,Create a DInput object
v1.3.0-linux,Look for a simple joystick we can use for this sample program.
v1.3.0-linux,Make sure we got a joystick
v1.3.0-linux,"Set the data format to ""simple joystick"" - a predefined data format"
v1.3.0-linux,
v1.3.0-linux,"A data format specifies which controls on a device we are interested in,"
v1.3.0-linux,and how they should be reported. This tells DInput that we will be
v1.3.0-linux,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.3.0-linux,Set the cooperative level to let DInput know how this device should
v1.3.0-linux,interact with the system and with other DInput applications.
v1.3.0-linux,Enumerate the joystick objects. The callback function enabled user
v1.3.0-linux,"interface elements for objects that are found, and sets the min/max"
v1.3.0-linux,values property for discovered axes.
v1.3.0-linux,-----------------------------------------------------------------------------
v1.3.0-linux,Enum each PNP device using WMI and check each device ID to see if it contains
v1.3.0-linux,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.3.0-linux,Unfortunately this information can not be found by just using DirectInput.
v1.3.0-linux,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.3.0-linux,XInput devices.
v1.3.0-linux,
v1.3.0-linux,This function stores the list of xinput devices in a linked list
v1.3.0-linux,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.3.0-linux,-----------------------------------------------------------------------------
v1.3.0-linux,CoInit if needed
v1.3.0-linux,Create WMI
v1.3.0-linux,Create BSTRs for WMI
v1.3.0-linux,Connect to WMI
v1.3.0-linux,Switch security level to IMPERSONATE
v1.3.0-linux,Get list of Win32_PNPEntity devices
v1.3.0-linux,Loop over all devices
v1.3.0-linux,Get 20 at a time
v1.3.0-linux,"For each device, get its device ID"
v1.3.0-linux,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.3.0-linux,Unfortunately this information can not be found by just using DirectInput
v1.3.0-linux,"If it does, then get the VID/PID from var.bstrVal"
v1.3.0-linux,Add the VID/PID to a linked list
v1.3.0-linux,-----------------------------------------------------------------------------
v1.3.0-linux,Returns true if the DirectInput device is also an XInput device.
v1.3.0-linux,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.3.0-linux,-----------------------------------------------------------------------------
v1.3.0-linux,Check each xinput device to see if this device's vid/pid matches
v1.3.0-linux,-----------------------------------------------------------------------------
v1.3.0-linux,Cleanup needed for IsXInputDevice()
v1.3.0-linux,-----------------------------------------------------------------------------
v1.3.0-linux,Cleanup linked list
v1.3.0-linux,-----------------------------------------------------------------------------
v1.3.0-linux,Name: EnumJoysticksCallback()
v1.3.0-linux,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.3.0-linux,device interface on it so we can play with it.
v1.3.0-linux,-----------------------------------------------------------------------------
v1.3.0-linux,Skip anything other than the perferred joystick device as defined by the control panel.
v1.3.0-linux,Instead you could store all the enumerated joysticks and let the user pick.
v1.3.0-linux,Obtain an interface to the enumerated joystick.
v1.3.0-linux,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.3.0-linux,it while we were in the middle of enumerating it.)
v1.3.0-linux,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.3.0-linux,could store all the enumerated joysticks and let the user pick.
v1.3.0-linux,-----------------------------------------------------------------------------
v1.3.0-linux,Name: EnumObjectsCallback()
v1.3.0-linux,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.3.0-linux,joystick. This function enables user interface elements for objects
v1.3.0-linux,"that are found to exist, and scales axes min/max values."
v1.3.0-linux,-----------------------------------------------------------------------------
v1.3.0-linux,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.3.0-linux,enumerated axis in order to scale min/max values.
v1.3.0-linux,Set the range for the axis
v1.3.0-linux,Set the UI to reflect what objects the joystick supports
v1.3.0-linux,-----------------------------------------------------------------------------
v1.3.0-linux,Name: UpdateInputState()
v1.3.0-linux,Desc: Get the input device's state and display it.
v1.3.0-linux,-----------------------------------------------------------------------------
v1.3.0-linux,Poll the device to read the current state
v1.3.0-linux,DInput is telling us that the input stream has been
v1.3.0-linux,"interrupted. We aren't tracking any state between polls, so"
v1.3.0-linux,we don't have any special reset that needs to be done. We
v1.3.0-linux,just re-acquire and try again.
v1.3.0-linux,while (hr == DIERR_INPUTLOST)
v1.3.0-linux,hr = g_pJoystick->Acquire();
v1.3.0-linux,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.3.0-linux,may occur when the app is minimized or in the process of
v1.3.0-linux,"switching, so just try again later"
v1.3.0-linux,Get the input's device state
v1.3.0-linux,Axes
v1.3.0-linux,Slider controls
v1.3.0-linux,Points of view
v1.3.0-linux,Buttons
v1.3.0-linux,-----------------------------------------------------------------------------
v1.3.0-linux,Name: FreeDirectInput()
v1.3.0-linux,Desc: Initialize the DirectInput variables.
v1.3.0-linux,-----------------------------------------------------------------------------
v1.3.0-linux,Unacquire the device one last time just in case
v1.3.0-linux,the app tried to exit while the device is still acquired.
v1.3.0-linux,Release any DirectInput objects.
v1.3.0-linux,nop
v1.3.0-linux,normalize min to max --> 0 to 1
v1.3.0-linux,normalize 0 to 1 --> -1 to 1
v1.3.0-linux,#include <libudev.h>
v1.3.0-linux,implementation for unsupported OS
v1.3.0-linux,if this is new index
v1.3.0-linux,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.3.0-linux,close previous one
v1.3.0-linux,open new device
v1.3.0-linux,if open was successful
v1.3.0-linux,read the device
v1.3.0-linux,if we didn't had valid read
v1.3.0-linux,"NOTE if this condition is not met, we're probably out of sync and this"
v1.3.0-linux,Joystick instance is likely unusable
v1.3.0-linux,TODO: set below to false?
v1.3.0-linux,state.is_valid = false;
v1.3.0-linux,else ignore
v1.3.0-linux,TODO: implement this for linux
v1.3.0-linux,TODO: implement this for linux
v1.3.0-linux,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.3.0-linux,{
v1.3.0-linux,"manufacturerID = productID = """";"
v1.3.0-linux,// Use udev to look up the product and manufacturer IDs
v1.3.0-linux,struct udev *udev = udev_new();
v1.3.0-linux,if (udev) {
v1.3.0-linux,char sysname[32];
v1.3.0-linux,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.3.0-linux,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.3.0-linux,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.3.0-linux,if (!dev)
v1.3.0-linux,{
v1.3.0-linux,"message = ""Unable to find parent USB device"";"
v1.3.0-linux,return false;
v1.3.0-linux,}
v1.3.0-linux,std::stringstream ss;
v1.3.0-linux,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.3.0-linux,ss >> manufacturerID;
v1.3.0-linux,ss.clear();
v1.3.0-linux,"ss.str("""");"
v1.3.0-linux,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.3.0-linux,ss >> productID;
v1.3.0-linux,udev_device_unref(dev);
v1.3.0-linux,}
v1.3.0-linux,else
v1.3.0-linux,{
v1.3.0-linux,"message = ""Cannot create udev"";"
v1.3.0-linux,return false;
v1.3.0-linux,}
v1.3.0-linux,udev_unref(udev);
v1.3.0-linux,return true;
v1.3.0-linux,}
v1.3.0-linux,required for pimpl
v1.3.0-linux,TODO: anyway to workaround const_cast?
v1.3.0-linux,FGenericPlatformMisc::PlatformInit();
v1.3.0-linux,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.3.0-linux,TODO: index check
v1.3.0-linux,create main widget
v1.3.0-linux,synchronize PIP views
v1.3.0-linux,TODO: should we only do below on SceneCapture2D components and cameras?
v1.3.0-linux,avoid motion blur so capture images don't get
v1.3.0-linux,use two different methods to set console var because sometime it doesn't seem to work
v1.3.0-linux,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.3.0-linux,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.3.0-linux,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.3.0-linux,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.3.0-linux,setup defaults
v1.3.0-linux,Attempts to parse the settings text from one of multiple locations.
v1.3.0-linux,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.3.0-linux,"Next, check the executable's working directory for the settings file."
v1.3.0-linux,"Finally, check the user's documents folder."
v1.3.0-linux,"If the settings file cannot be read, throw an exception"
v1.3.0-linux,Attempts to parse the settings text from the command line
v1.3.0-linux,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.3.0-linux,"Example: AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.3.0-linux,"Returns true if the argument is present, false otherwise."
v1.3.0-linux,build image file name
v1.3.0-linux,write image file
v1.3.0-linux,write to CSV file
v1.3.0-linux,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.3.0-linux,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.3.0-linux,make sire all vars are set up
v1.3.0-linux,"TODO: should we go as fast as possible, or should we limit this to a particular number of"
v1.3.0-linux,frames per second?
v1.3.0-linux,BG: Workaround to get sync ground truth. See https://github.com/Microsoft/AirSim/issues/1494 for details
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,decide which derived BP to use
v1.3.0-linux,we don't have real vehicle so no vehicle API
v1.3.0-linux,put camera little bit above vehicle
v1.3.0-linux,update ground level
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,let base class setup physics world
v1.3.0-linux,stop physics thread before we dismantle
v1.3.0-linux,setup clock in ClockFactory
v1.3.0-linux,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.3.0-linux,steppable clock returns interval that is a constant number irrespective of wall clock
v1.3.0-linux,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.3.0-linux,but that would cause vehicles like quadrotors to become unstable
v1.3.0-linux,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.3.0-linux,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.3.0-linux,get increase in clock speed
v1.3.0-linux,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.3.0-linux,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.3.0-linux,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.3.0-linux,Approach 2: scale control loop frequency if clock is speeded up
v1.3.0-linux,"for slowing down, this don't generate instability"
v1.3.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.3.0-linux,decide which derived BP to use
v1.3.0-linux,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.3.0-linux,vehicle_sim_api->reset();
v1.3.0-linux,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.3.0-linux,create vehicle API
v1.3.0-linux,setup physics vehicle
v1.3.0-linux,initialize private vars
v1.3.0-linux,calls to update* are handled by physics engine and in SimModeWorldBase
v1.3.0-linux,"Utils::log(""------Render tick-------"");"
v1.3.0-linux,"if reset is pending then do it first, no need to do other things until next tick"
v1.3.0-linux,move collision info from rendering engine to vehicle
v1.3.0-linux,update rotor poses
v1.3.0-linux,if we did reset then don't worry about synchronizing states for this tick
v1.3.0-linux,Continue to wait for reset
v1.3.0-linux,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.3.0-linux,*** Start: UpdatableState implementation ***//
v1.3.0-linux,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.3.0-linux,environment update for current position
v1.3.0-linux,update forces on vertices
v1.3.0-linux,update to controller must be done after kinematics have been updated by physics engine
v1.3.0-linux,*** End: UpdatableState implementation ***//
v1.3.0-linux,get references of existing camera
v1.3.0-linux,setup clock in PhysX
v1.3.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.3.0-linux,decide which derived BP to use
v1.3.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.3.0-linux,Setup suspension forces
v1.3.0-linux,Find the tire object and set the data for it
v1.3.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.3.0-linux,Setup suspension forces
v1.3.0-linux,Find the tire object and set the data for it
v1.3.0-linux,Create In-Car camera component
v1.3.0-linux,In car HUD
v1.3.0-linux,Create text render component for in car speed display
v1.3.0-linux,Create text render component for in car gear display
v1.3.0-linux,Setup the audio component and allocate it a sound cue
v1.3.0-linux,Colors for the in-car gear display. One for normal one for reverse
v1.3.0-linux,Wheels/Tires
v1.3.0-linux,Setup the wheels
v1.3.0-linux,Adjust the tire loading
v1.3.0-linux,Engine
v1.3.0-linux,Torque setup
v1.3.0-linux,Adjust the steering
v1.3.0-linux,Transmission
v1.3.0-linux,We want 4wd
v1.3.0-linux,Drive the front wheels a little more than the rear
v1.3.0-linux,Automatic gearbox
v1.3.0-linux,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.3.0-linux,Physics settings
v1.3.0-linux,Adjust the center of mass - the buggy is quite low
v1.3.0-linux,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.3.0-linux,put camera little bit above vehicle
v1.3.0-linux,update physics material
v1.3.0-linux,Update the strings used in the HUD (in-car and on-screen)
v1.3.0-linux,Set the string in the in-car HUD
v1.3.0-linux,Pass the engine RPM to the sound component
v1.3.0-linux,Start an engine sound playing
v1.3.0-linux,Using FText because this is display text that should be localizable
v1.3.0-linux,Setup the text render component strings
v1.3.0-linux,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.3.0-linux,below is not needed
v1.3.0-linux,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.3.0-linux,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.3.0-linux,TODO: should do reset() here?
v1.3.0-linux,create vehicle params
v1.3.0-linux,these are called on render ticks
v1.3.0-linux,TODO: do we need this for cars?
v1.3.0-linux,TODO: move this to SimModeBase?
v1.3.0-linux,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.3.0-linux,reset();
v1.3.0-linux,return;
v1.3.0-linux,}
v1.3.0-linux,Thrustmaster devices
v1.3.0-linux,"Anything else, typically Logitech G920 wheel"
v1.3.0-linux,Two steel levers behind wheel
v1.3.0-linux,if API-client control is not active then we route keyboard/joystick control to car
v1.3.0-linux,all car controls from anywhere must be routed through API component
v1.3.0-linux,*** Start: UpdatableState implementation ***//
v1.3.0-linux,physics tick
v1.3.0-linux,*** End: UpdatableState implementation ***//
v1.3.0-linux,TODO: directly accept getVehicleSimApis() using generic container
v1.3.0-linux,remove everything that we created in BeginPlay
v1.3.0-linux,we use custom debug reporting for this class
v1.3.0-linux,perform any expensive rendering update outside of lock region
v1.3.0-linux,no need to call base reset because of our custom implementation
v1.3.0-linux,TODO: this is going to cause circular references which is fine here but
v1.3.0-linux,in future we should consider moving SimMode not derived from AActor and move
v1.3.0-linux,it to AirLib and directly implement WorldSimApiBase interface
v1.3.0-linux,get player start
v1.3.0-linux,this must be done from within actor otherwise we don't get player start
v1.3.0-linux,UWeatherLib::showWeatherMenu(World);
v1.3.0-linux,else don't init
v1.3.0-linux,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v1.3.0-linux,tod_sim_clock_start_ needs to be reset here.
v1.3.0-linux,Going from enabled to disabled
v1.3.0-linux,do these in the end to ensure that advanceTimeOfDay() doesn't see
v1.3.0-linux,any inconsistent state.
v1.3.0-linux,should be overridden by derived class
v1.3.0-linux,should be overridden by derived class
v1.3.0-linux,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.3.0-linux,default setup - this should be overridden in derived modes as needed
v1.3.0-linux,setup clock in ClockFactory
v1.3.0-linux,default implementation
v1.3.0-linux,create director
v1.3.0-linux,create external camera required for the director
v1.3.0-linux,API server start/stop
v1.3.0-linux,get UU origin of global NED frame
v1.3.0-linux,determine camera director camera default pose and spawn it
v1.3.0-linux,find all vehicle pawns
v1.3.0-linux,add vehicles from settings
v1.3.0-linux,if vehicle is of type for derived SimMode and auto creatable
v1.3.0-linux,compute initial pose
v1.3.0-linux,spawn vehicle pawn
v1.3.0-linux,create API objects for each pawn we have
v1.3.0-linux,create vehicle sim api
v1.3.0-linux,TODO: better handle no FPV vehicles scenario
v1.3.0-linux,derived class should override this method to retrieve types of pawns they support
v1.3.0-linux,derived class should override this method to retrieve types of pawns they support
v1.3.0-linux,derived class should override this method to retrieve types of pawns they support
v1.3.0-linux,derived class should override this method to retrieve types of pawns they support
v1.3.0-linux,derived class should override this method to retrieve types of pawns they support
v1.3.0-linux,derived class should override this method to retrieve types of pawns they support
v1.3.0-linux,derived class should override this method to retrieve types of pawns they support
v1.3.0-linux,Draws debug-points on main viewport for Lidar laser hits.
v1.3.0-linux,Used for debugging only.
v1.3.0-linux,Currently we are checking the sensor-collection instead of sensor-settings.
v1.3.0-linux,Also using variables to optimize not checking the collection if not needed.
v1.3.0-linux,TODO: Is it incorrect to assume LidarSimple here?
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,ctor
v1.3.0-linux,initializes information based on lidar configuration
v1.3.0-linux,calculate verticle angle distance between each laser
v1.3.0-linux,store vertical angles for each laser
v1.3.0-linux,returns a point-cloud for the tick
v1.3.0-linux,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.3.0-linux,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.3.0-linux,calculate number of points needed for each laser/channel
v1.3.0-linux,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.3.0-linux,calculate needed angle/distance between each point
v1.3.0-linux,normalize FOV start/end
v1.3.0-linux,shoot lasers
v1.3.0-linux,check if the laser is outside the requested horizontal FOV
v1.3.0-linux,"shoot laser and get the impact point, if any"
v1.3.0-linux,simulate shooting a laser via Unreal ray-tracing.
v1.3.0-linux,start position
v1.3.0-linux,We need to compose rotations here rather than rotate a vector by a quaternion
v1.3.0-linux,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.3.0-linux,get ray quaternion in lidar frame (angles must be in radians)
v1.3.0-linux,get ray quaternion in body frame
v1.3.0-linux,get ray quaternion in world frame
v1.3.0-linux,get ray vector (end position)
v1.3.0-linux,Store the segmentation id of the hit object.
v1.3.0-linux,Debug code for very specific cases.
v1.3.0-linux,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.3.0-linux,decide the frame for the point-cloud
v1.3.0-linux,current detault behavior; though it is probably not very useful.
v1.3.0-linux,not changing the default for now to maintain backwards-compat.
v1.3.0-linux,point in vehicle intertial frame
v1.3.0-linux,tranform to lidar frame
v1.3.0-linux,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.3.0-linux,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.3.0-linux,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.3.0-linux,"On the client side, if it is needed to transform this data back to the world frame,"
v1.3.0-linux,"then do the equivalent of following,"
v1.3.0-linux,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.3.0-linux,See SimModeBase::drawLidarDebugPoints()
v1.3.0-linux,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.3.0-linux,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,update ray tracing
v1.3.0-linux,"FString hit_name = FString(""None"");"
v1.3.0-linux,if (dist_hit.GetActor())
v1.3.0-linux,hit_name=dist_hit.GetActor()->GetName();
v1.3.0-linux,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.3.0-linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,This assumes you are running DroneServer already on the same machine.
v1.3.0-linux,DroneServer must be running first.
v1.3.0-linux,enable API control
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,move commands
v1.3.0-linux,else leave as it is
v1.3.0-linux,TODO: get these in one call
v1.3.0-linux,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.3.0-linux,TODO: shouldn't we pass folder path?
v1.3.0-linux,parse
v1.3.0-linux,group the images by the current date.
v1.3.0-linux,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.3.0-linux,{
v1.3.0-linux,"return """";"
v1.3.0-linux,}
v1.3.0-linux,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.3.0-linux,{
v1.3.0-linux,return false;
v1.3.0-linux,}
v1.3.0-linux,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.3.0-linux,params.context->client.newTask();
v1.3.0-linux,}
v1.3.0-linux,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.3.0-linux,params.context->client.WaitForCompletion(0);
v1.3.0-linux,}
v1.3.0-linux,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.3.0-linux,{
v1.3.0-linux,}
v1.3.0-linux,parse command line
v1.3.0-linux,Shell callbacks
v1.3.0-linux,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.3.0-linux,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.3.0-linux,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.3.0-linux,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.3.0-linux,Add shell commands
v1.3.0-linux,TODO: add WaitForCompletion command
v1.3.0-linux,"TODO: add command line args help, arg count validation"
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v1.3.0-linux,switch to explicit hover mode so that this is the fall back when
v1.3.0-linux,move* commands are finished.
v1.3.0-linux,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.3.0-linux,TODO: implement weather for Unity
v1.3.0-linux,TODO: implement weather for Unity
v1.3.0-linux,Function pointers to hold the addresses of the functions that are defined in Unity
v1.3.0-linux,"Enabling all LogLevels,"
v1.3.0-linux,"Enabling all LogLevels,"
v1.3.0-linux,delete ltm;
v1.3.0-linux,initialize state
v1.3.0-linux,compute our home point
v1.3.0-linux,default behavior is to call update every tick
v1.3.0-linux,"for custom physics engine, this method should be overridden and update should be"
v1.3.0-linux,called from every physics tick
v1.3.0-linux,these will be available for devices like steering wheels
v1.3.0-linux,sync environment from kinematics
v1.3.0-linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.3.0-linux,FVector unrealPosition = getUUPosition();
v1.3.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v1.3.0-linux,parameters in NED frame
v1.3.0-linux,allow teleportation
v1.3.0-linux,if collisions are not enabled
v1.3.0-linux,or we have collided but passthrough is enabled
v1.3.0-linux,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.3.0-linux,"without flip flopping, collisions can't be detected"
v1.3.0-linux,by default we update kinematics from UE pawn
v1.3.0-linux,if SimMod uses its own physics engine then this should be overriden
v1.3.0-linux,no default action in this base class
v1.3.0-linux,TODO: because this bug we are using alternative code with stringstream
v1.3.0-linux,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.3.0-linux,update kinematics from pawn's movement instead of physics engine
v1.3.0-linux,TODO: update other fields?
v1.3.0-linux,implements getImages() method in the ImageCaptureBase class.
v1.3.0-linux,update ray tracing
v1.3.0-linux,TODO: index check
v1.3.0-linux,Attempts to parse the settings text from one of multiple locations.
v1.3.0-linux,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.3.0-linux,"Next, check the executable's working directory for the settings file."
v1.3.0-linux,"Finally, check the user's documents folder."
v1.3.0-linux,"If the settings file cannot be read, throw an exception"
v1.3.0-linux,let base class setup physics world
v1.3.0-linux,stop physics thread before we dismantle
v1.3.0-linux,setup clock in ClockFactory
v1.3.0-linux,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.3.0-linux,steppable clock returns interval that is a constant number irrespective of wall clock
v1.3.0-linux,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.3.0-linux,but that would cause vehicles like quadrotors to become unstable
v1.3.0-linux,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.3.0-linux,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.3.0-linux,get increase in clock speed
v1.3.0-linux,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.3.0-linux,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.3.0-linux,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.3.0-linux,Approach 2: scale control loop frequency if clock is speeded up
v1.3.0-linux,"for slowing down, this don't generate instability"
v1.3.0-linux,-------------------------------- overrides -----------------------------------------------//
v1.3.0-linux,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.3.0-linux,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.3.0-linux,create vehicle API
v1.3.0-linux,setup physics vehicle
v1.3.0-linux,initialize private vars
v1.3.0-linux,"if reset is pending then do it first, no need to do other things until next tick"
v1.3.0-linux,move collision info from rendering engine to vehicle
v1.3.0-linux,update rotor poses
v1.3.0-linux,if we did reset then don't worry about synchronizing states for this tick
v1.3.0-linux,Continue to wait for reset
v1.3.0-linux,*** Start: UpdatableState implementation ***//
v1.3.0-linux,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.3.0-linux,environment update for current position
v1.3.0-linux,update forces on vertices
v1.3.0-linux,update to controller must be done after kinematics have been updated by physics engine
v1.3.0-linux,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.3.0-linux,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.3.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.3.0-linux,*** End: UpdatableState implementation ***//
v1.3.0-linux,TODO: should do reset() here?
v1.3.0-linux,these are called on render ticks
v1.3.0-linux,TODO: do we need this for cars?
v1.3.0-linux,Thrustmaster devices
v1.3.0-linux,"Anything else, typically Logitech G920 wheel"
v1.3.0-linux,Two steel levers behind wheel
v1.3.0-linux,if API-client control is not active then we route keyboard/joystick control to car
v1.3.0-linux,all car controls from anywhere must be routed through API component
v1.3.0-linux,*** Start: UpdatableState implementation ***//
v1.3.0-linux,physics tick
v1.3.0-linux,void CarPawnSimApi::reportState(StateReporter& reporter)
v1.3.0-linux,{
v1.3.0-linux,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.3.0-linux,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.3.0-linux,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.3.0-linux,}
v1.3.0-linux,*** End: UpdatableState implementation ***//
v1.3.0-linux,remove everything that we created in BeginPlay
v1.3.0-linux,we use custom debug reporting for this class
v1.3.0-linux,perform any expensive rendering update outside of lock region
v1.3.0-linux,no need to call base reset because of our custom implementation
v1.3.0-linux,should be overridden by derived class
v1.3.0-linux,should be overridden by derived class
v1.3.0-linux,commenting this out for now to avoid unintentional Unity startup failure
v1.3.0-linux,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v1.3.0-linux,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.3.0-linux,default setup - this should be overridden in derived modes as needed
v1.3.0-linux,setup clock in ClockFactory
v1.3.0-linux,API server start/stop
v1.3.0-linux,determine camera director camera default pose and spawn it
v1.3.0-linux,derived class should override this method to retrieve types of pawns they support
v1.3.0-linux,derived class should override this method to retrieve types of pawns they support
v1.3.0-linux,60 acres park:
v1.3.0-linux,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.3.0-linux,marymoore park
v1.3.0-linux,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.3.0-linux,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.3.0-linux,DepthNavThreshold depthNav;
v1.3.0-linux,DepthNavOptAStar depthNav;
v1.3.0-linux,DepthNavThreshold depthNav;
v1.3.0-linux,DepthNavOptAStar depthNav;
v1.3.0-linux,Cleanup
v1.3.0-linux,runDepthNavGT();
v1.3.0-linux,runDepthNavSGM();
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,by Sudipta Sinha
v1.3.0-linux,adapted for AirSim by Matthias Mueller
v1.3.0-linux,first row
v1.3.0-linux,last row
v1.3.0-linux,Local quadratic fit of cost and subpixel refinement.
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,by Sudipta Sinha
v1.3.0-linux,adapted for AirSim by Matthias Mueller
v1.3.0-linux,uint64_t x64 = (uint64_t)x;
v1.3.0-linux,uint64_t y64 = (uint64_t)y;
v1.3.0-linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-linux,Licensed under the MIT License.
v1.3.0-linux,by Sudipta Sinha
v1.3.0-linux,adapted for AirSim by Matthias Mueller
v1.3.0-linux,ensure that disparity range is a multiple of 8
v1.3.0-linux,sgm stereo
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,read settings and override defaults
v1.3.0-Windows,allow json overrides on a per-vehicle basis.
v1.3.0-Windows,start server in async mode
v1.3.0-Windows,check messages
v1.3.0-Windows,In settings.json first activate computer vision mode:
v1.3.0-Windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.0-Windows,monitor car state while you drive it manually.
v1.3.0-Windows,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v1.3.0-Windows,denominator from microns^3 to microns * m^2)
v1.3.0-Windows,First set everything to 0.
v1.3.0-Windows,Next set all objects of interest provided to corresponding object IDs
v1.3.0-Windows,segIdDict values MUST match tempEmissivityNew labels.
v1.3.0-Windows,"Connect to AirSim, UAV mode."
v1.3.0-Windows,Choose temperature values for winter or summer.
v1.3.0-Windows,""""""""
v1.3.0-Windows,winter
v1.3.0-Windows,""""""""
v1.3.0-Windows,summer
v1.3.0-Windows,Read camera response.
v1.3.0-Windows,Calculate radiance.
v1.3.0-Windows,Set IDs in AirSim environment.
v1.3.0-Windows,plot red arrows for 30 seconds
v1.3.0-Windows,plot magenta arrows for 15 seconds
v1.3.0-Windows,plot red arrows for 10 seconds
v1.3.0-Windows,plot 2 white arrows which are persistent
v1.3.0-Windows,plot points
v1.3.0-Windows,"plot line strip. 0-1, 1-2, 2-3"
v1.3.0-Windows,"plot line list. 0-1, 2-3, 4-5. Must be even."
v1.3.0-Windows,plot transforms
v1.3.0-Windows,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=0.0, yaw=yaw)) for x, y, yaw in zip(np.linspace(0,10,10), np.linspace(0,0,10), np.linspace(0,np.pi,10))],"
v1.3.0-Windows,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.3.0-Windows,"client.simPlotTransforms(poses = [Pose(position_val=Vector3r(x,y,0), orientation_val=to_quaternion(pitch=0.0, roll=roll, yaw=0.0)) for x, y, roll in zip(np.linspace(0,10,10), np.linspace(1,1,10), np.linspace(0,np.pi,10))],"
v1.3.0-Windows,"scale = 35, thickness = 5, duration = 1200.0, is_persistent = False)"
v1.3.0-Windows,In settings.json first activate computer vision mode:
v1.3.0-Windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.0-Windows,"define abstract class to return next vector in the format (x,y,yaw)"
v1.3.0-Windows,"compute vector, distance and angle to goal"
v1.3.0-Windows,compute box of interest
v1.3.0-Windows,scale by weight matrix (optional)
v1.3.0-Windows,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.3.0-Windows,detect collision
v1.3.0-Windows,compute box of interest
v1.3.0-Windows,detect collision
v1.3.0-Windows,Same as above but decide to go left or right based on average or some metric like that
v1.3.0-Windows,"compute resultant normalized vector, distance and angle"
v1.3.0-Windows,compute bounding box size
v1.3.0-Windows,convert horizonal fov to vertical fov
v1.3.0-Windows,matrix with all ones
v1.3.0-Windows,matrix with max weight in center and decreasing linearly with distance from center
v1.3.0-Windows,matrix with max weight in center and decreasing quadratically with distance from center
v1.3.0-Windows,"print (""Saving images to %s"" % tmp_dir)"
v1.3.0-Windows,airsim.wait_key('Press any key to start')
v1.3.0-Windows,"Define start position, goal and size of UAV"
v1.3.0-Windows,Define parameters and thresholds
v1.3.0-Windows,initial position
v1.3.0-Windows,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.3.0-Windows,time.sleep(1)
v1.3.0-Windows,get response
v1.3.0-Windows,get numpy array
v1.3.0-Windows,reshape array to 2D array H X W
v1.3.0-Windows,write to png
v1.3.0-Windows,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.3.0-Windows,pose = client.simGetPose()
v1.3.0-Windows,pp.pprint(pose)
v1.3.0-Windows,time.sleep(5)
v1.3.0-Windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.3.0-Windows,################### OLD CODE
v1.3.0-Windows,timer = 0
v1.3.0-Windows,time_obs = 50
v1.3.0-Windows,bObstacle = False
v1.3.0-Windows,if (bObstacle):
v1.3.0-Windows,timer = timer + 1
v1.3.0-Windows,if timer > time_obs:
v1.3.0-Windows,bObstacle = False
v1.3.0-Windows,timer = 0
v1.3.0-Windows,else:
v1.3.0-Windows,yaw = target_angle
v1.3.0-Windows,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.3.0-Windows,if (np.average(img2d_box) < coll_thres):
v1.3.0-Windows,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.3.0-Windows,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.3.0-Windows,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.3.0-Windows,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.3.0-Windows,"print('left: ', img2d_box_l_avg)"
v1.3.0-Windows,"print('right: ', img2d_box_r_avg)"
v1.3.0-Windows,if img2d_box_l_avg > img2d_box_r_avg:
v1.3.0-Windows,##Go LEFT
v1.3.0-Windows,#y_offset = y_offset-1
v1.3.0-Windows,yaw = yaw - radians(10)
v1.3.0-Windows,bObstacle = True
v1.3.0-Windows,else:
v1.3.0-Windows,##Go RIGHT
v1.3.0-Windows,#y_offset = y_offset+1
v1.3.0-Windows,yaw = yaw + radians(10)
v1.3.0-Windows,bObstacle = true
v1.3.0-Windows,"print('yaw: ', yaw)"
v1.3.0-Windows,In settings.json first activate computer vision mode:
v1.3.0-Windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.0-Windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.3.0-Windows,In settings.json first activate computer vision mode:
v1.3.0-Windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.0-Windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.3.0-Windows,pip install opencv-python
v1.3.0-Windows,In settings.json first activate computer vision mode:
v1.3.0-Windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.0-Windows,for block environment
v1.3.0-Windows,regex are case insensitive
v1.3.0-Windows,#for neighborhood environment
v1.3.0-Windows,set object ID for sky
v1.3.0-Windows,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.3.0-Windows,get segmentation image in various formats
v1.3.0-Windows,save segmentation images in various formats
v1.3.0-Windows,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.3.0-Windows,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.3.0-Windows,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v1.3.0-Windows,find unique colors
v1.3.0-Windows,In settings.json first activate computer vision mode:
v1.3.0-Windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.0-Windows,objects can be named in two ways:
v1.3.0-Windows,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.3.0-Windows,default name is auto-generated and varies from run-to-run.
v1.3.0-Windows,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.3.0-Windows,
v1.3.0-Windows,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.3.0-Windows,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.3.0-Windows,https://answers.unrealengine.com/revisions/790629.html
v1.3.0-Windows,below works in Blocks environment
v1.3.0-Windows,------------------------------------ Get current pose ------------------------------------------------
v1.3.0-Windows,search object by name:
v1.3.0-Windows,search another object by tag
v1.3.0-Windows,search non-existent object
v1.3.0-Windows,------------------------------------ Set new pose ------------------------------------------------
v1.3.0-Windows,here we move with teleport enabled so collisions are ignored
v1.3.0-Windows,here we move with teleport enabled so collisions are not ignored
v1.3.0-Windows,move non-existent object
v1.3.0-Windows,------------------------------------ Get new pose ------------------------------------------------
v1.3.0-Windows,search another object by tag
v1.3.0-Windows,search non-existent object
v1.3.0-Windows,Import this module to automatically setup path to local airsim module
v1.3.0-Windows,This module first tries to see if airsim module is installed via pip
v1.3.0-Windows,If it does then we don't do anything else
v1.3.0-Windows,Else we look up grand-parent folder to see if it has airsim folder
v1.3.0-Windows,and if it does then we add that in sys.path
v1.3.0-Windows,this class simply tries to see if airsim
v1.3.0-Windows,if airsim module is installed then don't do anything else
v1.3.0-Windows,import pkgutil
v1.3.0-Windows,airsim_loader = pkgutil.find_loader('airsim')
v1.3.0-Windows,if airsim_loader is not None:
v1.3.0-Windows,return
v1.3.0-Windows,"Roll is applied first, then pitch, then yaw."
v1.3.0-Windows,Turn the camera position into a column vector.
v1.3.0-Windows,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v1.3.0-Windows,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v1.3.0-Windows,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v1.3.0-Windows,Recreate the perspective projection of the camera.
v1.3.0-Windows,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v1.3.0-Windows,Set pose and sleep after to ensure the pose sticks before capturing image.
v1.3.0-Windows,Capture segmentation (IR) and scene images.
v1.3.0-Windows,Change images into numpy arrays.
v1.3.0-Windows,Capture images for a certain amount of time in seconds (half hour now)
v1.3.0-Windows,Capture image - pose.position x_val access may change w/ AirSim
v1.3.0-Windows,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v1.3.0-Windows,Convert color scene image to BGR for write out with cv2.
v1.3.0-Windows,"Connect to AirSim, UAV mode."
v1.3.0-Windows,Look for objects with names that match a regular expression.
v1.3.0-Windows,"Sample calls to main, varying camera angle and altitude."
v1.3.0-Windows,"straight down, 400ft"
v1.3.0-Windows,"straight down, 200ft"
v1.3.0-Windows,"45 degrees, 200ft -- note that often object won't be scene since position"
v1.3.0-Windows,is set exactly to object's
v1.3.0-Windows,"45 degrees, 400ft -- note that often object won't be scene since position"
v1.3.0-Windows,is set exactly to object's
v1.3.0-Windows,In settings.json first activate computer vision mode:
v1.3.0-Windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.0-Windows,xn = 1 + x*5  # some random number
v1.3.0-Windows,currently reset() doesn't work in CV mode. Below is the workaround
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,monitor car state while you drive it manually.
v1.3.0-Windows,get state of the car
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,go forward
v1.3.0-Windows,get state of the car
v1.3.0-Windows,Python client example to change time-of-day using APIs
v1.3.0-Windows,
v1.3.0-Windows,Changes time of the day and makes the car move around
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,flip between specific time and default time
v1.3.0-Windows,go forward
v1.3.0-Windows,Go forward + steer right
v1.3.0-Windows,main
v1.3.0-Windows,import gym #pip install gym
v1.3.0-Windows,Local variable access is faster in loops
v1.3.0-Windows,"if not wrapping over current pointer,"
v1.3.0-Windows,then check if there is terminal state wrapped inside
v1.3.0-Windows,"If index > history_length, take from a slice"
v1.3.0-Windows,Metrics accumulator
v1.3.0-Windows,Action Value model (used by agent to interact with the environment)
v1.3.0-Windows,"Target model used to compute the target Q-values in training, updated"
v1.3.0-Windows,less frequently for increased stability.
v1.3.0-Windows,Function computing Q-values targets as part of the computation graph
v1.3.0-Windows,"Define the loss, using Huber Loss (more robust to outliers)"
v1.3.0-Windows,Compute the q_targets
v1.3.0-Windows,actions is a 1-hot encoding of the action done by the agent
v1.3.0-Windows,Define training criterion as the Huber Loss function
v1.3.0-Windows,Adam based SGD
v1.3.0-Windows,self._trainer.restore_from_checkpoint('models/oldmodels/model800000')
v1.3.0-Windows,Append the state to the short term memory (ie. History)
v1.3.0-Windows,"If policy requires agent to explore, sample random action"
v1.3.0-Windows,Use the network to output the best action
v1.3.0-Windows,Append batch axis with only one sample to evaluate
v1.3.0-Windows,Return the value maximizing the expected reward
v1.3.0-Windows,Keep track of interval action counter
v1.3.0-Windows,"If done, reset short term memory (ie. History)"
v1.3.0-Windows,Plot the metrics through Tensorboard and reset buffers
v1.3.0-Windows,Reset the short term memory
v1.3.0-Windows,Append to long term memory
v1.3.0-Windows,Update the Target Network if needed
v1.3.0-Windows,print(dist)
v1.3.0-Windows,Make RL agent
v1.3.0-Windows,Train
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,get state of the car
v1.3.0-Windows,go forward
v1.3.0-Windows,Go forward + steer right
v1.3.0-Windows,go reverse
v1.3.0-Windows,apply brakes
v1.3.0-Windows,get camera images from the car
v1.3.0-Windows,restore to original state
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,go forward
v1.3.0-Windows,Python client example to get Lidar data from a car
v1.3.0-Windows,
v1.3.0-Windows,Makes the drone fly and get Lidar data
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,"print(""state: %s"" % s)"
v1.3.0-Windows,go forward
v1.3.0-Windows,Go forward + steer right
v1.3.0-Windows,"reshape array of floats to array of [X,Y,Z]"
v1.3.0-Windows,TODO
v1.3.0-Windows,main
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,get state of the car
v1.3.0-Windows,go forward
v1.3.0-Windows,Go forward + steer right
v1.3.0-Windows,go reverse
v1.3.0-Windows,apply breaks
v1.3.0-Windows,restore to original state
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,get camera images from the car
v1.3.0-Windows,that's enough fun for now. let's quit cleanly
v1.3.0-Windows,Import this module to automatically setup path to local airsim module
v1.3.0-Windows,This module first tries to see if airsim module is installed via pip
v1.3.0-Windows,If it does then we don't do anything else
v1.3.0-Windows,Else we look up grand-parent folder to see if it has airsim folder
v1.3.0-Windows,and if it does then we add that in sys.path
v1.3.0-Windows,this class simply tries to see if airsim
v1.3.0-Windows,if airsim module is installed then don't do anything else
v1.3.0-Windows,import pkgutil
v1.3.0-Windows,airsim_loader = pkgutil.find_loader('airsim')
v1.3.0-Windows,if airsim_loader is not None:
v1.3.0-Windows,return
v1.3.0-Windows,Use below in settings.json with blocks environment
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,get state of the car
v1.3.0-Windows,go forward
v1.3.0-Windows,go reverse
v1.3.0-Windows,apply breaks
v1.3.0-Windows,get camera images from the car
v1.3.0-Windows,restore to original state
v1.3.0-Windows,from keras.models import load_model
v1.3.0-Windows,if (len(sys.argv) != 2):
v1.3.0-Windows,print('usage: python drive.py <modelName>')
v1.3.0-Windows,sys.exit()
v1.3.0-Windows,print('Loading model...')
v1.3.0-Windows,model = load_model(sys.argv[1])
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.3.0-Windows,"model_output = model.predict([image_buf, state_buf])"
v1.3.0-Windows,car_controls.steering = float(model_output[0][0])
v1.3.0-Windows,!/usr/bin/env python
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,start = time.time()
v1.3.0-Windows,get state of the car
v1.3.0-Windows,milliseconds = (time.time() - start) * 1000
v1.3.0-Windows,populate PoseStamped ros message
v1.3.0-Windows,log PoseStamped message
v1.3.0-Windows,publish PoseStamped message
v1.3.0-Windows,sleeps until next cycle
v1.3.0-Windows,!/usr/bin/env python
v1.3.0-Windows,Example ROS node for publishing AirSim images.
v1.3.0-Windows,AirSim Python API
v1.3.0-Windows,ROS Image message
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,get camera images from the car
v1.3.0-Windows,Populate image message
v1.3.0-Windows,log time and size of published image
v1.3.0-Windows,publish image message
v1.3.0-Windows,sleep until next cycle
v1.3.0-Windows,!/usr/bin/env python
v1.3.0-Windows,Example ROS node for publishing AirSim images.
v1.3.0-Windows,ROS Image message
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,get camera images from the car
v1.3.0-Windows,Populate image message
v1.3.0-Windows,log time and size of published image
v1.3.0-Windows,publish image message
v1.3.0-Windows,sleep until next cycle
v1.3.0-Windows,Import this module to automatically setup path to local airsim module
v1.3.0-Windows,This module first tries to see if airsim module is installed via pip
v1.3.0-Windows,If it does then we don't do anything else
v1.3.0-Windows,Else we look up grand-parent folder to see if it has airsim folder
v1.3.0-Windows,and if it does then we add that in sys.path
v1.3.0-Windows,this class simply tries to see if airsim
v1.3.0-Windows,if airsim module is installed then don't do anything else
v1.3.0-Windows,import pkgutil
v1.3.0-Windows,airsim_loader = pkgutil.find_loader('airsim')
v1.3.0-Windows,if airsim_loader is not None:
v1.3.0-Windows,return
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,MultirotorClient.wait_key('Press any key to takeoff')
v1.3.0-Windows,Local variable access is faster in loops
v1.3.0-Windows,"if not wrapping over current pointer,"
v1.3.0-Windows,then check if there is terminal state wrapped inside
v1.3.0-Windows,"If index > history_length, take from a slice"
v1.3.0-Windows,Metrics accumulator
v1.3.0-Windows,Action Value model (used by agent to interact with the environment)
v1.3.0-Windows,"Target model used to compute the target Q-values in training, updated"
v1.3.0-Windows,less frequently for increased stability.
v1.3.0-Windows,Function computing Q-values targets as part of the computation graph
v1.3.0-Windows,"Define the loss, using Huber Loss (more robust to outliers)"
v1.3.0-Windows,Compute the q_targets
v1.3.0-Windows,actions is a 1-hot encoding of the action done by the agent
v1.3.0-Windows,Define training criterion as the Huber Loss function
v1.3.0-Windows,Adam based SGD
v1.3.0-Windows,Append the state to the short term memory (ie. History)
v1.3.0-Windows,"If policy requires agent to explore, sample random action"
v1.3.0-Windows,Use the network to output the best action
v1.3.0-Windows,Append batch axis with only one sample to evaluate
v1.3.0-Windows,Return the value maximizing the expected reward
v1.3.0-Windows,Keep track of interval action counter
v1.3.0-Windows,"If done, reset short term memory (ie. History)"
v1.3.0-Windows,Plot the metrics through Tensorboard and reset buffers
v1.3.0-Windows,Reset the short term memory
v1.3.0-Windows,Append to long term memory
v1.3.0-Windows,Update the Target Network if needed
v1.3.0-Windows,print(dist)
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,Make RL agent
v1.3.0-Windows,Train
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,get camera images from the car
v1.3.0-Windows,that's enough fun for now. let's quit cleanly
v1.3.0-Windows,teleport the drone + 10 meters in x-direction
v1.3.0-Windows,teleport the drone back
v1.3.0-Windows,use open cv to create point cloud from depth image.
v1.3.0-Windows,###########################################
v1.3.0-Windows,######### This is work in progress! #######
v1.3.0-Windows,###########################################
v1.3.0-Windows,file will be saved in PythonClient folder (i.e. same folder as script)
v1.3.0-Windows,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.3.0-Windows,skip it
v1.3.0-Windows,AirSim uses NED coordinates so negative axis is up.
v1.3.0-Windows,z of -7 is 7 meters above the original launch point.
v1.3.0-Windows,Fly given velocity vector for 5 seconds
v1.3.0-Windows,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.3.0-Windows,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.3.0-Windows,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.3.0-Windows,Make the drone fly in a circle.
v1.3.0-Windows,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.3.0-Windows,check that our home position is stable
v1.3.0-Windows,AirSim uses NED coordinates so negative axis is up.
v1.3.0-Windows,ramp up time
v1.3.0-Windows,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.3.0-Windows,compute current angle
v1.3.0-Windows,compute lookahead
v1.3.0-Windows,if we did the takeoff then also do the landing.
v1.3.0-Windows,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.3.0-Windows,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.3.0-Windows,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.3.0-Windows,ignore the click over from 360 back to 0
v1.3.0-Windows,watch direction this diff is moving if it switches from shrinking to growing
v1.3.0-Windows,then we passed the starting point.
v1.3.0-Windows,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.3.0-Windows,AirSim uses NED coordinates so negative axis is up.
v1.3.0-Windows,z of -7 is 7 meters above the original launch point.
v1.3.0-Windows,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.3.0-Windows,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.3.0-Windows,drone will over-shoot so we bring it back to the start point before landing.
v1.3.0-Windows,change clock speed in settings.json
v1.3.0-Windows,"""ClockSpeed"": 0.5"
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,that's enough fun for now. let's quit cleanly
v1.3.0-Windows,In settings.json first activate computer vision mode:
v1.3.0-Windows,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.3.0-Windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.3.0-Windows,pip install opencv-python
v1.3.0-Windows,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.3.0-Windows,Python client example to get Lidar data from a drone
v1.3.0-Windows,
v1.3.0-Windows,Makes the drone fly and get Lidar data
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,"print(""state: %s"" % s)"
v1.3.0-Windows,"print(""state: %s"" % pprint.pformat(state))"
v1.3.0-Windows,"reshape array of floats to array of [X,Y,Z]"
v1.3.0-Windows,TODO
v1.3.0-Windows,main
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,AirSim uses NED coordinates so negative axis is up.
v1.3.0-Windows,let it settle there a bit.
v1.3.0-Windows,after hovering we need to re-enabled api control for next leg of the trip
v1.3.0-Windows,now compute the survey path required to fill the box
v1.3.0-Windows,Use below in settings.json with Blocks environment
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,get camera images from the car
v1.3.0-Windows,that's enough fun for now. let's quit cleanly
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,Import this module to automatically setup path to local airsim module
v1.3.0-Windows,This module first tries to see if airsim module is installed via pip
v1.3.0-Windows,If it does then we don't do anything else
v1.3.0-Windows,Else we look up grand-parent folder to see if it has airsim folder
v1.3.0-Windows,and if it does then we add that in sys.path
v1.3.0-Windows,this class simply tries to see if airsim
v1.3.0-Windows,if airsim module is installed then don't do anything else
v1.3.0-Windows,import pkgutil
v1.3.0-Windows,airsim_loader = pkgutil.find_loader('airsim')
v1.3.0-Windows,if airsim_loader is not None:
v1.3.0-Windows,return
v1.3.0-Windows,"this script moves the drone to a location, then rests it thousands of time"
v1.3.0-Windows,purpose of this script is to stress test reset API
v1.3.0-Windows,connect to the AirSim simulator
v1.3.0-Windows,that's enough fun for now. let's quite cleanly
v1.3.0-Windows,use open cv to show new images from AirSim
v1.3.0-Windows,requires Python 3.5.3 :: Anaconda 4.4.0
v1.3.0-Windows,pip install opencv-python
v1.3.0-Windows,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.3.0-Windows,get depth image
v1.3.0-Windows,"this will return png width= 256, height= 144"
v1.3.0-Windows,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.3.0-Windows,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.3.0-Windows,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.3.0-Windows,to get an estimate of distance.
v1.3.0-Windows,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.3.0-Windows,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.3.0-Windows,an angular delta of the following pi/10.
v1.3.0-Windows,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.3.0-Windows,Remove alpha channel if exists
v1.3.0-Windows,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.3.0-Windows,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.3.0-Windows,Flatten and yield as tuple
v1.3.0-Windows,Initialize a resizable dataset to hold the output
v1.3.0-Windows,Resize the dataset to accommodate the next chunk of rows
v1.3.0-Windows,Create the next chunk
v1.3.0-Windows,Increment the row count
v1.3.0-Windows,Arguments
v1.3.0-Windows,Returns
v1.3.0-Windows,use composition of homographies
v1.3.0-Windows,to generate final transform that needs to be applied
v1.3.0-Windows,Arguments
v1.3.0-Windows,Returns
v1.3.0-Windows,Keeps under lock only the mechanism which advances
v1.3.0-Windows,the indexing of each batch.
v1.3.0-Windows,The transformation of images is not under thread lock
v1.3.0-Windows,so it can be done in parallel
v1.3.0-Windows,Trained model path
v1.3.0-Windows,Connect to AirSim
v1.3.0-Windows,Start driving
v1.3.0-Windows,Initialize image buffer
v1.3.0-Windows,Update throttle value according to steering angle
v1.3.0-Windows,Prediction
v1.3.0-Windows,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.3.0-Windows,Print progress
v1.3.0-Windows,Update next car state
v1.3.0-Windows,Wait a bit between iterations
v1.3.0-Windows,%matplotlib inline
v1.3.0-Windows,chunk size for training batches
v1.3.0-Windows,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.3.0-Windows,Point this to the directory containing the raw data
v1.3.0-Windows,Point this to the desired output directory for the cooked (.h5) data
v1.3.0-Windows,Choose The folders to search for data under RAW_DATA_DIR
v1.3.0-Windows,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.3.0-Windows,data_folder.append('folder_name1')
v1.3.0-Windows,data_folder.append('folder_name2')
v1.3.0-Windows,...
v1.3.0-Windows,Hyper-parameters
v1.3.0-Windows,Activation functions
v1.3.0-Windows,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.3.0-Windows,<< The directory containing the cooked data from the previous step >>
v1.3.0-Windows,<< The directory in which the model output will be placed >>
v1.3.0-Windows,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.3.0-Windows,Network definition
v1.3.0-Windows,Import this module to automatically setup path to local airsim module
v1.3.0-Windows,This module first tries to see if airsim module is installed via pip
v1.3.0-Windows,If it does then we don't do anything else
v1.3.0-Windows,Else we look up grand-parent folder to see if it has airsim folder
v1.3.0-Windows,and if it does then we add that in sys.path
v1.3.0-Windows,this class simply tries to see if airsim
v1.3.0-Windows,if airsim module is installed then don't do anything else
v1.3.0-Windows,import pkgutil
v1.3.0-Windows,airsim_loader = pkgutil.find_loader('airsim')
v1.3.0-Windows,if airsim_loader is not None:
v1.3.0-Windows,return
v1.3.0-Windows,DEY: I don't know why this was there.
v1.3.0-Windows,-----------------------------------  Common vehicle APIs ---------------------------------------------
v1.3.0-Windows,basic flight control
v1.3.0-Windows,time-of-day control
v1.3.0-Windows,weather
v1.3.0-Windows,camera control
v1.3.0-Windows,simGetImage returns compressed png in array of bytes
v1.3.0-Windows,image_type uses one of the ImageType members
v1.3.0-Windows,"todo: in future remove below, it's only for compatibility to pre v1.2"
v1.3.0-Windows,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.3.0-Windows,camera control
v1.3.0-Windows,simGetImage returns compressed png in array of bytes
v1.3.0-Windows,image_type uses one of the ImageType members
v1.3.0-Windows,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.3.0-Windows,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.3.0-Windows,sensor APIs
v1.3.0-Windows,Plotting APIs
v1.3.0-Windows,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.3.0-Windows,APIs for control
v1.3.0-Windows,low-level control API
v1.3.0-Windows,query vehicle state
v1.3.0-Windows,-----------------------------------  Car APIs ---------------------------------------------
v1.3.0-Windows,helper method for converting getOrientation to roll/pitch/yaw
v1.3.0-Windows,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.3.0-Windows,roll (x-axis rotation)
v1.3.0-Windows,pitch (y-axis rotation)
v1.3.0-Windows,yaw (z-axis rotation)
v1.3.0-Windows,DEY: I don't know why this was there.
v1.3.0-Windows,reverse the vertical line order and add null bytes at the start
v1.3.0-Windows,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.3.0-Windows,return cls(**msgpack.unpack(encoded))
v1.3.0-Windows,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.3.0-Windows,"in header only mode, control library is not available"
v1.3.0-Windows,if using Unreal Build system then include precompiled header file first
v1.3.0-Windows,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.3.0-Windows,"Windows, OSX and Linux."
v1.3.0-Windows,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.3.0-Windows,Windows users can move the Documents folder to any location they want
v1.3.0-Windows,SHGetFolderPath knows how to find it.
v1.3.0-Windows,fall back in case SHGetFolderPath failed for some reason.
v1.3.0-Windows,convert from std::path '/' to windows backslash.
v1.3.0-Windows,make the current thread run with maximum priority.
v1.3.0-Windows,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.3.0-Windows,TODO: How to handle POSIX thread priorities on OSX?
v1.3.0-Windows,setThreadName is a helper function that is useful when debugging because your threads
v1.3.0-Windows,show up in the debugger with the name you set which makes it easier to find the threads
v1.3.0-Windows,that you are interested in.
v1.3.0-Windows,"unfortunately this is only available on Windows 10, and AirSim is not limited to that."
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.3.0-Windows,
v1.3.0-Windows,Treat all errors as failure conditions.
v1.3.0-Windows,parse command line
v1.3.0-Windows,"motive gives a weird error if the project is not found, so we look for it."
v1.3.0-Windows,Do an update to pick up any recently-arrived cameras.
v1.3.0-Windows,List all detected cameras.
v1.3.0-Windows,List all defined rigid bodies.
v1.3.0-Windows,throttle to 50 messages per second.
v1.3.0-Windows,OptiTrack uses 'y' axis for vertical.
v1.3.0-Windows,stdafx.cpp : source file that includes just the standard includes
v1.3.0-Windows,MavlinkMoCap.pch will be the pre-compiled header
v1.3.0-Windows,stdafx.obj will contain the pre-compiled type information
v1.3.0-Windows,TODO: reference any additional headers you need in STDAFX.H
v1.3.0-Windows,and not in this file
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,PX4.cpp : Defines the entry point for the console application.
v1.3.0-Windows,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.3.0-Windows,how do you write to the debug output windows on Unix ?
v1.3.0-Windows,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.3.0-Windows,connection to create to talke to that server.
v1.3.0-Windows,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.3.0-Windows,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.3.0-Windows,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.3.0-Windows,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.3.0-Windows,using their the -qgc option.
v1.3.0-Windows,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.3.0-Windows,this switch controls whether we turn off the RC remote active link loss detection
v1.3.0-Windows,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.3.0-Windows,from kicking in when you try and fly.
v1.3.0-Windows,can't use experimental stuff on Linux because of potential ABI issues
v1.3.0-Windows,parse the json
v1.3.0-Windows,flatten inner mavlink object
v1.3.0-Windows,flatten inner mavlink object
v1.3.0-Windows,todo
v1.3.0-Windows,todo
v1.3.0-Windows,"const char* outLogFileOption = ""outlogfile"";"
v1.3.0-Windows,parse command line
v1.3.0-Windows,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.3.0-Windows,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.3.0-Windows,"no local serial connection, so this is the primary droneConnection."
v1.3.0-Windows,failed to connect
v1.3.0-Windows,"local connection, then we own sending the heartbeat."
v1.3.0-Windows,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.3.0-Windows,cmdTable.push_back(new AltHoldCommand());
v1.3.0-Windows,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.3.0-Windows,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.3.0-Windows,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.3.0-Windows,this stops us from being able to connect to SITL mode PX4.
v1.3.0-Windows,checkPulse();
v1.3.0-Windows,add command text in log
v1.3.0-Windows,close previous command.
v1.3.0-Windows,FilterLogFiles(logDirectory);
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,send a heartbeat
v1.3.0-Windows,accept one incoming connection
v1.3.0-Windows,send a heartbeat to the client
v1.3.0-Windows,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.3.0-Windows,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.3.0-Windows,for this unit test we are expecting a request to send an image.
v1.3.0-Windows,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.3.0-Windows,hmmm
v1.3.0-Windows,================ ls
v1.3.0-Windows,================ put file
v1.3.0-Windows,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.3.0-Windows,================ get file
v1.3.0-Windows,verify the file contents.
v1.3.0-Windows,================ remove file
v1.3.0-Windows,================ make directory
v1.3.0-Windows,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.3.0-Windows,================ remove directory
v1.3.0-Windows,Now verification
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,from main.cpp.
v1.3.0-Windows,you must call this method if you want HandleMessage to be called subsequently.
v1.3.0-Windows,treat literals as one word
v1.3.0-Windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.3.0-Windows,request gps info
v1.3.0-Windows,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.3.0-Windows,find relative position since command start so we can compare two commands better
v1.3.0-Windows,TODO: make below future proof (i.e. usable by C++17 compiler) - also change same in main.cpp
v1.3.0-Windows,can't use experimental stuff on Linux because of potential ABI issues
v1.3.0-Windows,"these PID values are important, so set these to match"
v1.3.0-Windows,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.3.0-Windows,we can skip ahead.
v1.3.0-Windows,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.3.0-Windows,TODO: avoid passing hadcoded HIL flag
v1.3.0-Windows,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.3.0-Windows,"The global position, as returned by the Global Positioning System (GPS)."
v1.3.0-Windows,Provides state for additional features
v1.3.0-Windows,The general system state
v1.3.0-Windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.3.0-Windows,Provides state for additional features
v1.3.0-Windows,The general system state
v1.3.0-Windows,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.3.0-Windows,Provides state for additional features
v1.3.0-Windows,The general system state
v1.3.0-Windows,Provides state for additional features
v1.3.0-Windows,The general system state
v1.3.0-Windows,note: we do not reset com when Close() is called because we want to keep running.
v1.3.0-Windows,"user has to invoke ""hil stop"" to stop the hil thread."
v1.3.0-Windows,generate random between 0 and 1
v1.3.0-Windows,move to range -1 to 1
v1.3.0-Windows,scale it
v1.3.0-Windows,apply iy
v1.3.0-Windows,wait for the Execute method to be called.
v1.3.0-Windows,gps is much slower frequency than IMU.
v1.3.0-Windows,MAVLINK_MSG_ID_HIL_GPS
v1.3.0-Windows,disable MAV_USEHILGPS
v1.3.0-Windows,note: we do not reset com when Close() is called because we want to keep running.
v1.3.0-Windows,"user has to invoke ""hil stop"" to stop the hil thread."
v1.3.0-Windows,generate random between 0 and 1
v1.3.0-Windows,move to range -1 to 1
v1.3.0-Windows,scale it
v1.3.0-Windows,apply iy
v1.3.0-Windows,wait for the Execute method to be called.
v1.3.0-Windows,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.3.0-Windows,gps is much slower frequency than IMU.
v1.3.0-Windows,MAVLINK_MSG_ID_HIL_GPS
v1.3.0-Windows,disable HIL mode
v1.3.0-Windows,Enumeration of landed detector states
v1.3.0-Windows,MAV landed state is unknown
v1.3.0-Windows,MAV is landed (on ground)
v1.3.0-Windows,MAV is in air
v1.3.0-Windows,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.3.0-Windows,The filtered local position
v1.3.0-Windows,must send these regularly to keep offboard control.
v1.3.0-Windows,"ok, now we can safely switch to loiter."
v1.3.0-Windows,must send these regularly to keep offboard control.
v1.3.0-Windows,integrate the heading so it is smoother.
v1.3.0-Windows,must send these regularly to keep offboard control.
v1.3.0-Windows,integrate the heading so it is smoother.
v1.3.0-Windows,fly to radius
v1.3.0-Windows,it takes about 10 cm to stop and turn.
v1.3.0-Windows,next time around switch to orbiting!
v1.3.0-Windows,heading points to center of circle.
v1.3.0-Windows,interpoloate the speed ramp up time over 2 seconds from start time
v1.3.0-Windows,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.3.0-Windows,monitor the sin curves so we can see how on track or off track it actually is.
v1.3.0-Windows,the shape of the curve will also tell us if we are progressing at a consistent
v1.3.0-Windows,"speed, the more deformed the sin curve the worse our progress."
v1.3.0-Windows,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.3.0-Windows,degrees just flipped from 359 to 0.
v1.3.0-Windows,this enables us to test what happens when offboard control is lost and resumed.
v1.3.0-Windows,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.3.0-Windows,"ok, now we can start moving by velocity"
v1.3.0-Windows,recompute to new target.
v1.3.0-Windows,start by moving right with 10 degree roll.
v1.3.0-Windows,haven't started yet.
v1.3.0-Windows,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.3.0-Windows,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.3.0-Windows,track how our actual pitch is coming along compared to our target
v1.3.0-Windows,and check position
v1.3.0-Windows,the amount of pitch should depend on our speed in that direction.
v1.3.0-Windows,passed the midpoint.
v1.3.0-Windows,fade out the pitch as we pick up speed so we don't overshoot.
v1.3.0-Windows,see if we just crossed the wiggle distance threshold.
v1.3.0-Windows,(pitch affects the x-position).
v1.3.0-Windows,reverse direction with a -30 degrees quick stop
v1.3.0-Windows,reverse direction with a 30 degrees quick stop
v1.3.0-Windows,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.3.0-Windows,too much in that direction.
v1.3.0-Windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.3.0-Windows,track how our actual roll is coming along compared to our target
v1.3.0-Windows,and check position
v1.3.0-Windows,the amount of roll should depend on our speed in that direction.
v1.3.0-Windows,passed the midpoint.
v1.3.0-Windows,fade out the roll as we pick up speed so we don't overshoot.
v1.3.0-Windows,see if we just crossed the wiggle distance threshold.
v1.3.0-Windows,(roll affects the y-position).
v1.3.0-Windows,reverse direction with a -30 degrees quick stop
v1.3.0-Windows,reverse direction with a 30 degrees quick stop
v1.3.0-Windows,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.3.0-Windows,too much in that direction.
v1.3.0-Windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.3.0-Windows,for testing PID controller.
v1.3.0-Windows,class AltHoldCommand : public Command
v1.3.0-Windows,{
v1.3.0-Windows,std::shared_ptr<MavLinkVehicle> channel;
v1.3.0-Windows,"float sx_, sy_, sz_;"
v1.3.0-Windows,MavLinkAttitudeTarget _current;
v1.3.0-Windows,PidController thrust_controller_;
v1.3.0-Windows,public:
v1.3.0-Windows,this->sz_ = pos.z; // user defined target.
v1.3.0-Windows,move to local position keeps the offboard control happy.
v1.3.0-Windows,haven't started yet.
v1.3.0-Windows,and check position
v1.3.0-Windows,double dx = this->sx_ - pos.x;
v1.3.0-Windows,double dy = this->sy_ - pos.y;
v1.3.0-Windows,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.3.0-Windows,too much in that direction.
v1.3.0-Windows,adjust thrust so we keep steady height target
v1.3.0-Windows,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.3.0-Windows,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.3.0-Windows,local remote
v1.3.0-Windows,already handled by the parse method.
v1.3.0-Windows,we only support very simple patterns for now.
v1.3.0-Windows,each wildcard must be separated by literal.
v1.3.0-Windows,back to back wildcards with no literal in between is too complex.
v1.3.0-Windows,"we only support simple matching for now, we can add full regex later if we need it."
v1.3.0-Windows,yep!
v1.3.0-Windows,'*' is done we found the next matching char
v1.3.0-Windows,this is ok.
v1.3.0-Windows,this is an ERASE_END_LINE command which we ignore.
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,unpack the message...
v1.3.0-Windows,pack the payload buffer.
v1.3.0-Windows,"json can't handle ""nan"", so we convert it to null."
v1.3.0-Windows,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.3.0-Windows,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,start listening to this connection
v1.3.0-Windows,Send heartbeat to drone.  You should not do this if some other node is
v1.3.0-Windows,already doing it.
v1.3.0-Windows,stop listening to the connection.
v1.3.0-Windows,get the connection
v1.3.0-Windows,Get the local system and component id
v1.3.0-Windows,send a command to the remote node
v1.3.0-Windows,MavLinkNode::MavLinkNode() = default;
v1.3.0-Windows,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.3.0-Windows,decrementing the count so the next WaitOne may block.
v1.3.0-Windows,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.3.0-Windows,convert to absolute time.
v1.3.0-Windows,use mach_timespec
v1.3.0-Windows,convert to absolute time.
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,return true if we still have offboard control (can lose this if user flips the switch).
v1.3.0-Windows,MavLinkVehicle::MavLinkVehicle() = default;
v1.3.0-Windows,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.3.0-Windows,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,============================== CLIENT ============================================
v1.3.0-Windows,image APIs
v1.3.0-Windows,or if you are implementing the client side call this function to get the most recent frame.
v1.3.0-Windows,returns false if there is no new frame available.
v1.3.0-Windows,============================== SERVER ============================================
v1.3.0-Windows,call this to send the image back over the connection given to start function.
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,"log every message that is ""sent"" using sendMessage."
v1.3.0-Windows,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.3.0-Windows,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.3.0-Windows,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.3.0-Windows,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,for compatibility with QGroundControl we have to save the time field in big endian.
v1.3.0-Windows,todo: mavlink2 support?
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,start listening to this connection
v1.3.0-Windows,Send heartbeat to drone.  You should not do this if some other node is
v1.3.0-Windows,already doing it.
v1.3.0-Windows,this is called for all messages received on the connection.
v1.3.0-Windows,"we received a heartbeat, so let's get the capabilities."
v1.3.0-Windows,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.3.0-Windows,subclasses remembering to call this base implementation.
v1.3.0-Windows,stop listening to the connection.
v1.3.0-Windows,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.3.0-Windows,wait for a heartbeat msg since this will give us the port to send commands to...
v1.3.0-Windows,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.3.0-Windows,send a heart beat so that the remote node knows we are still alive
v1.3.0-Windows,(otherwise drone will trigger a failsafe operation).
v1.3.0-Windows,ignore any failures here because we are running in our own thread here.
v1.3.0-Windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.0-Windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.0-Windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.0-Windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.0-Windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.0-Windows,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.3.0-Windows,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.3.0-Windows,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.3.0-Windows,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.3.0-Windows,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.3.0-Windows,"ok, now fetch the missing parameters."
v1.3.0-Windows,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.3.0-Windows,silently fail since we are on a background thread here...
v1.3.0-Windows,tell the caller this is complete.
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,add our custom telemetry message length.
v1.3.0-Windows,todo: if we support signing then initialize
v1.3.0-Windows,mavlink_intermediate_status_.signing callbacks
v1.3.0-Windows,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.3.0-Windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.3.0-Windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.3.0-Windows,send this right away just in case serial link is not already configured
v1.3.0-Windows,"log every message that is ""sent"" using sendMessage."
v1.3.0-Windows,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.3.0-Windows,pack the payload buffer.
v1.3.0-Windows,calculate checksum
v1.3.0-Windows,mavlink2 supports trimming the payload of trailing zeros so the messages
v1.3.0-Windows,are variable length as a result.
v1.3.0-Windows,form the header as a byte array for the crc
v1.3.0-Windows,these macros use old style cast.
v1.3.0-Windows,forward messages from our connected node to the remote proxy.
v1.3.0-Windows,tell the remote connection to expect mavlink2 messages.
v1.3.0-Windows,forward messages from remote proxy to local connected node
v1.3.0-Windows,CurrentThread::setMaximumPriority();
v1.3.0-Windows,"hmmm, wait till it is opened?"
v1.3.0-Windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.3.0-Windows,pick up the sysid/compid of the remote node we are connected to.
v1.3.0-Windows,then this is a mavlink 1 message
v1.3.0-Windows,then this mavlink sender supports mavlink 2
v1.3.0-Windows,queue event for publishing.
v1.3.0-Windows,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.3.0-Windows,as it ensures we don't lose messages if the listener is slow.
v1.3.0-Windows,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.3.0-Windows,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.3.0-Windows,we would get a deadlock.
v1.3.0-Windows,CurrentThread::setMaximumPriority();
v1.3.0-Windows,reset counters
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,------------------------------------------------------------------------------
v1.3.0-Windows,Defines
v1.3.0-Windows,------------------------------------------------------------------------------
v1.3.0-Windows,bit number  876543210987654321
v1.3.0-Windows,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.3.0-Windows,in future it would be good to have ability to add system IDs we are interested in
v1.3.0-Windows,if (msg.sysid != getTargetSystemId())
v1.3.0-Windows,{
v1.3.0-Windows,// we only care about messages from our intended remote node.
v1.3.0-Windows,return;
v1.3.0-Windows,}
v1.3.0-Windows,user may have changed modes on us! So we need to honor that and not
v1.3.0-Windows,try and take it back.
v1.3.0-Windows,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.3.0-Windows,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.3.0-Windows,we can store up to 16 channels in rc_channels_scaled.
v1.3.0-Windows,The RAW values of the servo outputs
v1.3.0-Windows,Metrics typically displayed on a HUD for fixed wing aircraft
v1.3.0-Windows,The IMU readings in SI units in NED body frame
v1.3.0-Windows,printSystemStatus(&msg);
v1.3.0-Windows,todo: use this to determine when we need to do emergency landing...
v1.3.0-Windows,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.3.0-Windows,Provides state for additional features
v1.3.0-Windows,The general system state
v1.3.0-Windows,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.3.0-Windows,but we do want to know when we get the ack.  So this is async ACK processing!
v1.3.0-Windows,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.3.0-Windows,if threshold < 0 then the threshold is inverted.
v1.3.0-Windows,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.3.0-Windows,Convert it to a floating point number between -1 and 1.
v1.3.0-Windows,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.3.0-Windows,until the move commands start happening.
v1.3.0-Windows,return true if user calls requestControl and has not called releaseControl.
v1.3.0-Windows,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.3.0-Windows,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.3.0-Windows,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.3.0-Windows,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.3.0-Windows,send a few to make sure it gets through...
v1.3.0-Windows,now the command should succeed.
v1.3.0-Windows,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.3.0-Windows,us by which time the PX4 times out offboard mode!!
v1.3.0-Windows,this mode change take precedence over offboard mode.
v1.3.0-Windows,thrust must be between -1 and 1.
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,These definitions are copied from PX4 implementation
v1.3.0-Windows,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.3.0-Windows,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.3.0-Windows,/ @brief Command opcodes
v1.3.0-Windows,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.3.0-Windows,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.3.0-Windows,must trim trailing slashes so PX4 doesn't hang!
v1.3.0-Windows,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.3.0-Windows,from the source.
v1.3.0-Windows,check if directory exists.
v1.3.0-Windows,perfect.
v1.3.0-Windows,use last_message_ so we preserve the sessionid.
v1.3.0-Windows,"could not create the local file, so stop."
v1.3.0-Windows,must use last_message_ so we preserve the session id.
v1.3.0-Windows,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.3.0-Windows,todo: error handling here? sequence is out of order...
v1.3.0-Windows,"directory must be empty then, can't do nextStep because"
v1.3.0-Windows,it will just loop for ever re-requesting zero offset into
v1.3.0-Windows,empty directory.
v1.3.0-Windows,result should be a list of null terminated file names.
v1.3.0-Windows,skipping this entry
v1.3.0-Windows,remove the file size field.
v1.3.0-Windows,"printf(""%s\n"", name.c_str());"
v1.3.0-Windows,request the next batch.
v1.3.0-Windows,"perhaps this was a late response after we did a retry, so ignore it."
v1.3.0-Windows,"perhaps this was a late response after we did a retry, so ignore it."
v1.3.0-Windows,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.3.0-Windows,reached the end of the list or the file.
v1.3.0-Windows,end of file or directory listing.
v1.3.0-Windows,"success, data should be following..."
v1.3.0-Windows,ack on this cmd is a noop
v1.3.0-Windows,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.3.0-Windows,give up then.
v1.3.0-Windows,tell watchdog we are sending a request
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,================================= CLIENT ==============================================================
v1.3.0-Windows,Check if we have a valid transaction
v1.3.0-Windows,emit signal if all packets arrived
v1.3.0-Windows,Restart statemachine
v1.3.0-Windows,image APIs
v1.3.0-Windows,================================= SERVER ==============================================================
v1.3.0-Windows,Prepare and send acknowledgment packet
v1.3.0-Windows,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.3.0-Windows,Send ENCAPSULATED_IMAGE packet
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.3.0-Windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.3.0-Windows,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.3.0-Windows,send this right away just in case serial link is not already configured
v1.3.0-Windows,CurrentThread::setMaximumPriority();
v1.3.0-Windows,"hmmm, wait till it is opened?"
v1.3.0-Windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.3.0-Windows,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.3.0-Windows,queue event for publishing.
v1.3.0-Windows,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.3.0-Windows,as it ensures we don't lose messages if the listener is slow.
v1.3.0-Windows,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.3.0-Windows,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.3.0-Windows,we would get a deadlock.
v1.3.0-Windows,CurrentThread::setMaximumPriority();
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.3.0-Windows,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.3.0-Windows,parse out the VID number
v1.3.0-Windows,now the PID
v1.3.0-Windows,parse out the VID number
v1.3.0-Windows,examples:
v1.3.0-Windows,PX4: USB\VID_26AC&PID_0011\0
v1.3.0-Windows,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.3.0-Windows,"printf(""Found: %S\n"", buffer.c_str());"
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.3.0-Windows,parse out the VID number
v1.3.0-Windows,now the PID
v1.3.0-Windows,parse out the VID number
v1.3.0-Windows,suppress
v1.3.0-Windows,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,This has not been properly tested
v1.3.0-Windows,struct iw_statistics stats;
v1.3.0-Windows,struct iwreq req;
v1.3.0-Windows,"memset(&stats, 0, sizeof(stats));"
v1.3.0-Windows,"memset(&req, 0, sizeof(iwreq));"
v1.3.0-Windows,
v1.3.0-Windows,"strncpy(req.ifr_name, ifaceName, 16);"
v1.3.0-Windows,req.u.data.pointer = &stats;
v1.3.0-Windows,req.u.data.length = sizeof(iw_statistics);
v1.3.0-Windows,
v1.3.0-Windows,#ifdef CLEAR_UPDATED
v1.3.0-Windows,req.u.data.flags = 1;
v1.3.0-Windows,#endif
v1.3.0-Windows,
v1.3.0-Windows,/* Perform the ioctl */
v1.3.0-Windows,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.3.0-Windows,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.3.0-Windows,return -127;
v1.3.0-Windows,}
v1.3.0-Windows,
v1.3.0-Windows,return stats.qual.level;
v1.3.0-Windows,todo: windows version of this...
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,windows
v1.3.0-Windows,Need to link with Ws2_32.lib
v1.3.0-Windows,posix
v1.3.0-Windows,found it!
v1.3.0-Windows,bind socket to local address.
v1.3.0-Windows,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.3.0-Windows,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.3.0-Windows,write to the serial port
v1.3.0-Windows,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.3.0-Windows,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.3.0-Windows,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.3.0-Windows,"try and receive something, up until port is closed anyway."
v1.3.0-Windows,"message was too large for the buffer, no problem, return what we have."
v1.3.0-Windows,try again - this can happen if server recreates the socket on their side.
v1.3.0-Windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.3.0-Windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.3.0-Windows,"printf(""#### recv failed with error: %d\n"", hr);"
v1.3.0-Windows,we now have it.
v1.3.0-Windows,this is from someone we are not interested in.
v1.3.0-Windows,-----------------------------------------------------------------------------------------
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,Initialize Winsock
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,windows
v1.3.0-Windows,Need to link with Ws2_32.lib
v1.3.0-Windows,posix
v1.3.0-Windows,found it!
v1.3.0-Windows,bind socket to local address.
v1.3.0-Windows,bind socket to local address.
v1.3.0-Windows,start listening for incoming connection
v1.3.0-Windows,accept 1
v1.3.0-Windows,"don't need to accept any more, so we can close this one."
v1.3.0-Windows,write to the serial port
v1.3.0-Windows,"try and receive something, up until port is closed anyway."
v1.3.0-Windows,"message was too large for the buffer, no problem, return what we have."
v1.3.0-Windows,try again - this can happen if server recreates the socket on their side.
v1.3.0-Windows,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.3.0-Windows,try again - this can happen if server recreates the socket on their side.
v1.3.0-Windows,-----------------------------------------------------------------------------------------
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.3.0-Windows,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.3.0-Windows,set signal
v1.3.0-Windows,Clear Handshake flags
v1.3.0-Windows,Set Handshake flags
v1.3.0-Windows,return GetLastError();
v1.3.0-Windows,return GetLastError();
v1.3.0-Windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.3.0-Windows,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.3.0-Windows,enable reading
v1.3.0-Windows,posix doesn't have mark/space parity.
v1.3.0-Windows,posix doesn't have mark/space parity.
v1.3.0-Windows,this is the default.
v1.3.0-Windows,not sure this is supported...
v1.3.0-Windows,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.3.0-Windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.3.0-Windows,First do those specified by POSIX.
v1.3.0-Windows,Now conditionally handle a bunch of extended rates.
v1.3.0-Windows,First do those specified by POSIX.
v1.3.0-Windows,Now conditionally handle a bunch of extended rates.
v1.3.0-Windows,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.3.0-Windows,import airsim
v1.3.0-Windows,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v1.3.0-Windows,self.args = args
v1.3.0-Windows,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v1.3.0-Windows,pdb.set_trace()
v1.3.0-Windows,#include <pluginlib/class_list_macros.h>
v1.3.0-Windows,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v1.3.0-Windows,intitialize placeholder control commands
v1.3.0-Windows,vel_cmd_ = VelCmd();
v1.3.0-Windows,gimbal_cmd_ = GimbalCmd();
v1.3.0-Windows,todo do not reset if already in air?
v1.3.0-Windows,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v1.3.0-Windows,ros params
v1.3.0-Windows,todo enforce dynamics constraints in this node as well?
v1.3.0-Windows,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v1.3.0-Windows,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v1.3.0-Windows,XmlRpc::XmlRpcValue can't be const in this case
v1.3.0-Windows,subscribe to control commands on global nodehandle
v1.3.0-Windows,vehicle_setting_vec_.clear();
v1.3.0-Windows,vehicle_imu_map_;
v1.3.0-Windows,callback_queues_.clear();
v1.3.0-Windows,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v1.3.0-Windows,auto vehicle_setting_local = vehicle_setting.get();
v1.3.0-Windows,bind to a single callback. todo optimal subs queue length
v1.3.0-Windows,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v1.3.0-Windows,"multirotor_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v1.3.0-Windows,"iterate over camera map std::map<std::string, CameraSetting> cameras;"
v1.3.0-Windows,vehicle_setting_vec_.push_back(*vehicle_setting.get());
v1.3.0-Windows,camera_setting.gimbal
v1.3.0-Windows,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v1.3.0-Windows,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v1.3.0-Windows,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v1.3.0-Windows,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v1.3.0-Windows,"if {DepthPlanner, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v1.3.0-Windows,"push back pair (vector of image captures, current vehicle name)"
v1.3.0-Windows,"iterate over sensors std::map<std::string, std::unique_ptr<SensorSetting>> sensors;"
v1.3.0-Windows,"todo this is pretty non scalable, refactor airsim and ros api and maintain a vehicle <-> sensor (setting) map"
v1.3.0-Windows,add takeoff and land all services if more than 2 drones
v1.3.0-Windows,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v1.3.0-Windows,todo add per vehicle reset in AirLib API
v1.3.0-Windows,todo mimic gazebo's /use_sim_time feature which publishes airsim's clock time..via an rpc call?!
v1.3.0-Windows,"clock_pub_ = nh_private_.advertise<rosgraph_msgs::Clock>(""clock"", 10);"
v1.3.0-Windows,"if >0 cameras, add one more thread for img_request_timer_cb"
v1.3.0-Windows,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v1.3.0-Windows,"todo: error check. if state is not landed, return error."
v1.3.0-Windows,response.success =
v1.3.0-Windows,response.success =
v1.3.0-Windows,response.success =
v1.3.0-Windows,response.success =
v1.3.0-Windows,response.success =
v1.3.0-Windows,response.success =
v1.3.0-Windows,todo add reset by vehicle_name API to airlib
v1.3.0-Windows,todo not async remove waitonlasttask
v1.3.0-Windows,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v1.3.0-Windows,todo do actual body frame?
v1.3.0-Windows,airsim uses degrees
v1.3.0-Windows,todo do actual body frame?
v1.3.0-Windows,airsim uses degrees
v1.3.0-Windows,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v1.3.0-Windows,todo expose waitOnLastTask or nah?
v1.3.0-Windows,todo do actual body frame?
v1.3.0-Windows,airsim uses degrees
v1.3.0-Windows,this is kinda unnecessary but maybe it makes life easier for the end user.
v1.3.0-Windows,todo expose waitOnLastTask or nah?
v1.3.0-Windows,todo support multiple gimbal commands
v1.3.0-Windows,todo support multiple gimbal commands
v1.3.0-Windows,1. find quaternion of default gimbal pose
v1.3.0-Windows,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v1.3.0-Windows,3. call airsim client's setcameraorientation which sets camera orientation wrt world (or takeoff?) ned frame. todo
v1.3.0-Windows,odom_ned_msg.header.frame_id = world_frame_id_;
v1.3.0-Windows,"odom_ned_msg.child_frame_id = ""/airsim/odom_local_ned""; // todo make param"
v1.3.0-Windows,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v1.3.0-Windows,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v1.3.0-Windows,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v1.3.0-Windows,msg = []
v1.3.0-Windows,todo covariances
v1.3.0-Windows,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v1.3.0-Windows,todo radians per second
v1.3.0-Windows,meters/s2^m
v1.3.0-Windows,imu_msg.orientation_covariance = ;
v1.3.0-Windows,imu_msg.angular_velocity_covariance = ;
v1.3.0-Windows,imu_msg.linear_acceleration_covariance = ;
v1.3.0-Windows,todo unused
v1.3.0-Windows,void AirsimROSWrapper::set_zero_vel_cmd()
v1.3.0-Windows,{
v1.3.0-Windows,vel_cmd_.x = 0.0;
v1.3.0-Windows,vel_cmd_.y = 0.0;
v1.3.0-Windows,vel_cmd_.z = 0.0;
v1.3.0-Windows,vel_cmd_.drivetrain = msr::airlib::DrivetrainType::MaxDegreeOfFreedom;
v1.3.0-Windows,vel_cmd_.yaw_mode.is_rate = false;
v1.3.0-Windows,// todo make class member or a fucntion
v1.3.0-Windows,"double roll, pitch, yaw;"
v1.3.0-Windows,"tf2::Matrix3x3(get_tf2_quat(curr_drone_state_.kinematics_estimated.pose.orientation)).getRPY(roll, pitch, yaw); // ros uses xyzw"
v1.3.0-Windows,vel_cmd_.yaw_mode.yaw_or_rate = yaw;
v1.3.0-Windows,}
v1.3.0-Windows,todo this is global origin
v1.3.0-Windows,iterate over drones
v1.3.0-Windows,get drone state from airsim
v1.3.0-Windows,convert airsim drone state to ROS msgs
v1.3.0-Windows,publish to ROS!
v1.3.0-Windows,send control commands from the last callback to airsim
v1.3.0-Windows,"""clear"" control cmds"
v1.3.0-Windows,IMUS
v1.3.0-Windows,imu_msg.header.stamp = ros::Time::now();
v1.3.0-Windows,"we've sent these static transforms, so no need to keep sending them"
v1.3.0-Windows,todo add and expose a gimbal angular velocity to airlib
v1.3.0-Windows,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v1.3.0-Windows,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v1.3.0-Windows,std::lock_guard<std::recursive_mutex> guard(drone_control_mutex_);
v1.3.0-Windows,std::lock_guard<std::recursive_mutex> guard(lidar_mutex_);
v1.3.0-Windows,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v1.3.0-Windows,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v1.3.0-Windows,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v1.3.0-Windows,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v1.3.0-Windows,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v1.3.0-Windows,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v1.3.0-Windows,"if a render request failed for whatever reason, this img will be empty."
v1.3.0-Windows,Attempting to use a make_ts(0) results in ros::Duration runtime error.
v1.3.0-Windows,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v1.3.0-Windows,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v1.3.0-Windows,todo simGetCameraInfo is wrong + also it's only for image type -1.
v1.3.0-Windows,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v1.3.0-Windows,update timestamp of saved cam info msgs
v1.3.0-Windows,DepthPlanner / DepthPerspective / DepthVis / DisparityNormalized
v1.3.0-Windows,Scene / Segmentation / SurfaceNormals / Infrared
v1.3.0-Windows,publish camera transforms
v1.3.0-Windows,camera poses are obtained from airsim's client API which are in (local) NED frame.
v1.3.0-Windows,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v1.3.0-Windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v1.3.0-Windows,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v1.3.0-Windows,ROS params
v1.3.0-Windows,ROS publishers
v1.3.0-Windows,ROS subscribers
v1.3.0-Windows,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v1.3.0-Windows,ROS timers
v1.3.0-Windows,todo maintain internal representation as eigen vec?
v1.3.0-Windows,todo check if low velocity if within thresh?
v1.3.0-Windows,todo maintain separate errors for XY and Z
v1.3.0-Windows,todo save this in degrees somewhere to avoid repeated conversion
v1.3.0-Windows,this tells the update timer callback to not do active hovering
v1.3.0-Windows,todo maintain array of position goals
v1.3.0-Windows,todo error checks
v1.3.0-Windows,todo fill response
v1.3.0-Windows,this tells the update timer callback to not do active hovering
v1.3.0-Windows,todo error checks
v1.3.0-Windows,todo fill response
v1.3.0-Windows,"todo do relative altitude, or add an option for the same?"
v1.3.0-Windows,convert GPS goal to NED goal
v1.3.0-Windows,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.3.0-Windows,todo error checks
v1.3.0-Windows,todo fill response
v1.3.0-Windows,"todo do relative altitude, or add an option for the same?"
v1.3.0-Windows,convert GPS goal to NED goal
v1.3.0-Windows,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v1.3.0-Windows,todo error checks
v1.3.0-Windows,todo fill response
v1.3.0-Windows,todo check if odometry is too old!!
v1.3.0-Windows,"if no odom, don't do anything."
v1.3.0-Windows,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v1.3.0-Windows,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v1.3.0-Windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.3.0-Windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.3.0-Windows,todo yaw limits
v1.3.0-Windows,todo just add a sgn funciton in common utils? return double to be safe.
v1.3.0-Windows,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v1.3.0-Windows,check if path exists
v1.3.0-Windows,todo airsim's simhud.cpp does error checking here
v1.3.0-Windows,mimics void ASimHUD::initializeSettings()
v1.3.0-Windows,not sure where settings_json initialized in AirSimSettings::initializeSettings() is actually used
v1.3.0-Windows,int num_threads = 1;
v1.3.0-Windows,ros::MultiThreadedSpinner multi_thread(num_threads);
v1.3.0-Windows,multi_thread.spin();
v1.3.0-Windows,ros::AsyncSpinner async_spinner(num_threads);
v1.3.0-Windows,async_spinner.start();
v1.3.0-Windows,single threaded spinner
v1.3.0-Windows,","
v1.3.0-Windows,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.3.0-Windows,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,"in header only mode, control library is not available"
v1.3.0-Windows,TODO: something defines max macro which interfears with code here
v1.3.0-Windows,is cur_pos within fence?
v1.3.0-Windows,destination risk is not available then consider it zero
v1.3.0-Windows,if dest risk is lower than its more safe
v1.3.0-Windows,are we doing better than closest obstacle?
v1.3.0-Windows,"if we stay where we are, what is the risk distance?"
v1.3.0-Windows,else we are better of moving to dest
v1.3.0-Windows,this function should work even when dest_pos == cur_pos
v1.3.0-Windows,is this dest_pos cur_pos within the fence?
v1.3.0-Windows,transform dest_pos vector to body frame
v1.3.0-Windows,check for approx zero vectors to avoid random yaw angles
v1.3.0-Windows,we are hovering
v1.3.0-Windows,"get yaw in body frame, ie, front is always 0 radians"
v1.3.0-Windows,yaw to ticks
v1.3.0-Windows,get obstacles in the window at the tick direction around the window
v1.3.0-Windows,less risk distance is better
v1.3.0-Windows,check obstacles around current position and see if it has lower risk
v1.3.0-Windows,else obstacle is too far
v1.3.0-Windows,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.3.0-Windows,look for each surrounding tick to see if we have obstacle free angle
v1.3.0-Windows,else no suggestions required
v1.3.0-Windows,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.3.0-Windows,evaluate right and left side of circle
v1.3.0-Windows,find right and left risk distances
v1.3.0-Windows,at this point we have already determined hover is better than going to dest
v1.3.0-Windows,we now determine is moving to suggested angle better than hovering?
v1.3.0-Windows,check if dest_pos is safe
v1.3.0-Windows,breaking distance at this velocity
v1.3.0-Windows,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.3.0-Windows,check if dest_pos is safe
v1.3.0-Windows,float/vec parameters can have NaN which makes them optional
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,"in header only mode, control library is not available"
v1.3.0-Windows,handles +/- tick and wraps around circle
v1.3.0-Windows,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.3.0-Windows,update the specified window on the map
v1.3.0-Windows,make sure from <= to
v1.3.0-Windows,normalize the ticks so both are valid indices
v1.3.0-Windows,if from is still larger then
v1.3.0-Windows,to ticks is then added one full circle to make it larger than from_tick
v1.3.0-Windows,find closest obstacle in given window
v1.3.0-Windows,search whole map to find closest obstacle
v1.3.0-Windows,"in header only mode, control library is not available"
v1.3.0-Windows,#include <fileapi.h>
v1.3.0-Windows,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.3.0-Windows,"Windows, OSX and Linux."
v1.3.0-Windows,Windows users can move the Documents folder to any location they want
v1.3.0-Windows,SHGetFolderPath knows how to find it.
v1.3.0-Windows,fall back in case SHGetFolderPath failed for some reason.
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,"in header only mode, control library is not available"
v1.3.0-Windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.0-Windows,if using Unreal Build system then include precompiled header file first
v1.3.0-Windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.0-Windows,this deadlocks UI thread if async_run was called while there are pending rpc calls.
v1.3.0-Windows,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.3.0-Windows,Exit if already resetting.
v1.3.0-Windows,Reset
v1.3.0-Windows,if we don't suppress then server will bomb out for exceptions raised by any method
v1.3.0-Windows,required for pimpl
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,"in header only mode, control library is not available"
v1.3.0-Windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.0-Windows,if using Unreal Build system then include precompiled header file first
v1.3.0-Windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.0-Windows,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.3.0-Windows,make sure we can talk to the DroneServer
v1.3.0-Windows,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.3.0-Windows,command_context.client.ping();
v1.3.0-Windows,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.3.0-Windows,sim only
v1.3.0-Windows,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.3.0-Windows,return value of last task. It should be true if task completed without
v1.3.0-Windows,cancellation or timeout
v1.3.0-Windows,"should be implemented by derived class if it supports async task,"
v1.3.0-Windows,for example using futures
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,"in header only mode, control library is not available"
v1.3.0-Windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.0-Windows,if using Unreal Build system then include precompiled header file first
v1.3.0-Windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,"in header only mode, control library is not available"
v1.3.0-Windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.0-Windows,if using Unreal Build system then include precompiled header file first
v1.3.0-Windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.0-Windows,required for pimpl
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,"in header only mode, control library is not available"
v1.3.0-Windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.0-Windows,if using Unreal Build system then include precompiled header file first
v1.3.0-Windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.0-Windows,status getters
v1.3.0-Windows,return value of last task. It should be true if task completed without
v1.3.0-Windows,cancellation or timeout
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,"in header only mode, control library is not available"
v1.3.0-Windows,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.3.0-Windows,if using Unreal Build system then include pre-compiled header file first
v1.3.0-Windows,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.3.0-Windows,getters
v1.3.0-Windows,required for pimpl
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,"in header only mode, control library is not available"
v1.3.0-Windows,last command is to hold on to position
v1.3.0-Windows,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.3.0-Windows,after landing we detect if drone has stopped moving
v1.3.0-Windows,validate path size
v1.3.0-Windows,validate yaw mode
v1.3.0-Windows,validate and set auto-lookahead value
v1.3.0-Windows,if auto mode requested for lookahead then calculate based on velocity
v1.3.0-Windows,add current position as starting point
v1.3.0-Windows,append the input path and compute segments
v1.3.0-Windows,add last segment as zero length segment so we have equal number of segments and points.
v1.3.0-Windows,path_segs[i] refers to segment that starts at point i
v1.3.0-Windows,"when path ends, we want to slow down"
v1.3.0-Windows,else no need to change velocities for last segments
v1.3.0-Windows,setup current position on path to 0 offset
v1.3.0-Windows,initialize next path position
v1.3.0-Windows,until we are at the end of the path (last seg is always zero size)
v1.3.0-Windows,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.3.0-Windows,send drone command to get to next lookahead
v1.3.0-Windows,sleep for rest of the cycle
v1.3.0-Windows,how much have we moved towards last goal?
v1.3.0-Windows,project actual vector on goal vector
v1.3.0-Windows,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.3.0-Windows,TODO: below should be lower than 1E3 and configurable
v1.3.0-Windows,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.3.0-Windows,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.3.0-Windows,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.3.0-Windows,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.3.0-Windows,"if drone moved backward, we don't want goal to move backward as well"
v1.3.0-Windows,"so only climb forward on the path, never back. Also note >= which means"
v1.3.0-Windows,we climb path even if distance was 0 to take care of duplicated points on path
v1.3.0-Windows,else
v1.3.0-Windows,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.3.0-Windows,compute next target on path
v1.3.0-Windows,freeze the quaternion
v1.3.0-Windows,convert RC commands to velocity vector
v1.3.0-Windows,find yaw as per terrain and remote setting
v1.3.0-Windows,execute command
v1.3.0-Windows,if timeout occurred then command completed successfully otherwise it was interrupted
v1.3.0-Windows,change yaw by moving to same position but constant yaw mode
v1.3.0-Windows,by default we say that this command is not supported
v1.3.0-Windows,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.3.0-Windows,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.3.0-Windows,get trims
v1.3.0-Windows,take average
v1.3.0-Windows,validate dest
v1.3.0-Windows,what is the distance we will travel at this velocity?
v1.3.0-Windows,get velocity vector
v1.3.0-Windows,yaw for the direction of travel
v1.3.0-Windows,find velocity vector
v1.3.0-Windows,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.3.0-Windows,generate velocity vector that is same size as cur_dest_norm / command period
v1.3.0-Windows,this velocity vect when executed for command period would yield cur_dest_norm
v1.3.0-Windows,send commands
v1.3.0-Windows,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.3.0-Windows,default strategy is for move. In hover mode we set new strategy temporarily
v1.3.0-Windows,are we supposed to do EM?
v1.3.0-Windows,get suggested velocity vector
v1.3.0-Windows,use the unchecked command
v1.3.0-Windows,tell caller not to execute planned command
v1.3.0-Windows,other wise throw exception
v1.3.0-Windows,otherwise there is some other reason why we are in unsafe situation
v1.3.0-Windows,send last command to come to full stop
v1.3.0-Windows,else no unsafe situation
v1.3.0-Windows,note: cur_path_loc and next_path_loc may both point to same object
v1.3.0-Windows,"otherwise use up this segment, move on to next one"
v1.3.0-Windows,if we are here then we ran out of segments
v1.3.0-Windows,consider last segment as zero length segment
v1.3.0-Windows,adjust yaw for the direction of travel in forward-only mode
v1.3.0-Windows,else no adjustment needed
v1.3.0-Windows,if auto mode requested for lookahead then calculate based on velocity
v1.3.0-Windows,Create a spring arm component for our chase camera
v1.3.0-Windows,"do nothing, spring arm is pulling the camera with it"
v1.3.0-Windows,"do nothing, we have camera turned off"
v1.3.0-Windows,set initial view mode
v1.3.0-Windows,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.3.0-Windows,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.3.0-Windows,"If the lag is missing, the camera will also occasionally shake."
v1.3.0-Windows,"But, lag is not desired when piloting a drone"
v1.3.0-Windows,attach spring arm to actor
v1.3.0-Windows,remember current parent for external camera. Later when we remove external
v1.3.0-Windows,"camera from spring arm, we will attach it back to its last parent"
v1.3.0-Windows,now attach camera to spring arm
v1.3.0-Windows,"For car, we need to move the camera back a little more than for a drone."
v1.3.0-Windows,"Otherwise, the camera will be stuck inside the car"
v1.3.0-Windows,ExternalCamera->bUsePawnControlRotation = false;
v1.3.0-Windows,detach spring arm
v1.3.0-Windows,Re-enable rendering
v1.3.0-Windows,Remove any existing key bindings for manual mode
v1.3.0-Windows,"else someone else is bound to manual pose controller, leave it alone"
v1.3.0-Windows,if new mode is manual mode then add key bindings
v1.3.0-Windows,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.3.0-Windows,other modes don't need special setup
v1.3.0-Windows,make switch official
v1.3.0-Windows,Split the tag string into individual tags.
v1.3.0-Windows,Texture swap on actors that have all of those tags.
v1.3.0-Windows,----------- Plotting APIs ----------/
v1.3.0-Windows,"plot line for points 0-1, 1-2, 2-3"
v1.3.0-Windows,"plot line for points 0-1, 2-3, 4-5... must be even number of points"
v1.3.0-Windows,assert points_start.size() == poinst_end.size()
v1.3.0-Windows,assert positions.size() == strings.size()
v1.3.0-Windows,assert poses.size() == names.size()
v1.3.0-Windows,by default all image types are disabled
v1.3.0-Windows,use final color for all calculations
v1.3.0-Windows,TODO: avoid the need to override const cast here
v1.3.0-Windows,if the viewport is taller than it is wide
v1.3.0-Windows,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v1.3.0-Windows,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v1.3.0-Windows,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v1.3.0-Windows,use final color for all calculations
v1.3.0-Windows,TODO: should we be ignoring position and orientation settings here?
v1.3.0-Windows,TODO: can we eliminate storing NedTransform?
v1.3.0-Windows,if (!std::isnan(setting.target_gamma))
v1.3.0-Windows,camera-> = setting.target_gamma;
v1.3.0-Windows,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.3.0-Windows,else nothing to enable
v1.3.0-Windows,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.3.0-Windows,if (controller && controller->GetViewTarget() == this)
v1.3.0-Windows,controller->SetViewTarget(nullptr);
v1.3.0-Windows,TODO: explore screenshot option
v1.3.0-Windows,addScreenCaptureHandler(camera->GetWorld());
v1.3.0-Windows,TODO: may be we should have these methods non-const?
v1.3.0-Windows,We don't do game/render thread synchronization for safe method.
v1.3.0-Windows,We just blindly sleep for 200ms (the old way)
v1.3.0-Windows,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.3.0-Windows,Make sure that all alpha values are opaque.
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,"#include ""Runtime/Foliage/Public/FoliageType.h"""
v1.3.0-Windows,TODO: change naming conventions to same as other files?
v1.3.0-Windows,Enable/disable primary viewport rendering flag
v1.3.0-Windows,This disables rendering of the main viewport in the same way as the
v1.3.0-Windows,"console command ""show rendering"" would do."
v1.3.0-Windows,"When getting an image through the API, the image is produced after the render"
v1.3.0-Windows,thread has finished rendering the current and the subsequent frame. This means
v1.3.0-Windows,that the frame rate for obtaining images through the API is only half as high as
v1.3.0-Windows,"it could be, since only every other image is actually captured. We work around"
v1.3.0-Windows,this by telling the viewport to flush the rendering queue at the end of each
v1.3.0-Windows,drawn frame so that it executes our render request at that point already.
v1.3.0-Windows,Do this only if the main viewport is not being rendered anyway in case there are
v1.3.0-Windows,any adverse performance effects during main rendering.
v1.3.0-Windows,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v1.3.0-Windows,nothing to do for now
v1.3.0-Windows,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.3.0-Windows,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.3.0-Windows,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.3.0-Windows,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.3.0-Windows,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.3.0-Windows,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.3.0-Windows,{
v1.3.0-Windows,InitializeObjectStencilID(*comp);
v1.3.0-Windows,}
v1.3.0-Windows,Access the subclass instance with the * or -> operators.
v1.3.0-Windows,can we see followee?
v1.3.0-Windows,remove mapping
v1.3.0-Windows,removing binding
v1.3.0-Windows,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.3.0-Windows,"some point. At the moment, manually swapping Red and Blue"
v1.3.0-Windows,Copy scaled image into destination thumb
v1.3.0-Windows,Compress data - convert into a .png
v1.3.0-Windows,if we already have attached actor
v1.3.0-Windows,#ifdef _MSC_VER
v1.3.0-Windows,//print to VS output window
v1.3.0-Windows,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.3.0-Windows,#endif
v1.3.0-Windows,also do default logging
v1.3.0-Windows,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.3.0-Windows,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.3.0-Windows,{
v1.3.0-Windows,if (GEngine != nullptr)
v1.3.0-Windows,{
v1.3.0-Windows,return GEngine->GameUserSettings;
v1.3.0-Windows,}
v1.3.0-Windows,return nullptr;
v1.3.0-Windows,}
v1.3.0-Windows,UGameUserSettings* game_settings = GetGameUserSettings();
v1.3.0-Windows,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.3.0-Windows,game_settings->ApplySettings(true);
v1.3.0-Windows,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.3.0-Windows,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.3.0-Windows,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.3.0-Windows,todo unused. need to manually plots tf axes' line in right handed FLU instead of using DrawDebugCoordinateSystem
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,plugin startup
v1.3.0-Windows,plugin shutdown
v1.3.0-Windows,initialize state
v1.3.0-Windows,add listener for pawn's collision event
v1.3.0-Windows,compute our home point
v1.3.0-Windows,default behavior is to call update every tick
v1.3.0-Windows,"for custom physics engine, this method should be overridden and update should be"
v1.3.0-Windows,called from every physics tick
v1.3.0-Windows,add cameras that already exists in pawn
v1.3.0-Windows,create or replace cameras specified in settings
v1.3.0-Windows,setup individual cameras
v1.3.0-Windows,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.3.0-Windows,for each camera in settings
v1.3.0-Windows,get pose
v1.3.0-Windows,spawn and attach camera to pawn
v1.3.0-Windows,add on to our collection
v1.3.0-Windows,Deflect along the surface when we collide.
v1.3.0-Windows,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.3.0-Windows,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.3.0-Windows,-1 to 1 --> 0 to 1
v1.3.0-Windows,-1 to 1
v1.3.0-Windows,these will be available for devices like steering wheels
v1.3.0-Windows,switch index 0 to 7 for FrSky Taranis RC is:
v1.3.0-Windows,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.3.0-Windows,TODO: should below be at controller level info?
v1.3.0-Windows,else don't waste time
v1.3.0-Windows,sync environment from kinematics
v1.3.0-Windows,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.3.0-Windows,void playBack()
v1.3.0-Windows,{
v1.3.0-Windows,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.3.0-Windows,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.3.0-Windows,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.3.0-Windows,}
v1.3.0-Windows,TODO: refactor below code used for playback
v1.3.0-Windows,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.3.0-Windows,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.3.0-Windows,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.3.0-Windows,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.3.0-Windows,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.3.0-Windows,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.3.0-Windows,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.3.0-Windows,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.3.0-Windows,}
v1.3.0-Windows,parameters in NED frame
v1.3.0-Windows,translate to new PawnSimApi position & orientation from NED to NEU
v1.3.0-Windows,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.3.0-Windows,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.3.0-Windows,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.3.0-Windows,checked at the start of next tick
v1.3.0-Windows,allow teleportation
v1.3.0-Windows,if collisions are not enabled
v1.3.0-Windows,or we have collided but passthrough is enabled
v1.3.0-Windows,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.3.0-Windows,"without flip flopping, collisions can't be detected"
v1.3.0-Windows,update kinematics from pawn's movement instead of physics engine
v1.3.0-Windows,by default we update kinematics from UE pawn
v1.3.0-Windows,if SimMod uses its own physics engine then this should be overriden
v1.3.0-Windows,no default action in this base class
v1.3.0-Windows,TODO: because this bug we are using alternative code with stringstream
v1.3.0-Windows,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.3.0-Windows,std::stringstream ss;
v1.3.0-Windows,"ss << timestamp_millis << ""\t"";"
v1.3.0-Windows,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.3.0-Windows,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.3.0-Windows,"ss << ""\n"";"
v1.3.0-Windows,return ss.str();
v1.3.0-Windows,"read pixels from render target using render thread, then compress the result into PNG"
v1.3.0-Windows,argument on the thread that calls this method.
v1.3.0-Windows,TODO: is below really needed?
v1.3.0-Windows,make sure we are not on the rendering thread
v1.3.0-Windows,TODO: below doesn't work right now because it must be running in game thread
v1.3.0-Windows,below is documented method but more expensive because it forces flush
v1.3.0-Windows,wait for render thread to pick up our task
v1.3.0-Windows,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.3.0-Windows,capture CameraPose for this frame
v1.3.0-Windows,The completion is called immeidately after GameThread sends the
v1.3.0-Windows,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.3.0-Windows,execute *immediately* after RenderThread renders the scene!
v1.3.0-Windows,"while we're still on GameThread, enqueue request for capture the scene!"
v1.3.0-Windows,wait for this task to complete
v1.3.0-Windows,log a message and continue wait
v1.3.0-Windows,lamda function still references a few objects for which there is no refcount.
v1.3.0-Windows,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.3.0-Windows,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.3.0-Windows,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.3.0-Windows,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.3.0-Windows,Fill out your copyright notice in the Description page of Project Settings.
v1.3.0-Windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.0-Windows,UWorld* World = GetWorld();
v1.3.0-Windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.0-Windows,still need the menu class for f10
v1.3.0-Windows,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v1.3.0-Windows,showWeatherMenu(WorldContextObject);
v1.3.0-Windows,"if weather is not enabled, dont allow any weather values to be set"
v1.3.0-Windows,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v1.3.0-Windows,and must be set to true or false before this.
v1.3.0-Windows,WeatherEnabled will always be false
v1.3.0-Windows,"NOTE: weather enabled must be set first, before other params for this to work"
v1.3.0-Windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.0-Windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.0-Windows,"get all menu actors, if any"
v1.3.0-Windows,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.3.0-Windows,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v1.3.0-Windows,"get all menu actors, if any"
v1.3.0-Windows,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v1.3.0-Windows,"get all menu actors, if any, then hide the menu"
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,Stuff to filter out XInput devices
v1.3.0-Windows,-----------------------------------------------------------------------------
v1.3.0-Windows,"Defines, constants, and global variables"
v1.3.0-Windows,-----------------------------------------------------------------------------
v1.3.0-Windows,Magnitude ranges from -1 to 1
v1.3.0-Windows,Strength ranges from 0 to 1
v1.3.0-Windows,Autocenter
v1.3.0-Windows,Rumble
v1.3.0-Windows,Register with the DirectInput subsystem and get a pointer
v1.3.0-Windows,to a IDirectInput interface we can use.
v1.3.0-Windows,Create a DInput object
v1.3.0-Windows,Look for a simple joystick we can use for this sample program.
v1.3.0-Windows,Make sure we got a joystick
v1.3.0-Windows,"Set the data format to ""simple joystick"" - a predefined data format"
v1.3.0-Windows,
v1.3.0-Windows,"A data format specifies which controls on a device we are interested in,"
v1.3.0-Windows,and how they should be reported. This tells DInput that we will be
v1.3.0-Windows,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.3.0-Windows,Set the cooperative level to let DInput know how this device should
v1.3.0-Windows,interact with the system and with other DInput applications.
v1.3.0-Windows,Enumerate the joystick objects. The callback function enabled user
v1.3.0-Windows,"interface elements for objects that are found, and sets the min/max"
v1.3.0-Windows,values property for discovered axes.
v1.3.0-Windows,-----------------------------------------------------------------------------
v1.3.0-Windows,Enum each PNP device using WMI and check each device ID to see if it contains
v1.3.0-Windows,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.3.0-Windows,Unfortunately this information can not be found by just using DirectInput.
v1.3.0-Windows,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.3.0-Windows,XInput devices.
v1.3.0-Windows,
v1.3.0-Windows,This function stores the list of xinput devices in a linked list
v1.3.0-Windows,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.3.0-Windows,-----------------------------------------------------------------------------
v1.3.0-Windows,CoInit if needed
v1.3.0-Windows,Create WMI
v1.3.0-Windows,Create BSTRs for WMI
v1.3.0-Windows,Connect to WMI
v1.3.0-Windows,Switch security level to IMPERSONATE
v1.3.0-Windows,Get list of Win32_PNPEntity devices
v1.3.0-Windows,Loop over all devices
v1.3.0-Windows,Get 20 at a time
v1.3.0-Windows,"For each device, get its device ID"
v1.3.0-Windows,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.3.0-Windows,Unfortunately this information can not be found by just using DirectInput
v1.3.0-Windows,"If it does, then get the VID/PID from var.bstrVal"
v1.3.0-Windows,Add the VID/PID to a linked list
v1.3.0-Windows,-----------------------------------------------------------------------------
v1.3.0-Windows,Returns true if the DirectInput device is also an XInput device.
v1.3.0-Windows,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.3.0-Windows,-----------------------------------------------------------------------------
v1.3.0-Windows,Check each xinput device to see if this device's vid/pid matches
v1.3.0-Windows,-----------------------------------------------------------------------------
v1.3.0-Windows,Cleanup needed for IsXInputDevice()
v1.3.0-Windows,-----------------------------------------------------------------------------
v1.3.0-Windows,Cleanup linked list
v1.3.0-Windows,-----------------------------------------------------------------------------
v1.3.0-Windows,Name: EnumJoysticksCallback()
v1.3.0-Windows,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.3.0-Windows,device interface on it so we can play with it.
v1.3.0-Windows,-----------------------------------------------------------------------------
v1.3.0-Windows,Skip anything other than the perferred joystick device as defined by the control panel.
v1.3.0-Windows,Instead you could store all the enumerated joysticks and let the user pick.
v1.3.0-Windows,Obtain an interface to the enumerated joystick.
v1.3.0-Windows,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.3.0-Windows,it while we were in the middle of enumerating it.)
v1.3.0-Windows,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.3.0-Windows,could store all the enumerated joysticks and let the user pick.
v1.3.0-Windows,-----------------------------------------------------------------------------
v1.3.0-Windows,Name: EnumObjectsCallback()
v1.3.0-Windows,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.3.0-Windows,joystick. This function enables user interface elements for objects
v1.3.0-Windows,"that are found to exist, and scales axes min/max values."
v1.3.0-Windows,-----------------------------------------------------------------------------
v1.3.0-Windows,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.3.0-Windows,enumerated axis in order to scale min/max values.
v1.3.0-Windows,Set the range for the axis
v1.3.0-Windows,Set the UI to reflect what objects the joystick supports
v1.3.0-Windows,-----------------------------------------------------------------------------
v1.3.0-Windows,Name: UpdateInputState()
v1.3.0-Windows,Desc: Get the input device's state and display it.
v1.3.0-Windows,-----------------------------------------------------------------------------
v1.3.0-Windows,Poll the device to read the current state
v1.3.0-Windows,DInput is telling us that the input stream has been
v1.3.0-Windows,"interrupted. We aren't tracking any state between polls, so"
v1.3.0-Windows,we don't have any special reset that needs to be done. We
v1.3.0-Windows,just re-acquire and try again.
v1.3.0-Windows,while (hr == DIERR_INPUTLOST)
v1.3.0-Windows,hr = g_pJoystick->Acquire();
v1.3.0-Windows,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.3.0-Windows,may occur when the app is minimized or in the process of
v1.3.0-Windows,"switching, so just try again later"
v1.3.0-Windows,Get the input's device state
v1.3.0-Windows,Axes
v1.3.0-Windows,Slider controls
v1.3.0-Windows,Points of view
v1.3.0-Windows,Buttons
v1.3.0-Windows,-----------------------------------------------------------------------------
v1.3.0-Windows,Name: FreeDirectInput()
v1.3.0-Windows,Desc: Initialize the DirectInput variables.
v1.3.0-Windows,-----------------------------------------------------------------------------
v1.3.0-Windows,Unacquire the device one last time just in case
v1.3.0-Windows,the app tried to exit while the device is still acquired.
v1.3.0-Windows,Release any DirectInput objects.
v1.3.0-Windows,nop
v1.3.0-Windows,normalize min to max --> 0 to 1
v1.3.0-Windows,normalize 0 to 1 --> -1 to 1
v1.3.0-Windows,#include <libudev.h>
v1.3.0-Windows,implementation for unsupported OS
v1.3.0-Windows,if this is new index
v1.3.0-Windows,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.3.0-Windows,close previous one
v1.3.0-Windows,open new device
v1.3.0-Windows,if open was successful
v1.3.0-Windows,read the device
v1.3.0-Windows,if we didn't had valid read
v1.3.0-Windows,"NOTE if this condition is not met, we're probably out of sync and this"
v1.3.0-Windows,Joystick instance is likely unusable
v1.3.0-Windows,TODO: set below to false?
v1.3.0-Windows,state.is_valid = false;
v1.3.0-Windows,else ignore
v1.3.0-Windows,TODO: implement this for linux
v1.3.0-Windows,TODO: implement this for linux
v1.3.0-Windows,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.3.0-Windows,{
v1.3.0-Windows,"manufacturerID = productID = """";"
v1.3.0-Windows,// Use udev to look up the product and manufacturer IDs
v1.3.0-Windows,struct udev *udev = udev_new();
v1.3.0-Windows,if (udev) {
v1.3.0-Windows,char sysname[32];
v1.3.0-Windows,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.3.0-Windows,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.3.0-Windows,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.3.0-Windows,if (!dev)
v1.3.0-Windows,{
v1.3.0-Windows,"message = ""Unable to find parent USB device"";"
v1.3.0-Windows,return false;
v1.3.0-Windows,}
v1.3.0-Windows,std::stringstream ss;
v1.3.0-Windows,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.3.0-Windows,ss >> manufacturerID;
v1.3.0-Windows,ss.clear();
v1.3.0-Windows,"ss.str("""");"
v1.3.0-Windows,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.3.0-Windows,ss >> productID;
v1.3.0-Windows,udev_device_unref(dev);
v1.3.0-Windows,}
v1.3.0-Windows,else
v1.3.0-Windows,{
v1.3.0-Windows,"message = ""Cannot create udev"";"
v1.3.0-Windows,return false;
v1.3.0-Windows,}
v1.3.0-Windows,udev_unref(udev);
v1.3.0-Windows,return true;
v1.3.0-Windows,}
v1.3.0-Windows,required for pimpl
v1.3.0-Windows,TODO: anyway to workaround const_cast?
v1.3.0-Windows,FGenericPlatformMisc::PlatformInit();
v1.3.0-Windows,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.3.0-Windows,TODO: index check
v1.3.0-Windows,create main widget
v1.3.0-Windows,synchronize PIP views
v1.3.0-Windows,TODO: should we only do below on SceneCapture2D components and cameras?
v1.3.0-Windows,avoid motion blur so capture images don't get
v1.3.0-Windows,use two different methods to set console var because sometime it doesn't seem to work
v1.3.0-Windows,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.3.0-Windows,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.3.0-Windows,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.3.0-Windows,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.3.0-Windows,setup defaults
v1.3.0-Windows,Attempts to parse the settings text from one of multiple locations.
v1.3.0-Windows,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.3.0-Windows,"Next, check the executable's working directory for the settings file."
v1.3.0-Windows,"Finally, check the user's documents folder."
v1.3.0-Windows,"If the settings file cannot be read, throw an exception"
v1.3.0-Windows,Attempts to parse the settings text from the command line
v1.3.0-Windows,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.3.0-Windows,"Example: AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.3.0-Windows,"Returns true if the argument is present, false otherwise."
v1.3.0-Windows,build image file name
v1.3.0-Windows,write image file
v1.3.0-Windows,write to CSV file
v1.3.0-Windows,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.3.0-Windows,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.3.0-Windows,make sire all vars are set up
v1.3.0-Windows,"TODO: should we go as fast as possible, or should we limit this to a particular number of"
v1.3.0-Windows,frames per second?
v1.3.0-Windows,BG: Workaround to get sync ground truth. See https://github.com/Microsoft/AirSim/issues/1494 for details
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,decide which derived BP to use
v1.3.0-Windows,we don't have real vehicle so no vehicle API
v1.3.0-Windows,put camera little bit above vehicle
v1.3.0-Windows,update ground level
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,let base class setup physics world
v1.3.0-Windows,stop physics thread before we dismantle
v1.3.0-Windows,setup clock in ClockFactory
v1.3.0-Windows,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.3.0-Windows,steppable clock returns interval that is a constant number irrespective of wall clock
v1.3.0-Windows,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.3.0-Windows,but that would cause vehicles like quadrotors to become unstable
v1.3.0-Windows,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.3.0-Windows,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.3.0-Windows,get increase in clock speed
v1.3.0-Windows,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.3.0-Windows,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.3.0-Windows,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.3.0-Windows,Approach 2: scale control loop frequency if clock is speeded up
v1.3.0-Windows,"for slowing down, this don't generate instability"
v1.3.0-Windows,-------------------------------- overrides -----------------------------------------------//
v1.3.0-Windows,decide which derived BP to use
v1.3.0-Windows,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.3.0-Windows,vehicle_sim_api->reset();
v1.3.0-Windows,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.3.0-Windows,create vehicle API
v1.3.0-Windows,setup physics vehicle
v1.3.0-Windows,initialize private vars
v1.3.0-Windows,calls to update* are handled by physics engine and in SimModeWorldBase
v1.3.0-Windows,"Utils::log(""------Render tick-------"");"
v1.3.0-Windows,"if reset is pending then do it first, no need to do other things until next tick"
v1.3.0-Windows,move collision info from rendering engine to vehicle
v1.3.0-Windows,update rotor poses
v1.3.0-Windows,if we did reset then don't worry about synchronizing states for this tick
v1.3.0-Windows,Continue to wait for reset
v1.3.0-Windows,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.3.0-Windows,*** Start: UpdatableState implementation ***//
v1.3.0-Windows,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.3.0-Windows,environment update for current position
v1.3.0-Windows,update forces on vertices
v1.3.0-Windows,update to controller must be done after kinematics have been updated by physics engine
v1.3.0-Windows,*** End: UpdatableState implementation ***//
v1.3.0-Windows,get references of existing camera
v1.3.0-Windows,setup clock in PhysX
v1.3.0-Windows,-------------------------------- overrides -----------------------------------------------//
v1.3.0-Windows,decide which derived BP to use
v1.3.0-Windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.3.0-Windows,Setup suspension forces
v1.3.0-Windows,Find the tire object and set the data for it
v1.3.0-Windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.3.0-Windows,Setup suspension forces
v1.3.0-Windows,Find the tire object and set the data for it
v1.3.0-Windows,Create In-Car camera component
v1.3.0-Windows,In car HUD
v1.3.0-Windows,Create text render component for in car speed display
v1.3.0-Windows,Create text render component for in car gear display
v1.3.0-Windows,Setup the audio component and allocate it a sound cue
v1.3.0-Windows,Colors for the in-car gear display. One for normal one for reverse
v1.3.0-Windows,Wheels/Tires
v1.3.0-Windows,Setup the wheels
v1.3.0-Windows,Adjust the tire loading
v1.3.0-Windows,Engine
v1.3.0-Windows,Torque setup
v1.3.0-Windows,Adjust the steering
v1.3.0-Windows,Transmission
v1.3.0-Windows,We want 4wd
v1.3.0-Windows,Drive the front wheels a little more than the rear
v1.3.0-Windows,Automatic gearbox
v1.3.0-Windows,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.3.0-Windows,Physics settings
v1.3.0-Windows,Adjust the center of mass - the buggy is quite low
v1.3.0-Windows,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.3.0-Windows,put camera little bit above vehicle
v1.3.0-Windows,update physics material
v1.3.0-Windows,Update the strings used in the HUD (in-car and on-screen)
v1.3.0-Windows,Set the string in the in-car HUD
v1.3.0-Windows,Pass the engine RPM to the sound component
v1.3.0-Windows,Start an engine sound playing
v1.3.0-Windows,Using FText because this is display text that should be localizable
v1.3.0-Windows,Setup the text render component strings
v1.3.0-Windows,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.3.0-Windows,below is not needed
v1.3.0-Windows,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.3.0-Windows,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.3.0-Windows,TODO: should do reset() here?
v1.3.0-Windows,create vehicle params
v1.3.0-Windows,these are called on render ticks
v1.3.0-Windows,TODO: do we need this for cars?
v1.3.0-Windows,TODO: move this to SimModeBase?
v1.3.0-Windows,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.3.0-Windows,reset();
v1.3.0-Windows,return;
v1.3.0-Windows,}
v1.3.0-Windows,Thrustmaster devices
v1.3.0-Windows,"Anything else, typically Logitech G920 wheel"
v1.3.0-Windows,Two steel levers behind wheel
v1.3.0-Windows,if API-client control is not active then we route keyboard/joystick control to car
v1.3.0-Windows,all car controls from anywhere must be routed through API component
v1.3.0-Windows,*** Start: UpdatableState implementation ***//
v1.3.0-Windows,physics tick
v1.3.0-Windows,*** End: UpdatableState implementation ***//
v1.3.0-Windows,TODO: directly accept getVehicleSimApis() using generic container
v1.3.0-Windows,remove everything that we created in BeginPlay
v1.3.0-Windows,we use custom debug reporting for this class
v1.3.0-Windows,perform any expensive rendering update outside of lock region
v1.3.0-Windows,no need to call base reset because of our custom implementation
v1.3.0-Windows,TODO: this is going to cause circular references which is fine here but
v1.3.0-Windows,in future we should consider moving SimMode not derived from AActor and move
v1.3.0-Windows,it to AirLib and directly implement WorldSimApiBase interface
v1.3.0-Windows,get player start
v1.3.0-Windows,this must be done from within actor otherwise we don't get player start
v1.3.0-Windows,UWeatherLib::showWeatherMenu(World);
v1.3.0-Windows,else don't init
v1.3.0-Windows,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v1.3.0-Windows,tod_sim_clock_start_ needs to be reset here.
v1.3.0-Windows,Going from enabled to disabled
v1.3.0-Windows,do these in the end to ensure that advanceTimeOfDay() doesn't see
v1.3.0-Windows,any inconsistent state.
v1.3.0-Windows,should be overridden by derived class
v1.3.0-Windows,should be overridden by derived class
v1.3.0-Windows,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.3.0-Windows,default setup - this should be overridden in derived modes as needed
v1.3.0-Windows,setup clock in ClockFactory
v1.3.0-Windows,default implementation
v1.3.0-Windows,create director
v1.3.0-Windows,create external camera required for the director
v1.3.0-Windows,API server start/stop
v1.3.0-Windows,get UU origin of global NED frame
v1.3.0-Windows,determine camera director camera default pose and spawn it
v1.3.0-Windows,find all vehicle pawns
v1.3.0-Windows,add vehicles from settings
v1.3.0-Windows,if vehicle is of type for derived SimMode and auto creatable
v1.3.0-Windows,compute initial pose
v1.3.0-Windows,spawn vehicle pawn
v1.3.0-Windows,create API objects for each pawn we have
v1.3.0-Windows,create vehicle sim api
v1.3.0-Windows,TODO: better handle no FPV vehicles scenario
v1.3.0-Windows,derived class should override this method to retrieve types of pawns they support
v1.3.0-Windows,derived class should override this method to retrieve types of pawns they support
v1.3.0-Windows,derived class should override this method to retrieve types of pawns they support
v1.3.0-Windows,derived class should override this method to retrieve types of pawns they support
v1.3.0-Windows,derived class should override this method to retrieve types of pawns they support
v1.3.0-Windows,derived class should override this method to retrieve types of pawns they support
v1.3.0-Windows,derived class should override this method to retrieve types of pawns they support
v1.3.0-Windows,Draws debug-points on main viewport for Lidar laser hits.
v1.3.0-Windows,Used for debugging only.
v1.3.0-Windows,Currently we are checking the sensor-collection instead of sensor-settings.
v1.3.0-Windows,Also using variables to optimize not checking the collection if not needed.
v1.3.0-Windows,TODO: Is it incorrect to assume LidarSimple here?
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,ctor
v1.3.0-Windows,initializes information based on lidar configuration
v1.3.0-Windows,calculate verticle angle distance between each laser
v1.3.0-Windows,store vertical angles for each laser
v1.3.0-Windows,returns a point-cloud for the tick
v1.3.0-Windows,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.3.0-Windows,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.3.0-Windows,calculate number of points needed for each laser/channel
v1.3.0-Windows,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.3.0-Windows,calculate needed angle/distance between each point
v1.3.0-Windows,normalize FOV start/end
v1.3.0-Windows,shoot lasers
v1.3.0-Windows,check if the laser is outside the requested horizontal FOV
v1.3.0-Windows,"shoot laser and get the impact point, if any"
v1.3.0-Windows,simulate shooting a laser via Unreal ray-tracing.
v1.3.0-Windows,start position
v1.3.0-Windows,We need to compose rotations here rather than rotate a vector by a quaternion
v1.3.0-Windows,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.3.0-Windows,get ray quaternion in lidar frame (angles must be in radians)
v1.3.0-Windows,get ray quaternion in body frame
v1.3.0-Windows,get ray quaternion in world frame
v1.3.0-Windows,get ray vector (end position)
v1.3.0-Windows,Store the segmentation id of the hit object.
v1.3.0-Windows,Debug code for very specific cases.
v1.3.0-Windows,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.3.0-Windows,decide the frame for the point-cloud
v1.3.0-Windows,current detault behavior; though it is probably not very useful.
v1.3.0-Windows,not changing the default for now to maintain backwards-compat.
v1.3.0-Windows,point in vehicle intertial frame
v1.3.0-Windows,tranform to lidar frame
v1.3.0-Windows,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.3.0-Windows,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.3.0-Windows,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.3.0-Windows,"On the client side, if it is needed to transform this data back to the world frame,"
v1.3.0-Windows,"then do the equivalent of following,"
v1.3.0-Windows,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.3.0-Windows,See SimModeBase::drawLidarDebugPoints()
v1.3.0-Windows,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.3.0-Windows,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,update ray tracing
v1.3.0-Windows,"FString hit_name = FString(""None"");"
v1.3.0-Windows,if (dist_hit.GetActor())
v1.3.0-Windows,hit_name=dist_hit.GetActor()->GetName();
v1.3.0-Windows,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.3.0-Windows,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,This assumes you are running DroneServer already on the same machine.
v1.3.0-Windows,DroneServer must be running first.
v1.3.0-Windows,enable API control
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,move commands
v1.3.0-Windows,else leave as it is
v1.3.0-Windows,TODO: get these in one call
v1.3.0-Windows,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.3.0-Windows,TODO: shouldn't we pass folder path?
v1.3.0-Windows,parse
v1.3.0-Windows,group the images by the current date.
v1.3.0-Windows,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.3.0-Windows,{
v1.3.0-Windows,"return """";"
v1.3.0-Windows,}
v1.3.0-Windows,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.3.0-Windows,{
v1.3.0-Windows,return false;
v1.3.0-Windows,}
v1.3.0-Windows,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.3.0-Windows,params.context->client.newTask();
v1.3.0-Windows,}
v1.3.0-Windows,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.3.0-Windows,params.context->client.WaitForCompletion(0);
v1.3.0-Windows,}
v1.3.0-Windows,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.3.0-Windows,{
v1.3.0-Windows,}
v1.3.0-Windows,parse command line
v1.3.0-Windows,Shell callbacks
v1.3.0-Windows,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.3.0-Windows,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.3.0-Windows,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.3.0-Windows,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.3.0-Windows,Add shell commands
v1.3.0-Windows,TODO: add WaitForCompletion command
v1.3.0-Windows,"TODO: add command line args help, arg count validation"
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v1.3.0-Windows,switch to explicit hover mode so that this is the fall back when
v1.3.0-Windows,move* commands are finished.
v1.3.0-Windows,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.3.0-Windows,TODO: implement weather for Unity
v1.3.0-Windows,TODO: implement weather for Unity
v1.3.0-Windows,Function pointers to hold the addresses of the functions that are defined in Unity
v1.3.0-Windows,"Enabling all LogLevels,"
v1.3.0-Windows,"Enabling all LogLevels,"
v1.3.0-Windows,delete ltm;
v1.3.0-Windows,initialize state
v1.3.0-Windows,compute our home point
v1.3.0-Windows,default behavior is to call update every tick
v1.3.0-Windows,"for custom physics engine, this method should be overridden and update should be"
v1.3.0-Windows,called from every physics tick
v1.3.0-Windows,these will be available for devices like steering wheels
v1.3.0-Windows,sync environment from kinematics
v1.3.0-Windows,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.3.0-Windows,FVector unrealPosition = getUUPosition();
v1.3.0-Windows,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v1.3.0-Windows,parameters in NED frame
v1.3.0-Windows,allow teleportation
v1.3.0-Windows,if collisions are not enabled
v1.3.0-Windows,or we have collided but passthrough is enabled
v1.3.0-Windows,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.3.0-Windows,"without flip flopping, collisions can't be detected"
v1.3.0-Windows,by default we update kinematics from UE pawn
v1.3.0-Windows,if SimMod uses its own physics engine then this should be overriden
v1.3.0-Windows,no default action in this base class
v1.3.0-Windows,TODO: because this bug we are using alternative code with stringstream
v1.3.0-Windows,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.3.0-Windows,update kinematics from pawn's movement instead of physics engine
v1.3.0-Windows,TODO: update other fields?
v1.3.0-Windows,implements getImages() method in the ImageCaptureBase class.
v1.3.0-Windows,update ray tracing
v1.3.0-Windows,TODO: index check
v1.3.0-Windows,Attempts to parse the settings text from one of multiple locations.
v1.3.0-Windows,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.3.0-Windows,"Next, check the executable's working directory for the settings file."
v1.3.0-Windows,"Finally, check the user's documents folder."
v1.3.0-Windows,"If the settings file cannot be read, throw an exception"
v1.3.0-Windows,let base class setup physics world
v1.3.0-Windows,stop physics thread before we dismantle
v1.3.0-Windows,setup clock in ClockFactory
v1.3.0-Windows,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.3.0-Windows,steppable clock returns interval that is a constant number irrespective of wall clock
v1.3.0-Windows,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.3.0-Windows,but that would cause vehicles like quadrotors to become unstable
v1.3.0-Windows,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.3.0-Windows,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.3.0-Windows,get increase in clock speed
v1.3.0-Windows,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.3.0-Windows,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.3.0-Windows,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.3.0-Windows,Approach 2: scale control loop frequency if clock is speeded up
v1.3.0-Windows,"for slowing down, this don't generate instability"
v1.3.0-Windows,-------------------------------- overrides -----------------------------------------------//
v1.3.0-Windows,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v1.3.0-Windows,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.3.0-Windows,create vehicle API
v1.3.0-Windows,setup physics vehicle
v1.3.0-Windows,initialize private vars
v1.3.0-Windows,"if reset is pending then do it first, no need to do other things until next tick"
v1.3.0-Windows,move collision info from rendering engine to vehicle
v1.3.0-Windows,update rotor poses
v1.3.0-Windows,if we did reset then don't worry about synchronizing states for this tick
v1.3.0-Windows,Continue to wait for reset
v1.3.0-Windows,*** Start: UpdatableState implementation ***//
v1.3.0-Windows,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.3.0-Windows,environment update for current position
v1.3.0-Windows,update forces on vertices
v1.3.0-Windows,update to controller must be done after kinematics have been updated by physics engine
v1.3.0-Windows,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.3.0-Windows,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.3.0-Windows,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.3.0-Windows,*** End: UpdatableState implementation ***//
v1.3.0-Windows,TODO: should do reset() here?
v1.3.0-Windows,these are called on render ticks
v1.3.0-Windows,TODO: do we need this for cars?
v1.3.0-Windows,Thrustmaster devices
v1.3.0-Windows,"Anything else, typically Logitech G920 wheel"
v1.3.0-Windows,Two steel levers behind wheel
v1.3.0-Windows,if API-client control is not active then we route keyboard/joystick control to car
v1.3.0-Windows,all car controls from anywhere must be routed through API component
v1.3.0-Windows,*** Start: UpdatableState implementation ***//
v1.3.0-Windows,physics tick
v1.3.0-Windows,void CarPawnSimApi::reportState(StateReporter& reporter)
v1.3.0-Windows,{
v1.3.0-Windows,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.3.0-Windows,AirSimPose pose = GetPose(getVehicleName().c_str());
v1.3.0-Windows,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v1.3.0-Windows,}
v1.3.0-Windows,*** End: UpdatableState implementation ***//
v1.3.0-Windows,remove everything that we created in BeginPlay
v1.3.0-Windows,we use custom debug reporting for this class
v1.3.0-Windows,perform any expensive rendering update outside of lock region
v1.3.0-Windows,no need to call base reset because of our custom implementation
v1.3.0-Windows,should be overridden by derived class
v1.3.0-Windows,should be overridden by derived class
v1.3.0-Windows,commenting this out for now to avoid unintentional Unity startup failure
v1.3.0-Windows,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v1.3.0-Windows,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.3.0-Windows,default setup - this should be overridden in derived modes as needed
v1.3.0-Windows,setup clock in ClockFactory
v1.3.0-Windows,API server start/stop
v1.3.0-Windows,determine camera director camera default pose and spawn it
v1.3.0-Windows,derived class should override this method to retrieve types of pawns they support
v1.3.0-Windows,derived class should override this method to retrieve types of pawns they support
v1.3.0-Windows,60 acres park:
v1.3.0-Windows,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.3.0-Windows,marymoore park
v1.3.0-Windows,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.3.0-Windows,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.3.0-Windows,DepthNavThreshold depthNav;
v1.3.0-Windows,DepthNavOptAStar depthNav;
v1.3.0-Windows,DepthNavThreshold depthNav;
v1.3.0-Windows,DepthNavOptAStar depthNav;
v1.3.0-Windows,Cleanup
v1.3.0-Windows,runDepthNavGT();
v1.3.0-Windows,runDepthNavSGM();
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,by Sudipta Sinha
v1.3.0-Windows,adapted for AirSim by Matthias Mueller
v1.3.0-Windows,first row
v1.3.0-Windows,last row
v1.3.0-Windows,Local quadratic fit of cost and subpixel refinement.
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,by Sudipta Sinha
v1.3.0-Windows,adapted for AirSim by Matthias Mueller
v1.3.0-Windows,uint64_t x64 = (uint64_t)x;
v1.3.0-Windows,uint64_t y64 = (uint64_t)y;
v1.3.0-Windows,Copyright (c) Microsoft Corporation. All rights reserved.
v1.3.0-Windows,Licensed under the MIT License.
v1.3.0-Windows,by Sudipta Sinha
v1.3.0-Windows,adapted for AirSim by Matthias Mueller
v1.3.0-Windows,ensure that disparity range is a multiple of 8
v1.3.0-Windows,sgm stereo
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,read settings and override defaults
v.1.2.2,allow json overrides on a per-vehicle basis.
v.1.2.2,start server in async mode
v.1.2.2,check messages
v.1.2.2,In settings.json first activate computer vision mode:
v.1.2.2,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v.1.2.2,monitor car state while you drive it manually.
v.1.2.2,(2.99792458 * 10^14 [micron/s])^2 * 10^12 to convert
v.1.2.2,denominator from microns^3 to microns * m^2)
v.1.2.2,First set everything to 0.
v.1.2.2,Next set all objects of interest provided to corresponding object IDs
v.1.2.2,segIdDict values MUST match tempEmissivityNew labels.
v.1.2.2,"Connect to AirSim, UAV mode."
v.1.2.2,Choose temperature values for winter or summer.
v.1.2.2,""""""""
v.1.2.2,winter
v.1.2.2,""""""""
v.1.2.2,summer
v.1.2.2,Read camera response.
v.1.2.2,Calculate radiance.
v.1.2.2,Set IDs in AirSim environment.
v.1.2.2,In settings.json first activate computer vision mode:
v.1.2.2,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v.1.2.2,"define abstract class to return next vector in the format (x,y,yaw)"
v.1.2.2,"compute vector, distance and angle to goal"
v.1.2.2,compute box of interest
v.1.2.2,scale by weight matrix (optional)
v.1.2.2,"img2d_box = np.multiply(img2d_box,w_mtx)"
v.1.2.2,detect collision
v.1.2.2,compute box of interest
v.1.2.2,detect collision
v.1.2.2,Same as above but decide to go left or right based on average or some metric like that
v.1.2.2,"compute resultant normalized vector, distance and angle"
v.1.2.2,compute bounding box size
v.1.2.2,convert horizonal fov to vertical fov
v.1.2.2,matrix with all ones
v.1.2.2,matrix with max weight in center and decreasing linearly with distance from center
v.1.2.2,matrix with max weight in center and decreasing quadratically with distance from center
v.1.2.2,"print (""Saving images to %s"" % tmp_dir)"
v.1.2.2,airsim.wait_key('Press any key to start')
v.1.2.2,"Define start position, goal and size of UAV"
v.1.2.2,Define parameters and thresholds
v.1.2.2,initial position
v.1.2.2,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v.1.2.2,time.sleep(1)
v.1.2.2,get response
v.1.2.2,get numpy array
v.1.2.2,reshape array to 2D array H X W
v.1.2.2,write to png
v.1.2.2,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v.1.2.2,pose = client.simGetPose()
v.1.2.2,pp.pprint(pose)
v.1.2.2,time.sleep(5)
v.1.2.2,currently reset() doesn't work in CV mode. Below is the workaround
v.1.2.2,################### OLD CODE
v.1.2.2,timer = 0
v.1.2.2,time_obs = 50
v.1.2.2,bObstacle = False
v.1.2.2,if (bObstacle):
v.1.2.2,timer = timer + 1
v.1.2.2,if timer > time_obs:
v.1.2.2,bObstacle = False
v.1.2.2,timer = 0
v.1.2.2,else:
v.1.2.2,yaw = target_angle
v.1.2.2,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v.1.2.2,if (np.average(img2d_box) < coll_thres):
v.1.2.2,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v.1.2.2,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v.1.2.2,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v.1.2.2,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v.1.2.2,"print('left: ', img2d_box_l_avg)"
v.1.2.2,"print('right: ', img2d_box_r_avg)"
v.1.2.2,if img2d_box_l_avg > img2d_box_r_avg:
v.1.2.2,##Go LEFT
v.1.2.2,#y_offset = y_offset-1
v.1.2.2,yaw = yaw - radians(10)
v.1.2.2,bObstacle = True
v.1.2.2,else:
v.1.2.2,##Go RIGHT
v.1.2.2,#y_offset = y_offset+1
v.1.2.2,yaw = yaw + radians(10)
v.1.2.2,bObstacle = true
v.1.2.2,"print('yaw: ', yaw)"
v.1.2.2,In settings.json first activate computer vision mode:
v.1.2.2,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v.1.2.2,currently reset() doesn't work in CV mode. Below is the workaround
v.1.2.2,In settings.json first activate computer vision mode:
v.1.2.2,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v.1.2.2,requires Python 3.5.3 :: Anaconda 4.4.0
v.1.2.2,pip install opencv-python
v.1.2.2,In settings.json first activate computer vision mode:
v.1.2.2,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v.1.2.2,for block environment
v.1.2.2,regex are case insensitive
v.1.2.2,#for neighborhood environment
v.1.2.2,set object ID for sky
v.1.2.2,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v.1.2.2,get segmentation image in various formats
v.1.2.2,save segmentation images in various formats
v.1.2.2,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v.1.2.2,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v.1.2.2,"cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png"
v.1.2.2,find unique colors
v.1.2.2,In settings.json first activate computer vision mode:
v.1.2.2,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v.1.2.2,objects can be named in two ways:
v.1.2.2,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v.1.2.2,default name is auto-generated and varies from run-to-run.
v.1.2.2,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v.1.2.2,
v.1.2.2,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v.1.2.2,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v.1.2.2,https://answers.unrealengine.com/revisions/790629.html
v.1.2.2,below works in Blocks environment
v.1.2.2,------------------------------------ Get current pose ------------------------------------------------
v.1.2.2,search object by name:
v.1.2.2,search another object by tag
v.1.2.2,search non-existent object
v.1.2.2,------------------------------------ Set new pose ------------------------------------------------
v.1.2.2,here we move with teleport enabled so collisions are ignored
v.1.2.2,here we move with teleport enabled so collisions are not ignored
v.1.2.2,move non-existent object
v.1.2.2,------------------------------------ Get new pose ------------------------------------------------
v.1.2.2,search another object by tag
v.1.2.2,search non-existent object
v.1.2.2,Import this module to automatically setup path to local airsim module
v.1.2.2,This module first tries to see if airsim module is installed via pip
v.1.2.2,If it does then we don't do anything else
v.1.2.2,Else we look up grand-parent folder to see if it has airsim folder
v.1.2.2,and if it does then we add that in sys.path
v.1.2.2,this class simply tries to see if airsim
v.1.2.2,if airsim module is installed then don't do anything else
v.1.2.2,import pkgutil
v.1.2.2,airsim_loader = pkgutil.find_loader('airsim')
v.1.2.2,if airsim_loader is not None:
v.1.2.2,return
v.1.2.2,This script expects object available in UE environment of type AAirSimCharater
v.1.2.2,In settings.json first activate computer vision mode:
v.1.2.2,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v.1.2.2,airsim.wait_key('Press any key to set face expression')
v.1.2.2,"client.simCharSetFaceExpression(""BlendShapeNode_Smile"", 1);"
v.1.2.2,"Roll is applied first, then pitch, then yaw."
v.1.2.2,Turn the camera position into a column vector.
v.1.2.2,"Convert the camera's quaternion rotation to yaw, pitch, roll angles."
v.1.2.2,"Create a rotation matrix from camera pitch, roll, and yaw angles."
v.1.2.2,Change coordinates to get subjectXYZ in the camera's local coordinate system.
v.1.2.2,Recreate the perspective projection of the camera.
v.1.2.2,"Move origin to the upper-left corner of the screen and multiply by size to get pixel values. Note that screen is in y,-z plane."
v.1.2.2,Set pose and sleep after to ensure the pose sticks before capturing image.
v.1.2.2,Capture segmentation (IR) and scene images.
v.1.2.2,Change images into numpy arrays.
v.1.2.2,Capture images for a certain amount of time in seconds (half hour now)
v.1.2.2,Capture image - pose.position x_val access may change w/ AirSim
v.1.2.2,"version (pose.position.x_val new, pose.position[b'x_val'] old)"
v.1.2.2,Convert color scene image to BGR for write out with cv2.
v.1.2.2,"Connect to AirSim, UAV mode."
v.1.2.2,Look for objects with names that match a regular expression.
v.1.2.2,"Sample calls to main, varying camera angle and altitude."
v.1.2.2,"straight down, 400ft"
v.1.2.2,"straight down, 200ft"
v.1.2.2,"45 degrees, 200ft -- note that often object won't be scene since position"
v.1.2.2,is set exactly to object's
v.1.2.2,"45 degrees, 400ft -- note that often object won't be scene since position"
v.1.2.2,is set exactly to object's
v.1.2.2,In settings.json first activate computer vision mode:
v.1.2.2,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v.1.2.2,xn = 1 + x*5  # some random number
v.1.2.2,currently reset() doesn't work in CV mode. Below is the workaround
v.1.2.2,connect to the AirSim simulator
v.1.2.2,monitor car state while you drive it manually.
v.1.2.2,get state of the car
v.1.2.2,connect to the AirSim simulator
v.1.2.2,connect to the AirSim simulator
v.1.2.2,go forward
v.1.2.2,get state of the car
v.1.2.2,Python client example to change time-of-day using APIs
v.1.2.2,
v.1.2.2,Changes time of the day and makes the car move around
v.1.2.2,connect to the AirSim simulator
v.1.2.2,flip between specific time and default time
v.1.2.2,go forward
v.1.2.2,Go forward + steer right
v.1.2.2,main
v.1.2.2,import gym #pip install gym
v.1.2.2,Local variable access is faster in loops
v.1.2.2,"if not wrapping over current pointer,"
v.1.2.2,then check if there is terminal state wrapped inside
v.1.2.2,"If index > history_length, take from a slice"
v.1.2.2,Metrics accumulator
v.1.2.2,Action Value model (used by agent to interact with the environment)
v.1.2.2,"Target model used to compute the target Q-values in training, updated"
v.1.2.2,less frequently for increased stability.
v.1.2.2,Function computing Q-values targets as part of the computation graph
v.1.2.2,"Define the loss, using Huber Loss (more robust to outliers)"
v.1.2.2,Compute the q_targets
v.1.2.2,actions is a 1-hot encoding of the action done by the agent
v.1.2.2,Define training criterion as the Huber Loss function
v.1.2.2,Adam based SGD
v.1.2.2,self._trainer.restore_from_checkpoint('models/oldmodels/model800000')
v.1.2.2,Append the state to the short term memory (ie. History)
v.1.2.2,"If policy requires agent to explore, sample random action"
v.1.2.2,Use the network to output the best action
v.1.2.2,Append batch axis with only one sample to evaluate
v.1.2.2,Return the value maximizing the expected reward
v.1.2.2,Keep track of interval action counter
v.1.2.2,"If done, reset short term memory (ie. History)"
v.1.2.2,Plot the metrics through Tensorboard and reset buffers
v.1.2.2,Reset the short term memory
v.1.2.2,Append to long term memory
v.1.2.2,Update the Target Network if needed
v.1.2.2,print(dist)
v.1.2.2,Make RL agent
v.1.2.2,Train
v.1.2.2,connect to the AirSim simulator
v.1.2.2,get state of the car
v.1.2.2,go forward
v.1.2.2,Go forward + steer right
v.1.2.2,go reverse
v.1.2.2,apply brakes
v.1.2.2,get camera images from the car
v.1.2.2,restore to original state
v.1.2.2,connect to the AirSim simulator
v.1.2.2,go forward
v.1.2.2,Python client example to get Lidar data from a car
v.1.2.2,
v.1.2.2,Makes the drone fly and get Lidar data
v.1.2.2,connect to the AirSim simulator
v.1.2.2,"print(""state: %s"" % s)"
v.1.2.2,go forward
v.1.2.2,Go forward + steer right
v.1.2.2,"reshape array of floats to array of [X,Y,Z]"
v.1.2.2,TODO
v.1.2.2,main
v.1.2.2,connect to the AirSim simulator
v.1.2.2,get state of the car
v.1.2.2,go forward
v.1.2.2,Go forward + steer right
v.1.2.2,go reverse
v.1.2.2,apply breaks
v.1.2.2,restore to original state
v.1.2.2,connect to the AirSim simulator
v.1.2.2,get camera images from the car
v.1.2.2,that's enough fun for now. let's quit cleanly
v.1.2.2,Import this module to automatically setup path to local airsim module
v.1.2.2,This module first tries to see if airsim module is installed via pip
v.1.2.2,If it does then we don't do anything else
v.1.2.2,Else we look up grand-parent folder to see if it has airsim folder
v.1.2.2,and if it does then we add that in sys.path
v.1.2.2,this class simply tries to see if airsim
v.1.2.2,if airsim module is installed then don't do anything else
v.1.2.2,import pkgutil
v.1.2.2,airsim_loader = pkgutil.find_loader('airsim')
v.1.2.2,if airsim_loader is not None:
v.1.2.2,return
v.1.2.2,Use below in settings.json with blocks environment
v.1.2.2,connect to the AirSim simulator
v.1.2.2,get state of the car
v.1.2.2,go forward
v.1.2.2,go reverse
v.1.2.2,apply breaks
v.1.2.2,get camera images from the car
v.1.2.2,restore to original state
v.1.2.2,from keras.models import load_model
v.1.2.2,if (len(sys.argv) != 2):
v.1.2.2,print('usage: python drive.py <modelName>')
v.1.2.2,sys.exit()
v.1.2.2,print('Loading model...')
v.1.2.2,model = load_model(sys.argv[1])
v.1.2.2,connect to the AirSim simulator
v.1.2.2,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v.1.2.2,"model_output = model.predict([image_buf, state_buf])"
v.1.2.2,car_controls.steering = float(model_output[0][0])
v.1.2.2,!/usr/bin/env python
v.1.2.2,connect to the AirSim simulator
v.1.2.2,start = time.time()
v.1.2.2,get state of the car
v.1.2.2,milliseconds = (time.time() - start) * 1000
v.1.2.2,populate PoseStamped ros message
v.1.2.2,log PoseStamped message
v.1.2.2,publish PoseStamped message
v.1.2.2,sleeps until next cycle
v.1.2.2,!/usr/bin/env python
v.1.2.2,Example ROS node for publishing AirSim images.
v.1.2.2,AirSim Python API
v.1.2.2,ROS Image message
v.1.2.2,connect to the AirSim simulator
v.1.2.2,get camera images from the car
v.1.2.2,Populate image message
v.1.2.2,log time and size of published image
v.1.2.2,publish image message
v.1.2.2,sleep until next cycle
v.1.2.2,!/usr/bin/env python
v.1.2.2,Example ROS node for publishing AirSim images.
v.1.2.2,ROS Image message
v.1.2.2,connect to the AirSim simulator
v.1.2.2,get camera images from the car
v.1.2.2,Populate image message
v.1.2.2,log time and size of published image
v.1.2.2,publish image message
v.1.2.2,sleep until next cycle
v.1.2.2,Import this module to automatically setup path to local airsim module
v.1.2.2,This module first tries to see if airsim module is installed via pip
v.1.2.2,If it does then we don't do anything else
v.1.2.2,Else we look up grand-parent folder to see if it has airsim folder
v.1.2.2,and if it does then we add that in sys.path
v.1.2.2,this class simply tries to see if airsim
v.1.2.2,if airsim module is installed then don't do anything else
v.1.2.2,import pkgutil
v.1.2.2,airsim_loader = pkgutil.find_loader('airsim')
v.1.2.2,if airsim_loader is not None:
v.1.2.2,return
v.1.2.2,connect to the AirSim simulator
v.1.2.2,connect to the AirSim simulator
v.1.2.2,MultirotorClient.wait_key('Press any key to takeoff')
v.1.2.2,Local variable access is faster in loops
v.1.2.2,"if not wrapping over current pointer,"
v.1.2.2,then check if there is terminal state wrapped inside
v.1.2.2,"If index > history_length, take from a slice"
v.1.2.2,Metrics accumulator
v.1.2.2,Action Value model (used by agent to interact with the environment)
v.1.2.2,"Target model used to compute the target Q-values in training, updated"
v.1.2.2,less frequently for increased stability.
v.1.2.2,Function computing Q-values targets as part of the computation graph
v.1.2.2,"Define the loss, using Huber Loss (more robust to outliers)"
v.1.2.2,Compute the q_targets
v.1.2.2,actions is a 1-hot encoding of the action done by the agent
v.1.2.2,Define training criterion as the Huber Loss function
v.1.2.2,Adam based SGD
v.1.2.2,Append the state to the short term memory (ie. History)
v.1.2.2,"If policy requires agent to explore, sample random action"
v.1.2.2,Use the network to output the best action
v.1.2.2,Append batch axis with only one sample to evaluate
v.1.2.2,Return the value maximizing the expected reward
v.1.2.2,Keep track of interval action counter
v.1.2.2,"If done, reset short term memory (ie. History)"
v.1.2.2,Plot the metrics through Tensorboard and reset buffers
v.1.2.2,Reset the short term memory
v.1.2.2,Append to long term memory
v.1.2.2,Update the Target Network if needed
v.1.2.2,print(dist)
v.1.2.2,connect to the AirSim simulator
v.1.2.2,Make RL agent
v.1.2.2,Train
v.1.2.2,connect to the AirSim simulator
v.1.2.2,get camera images from the car
v.1.2.2,that's enough fun for now. let's quit cleanly
v.1.2.2,teleport the drone + 10 meters in x-direction
v.1.2.2,teleport the drone back
v.1.2.2,use open cv to create point cloud from depth image.
v.1.2.2,###########################################
v.1.2.2,######### This is work in progress! #######
v.1.2.2,###########################################
v.1.2.2,file will be saved in PythonClient folder (i.e. same folder as script)
v.1.2.2,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v.1.2.2,skip it
v.1.2.2,AirSim uses NED coordinates so negative axis is up.
v.1.2.2,z of -7 is 7 meters above the original launch point.
v.1.2.2,Fly given velocity vector for 5 seconds
v.1.2.2,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v.1.2.2,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v.1.2.2,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v.1.2.2,Make the drone fly in a circle.
v.1.2.2,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v.1.2.2,check that our home position is stable
v.1.2.2,AirSim uses NED coordinates so negative axis is up.
v.1.2.2,ramp up time
v.1.2.2,ramp up to full speed in smooth increments so we don't start too aggressively.
v.1.2.2,compute current angle
v.1.2.2,compute lookahead
v.1.2.2,if we did the takeoff then also do the landing.
v.1.2.2,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v.1.2.2,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v.1.2.2,now we just have to watch for a smooth crossing from negative diff to positive diff
v.1.2.2,ignore the click over from 360 back to 0
v.1.2.2,watch direction this diff is moving if it switches from shrinking to growing
v.1.2.2,then we passed the starting point.
v.1.2.2,first hold our current position so drone doesn't try and keep flying while we take the picture.
v.1.2.2,AirSim uses NED coordinates so negative axis is up.
v.1.2.2,z of -7 is 7 meters above the original launch point.
v.1.2.2,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v.1.2.2,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v.1.2.2,change clock speed in settings.json
v.1.2.2,"""ClockSpeed"": 0.5"
v.1.2.2,connect to the AirSim simulator
v.1.2.2,that's enough fun for now. let's quit cleanly
v.1.2.2,In settings.json first activate computer vision mode:
v.1.2.2,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v.1.2.2,requires Python 3.5.3 :: Anaconda 4.4.0
v.1.2.2,pip install opencv-python
v.1.2.2,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v.1.2.2,Python client example to get Lidar data from a drone
v.1.2.2,
v.1.2.2,Makes the drone fly and get Lidar data
v.1.2.2,connect to the AirSim simulator
v.1.2.2,"print(""state: %s"" % s)"
v.1.2.2,"print(""state: %s"" % pprint.pformat(state))"
v.1.2.2,"reshape array of floats to array of [X,Y,Z]"
v.1.2.2,TODO
v.1.2.2,main
v.1.2.2,connect to the AirSim simulator
v.1.2.2,AirSim uses NED coordinates so negative axis is up.
v.1.2.2,let it settle there a bit.
v.1.2.2,after hovering we need to re-enabled api control for next leg of the trip
v.1.2.2,now compute the survey path required to fill the box
v.1.2.2,Use below in settings.json with Blocks environment
v.1.2.2,connect to the AirSim simulator
v.1.2.2,get camera images from the car
v.1.2.2,that's enough fun for now. let's quit cleanly
v.1.2.2,connect to the AirSim simulator
v.1.2.2,Import this module to automatically setup path to local airsim module
v.1.2.2,This module first tries to see if airsim module is installed via pip
v.1.2.2,If it does then we don't do anything else
v.1.2.2,Else we look up grand-parent folder to see if it has airsim folder
v.1.2.2,and if it does then we add that in sys.path
v.1.2.2,this class simply tries to see if airsim
v.1.2.2,if airsim module is installed then don't do anything else
v.1.2.2,import pkgutil
v.1.2.2,airsim_loader = pkgutil.find_loader('airsim')
v.1.2.2,if airsim_loader is not None:
v.1.2.2,return
v.1.2.2,"this script moves the drone to a location, then rests it thousands of time"
v.1.2.2,purpose of this script is to stress test reset API
v.1.2.2,connect to the AirSim simulator
v.1.2.2,that's enough fun for now. let's quite cleanly
v.1.2.2,use open cv to show new images from AirSim
v.1.2.2,requires Python 3.5.3 :: Anaconda 4.4.0
v.1.2.2,pip install opencv-python
v.1.2.2,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v.1.2.2,get depth image
v.1.2.2,"this will return png width= 256, height= 144"
v.1.2.2,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v.1.2.2,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v.1.2.2,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v.1.2.2,to get an estimate of distance.
v.1.2.2,sanity check on what is directly in front of us (slot 2 in our hsplit)
v.1.2.2,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v.1.2.2,an angular delta of the following pi/10.
v.1.2.2,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v.1.2.2,Remove alpha channel if exists
v.1.2.2,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v.1.2.2,"Data is expected to be a dict of <image: (label, previousious_state)>"
v.1.2.2,Flatten and yield as tuple
v.1.2.2,Initialize a resizable dataset to hold the output
v.1.2.2,Resize the dataset to accommodate the next chunk of rows
v.1.2.2,Create the next chunk
v.1.2.2,Increment the row count
v.1.2.2,Arguments
v.1.2.2,Returns
v.1.2.2,use composition of homographies
v.1.2.2,to generate final transform that needs to be applied
v.1.2.2,Arguments
v.1.2.2,Returns
v.1.2.2,Keeps under lock only the mechanism which advances
v.1.2.2,the indexing of each batch.
v.1.2.2,The transformation of images is not under thread lock
v.1.2.2,so it can be done in parallel
v.1.2.2,Trained model path
v.1.2.2,Connect to AirSim
v.1.2.2,Start driving
v.1.2.2,Initialize image buffer
v.1.2.2,Update throttle value according to steering angle
v.1.2.2,Prediction
v.1.2.2,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v.1.2.2,Print progress
v.1.2.2,Update next car state
v.1.2.2,Wait a bit between iterations
v.1.2.2,%matplotlib inline
v.1.2.2,chunk size for training batches
v.1.2.2,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v.1.2.2,Point this to the directory containing the raw data
v.1.2.2,Point this to the desired output directory for the cooked (.h5) data
v.1.2.2,Choose The folders to search for data under RAW_DATA_DIR
v.1.2.2,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v.1.2.2,data_folder.append('folder_name1')
v.1.2.2,data_folder.append('folder_name2')
v.1.2.2,...
v.1.2.2,Hyper-parameters
v.1.2.2,Activation functions
v.1.2.2,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v.1.2.2,<< The directory containing the cooked data from the previous step >>
v.1.2.2,<< The directory in which the model output will be placed >>
v.1.2.2,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v.1.2.2,Network definition
v.1.2.2,Import this module to automatically setup path to local airsim module
v.1.2.2,This module first tries to see if airsim module is installed via pip
v.1.2.2,If it does then we don't do anything else
v.1.2.2,Else we look up grand-parent folder to see if it has airsim folder
v.1.2.2,and if it does then we add that in sys.path
v.1.2.2,this class simply tries to see if airsim
v.1.2.2,if airsim module is installed then don't do anything else
v.1.2.2,import pkgutil
v.1.2.2,airsim_loader = pkgutil.find_loader('airsim')
v.1.2.2,if airsim_loader is not None:
v.1.2.2,return
v.1.2.2,DEY: I don't know why this was there.
v.1.2.2,-----------------------------------  Common vehicle APIs ---------------------------------------------
v.1.2.2,basic flight control
v.1.2.2,time-of-day control
v.1.2.2,weather
v.1.2.2,camera control
v.1.2.2,simGetImage returns compressed png in array of bytes
v.1.2.2,image_type uses one of the ImageType members
v.1.2.2,"todo: in future remove below, it's only for compatibility to pre v1.2"
v.1.2.2,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v.1.2.2,camera control
v.1.2.2,simGetImage returns compressed png in array of bytes
v.1.2.2,image_type uses one of the ImageType members
v.1.2.2,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v.1.2.2,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v.1.2.2,sensor APIs
v.1.2.2,----------- APIs to control ACharacter in scene ----------/
v.1.2.2,legacy handling
v.1.2.2,TODO: remove below legacy wrappers in future major releases
v.1.2.2,-----------------------------------  Multirotor APIs ---------------------------------------------
v.1.2.2,APIs for control
v.1.2.2,query vehicle state
v.1.2.2,-----------------------------------  Car APIs ---------------------------------------------
v.1.2.2,helper method for converting getOrientation to roll/pitch/yaw
v.1.2.2,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v.1.2.2,roll (x-axis rotation)
v.1.2.2,pitch (y-axis rotation)
v.1.2.2,yaw (z-axis rotation)
v.1.2.2,DEY: I don't know why this was there.
v.1.2.2,reverse the vertical line order and add null bytes at the start
v.1.2.2,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v.1.2.2,return cls(**msgpack.unpack(encoded))
v.1.2.2,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v.1.2.2,"in header only mode, control library is not available"
v.1.2.2,if using Unreal Build system then include precompiled header file first
v.1.2.2,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v.1.2.2,"Windows, OSX and Linux."
v.1.2.2,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v.1.2.2,Windows users can move the Documents folder to any location they want
v.1.2.2,SHGetFolderPath knows how to find it.
v.1.2.2,fall back in case SHGetFolderPath failed for some reason.
v.1.2.2,convert from std::path '/' to windows backslash.
v.1.2.2,make the current thread run with maximum priority.
v.1.2.2,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v.1.2.2,TODO: How to handle POSIX thread priorities on OSX?
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,MavlinkMoCap.cpp : Defines the entry point for the console application.
v.1.2.2,
v.1.2.2,Treat all errors as failure conditions.
v.1.2.2,parse command line
v.1.2.2,"motive gives a weird error if the project is not found, so we look for it."
v.1.2.2,Do an update to pick up any recently-arrived cameras.
v.1.2.2,List all detected cameras.
v.1.2.2,List all defined rigid bodies.
v.1.2.2,throttle to 50 messages per second.
v.1.2.2,OptiTrack uses 'y' axis for vertical.
v.1.2.2,stdafx.cpp : source file that includes just the standard includes
v.1.2.2,MavlinkMoCap.pch will be the pre-compiled header
v.1.2.2,stdafx.obj will contain the pre-compiled type information
v.1.2.2,TODO: reference any additional headers you need in STDAFX.H
v.1.2.2,and not in this file
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,PX4.cpp : Defines the entry point for the console application.
v.1.2.2,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v.1.2.2,how do you write to the debug output windows on Unix ?
v.1.2.2,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v.1.2.2,connection to create to talke to that server.
v.1.2.2,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v.1.2.2,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v.1.2.2,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v.1.2.2,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v.1.2.2,using their the -qgc option.
v.1.2.2,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v.1.2.2,this switch controls whether we turn off the RC remote active link loss detection
v.1.2.2,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v.1.2.2,from kicking in when you try and fly.
v.1.2.2,can't use experimental stuff on Linux because of potential ABI issues
v.1.2.2,parse the json
v.1.2.2,flatten inner mavlink object
v.1.2.2,flatten inner mavlink object
v.1.2.2,todo
v.1.2.2,todo
v.1.2.2,"const char* outLogFileOption = ""outlogfile"";"
v.1.2.2,parse command line
v.1.2.2,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v.1.2.2,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v.1.2.2,"no local serial connection, so this is the primary droneConnection."
v.1.2.2,failed to connect
v.1.2.2,"local connection, then we own sending the heartbeat."
v.1.2.2,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v.1.2.2,cmdTable.push_back(new AltHoldCommand());
v.1.2.2,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v.1.2.2,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v.1.2.2,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v.1.2.2,this stops us from being able to connect to SITL mode PX4.
v.1.2.2,checkPulse();
v.1.2.2,add command text in log
v.1.2.2,close previous command.
v.1.2.2,FilterLogFiles(logDirectory);
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,send a heartbeat
v.1.2.2,accept one incoming connection
v.1.2.2,send a heartbeat to the client
v.1.2.2,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v.1.2.2,"this is the server code, it will accept 1 connection from a client on port 14588"
v.1.2.2,for this unit test we are expecting a request to send an image.
v.1.2.2,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v.1.2.2,hmmm
v.1.2.2,================ ls
v.1.2.2,================ put file
v.1.2.2,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v.1.2.2,================ get file
v.1.2.2,verify the file contents.
v.1.2.2,================ remove file
v.1.2.2,================ make directory
v.1.2.2,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v.1.2.2,================ remove directory
v.1.2.2,Now verification
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,from main.cpp.
v.1.2.2,you must call this method if you want HandleMessage to be called subsequently.
v.1.2.2,treat literals as one word
v.1.2.2,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v.1.2.2,request gps info
v.1.2.2,convert target altitude to a 'z' coordinate (in NED coordinates).
v.1.2.2,find relative position since command start so we can compare two commands better
v.1.2.2,TODO: make below future proof (i.e. usable by C++17 compiler) - also change same in main.cpp
v.1.2.2,can't use experimental stuff on Linux because of potential ABI issues
v.1.2.2,"these PID values are important, so set these to match"
v.1.2.2,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v.1.2.2,we can skip ahead.
v.1.2.2,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v.1.2.2,TODO: avoid passing hadcoded HIL flag
v.1.2.2,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v.1.2.2,"The global position, as returned by the Global Positioning System (GPS)."
v.1.2.2,Provides state for additional features
v.1.2.2,The general system state
v.1.2.2,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v.1.2.2,Provides state for additional features
v.1.2.2,The general system state
v.1.2.2,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v.1.2.2,Provides state for additional features
v.1.2.2,The general system state
v.1.2.2,Provides state for additional features
v.1.2.2,The general system state
v.1.2.2,note: we do not reset com when Close() is called because we want to keep running.
v.1.2.2,"user has to invoke ""hil stop"" to stop the hil thread."
v.1.2.2,generate random between 0 and 1
v.1.2.2,move to range -1 to 1
v.1.2.2,scale it
v.1.2.2,apply iy
v.1.2.2,wait for the Execute method to be called.
v.1.2.2,gps is much slower frequency than IMU.
v.1.2.2,MAVLINK_MSG_ID_HIL_GPS
v.1.2.2,disable MAV_USEHILGPS
v.1.2.2,note: we do not reset com when Close() is called because we want to keep running.
v.1.2.2,"user has to invoke ""hil stop"" to stop the hil thread."
v.1.2.2,generate random between 0 and 1
v.1.2.2,move to range -1 to 1
v.1.2.2,scale it
v.1.2.2,apply iy
v.1.2.2,wait for the Execute method to be called.
v.1.2.2,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v.1.2.2,gps is much slower frequency than IMU.
v.1.2.2,MAVLINK_MSG_ID_HIL_GPS
v.1.2.2,disable HIL mode
v.1.2.2,Enumeration of landed detector states
v.1.2.2,MAV landed state is unknown
v.1.2.2,MAV is landed (on ground)
v.1.2.2,MAV is in air
v.1.2.2,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v.1.2.2,The filtered local position
v.1.2.2,must send these regularly to keep offboard control.
v.1.2.2,"ok, now we can safely switch to loiter."
v.1.2.2,must send these regularly to keep offboard control.
v.1.2.2,integrate the heading so it is smoother.
v.1.2.2,must send these regularly to keep offboard control.
v.1.2.2,integrate the heading so it is smoother.
v.1.2.2,fly to radius
v.1.2.2,it takes about 10 cm to stop and turn.
v.1.2.2,next time around switch to orbiting!
v.1.2.2,heading points to center of circle.
v.1.2.2,interpoloate the speed ramp up time over 2 seconds from start time
v.1.2.2,"printf(""speeding up to %f\n"", orbitSpeed);"
v.1.2.2,monitor the sin curves so we can see how on track or off track it actually is.
v.1.2.2,the shape of the curve will also tell us if we are progressing at a consistent
v.1.2.2,"speed, the more deformed the sin curve the worse our progress."
v.1.2.2,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v.1.2.2,degrees just flipped from 359 to 0.
v.1.2.2,this enables us to test what happens when offboard control is lost and resumed.
v.1.2.2,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v.1.2.2,"ok, now we can start moving by velocity"
v.1.2.2,recompute to new target.
v.1.2.2,start by moving right with 10 degree roll.
v.1.2.2,haven't started yet.
v.1.2.2,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v.1.2.2,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v.1.2.2,track how our actual pitch is coming along compared to our target
v.1.2.2,and check position
v.1.2.2,the amount of pitch should depend on our speed in that direction.
v.1.2.2,passed the midpoint.
v.1.2.2,fade out the pitch as we pick up speed so we don't overshoot.
v.1.2.2,see if we just crossed the wiggle distance threshold.
v.1.2.2,(pitch affects the x-position).
v.1.2.2,reverse direction with a -30 degrees quick stop
v.1.2.2,reverse direction with a 30 degrees quick stop
v.1.2.2,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v.1.2.2,too much in that direction.
v.1.2.2,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v.1.2.2,track how our actual roll is coming along compared to our target
v.1.2.2,and check position
v.1.2.2,the amount of roll should depend on our speed in that direction.
v.1.2.2,passed the midpoint.
v.1.2.2,fade out the roll as we pick up speed so we don't overshoot.
v.1.2.2,see if we just crossed the wiggle distance threshold.
v.1.2.2,(roll affects the y-position).
v.1.2.2,reverse direction with a -30 degrees quick stop
v.1.2.2,reverse direction with a 30 degrees quick stop
v.1.2.2,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v.1.2.2,too much in that direction.
v.1.2.2,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v.1.2.2,for testing PID controller.
v.1.2.2,class AltHoldCommand : public Command
v.1.2.2,{
v.1.2.2,std::shared_ptr<MavLinkVehicle> channel;
v.1.2.2,"float sx_, sy_, sz_;"
v.1.2.2,MavLinkAttitudeTarget _current;
v.1.2.2,PidController thrust_controller_;
v.1.2.2,public:
v.1.2.2,this->sz_ = pos.z; // user defined target.
v.1.2.2,move to local position keeps the offboard control happy.
v.1.2.2,haven't started yet.
v.1.2.2,and check position
v.1.2.2,double dx = this->sx_ - pos.x;
v.1.2.2,double dy = this->sy_ - pos.y;
v.1.2.2,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v.1.2.2,too much in that direction.
v.1.2.2,adjust thrust so we keep steady height target
v.1.2.2,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v.1.2.2,"""ftp [ls|cd name|get source [target]|put source target]"";"
v.1.2.2,local remote
v.1.2.2,already handled by the parse method.
v.1.2.2,we only support very simple patterns for now.
v.1.2.2,each wildcard must be separated by literal.
v.1.2.2,back to back wildcards with no literal in between is too complex.
v.1.2.2,"we only support simple matching for now, we can add full regex later if we need it."
v.1.2.2,yep!
v.1.2.2,'*' is done we found the next matching char
v.1.2.2,this is ok.
v.1.2.2,this is an ERASE_END_LINE command which we ignore.
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,unpack the message...
v.1.2.2,pack the payload buffer.
v.1.2.2,"json can't handle ""nan"", so we convert it to null."
v.1.2.2,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v.1.2.2,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,start listening to this connection
v.1.2.2,Send heartbeat to drone.  You should not do this if some other node is
v.1.2.2,already doing it.
v.1.2.2,stop listening to the connection.
v.1.2.2,get the connection
v.1.2.2,Get the local system and component id
v.1.2.2,send a command to the remote node
v.1.2.2,MavLinkNode::MavLinkNode() = default;
v.1.2.2,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v.1.2.2,decrementing the count so the next WaitOne may block.
v.1.2.2,perhaps we have WAIT_IO_COMPLETION interrupt...
v.1.2.2,convert to absolute time.
v.1.2.2,use mach_timespec
v.1.2.2,convert to absolute time.
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,return true if we still have offboard control (can lose this if user flips the switch).
v.1.2.2,MavLinkVehicle::MavLinkVehicle() = default;
v.1.2.2,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v.1.2.2,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,============================== CLIENT ============================================
v.1.2.2,image APIs
v.1.2.2,or if you are implementing the client side call this function to get the most recent frame.
v.1.2.2,returns false if there is no new frame available.
v.1.2.2,============================== SERVER ============================================
v.1.2.2,call this to send the image back over the connection given to start function.
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,"log every message that is ""sent"" using sendMessage."
v.1.2.2,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v.1.2.2,gives you a picture of what happened in whatever timeslice you decide to call this method.
v.1.2.2,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v.1.2.2,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,for compatibility with QGroundControl we have to save the time field in big endian.
v.1.2.2,todo: mavlink2 support?
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,start listening to this connection
v.1.2.2,Send heartbeat to drone.  You should not do this if some other node is
v.1.2.2,already doing it.
v.1.2.2,send a heart beat so that the remote node knows we are still alive
v.1.2.2,(otherwise drone will trigger a failsafe operation).
v.1.2.2,ignore any failures here because we are running in our own thread here.
v.1.2.2,this is called for all messages received on the connection.
v.1.2.2,"we received a heartbeat, so let's get the capabilities."
v.1.2.2,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v.1.2.2,subclasses remembering to call this base implementation.
v.1.2.2,stop listening to the connection.
v.1.2.2,"request capabilities, it will respond with AUTOPILOT_VERSION."
v.1.2.2,wait for a heartbeat msg since this will give us the port to send commands to...
v.1.2.2,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v.1.2.2,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v.1.2.2,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v.1.2.2,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v.1.2.2,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v.1.2.2,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v.1.2.2,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v.1.2.2,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v.1.2.2,"timeout, so we'll drop through to the code below which will try and fix this..."
v.1.2.2,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v.1.2.2,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v.1.2.2,"ok, now fetch the missing parameters."
v.1.2.2,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v.1.2.2,silently fail since we are on a background thread here...
v.1.2.2,tell the caller this is complete.
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,add our custom telemetry message length.
v.1.2.2,todo: if we support signing then initialize
v.1.2.2,mavlink_intermediate_status_.signing callbacks
v.1.2.2,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v.1.2.2,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v.1.2.2,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v.1.2.2,send this right away just in case serial link is not already configured
v.1.2.2,"log every message that is ""sent"" using sendMessage."
v.1.2.2,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v.1.2.2,pack the payload buffer.
v.1.2.2,calculate checksum
v.1.2.2,mavlink2 supports trimming the payload of trailing zeros so the messages
v.1.2.2,are variable length as a result.
v.1.2.2,form the header as a byte array for the crc
v.1.2.2,these macros use old style cast.
v.1.2.2,forward messages from our connected node to the remote proxy.
v.1.2.2,tell the remote connection to expect mavlink2 messages.
v.1.2.2,forward messages from remote proxy to local connected node
v.1.2.2,CurrentThread::setMaximumPriority();
v.1.2.2,"hmmm, wait till it is opened?"
v.1.2.2,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v.1.2.2,pick up the sysid/compid of the remote node we are connected to.
v.1.2.2,then this is a mavlink 1 message
v.1.2.2,then this mavlink sender supports mavlink 2
v.1.2.2,queue event for publishing.
v.1.2.2,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v.1.2.2,as it ensures we don't lose messages if the listener is slow.
v.1.2.2,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v.1.2.2,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v.1.2.2,we would get a deadlock.
v.1.2.2,CurrentThread::setMaximumPriority();
v.1.2.2,reset counters
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,------------------------------------------------------------------------------
v.1.2.2,Defines
v.1.2.2,------------------------------------------------------------------------------
v.1.2.2,bit number  876543210987654321
v.1.2.2,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v.1.2.2,in future it would be good to have ability to add system IDs we are interested in
v.1.2.2,if (msg.sysid != getTargetSystemId())
v.1.2.2,{
v.1.2.2,// we only care about messages from our intended remote node.
v.1.2.2,return;
v.1.2.2,}
v.1.2.2,user may have changed modes on us! So we need to honor that and not
v.1.2.2,try and take it back.
v.1.2.2,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v.1.2.2,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v.1.2.2,we can store up to 16 channels in rc_channels_scaled.
v.1.2.2,The RAW values of the servo outputs
v.1.2.2,Metrics typically displayed on a HUD for fixed wing aircraft
v.1.2.2,The IMU readings in SI units in NED body frame
v.1.2.2,printSystemStatus(&msg);
v.1.2.2,todo: use this to determine when we need to do emergency landing...
v.1.2.2,Reports the current commanded attitude of the vehicle as specified by the autopilot
v.1.2.2,Provides state for additional features
v.1.2.2,The general system state
v.1.2.2,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v.1.2.2,but we do want to know when we get the ack.  So this is async ACK processing!
v.1.2.2,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v.1.2.2,if threshold < 0 then the threshold is inverted.
v.1.2.2,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v.1.2.2,Convert it to a floating point number between -1 and 1.
v.1.2.2,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v.1.2.2,until the move commands start happening.
v.1.2.2,return true if user calls requestControl and has not called releaseControl.
v.1.2.2,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v.1.2.2,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v.1.2.2,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v.1.2.2,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v.1.2.2,send a few to make sure it gets through...
v.1.2.2,now the command should succeed.
v.1.2.2,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v.1.2.2,us by which time the PX4 times out offboard mode!!
v.1.2.2,this mode change take precedence over offboard mode.
v.1.2.2,thrust must be between -1 and 1.
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,These definitions are copied from PX4 implementation
v.1.2.2,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v.1.2.2,/ 32 bit alignment to avoid usage of any pack pragmas.
v.1.2.2,/ @brief Command opcodes
v.1.2.2,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v.1.2.2,"request capabilities, it will respond with AUTOPILOT_VERSION."
v.1.2.2,must trim trailing slashes so PX4 doesn't hang!
v.1.2.2,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v.1.2.2,from the source.
v.1.2.2,check if directory exists.
v.1.2.2,perfect.
v.1.2.2,use last_message_ so we preserve the sessionid.
v.1.2.2,"could not create the local file, so stop."
v.1.2.2,must use last_message_ so we preserve the session id.
v.1.2.2,todo: wait for any pending responses from PX4 so we can safely start a new command.
v.1.2.2,todo: error handling here? sequence is out of order...
v.1.2.2,"directory must be empty then, can't do nextStep because"
v.1.2.2,it will just loop for ever re-requesting zero offset into
v.1.2.2,empty directory.
v.1.2.2,result should be a list of null terminated file names.
v.1.2.2,skipping this entry
v.1.2.2,remove the file size field.
v.1.2.2,"printf(""%s\n"", name.c_str());"
v.1.2.2,request the next batch.
v.1.2.2,"perhaps this was a late response after we did a retry, so ignore it."
v.1.2.2,"perhaps this was a late response after we did a retry, so ignore it."
v.1.2.2,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v.1.2.2,reached the end of the list or the file.
v.1.2.2,end of file or directory listing.
v.1.2.2,"success, data should be following..."
v.1.2.2,ack on this cmd is a noop
v.1.2.2,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v.1.2.2,give up then.
v.1.2.2,tell watchdog we are sending a request
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,================================= CLIENT ==============================================================
v.1.2.2,Check if we have a valid transaction
v.1.2.2,emit signal if all packets arrived
v.1.2.2,Restart statemachine
v.1.2.2,image APIs
v.1.2.2,================================= SERVER ==============================================================
v.1.2.2,Prepare and send acknowledgment packet
v.1.2.2,Copy PACKET_PAYLOAD bytes of image data to send buffer
v.1.2.2,Send ENCAPSULATED_IMAGE packet
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v.1.2.2,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v.1.2.2,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v.1.2.2,send this right away just in case serial link is not already configured
v.1.2.2,CurrentThread::setMaximumPriority();
v.1.2.2,"hmmm, wait till it is opened?"
v.1.2.2,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v.1.2.2,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v.1.2.2,queue event for publishing.
v.1.2.2,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v.1.2.2,as it ensures we don't lose messages if the listener is slow.
v.1.2.2,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v.1.2.2,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v.1.2.2,we would get a deadlock.
v.1.2.2,CurrentThread::setMaximumPriority();
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v.1.2.2,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,{4d36e978-e325-11ce-bfc1-08002be10318}
v.1.2.2,parse out the VID number
v.1.2.2,now the PID
v.1.2.2,parse out the VID number
v.1.2.2,examples:
v.1.2.2,PX4: USB\VID_26AC&PID_0011\0
v.1.2.2,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v.1.2.2,"printf(""Found: %S\n"", buffer.c_str());"
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,{4d36e978-e325-11ce-bfc1-08002be10318}
v.1.2.2,parse out the VID number
v.1.2.2,now the PID
v.1.2.2,parse out the VID number
v.1.2.2,suppress
v.1.2.2,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,This has not been properly tested
v.1.2.2,struct iw_statistics stats;
v.1.2.2,struct iwreq req;
v.1.2.2,"memset(&stats, 0, sizeof(stats));"
v.1.2.2,"memset(&req, 0, sizeof(iwreq));"
v.1.2.2,
v.1.2.2,"strncpy(req.ifr_name, ifaceName, 16);"
v.1.2.2,req.u.data.pointer = &stats;
v.1.2.2,req.u.data.length = sizeof(iw_statistics);
v.1.2.2,
v.1.2.2,#ifdef CLEAR_UPDATED
v.1.2.2,req.u.data.flags = 1;
v.1.2.2,#endif
v.1.2.2,
v.1.2.2,/* Perform the ioctl */
v.1.2.2,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v.1.2.2,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v.1.2.2,return -127;
v.1.2.2,}
v.1.2.2,
v.1.2.2,return stats.qual.level;
v.1.2.2,todo: windows version of this...
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,windows
v.1.2.2,Need to link with Ws2_32.lib
v.1.2.2,posix
v.1.2.2,found it!
v.1.2.2,bind socket to local address.
v.1.2.2,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v.1.2.2,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v.1.2.2,write to the serial port
v.1.2.2,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v.1.2.2,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v.1.2.2,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v.1.2.2,"try and receive something, up until port is closed anyway."
v.1.2.2,"message was too large for the buffer, no problem, return what we have."
v.1.2.2,try again - this can happen if server recreates the socket on their side.
v.1.2.2,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v.1.2.2,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v.1.2.2,try again - this can happen if server recreates the socket on their side.
v.1.2.2,"printf(""#### recv failed with error: %d\n"", hr);"
v.1.2.2,we now have it.
v.1.2.2,this is from someone we are not interested in.
v.1.2.2,"printf(""Connection closed\n"");"
v.1.2.2,-----------------------------------------------------------------------------------------
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,Initialize Winsock
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,windows
v.1.2.2,Need to link with Ws2_32.lib
v.1.2.2,posix
v.1.2.2,found it!
v.1.2.2,bind socket to local address.
v.1.2.2,bind socket to local address.
v.1.2.2,start listening for incoming connection
v.1.2.2,accept 1
v.1.2.2,write to the serial port
v.1.2.2,"try and receive something, up until port is closed anyway."
v.1.2.2,"message was too large for the buffer, no problem, return what we have."
v.1.2.2,try again - this can happen if server recreates the socket on their side.
v.1.2.2,"skip this, it is was interrupted."
v.1.2.2,"printf(""Connection closed\n"");"
v.1.2.2,-----------------------------------------------------------------------------------------
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,"FIXME: The windows api docs are not very clear about read timeouts,"
v.1.2.2,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v.1.2.2,set signal
v.1.2.2,Clear Handshake flags
v.1.2.2,Set Handshake flags
v.1.2.2,return GetLastError();
v.1.2.2,return GetLastError();
v.1.2.2,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v.1.2.2,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v.1.2.2,enable reading
v.1.2.2,posix doesn't have mark/space parity.
v.1.2.2,posix doesn't have mark/space parity.
v.1.2.2,this is the default.
v.1.2.2,not sure this is supported...
v.1.2.2,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v.1.2.2,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v.1.2.2,First do those specified by POSIX.
v.1.2.2,Now conditionally handle a bunch of extended rates.
v.1.2.2,First do those specified by POSIX.
v.1.2.2,Now conditionally handle a bunch of extended rates.
v.1.2.2,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v.1.2.2,import airsim
v.1.2.2,todo expose airsimsettings.hpp via pybind11? this should be done for the full API *some*day
v.1.2.2,self.args = args
v.1.2.2,arrange drones in a rectangle. todo make classes for different swarm spawn shapes?
v.1.2.2,pdb.set_trace()
v.1.2.2,#include <pluginlib/class_list_macros.h>
v.1.2.2,"PLUGINLIB_EXPORT_CLASS(AirsimROSWrapper, nodelet::Nodelet)"
v.1.2.2,intitialize placeholder control commands
v.1.2.2,vel_cmd_ = VelCmd();
v.1.2.2,gimbal_cmd_ = GimbalCmd();
v.1.2.2,todo do not reset if already in air?
v.1.2.2,"todo there's only one global origin geopoint for environment. but airsim API accept a parameter vehicle_name? inside carsimpawnapi.cpp, there's a geopoint being assigned in the constructor. by?"
v.1.2.2,ros params
v.1.2.2,todo enforce dynamics constraints in this node as well?
v.1.2.2,"nh_.getParam(""max_vert_vel_"", max_vert_vel_);"
v.1.2.2,"nh_.getParam(""max_horz_vel"", max_horz_vel_)"
v.1.2.2,XmlRpc::XmlRpcValue can't be const in this case
v.1.2.2,subscribe to control commands on global nodehandle
v.1.2.2,vehicle_setting_vec_.clear();
v.1.2.2,vehicle_imu_map_;
v.1.2.2,callback_queues_.clear();
v.1.2.2,"iterate over std::map<std::string, std::unique_ptr<VehicleSetting>> vehicles;"
v.1.2.2,auto vehicle_setting_local = vehicle_setting.get();
v.1.2.2,bind to a single callback. todo optimal subs queue length
v.1.2.2,"bind multiple topics to a single callback, but keep track of which vehicle name it was by passing curr_vehicle_name as the 2nd argument"
v.1.2.2,"multirotor_ros.reset_srvr = nh_private_.advertiseService(curr_vehicle_name + ""/reset"",&AirsimROSWrapper::reset_srv_cb, this);"
v.1.2.2,"iterate over camera map std::map<std::string, CameraSetting> cameras;"
v.1.2.2,vehicle_setting_vec_.push_back(*vehicle_setting.get());
v.1.2.2,camera_setting.gimbal
v.1.2.2,"iterate over capture_setting std::map<int, CaptureSetting> capture_settings"
v.1.2.2,todo why does AirSimSettings::loadCaptureSettings calls AirSimSettings::initializeCaptureSettings()
v.1.2.2,which initializes default capture settings for _all_ NINE msr::airlib::ImageCaptureBase::ImageType
v.1.2.2,"if scene / segmentation / surface normals / infrared, get uncompressed image with pixels_as_floats = false"
v.1.2.2,"if {DepthPlanner, DepthPerspective,DepthVis, DisparityNormalized}, get float image"
v.1.2.2,"push back pair (vector of image captures, current vehicle name)"
v.1.2.2,"iterate over sensors std::map<std::string, std::unique_ptr<SensorSetting>> sensors;"
v.1.2.2,"todo this is pretty non scalable, refactor airsim and ros api and maintain a vehicle <-> sensor (setting) map"
v.1.2.2,add takeoff and land all services if more than 2 drones
v.1.2.2,"gimbal_angle_quat_cmd_sub_ = nh_.subscribe(""gimbal_angle_quat_cmd"", 50, &AirsimROSWrapper::gimbal_angle_quat_cmd_cb, this);"
v.1.2.2,todo add per vehicle reset in AirLib API
v.1.2.2,todo mimic gazebo's /use_sim_time feature which publishes airsim's clock time..via an rpc call?!
v.1.2.2,"clock_pub_ = nh_private_.advertise<rosgraph_msgs::Clock>(""clock"", 10);"
v.1.2.2,"if >0 cameras, add one more thread for img_request_timer_cb"
v.1.2.2,nh_private_.setCallbackQueue(&lidar_timer_cb_queue_);
v.1.2.2,"todo: error check. if state is not landed, return error."
v.1.2.2,response.success =
v.1.2.2,response.success =
v.1.2.2,response.success =
v.1.2.2,response.success =
v.1.2.2,response.success =
v.1.2.2,response.success =
v.1.2.2,todo add reset by vehicle_name API to airlib
v.1.2.2,todo not async remove waitonlasttask
v.1.2.2,"void AirsimROSWrapper::vel_cmd_body_frame_cb(const airsim_ros_pkgs::VelCmd& msg, const std::string& vehicle_name)"
v.1.2.2,todo do actual body frame?
v.1.2.2,airsim uses degrees
v.1.2.2,todo do actual body frame?
v.1.2.2,airsim uses degrees
v.1.2.2,void AirsimROSWrapper::vel_cmd_all_body_frame_cb(const airsim_ros_pkgs::VelCmd::ConstPtr& msg)
v.1.2.2,todo expose waitOnLastTask or nah?
v.1.2.2,todo do actual body frame?
v.1.2.2,airsim uses degrees
v.1.2.2,this is kinda unnecessary but maybe it makes life easier for the end user.
v.1.2.2,todo expose waitOnLastTask or nah?
v.1.2.2,todo support multiple gimbal commands
v.1.2.2,todo support multiple gimbal commands
v.1.2.2,1. find quaternion of default gimbal pose
v.1.2.2,2. forward multiply with quaternion equivalent to desired euler commands (in degrees)
v.1.2.2,3. call airsim client's setcameraorientation which sets camera orientation wrt world (or takeoff?) ned frame. todo
v.1.2.2,odom_ned_msg.header.frame_id = world_frame_id_;
v.1.2.2,"odom_ned_msg.child_frame_id = ""/airsim/odom_local_ned""; // todo make param"
v.1.2.2,https://docs.ros.org/jade/api/sensor_msgs/html/point__cloud__conversion_8h_source.html#l00066
v.1.2.2,look at UnrealLidarSensor.cpp UnrealLidarSensor::getPointCloud() for math
v.1.2.2,read this carefully https://docs.ros.org/kinetic/api/sensor_msgs/html/msg/PointCloud2.html
v.1.2.2,msg = []
v.1.2.2,todo covariances
v.1.2.2,"imu_msg.header.frame_id = ""/airsim/odom_local_ned"";// todo multiple drones"
v.1.2.2,todo radians per second
v.1.2.2,meters/s2^m
v.1.2.2,imu_msg.orientation_covariance = ;
v.1.2.2,imu_msg.angular_velocity_covariance = ;
v.1.2.2,imu_msg.linear_acceleration_covariance = ;
v.1.2.2,todo unused
v.1.2.2,void AirsimROSWrapper::set_zero_vel_cmd()
v.1.2.2,{
v.1.2.2,vel_cmd_.x = 0.0;
v.1.2.2,vel_cmd_.y = 0.0;
v.1.2.2,vel_cmd_.z = 0.0;
v.1.2.2,vel_cmd_.drivetrain = msr::airlib::DrivetrainType::MaxDegreeOfFreedom;
v.1.2.2,vel_cmd_.yaw_mode.is_rate = false;
v.1.2.2,// todo make class member or a fucntion
v.1.2.2,"double roll, pitch, yaw;"
v.1.2.2,"tf2::Matrix3x3(get_tf2_quat(curr_drone_state_.kinematics_estimated.pose.orientation)).getRPY(roll, pitch, yaw); // ros uses xyzw"
v.1.2.2,vel_cmd_.yaw_mode.yaw_or_rate = yaw;
v.1.2.2,}
v.1.2.2,todo this is global origin
v.1.2.2,iterate over drones
v.1.2.2,get drone state from airsim
v.1.2.2,convert airsim drone state to ROS msgs
v.1.2.2,publish to ROS!
v.1.2.2,send control commands from the last callback to airsim
v.1.2.2,"""clear"" control cmds"
v.1.2.2,IMUS
v.1.2.2,todo add and expose a gimbal angular velocity to airlib
v.1.2.2,airsim uses nans for zeros in settings.json. we set them to zeros here for handling tfs in ROS
v.1.2.2,"if any nan's in camera pose, set them to match vehicle pose (which has already converted any potential nans to zeros)"
v.1.2.2,std::lock_guard<std::recursive_mutex> guard(drone_control_mutex_);
v.1.2.2,std::lock_guard<std::recursive_mutex> guard(lidar_mutex_);
v.1.2.2,"todo using img_response.image_data_float direclty as done get_img_msg_from_response() throws an error,"
v.1.2.2,"hence the dependency on opencv and cv_bridge. however, this is an extremely fast op, so no big deal."
v.1.2.2,todo have a special stereo pair mode and get projection matrix by calculating offset wrt drone body frame?
v.1.2.2,todo focal length in Y direction should be same as X it seems. this can change in future a scene capture component which exactly correponds to a cine camera
v.1.2.2,float f_y = (capture_setting.height / 2.0) / tan(math_common::deg2rad(fov_degrees / 2.0));
v.1.2.2,todo add option to use airsim time (image_response.TTimePoint) like Gazebo /use_sim_time param
v.1.2.2,"todo publishing a tf for each capture type seems stupid. but it foolproofs us against render thread's async stuff, I hope."
v.1.2.2,"Ideally, we should loop over cameras and then captures, and publish only one tf."
v.1.2.2,todo simGetCameraInfo is wrong + also it's only for image type -1.
v.1.2.2,msr::airlib::CameraInfo camera_info = airsim_client_.simGetCameraInfo(curr_img_response.camera_name);
v.1.2.2,update timestamp of saved cam info msgs
v.1.2.2,DepthPlanner / DepthPerspective / DepthVis / DisparityNormalized
v.1.2.2,Scene / Segmentation / SurfaceNormals / Infrared
v.1.2.2,publish camera transforms
v.1.2.2,camera poses are obtained from airsim's client API which are in (local) NED frame.
v.1.2.2,"We first do a change of basis to camera optical frame (Z forward, X right, Y down)"
v.1.2.2,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body * matrix_cam_body_to_optical_inverse_;
v.1.2.2,tf2::Matrix3x3 mat_cam_optical = matrix_cam_body_to_optical_ * mat_cam_body;
v.1.2.2,ROS params
v.1.2.2,ROS publishers
v.1.2.2,ROS subscribers
v.1.2.2,"todo publish this under global nodehandle / ""airsim node"" and hide it from user"
v.1.2.2,ROS timers
v.1.2.2,todo maintain internal representation as eigen vec?
v.1.2.2,todo check if low velocity if within thresh?
v.1.2.2,todo maintain separate errors for XY and Z
v.1.2.2,todo save this in degrees somewhere to avoid repeated conversion
v.1.2.2,this tells the update timer callback to not do active hovering
v.1.2.2,todo maintain array of position goals
v.1.2.2,todo error checks
v.1.2.2,todo fill response
v.1.2.2,this tells the update timer callback to not do active hovering
v.1.2.2,todo error checks
v.1.2.2,todo fill response
v.1.2.2,"todo do relative altitude, or add an option for the same?"
v.1.2.2,convert GPS goal to NED goal
v.1.2.2,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v.1.2.2,todo error checks
v.1.2.2,todo fill response
v.1.2.2,"todo do relative altitude, or add an option for the same?"
v.1.2.2,convert GPS goal to NED goal
v.1.2.2,"ROS_INFO_STREAM(""[PIDPositionController] geodetic_converter_ GPS reference initialized correctly (lat long in radians) "" << initial_latitude << "", ""<< initial_longitude << "", "" << initial_altitude);"
v.1.2.2,todo error checks
v.1.2.2,todo fill response
v.1.2.2,todo check if odometry is too old!!
v.1.2.2,"if no odom, don't do anything."
v.1.2.2,"dear future self, this function doesn't return coz we need to keep on actively hovering at last goal pose. don't act smart"
v.1.2.2,"only compute and send control commands for hovering / moving to pose, if we received a goal at least once in the past"
v.1.2.2,todo just add a sgn funciton in common utils? return double to be safe.
v.1.2.2,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v.1.2.2,todo yaw limits
v.1.2.2,todo just add a sgn funciton in common utils? return double to be safe.
v.1.2.2,template <typename T> double sgn(T val) { return (T(0) < val) - (val < T(0)); }
v.1.2.2,check if path exists
v.1.2.2,todo airsim's simhud.cpp does error checking here
v.1.2.2,mimics void ASimHUD::initializeSettings()
v.1.2.2,not sure where settings_json initialized in AirSimSettings::initializeSettings() is actually used
v.1.2.2,int num_threads = 1;
v.1.2.2,ros::MultiThreadedSpinner multi_thread(num_threads);
v.1.2.2,multi_thread.spin();
v.1.2.2,ros::AsyncSpinner async_spinner(num_threads);
v.1.2.2,async_spinner.start();
v.1.2.2,single threaded spinner
v.1.2.2,","
v.1.2.2,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v.1.2.2,std::unique_ptr<TestBase>(new WorkerThreadTest())
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,"in header only mode, control library is not available"
v.1.2.2,TODO: something defines max macro which interfears with code here
v.1.2.2,is cur_pos within fence?
v.1.2.2,destination risk is not available then consider it zero
v.1.2.2,if dest risk is lower than its more safe
v.1.2.2,are we doing better than closest obstacle?
v.1.2.2,"if we stay where we are, what is the risk distance?"
v.1.2.2,else we are better of moving to dest
v.1.2.2,this function should work even when dest_pos == cur_pos
v.1.2.2,is this dest_pos cur_pos within the fence?
v.1.2.2,transform dest_pos vector to body frame
v.1.2.2,check for approx zero vectors to avoid random yaw angles
v.1.2.2,we are hovering
v.1.2.2,"get yaw in body frame, ie, front is always 0 radians"
v.1.2.2,yaw to ticks
v.1.2.2,get obstacles in the window at the tick direction around the window
v.1.2.2,less risk distance is better
v.1.2.2,check obstacles around current position and see if it has lower risk
v.1.2.2,else obstacle is too far
v.1.2.2,"if we detected unsafe condition due to obstacle, find direction to move away to"
v.1.2.2,look for each surrounding tick to see if we have obstacle free angle
v.1.2.2,else no suggestions required
v.1.2.2,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v.1.2.2,evaluate right and left side of circle
v.1.2.2,find right and left risk distances
v.1.2.2,at this point we have already determined hover is better than going to dest
v.1.2.2,we now determine is moving to suggested angle better than hovering?
v.1.2.2,check if dest_pos is safe
v.1.2.2,breaking distance at this velocity
v.1.2.2,calculate dest_pos cur_pos we will be if we had to break suddenly
v.1.2.2,check if dest_pos is safe
v.1.2.2,float/vec parameters can have NaN which makes them optional
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,"in header only mode, control library is not available"
v.1.2.2,handles +/- tick and wraps around circle
v.1.2.2,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v.1.2.2,update the specified window on the map
v.1.2.2,make sure from <= to
v.1.2.2,normalize the ticks so both are valid indices
v.1.2.2,if from is still larger then
v.1.2.2,to ticks is then added one full circle to make it larger than from_tick
v.1.2.2,find closest obstacle in given window
v.1.2.2,search whole map to find closest obstacle
v.1.2.2,"in header only mode, control library is not available"
v.1.2.2,#include <fileapi.h>
v.1.2.2,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v.1.2.2,"Windows, OSX and Linux."
v.1.2.2,Windows users can move the Documents folder to any location they want
v.1.2.2,SHGetFolderPath knows how to find it.
v.1.2.2,fall back in case SHGetFolderPath failed for some reason.
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,"in header only mode, control library is not available"
v.1.2.2,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v.1.2.2,if using Unreal Build system then include precompiled header file first
v.1.2.2,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v.1.2.2,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v.1.2.2,----------- APIs to control ACharacter in scene ----------/
v.1.2.2,if we don't suppress then server will bomb out for exceptions raised by any method
v.1.2.2,required for pimpl
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,"in header only mode, control library is not available"
v.1.2.2,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v.1.2.2,if using Unreal Build system then include precompiled header file first
v.1.2.2,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v.1.2.2,"some long flight path commands can take a while, so we give it up to 1 hour max."
v.1.2.2,make sure we can talk to the DroneServer
v.1.2.2,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v.1.2.2,command_context.client.ping();
v.1.2.2,"std::cout << ""DroneServer is responding."" << std::endl;"
v.1.2.2,sim only
v.1.2.2,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v.1.2.2,return value of last task. It should be true if task completed without
v.1.2.2,cancellation or timeout
v.1.2.2,"should be implemented by derived class if it supports async task,"
v.1.2.2,for example using futures
v.1.2.2,----------- APIs to control ACharacter in scene ----------/
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,"in header only mode, control library is not available"
v.1.2.2,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v.1.2.2,if using Unreal Build system then include precompiled header file first
v.1.2.2,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,"in header only mode, control library is not available"
v.1.2.2,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v.1.2.2,if using Unreal Build system then include precompiled header file first
v.1.2.2,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v.1.2.2,required for pimpl
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,"in header only mode, control library is not available"
v.1.2.2,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v.1.2.2,if using Unreal Build system then include precompiled header file first
v.1.2.2,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v.1.2.2,status getters
v.1.2.2,return value of last task. It should be true if task completed without
v.1.2.2,cancellation or timeout
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,"in header only mode, control library is not available"
v.1.2.2,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v.1.2.2,if using Unreal Build system then include pre-compiled header file first
v.1.2.2,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v.1.2.2,getters
v.1.2.2,required for pimpl
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,"in header only mode, control library is not available"
v.1.2.2,last command is to hold on to position
v.1.2.2,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v.1.2.2,after landing we detect if drone has stopped moving
v.1.2.2,validate path size
v.1.2.2,validate yaw mode
v.1.2.2,validate and set auto-lookahead value
v.1.2.2,if auto mode requested for lookahead then calculate based on velocity
v.1.2.2,add current position as starting point
v.1.2.2,append the input path and compute segments
v.1.2.2,add last segment as zero length segment so we have equal number of segments and points.
v.1.2.2,path_segs[i] refers to segment that starts at point i
v.1.2.2,"when path ends, we want to slow down"
v.1.2.2,else no need to change velocities for last segments
v.1.2.2,setup current position on path to 0 offset
v.1.2.2,initialize next path position
v.1.2.2,until we are at the end of the path (last seg is always zero size)
v.1.2.2,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v.1.2.2,send drone command to get to next lookahead
v.1.2.2,sleep for rest of the cycle
v.1.2.2,how much have we moved towards last goal?
v.1.2.2,project actual vector on goal vector
v.1.2.2,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v.1.2.2,TODO: below should be lower than 1E3 and configurable
v.1.2.2,but lower values like 100 doesn't work for simple_flight + ScalableClock
v.1.2.2,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v.1.2.2,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v.1.2.2,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v.1.2.2,"if drone moved backward, we don't want goal to move backward as well"
v.1.2.2,"so only climb forward on the path, never back. Also note >= which means"
v.1.2.2,we climb path even if distance was 0 to take care of duplicated points on path
v.1.2.2,else
v.1.2.2,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v.1.2.2,compute next target on path
v.1.2.2,freeze the quaternion
v.1.2.2,convert RC commands to velocity vector
v.1.2.2,find yaw as per terrain and remote setting
v.1.2.2,execute command
v.1.2.2,if timeout occurred then command completed successfully otherwise it was interrupted
v.1.2.2,change yaw by moving to same position but constant yaw mode
v.1.2.2,by default we say that this command is not supported
v.1.2.2,executes a given function until it returns true. Each execution is spaced apart at command period.
v.1.2.2,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v.1.2.2,get trims
v.1.2.2,take average
v.1.2.2,validate dest
v.1.2.2,what is the distance we will travel at this velocity?
v.1.2.2,get velocity vector
v.1.2.2,yaw for the direction of travel
v.1.2.2,find velocity vector
v.1.2.2,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v.1.2.2,generate velocity vector that is same size as cur_dest_norm / command period
v.1.2.2,this velocity vect when executed for command period would yield cur_dest_norm
v.1.2.2,send commands
v.1.2.2,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v.1.2.2,default strategy is for move. In hover mode we set new strategy temporarily
v.1.2.2,are we supposed to do EM?
v.1.2.2,get suggested velocity vector
v.1.2.2,use the unchecked command
v.1.2.2,tell caller not to execute planned command
v.1.2.2,other wise throw exception
v.1.2.2,otherwise there is some other reason why we are in unsafe situation
v.1.2.2,send last command to come to full stop
v.1.2.2,else no unsafe situation
v.1.2.2,note: cur_path_loc and next_path_loc may both point to same object
v.1.2.2,"otherwise use up this segment, move on to next one"
v.1.2.2,if we are here then we ran out of segments
v.1.2.2,consider last segment as zero length segment
v.1.2.2,adjust yaw for the direction of travel in forward-only mode
v.1.2.2,else no adjustment needed
v.1.2.2,if auto mode requested for lookahead then calculate based on velocity
v.1.2.2,Create a spring arm component for our chase camera
v.1.2.2,"do nothing, spring arm is pulling the camera with it"
v.1.2.2,"do nothing, we have camera turned off"
v.1.2.2,set initial view mode
v.1.2.2,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v.1.2.2,"For car, we want a bit of camera lag, as that is customary of racing video games"
v.1.2.2,"If the lag is missing, the camera will also occasionally shake."
v.1.2.2,"But, lag is not desired when piloting a drone"
v.1.2.2,attach spring arm to actor
v.1.2.2,remember current parent for external camera. Later when we remove external
v.1.2.2,"camera from spring arm, we will attach it back to its last parent"
v.1.2.2,now attach camera to spring arm
v.1.2.2,"For car, we need to move the camera back a little more than for a drone."
v.1.2.2,"Otherwise, the camera will be stuck inside the car"
v.1.2.2,ExternalCamera->bUsePawnControlRotation = false;
v.1.2.2,detach spring arm
v.1.2.2,Re-enable rendering
v.1.2.2,Remove any existing key bindings for manual mode
v.1.2.2,"else someone else is bound to manual pose controller, leave it alone"
v.1.2.2,if new mode is manual mode then add key bindings
v.1.2.2,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v.1.2.2,other modes don't need special setup
v.1.2.2,make switch official
v.1.2.2,reset any chars we have
v.1.2.2,------------------------------------------------- Char APIs -----------------------------------------------------------/
v.1.2.2,choose first character if name was blank or find by name
v.1.2.2,------------------------------------------------- Char APIs -----------------------------------------------------------/
v.1.2.2,by default all image types are disabled
v.1.2.2,use final color for all calculations
v.1.2.2,TODO: avoid the need to override const cast here
v.1.2.2,if the viewport is taller than it is wide
v.1.2.2,The FPerspectiveMatrix() constructor actually returns the transpose of the perspective matrix.
v.1.2.2,Takes a vector from NORTH-EAST-DOWN coordinates (AirSim) to EAST-UP-SOUTH coordinates (Unreal). Leaves W coordinate unchanged.
v.1.2.2,Copy the result to an airlib::ProjectionMatrix while taking transpose.
v.1.2.2,use final color for all calculations
v.1.2.2,TODO: should we be ignoring position and orientation settings here?
v.1.2.2,TODO: can we eliminate storing NedTransform?
v.1.2.2,if (!std::isnan(setting.target_gamma))
v.1.2.2,camera-> = setting.target_gamma;
v.1.2.2,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v.1.2.2,else nothing to enable
v.1.2.2,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v.1.2.2,if (controller && controller->GetViewTarget() == this)
v.1.2.2,controller->SetViewTarget(nullptr);
v.1.2.2,TODO: explore screenshot option
v.1.2.2,addScreenCaptureHandler(camera->GetWorld());
v.1.2.2,TODO: may be we should have these methods non-const?
v.1.2.2,We don't do game/render thread synchronization for safe method.
v.1.2.2,We just blindly sleep for 200ms (the old way)
v.1.2.2,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v.1.2.2,Make sure that all alpha values are opaque.
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,"#include ""Runtime/Foliage/Public/FoliageType.h"""
v.1.2.2,TODO: change naming conventions to same as other files?
v.1.2.2,Enable/disable primary viewport rendering flag
v.1.2.2,This disables rendering of the main viewport in the same way as the
v.1.2.2,"console command ""show rendering"" would do."
v.1.2.2,"When getting an image through the API, the image is produced after the render"
v.1.2.2,thread has finished rendering the current and the subsequent frame. This means
v.1.2.2,that the frame rate for obtaining images through the API is only half as high as
v.1.2.2,"it could be, since only every other image is actually captured. We work around"
v.1.2.2,this by telling the viewport to flush the rendering queue at the end of each
v.1.2.2,drawn frame so that it executes our render request at that point already.
v.1.2.2,Do this only if the main viewport is not being rendered anyway in case there are
v.1.2.2,any adverse performance effects during main rendering.
v.1.2.2,TODO: Validate framerate of sensor data when the NoDisplay setting is turned on.
v.1.2.2,nothing to do for now
v.1.2.2,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v.1.2.2,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v.1.2.2,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v.1.2.2,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v.1.2.2,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v.1.2.2,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v.1.2.2,{
v.1.2.2,InitializeObjectStencilID(*comp);
v.1.2.2,}
v.1.2.2,Access the subclass instance with the * or -> operators.
v.1.2.2,can we see followee?
v.1.2.2,remove mapping
v.1.2.2,removing binding
v.1.2.2,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v.1.2.2,"some point. At the moment, manually swapping Red and Blue"
v.1.2.2,Copy scaled image into destination thumb
v.1.2.2,Compress data - convert into a .png
v.1.2.2,if we already have attached actor
v.1.2.2,#ifdef _MSC_VER
v.1.2.2,//print to VS output window
v.1.2.2,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v.1.2.2,#endif
v.1.2.2,also do default logging
v.1.2.2,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v.1.2.2,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v.1.2.2,{
v.1.2.2,if (GEngine != nullptr)
v.1.2.2,{
v.1.2.2,return GEngine->GameUserSettings;
v.1.2.2,}
v.1.2.2,return nullptr;
v.1.2.2,}
v.1.2.2,UGameUserSettings* game_settings = GetGameUserSettings();
v.1.2.2,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v.1.2.2,game_settings->ApplySettings(true);
v.1.2.2,derived class should override this
v.1.2.2,derived class should override this
v.1.2.2,derived class should override this
v.1.2.2,derived class should override this
v.1.2.2,derived class should override this
v.1.2.2,derived class should override this
v.1.2.2,derived class should override this
v.1.2.2,derived class should override this
v.1.2.2,derived class should override this
v.1.2.2,derived class should override this
v.1.2.2,derived class should override this
v.1.2.2,derived class should override this
v.1.2.2,derived class should override this
v.1.2.2,derived class should override this
v.1.2.2,derived class should override this
v.1.2.2,derived class should override this
v.1.2.2,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v.1.2.2,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v.1.2.2,"so we get the bounds and subtract z to get bottom as 0,0,0"
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,plugin startup
v.1.2.2,plugin shutdown
v.1.2.2,initialize state
v.1.2.2,add listener for pawn's collision event
v.1.2.2,compute our home point
v.1.2.2,default behavior is to call update every tick
v.1.2.2,"for custom physics engine, this method should be overridden and update should be"
v.1.2.2,called from every physics tick
v.1.2.2,add cameras that already exists in pawn
v.1.2.2,create or replace cameras specified in settings
v.1.2.2,setup individual cameras
v.1.2.2,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v.1.2.2,for each camera in settings
v.1.2.2,get pose
v.1.2.2,spawn and attach camera to pawn
v.1.2.2,add on to our collection
v.1.2.2,Deflect along the surface when we collide.
v.1.2.2,FRotator CurrentRotation = GetActorRotation(RootComponent);
v.1.2.2,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v.1.2.2,-1 to 1 --> 0 to 1
v.1.2.2,-1 to 1
v.1.2.2,these will be available for devices like steering wheels
v.1.2.2,switch index 0 to 7 for FrSky Taranis RC is:
v.1.2.2,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v.1.2.2,TODO: should below be at controller level info?
v.1.2.2,else don't waste time
v.1.2.2,sync environment from kinematics
v.1.2.2,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v.1.2.2,void playBack()
v.1.2.2,{
v.1.2.2,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v.1.2.2,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v.1.2.2,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v.1.2.2,}
v.1.2.2,TODO: refactor below code used for playback
v.1.2.2,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v.1.2.2,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v.1.2.2,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v.1.2.2,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v.1.2.2,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v.1.2.2,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v.1.2.2,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v.1.2.2,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v.1.2.2,}
v.1.2.2,parameters in NED frame
v.1.2.2,translate to new PawnSimApi position & orientation from NED to NEU
v.1.2.2,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v.1.2.2,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v.1.2.2,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v.1.2.2,checked at the start of next tick
v.1.2.2,allow teleportation
v.1.2.2,if collisions are not enabled
v.1.2.2,or we have collided but passthrough is enabled
v.1.2.2,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v.1.2.2,"without flip flopping, collisions can't be detected"
v.1.2.2,update kinematics from pawn's movement instead of physics engine
v.1.2.2,by default we update kinematics from UE pawn
v.1.2.2,if SimMod uses its own physics engine then this should be overriden
v.1.2.2,no default action in this base class
v.1.2.2,TODO: because this bug we are using alternative code with stringstream
v.1.2.2,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v.1.2.2,std::stringstream ss;
v.1.2.2,"ss << timestamp_millis << ""\t"";"
v.1.2.2,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v.1.2.2,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v.1.2.2,"ss << ""\n"";"
v.1.2.2,return ss.str();
v.1.2.2,"read pixels from render target using render thread, then compress the result into PNG"
v.1.2.2,argument on the thread that calls this method.
v.1.2.2,TODO: is below really needed?
v.1.2.2,make sure we are not on the rendering thread
v.1.2.2,TODO: below doesn't work right now because it must be running in game thread
v.1.2.2,below is documented method but more expensive because it forces flush
v.1.2.2,wait for render thread to pick up our task
v.1.2.2,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v.1.2.2,capture CameraPose for this frame
v.1.2.2,The completion is called immeidately after GameThread sends the
v.1.2.2,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v.1.2.2,execute *immediately* after RenderThread renders the scene!
v.1.2.2,"while we're still on GameThread, enqueue request for capture the scene!"
v.1.2.2,wait for this task to complete
v.1.2.2,log a message and continue wait
v.1.2.2,lamda function still references a few objects for which there is no refcount.
v.1.2.2,"Walking away will cause memory corruption, which is much more difficult to debug."
v.1.2.2,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v.1.2.2,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v.1.2.2,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v.1.2.2,Fill out your copyright notice in the Description page of Project Settings.
v.1.2.2,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v.1.2.2,UWorld* World = GetWorld();
v.1.2.2,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v.1.2.2,still need the menu class for f10
v.1.2.2,"UClass* Class, FTransform const* Transform, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters()"
v.1.2.2,showWeatherMenu(WorldContextObject);
v.1.2.2,"if weather is not enabled, dont allow any weather values to be set"
v.1.2.2,"must be called after SetScalarParam, because WeatherEnabled is a scalar param"
v.1.2.2,and must be set to true or false before this.
v.1.2.2,WeatherEnabled will always be false
v.1.2.2,"NOTE: weather enabled must be set first, before other params for this to work"
v.1.2.2,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v.1.2.2,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v.1.2.2,"get all menu actors, if any"
v.1.2.2,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v.1.2.2,"UWorld* World = GEngine->GetWorldFromContextObject(WorldContextObject, EGetWorldErrorMode::LogAndReturnNull);"
v.1.2.2,"get all menu actors, if any"
v.1.2.2,"hacky test to make sure we are getting the right class. for some reason cast above doesn't work, so we use this instead to test for class"
v.1.2.2,"get all menu actors, if any, then hide the menu"
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,Stuff to filter out XInput devices
v.1.2.2,-----------------------------------------------------------------------------
v.1.2.2,"Defines, constants, and global variables"
v.1.2.2,-----------------------------------------------------------------------------
v.1.2.2,Magnitude ranges from -1 to 1
v.1.2.2,Strength ranges from 0 to 1
v.1.2.2,Autocenter
v.1.2.2,Rumble
v.1.2.2,Register with the DirectInput subsystem and get a pointer
v.1.2.2,to a IDirectInput interface we can use.
v.1.2.2,Create a DInput object
v.1.2.2,Look for a simple joystick we can use for this sample program.
v.1.2.2,Make sure we got a joystick
v.1.2.2,"Set the data format to ""simple joystick"" - a predefined data format"
v.1.2.2,
v.1.2.2,"A data format specifies which controls on a device we are interested in,"
v.1.2.2,and how they should be reported. This tells DInput that we will be
v.1.2.2,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v.1.2.2,Set the cooperative level to let DInput know how this device should
v.1.2.2,interact with the system and with other DInput applications.
v.1.2.2,Enumerate the joystick objects. The callback function enabled user
v.1.2.2,"interface elements for objects that are found, and sets the min/max"
v.1.2.2,values property for discovered axes.
v.1.2.2,-----------------------------------------------------------------------------
v.1.2.2,Enum each PNP device using WMI and check each device ID to see if it contains
v.1.2.2,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v.1.2.2,Unfortunately this information can not be found by just using DirectInput.
v.1.2.2,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v.1.2.2,XInput devices.
v.1.2.2,
v.1.2.2,This function stores the list of xinput devices in a linked list
v.1.2.2,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v.1.2.2,-----------------------------------------------------------------------------
v.1.2.2,CoInit if needed
v.1.2.2,Create WMI
v.1.2.2,Create BSTRs for WMI
v.1.2.2,Connect to WMI
v.1.2.2,Switch security level to IMPERSONATE
v.1.2.2,Get list of Win32_PNPEntity devices
v.1.2.2,Loop over all devices
v.1.2.2,Get 20 at a time
v.1.2.2,"For each device, get its device ID"
v.1.2.2,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v.1.2.2,Unfortunately this information can not be found by just using DirectInput
v.1.2.2,"If it does, then get the VID/PID from var.bstrVal"
v.1.2.2,Add the VID/PID to a linked list
v.1.2.2,-----------------------------------------------------------------------------
v.1.2.2,Returns true if the DirectInput device is also an XInput device.
v.1.2.2,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v.1.2.2,-----------------------------------------------------------------------------
v.1.2.2,Check each xinput device to see if this device's vid/pid matches
v.1.2.2,-----------------------------------------------------------------------------
v.1.2.2,Cleanup needed for IsXInputDevice()
v.1.2.2,-----------------------------------------------------------------------------
v.1.2.2,Cleanup linked list
v.1.2.2,-----------------------------------------------------------------------------
v.1.2.2,Name: EnumJoysticksCallback()
v.1.2.2,"Desc: Called once for each enumerated joystick. If we find one, create a"
v.1.2.2,device interface on it so we can play with it.
v.1.2.2,-----------------------------------------------------------------------------
v.1.2.2,Skip anything other than the perferred joystick device as defined by the control panel.
v.1.2.2,Instead you could store all the enumerated joysticks and let the user pick.
v.1.2.2,Obtain an interface to the enumerated joystick.
v.1.2.2,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v.1.2.2,it while we were in the middle of enumerating it.)
v.1.2.2,Stop enumeration. Note: we're just taking the first joystick we get. You
v.1.2.2,could store all the enumerated joysticks and let the user pick.
v.1.2.2,-----------------------------------------------------------------------------
v.1.2.2,Name: EnumObjectsCallback()
v.1.2.2,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v.1.2.2,joystick. This function enables user interface elements for objects
v.1.2.2,"that are found to exist, and scales axes min/max values."
v.1.2.2,-----------------------------------------------------------------------------
v.1.2.2,"For axes that are returned, set the DIPROP_RANGE property for the"
v.1.2.2,enumerated axis in order to scale min/max values.
v.1.2.2,Set the range for the axis
v.1.2.2,Set the UI to reflect what objects the joystick supports
v.1.2.2,-----------------------------------------------------------------------------
v.1.2.2,Name: UpdateInputState()
v.1.2.2,Desc: Get the input device's state and display it.
v.1.2.2,-----------------------------------------------------------------------------
v.1.2.2,Poll the device to read the current state
v.1.2.2,DInput is telling us that the input stream has been
v.1.2.2,"interrupted. We aren't tracking any state between polls, so"
v.1.2.2,we don't have any special reset that needs to be done. We
v.1.2.2,just re-acquire and try again.
v.1.2.2,while (hr == DIERR_INPUTLOST)
v.1.2.2,hr = g_pJoystick->Acquire();
v.1.2.2,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v.1.2.2,may occur when the app is minimized or in the process of
v.1.2.2,"switching, so just try again later"
v.1.2.2,Get the input's device state
v.1.2.2,Axes
v.1.2.2,Slider controls
v.1.2.2,Points of view
v.1.2.2,Buttons
v.1.2.2,-----------------------------------------------------------------------------
v.1.2.2,Name: FreeDirectInput()
v.1.2.2,Desc: Initialize the DirectInput variables.
v.1.2.2,-----------------------------------------------------------------------------
v.1.2.2,Unacquire the device one last time just in case
v.1.2.2,the app tried to exit while the device is still acquired.
v.1.2.2,Release any DirectInput objects.
v.1.2.2,nop
v.1.2.2,normalize min to max --> 0 to 1
v.1.2.2,normalize 0 to 1 --> -1 to 1
v.1.2.2,#include <libudev.h>
v.1.2.2,implementation for unsupported OS
v.1.2.2,if this is new index
v.1.2.2,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v.1.2.2,close previous one
v.1.2.2,open new device
v.1.2.2,if open was successful
v.1.2.2,read the device
v.1.2.2,if we didn't had valid read
v.1.2.2,"NOTE if this condition is not met, we're probably out of sync and this"
v.1.2.2,Joystick instance is likely unusable
v.1.2.2,TODO: set below to false?
v.1.2.2,state.is_valid = false;
v.1.2.2,else ignore
v.1.2.2,TODO: implement this for linux
v.1.2.2,TODO: implement this for linux
v.1.2.2,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v.1.2.2,{
v.1.2.2,"manufacturerID = productID = """";"
v.1.2.2,// Use udev to look up the product and manufacturer IDs
v.1.2.2,struct udev *udev = udev_new();
v.1.2.2,if (udev) {
v.1.2.2,char sysname[32];
v.1.2.2,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v.1.2.2,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v.1.2.2,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v.1.2.2,if (!dev)
v.1.2.2,{
v.1.2.2,"message = ""Unable to find parent USB device"";"
v.1.2.2,return false;
v.1.2.2,}
v.1.2.2,std::stringstream ss;
v.1.2.2,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v.1.2.2,ss >> manufacturerID;
v.1.2.2,ss.clear();
v.1.2.2,"ss.str("""");"
v.1.2.2,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v.1.2.2,ss >> productID;
v.1.2.2,udev_device_unref(dev);
v.1.2.2,}
v.1.2.2,else
v.1.2.2,{
v.1.2.2,"message = ""Cannot create udev"";"
v.1.2.2,return false;
v.1.2.2,}
v.1.2.2,udev_unref(udev);
v.1.2.2,return true;
v.1.2.2,}
v.1.2.2,required for pimpl
v.1.2.2,TODO: anyway to workaround const_cast?
v.1.2.2,FGenericPlatformMisc::PlatformInit();
v.1.2.2,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v.1.2.2,TODO: index check
v.1.2.2,create main widget
v.1.2.2,synchronize PIP views
v.1.2.2,TODO: should we only do below on SceneCapture2D components and cameras?
v.1.2.2,avoid motion blur so capture images don't get
v.1.2.2,use two different methods to set console var because sometime it doesn't seem to work
v.1.2.2,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v.1.2.2,during startup we init stencil IDs to random hash and it takes long time for large environments
v.1.2.2,we get error that GameThread has timed out after 30 sec waiting on render thread
v.1.2.2,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v.1.2.2,setup defaults
v.1.2.2,Attempts to parse the settings text from one of multiple locations.
v.1.2.2,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v.1.2.2,"Next, check the executable's working directory for the settings file."
v.1.2.2,"Finally, check the user's documents folder."
v.1.2.2,"If the settings file cannot be read, throw an exception"
v.1.2.2,Attempts to parse the settings text from the command line
v.1.2.2,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v.1.2.2,"Example: AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v.1.2.2,"Returns true if the argument is present, false otherwise."
v.1.2.2,build image file name
v.1.2.2,write image file
v.1.2.2,write to CSV file
v.1.2.2,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v.1.2.2,TODO: check FPlatformProcess::SupportsMultithreading()?
v.1.2.2,make sire all vars are set up
v.1.2.2,"TODO: should we go as fast as possible, or should we limit this to a particular number of"
v.1.2.2,frames per second?
v.1.2.2,"UAirBlueprintLib::LogMessage(TEXT(""Stopped recording thread""), TEXT(""""), LogDebugLevel::Success);"
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,decide which derived BP to use
v.1.2.2,we don't have real vehicle so no vehicle API
v.1.2.2,put camera little bit above vehicle
v.1.2.2,update ground level
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,let base class setup physics world
v.1.2.2,stop physics thread before we dismantle
v.1.2.2,setup clock in ClockFactory
v.1.2.2,scalable clock returns interval same as wall clock but multiplied by a scale factor
v.1.2.2,steppable clock returns interval that is a constant number irrespective of wall clock
v.1.2.2,we can either multiply this fixed interval by scale factor to speed up/down the clock
v.1.2.2,but that would cause vehicles like quadrotors to become unstable
v.1.2.2,so alternative we use here is instead to scale control loop frequency. The downside is that
v.1.2.2,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v.1.2.2,get increase in clock speed
v.1.2.2,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v.1.2.2,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v.1.2.2,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v.1.2.2,Approach 2: scale control loop frequency if clock is speeded up
v.1.2.2,"for slowing down, this don't generate instability"
v.1.2.2,-------------------------------- overrides -----------------------------------------------//
v.1.2.2,decide which derived BP to use
v.1.2.2,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v.1.2.2,vehicle_sim_api->reset();
v.1.2.2,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v.1.2.2,create vehicle API
v.1.2.2,setup physics vehicle
v.1.2.2,initialize private vars
v.1.2.2,calls to update* are handled by physics engine and in SimModeWorldBase
v.1.2.2,"Utils::log(""------Render tick-------"");"
v.1.2.2,"if reset is pending then do it first, no need to do other things until next tick"
v.1.2.2,move collision info from rendering engine to vehicle
v.1.2.2,update rotor poses
v.1.2.2,if we did reset then don't worry about synchronizing states for this tick
v.1.2.2,Continue to wait for reset
v.1.2.2,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v.1.2.2,*** Start: UpdatableState implementation ***//
v.1.2.2,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v.1.2.2,environment update for current position
v.1.2.2,update forces on vertices
v.1.2.2,update to controller must be done after kinematics have been updated by physics engine
v.1.2.2,*** End: UpdatableState implementation ***//
v.1.2.2,get references of existing camera
v.1.2.2,setup clock in PhysX
v.1.2.2,-------------------------------- overrides -----------------------------------------------//
v.1.2.2,decide which derived BP to use
v.1.2.2,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v.1.2.2,Setup suspension forces
v.1.2.2,Find the tire object and set the data for it
v.1.2.2,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v.1.2.2,Setup suspension forces
v.1.2.2,Find the tire object and set the data for it
v.1.2.2,Create In-Car camera component
v.1.2.2,In car HUD
v.1.2.2,Create text render component for in car speed display
v.1.2.2,Create text render component for in car gear display
v.1.2.2,Setup the audio component and allocate it a sound cue
v.1.2.2,Colors for the in-car gear display. One for normal one for reverse
v.1.2.2,Wheels/Tires
v.1.2.2,Setup the wheels
v.1.2.2,Adjust the tire loading
v.1.2.2,Engine
v.1.2.2,Torque setup
v.1.2.2,Adjust the steering
v.1.2.2,Transmission
v.1.2.2,We want 4wd
v.1.2.2,Drive the front wheels a little more than the rear
v.1.2.2,Automatic gearbox
v.1.2.2,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v.1.2.2,Physics settings
v.1.2.2,Adjust the center of mass - the buggy is quite low
v.1.2.2,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v.1.2.2,put camera little bit above vehicle
v.1.2.2,update physics material
v.1.2.2,Update the strings used in the HUD (in-car and on-screen)
v.1.2.2,Set the string in the in-car HUD
v.1.2.2,Pass the engine RPM to the sound component
v.1.2.2,Start an engine sound playing
v.1.2.2,Using FText because this is display text that should be localizable
v.1.2.2,Setup the text render component strings
v.1.2.2,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v.1.2.2,below is not needed
v.1.2.2,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v.1.2.2,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v.1.2.2,TODO: should do reset() here?
v.1.2.2,create vehicle params
v.1.2.2,these are called on render ticks
v.1.2.2,TODO: do we need this for cars?
v.1.2.2,TODO: move this to SimModeBase?
v.1.2.2,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v.1.2.2,reset();
v.1.2.2,return;
v.1.2.2,}
v.1.2.2,Thrustmaster devices
v.1.2.2,"Anything else, typically Logitech G920 wheel"
v.1.2.2,Two steel levers behind wheel
v.1.2.2,if API-client control is not active then we route keyboard/joystick control to car
v.1.2.2,all car controls from anywhere must be routed through API component
v.1.2.2,*** Start: UpdatableState implementation ***//
v.1.2.2,physics tick
v.1.2.2,*** End: UpdatableState implementation ***//
v.1.2.2,TODO: implement arming for car
v.1.2.2,TODO: directly accept getVehicleSimApis() using generic container
v.1.2.2,remove everything that we created in BeginPlay
v.1.2.2,we use custom debug reporting for this class
v.1.2.2,perform any expensive rendering update outside of lock region
v.1.2.2,no need to call base reset because of our custom implementation
v.1.2.2,TODO: this is going to cause circular references which is fine here but
v.1.2.2,in future we should consider moving SimMode not derived from AActor and move
v.1.2.2,it to AirLib and directly implement WorldSimApiBase interface
v.1.2.2,get player start
v.1.2.2,this must be done from within actor otherwise we don't get player start
v.1.2.2,UWeatherLib::showWeatherMenu(World);
v.1.2.2,else don't init
v.1.2.2,"this is a bit odd but given how advanceTimeOfDay() works currently,"
v.1.2.2,tod_sim_clock_start_ needs to be reset here.
v.1.2.2,Going from enabled to disabled
v.1.2.2,do these in the end to ensure that advanceTimeOfDay() doesn't see
v.1.2.2,any inconsistent state.
v.1.2.2,should be overridden by derived class
v.1.2.2,should be overridden by derived class
v.1.2.2,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v.1.2.2,default setup - this should be overridden in derived modes as needed
v.1.2.2,setup clock in ClockFactory
v.1.2.2,default implementation
v.1.2.2,create director
v.1.2.2,create external camera required for the director
v.1.2.2,API server start/stop
v.1.2.2,get UU origin of global NED frame
v.1.2.2,determine camera director camera default pose and spawn it
v.1.2.2,find all vehicle pawns
v.1.2.2,add vehicles from settings
v.1.2.2,if vehicle is of type for derived SimMode and auto creatable
v.1.2.2,compute initial pose
v.1.2.2,spawn vehicle pawn
v.1.2.2,create API objects for each pawn we have
v.1.2.2,create vehicle sim api
v.1.2.2,TODO: better handle no FPV vehicles scenario
v.1.2.2,derived class should override this method to retrieve types of pawns they support
v.1.2.2,derived class should override this method to retrieve types of pawns they support
v.1.2.2,derived class should override this method to retrieve types of pawns they support
v.1.2.2,derived class should override this method to retrieve types of pawns they support
v.1.2.2,derived class should override this method to retrieve types of pawns they support
v.1.2.2,derived class should override this method to retrieve types of pawns they support
v.1.2.2,derived class should override this method to retrieve types of pawns they support
v.1.2.2,Draws debug-points on main viewport for Lidar laser hits.
v.1.2.2,Used for debugging only.
v.1.2.2,Currently we are checking the sensor-collection instead of sensor-settings.
v.1.2.2,Also using variables to optimize not checking the collection if not needed.
v.1.2.2,TODO: Is it incorrect to assume LidarSimple here?
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,ctor
v.1.2.2,initializes information based on lidar configuration
v.1.2.2,calculate verticle angle distance between each laser
v.1.2.2,store vertical angles for each laser
v.1.2.2,returns a point-cloud for the tick
v.1.2.2,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v.1.2.2,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v.1.2.2,calculate number of points needed for each laser/channel
v.1.2.2,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v.1.2.2,calculate needed angle/distance between each point
v.1.2.2,normalize FOV start/end
v.1.2.2,shoot lasers
v.1.2.2,check if the laser is outside the requested horizontal FOV
v.1.2.2,"shoot laser and get the impact point, if any"
v.1.2.2,simulate shooting a laser via Unreal ray-tracing.
v.1.2.2,start position
v.1.2.2,We need to compose rotations here rather than rotate a vector by a quaternion
v.1.2.2,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v.1.2.2,get ray quaternion in lidar frame (angles must be in radians)
v.1.2.2,get ray quaternion in body frame
v.1.2.2,get ray quaternion in world frame
v.1.2.2,get ray vector (end position)
v.1.2.2,Debug code for very specific cases.
v.1.2.2,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v.1.2.2,decide the frame for the point-cloud
v.1.2.2,current detault behavior; though it is probably not very useful.
v.1.2.2,not changing the default for now to maintain backwards-compat.
v.1.2.2,point in vehicle intertial frame
v.1.2.2,tranform to lidar frame
v.1.2.2,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v.1.2.2,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v.1.2.2,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v.1.2.2,"On the client side, if it is needed to transform this data back to the world frame,"
v.1.2.2,"then do the equivalent of following,"
v.1.2.2,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v.1.2.2,See SimModeBase::drawLidarDebugPoints()
v.1.2.2,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v.1.2.2,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,update ray tracing
v.1.2.2,"FString hit_name = FString(""None"");"
v.1.2.2,if (dist_hit.GetActor())
v.1.2.2,hit_name=dist_hit.GetActor()->GetName();
v.1.2.2,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v.1.2.2,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,This assumes you are running DroneServer already on the same machine.
v.1.2.2,DroneServer must be running first.
v.1.2.2,enable API control
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,move commands
v.1.2.2,else leave as it is
v.1.2.2,TODO: get these in one call
v.1.2.2,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v.1.2.2,TODO: shouldn't we pass folder path?
v.1.2.2,parse
v.1.2.2,group the images by the current date.
v.1.2.2,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v.1.2.2,{
v.1.2.2,"return """";"
v.1.2.2,}
v.1.2.2,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v.1.2.2,{
v.1.2.2,return false;
v.1.2.2,}
v.1.2.2,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v.1.2.2,params.context->client.newTask();
v.1.2.2,}
v.1.2.2,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v.1.2.2,params.context->client.WaitForCompletion(0);
v.1.2.2,}
v.1.2.2,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v.1.2.2,{
v.1.2.2,}
v.1.2.2,parse command line
v.1.2.2,Shell callbacks
v.1.2.2,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v.1.2.2,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v.1.2.2,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v.1.2.2,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v.1.2.2,Add shell commands
v.1.2.2,TODO: add WaitForCompletion command
v.1.2.2,"TODO: add command line args help, arg count validation"
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,"<< ""magnetometer_data.magnetic_field_covariance"" << magnetometer_data.magnetic_field_covariance // not implemented in sensor"
v.1.2.2,switch to explicit hover mode so that this is the fall back when
v.1.2.2,move* commands are finished.
v.1.2.2,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v.1.2.2,TODO: implement weather for Unity
v.1.2.2,TODO: implement weather for Unity
v.1.2.2,"Not implemented, just added for compilation."
v.1.2.2,Function pointers to hold the addresses of the functions that are defined in Unity
v.1.2.2,"Enabling all LogLevels,"
v.1.2.2,"Enabling all LogLevels,"
v.1.2.2,delete ltm;
v.1.2.2,initialize state
v.1.2.2,compute our home point
v.1.2.2,default behavior is to call update every tick
v.1.2.2,"for custom physics engine, this method should be overridden and update should be"
v.1.2.2,called from every physics tick
v.1.2.2,these will be available for devices like steering wheels
v.1.2.2,sync environment from kinematics
v.1.2.2,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v.1.2.2,FVector unrealPosition = getUUPosition();
v.1.2.2,"reporter.writeValue(""unreal pos"", Vector3r(unrealPosition.X, unrealPosition.Y, unrealPosition.Z));"
v.1.2.2,parameters in NED frame
v.1.2.2,allow teleportation
v.1.2.2,if collisions are not enabled
v.1.2.2,or we have collided but passthrough is enabled
v.1.2.2,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v.1.2.2,"without flip flopping, collisions can't be detected"
v.1.2.2,by default we update kinematics from UE pawn
v.1.2.2,if SimMod uses its own physics engine then this should be overriden
v.1.2.2,no default action in this base class
v.1.2.2,TODO: because this bug we are using alternative code with stringstream
v.1.2.2,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v.1.2.2,update kinematics from pawn's movement instead of physics engine
v.1.2.2,TODO: update other fields?
v.1.2.2,implements getImages() method in the ImageCaptureBase class.
v.1.2.2,update ray tracing
v.1.2.2,TODO: index check
v.1.2.2,Attempts to parse the settings text from one of multiple locations.
v.1.2.2,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v.1.2.2,"Next, check the executable's working directory for the settings file."
v.1.2.2,"Finally, check the user's documents folder."
v.1.2.2,"If the settings file cannot be read, throw an exception"
v.1.2.2,let base class setup physics world
v.1.2.2,stop physics thread before we dismantle
v.1.2.2,setup clock in ClockFactory
v.1.2.2,scalable clock returns interval same as wall clock but multiplied by a scale factor
v.1.2.2,steppable clock returns interval that is a constant number irrespective of wall clock
v.1.2.2,we can either multiply this fixed interval by scale factor to speed up/down the clock
v.1.2.2,but that would cause vehicles like quadrotors to become unstable
v.1.2.2,so alternative we use here is instead to scale control loop frequency. The downside is that
v.1.2.2,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v.1.2.2,get increase in clock speed
v.1.2.2,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v.1.2.2,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v.1.2.2,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v.1.2.2,Approach 2: scale control loop frequency if clock is speeded up
v.1.2.2,"for slowing down, this don't generate instability"
v.1.2.2,-------------------------------- overrides -----------------------------------------------//
v.1.2.2,For multirotors the vehicle_sim_api are in PhysicsWOrld container and then get reseted when world gets reseted
v.1.2.2,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v.1.2.2,create vehicle API
v.1.2.2,setup physics vehicle
v.1.2.2,initialize private vars
v.1.2.2,"if reset is pending then do it first, no need to do other things until next tick"
v.1.2.2,move collision info from rendering engine to vehicle
v.1.2.2,update rotor poses
v.1.2.2,if we did reset then don't worry about synchronizing states for this tick
v.1.2.2,Continue to wait for reset
v.1.2.2,*** Start: UpdatableState implementation ***//
v.1.2.2,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v.1.2.2,environment update for current position
v.1.2.2,update forces on vertices
v.1.2.2,update to controller must be done after kinematics have been updated by physics engine
v.1.2.2,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v.1.2.2,AirSimPose pose = GetPose(getVehicleName().c_str());
v.1.2.2,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v.1.2.2,*** End: UpdatableState implementation ***//
v.1.2.2,TODO: should do reset() here?
v.1.2.2,these are called on render ticks
v.1.2.2,TODO: do we need this for cars?
v.1.2.2,Thrustmaster devices
v.1.2.2,"Anything else, typically Logitech G920 wheel"
v.1.2.2,Two steel levers behind wheel
v.1.2.2,if API-client control is not active then we route keyboard/joystick control to car
v.1.2.2,all car controls from anywhere must be routed through API component
v.1.2.2,*** Start: UpdatableState implementation ***//
v.1.2.2,physics tick
v.1.2.2,void CarPawnSimApi::reportState(StateReporter& reporter)
v.1.2.2,{
v.1.2.2,// report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v.1.2.2,AirSimPose pose = GetPose(getVehicleName().c_str());
v.1.2.2,"reporter.writeValue(""unreal pos"", Vector3r(pose.position.x, pose.position.y, pose.position.z));"
v.1.2.2,}
v.1.2.2,*** End: UpdatableState implementation ***//
v.1.2.2,TODO: implement arming for car
v.1.2.2,remove everything that we created in BeginPlay
v.1.2.2,we use custom debug reporting for this class
v.1.2.2,perform any expensive rendering update outside of lock region
v.1.2.2,no need to call base reset because of our custom implementation
v.1.2.2,should be overridden by derived class
v.1.2.2,should be overridden by derived class
v.1.2.2,commenting this out for now to avoid unintentional Unity startup failure
v.1.2.2,"throw std::domain_error(""setTimeOfDay is not implemented by SimMode"");"
v.1.2.2,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v.1.2.2,default setup - this should be overridden in derived modes as needed
v.1.2.2,setup clock in ClockFactory
v.1.2.2,API server start/stop
v.1.2.2,determine camera director camera default pose and spawn it
v.1.2.2,derived class should override this method to retrieve types of pawns they support
v.1.2.2,derived class should override this method to retrieve types of pawns they support
v.1.2.2,60 acres park:
v.1.2.2,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v.1.2.2,marymoore park
v.1.2.2,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v.1.2.2,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v.1.2.2,DepthNavThreshold depthNav;
v.1.2.2,DepthNavOptAStar depthNav;
v.1.2.2,DepthNavThreshold depthNav;
v.1.2.2,DepthNavOptAStar depthNav;
v.1.2.2,Cleanup
v.1.2.2,runDepthNavGT();
v.1.2.2,runDepthNavSGM();
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,by Sudipta Sinha
v.1.2.2,adapted for AirSim by Matthias Mueller
v.1.2.2,first row
v.1.2.2,last row
v.1.2.2,Local quadratic fit of cost and subpixel refinement.
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,by Sudipta Sinha
v.1.2.2,adapted for AirSim by Matthias Mueller
v.1.2.2,uint64_t x64 = (uint64_t)x;
v.1.2.2,uint64_t y64 = (uint64_t)y;
v.1.2.2,Copyright (c) Microsoft Corporation. All rights reserved.
v.1.2.2,Licensed under the MIT License.
v.1.2.2,by Sudipta Sinha
v.1.2.2,adapted for AirSim by Matthias Mueller
v.1.2.2,ensure that disparity range is a multiple of 8
v.1.2.2,sgm stereo
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,read settings and override defaults
v1.2.0Linux,allow json overrides on a per-vehicle basis.
v1.2.0Linux,start server in async mode
v1.2.0Linux,check messages
v1.2.0Linux,In settings.json first activate computer vision mode:
v1.2.0Linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.0Linux,monitor car state while you drive it manually.
v1.2.0Linux,In settings.json first activate computer vision mode:
v1.2.0Linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.0Linux,"define abstract class to return next vector in the format (x,y,yaw)"
v1.2.0Linux,"compute vector, distance and angle to goal"
v1.2.0Linux,compute box of interest
v1.2.0Linux,scale by weight matrix (optional)
v1.2.0Linux,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.2.0Linux,detect collision
v1.2.0Linux,compute box of interest
v1.2.0Linux,detect collision
v1.2.0Linux,Same as above but decide to go left or right based on average or some metric like that
v1.2.0Linux,"compute resultant normalized vector, distance and angle"
v1.2.0Linux,compute bounding box size
v1.2.0Linux,convert horizonal fov to vertical fov
v1.2.0Linux,matrix with all ones
v1.2.0Linux,matrix with max weight in center and decreasing linearly with distance from center
v1.2.0Linux,matrix with max weight in center and decreasing quadratically with distance from center
v1.2.0Linux,"print (""Saving images to %s"" % tmp_dir)"
v1.2.0Linux,airsim.wait_key('Press any key to start')
v1.2.0Linux,"Define start position, goal and size of UAV"
v1.2.0Linux,Define parameters and thresholds
v1.2.0Linux,initial position
v1.2.0Linux,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.2.0Linux,time.sleep(1)
v1.2.0Linux,get response
v1.2.0Linux,get numpy array
v1.2.0Linux,reshape array to 2D array H X W
v1.2.0Linux,write to png
v1.2.0Linux,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.2.0Linux,pose = client.simGetPose()
v1.2.0Linux,pp.pprint(pose)
v1.2.0Linux,time.sleep(5)
v1.2.0Linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.2.0Linux,################### OLD CODE
v1.2.0Linux,timer = 0
v1.2.0Linux,time_obs = 50
v1.2.0Linux,bObstacle = False
v1.2.0Linux,if (bObstacle):
v1.2.0Linux,timer = timer + 1
v1.2.0Linux,if timer > time_obs:
v1.2.0Linux,bObstacle = False
v1.2.0Linux,timer = 0
v1.2.0Linux,else:
v1.2.0Linux,yaw = target_angle
v1.2.0Linux,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.2.0Linux,if (np.average(img2d_box) < coll_thres):
v1.2.0Linux,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.2.0Linux,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.2.0Linux,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.2.0Linux,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.2.0Linux,"print('left: ', img2d_box_l_avg)"
v1.2.0Linux,"print('right: ', img2d_box_r_avg)"
v1.2.0Linux,if img2d_box_l_avg > img2d_box_r_avg:
v1.2.0Linux,##Go LEFT
v1.2.0Linux,#y_offset = y_offset-1
v1.2.0Linux,yaw = yaw - radians(10)
v1.2.0Linux,bObstacle = True
v1.2.0Linux,else:
v1.2.0Linux,##Go RIGHT
v1.2.0Linux,#y_offset = y_offset+1
v1.2.0Linux,yaw = yaw + radians(10)
v1.2.0Linux,bObstacle = true
v1.2.0Linux,"print('yaw: ', yaw)"
v1.2.0Linux,In settings.json first activate computer vision mode:
v1.2.0Linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.0Linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.2.0Linux,In settings.json first activate computer vision mode:
v1.2.0Linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.0Linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.2.0Linux,pip install opencv-python
v1.2.0Linux,In settings.json first activate computer vision mode:
v1.2.0Linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.0Linux,for block environment
v1.2.0Linux,regex are case insensitive
v1.2.0Linux,#for neighborhood environment
v1.2.0Linux,set object ID for sky
v1.2.0Linux,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.2.0Linux,get segmentation image in various formats
v1.2.0Linux,save segmentation images in various formats
v1.2.0Linux,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.2.0Linux,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.2.0Linux,"airsim.write_png(os.path.normpath(filename + '.numpy.png'), img_rgba) #write to png"
v1.2.0Linux,find unique colors
v1.2.0Linux,In settings.json first activate computer vision mode:
v1.2.0Linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.0Linux,objects can be named in two ways:
v1.2.0Linux,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.2.0Linux,default name is auto-generated and varies from run-to-run.
v1.2.0Linux,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.2.0Linux,
v1.2.0Linux,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.2.0Linux,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.2.0Linux,https://answers.unrealengine.com/revisions/790629.html
v1.2.0Linux,below works in Blocks environment
v1.2.0Linux,------------------------------------ Get current pose ------------------------------------------------
v1.2.0Linux,search object by name:
v1.2.0Linux,search another object by tag
v1.2.0Linux,search non-existent object
v1.2.0Linux,------------------------------------ Set new pose ------------------------------------------------
v1.2.0Linux,here we move with teleport enabled so collisions are ignored
v1.2.0Linux,here we move with teleport enabled so collisions are not ignored
v1.2.0Linux,move non-existent object
v1.2.0Linux,------------------------------------ Get new pose ------------------------------------------------
v1.2.0Linux,search another object by tag
v1.2.0Linux,search non-existent object
v1.2.0Linux,Import this module to automatically setup path to local airsim module
v1.2.0Linux,This module first tries to see if airsim module is installed via pip
v1.2.0Linux,If it does then we don't do anything else
v1.2.0Linux,Else we look up grand-parent folder to see if it has airsim folder
v1.2.0Linux,and if it does then we add that in sys.path
v1.2.0Linux,this class simply tries to see if airsim
v1.2.0Linux,if airsim module is installed then don't do anything else
v1.2.0Linux,import pkgutil
v1.2.0Linux,airsim_loader = pkgutil.find_loader('airsim')
v1.2.0Linux,if airsim_loader is not None:
v1.2.0Linux,return
v1.2.0Linux,This script expects object available in UE environment of type AAirSimCharater
v1.2.0Linux,In settings.json first activate computer vision mode:
v1.2.0Linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.0Linux,airsim.wait_key('Press any key to set face expression')
v1.2.0Linux,"client.simCharSetFaceExpression(""BlendShapeNode_Smile"", 1);"
v1.2.0Linux,In settings.json first activate computer vision mode:
v1.2.0Linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.0Linux,xn = 1 + x*5  # some random number
v1.2.0Linux,currently reset() doesn't work in CV mode. Below is the workaround
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,monitor car state while you drive it manually.
v1.2.0Linux,get state of the car
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,go forward
v1.2.0Linux,get state of the car
v1.2.0Linux,import gym #pip install gym
v1.2.0Linux,Local variable access is faster in loops
v1.2.0Linux,"if not wrapping over current pointer,"
v1.2.0Linux,then check if there is terminal state wrapped inside
v1.2.0Linux,"If index > history_length, take from a slice"
v1.2.0Linux,Metrics accumulator
v1.2.0Linux,Action Value model (used by agent to interact with the environment)
v1.2.0Linux,"Target model used to compute the target Q-values in training, updated"
v1.2.0Linux,less frequently for increased stability.
v1.2.0Linux,Function computing Q-values targets as part of the computation graph
v1.2.0Linux,"Define the loss, using Huber Loss (more robust to outliers)"
v1.2.0Linux,Compute the q_targets
v1.2.0Linux,actions is a 1-hot encoding of the action done by the agent
v1.2.0Linux,Define training criterion as the Huber Loss function
v1.2.0Linux,Adam based SGD
v1.2.0Linux,self._trainer.restore_from_checkpoint('models/oldmodels/model800000')
v1.2.0Linux,Append the state to the short term memory (ie. History)
v1.2.0Linux,"If policy requires agent to explore, sample random action"
v1.2.0Linux,Use the network to output the best action
v1.2.0Linux,Append batch axis with only one sample to evaluate
v1.2.0Linux,Return the value maximizing the expected reward
v1.2.0Linux,Keep track of interval action counter
v1.2.0Linux,"If done, reset short term memory (ie. History)"
v1.2.0Linux,Plot the metrics through Tensorboard and reset buffers
v1.2.0Linux,Reset the short term memory
v1.2.0Linux,Append to long term memory
v1.2.0Linux,Update the Target Network if needed
v1.2.0Linux,print(dist)
v1.2.0Linux,Make RL agent
v1.2.0Linux,Train
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,get state of the car
v1.2.0Linux,go forward
v1.2.0Linux,Go forward + steer right
v1.2.0Linux,go reverse
v1.2.0Linux,apply brakes
v1.2.0Linux,get camera images from the car
v1.2.0Linux,restore to original state
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,go forward
v1.2.0Linux,Python client example to get Lidar data from a car
v1.2.0Linux,
v1.2.0Linux,Makes the drone fly and get Lidar data
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,"print(""state: %s"" % s)"
v1.2.0Linux,go forward
v1.2.0Linux,Go forward + steer right
v1.2.0Linux,"reshape array of floats to array of [X,Y,Z]"
v1.2.0Linux,TODO
v1.2.0Linux,main
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,get state of the car
v1.2.0Linux,go forward
v1.2.0Linux,Go forward + steer right
v1.2.0Linux,go reverse
v1.2.0Linux,apply breaks
v1.2.0Linux,restore to original state
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,get camera images from the car
v1.2.0Linux,that's enough fun for now. let's quit cleanly
v1.2.0Linux,Import this module to automatically setup path to local airsim module
v1.2.0Linux,This module first tries to see if airsim module is installed via pip
v1.2.0Linux,If it does then we don't do anything else
v1.2.0Linux,Else we look up grand-parent folder to see if it has airsim folder
v1.2.0Linux,and if it does then we add that in sys.path
v1.2.0Linux,this class simply tries to see if airsim
v1.2.0Linux,if airsim module is installed then don't do anything else
v1.2.0Linux,import pkgutil
v1.2.0Linux,airsim_loader = pkgutil.find_loader('airsim')
v1.2.0Linux,if airsim_loader is not None:
v1.2.0Linux,return
v1.2.0Linux,Use below in settings.json with blocks environment
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,get state of the car
v1.2.0Linux,go forward
v1.2.0Linux,go reverse
v1.2.0Linux,apply breaks
v1.2.0Linux,get camera images from the car
v1.2.0Linux,restore to original state
v1.2.0Linux,from keras.models import load_model
v1.2.0Linux,if (len(sys.argv) != 2):
v1.2.0Linux,print('usage: python drive.py <modelName>')
v1.2.0Linux,sys.exit()
v1.2.0Linux,print('Loading model...')
v1.2.0Linux,model = load_model(sys.argv[1])
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,image_buf[0] = get_image()
v1.2.0Linux,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.2.0Linux,"model_output = model.predict([image_buf, state_buf])"
v1.2.0Linux,car_controls.steering = float(model_output[0][0])
v1.2.0Linux,!/usr/bin/env python
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,start = time.time()
v1.2.0Linux,get state of the car
v1.2.0Linux,milliseconds = (time.time() - start) * 1000
v1.2.0Linux,populate PoseStamped ros message
v1.2.0Linux,log PoseStamped message
v1.2.0Linux,publish PoseStamped message
v1.2.0Linux,sleeps until next cycle
v1.2.0Linux,!/usr/bin/env python
v1.2.0Linux,Example ROS node for publishing AirSim images.
v1.2.0Linux,AirSim Python API
v1.2.0Linux,ROS Image message
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,get camera images from the car
v1.2.0Linux,Populate image message
v1.2.0Linux,log time and size of published image
v1.2.0Linux,publish image message
v1.2.0Linux,sleep until next cycle
v1.2.0Linux,!/usr/bin/env python
v1.2.0Linux,Example ROS node for publishing AirSim images.
v1.2.0Linux,ROS Image message
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,get camera images from the car
v1.2.0Linux,Populate image message
v1.2.0Linux,log time and size of published image
v1.2.0Linux,publish image message
v1.2.0Linux,sleep until next cycle
v1.2.0Linux,Import this module to automatically setup path to local airsim module
v1.2.0Linux,This module first tries to see if airsim module is installed via pip
v1.2.0Linux,If it does then we don't do anything else
v1.2.0Linux,Else we look up grand-parent folder to see if it has airsim folder
v1.2.0Linux,and if it does then we add that in sys.path
v1.2.0Linux,this class simply tries to see if airsim
v1.2.0Linux,if airsim module is installed then don't do anything else
v1.2.0Linux,import pkgutil
v1.2.0Linux,airsim_loader = pkgutil.find_loader('airsim')
v1.2.0Linux,if airsim_loader is not None:
v1.2.0Linux,return
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,MultirotorClient.wait_key('Press any key to takeoff')
v1.2.0Linux,Local variable access is faster in loops
v1.2.0Linux,"if not wrapping over current pointer,"
v1.2.0Linux,then check if there is terminal state wrapped inside
v1.2.0Linux,"If index > history_length, take from a slice"
v1.2.0Linux,Metrics accumulator
v1.2.0Linux,Action Value model (used by agent to interact with the environment)
v1.2.0Linux,"Target model used to compute the target Q-values in training, updated"
v1.2.0Linux,less frequently for increased stability.
v1.2.0Linux,Function computing Q-values targets as part of the computation graph
v1.2.0Linux,"Define the loss, using Huber Loss (more robust to outliers)"
v1.2.0Linux,Compute the q_targets
v1.2.0Linux,actions is a 1-hot encoding of the action done by the agent
v1.2.0Linux,Define training criterion as the Huber Loss function
v1.2.0Linux,Adam based SGD
v1.2.0Linux,Append the state to the short term memory (ie. History)
v1.2.0Linux,"If policy requires agent to explore, sample random action"
v1.2.0Linux,Use the network to output the best action
v1.2.0Linux,Append batch axis with only one sample to evaluate
v1.2.0Linux,Return the value maximizing the expected reward
v1.2.0Linux,Keep track of interval action counter
v1.2.0Linux,"If done, reset short term memory (ie. History)"
v1.2.0Linux,Plot the metrics through Tensorboard and reset buffers
v1.2.0Linux,Reset the short term memory
v1.2.0Linux,Append to long term memory
v1.2.0Linux,Update the Target Network if needed
v1.2.0Linux,print(dist)
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,Make RL agent
v1.2.0Linux,Train
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,get camera images from the car
v1.2.0Linux,that's enough fun for now. let's quit cleanly
v1.2.0Linux,use open cv to create point cloud from depth image.
v1.2.0Linux,###########################################
v1.2.0Linux,######### This is work in progress! #######
v1.2.0Linux,###########################################
v1.2.0Linux,file will be saved in PythonClient folder (i.e. same folder as script)
v1.2.0Linux,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.2.0Linux,skip it
v1.2.0Linux,AirSim uses NED coordinates so negative axis is up.
v1.2.0Linux,z of -7 is 7 meters above the original launch point.
v1.2.0Linux,Fly given velocity vector for 5 seconds
v1.2.0Linux,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.2.0Linux,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.2.0Linux,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.2.0Linux,Make the drone fly in a circle.
v1.2.0Linux,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.2.0Linux,check that our home position is stable
v1.2.0Linux,AirSim uses NED coordinates so negative axis is up.
v1.2.0Linux,ramp up time
v1.2.0Linux,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.2.0Linux,compute current angle
v1.2.0Linux,compute lookahead
v1.2.0Linux,if we did the takeoff then also do the landing.
v1.2.0Linux,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.2.0Linux,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.2.0Linux,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.2.0Linux,ignore the click over from 360 back to 0
v1.2.0Linux,watch direction this diff is moving if it switches from shrinking to growing
v1.2.0Linux,then we passed the starting point.
v1.2.0Linux,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.2.0Linux,AirSim uses NED coordinates so negative axis is up.
v1.2.0Linux,z of -7 is 7 meters above the original launch point.
v1.2.0Linux,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.2.0Linux,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.2.0Linux,change clock speed in settings.json
v1.2.0Linux,"""ClockSpeed"": 0.5"
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,that's enough fun for now. let's quit cleanly
v1.2.0Linux,In settings.json first activate computer vision mode:
v1.2.0Linux,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.0Linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.2.0Linux,pip install opencv-python
v1.2.0Linux,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.2.0Linux,Python client example to get Lidar data from a drone
v1.2.0Linux,
v1.2.0Linux,Makes the drone fly and get Lidar data
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,"print(""state: %s"" % s)"
v1.2.0Linux,"print(""state: %s"" % pprint.pformat(state))"
v1.2.0Linux,"reshape array of floats to array of [X,Y,Z]"
v1.2.0Linux,TODO
v1.2.0Linux,main
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,AirSim uses NED coordinates so negative axis is up.
v1.2.0Linux,let it settle there a bit.
v1.2.0Linux,now compute the survey path required to fill the box
v1.2.0Linux,Use below in settings.json with Blocks environment
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,get camera images from the car
v1.2.0Linux,that's enough fun for now. let's quit cleanly
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,Import this module to automatically setup path to local airsim module
v1.2.0Linux,This module first tries to see if airsim module is installed via pip
v1.2.0Linux,If it does then we don't do anything else
v1.2.0Linux,Else we look up grand-parent folder to see if it has airsim folder
v1.2.0Linux,and if it does then we add that in sys.path
v1.2.0Linux,this class simply tries to see if airsim
v1.2.0Linux,if airsim module is installed then don't do anything else
v1.2.0Linux,import pkgutil
v1.2.0Linux,airsim_loader = pkgutil.find_loader('airsim')
v1.2.0Linux,if airsim_loader is not None:
v1.2.0Linux,return
v1.2.0Linux,"this script moves the drone to a location, then rests it thousands of time"
v1.2.0Linux,purpose of this script is to stress test reset API
v1.2.0Linux,connect to the AirSim simulator
v1.2.0Linux,that's enough fun for now. let's quite cleanly
v1.2.0Linux,use open cv to show new images from AirSim
v1.2.0Linux,requires Python 3.5.3 :: Anaconda 4.4.0
v1.2.0Linux,pip install opencv-python
v1.2.0Linux,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.2.0Linux,get depth image
v1.2.0Linux,"this will return png width= 256, height= 144"
v1.2.0Linux,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.2.0Linux,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.2.0Linux,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.2.0Linux,to get an estimate of distance.
v1.2.0Linux,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.2.0Linux,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.2.0Linux,an angular delta of the following pi/10.
v1.2.0Linux,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.2.0Linux,Remove alpha channel if exists
v1.2.0Linux,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.2.0Linux,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.2.0Linux,Flatten and yield as tuple
v1.2.0Linux,Initialize a resizable dataset to hold the output
v1.2.0Linux,Resize the dataset to accommodate the next chunk of rows
v1.2.0Linux,Create the next chunk
v1.2.0Linux,Increment the row count
v1.2.0Linux,Arguments
v1.2.0Linux,Returns
v1.2.0Linux,use composition of homographies
v1.2.0Linux,to generate final transform that needs to be applied
v1.2.0Linux,Arguments
v1.2.0Linux,Returns
v1.2.0Linux,Keeps under lock only the mechanism which advances
v1.2.0Linux,the indexing of each batch.
v1.2.0Linux,The transformation of images is not under thread lock
v1.2.0Linux,so it can be done in parallel
v1.2.0Linux,Trained model path
v1.2.0Linux,Connect to AirSim
v1.2.0Linux,Start driving
v1.2.0Linux,Initialize image buffer
v1.2.0Linux,Update throttle value according to steering angle
v1.2.0Linux,Prediction
v1.2.0Linux,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.2.0Linux,Print progress
v1.2.0Linux,Update next car state
v1.2.0Linux,Wait a bit between iterations
v1.2.0Linux,%matplotlib inline
v1.2.0Linux,chunk size for training batches
v1.2.0Linux,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.2.0Linux,Point this to the directory containing the raw data
v1.2.0Linux,Point this to the desired output directory for the cooked (.h5) data
v1.2.0Linux,Choose The folders to search for data under RAW_DATA_DIR
v1.2.0Linux,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.2.0Linux,data_folder.append('folder_name1')
v1.2.0Linux,data_folder.append('folder_name2')
v1.2.0Linux,...
v1.2.0Linux,Hyper-parameters
v1.2.0Linux,Activation functions
v1.2.0Linux,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.2.0Linux,<< The directory containing the cooked data from the previous step >>
v1.2.0Linux,<< The directory in which the model output will be placed >>
v1.2.0Linux,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.2.0Linux,Network definition
v1.2.0Linux,Import this module to automatically setup path to local airsim module
v1.2.0Linux,This module first tries to see if airsim module is installed via pip
v1.2.0Linux,If it does then we don't do anything else
v1.2.0Linux,Else we look up grand-parent folder to see if it has airsim folder
v1.2.0Linux,and if it does then we add that in sys.path
v1.2.0Linux,this class simply tries to see if airsim
v1.2.0Linux,if airsim module is installed then don't do anything else
v1.2.0Linux,import pkgutil
v1.2.0Linux,airsim_loader = pkgutil.find_loader('airsim')
v1.2.0Linux,if airsim_loader is not None:
v1.2.0Linux,return
v1.2.0Linux,DEY: I don't know why this was there.
v1.2.0Linux,data = np.flipud(data)
v1.2.0Linux,-----------------------------------  Common vehicle APIs ---------------------------------------------
v1.2.0Linux,basic flight control
v1.2.0Linux,camera control
v1.2.0Linux,simGetImage returns compressed png in array of bytes
v1.2.0Linux,image_type uses one of the ImageType members
v1.2.0Linux,"todo: in future remove below, it's only for compatibility to pre v1.2"
v1.2.0Linux,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.2.0Linux,camera control
v1.2.0Linux,simGetImage returns compressed png in array of bytes
v1.2.0Linux,image_type uses one of the ImageType members
v1.2.0Linux,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.2.0Linux,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.2.0Linux,lidar APIs
v1.2.0Linux,----------- APIs to control ACharacter in scene ----------/
v1.2.0Linux,legacy handling
v1.2.0Linux,TODO: remove below legacy wrappers in future major releases
v1.2.0Linux,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.2.0Linux,APIs for control
v1.2.0Linux,query vehicle state
v1.2.0Linux,-----------------------------------  Car APIs ---------------------------------------------
v1.2.0Linux,helper method for converting getOrientation to roll/pitch/yaw
v1.2.0Linux,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.2.0Linux,roll (x-axis rotation)
v1.2.0Linux,pitch (y-axis rotation)
v1.2.0Linux,yaw (z-axis rotation)
v1.2.0Linux,DEY: I don't know why this was there.
v1.2.0Linux,data = np.flipud(data)
v1.2.0Linux,reverse the vertical line order and add null bytes at the start
v1.2.0Linux,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.2.0Linux,return cls(**msgpack.unpack(encoded))
v1.2.0Linux,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.2.0Linux,"in header only mode, control library is not available"
v1.2.0Linux,if using Unreal Build system then include precompiled header file first
v1.2.0Linux,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.2.0Linux,"Windows, OSX and Linux."
v1.2.0Linux,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.2.0Linux,Windows users can move the Documents folder to any location they want
v1.2.0Linux,SHGetFolderPath knows how to find it.
v1.2.0Linux,fall back in case SHGetFolderPath failed for some reason.
v1.2.0Linux,convert from std::path '/' to windows backslash.
v1.2.0Linux,make the current thread run with maximum priority.
v1.2.0Linux,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.2.0Linux,TODO: How to handle POSIX thread priorities on OSX?
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.2.0Linux,
v1.2.0Linux,Treat all errors as failure conditions.
v1.2.0Linux,parse command line
v1.2.0Linux,"motive gives a weird error if the project is not found, so we look for it."
v1.2.0Linux,Do an update to pick up any recently-arrived cameras.
v1.2.0Linux,List all detected cameras.
v1.2.0Linux,List all defined rigid bodies.
v1.2.0Linux,throttle to 50 messages per second.
v1.2.0Linux,OptiTrack uses 'y' axis for vertical.
v1.2.0Linux,stdafx.cpp : source file that includes just the standard includes
v1.2.0Linux,MavlinkMoCap.pch will be the pre-compiled header
v1.2.0Linux,stdafx.obj will contain the pre-compiled type information
v1.2.0Linux,TODO: reference any additional headers you need in STDAFX.H
v1.2.0Linux,and not in this file
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,PX4.cpp : Defines the entry point for the console application.
v1.2.0Linux,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.2.0Linux,how do you write to the debug output windows on Unix ?
v1.2.0Linux,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.2.0Linux,connection to create to talke to that server.
v1.2.0Linux,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.2.0Linux,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.2.0Linux,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.2.0Linux,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.2.0Linux,using their the -qgc option.
v1.2.0Linux,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.2.0Linux,this switch controls whether we turn off the RC remote active link loss detection
v1.2.0Linux,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.2.0Linux,from kicking in when you try and fly.
v1.2.0Linux,can't use experimental stuff on Linux because of potential ABI issues
v1.2.0Linux,parse the json
v1.2.0Linux,flatten inner mavlink object
v1.2.0Linux,flatten inner mavlink object
v1.2.0Linux,todo
v1.2.0Linux,todo
v1.2.0Linux,"const char* outLogFileOption = ""outlogfile"";"
v1.2.0Linux,parse command line
v1.2.0Linux,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.2.0Linux,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.2.0Linux,"no local serial connection, so this is the primary droneConnection."
v1.2.0Linux,failed to connect
v1.2.0Linux,"local connection, then we own sending the heartbeat."
v1.2.0Linux,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.2.0Linux,cmdTable.push_back(new AltHoldCommand());
v1.2.0Linux,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.2.0Linux,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.2.0Linux,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.2.0Linux,this stops us from being able to connect to SITL mode PX4.
v1.2.0Linux,checkPulse();
v1.2.0Linux,add command text in log
v1.2.0Linux,close previous command.
v1.2.0Linux,FilterLogFiles(logDirectory);
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,send a heartbeat
v1.2.0Linux,accept one incoming connection
v1.2.0Linux,send a heartbeat to the client
v1.2.0Linux,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.2.0Linux,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.2.0Linux,for this unit test we are expecting a request to send an image.
v1.2.0Linux,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.2.0Linux,hmmm
v1.2.0Linux,================ ls
v1.2.0Linux,================ put file
v1.2.0Linux,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.2.0Linux,================ get file
v1.2.0Linux,verify the file contents.
v1.2.0Linux,================ remove file
v1.2.0Linux,================ make directory
v1.2.0Linux,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.2.0Linux,================ remove directory
v1.2.0Linux,Now verification
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,from main.cpp.
v1.2.0Linux,you must call this method if you want HandleMessage to be called subsequently.
v1.2.0Linux,treat literals as one word
v1.2.0Linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.2.0Linux,request gps info
v1.2.0Linux,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.2.0Linux,find relative position since command start so we can compare two commands better
v1.2.0Linux,TODO: make below future proof (i.e. usable by C++17 compiler) - also change same in main.cpp
v1.2.0Linux,can't use experimental stuff on Linux because of potential ABI issues
v1.2.0Linux,"these PID values are important, so set these to match"
v1.2.0Linux,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.2.0Linux,we can skip ahead.
v1.2.0Linux,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.2.0Linux,TODO: avoid passing hadcoded HIL flag
v1.2.0Linux,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.2.0Linux,"The global position, as returned by the Global Positioning System (GPS)."
v1.2.0Linux,Provides state for additional features
v1.2.0Linux,The general system state
v1.2.0Linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.2.0Linux,Provides state for additional features
v1.2.0Linux,The general system state
v1.2.0Linux,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.2.0Linux,Provides state for additional features
v1.2.0Linux,The general system state
v1.2.0Linux,Provides state for additional features
v1.2.0Linux,The general system state
v1.2.0Linux,note: we do not reset com when Close() is called because we want to keep running.
v1.2.0Linux,"user has to invoke ""hil stop"" to stop the hil thread."
v1.2.0Linux,generate random between 0 and 1
v1.2.0Linux,move to range -1 to 1
v1.2.0Linux,scale it
v1.2.0Linux,apply iy
v1.2.0Linux,wait for the Execute method to be called.
v1.2.0Linux,gps is much slower frequency than IMU.
v1.2.0Linux,MAVLINK_MSG_ID_HIL_GPS
v1.2.0Linux,disable MAV_USEHILGPS
v1.2.0Linux,note: we do not reset com when Close() is called because we want to keep running.
v1.2.0Linux,"user has to invoke ""hil stop"" to stop the hil thread."
v1.2.0Linux,generate random between 0 and 1
v1.2.0Linux,move to range -1 to 1
v1.2.0Linux,scale it
v1.2.0Linux,apply iy
v1.2.0Linux,wait for the Execute method to be called.
v1.2.0Linux,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.2.0Linux,gps is much slower frequency than IMU.
v1.2.0Linux,MAVLINK_MSG_ID_HIL_GPS
v1.2.0Linux,disable HIL mode
v1.2.0Linux,Enumeration of landed detector states
v1.2.0Linux,MAV landed state is unknown
v1.2.0Linux,MAV is landed (on ground)
v1.2.0Linux,MAV is in air
v1.2.0Linux,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.2.0Linux,The filtered local position
v1.2.0Linux,must send these regularly to keep offboard control.
v1.2.0Linux,"ok, now we can safely switch to loiter."
v1.2.0Linux,must send these regularly to keep offboard control.
v1.2.0Linux,integrate the heading so it is smoother.
v1.2.0Linux,must send these regularly to keep offboard control.
v1.2.0Linux,integrate the heading so it is smoother.
v1.2.0Linux,fly to radius
v1.2.0Linux,it takes about 10 cm to stop and turn.
v1.2.0Linux,next time around switch to orbiting!
v1.2.0Linux,heading points to center of circle.
v1.2.0Linux,interpoloate the speed ramp up time over 2 seconds from start time
v1.2.0Linux,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.2.0Linux,monitor the sin curves so we can see how on track or off track it actually is.
v1.2.0Linux,the shape of the curve will also tell us if we are progressing at a consistent
v1.2.0Linux,"speed, the more deformed the sin curve the worse our progress."
v1.2.0Linux,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.2.0Linux,degrees just flipped from 359 to 0.
v1.2.0Linux,this enables us to test what happens when offboard control is lost and resumed.
v1.2.0Linux,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.2.0Linux,"ok, now we can start moving by velocity"
v1.2.0Linux,recompute to new target.
v1.2.0Linux,start by moving right with 10 degree roll.
v1.2.0Linux,haven't started yet.
v1.2.0Linux,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.2.0Linux,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.2.0Linux,track how our actual pitch is coming along compared to our target
v1.2.0Linux,and check position
v1.2.0Linux,the amount of pitch should depend on our speed in that direction.
v1.2.0Linux,passed the midpoint.
v1.2.0Linux,fade out the pitch as we pick up speed so we don't overshoot.
v1.2.0Linux,see if we just crossed the wiggle distance threshold.
v1.2.0Linux,(pitch affects the x-position).
v1.2.0Linux,reverse direction with a -30 degrees quick stop
v1.2.0Linux,reverse direction with a 30 degrees quick stop
v1.2.0Linux,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.2.0Linux,too much in that direction.
v1.2.0Linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.2.0Linux,track how our actual roll is coming along compared to our target
v1.2.0Linux,and check position
v1.2.0Linux,the amount of roll should depend on our speed in that direction.
v1.2.0Linux,passed the midpoint.
v1.2.0Linux,fade out the roll as we pick up speed so we don't overshoot.
v1.2.0Linux,see if we just crossed the wiggle distance threshold.
v1.2.0Linux,(roll affects the y-position).
v1.2.0Linux,reverse direction with a -30 degrees quick stop
v1.2.0Linux,reverse direction with a 30 degrees quick stop
v1.2.0Linux,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.2.0Linux,too much in that direction.
v1.2.0Linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.2.0Linux,for testing PID controller.
v1.2.0Linux,class AltHoldCommand : public Command
v1.2.0Linux,{
v1.2.0Linux,std::shared_ptr<MavLinkVehicle> channel;
v1.2.0Linux,"float sx_, sy_, sz_;"
v1.2.0Linux,MavLinkAttitudeTarget _current;
v1.2.0Linux,PidController thrust_controller_;
v1.2.0Linux,public:
v1.2.0Linux,this->sz_ = pos.z; // user defined target.
v1.2.0Linux,move to local position keeps the offboard control happy.
v1.2.0Linux,haven't started yet.
v1.2.0Linux,and check position
v1.2.0Linux,double dx = this->sx_ - pos.x;
v1.2.0Linux,double dy = this->sy_ - pos.y;
v1.2.0Linux,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.2.0Linux,too much in that direction.
v1.2.0Linux,adjust thrust so we keep steady height target
v1.2.0Linux,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.2.0Linux,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.2.0Linux,local remote
v1.2.0Linux,already handled by the parse method.
v1.2.0Linux,we only support very simple patterns for now.
v1.2.0Linux,each wildcard must be separated by literal.
v1.2.0Linux,back to back wildcards with no literal in between is too complex.
v1.2.0Linux,"we only support simple matching for now, we can add full regex later if we need it."
v1.2.0Linux,yep!
v1.2.0Linux,'*' is done we found the next matching char
v1.2.0Linux,this is ok.
v1.2.0Linux,this is an ERASE_END_LINE command which we ignore.
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,unpack the message...
v1.2.0Linux,pack the payload buffer.
v1.2.0Linux,"json can't handle ""nan"", so we convert it to null."
v1.2.0Linux,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.2.0Linux,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,start listening to this connection
v1.2.0Linux,Send heartbeat to drone.  You should not do this if some other node is
v1.2.0Linux,already doing it.
v1.2.0Linux,stop listening to the connection.
v1.2.0Linux,get the connection
v1.2.0Linux,Get the local system and component id
v1.2.0Linux,send a command to the remote node
v1.2.0Linux,MavLinkNode::MavLinkNode() = default;
v1.2.0Linux,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.2.0Linux,decrementing the count so the next WaitOne may block.
v1.2.0Linux,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.2.0Linux,convert to absolute time.
v1.2.0Linux,use mach_timespec
v1.2.0Linux,convert to absolute time.
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,return true if we still have offboard control (can lose this if user flips the switch).
v1.2.0Linux,MavLinkVehicle::MavLinkVehicle() = default;
v1.2.0Linux,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.2.0Linux,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,============================== CLIENT ============================================
v1.2.0Linux,image APIs
v1.2.0Linux,or if you are implementing the client side call this function to get the most recent frame.
v1.2.0Linux,returns false if there is no new frame available.
v1.2.0Linux,============================== SERVER ============================================
v1.2.0Linux,call this to send the image back over the connection given to start function.
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,"log every message that is ""sent"" using sendMessage."
v1.2.0Linux,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.2.0Linux,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.2.0Linux,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.2.0Linux,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,for compatibility with QGroundControl we have to save the time field in big endian.
v1.2.0Linux,todo: mavlink2 support?
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,start listening to this connection
v1.2.0Linux,Send heartbeat to drone.  You should not do this if some other node is
v1.2.0Linux,already doing it.
v1.2.0Linux,send a heart beat so that the remote node knows we are still alive
v1.2.0Linux,(otherwise drone will trigger a failsafe operation).
v1.2.0Linux,this is called for all messages received on the connection.
v1.2.0Linux,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.2.0Linux,subclasses remembering to call this base implementation.
v1.2.0Linux,stop listening to the connection.
v1.2.0Linux,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.2.0Linux,wait for a heartbeat msg since this will give us the port to send commands to...
v1.2.0Linux,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.2.0Linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.0Linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.0Linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.0Linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.0Linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.0Linux,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.0Linux,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.2.0Linux,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.2.0Linux,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.2.0Linux,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.2.0Linux,"ok, now fetch the missing parameters."
v1.2.0Linux,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.2.0Linux,silently fail since we are on a background thread here...
v1.2.0Linux,tell the caller this is complete.
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,add our custom telemetry message length.
v1.2.0Linux,todo: if we support signing then initialize
v1.2.0Linux,mavlink_intermediate_status_.signing callbacks
v1.2.0Linux,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.2.0Linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.2.0Linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.2.0Linux,send this right away just in case serial link is not already configured
v1.2.0Linux,"log every message that is ""sent"" using sendMessage."
v1.2.0Linux,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.2.0Linux,pack the payload buffer.
v1.2.0Linux,calculate checksum
v1.2.0Linux,form the header as a byte array for the crc
v1.2.0Linux,these macros use old style cast.
v1.2.0Linux,forward messages from our connected node to the remote proxy.
v1.2.0Linux,forward messages from remote proxy to local connected node
v1.2.0Linux,CurrentThread::setMaximumPriority();
v1.2.0Linux,"hmmm, wait till it is opened?"
v1.2.0Linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.2.0Linux,pick up the sysid/compid of the remote node we are connected to.
v1.2.0Linux,then this is a mavlink 1 message
v1.2.0Linux,then this mavlink sender supports mavlink 2
v1.2.0Linux,queue event for publishing.
v1.2.0Linux,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.2.0Linux,as it ensures we don't lose messages if the listener is slow.
v1.2.0Linux,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.2.0Linux,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.2.0Linux,we would get a deadlock.
v1.2.0Linux,CurrentThread::setMaximumPriority();
v1.2.0Linux,reset counters
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,------------------------------------------------------------------------------
v1.2.0Linux,Defines
v1.2.0Linux,------------------------------------------------------------------------------
v1.2.0Linux,bit number  876543210987654321
v1.2.0Linux,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.2.0Linux,in future it would be good to have ability to add system IDs we are interested in
v1.2.0Linux,if (msg.sysid != getTargetSystemId())
v1.2.0Linux,{
v1.2.0Linux,// we only care about messages from our intended remote node.
v1.2.0Linux,return;
v1.2.0Linux,}
v1.2.0Linux,user may have changed modes on us! So we need to honor that and not
v1.2.0Linux,try and take it back.
v1.2.0Linux,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.2.0Linux,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.2.0Linux,we can store up to 16 channels in rc_channels_scaled.
v1.2.0Linux,The RAW values of the servo outputs
v1.2.0Linux,Metrics typically displayed on a HUD for fixed wing aircraft
v1.2.0Linux,The IMU readings in SI units in NED body frame
v1.2.0Linux,printSystemStatus(&msg);
v1.2.0Linux,todo: use this to determine when we need to do emergency landing...
v1.2.0Linux,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.2.0Linux,Provides state for additional features
v1.2.0Linux,The general system state
v1.2.0Linux,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.2.0Linux,but we do want to know when we get the ack.  So this is async ACK processing!
v1.2.0Linux,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.2.0Linux,if threshold < 0 then the threshold is inverted.
v1.2.0Linux,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.2.0Linux,Convert it to a floating point number between -1 and 1.
v1.2.0Linux,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.2.0Linux,until the move commands start happening.
v1.2.0Linux,return true if user calls requestControl and has not called releaseControl.
v1.2.0Linux,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.2.0Linux,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.2.0Linux,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.2.0Linux,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.2.0Linux,send a few to make sure it gets through...
v1.2.0Linux,now the command should succeed.
v1.2.0Linux,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.2.0Linux,us by which time the PX4 times out offboard mode!!
v1.2.0Linux,this mode change take precedence over offboard mode.
v1.2.0Linux,thrust must be between -1 and 1.
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,These definitions are copied from PX4 implementation
v1.2.0Linux,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.2.0Linux,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.2.0Linux,/ @brief Command opcodes
v1.2.0Linux,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.2.0Linux,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.2.0Linux,must trim trailing slashes so PX4 doesn't hang!
v1.2.0Linux,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.2.0Linux,from the source.
v1.2.0Linux,check if directory exists.
v1.2.0Linux,perfect.
v1.2.0Linux,use last_message_ so we preserve the sessionid.
v1.2.0Linux,"could not create the local file, so stop."
v1.2.0Linux,must use last_message_ so we preserve the session id.
v1.2.0Linux,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.2.0Linux,todo: error handling here? sequence is out of order...
v1.2.0Linux,"directory must be empty then, can't do nextStep because"
v1.2.0Linux,it will just loop for ever re-requesting zero offset into
v1.2.0Linux,empty directory.
v1.2.0Linux,result should be a list of null terminated file names.
v1.2.0Linux,skipping this entry
v1.2.0Linux,remove the file size field.
v1.2.0Linux,"printf(""%s\n"", name.c_str());"
v1.2.0Linux,request the next batch.
v1.2.0Linux,"perhaps this was a late response after we did a retry, so ignore it."
v1.2.0Linux,"perhaps this was a late response after we did a retry, so ignore it."
v1.2.0Linux,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.2.0Linux,reached the end of the list or the file.
v1.2.0Linux,end of file or directory listing.
v1.2.0Linux,"success, data should be following..."
v1.2.0Linux,ack on this cmd is a noop
v1.2.0Linux,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.2.0Linux,give up then.
v1.2.0Linux,tell watchdog we are sending a request
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,================================= CLIENT ==============================================================
v1.2.0Linux,Check if we have a valid transaction
v1.2.0Linux,emit signal if all packets arrived
v1.2.0Linux,Restart statemachine
v1.2.0Linux,image APIs
v1.2.0Linux,================================= SERVER ==============================================================
v1.2.0Linux,Prepare and send acknowledgment packet
v1.2.0Linux,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.2.0Linux,Send ENCAPSULATED_IMAGE packet
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.2.0Linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.2.0Linux,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.2.0Linux,send this right away just in case serial link is not already configured
v1.2.0Linux,CurrentThread::setMaximumPriority();
v1.2.0Linux,"hmmm, wait till it is opened?"
v1.2.0Linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.2.0Linux,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.2.0Linux,queue event for publishing.
v1.2.0Linux,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.2.0Linux,as it ensures we don't lose messages if the listener is slow.
v1.2.0Linux,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.2.0Linux,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.2.0Linux,we would get a deadlock.
v1.2.0Linux,CurrentThread::setMaximumPriority();
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.2.0Linux,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.2.0Linux,parse out the VID number
v1.2.0Linux,now the PID
v1.2.0Linux,parse out the VID number
v1.2.0Linux,examples:
v1.2.0Linux,PX4: USB\VID_26AC&PID_0011\0
v1.2.0Linux,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.2.0Linux,"printf(""Found: %S\n"", buffer.c_str());"
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.2.0Linux,parse out the VID number
v1.2.0Linux,now the PID
v1.2.0Linux,parse out the VID number
v1.2.0Linux,suppress
v1.2.0Linux,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,This has not been properly tested
v1.2.0Linux,struct iw_statistics stats;
v1.2.0Linux,struct iwreq req;
v1.2.0Linux,"memset(&stats, 0, sizeof(stats));"
v1.2.0Linux,"memset(&req, 0, sizeof(iwreq));"
v1.2.0Linux,
v1.2.0Linux,"strncpy(req.ifr_name, ifaceName, 16);"
v1.2.0Linux,req.u.data.pointer = &stats;
v1.2.0Linux,req.u.data.length = sizeof(iw_statistics);
v1.2.0Linux,
v1.2.0Linux,#ifdef CLEAR_UPDATED
v1.2.0Linux,req.u.data.flags = 1;
v1.2.0Linux,#endif
v1.2.0Linux,
v1.2.0Linux,/* Perform the ioctl */
v1.2.0Linux,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.2.0Linux,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.2.0Linux,return -127;
v1.2.0Linux,}
v1.2.0Linux,
v1.2.0Linux,return stats.qual.level;
v1.2.0Linux,todo: windows version of this...
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,windows
v1.2.0Linux,Need to link with Ws2_32.lib
v1.2.0Linux,posix
v1.2.0Linux,found it!
v1.2.0Linux,bind socket to local address.
v1.2.0Linux,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.2.0Linux,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.2.0Linux,write to the serial port
v1.2.0Linux,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.2.0Linux,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.2.0Linux,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.2.0Linux,"try and receive something, up until port is closed anyway."
v1.2.0Linux,"message was too large for the buffer, no problem, return what we have."
v1.2.0Linux,try again - this can happen if server recreates the socket on their side.
v1.2.0Linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.2.0Linux,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.2.0Linux,try again - this can happen if server recreates the socket on their side.
v1.2.0Linux,"printf(""#### recv failed with error: %d\n"", hr);"
v1.2.0Linux,we now have it.
v1.2.0Linux,this is from someone we are not interested in.
v1.2.0Linux,"printf(""Connection closed\n"");"
v1.2.0Linux,-----------------------------------------------------------------------------------------
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,Initialize Winsock
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,windows
v1.2.0Linux,Need to link with Ws2_32.lib
v1.2.0Linux,posix
v1.2.0Linux,found it!
v1.2.0Linux,bind socket to local address.
v1.2.0Linux,bind socket to local address.
v1.2.0Linux,start listening for incoming connection
v1.2.0Linux,accept 1
v1.2.0Linux,write to the serial port
v1.2.0Linux,"try and receive something, up until port is closed anyway."
v1.2.0Linux,"message was too large for the buffer, no problem, return what we have."
v1.2.0Linux,try again - this can happen if server recreates the socket on their side.
v1.2.0Linux,"skip this, it is was interrupted."
v1.2.0Linux,"printf(""Connection closed\n"");"
v1.2.0Linux,-----------------------------------------------------------------------------------------
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.2.0Linux,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.2.0Linux,set signal
v1.2.0Linux,Clear Handshake flags
v1.2.0Linux,Set Handshake flags
v1.2.0Linux,return GetLastError();
v1.2.0Linux,return GetLastError();
v1.2.0Linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.2.0Linux,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.2.0Linux,enable reading
v1.2.0Linux,posix doesn't have mark/space parity.
v1.2.0Linux,posix doesn't have mark/space parity.
v1.2.0Linux,this is the default.
v1.2.0Linux,not sure this is supported...
v1.2.0Linux,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.2.0Linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.2.0Linux,First do those specified by POSIX.
v1.2.0Linux,Now conditionally handle a bunch of extended rates.
v1.2.0Linux,First do those specified by POSIX.
v1.2.0Linux,Now conditionally handle a bunch of extended rates.
v1.2.0Linux,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.2.0Linux,","
v1.2.0Linux,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.2.0Linux,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,"in header only mode, control library is not available"
v1.2.0Linux,TODO: something defines max macro which interfears with code here
v1.2.0Linux,is cur_pos within fence?
v1.2.0Linux,destination risk is not available then consider it zero
v1.2.0Linux,if dest risk is lower than its more safe
v1.2.0Linux,are we doing better than closest obstacle?
v1.2.0Linux,"if we stay where we are, what is the risk distance?"
v1.2.0Linux,else we are better of moving to dest
v1.2.0Linux,this function should work even when dest_pos == cur_pos
v1.2.0Linux,is this dest_pos cur_pos within the fence?
v1.2.0Linux,transform dest_pos vector to body frame
v1.2.0Linux,check for approx zero vectors to avoid random yaw angles
v1.2.0Linux,we are hovering
v1.2.0Linux,"get yaw in body frame, ie, front is always 0 radians"
v1.2.0Linux,yaw to ticks
v1.2.0Linux,get obstacles in the window at the tick direction around the window
v1.2.0Linux,less risk distance is better
v1.2.0Linux,check obstacles around current position and see if it has lower risk
v1.2.0Linux,else obstacle is too far
v1.2.0Linux,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.2.0Linux,look for each surrounding tick to see if we have obstacle free angle
v1.2.0Linux,else no suggestions required
v1.2.0Linux,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.2.0Linux,evaluate right and left side of circle
v1.2.0Linux,find right and left risk distances
v1.2.0Linux,at this point we have already determined hover is better than going to dest
v1.2.0Linux,we now determine is moving to suggested angle better than hovering?
v1.2.0Linux,check if dest_pos is safe
v1.2.0Linux,breaking distance at this velocity
v1.2.0Linux,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.2.0Linux,check if dest_pos is safe
v1.2.0Linux,float/vec parameters can have NaN which makes them optional
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,"in header only mode, control library is not available"
v1.2.0Linux,handles +/- tick and wraps around circle
v1.2.0Linux,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.2.0Linux,update the specified window on the map
v1.2.0Linux,make sure from <= to
v1.2.0Linux,normalize the ticks so both are valid indices
v1.2.0Linux,if from is still larger then
v1.2.0Linux,to ticks is then added one full circle to make it larger than from_tick
v1.2.0Linux,find closest obstacle in given window
v1.2.0Linux,search whole map to find closest obstacle
v1.2.0Linux,"in header only mode, control library is not available"
v1.2.0Linux,#include <fileapi.h>
v1.2.0Linux,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.2.0Linux,"Windows, OSX and Linux."
v1.2.0Linux,Windows users can move the Documents folder to any location they want
v1.2.0Linux,SHGetFolderPath knows how to find it.
v1.2.0Linux,fall back in case SHGetFolderPath failed for some reason.
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,"in header only mode, control library is not available"
v1.2.0Linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.0Linux,if using Unreal Build system then include precompiled header file first
v1.2.0Linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.0Linux,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.2.0Linux,----------- APIs to control ACharacter in scene ----------/
v1.2.0Linux,if we don't suppress then server will bomb out for exceptions raised by any method
v1.2.0Linux,required for pimpl
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,"in header only mode, control library is not available"
v1.2.0Linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.0Linux,if using Unreal Build system then include precompiled header file first
v1.2.0Linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.0Linux,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.2.0Linux,make sure we can talk to the DroneServer
v1.2.0Linux,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.2.0Linux,command_context.client.ping();
v1.2.0Linux,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.2.0Linux,sim only
v1.2.0Linux,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.2.0Linux,return value of last task. It should be true if task completed without
v1.2.0Linux,cancellation or timeout
v1.2.0Linux,"should be implemented by derived class if it supports async task,"
v1.2.0Linux,for example using futures
v1.2.0Linux,----------- APIs to control ACharacter in scene ----------/
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,"in header only mode, control library is not available"
v1.2.0Linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.0Linux,if using Unreal Build system then include precompiled header file first
v1.2.0Linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,"in header only mode, control library is not available"
v1.2.0Linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.0Linux,if using Unreal Build system then include precompiled header file first
v1.2.0Linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.0Linux,required for pimpl
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,"in header only mode, control library is not available"
v1.2.0Linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.0Linux,if using Unreal Build system then include precompiled header file first
v1.2.0Linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.0Linux,status getters
v1.2.0Linux,return value of last task. It should be true if task completed without
v1.2.0Linux,cancellation or timeout
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,"in header only mode, control library is not available"
v1.2.0Linux,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.0Linux,if using Unreal Build system then include pre-compiled header file first
v1.2.0Linux,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.0Linux,getters
v1.2.0Linux,required for pimpl
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,"in header only mode, control library is not available"
v1.2.0Linux,last command is to hold on to position
v1.2.0Linux,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.2.0Linux,after landing we detect if drone has stopped moving
v1.2.0Linux,validate path size
v1.2.0Linux,validate yaw mode
v1.2.0Linux,validate and set auto-lookahead value
v1.2.0Linux,if auto mode requested for lookahead then calculate based on velocity
v1.2.0Linux,add current position as starting point
v1.2.0Linux,append the input path and compute segments
v1.2.0Linux,add last segment as zero length segment so we have equal number of segments and points.
v1.2.0Linux,path_segs[i] refers to segment that starts at point i
v1.2.0Linux,"when path ends, we want to slow down"
v1.2.0Linux,else no need to change velocities for last segments
v1.2.0Linux,setup current position on path to 0 offset
v1.2.0Linux,initialize next path position
v1.2.0Linux,until we are at the end of the path (last seg is always zero size)
v1.2.0Linux,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.2.0Linux,send drone command to get to next lookahead
v1.2.0Linux,sleep for rest of the cycle
v1.2.0Linux,how much have we moved towards last goal?
v1.2.0Linux,project actual vector on goal vector
v1.2.0Linux,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.2.0Linux,TODO: below should be lower than 1E3 and configurable
v1.2.0Linux,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.2.0Linux,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.2.0Linux,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.2.0Linux,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.2.0Linux,"if drone moved backward, we don't want goal to move backward as well"
v1.2.0Linux,"so only climb forward on the path, never back. Also note >= which means"
v1.2.0Linux,we climb path even if distance was 0 to take care of duplicated points on path
v1.2.0Linux,else
v1.2.0Linux,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.2.0Linux,compute next target on path
v1.2.0Linux,freeze the quaternion
v1.2.0Linux,convert RC commands to velocity vector
v1.2.0Linux,find yaw as per terrain and remote setting
v1.2.0Linux,execute command
v1.2.0Linux,if timeout occurred then command completed successfully otherwise it was interrupted
v1.2.0Linux,change yaw by moving to same position but constant yaw mode
v1.2.0Linux,by default we say that this command is not supported
v1.2.0Linux,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.2.0Linux,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.2.0Linux,get trims
v1.2.0Linux,take average
v1.2.0Linux,validate dest
v1.2.0Linux,what is the distance we will travel at this velocity?
v1.2.0Linux,get velocity vector
v1.2.0Linux,yaw for the direction of travel
v1.2.0Linux,find velocity vector
v1.2.0Linux,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.2.0Linux,generate velocity vector that is same size as cur_dest_norm / command period
v1.2.0Linux,this velocity vect when executed for command period would yield cur_dest_norm
v1.2.0Linux,send commands
v1.2.0Linux,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.2.0Linux,default strategy is for move. In hover mode we set new strategy temporarily
v1.2.0Linux,are we supposed to do EM?
v1.2.0Linux,get suggested velocity vector
v1.2.0Linux,use the unchecked command
v1.2.0Linux,tell caller not to execute planned command
v1.2.0Linux,other wise throw exception
v1.2.0Linux,otherwise there is some other reason why we are in unsafe situation
v1.2.0Linux,send last command to come to full stop
v1.2.0Linux,else no unsafe situation
v1.2.0Linux,note: cur_path_loc and next_path_loc may both point to same object
v1.2.0Linux,"otherwise use up this segment, move on to next one"
v1.2.0Linux,if we are here then we ran out of segments
v1.2.0Linux,consider last segment as zero length segment
v1.2.0Linux,adjust yaw for the direction of travel in forward-only mode
v1.2.0Linux,else no adjustment needed
v1.2.0Linux,if auto mode requested for lookahead then calculate based on velocity
v1.2.0Linux,Create a spring arm component for our chase camera
v1.2.0Linux,"do nothing, spring arm is pulling the camera with it"
v1.2.0Linux,"do nothing, we have camera turned off"
v1.2.0Linux,set initial view mode
v1.2.0Linux,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.2.0Linux,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.2.0Linux,"If the lag is missing, the camera will also occasionally shake."
v1.2.0Linux,"But, lag is not desired when piloting a drone"
v1.2.0Linux,attach spring arm to actor
v1.2.0Linux,remember current parent for external camera. Later when we remove external
v1.2.0Linux,"camera from spring arm, we will attach it back to its last parent"
v1.2.0Linux,now attach camera to spring arm
v1.2.0Linux,"For car, we need to move the camera back a little more than for a drone."
v1.2.0Linux,"Otherwise, the camera will be stuck inside the car"
v1.2.0Linux,ExternalCamera->bUsePawnControlRotation = false;
v1.2.0Linux,detach spring arm
v1.2.0Linux,Re-enable rendering
v1.2.0Linux,Remove any existing key bindings for manual mode
v1.2.0Linux,"else someone else is bound to manual pose controller, leave it alone"
v1.2.0Linux,if new mode is manual mode then add key bindings
v1.2.0Linux,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.2.0Linux,other modes don't need special setup
v1.2.0Linux,make switch official
v1.2.0Linux,reset any chars we have
v1.2.0Linux,choose first character if name was blank or find by name
v1.2.0Linux,by default all image types are disabled
v1.2.0Linux,use final color for all calculations
v1.2.0Linux,TODO: avoid the need to override const cast here
v1.2.0Linux,if the viewport is wider than it is tall
v1.2.0Linux,if the viewport is taller than it is wide
v1.2.0Linux,use final color for all calculations
v1.2.0Linux,TODO: should we be ignoring position and orientation settings here?
v1.2.0Linux,TODO: can we eliminate storing NedTransform?
v1.2.0Linux,if (!std::isnan(setting.target_gamma))
v1.2.0Linux,camera-> = setting.target_gamma;
v1.2.0Linux,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.2.0Linux,else nothing to enable
v1.2.0Linux,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.2.0Linux,if (controller && controller->GetViewTarget() == this)
v1.2.0Linux,controller->SetViewTarget(nullptr);
v1.2.0Linux,TODO: explore screenshot option
v1.2.0Linux,addScreenCaptureHandler(camera->GetWorld());
v1.2.0Linux,TODO: may be we should have these methods non-const?
v1.2.0Linux,We don't do game/render thread synchronization for safe method.
v1.2.0Linux,We just blindly sleep for 200ms (the old way)
v1.2.0Linux,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.2.0Linux,Make sure that all alpha values are opaque.
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,"#include ""Runtime/Foliage/Public/FoliageType.h"""
v1.2.0Linux,TODO: change naming conventions to same as other files?
v1.2.0Linux,Enable/disable primary viewport rendering flag
v1.2.0Linux,This disables rendering of the main viewport in the same way as the
v1.2.0Linux,"console command ""show rendering"" would do."
v1.2.0Linux,"When getting an image through the API, the image is produced after the render"
v1.2.0Linux,thread has finished rendering the current and the subsequent frame. This means
v1.2.0Linux,that the frame rate for obtaining images through the API is only half as high as
v1.2.0Linux,"it could be, since only every other image is actually captured. We work around"
v1.2.0Linux,this by telling the viewport to flush the rendering queue at the end of each
v1.2.0Linux,drawn frame so that it executes our render request at that point already.
v1.2.0Linux,Do this only if the main viewport is not being rendered anyway in case there are
v1.2.0Linux,any adverse performance effects during main rendering.
v1.2.0Linux,HACK: FViewPort doesn't expose this field so we are doing dirty work around by maintaining count by ourselves
v1.2.0Linux,HACK: FViewPort doesn't expose this field so we are doing dirty work around by maintaining count by ourselves
v1.2.0Linux,nothing to do for now
v1.2.0Linux,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.2.0Linux,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.2.0Linux,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.2.0Linux,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.2.0Linux,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.2.0Linux,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.2.0Linux,{
v1.2.0Linux,InitializeObjectStencilID(*comp);
v1.2.0Linux,}
v1.2.0Linux,Access the subclass instance with the * or -> operators.
v1.2.0Linux,can we see followee?
v1.2.0Linux,remove mapping
v1.2.0Linux,removing binding
v1.2.0Linux,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.2.0Linux,"some point. At the moment, manually swapping Red and Blue"
v1.2.0Linux,Copy scaled image into destination thumb
v1.2.0Linux,Compress data - convert into a .png
v1.2.0Linux,if we already have attached actor
v1.2.0Linux,#ifdef _MSC_VER
v1.2.0Linux,//print to VS output window
v1.2.0Linux,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.2.0Linux,#endif
v1.2.0Linux,also do default logging
v1.2.0Linux,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.2.0Linux,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.2.0Linux,{
v1.2.0Linux,if (GEngine != nullptr)
v1.2.0Linux,{
v1.2.0Linux,return GEngine->GameUserSettings;
v1.2.0Linux,}
v1.2.0Linux,return nullptr;
v1.2.0Linux,}
v1.2.0Linux,UGameUserSettings* game_settings = GetGameUserSettings();
v1.2.0Linux,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.2.0Linux,game_settings->ApplySettings(true);
v1.2.0Linux,derived class should override this
v1.2.0Linux,derived class should override this
v1.2.0Linux,derived class should override this
v1.2.0Linux,derived class should override this
v1.2.0Linux,derived class should override this
v1.2.0Linux,derived class should override this
v1.2.0Linux,derived class should override this
v1.2.0Linux,derived class should override this
v1.2.0Linux,derived class should override this
v1.2.0Linux,derived class should override this
v1.2.0Linux,derived class should override this
v1.2.0Linux,derived class should override this
v1.2.0Linux,derived class should override this
v1.2.0Linux,derived class should override this
v1.2.0Linux,derived class should override this
v1.2.0Linux,derived class should override this
v1.2.0Linux,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.2.0Linux,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.2.0Linux,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,plugin startup
v1.2.0Linux,plugin shutdown
v1.2.0Linux,initialize state
v1.2.0Linux,add listener for pawn's collision event
v1.2.0Linux,compute our home point
v1.2.0Linux,add cameras that already exists in pawn
v1.2.0Linux,create or replace cameras specified in settings
v1.2.0Linux,setup individual cameras
v1.2.0Linux,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.2.0Linux,for each camera in settings
v1.2.0Linux,get pose
v1.2.0Linux,spawn and attach camera to pawn
v1.2.0Linux,add on to our collection
v1.2.0Linux,Deflect along the surface when we collide.
v1.2.0Linux,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.2.0Linux,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.2.0Linux,-1 to 1 --> 0 to 1
v1.2.0Linux,-1 to 1
v1.2.0Linux,these will be available for devices like steering wheels
v1.2.0Linux,switch index 0 to 7 for FrSky Taranis RC is:
v1.2.0Linux,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.2.0Linux,TODO: should below be at controller level info?
v1.2.0Linux,else don't waste time
v1.2.0Linux,update position from kinematics so we have latest position after physics update
v1.2.0Linux,kinematics_->update();
v1.2.0Linux,void playBack()
v1.2.0Linux,{
v1.2.0Linux,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.2.0Linux,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.2.0Linux,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.2.0Linux,}
v1.2.0Linux,TODO: refactor below code used for playback
v1.2.0Linux,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.2.0Linux,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.2.0Linux,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.2.0Linux,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.2.0Linux,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.2.0Linux,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.2.0Linux,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.2.0Linux,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.2.0Linux,}
v1.2.0Linux,parameters in NED frame
v1.2.0Linux,translate to new PawnSimApi position & orientation from NED to NEU
v1.2.0Linux,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.2.0Linux,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.2.0Linux,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.2.0Linux,checked at the start of next tick
v1.2.0Linux,allow teleportation
v1.2.0Linux,if collisions are not enabled
v1.2.0Linux,or we have collided but passthrough is enabled
v1.2.0Linux,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.2.0Linux,"without flip flopping, collisions can't be detected"
v1.2.0Linux,TODO: update other fields?
v1.2.0Linux,no default action in this base class
v1.2.0Linux,TODO: because this bug we are using alternative code with stringstream
v1.2.0Linux,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.2.0Linux,std::stringstream ss;
v1.2.0Linux,"ss << timestamp_millis << ""\t"";"
v1.2.0Linux,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.2.0Linux,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.2.0Linux,"ss << ""\n"";"
v1.2.0Linux,return ss.str();
v1.2.0Linux,"read pixels from render target using render thread, then compress the result into PNG"
v1.2.0Linux,argument on the thread that calls this method.
v1.2.0Linux,TODO: is below really needed?
v1.2.0Linux,make sure we are not on the rendering thread
v1.2.0Linux,TODO: below doesn't work right now because it must be running in game thread
v1.2.0Linux,below is documented method but more expensive because it forces flush
v1.2.0Linux,wait for render thread to pick up our task
v1.2.0Linux,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.2.0Linux,capture CameraPose for this frame
v1.2.0Linux,The completion is called immeidately after GameThread sends the
v1.2.0Linux,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.2.0Linux,execute *immediately* after RenderThread renders the scene!
v1.2.0Linux,"while we're still on GameThread, enqueue request for capture the scene!"
v1.2.0Linux,wait for this task to complete
v1.2.0Linux,log a message and continue wait
v1.2.0Linux,lamda function still references a few objects for which there is no refcount.
v1.2.0Linux,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.2.0Linux,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.2.0Linux,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.2.0Linux,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,Stuff to filter out XInput devices
v1.2.0Linux,-----------------------------------------------------------------------------
v1.2.0Linux,"Defines, constants, and global variables"
v1.2.0Linux,-----------------------------------------------------------------------------
v1.2.0Linux,Magnitude ranges from -1 to 1
v1.2.0Linux,Strength ranges from 0 to 1
v1.2.0Linux,Autocenter
v1.2.0Linux,Rumble
v1.2.0Linux,Register with the DirectInput subsystem and get a pointer
v1.2.0Linux,to a IDirectInput interface we can use.
v1.2.0Linux,Create a DInput object
v1.2.0Linux,Look for a simple joystick we can use for this sample program.
v1.2.0Linux,Make sure we got a joystick
v1.2.0Linux,"Set the data format to ""simple joystick"" - a predefined data format"
v1.2.0Linux,
v1.2.0Linux,"A data format specifies which controls on a device we are interested in,"
v1.2.0Linux,and how they should be reported. This tells DInput that we will be
v1.2.0Linux,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.2.0Linux,Set the cooperative level to let DInput know how this device should
v1.2.0Linux,interact with the system and with other DInput applications.
v1.2.0Linux,Enumerate the joystick objects. The callback function enabled user
v1.2.0Linux,"interface elements for objects that are found, and sets the min/max"
v1.2.0Linux,values property for discovered axes.
v1.2.0Linux,-----------------------------------------------------------------------------
v1.2.0Linux,Enum each PNP device using WMI and check each device ID to see if it contains
v1.2.0Linux,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.2.0Linux,Unfortunately this information can not be found by just using DirectInput.
v1.2.0Linux,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.2.0Linux,XInput devices.
v1.2.0Linux,
v1.2.0Linux,This function stores the list of xinput devices in a linked list
v1.2.0Linux,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.2.0Linux,-----------------------------------------------------------------------------
v1.2.0Linux,CoInit if needed
v1.2.0Linux,Create WMI
v1.2.0Linux,Create BSTRs for WMI
v1.2.0Linux,Connect to WMI
v1.2.0Linux,Switch security level to IMPERSONATE
v1.2.0Linux,Get list of Win32_PNPEntity devices
v1.2.0Linux,Loop over all devices
v1.2.0Linux,Get 20 at a time
v1.2.0Linux,"For each device, get its device ID"
v1.2.0Linux,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.2.0Linux,Unfortunately this information can not be found by just using DirectInput
v1.2.0Linux,"If it does, then get the VID/PID from var.bstrVal"
v1.2.0Linux,Add the VID/PID to a linked list
v1.2.0Linux,-----------------------------------------------------------------------------
v1.2.0Linux,Returns true if the DirectInput device is also an XInput device.
v1.2.0Linux,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.2.0Linux,-----------------------------------------------------------------------------
v1.2.0Linux,Check each xinput device to see if this device's vid/pid matches
v1.2.0Linux,-----------------------------------------------------------------------------
v1.2.0Linux,Cleanup needed for IsXInputDevice()
v1.2.0Linux,-----------------------------------------------------------------------------
v1.2.0Linux,Cleanup linked list
v1.2.0Linux,-----------------------------------------------------------------------------
v1.2.0Linux,Name: EnumJoysticksCallback()
v1.2.0Linux,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.2.0Linux,device interface on it so we can play with it.
v1.2.0Linux,-----------------------------------------------------------------------------
v1.2.0Linux,Skip anything other than the perferred joystick device as defined by the control panel.
v1.2.0Linux,Instead you could store all the enumerated joysticks and let the user pick.
v1.2.0Linux,Obtain an interface to the enumerated joystick.
v1.2.0Linux,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.2.0Linux,it while we were in the middle of enumerating it.)
v1.2.0Linux,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.2.0Linux,could store all the enumerated joysticks and let the user pick.
v1.2.0Linux,-----------------------------------------------------------------------------
v1.2.0Linux,Name: EnumObjectsCallback()
v1.2.0Linux,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.2.0Linux,joystick. This function enables user interface elements for objects
v1.2.0Linux,"that are found to exist, and scales axes min/max values."
v1.2.0Linux,-----------------------------------------------------------------------------
v1.2.0Linux,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.2.0Linux,enumerated axis in order to scale min/max values.
v1.2.0Linux,Set the range for the axis
v1.2.0Linux,Set the UI to reflect what objects the joystick supports
v1.2.0Linux,-----------------------------------------------------------------------------
v1.2.0Linux,Name: UpdateInputState()
v1.2.0Linux,Desc: Get the input device's state and display it.
v1.2.0Linux,-----------------------------------------------------------------------------
v1.2.0Linux,Poll the device to read the current state
v1.2.0Linux,DInput is telling us that the input stream has been
v1.2.0Linux,"interrupted. We aren't tracking any state between polls, so"
v1.2.0Linux,we don't have any special reset that needs to be done. We
v1.2.0Linux,just re-acquire and try again.
v1.2.0Linux,while (hr == DIERR_INPUTLOST)
v1.2.0Linux,hr = g_pJoystick->Acquire();
v1.2.0Linux,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.2.0Linux,may occur when the app is minimized or in the process of
v1.2.0Linux,"switching, so just try again later"
v1.2.0Linux,Get the input's device state
v1.2.0Linux,Axes
v1.2.0Linux,Slider controls
v1.2.0Linux,Points of view
v1.2.0Linux,Buttons
v1.2.0Linux,-----------------------------------------------------------------------------
v1.2.0Linux,Name: FreeDirectInput()
v1.2.0Linux,Desc: Initialize the DirectInput variables.
v1.2.0Linux,-----------------------------------------------------------------------------
v1.2.0Linux,Unacquire the device one last time just in case
v1.2.0Linux,the app tried to exit while the device is still acquired.
v1.2.0Linux,Release any DirectInput objects.
v1.2.0Linux,nop
v1.2.0Linux,normalize min to max --> 0 to 1
v1.2.0Linux,normalize 0 to 1 --> -1 to 1
v1.2.0Linux,#include <libudev.h>
v1.2.0Linux,implementation for unsupported OS
v1.2.0Linux,if this is new index
v1.2.0Linux,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.2.0Linux,close previous one
v1.2.0Linux,open new device
v1.2.0Linux,if open was successful
v1.2.0Linux,read the device
v1.2.0Linux,if we didn't had valid read
v1.2.0Linux,"NOTE if this condition is not met, we're probably out of sync and this"
v1.2.0Linux,Joystick instance is likely unusable
v1.2.0Linux,TODO: set below to false?
v1.2.0Linux,state.is_valid = false;
v1.2.0Linux,else ignore
v1.2.0Linux,TODO: implement this for linux
v1.2.0Linux,TODO: implement this for linux
v1.2.0Linux,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.2.0Linux,{
v1.2.0Linux,"manufacturerID = productID = """";"
v1.2.0Linux,// Use udev to look up the product and manufacturer IDs
v1.2.0Linux,struct udev *udev = udev_new();
v1.2.0Linux,if (udev) {
v1.2.0Linux,char sysname[32];
v1.2.0Linux,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.2.0Linux,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.2.0Linux,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.2.0Linux,if (!dev)
v1.2.0Linux,{
v1.2.0Linux,"message = ""Unable to find parent USB device"";"
v1.2.0Linux,return false;
v1.2.0Linux,}
v1.2.0Linux,std::stringstream ss;
v1.2.0Linux,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.2.0Linux,ss >> manufacturerID;
v1.2.0Linux,ss.clear();
v1.2.0Linux,"ss.str("""");"
v1.2.0Linux,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.2.0Linux,ss >> productID;
v1.2.0Linux,udev_device_unref(dev);
v1.2.0Linux,}
v1.2.0Linux,else
v1.2.0Linux,{
v1.2.0Linux,"message = ""Cannot create udev"";"
v1.2.0Linux,return false;
v1.2.0Linux,}
v1.2.0Linux,udev_unref(udev);
v1.2.0Linux,return true;
v1.2.0Linux,}
v1.2.0Linux,required for pimpl
v1.2.0Linux,TODO: anyway to workaround const_cast?
v1.2.0Linux,FGenericPlatformMisc::PlatformInit();
v1.2.0Linux,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.2.0Linux,TODO: index check
v1.2.0Linux,create main widget
v1.2.0Linux,synchronize PIP views
v1.2.0Linux,TODO: should we only do below on SceneCapture2D components and cameras?
v1.2.0Linux,avoid motion blur so capture images don't get
v1.2.0Linux,use two different methods to set console var because sometime it doesn't seem to work
v1.2.0Linux,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.2.0Linux,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.2.0Linux,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.2.0Linux,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.2.0Linux,setup defaults
v1.2.0Linux,Attempts to parse the settings text from one of multiple locations.
v1.2.0Linux,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.2.0Linux,"Next, check the executable's working directory for the settings file."
v1.2.0Linux,"Finally, check the user's documents folder."
v1.2.0Linux,"If the settings file cannot be read, throw an exception"
v1.2.0Linux,Attempts to parse the settings text from the command line
v1.2.0Linux,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.2.0Linux,"Example: AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.2.0Linux,"Returns true if the argument is present, false otherwise."
v1.2.0Linux,build image file name
v1.2.0Linux,write image file
v1.2.0Linux,write to CSV file
v1.2.0Linux,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.2.0Linux,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.2.0Linux,make sire all vars are set up
v1.2.0Linux,"TODO: should we go as fast as possible, or should we limit this to a particular number of"
v1.2.0Linux,frames per second?
v1.2.0Linux,"UAirBlueprintLib::LogMessage(TEXT(""Stopped recording thread""), TEXT(""""), LogDebugLevel::Success);"
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,decide which derived BP to use
v1.2.0Linux,we don't have real vehicle so no vehicle API
v1.2.0Linux,put camera little bit above vehicle
v1.2.0Linux,update ground level
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,let base class setup physics world
v1.2.0Linux,stop physics thread before we dismantle
v1.2.0Linux,setup clock in ClockFactory
v1.2.0Linux,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.2.0Linux,steppable clock returns interval that is a constant number irrespective of wall clock
v1.2.0Linux,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.2.0Linux,but that would cause vehicles like quadrotors to become unstable
v1.2.0Linux,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.2.0Linux,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.2.0Linux,get increase in clock speed
v1.2.0Linux,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.2.0Linux,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.2.0Linux,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.2.0Linux,Approach 2: scale control loop frequency if clock is speeded up
v1.2.0Linux,"for slowing down, this don't generate instability"
v1.2.0Linux,-------------------------------- overrides -----------------------------------------------//
v1.2.0Linux,decide which derived BP to use
v1.2.0Linux,vehicle_sim_api->reset();
v1.2.0Linux,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.2.0Linux,create vehicle API
v1.2.0Linux,setup physics vehicle
v1.2.0Linux,initialize private vars
v1.2.0Linux,calls to update* are handled by physics engine and in SimModeWorldBase
v1.2.0Linux,"Utils::log(""------Render tick-------"");"
v1.2.0Linux,"if reset is pending then do it first, no need to do other things until next tick"
v1.2.0Linux,move collision info from rendering engine to vehicle
v1.2.0Linux,update rotor poses
v1.2.0Linux,if we did reset then don't worry about synchronizing states for this tick
v1.2.0Linux,Continue to wait for reset
v1.2.0Linux,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.2.0Linux,*** Start: UpdatableState implementation ***//
v1.2.0Linux,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.2.0Linux,environment update for current position
v1.2.0Linux,update forces on vertices
v1.2.0Linux,update to controller must be done after kinematics have been updated by physics engine
v1.2.0Linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.2.0Linux,*** End: UpdatableState implementation ***//
v1.2.0Linux,get references of existing camera
v1.2.0Linux,setup clock in PhysX
v1.2.0Linux,-------------------------------- overrides -----------------------------------------------//
v1.2.0Linux,decide which derived BP to use
v1.2.0Linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.2.0Linux,Setup suspension forces
v1.2.0Linux,Find the tire object and set the data for it
v1.2.0Linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.2.0Linux,Setup suspension forces
v1.2.0Linux,Find the tire object and set the data for it
v1.2.0Linux,Create In-Car camera component
v1.2.0Linux,In car HUD
v1.2.0Linux,Create text render component for in car speed display
v1.2.0Linux,Create text render component for in car gear display
v1.2.0Linux,Setup the audio component and allocate it a sound cue
v1.2.0Linux,Colors for the in-car gear display. One for normal one for reverse
v1.2.0Linux,Wheels/Tires
v1.2.0Linux,Setup the wheels
v1.2.0Linux,Adjust the tire loading
v1.2.0Linux,Engine
v1.2.0Linux,Torque setup
v1.2.0Linux,Adjust the steering
v1.2.0Linux,Transmission
v1.2.0Linux,We want 4wd
v1.2.0Linux,Drive the front wheels a little more than the rear
v1.2.0Linux,Automatic gearbox
v1.2.0Linux,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.2.0Linux,Physics settings
v1.2.0Linux,Adjust the center of mass - the buggy is quite low
v1.2.0Linux,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.2.0Linux,put camera little bit above vehicle
v1.2.0Linux,update physics material
v1.2.0Linux,Update the strings used in the HUD (in-car and on-screen)
v1.2.0Linux,Set the string in the in-car HUD
v1.2.0Linux,Pass the engine RPM to the sound component
v1.2.0Linux,Start an engine sound playing
v1.2.0Linux,Using FText because this is display text that should be localizable
v1.2.0Linux,Setup the text render component strings
v1.2.0Linux,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.2.0Linux,below is not needed
v1.2.0Linux,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.2.0Linux,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.2.0Linux,TODO: should do reset() here?
v1.2.0Linux,create vehicle params
v1.2.0Linux,these are called on render ticks
v1.2.0Linux,TODO: do we need this for cars?
v1.2.0Linux,TODO: move this to SimModeBase?
v1.2.0Linux,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.2.0Linux,reset();
v1.2.0Linux,return;
v1.2.0Linux,}
v1.2.0Linux,Thrustmaster devices
v1.2.0Linux,"Anything else, typically Logitech G920 wheel"
v1.2.0Linux,Two steel levers behind wheel
v1.2.0Linux,if API-client control is not active then we route keyboard/joystick control to car
v1.2.0Linux,all car controls from anywhere must be routed through API component
v1.2.0Linux,*** Start: UpdatableState implementation ***//
v1.2.0Linux,physics tick
v1.2.0Linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.2.0Linux,*** End: UpdatableState implementation ***//
v1.2.0Linux,TODO: implement arming for car
v1.2.0Linux,TODO: directly accept getVehicleSimApis() using generic container
v1.2.0Linux,remove everything that we created in BeginPlay
v1.2.0Linux,we use custom debug reporting for this class
v1.2.0Linux,perform any expensive rendering update outside of lock region
v1.2.0Linux,no need to call base reset because of our custom implementation
v1.2.0Linux,TODO: this is going to cause circular references which is fine here but
v1.2.0Linux,in future we should consider moving SimMode not derived from AActor and move
v1.2.0Linux,it to AirLib and directly implement WorldSimApiBase interface
v1.2.0Linux,get player start
v1.2.0Linux,this must be done from within actor otherwise we don't get player start
v1.2.0Linux,else don't init
v1.2.0Linux,else ignore
v1.2.0Linux,should be overridden by derived class
v1.2.0Linux,should be overridden by derived class
v1.2.0Linux,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.2.0Linux,default setup - this should be overridden in derived modes as needed
v1.2.0Linux,setup clock in ClockFactory
v1.2.0Linux,default implementation
v1.2.0Linux,create director
v1.2.0Linux,create external camera required for the director
v1.2.0Linux,API server start/stop
v1.2.0Linux,get UU origin of global NED frame
v1.2.0Linux,determine camera director camera default pose and spawn it
v1.2.0Linux,find all vehicle pawns
v1.2.0Linux,add vehicles from settings
v1.2.0Linux,if vehicle is of type for derived SimMode and auto creatable
v1.2.0Linux,compute initial pose
v1.2.0Linux,spawn vehicle pawn
v1.2.0Linux,create API objects for each pawn we have
v1.2.0Linux,create vehicle sim api
v1.2.0Linux,TODO: better handle no FPV vehicles scenario
v1.2.0Linux,derived class should override this method to retrieve types of pawns they support
v1.2.0Linux,derived class should override this method to retrieve types of pawns they support
v1.2.0Linux,derived class should override this method to retrieve types of pawns they support
v1.2.0Linux,derived class should override this method to retrieve types of pawns they support
v1.2.0Linux,derived class should override this method to retrieve types of pawns they support
v1.2.0Linux,derived class should override this method to retrieve types of pawns they support
v1.2.0Linux,derived class should override this method to retrieve types of pawns they support
v1.2.0Linux,Draws debug-points on main viewport for Lidar laser hits.
v1.2.0Linux,Used for debugging only.
v1.2.0Linux,Currently we are checking the sensor-collection instead of sensor-settings.
v1.2.0Linux,Also using variables to optimize not checking the collection if not needed.
v1.2.0Linux,TODO: Is it incorrect to assume LidarSimple here?
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,ctor
v1.2.0Linux,initializes information based on lidar configuration
v1.2.0Linux,calculate verticle angle distance between each laser
v1.2.0Linux,store vertical angles for each laser
v1.2.0Linux,returns a point-cloud for the tick
v1.2.0Linux,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.2.0Linux,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.2.0Linux,calculate number of points needed for each laser/channel
v1.2.0Linux,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.2.0Linux,calculate needed angle/distance between each point
v1.2.0Linux,normalize FOV start/end
v1.2.0Linux,shoot lasers
v1.2.0Linux,check if the laser is outside the requested horizontal FOV
v1.2.0Linux,"shoot laser and get the impact point, if any"
v1.2.0Linux,simulate shooting a laser via Unreal ray-tracing.
v1.2.0Linux,start position
v1.2.0Linux,We need to compose rotations here rather than rotate a vector by a quaternion
v1.2.0Linux,Hence using coordOrientationAdd(..) rather than rotateQuaternion(..)
v1.2.0Linux,get ray quaternion in lidar frame (angles must be in radians)
v1.2.0Linux,get ray quaternion in body frame
v1.2.0Linux,get ray quaternion in world frame
v1.2.0Linux,get ray vector (end position)
v1.2.0Linux,Debug code for very specific cases.
v1.2.0Linux,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.2.0Linux,decide the frame for the point-cloud
v1.2.0Linux,current detault behavior; though it is probably not very useful.
v1.2.0Linux,not changing the default for now to maintain backwards-compat.
v1.2.0Linux,point in vehicle intertial frame
v1.2.0Linux,tranform to lidar frame
v1.2.0Linux,The above should be same as first transforming to vehicle-body frame and then to lidar frame
v1.2.0Linux,"Vector3r point_v_b = VectorMath::transformToBodyFrame(point_v_i, vehicle_pose, true);"
v1.2.0Linux,"point = VectorMath::transformToBodyFrame(point_v_b, lidar_pose, true);"
v1.2.0Linux,"On the client side, if it is needed to transform this data back to the world frame,"
v1.2.0Linux,"then do the equivalent of following,"
v1.2.0Linux,"Vector3r point_w = VectorMath::transformToWorldFrame(point, lidar_pose + vehicle_pose, true);"
v1.2.0Linux,See SimModeBase::drawLidarDebugPoints()
v1.2.0Linux,"TODO: Optimization -- instead of doing this for every point, it should be possible to do this"
v1.2.0Linux,for the point-cloud together? Need to look into matrix operations to do this together for all points.
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,update ray tracing
v1.2.0Linux,"FString hit_name = FString(""None"");"
v1.2.0Linux,if (dist_hit.GetActor())
v1.2.0Linux,hit_name=dist_hit.GetActor()->GetName();
v1.2.0Linux,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.2.0Linux,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,This assumes you are running DroneServer already on the same machine.
v1.2.0Linux,DroneServer must be running first.
v1.2.0Linux,enable API control
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,move commands
v1.2.0Linux,else leave as it is
v1.2.0Linux,TODO: get these in one call
v1.2.0Linux,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.2.0Linux,TODO: shouldn't we pass folder path?
v1.2.0Linux,parse
v1.2.0Linux,group the images by the current date.
v1.2.0Linux,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.2.0Linux,{
v1.2.0Linux,"return """";"
v1.2.0Linux,}
v1.2.0Linux,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.2.0Linux,{
v1.2.0Linux,return false;
v1.2.0Linux,}
v1.2.0Linux,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.2.0Linux,params.context->client.newTask();
v1.2.0Linux,}
v1.2.0Linux,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.2.0Linux,params.context->client.WaitForCompletion(0);
v1.2.0Linux,}
v1.2.0Linux,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.2.0Linux,{
v1.2.0Linux,}
v1.2.0Linux,parse command line
v1.2.0Linux,Shell callbacks
v1.2.0Linux,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.2.0Linux,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.2.0Linux,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.2.0Linux,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.2.0Linux,Add shell commands
v1.2.0Linux,TODO: add WaitForCompletion command
v1.2.0Linux,"TODO: add command line args help, arg count validation"
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,switch to explicit hover mode so that this is the fall back when
v1.2.0Linux,move* commands are finished.
v1.2.0Linux,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.2.0Linux,"Not implemented, just added for compilation."
v1.2.0Linux,Function pointers to hold the addresses of the functions that are defined in Unity
v1.2.0Linux,"Enabling all LogLevels,"
v1.2.0Linux,initialize state
v1.2.0Linux,compute our home point
v1.2.0Linux,these will be available for devices like steering wheels
v1.2.0Linux,update position from kinematics so we have latest position after physics update
v1.2.0Linux,kinematics_->update();
v1.2.0Linux,parameters in NED frame
v1.2.0Linux,allow teleportation
v1.2.0Linux,if collisions are not enabled
v1.2.0Linux,or we have collided but passthrough is enabled
v1.2.0Linux,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.2.0Linux,"without flip flopping, collisions can't be detected"
v1.2.0Linux,no default action in this base class
v1.2.0Linux,TODO: because this bug we are using alternative code with stringstream
v1.2.0Linux,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.2.0Linux,implements getImages() method in the ImageCaptureBase class.
v1.2.0Linux,update ray tracing
v1.2.0Linux,TODO: index check
v1.2.0Linux,Attempts to parse the settings text from one of multiple locations.
v1.2.0Linux,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.2.0Linux,"Next, check the executable's working directory for the settings file."
v1.2.0Linux,"Finally, check the user's documents folder."
v1.2.0Linux,"If the settings file cannot be read, throw an exception"
v1.2.0Linux,let base class setup physics world
v1.2.0Linux,stop physics thread before we dismantle
v1.2.0Linux,setup clock in ClockFactory
v1.2.0Linux,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.2.0Linux,steppable clock returns interval that is a constant number irrespective of wall clock
v1.2.0Linux,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.2.0Linux,but that would cause vehicles like quadrotors to become unstable
v1.2.0Linux,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.2.0Linux,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.2.0Linux,get increase in clock speed
v1.2.0Linux,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.2.0Linux,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.2.0Linux,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.2.0Linux,Approach 2: scale control loop frequency if clock is speeded up
v1.2.0Linux,"for slowing down, this don't generate instability"
v1.2.0Linux,-------------------------------- overrides -----------------------------------------------//
v1.2.0Linux,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.2.0Linux,create vehicle API
v1.2.0Linux,setup physics vehicle
v1.2.0Linux,initialize private vars
v1.2.0Linux,"if reset is pending then do it first, no need to do other things until next tick"
v1.2.0Linux,move collision info from rendering engine to vehicle
v1.2.0Linux,update rotor poses
v1.2.0Linux,if we did reset then don't worry about synchronizing states for this tick
v1.2.0Linux,Continue to wait for reset
v1.2.0Linux,*** Start: UpdatableState implementation ***//
v1.2.0Linux,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.2.0Linux,environment update for current position
v1.2.0Linux,update forces on vertices
v1.2.0Linux,update to controller must be done after kinematics have been updated by physics engine
v1.2.0Linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.2.0Linux,*** End: UpdatableState implementation ***//
v1.2.0Linux,these are called on render ticks
v1.2.0Linux,TODO: do we need this for cars?
v1.2.0Linux,Thrustmaster devices
v1.2.0Linux,"Anything else, typically Logitech G920 wheel"
v1.2.0Linux,Two steel levers behind wheel
v1.2.0Linux,if API-client control is not active then we route keyboard/joystick control to car
v1.2.0Linux,all car controls from anywhere must be routed through API component
v1.2.0Linux,*** Start: UpdatableState implementation ***//
v1.2.0Linux,physics tick
v1.2.0Linux,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.2.0Linux,*** End: UpdatableState implementation ***//
v1.2.0Linux,TODO: implement arming for car
v1.2.0Linux,remove everything that we created in BeginPlay
v1.2.0Linux,we use custom debug reporting for this class
v1.2.0Linux,perform any expensive rendering update outside of lock region
v1.2.0Linux,no need to call base reset because of our custom implementation
v1.2.0Linux,should be overridden by derived class
v1.2.0Linux,should be overridden by derived class
v1.2.0Linux,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.2.0Linux,default setup - this should be overridden in derived modes as needed
v1.2.0Linux,setup clock in ClockFactory
v1.2.0Linux,API server start/stop
v1.2.0Linux,determine camera director camera default pose and spawn it
v1.2.0Linux,derived class should override this method to retrieve types of pawns they support
v1.2.0Linux,derived class should override this method to retrieve types of pawns they support
v1.2.0Linux,60 acres park:
v1.2.0Linux,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.2.0Linux,marymoore park
v1.2.0Linux,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.2.0Linux,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.2.0Linux,DepthNavThreshold depthNav;
v1.2.0Linux,DepthNavOptAStar depthNav;
v1.2.0Linux,DepthNavThreshold depthNav;
v1.2.0Linux,DepthNavOptAStar depthNav;
v1.2.0Linux,Cleanup
v1.2.0Linux,runDepthNavGT();
v1.2.0Linux,runDepthNavSGM();
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,by Sudipta Sinha
v1.2.0Linux,adapted for AirSim by Matthias Mueller
v1.2.0Linux,first row
v1.2.0Linux,last row
v1.2.0Linux,Local quadratic fit of cost and subpixel refinement.
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,by Sudipta Sinha
v1.2.0Linux,adapted for AirSim by Matthias Mueller
v1.2.0Linux,uint64_t x64 = (uint64_t)x;
v1.2.0Linux,uint64_t y64 = (uint64_t)y;
v1.2.0Linux,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0Linux,Licensed under the MIT License.
v1.2.0Linux,by Sudipta Sinha
v1.2.0Linux,adapted for AirSim by Matthias Mueller
v1.2.0Linux,ensure that disparity range is a multiple of 8
v1.2.0Linux,sgm stereo
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,read settings and override defaults
v1.2.1,allow json overrides on a per-vehicle basis.
v1.2.1,start server in async mode
v1.2.1,check messages
v1.2.1,In settings.json first activate computer vision mode:
v1.2.1,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.1,monitor car state while you drive it manually.
v1.2.1,In settings.json first activate computer vision mode:
v1.2.1,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.1,"define abstract class to return next vector in the format (x,y,yaw)"
v1.2.1,"compute vector, distance and angle to goal"
v1.2.1,compute box of interest
v1.2.1,scale by weight matrix (optional)
v1.2.1,"img2d_box = np.multiply(img2d_box,w_mtx)"
v1.2.1,detect collision
v1.2.1,compute box of interest
v1.2.1,detect collision
v1.2.1,Same as above but decide to go left or right based on average or some metric like that
v1.2.1,"compute resultant normalized vector, distance and angle"
v1.2.1,compute bounding box size
v1.2.1,convert horizonal fov to vertical fov
v1.2.1,matrix with all ones
v1.2.1,matrix with max weight in center and decreasing linearly with distance from center
v1.2.1,matrix with max weight in center and decreasing quadratically with distance from center
v1.2.1,"print (""Saving images to %s"" % tmp_dir)"
v1.2.1,airsim.wait_key('Press any key to start')
v1.2.1,"Define start position, goal and size of UAV"
v1.2.1,Define parameters and thresholds
v1.2.1,initial position
v1.2.1,"predictControl = AvoidLeftIgonreGoal(hfov, coll_thres, yaw, limit_yaw, step)"
v1.2.1,time.sleep(1)
v1.2.1,get response
v1.2.1,get numpy array
v1.2.1,reshape array to 2D array H X W
v1.2.1,write to png
v1.2.1,"imsave(os.path.normpath(os.path.join(tmp_dir, ""depth_"" + str(z) + '.png')), generate_depth_viz(img2d,5))"
v1.2.1,pose = client.simGetPose()
v1.2.1,pp.pprint(pose)
v1.2.1,time.sleep(5)
v1.2.1,currently reset() doesn't work in CV mode. Below is the workaround
v1.2.1,################### OLD CODE
v1.2.1,timer = 0
v1.2.1,time_obs = 50
v1.2.1,bObstacle = False
v1.2.1,if (bObstacle):
v1.2.1,timer = timer + 1
v1.2.1,if timer > time_obs:
v1.2.1,bObstacle = False
v1.2.1,timer = 0
v1.2.1,else:
v1.2.1,yaw = target_angle
v1.2.1,"print (target_angle,target_vec,target_dist,x,y,goal[0],goal[1])"
v1.2.1,if (np.average(img2d_box) < coll_thres):
v1.2.1,"img2d_box_l = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)-50:int((w+roi_w)/2)-50]"
v1.2.1,"img2d_box_r = img2d_box = img2d[int((h-roi_h)/2):int((h+roi_h)/2),int((w-roi_w)/2)+50:int((w+roi_w)/2)+50]"
v1.2.1,"img2d_box_l_avg = np.average(np.multiply(img2d_box_l,w_mtx))"
v1.2.1,"img2d_box_r_avg = np.average(np.multiply(img2d_box_r,w_mtx))"
v1.2.1,"print('left: ', img2d_box_l_avg)"
v1.2.1,"print('right: ', img2d_box_r_avg)"
v1.2.1,if img2d_box_l_avg > img2d_box_r_avg:
v1.2.1,##Go LEFT
v1.2.1,#y_offset = y_offset-1
v1.2.1,yaw = yaw - radians(10)
v1.2.1,bObstacle = True
v1.2.1,else:
v1.2.1,##Go RIGHT
v1.2.1,#y_offset = y_offset+1
v1.2.1,yaw = yaw + radians(10)
v1.2.1,bObstacle = true
v1.2.1,"print('yaw: ', yaw)"
v1.2.1,In settings.json first activate computer vision mode:
v1.2.1,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.1,currently reset() doesn't work in CV mode. Below is the workaround
v1.2.1,In settings.json first activate computer vision mode:
v1.2.1,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.1,requires Python 3.5.3 :: Anaconda 4.4.0
v1.2.1,pip install opencv-python
v1.2.1,In settings.json first activate computer vision mode:
v1.2.1,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.1,for block environment
v1.2.1,regex are case insensitive
v1.2.1,#for neighborhood environment
v1.2.1,set object ID for sky
v1.2.1,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.2.1,get segmentation image in various formats
v1.2.1,save segmentation images in various formats
v1.2.1,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.2.1,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.2.1,"airsim.write_png(os.path.normpath(filename + '.numpy.png'), img_rgba) #write to png"
v1.2.1,find unique colors
v1.2.1,In settings.json first activate computer vision mode:
v1.2.1,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.1,objects can be named in two ways:
v1.2.1,"1. In UE Editor, select and object and change its name to something else. Note that you must *change* its name because"
v1.2.1,default name is auto-generated and varies from run-to-run.
v1.2.1,"2. OR you can do this: In UE Editor select the object and then go to ""Actor"" section, click down arrow to see ""Tags"" property and add a tag there."
v1.2.1,
v1.2.1,The simGetObjectPose and simSetObjectPose uses first object that has specified name OR tag.
v1.2.1,more info: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.2.1,https://answers.unrealengine.com/revisions/790629.html
v1.2.1,below works in Blocks environment
v1.2.1,------------------------------------ Get current pose ------------------------------------------------
v1.2.1,search object by name:
v1.2.1,search another object by tag
v1.2.1,search non-existent object
v1.2.1,------------------------------------ Set new pose ------------------------------------------------
v1.2.1,here we move with teleport enabled so collisions are ignored
v1.2.1,here we move with teleport enabled so collisions are not ignored
v1.2.1,move non-existent object
v1.2.1,------------------------------------ Get new pose ------------------------------------------------
v1.2.1,search another object by tag
v1.2.1,search non-existent object
v1.2.1,Import this module to automatically setup path to local airsim module
v1.2.1,This module first tries to see if airsim module is installed via pip
v1.2.1,If it does then we don't do anything else
v1.2.1,Else we look up grand-parent folder to see if it has airsim folder
v1.2.1,and if it does then we add that in sys.path
v1.2.1,this class simply tries to see if airsim
v1.2.1,if airsim module is installed then don't do anything else
v1.2.1,import pkgutil
v1.2.1,airsim_loader = pkgutil.find_loader('airsim')
v1.2.1,if airsim_loader is not None:
v1.2.1,return
v1.2.1,This script expects object available in UE environment of type AAirSimCharater
v1.2.1,In settings.json first activate computer vision mode:
v1.2.1,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.1,airsim.wait_key('Press any key to set face expression')
v1.2.1,"client.simCharSetFaceExpression(""BlendShapeNode_Smile"", 1);"
v1.2.1,In settings.json first activate computer vision mode:
v1.2.1,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.1,xn = 1 + x*5  # some random number
v1.2.1,currently reset() doesn't work in CV mode. Below is the workaround
v1.2.1,connect to the AirSim simulator
v1.2.1,monitor car state while you drive it manually.
v1.2.1,get state of the car
v1.2.1,connect to the AirSim simulator
v1.2.1,connect to the AirSim simulator
v1.2.1,go forward
v1.2.1,get state of the car
v1.2.1,import gym #pip install gym
v1.2.1,Local variable access is faster in loops
v1.2.1,"if not wrapping over current pointer,"
v1.2.1,then check if there is terminal state wrapped inside
v1.2.1,"If index > history_length, take from a slice"
v1.2.1,Metrics accumulator
v1.2.1,Action Value model (used by agent to interact with the environment)
v1.2.1,"Target model used to compute the target Q-values in training, updated"
v1.2.1,less frequently for increased stability.
v1.2.1,Function computing Q-values targets as part of the computation graph
v1.2.1,"Define the loss, using Huber Loss (more robust to outliers)"
v1.2.1,Compute the q_targets
v1.2.1,actions is a 1-hot encoding of the action done by the agent
v1.2.1,Define training criterion as the Huber Loss function
v1.2.1,Adam based SGD
v1.2.1,self._trainer.restore_from_checkpoint('models/oldmodels/model800000')
v1.2.1,Append the state to the short term memory (ie. History)
v1.2.1,"If policy requires agent to explore, sample random action"
v1.2.1,Use the network to output the best action
v1.2.1,Append batch axis with only one sample to evaluate
v1.2.1,Return the value maximizing the expected reward
v1.2.1,Keep track of interval action counter
v1.2.1,"If done, reset short term memory (ie. History)"
v1.2.1,Plot the metrics through Tensorboard and reset buffers
v1.2.1,Reset the short term memory
v1.2.1,Append to long term memory
v1.2.1,Update the Target Network if needed
v1.2.1,print(dist)
v1.2.1,Make RL agent
v1.2.1,Train
v1.2.1,connect to the AirSim simulator
v1.2.1,get state of the car
v1.2.1,go forward
v1.2.1,Go forward + steer right
v1.2.1,go reverse
v1.2.1,apply breaks
v1.2.1,get camera images from the car
v1.2.1,restore to original state
v1.2.1,connect to the AirSim simulator
v1.2.1,go forward
v1.2.1,Python client example to get Lidar data from a car
v1.2.1,
v1.2.1,Makes the drone fly and get Lidar data
v1.2.1,connect to the AirSim simulator
v1.2.1,"print(""state: %s"" % s)"
v1.2.1,go forward
v1.2.1,Go forward + steer right
v1.2.1,"reshape array of floats to array of [X,Y,Z]"
v1.2.1,TODO
v1.2.1,main
v1.2.1,connect to the AirSim simulator
v1.2.1,get state of the car
v1.2.1,go forward
v1.2.1,Go forward + steer right
v1.2.1,go reverse
v1.2.1,apply breaks
v1.2.1,restore to original state
v1.2.1,connect to the AirSim simulator
v1.2.1,get camera images from the car
v1.2.1,that's enough fun for now. let's quit cleanly
v1.2.1,Import this module to automatically setup path to local airsim module
v1.2.1,This module first tries to see if airsim module is installed via pip
v1.2.1,If it does then we don't do anything else
v1.2.1,Else we look up grand-parent folder to see if it has airsim folder
v1.2.1,and if it does then we add that in sys.path
v1.2.1,this class simply tries to see if airsim
v1.2.1,if airsim module is installed then don't do anything else
v1.2.1,import pkgutil
v1.2.1,airsim_loader = pkgutil.find_loader('airsim')
v1.2.1,if airsim_loader is not None:
v1.2.1,return
v1.2.1,Use below in settings.json with blocks environment
v1.2.1,connect to the AirSim simulator
v1.2.1,get state of the car
v1.2.1,go forward
v1.2.1,go reverse
v1.2.1,apply breaks
v1.2.1,get camera images from the car
v1.2.1,restore to original state
v1.2.1,from keras.models import load_model
v1.2.1,if (len(sys.argv) != 2):
v1.2.1,print('usage: python drive.py <modelName>')
v1.2.1,sys.exit()
v1.2.1,print('Loading model...')
v1.2.1,model = load_model(sys.argv[1])
v1.2.1,connect to the AirSim simulator
v1.2.1,image_buf[0] = get_image()
v1.2.1,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.2.1,"model_output = model.predict([image_buf, state_buf])"
v1.2.1,car_controls.steering = float(model_output[0][0])
v1.2.1,!/usr/bin/env python
v1.2.1,connect to the AirSim simulator
v1.2.1,start = time.time()
v1.2.1,get state of the car
v1.2.1,milliseconds = (time.time() - start) * 1000
v1.2.1,populate PoseStamped ros message
v1.2.1,log PoseStamped message
v1.2.1,publish PoseStamped message
v1.2.1,sleeps until next cycle
v1.2.1,!/usr/bin/env python
v1.2.1,Example ROS node for publishing AirSim images.
v1.2.1,AirSim Python API
v1.2.1,ROS Image message
v1.2.1,connect to the AirSim simulator
v1.2.1,get camera images from the car
v1.2.1,Populate image message
v1.2.1,log time and size of published image
v1.2.1,publish image message
v1.2.1,sleep until next cycle
v1.2.1,!/usr/bin/env python
v1.2.1,Example ROS node for publishing AirSim images.
v1.2.1,ROS Image message
v1.2.1,connect to the AirSim simulator
v1.2.1,get camera images from the car
v1.2.1,Populate image message
v1.2.1,log time and size of published image
v1.2.1,publish image message
v1.2.1,sleep until next cycle
v1.2.1,Import this module to automatically setup path to local airsim module
v1.2.1,This module first tries to see if airsim module is installed via pip
v1.2.1,If it does then we don't do anything else
v1.2.1,Else we look up grand-parent folder to see if it has airsim folder
v1.2.1,and if it does then we add that in sys.path
v1.2.1,this class simply tries to see if airsim
v1.2.1,if airsim module is installed then don't do anything else
v1.2.1,import pkgutil
v1.2.1,airsim_loader = pkgutil.find_loader('airsim')
v1.2.1,if airsim_loader is not None:
v1.2.1,return
v1.2.1,connect to the AirSim simulator
v1.2.1,connect to the AirSim simulator
v1.2.1,MultirotorClient.wait_key('Press any key to takeoff')
v1.2.1,Local variable access is faster in loops
v1.2.1,"if not wrapping over current pointer,"
v1.2.1,then check if there is terminal state wrapped inside
v1.2.1,"If index > history_length, take from a slice"
v1.2.1,Metrics accumulator
v1.2.1,Action Value model (used by agent to interact with the environment)
v1.2.1,"Target model used to compute the target Q-values in training, updated"
v1.2.1,less frequently for increased stability.
v1.2.1,Function computing Q-values targets as part of the computation graph
v1.2.1,"Define the loss, using Huber Loss (more robust to outliers)"
v1.2.1,Compute the q_targets
v1.2.1,actions is a 1-hot encoding of the action done by the agent
v1.2.1,Define training criterion as the Huber Loss function
v1.2.1,Adam based SGD
v1.2.1,Append the state to the short term memory (ie. History)
v1.2.1,"If policy requires agent to explore, sample random action"
v1.2.1,Use the network to output the best action
v1.2.1,Append batch axis with only one sample to evaluate
v1.2.1,Return the value maximizing the expected reward
v1.2.1,Keep track of interval action counter
v1.2.1,"If done, reset short term memory (ie. History)"
v1.2.1,Plot the metrics through Tensorboard and reset buffers
v1.2.1,Reset the short term memory
v1.2.1,Append to long term memory
v1.2.1,Update the Target Network if needed
v1.2.1,print(dist)
v1.2.1,connect to the AirSim simulator
v1.2.1,Make RL agent
v1.2.1,Train
v1.2.1,connect to the AirSim simulator
v1.2.1,get camera images from the car
v1.2.1,that's enough fun for now. let's quit cleanly
v1.2.1,use open cv to create point cloud from depth image.
v1.2.1,###########################################
v1.2.1,######### This is work in progress! #######
v1.2.1,###########################################
v1.2.1,file will be saved in PythonClient folder (i.e. same folder as script)
v1.2.1,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.2.1,skip it
v1.2.1,AirSim uses NED coordinates so negative axis is up.
v1.2.1,z of -7 is 7 meters above the original launch point.
v1.2.1,Fly given velocity vector for 5 seconds
v1.2.1,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.2.1,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.2.1,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.2.1,Make the drone fly in a circle.
v1.2.1,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.2.1,check that our home position is stable
v1.2.1,AirSim uses NED coordinates so negative axis is up.
v1.2.1,ramp up time
v1.2.1,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.2.1,compute current angle
v1.2.1,compute lookahead
v1.2.1,if we did the takeoff then also do the landing.
v1.2.1,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.2.1,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.2.1,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.2.1,ignore the click over from 360 back to 0
v1.2.1,watch direction this diff is moving if it switches from shrinking to growing
v1.2.1,then we passed the starting point.
v1.2.1,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.2.1,AirSim uses NED coordinates so negative axis is up.
v1.2.1,z of -7 is 7 meters above the original launch point.
v1.2.1,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.2.1,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.2.1,change clock speed in settings.json
v1.2.1,"""ClockSpeed"": 0.5"
v1.2.1,connect to the AirSim simulator
v1.2.1,that's enough fun for now. let's quit cleanly
v1.2.1,In settings.json first activate computer vision mode:
v1.2.1,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.1,requires Python 3.5.3 :: Anaconda 4.4.0
v1.2.1,pip install opencv-python
v1.2.1,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.2.1,Python client example to get Lidar data from a drone
v1.2.1,
v1.2.1,Makes the drone fly and get Lidar data
v1.2.1,connect to the AirSim simulator
v1.2.1,"print(""state: %s"" % s)"
v1.2.1,"print(""state: %s"" % pprint.pformat(state))"
v1.2.1,"reshape array of floats to array of [X,Y,Z]"
v1.2.1,TODO
v1.2.1,main
v1.2.1,connect to the AirSim simulator
v1.2.1,AirSim uses NED coordinates so negative axis is up.
v1.2.1,let it settle there a bit.
v1.2.1,now compute the survey path required to fill the box
v1.2.1,Use below in settings.json with Blocks environment
v1.2.1,connect to the AirSim simulator
v1.2.1,get camera images from the car
v1.2.1,that's enough fun for now. let's quit cleanly
v1.2.1,connect to the AirSim simulator
v1.2.1,Import this module to automatically setup path to local airsim module
v1.2.1,This module first tries to see if airsim module is installed via pip
v1.2.1,If it does then we don't do anything else
v1.2.1,Else we look up grand-parent folder to see if it has airsim folder
v1.2.1,and if it does then we add that in sys.path
v1.2.1,this class simply tries to see if airsim
v1.2.1,if airsim module is installed then don't do anything else
v1.2.1,import pkgutil
v1.2.1,airsim_loader = pkgutil.find_loader('airsim')
v1.2.1,if airsim_loader is not None:
v1.2.1,return
v1.2.1,"this script moves the drone to a location, then rests it thousands of time"
v1.2.1,purpose of this script is to stress test reset API
v1.2.1,connect to the AirSim simulator
v1.2.1,that's enough fun for now. let's quite cleanly
v1.2.1,use open cv to show new images from AirSim
v1.2.1,requires Python 3.5.3 :: Anaconda 4.4.0
v1.2.1,pip install opencv-python
v1.2.1,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.2.1,get depth image
v1.2.1,"this will return png width= 256, height= 144"
v1.2.1,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.2.1,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.2.1,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.2.1,to get an estimate of distance.
v1.2.1,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.2.1,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.2.1,an angular delta of the following pi/10.
v1.2.1,This constant is used as an upper bound  for normalizing the car's speed to be between 0 and 1
v1.2.1,Remove alpha channel if exists
v1.2.1,"compute average steering over 3 consecutive recorded images, this will serve as the label"
v1.2.1,"Data is expected to be a dict of <image: (label, previousious_state)>"
v1.2.1,Flatten and yield as tuple
v1.2.1,Initialize a resizable dataset to hold the output
v1.2.1,Resize the dataset to accommodate the next chunk of rows
v1.2.1,Create the next chunk
v1.2.1,Increment the row count
v1.2.1,Arguments
v1.2.1,Returns
v1.2.1,use composition of homographies
v1.2.1,to generate final transform that needs to be applied
v1.2.1,Arguments
v1.2.1,Returns
v1.2.1,Keeps under lock only the mechanism which advances
v1.2.1,the indexing of each batch.
v1.2.1,The transformation of images is not under thread lock
v1.2.1,so it can be done in parallel
v1.2.1,Trained model path
v1.2.1,Connect to AirSim
v1.2.1,Start driving
v1.2.1,Initialize image buffer
v1.2.1,Update throttle value according to steering angle
v1.2.1,Prediction
v1.2.1,"Rescale prediction to [-1,1] and factor by 0.82 for drive smoothness"
v1.2.1,Print progress
v1.2.1,Update next car state
v1.2.1,Wait a bit between iterations
v1.2.1,%matplotlib inline
v1.2.1,chunk size for training batches
v1.2.1,"No test set needed, since testing in our case is running the model on an unseen map in AirSim"
v1.2.1,Point this to the directory containing the raw data
v1.2.1,Point this to the desired output directory for the cooked (.h5) data
v1.2.1,Choose The folders to search for data under RAW_DATA_DIR
v1.2.1,"if COOK_ALL_DATA is set to False, append your desired data folders here"
v1.2.1,data_folder.append('folder_name1')
v1.2.1,data_folder.append('folder_name2')
v1.2.1,...
v1.2.1,Hyper-parameters
v1.2.1,Activation functions
v1.2.1,"Stop training if in the last 20 epochs, there was no change of the best recorded validation loss"
v1.2.1,<< The directory containing the cooked data from the previous step >>
v1.2.1,<< The directory in which the model output will be placed >>
v1.2.1,"Use ROI of [78,144,27,227] for FOV 60 with Formula car"
v1.2.1,Network definition
v1.2.1,Import this module to automatically setup path to local airsim module
v1.2.1,This module first tries to see if airsim module is installed via pip
v1.2.1,If it does then we don't do anything else
v1.2.1,Else we look up grand-parent folder to see if it has airsim folder
v1.2.1,and if it does then we add that in sys.path
v1.2.1,this class simply tries to see if airsim
v1.2.1,if airsim module is installed then don't do anything else
v1.2.1,import pkgutil
v1.2.1,airsim_loader = pkgutil.find_loader('airsim')
v1.2.1,if airsim_loader is not None:
v1.2.1,return
v1.2.1,DEY: I don't know why this was there.
v1.2.1,data = np.flipud(data)
v1.2.1,-----------------------------------  Common vehicle APIs ---------------------------------------------
v1.2.1,basic flight control
v1.2.1,camera control
v1.2.1,simGetImage returns compressed png in array of bytes
v1.2.1,image_type uses one of the ImageType members
v1.2.1,"todo: in future remove below, it's only for compatibility to pre v1.2"
v1.2.1,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.2.1,camera control
v1.2.1,simGetImage returns compressed png in array of bytes
v1.2.1,image_type uses one of the ImageType members
v1.2.1,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.2.1,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.2.1,lidar APIs
v1.2.1,----------- APIs to control ACharacter in scene ----------/
v1.2.1,legacy handling
v1.2.1,TODO: remove below legacy wrappers in future major releases
v1.2.1,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.2.1,APIs for control
v1.2.1,query vehicle state
v1.2.1,-----------------------------------  Car APIs ---------------------------------------------
v1.2.1,helper method for converting getOrientation to roll/pitch/yaw
v1.2.1,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.2.1,roll (x-axis rotation)
v1.2.1,pitch (y-axis rotation)
v1.2.1,yaw (z-axis rotation)
v1.2.1,DEY: I don't know why this was there.
v1.2.1,data = np.flipud(data)
v1.2.1,reverse the vertical line order and add null bytes at the start
v1.2.1,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.2.1,return cls(**msgpack.unpack(encoded))
v1.2.1,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.2.1,"in header only mode, control library is not available"
v1.2.1,if using Unreal Build system then include precompiled header file first
v1.2.1,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.2.1,"Windows, OSX and Linux."
v1.2.1,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.2.1,Windows users can move the Documents folder to any location they want
v1.2.1,SHGetFolderPath knows how to find it.
v1.2.1,fall back in case SHGetFolderPath failed for some reason.
v1.2.1,convert from std::path '/' to windows backslash.
v1.2.1,make the current thread run with maximum priority.
v1.2.1,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.2.1,TODO: How to handle POSIX thread priorities on OSX?
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.2.1,
v1.2.1,Treat all errors as failure conditions.
v1.2.1,parse command line
v1.2.1,"motive gives a weird error if the project is not found, so we look for it."
v1.2.1,Do an update to pick up any recently-arrived cameras.
v1.2.1,List all detected cameras.
v1.2.1,List all defined rigid bodies.
v1.2.1,throttle to 50 messages per second.
v1.2.1,OptiTrack uses 'y' axis for vertical.
v1.2.1,stdafx.cpp : source file that includes just the standard includes
v1.2.1,MavlinkMoCap.pch will be the pre-compiled header
v1.2.1,stdafx.obj will contain the pre-compiled type information
v1.2.1,TODO: reference any additional headers you need in STDAFX.H
v1.2.1,and not in this file
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,PX4.cpp : Defines the entry point for the console application.
v1.2.1,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.2.1,how do you write to the debug output windows on Unix ?
v1.2.1,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.2.1,connection to create to talke to that server.
v1.2.1,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.2.1,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.2.1,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.2.1,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.2.1,using their the -qgc option.
v1.2.1,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.2.1,this switch controls whether we turn off the RC remote active link loss detection
v1.2.1,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.2.1,from kicking in when you try and fly.
v1.2.1,can't use experimental stuff on Linux because of potential ABI issues
v1.2.1,parse the json
v1.2.1,flatten inner mavlink object
v1.2.1,flatten inner mavlink object
v1.2.1,todo
v1.2.1,todo
v1.2.1,"const char* outLogFileOption = ""outlogfile"";"
v1.2.1,parse command line
v1.2.1,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.2.1,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.2.1,"no local serial connection, so this is the primary droneConnection."
v1.2.1,failed to connect
v1.2.1,"local connection, then we own sending the heartbeat."
v1.2.1,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.2.1,cmdTable.push_back(new AltHoldCommand());
v1.2.1,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.2.1,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.2.1,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.2.1,this stops us from being able to connect to SITL mode PX4.
v1.2.1,checkPulse();
v1.2.1,add command text in log
v1.2.1,close previous command.
v1.2.1,FilterLogFiles(logDirectory);
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,send a heartbeat
v1.2.1,accept one incoming connection
v1.2.1,send a heartbeat to the client
v1.2.1,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.2.1,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.2.1,for this unit test we are expecting a request to send an image.
v1.2.1,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.2.1,hmmm
v1.2.1,================ ls
v1.2.1,================ put file
v1.2.1,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.2.1,================ get file
v1.2.1,verify the file contents.
v1.2.1,================ remove file
v1.2.1,================ make directory
v1.2.1,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.2.1,================ remove directory
v1.2.1,Now verification
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,from main.cpp.
v1.2.1,you must call this method if you want HandleMessage to be called subsequently.
v1.2.1,treat literals as one word
v1.2.1,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.2.1,request gps info
v1.2.1,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.2.1,find relative position since command start so we can compare two commands better
v1.2.1,TODO: make below future proof (i.e. usable by C++17 compiler) - also change same in main.cpp
v1.2.1,can't use experimental stuff on Linux because of potential ABI issues
v1.2.1,"these PID values are important, so set these to match"
v1.2.1,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.2.1,we can skip ahead.
v1.2.1,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.2.1,TODO: avoid passing hadcoded HIL flag
v1.2.1,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.2.1,"The global position, as returned by the Global Positioning System (GPS)."
v1.2.1,Provides state for additional features
v1.2.1,The general system state
v1.2.1,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.2.1,Provides state for additional features
v1.2.1,The general system state
v1.2.1,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.2.1,Provides state for additional features
v1.2.1,The general system state
v1.2.1,Provides state for additional features
v1.2.1,The general system state
v1.2.1,note: we do not reset com when Close() is called because we want to keep running.
v1.2.1,"user has to invoke ""hil stop"" to stop the hil thread."
v1.2.1,generate random between 0 and 1
v1.2.1,move to range -1 to 1
v1.2.1,scale it
v1.2.1,apply iy
v1.2.1,wait for the Execute method to be called.
v1.2.1,gps is much slower frequency than IMU.
v1.2.1,MAVLINK_MSG_ID_HIL_GPS
v1.2.1,disable MAV_USEHILGPS
v1.2.1,note: we do not reset com when Close() is called because we want to keep running.
v1.2.1,"user has to invoke ""hil stop"" to stop the hil thread."
v1.2.1,generate random between 0 and 1
v1.2.1,move to range -1 to 1
v1.2.1,scale it
v1.2.1,apply iy
v1.2.1,wait for the Execute method to be called.
v1.2.1,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.2.1,gps is much slower frequency than IMU.
v1.2.1,MAVLINK_MSG_ID_HIL_GPS
v1.2.1,disable HIL mode
v1.2.1,Enumeration of landed detector states
v1.2.1,MAV landed state is unknown
v1.2.1,MAV is landed (on ground)
v1.2.1,MAV is in air
v1.2.1,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.2.1,The filtered local position
v1.2.1,must send these regularly to keep offboard control.
v1.2.1,"ok, now we can safely switch to loiter."
v1.2.1,must send these regularly to keep offboard control.
v1.2.1,integrate the heading so it is smoother.
v1.2.1,must send these regularly to keep offboard control.
v1.2.1,integrate the heading so it is smoother.
v1.2.1,fly to radius
v1.2.1,it takes about 10 cm to stop and turn.
v1.2.1,next time around switch to orbiting!
v1.2.1,heading points to center of circle.
v1.2.1,interpoloate the speed ramp up time over 2 seconds from start time
v1.2.1,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.2.1,monitor the sin curves so we can see how on track or off track it actually is.
v1.2.1,the shape of the curve will also tell us if we are progressing at a consistent
v1.2.1,"speed, the more deformed the sin curve the worse our progress."
v1.2.1,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.2.1,degrees just flipped from 359 to 0.
v1.2.1,this enables us to test what happens when offboard control is lost and resumed.
v1.2.1,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.2.1,"ok, now we can start moving by velocity"
v1.2.1,recompute to new target.
v1.2.1,start by moving right with 10 degree roll.
v1.2.1,haven't started yet.
v1.2.1,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.2.1,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.2.1,track how our actual pitch is coming along compared to our target
v1.2.1,and check position
v1.2.1,the amount of pitch should depend on our speed in that direction.
v1.2.1,passed the midpoint.
v1.2.1,fade out the pitch as we pick up speed so we don't overshoot.
v1.2.1,see if we just crossed the wiggle distance threshold.
v1.2.1,(pitch affects the x-position).
v1.2.1,reverse direction with a -30 degrees quick stop
v1.2.1,reverse direction with a 30 degrees quick stop
v1.2.1,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.2.1,too much in that direction.
v1.2.1,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.2.1,track how our actual roll is coming along compared to our target
v1.2.1,and check position
v1.2.1,the amount of roll should depend on our speed in that direction.
v1.2.1,passed the midpoint.
v1.2.1,fade out the roll as we pick up speed so we don't overshoot.
v1.2.1,see if we just crossed the wiggle distance threshold.
v1.2.1,(roll affects the y-position).
v1.2.1,reverse direction with a -30 degrees quick stop
v1.2.1,reverse direction with a 30 degrees quick stop
v1.2.1,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.2.1,too much in that direction.
v1.2.1,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.2.1,for testing PID controller.
v1.2.1,class AltHoldCommand : public Command
v1.2.1,{
v1.2.1,std::shared_ptr<MavLinkVehicle> channel;
v1.2.1,"float sx_, sy_, sz_;"
v1.2.1,MavLinkAttitudeTarget _current;
v1.2.1,PidController thrust_controller_;
v1.2.1,public:
v1.2.1,this->sz_ = pos.z; // user defined target.
v1.2.1,move to local position keeps the offboard control happy.
v1.2.1,haven't started yet.
v1.2.1,and check position
v1.2.1,double dx = this->sx_ - pos.x;
v1.2.1,double dy = this->sy_ - pos.y;
v1.2.1,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.2.1,too much in that direction.
v1.2.1,adjust thrust so we keep steady height target
v1.2.1,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.2.1,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.2.1,local remote
v1.2.1,already handled by the parse method.
v1.2.1,we only support very simple patterns for now.
v1.2.1,each wildcard must be separated by literal.
v1.2.1,back to back wildcards with no literal in between is too complex.
v1.2.1,"we only support simple matching for now, we can add full regex later if we need it."
v1.2.1,yep!
v1.2.1,'*' is done we found the next matching char
v1.2.1,this is ok.
v1.2.1,this is an ERASE_END_LINE command which we ignore.
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,unpack the message...
v1.2.1,pack the payload buffer.
v1.2.1,"json can't handle ""nan"", so we convert it to null."
v1.2.1,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.2.1,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,start listening to this connection
v1.2.1,Send heartbeat to drone.  You should not do this if some other node is
v1.2.1,already doing it.
v1.2.1,stop listening to the connection.
v1.2.1,get the connection
v1.2.1,Get the local system and component id
v1.2.1,send a command to the remote node
v1.2.1,MavLinkNode::MavLinkNode() = default;
v1.2.1,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.2.1,decrementing the count so the next WaitOne may block.
v1.2.1,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.2.1,convert to absolute time.
v1.2.1,use mach_timespec
v1.2.1,convert to absolute time.
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,return true if we still have offboard control (can lose this if user flips the switch).
v1.2.1,MavLinkVehicle::MavLinkVehicle() = default;
v1.2.1,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.2.1,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,============================== CLIENT ============================================
v1.2.1,image APIs
v1.2.1,or if you are implementing the client side call this function to get the most recent frame.
v1.2.1,returns false if there is no new frame available.
v1.2.1,============================== SERVER ============================================
v1.2.1,call this to send the image back over the connection given to start function.
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,"log every message that is ""sent"" using sendMessage."
v1.2.1,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.2.1,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.2.1,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.2.1,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,for compatibility with QGroundControl we have to save the time field in big endian.
v1.2.1,todo: mavlink2 support?
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,start listening to this connection
v1.2.1,Send heartbeat to drone.  You should not do this if some other node is
v1.2.1,already doing it.
v1.2.1,send a heart beat so that the remote node knows we are still alive
v1.2.1,(otherwise drone will trigger a failsafe operation).
v1.2.1,this is called for all messages received on the connection.
v1.2.1,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.2.1,subclasses remembering to call this base implementation.
v1.2.1,stop listening to the connection.
v1.2.1,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.2.1,wait for a heartbeat msg since this will give us the port to send commands to...
v1.2.1,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.2.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.1,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.2.1,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.2.1,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.2.1,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.2.1,"ok, now fetch the missing parameters."
v1.2.1,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.2.1,silently fail since we are on a background thread here...
v1.2.1,tell the caller this is complete.
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,add our custom telemetry message length.
v1.2.1,todo: if we support signing then initialize
v1.2.1,mavlink_intermediate_status_.signing callbacks
v1.2.1,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.2.1,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.2.1,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.2.1,send this right away just in case serial link is not already configured
v1.2.1,"log every message that is ""sent"" using sendMessage."
v1.2.1,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.2.1,pack the payload buffer.
v1.2.1,calculate checksum
v1.2.1,form the header as a byte array for the crc
v1.2.1,these macros use old style cast.
v1.2.1,forward messages from our connected node to the remote proxy.
v1.2.1,forward messages from remote proxy to local connected node
v1.2.1,CurrentThread::setMaximumPriority();
v1.2.1,"hmmm, wait till it is opened?"
v1.2.1,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.2.1,pick up the sysid/compid of the remote node we are connected to.
v1.2.1,then this is a mavlink 1 message
v1.2.1,then this mavlink sender supports mavlink 2
v1.2.1,queue event for publishing.
v1.2.1,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.2.1,as it ensures we don't lose messages if the listener is slow.
v1.2.1,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.2.1,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.2.1,we would get a deadlock.
v1.2.1,CurrentThread::setMaximumPriority();
v1.2.1,reset counters
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,------------------------------------------------------------------------------
v1.2.1,Defines
v1.2.1,------------------------------------------------------------------------------
v1.2.1,bit number  876543210987654321
v1.2.1,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.2.1,in future it would be good to have ability to add system IDs we are interested in
v1.2.1,if (msg.sysid != getTargetSystemId())
v1.2.1,{
v1.2.1,// we only care about messages from our intended remote node.
v1.2.1,return;
v1.2.1,}
v1.2.1,user may have changed modes on us! So we need to honor that and not
v1.2.1,try and take it back.
v1.2.1,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.2.1,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.2.1,we can store up to 16 channels in rc_channels_scaled.
v1.2.1,The RAW values of the servo outputs
v1.2.1,Metrics typically displayed on a HUD for fixed wing aircraft
v1.2.1,The IMU readings in SI units in NED body frame
v1.2.1,printSystemStatus(&msg);
v1.2.1,todo: use this to determine when we need to do emergency landing...
v1.2.1,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.2.1,Provides state for additional features
v1.2.1,The general system state
v1.2.1,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.2.1,but we do want to know when we get the ack.  So this is async ACK processing!
v1.2.1,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.2.1,if threshold < 0 then the threshold is inverted.
v1.2.1,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.2.1,Convert it to a floating point number between -1 and 1.
v1.2.1,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.2.1,until the move commands start happening.
v1.2.1,return true if user calls requestControl and has not called releaseControl.
v1.2.1,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.2.1,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.2.1,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.2.1,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.2.1,send a few to make sure it gets through...
v1.2.1,now the command should succeed.
v1.2.1,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.2.1,us by which time the PX4 times out offboard mode!!
v1.2.1,this mode change take precedence over offboard mode.
v1.2.1,thrust must be between -1 and 1.
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,These definitions are copied from PX4 implementation
v1.2.1,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.2.1,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.2.1,/ @brief Command opcodes
v1.2.1,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.2.1,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.2.1,must trim trailing slashes so PX4 doesn't hang!
v1.2.1,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.2.1,from the source.
v1.2.1,check if directory exists.
v1.2.1,perfect.
v1.2.1,use last_message_ so we preserve the sessionid.
v1.2.1,"could not create the local file, so stop."
v1.2.1,must use last_message_ so we preserve the session id.
v1.2.1,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.2.1,todo: error handling here? sequence is out of order...
v1.2.1,"directory must be empty then, can't do nextStep because"
v1.2.1,it will just loop for ever re-requesting zero offset into
v1.2.1,empty directory.
v1.2.1,result should be a list of null terminated file names.
v1.2.1,skipping this entry
v1.2.1,remove the file size field.
v1.2.1,"printf(""%s\n"", name.c_str());"
v1.2.1,request the next batch.
v1.2.1,"perhaps this was a late response after we did a retry, so ignore it."
v1.2.1,"perhaps this was a late response after we did a retry, so ignore it."
v1.2.1,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.2.1,reached the end of the list or the file.
v1.2.1,end of file or directory listing.
v1.2.1,"success, data should be following..."
v1.2.1,ack on this cmd is a noop
v1.2.1,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.2.1,give up then.
v1.2.1,tell watchdog we are sending a request
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,================================= CLIENT ==============================================================
v1.2.1,Check if we have a valid transaction
v1.2.1,emit signal if all packets arrived
v1.2.1,Restart statemachine
v1.2.1,image APIs
v1.2.1,================================= SERVER ==============================================================
v1.2.1,Prepare and send acknowledgment packet
v1.2.1,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.2.1,Send ENCAPSULATED_IMAGE packet
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.2.1,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.2.1,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.2.1,send this right away just in case serial link is not already configured
v1.2.1,CurrentThread::setMaximumPriority();
v1.2.1,"hmmm, wait till it is opened?"
v1.2.1,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.2.1,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.2.1,queue event for publishing.
v1.2.1,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.2.1,as it ensures we don't lose messages if the listener is slow.
v1.2.1,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.2.1,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.2.1,we would get a deadlock.
v1.2.1,CurrentThread::setMaximumPriority();
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.2.1,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.2.1,parse out the VID number
v1.2.1,now the PID
v1.2.1,parse out the VID number
v1.2.1,examples:
v1.2.1,PX4: USB\VID_26AC&PID_0011\0
v1.2.1,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.2.1,"printf(""Found: %S\n"", buffer.c_str());"
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.2.1,parse out the VID number
v1.2.1,now the PID
v1.2.1,parse out the VID number
v1.2.1,suppress
v1.2.1,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,This has not been properly tested
v1.2.1,struct iw_statistics stats;
v1.2.1,struct iwreq req;
v1.2.1,"memset(&stats, 0, sizeof(stats));"
v1.2.1,"memset(&req, 0, sizeof(iwreq));"
v1.2.1,
v1.2.1,"strncpy(req.ifr_name, ifaceName, 16);"
v1.2.1,req.u.data.pointer = &stats;
v1.2.1,req.u.data.length = sizeof(iw_statistics);
v1.2.1,
v1.2.1,#ifdef CLEAR_UPDATED
v1.2.1,req.u.data.flags = 1;
v1.2.1,#endif
v1.2.1,
v1.2.1,/* Perform the ioctl */
v1.2.1,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.2.1,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.2.1,return -127;
v1.2.1,}
v1.2.1,
v1.2.1,return stats.qual.level;
v1.2.1,todo: windows version of this...
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,windows
v1.2.1,Need to link with Ws2_32.lib
v1.2.1,posix
v1.2.1,found it!
v1.2.1,bind socket to local address.
v1.2.1,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.2.1,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.2.1,write to the serial port
v1.2.1,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.2.1,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.2.1,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.2.1,"try and receive something, up until port is closed anyway."
v1.2.1,"message was too large for the buffer, no problem, return what we have."
v1.2.1,try again - this can happen if server recreates the socket on their side.
v1.2.1,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.2.1,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.2.1,try again - this can happen if server recreates the socket on their side.
v1.2.1,"printf(""#### recv failed with error: %d\n"", hr);"
v1.2.1,we now have it.
v1.2.1,this is from someone we are not interested in.
v1.2.1,"printf(""Connection closed\n"");"
v1.2.1,-----------------------------------------------------------------------------------------
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,Initialize Winsock
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,windows
v1.2.1,Need to link with Ws2_32.lib
v1.2.1,posix
v1.2.1,found it!
v1.2.1,bind socket to local address.
v1.2.1,bind socket to local address.
v1.2.1,start listening for incoming connection
v1.2.1,accept 1
v1.2.1,write to the serial port
v1.2.1,"try and receive something, up until port is closed anyway."
v1.2.1,"message was too large for the buffer, no problem, return what we have."
v1.2.1,try again - this can happen if server recreates the socket on their side.
v1.2.1,"skip this, it is was interrupted."
v1.2.1,"printf(""Connection closed\n"");"
v1.2.1,-----------------------------------------------------------------------------------------
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.2.1,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.2.1,set signal
v1.2.1,Clear Handshake flags
v1.2.1,Set Handshake flags
v1.2.1,return GetLastError();
v1.2.1,return GetLastError();
v1.2.1,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.2.1,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.2.1,enable reading
v1.2.1,posix doesn't have mark/space parity.
v1.2.1,posix doesn't have mark/space parity.
v1.2.1,this is the default.
v1.2.1,not sure this is supported...
v1.2.1,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.2.1,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.2.1,First do those specified by POSIX.
v1.2.1,Now conditionally handle a bunch of extended rates.
v1.2.1,First do those specified by POSIX.
v1.2.1,Now conditionally handle a bunch of extended rates.
v1.2.1,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.2.1,","
v1.2.1,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.2.1,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,"in header only mode, control library is not available"
v1.2.1,TODO: something defines max macro which interfears with code here
v1.2.1,is cur_pos within fence?
v1.2.1,destination risk is not available then consider it zero
v1.2.1,if dest risk is lower than its more safe
v1.2.1,are we doing better than closest obstacle?
v1.2.1,"if we stay where we are, what is the risk distance?"
v1.2.1,else we are better of moving to dest
v1.2.1,this function should work even when dest_pos == cur_pos
v1.2.1,is this dest_pos cur_pos within the fence?
v1.2.1,transform dest_pos vector to body frame
v1.2.1,check for approx zero vectors to avoid random yaw angles
v1.2.1,we are hovering
v1.2.1,"get yaw in body frame, ie, front is always 0 radians"
v1.2.1,yaw to ticks
v1.2.1,get obstacles in the window at the tick direction around the window
v1.2.1,less risk distance is better
v1.2.1,check obstacles around current position and see if it has lower risk
v1.2.1,else obstacle is too far
v1.2.1,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.2.1,look for each surrounding tick to see if we have obstacle free angle
v1.2.1,else no suggestions required
v1.2.1,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.2.1,evaluate right and left side of circle
v1.2.1,find right and left risk distances
v1.2.1,at this point we have already determined hover is better than going to dest
v1.2.1,we now determine is moving to suggested angle better than hovering?
v1.2.1,check if dest_pos is safe
v1.2.1,breaking distance at this velocity
v1.2.1,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.2.1,check if dest_pos is safe
v1.2.1,float/vec parameters can have NaN which makes them optional
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,"in header only mode, control library is not available"
v1.2.1,handles +/- tick and wraps around circle
v1.2.1,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.2.1,update the specified window on the map
v1.2.1,make sure from <= to
v1.2.1,normalize the ticks so both are valid indices
v1.2.1,if from is still larger then
v1.2.1,to ticks is then added one full circle to make it larger than from_tick
v1.2.1,find closest obstacle in given window
v1.2.1,search whole map to find closest obstacle
v1.2.1,"in header only mode, control library is not available"
v1.2.1,#include <fileapi.h>
v1.2.1,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.2.1,"Windows, OSX and Linux."
v1.2.1,Windows users can move the Documents folder to any location they want
v1.2.1,SHGetFolderPath knows how to find it.
v1.2.1,fall back in case SHGetFolderPath failed for some reason.
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,"in header only mode, control library is not available"
v1.2.1,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.1,if using Unreal Build system then include precompiled header file first
v1.2.1,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.1,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.2.1,----------- APIs to control ACharacter in scene ----------/
v1.2.1,if we don't suppress then server will bomb out for exceptions raised by any method
v1.2.1,required for pimpl
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,"in header only mode, control library is not available"
v1.2.1,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.1,if using Unreal Build system then include precompiled header file first
v1.2.1,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.1,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.2.1,make sure we can talk to the DroneServer
v1.2.1,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.2.1,command_context.client.ping();
v1.2.1,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.2.1,sim only
v1.2.1,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.2.1,return value of last task. It should be true if task completed without
v1.2.1,cancellation or timeout
v1.2.1,"should be implemented by derived class if it supports async task,"
v1.2.1,for example using futures
v1.2.1,----------- APIs to control ACharacter in scene ----------/
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,"in header only mode, control library is not available"
v1.2.1,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.1,if using Unreal Build system then include precompiled header file first
v1.2.1,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,"in header only mode, control library is not available"
v1.2.1,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.1,if using Unreal Build system then include precompiled header file first
v1.2.1,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.1,required for pimpl
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,"in header only mode, control library is not available"
v1.2.1,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.1,if using Unreal Build system then include precompiled header file first
v1.2.1,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.1,status getters
v1.2.1,return value of last task. It should be true if task completed without
v1.2.1,cancellation or timeout
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,"in header only mode, control library is not available"
v1.2.1,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.1,if using Unreal Build system then include pre-compiled header file first
v1.2.1,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.1,getters
v1.2.1,required for pimpl
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,"in header only mode, control library is not available"
v1.2.1,last command is to hold on to position
v1.2.1,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.2.1,after landing we detect if drone has stopped moving
v1.2.1,validate path size
v1.2.1,validate yaw mode
v1.2.1,validate and set auto-lookahead value
v1.2.1,if auto mode requested for lookahead then calculate based on velocity
v1.2.1,add current position as starting point
v1.2.1,append the input path and compute segments
v1.2.1,add last segment as zero length segment so we have equal number of segments and points.
v1.2.1,path_segs[i] refers to segment that starts at point i
v1.2.1,"when path ends, we want to slow down"
v1.2.1,else no need to change velocities for last segments
v1.2.1,setup current position on path to 0 offset
v1.2.1,initialize next path position
v1.2.1,until we are at the end of the path (last seg is always zero size)
v1.2.1,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.2.1,send drone command to get to next lookahead
v1.2.1,sleep for rest of the cycle
v1.2.1,how much have we moved towards last goal?
v1.2.1,project actual vector on goal vector
v1.2.1,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.2.1,TODO: below should be lower than 1E3 and configurable
v1.2.1,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.2.1,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.2.1,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.2.1,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.2.1,"if drone moved backward, we don't want goal to move backward as well"
v1.2.1,"so only climb forward on the path, never back. Also note >= which means"
v1.2.1,we climb path even if distance was 0 to take care of duplicated points on path
v1.2.1,else
v1.2.1,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.2.1,compute next target on path
v1.2.1,freeze the quaternion
v1.2.1,convert RC commands to velocity vector
v1.2.1,find yaw as per terrain and remote setting
v1.2.1,execute command
v1.2.1,if timeout occurred then command completed successfully otherwise it was interrupted
v1.2.1,change yaw by moving to same position but constant yaw mode
v1.2.1,by default we say that this command is not supported
v1.2.1,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.2.1,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.2.1,get trims
v1.2.1,take average
v1.2.1,validate dest
v1.2.1,what is the distance we will travel at this velocity?
v1.2.1,get velocity vector
v1.2.1,yaw for the direction of travel
v1.2.1,find velocity vector
v1.2.1,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.2.1,generate velocity vector that is same size as cur_dest_norm / command period
v1.2.1,this velocity vect when executed for command period would yield cur_dest_norm
v1.2.1,send commands
v1.2.1,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.2.1,default strategy is for move. In hover mode we set new strategy temporarily
v1.2.1,are we supposed to do EM?
v1.2.1,get suggested velocity vector
v1.2.1,use the unchecked command
v1.2.1,tell caller not to execute planned command
v1.2.1,other wise throw exception
v1.2.1,otherwise there is some other reason why we are in unsafe situation
v1.2.1,send last command to come to full stop
v1.2.1,else no unsafe situation
v1.2.1,note: cur_path_loc and next_path_loc may both point to same object
v1.2.1,"otherwise use up this segment, move on to next one"
v1.2.1,if we are here then we ran out of segments
v1.2.1,consider last segment as zero length segment
v1.2.1,adjust yaw for the direction of travel in forward-only mode
v1.2.1,else no adjustment needed
v1.2.1,if auto mode requested for lookahead then calculate based on velocity
v1.2.1,Create a spring arm component for our chase camera
v1.2.1,"do nothing, spring arm is pulling the camera with it"
v1.2.1,"do nothing, we have camera turned off"
v1.2.1,set initial view mode
v1.2.1,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.2.1,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.2.1,"If the lag is missing, the camera will also occasionally shake."
v1.2.1,"But, lag is not desired when piloting a drone"
v1.2.1,attach spring arm to actor
v1.2.1,remember current parent for external camera. Later when we remove external
v1.2.1,"camera from spring arm, we will attach it back to its last parent"
v1.2.1,now attach camera to spring arm
v1.2.1,"For car, we need to move the camera back a little more than for a drone."
v1.2.1,"Otherwise, the camera will be stuck inside the car"
v1.2.1,ExternalCamera->bUsePawnControlRotation = false;
v1.2.1,detach spring arm
v1.2.1,Re-enable rendering
v1.2.1,Remove any existing key bindings for manual mode
v1.2.1,"else someone else is bound to manual pose controller, leave it alone"
v1.2.1,if new mode is manual mode then add key bindings
v1.2.1,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.2.1,other modes don't need special setup
v1.2.1,make switch official
v1.2.1,reset any chars we have
v1.2.1,choose first character if name was blank or find by name
v1.2.1,by default all image types are disabled
v1.2.1,use final color for all calculations
v1.2.1,TODO: avoid the need to override const cast here
v1.2.1,if the viewport is wider than it is tall
v1.2.1,if the viewport is taller than it is wide
v1.2.1,use final color for all calculations
v1.2.1,TODO: should we be ignoring position and orientation settings here?
v1.2.1,TODO: can we eliminate storing NedTransform?
v1.2.1,if (!std::isnan(setting.target_gamma))
v1.2.1,camera-> = setting.target_gamma;
v1.2.1,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.2.1,else nothing to enable
v1.2.1,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.2.1,if (controller && controller->GetViewTarget() == this)
v1.2.1,controller->SetViewTarget(nullptr);
v1.2.1,TODO: explore screenshot option
v1.2.1,addScreenCaptureHandler(camera->GetWorld());
v1.2.1,TODO: may be we should have these methods non-const?
v1.2.1,We don't do game/render thread synchronization for safe method.
v1.2.1,We just blindly sleep for 200ms (the old way)
v1.2.1,"Currently, we don't have a way to synthronize image capturing and camera pose when safe method is used,"
v1.2.1,Make sure that all alpha values are opaque.
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,"#include ""Runtime/Foliage/Public/FoliageType.h"""
v1.2.1,TODO: change naming conventions to same as other files?
v1.2.1,Enable/disable primary viewport rendering flag
v1.2.1,This disables rendering of the main viewport in the same way as the
v1.2.1,"console command ""show rendering"" would do."
v1.2.1,"When getting an image through the API, the image is produced after the render"
v1.2.1,thread has finished rendering the current and the subsequent frame. This means
v1.2.1,that the frame rate for obtaining images through the API is only half as high as
v1.2.1,"it could be, since only every other image is actually captured. We work around"
v1.2.1,this by telling the viewport to flush the rendering queue at the end of each
v1.2.1,drawn frame so that it executes our render request at that point already.
v1.2.1,Do this only if the main viewport is not being rendered anyway in case there are
v1.2.1,any adverse performance effects during main rendering.
v1.2.1,HACK: FViewPort doesn't expose this field so we are doing dirty work around by maintaining count by ourselves
v1.2.1,HACK: FViewPort doesn't expose this field so we are doing dirty work around by maintaining count by ourselves
v1.2.1,nothing to do for now
v1.2.1,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.2.1,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.2.1,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.2.1,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.2.1,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.2.1,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.2.1,{
v1.2.1,InitializeObjectStencilID(*comp);
v1.2.1,}
v1.2.1,Access the subclass instance with the * or -> operators.
v1.2.1,can we see followee?
v1.2.1,remove mapping
v1.2.1,removing binding
v1.2.1,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.2.1,"some point. At the moment, manually swapping Red and Blue"
v1.2.1,Copy scaled image into destination thumb
v1.2.1,Compress data - convert into a .png
v1.2.1,if we already have attached actor
v1.2.1,#ifdef _MSC_VER
v1.2.1,//print to VS output window
v1.2.1,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.2.1,#endif
v1.2.1,also do default logging
v1.2.1,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.2.1,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.2.1,{
v1.2.1,if (GEngine != nullptr)
v1.2.1,{
v1.2.1,return GEngine->GameUserSettings;
v1.2.1,}
v1.2.1,return nullptr;
v1.2.1,}
v1.2.1,UGameUserSettings* game_settings = GetGameUserSettings();
v1.2.1,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.2.1,game_settings->ApplySettings(true);
v1.2.1,derived class should override this
v1.2.1,derived class should override this
v1.2.1,derived class should override this
v1.2.1,derived class should override this
v1.2.1,derived class should override this
v1.2.1,derived class should override this
v1.2.1,derived class should override this
v1.2.1,derived class should override this
v1.2.1,derived class should override this
v1.2.1,derived class should override this
v1.2.1,derived class should override this
v1.2.1,derived class should override this
v1.2.1,derived class should override this
v1.2.1,derived class should override this
v1.2.1,derived class should override this
v1.2.1,derived class should override this
v1.2.1,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.2.1,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.2.1,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,plugin startup
v1.2.1,plugin shutdown
v1.2.1,initialize state
v1.2.1,add listener for pawn's collision event
v1.2.1,compute our home point
v1.2.1,add cameras that already exists in pawn
v1.2.1,create or replace cameras specified in settings
v1.2.1,setup individual cameras
v1.2.1,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.2.1,for each camera in settings
v1.2.1,get pose
v1.2.1,spawn and attach camera to pawn
v1.2.1,add on to our collection
v1.2.1,Deflect along the surface when we collide.
v1.2.1,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.2.1,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.2.1,-1 to 1 --> 0 to 1
v1.2.1,-1 to 1
v1.2.1,these will be available for devices like steering wheels
v1.2.1,switch index 0 to 7 for FrSky Taranis RC is:
v1.2.1,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.2.1,TODO: should below be at controller level info?
v1.2.1,else don't waste time
v1.2.1,update position from kinematics so we have latest position after physics update
v1.2.1,kinematics_->update();
v1.2.1,void playBack()
v1.2.1,{
v1.2.1,if (params_.pawn->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.2.1,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.2.1,params_.pawn->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.2.1,}
v1.2.1,TODO: refactor below code used for playback
v1.2.1,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.2.1,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.2.1,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.2.1,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.2.1,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.2.1,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.2.1,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.2.1,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.2.1,}
v1.2.1,parameters in NED frame
v1.2.1,translate to new PawnSimApi position & orientation from NED to NEU
v1.2.1,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.2.1,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.2.1,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.2.1,checked at the start of next tick
v1.2.1,allow teleportation
v1.2.1,if collisions are not enabled
v1.2.1,or we have collided but passthrough is enabled
v1.2.1,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.2.1,"without flip flopping, collisions can't be detected"
v1.2.1,TODO: update other fields?
v1.2.1,no default action in this base class
v1.2.1,TODO: because this bug we are using alternative code with stringstream
v1.2.1,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.2.1,std::stringstream ss;
v1.2.1,"ss << timestamp_millis << ""\t"";"
v1.2.1,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.2.1,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.2.1,"ss << ""\n"";"
v1.2.1,return ss.str();
v1.2.1,"read pixels from render target using render thread, then compress the result into PNG"
v1.2.1,argument on the thread that calls this method.
v1.2.1,TODO: is below really needed?
v1.2.1,make sure we are not on the rendering thread
v1.2.1,TODO: below doesn't work right now because it must be running in game thread
v1.2.1,below is documented method but more expensive because it forces flush
v1.2.1,wait for render thread to pick up our task
v1.2.1,Queue up the task of querying camera pose in the game thread and synchronizing render thread with camera pose
v1.2.1,capture CameraPose for this frame
v1.2.1,The completion is called immeidately after GameThread sends the
v1.2.1,"rendering commands to RenderThread. Hence, our ExecuteTask will"
v1.2.1,execute *immediately* after RenderThread renders the scene!
v1.2.1,"while we're still on GameThread, enqueue request for capture the scene!"
v1.2.1,wait for this task to complete
v1.2.1,log a message and continue wait
v1.2.1,lamda function still references a few objects for which there is no refcount.
v1.2.1,"Walking away will cause memory corruption, which is much more difficult to debug."
v1.2.1,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.2.1,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.2.1,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,Stuff to filter out XInput devices
v1.2.1,-----------------------------------------------------------------------------
v1.2.1,"Defines, constants, and global variables"
v1.2.1,-----------------------------------------------------------------------------
v1.2.1,Magnitude ranges from -1 to 1
v1.2.1,Strength ranges from 0 to 1
v1.2.1,Autocenter
v1.2.1,Rumble
v1.2.1,Register with the DirectInput subsystem and get a pointer
v1.2.1,to a IDirectInput interface we can use.
v1.2.1,Create a DInput object
v1.2.1,Look for a simple joystick we can use for this sample program.
v1.2.1,Make sure we got a joystick
v1.2.1,"Set the data format to ""simple joystick"" - a predefined data format"
v1.2.1,
v1.2.1,"A data format specifies which controls on a device we are interested in,"
v1.2.1,and how they should be reported. This tells DInput that we will be
v1.2.1,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.2.1,Set the cooperative level to let DInput know how this device should
v1.2.1,interact with the system and with other DInput applications.
v1.2.1,Enumerate the joystick objects. The callback function enabled user
v1.2.1,"interface elements for objects that are found, and sets the min/max"
v1.2.1,values property for discovered axes.
v1.2.1,-----------------------------------------------------------------------------
v1.2.1,Enum each PNP device using WMI and check each device ID to see if it contains
v1.2.1,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.2.1,Unfortunately this information can not be found by just using DirectInput.
v1.2.1,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.2.1,XInput devices.
v1.2.1,
v1.2.1,This function stores the list of xinput devices in a linked list
v1.2.1,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.2.1,-----------------------------------------------------------------------------
v1.2.1,CoInit if needed
v1.2.1,Create WMI
v1.2.1,Create BSTRs for WMI
v1.2.1,Connect to WMI
v1.2.1,Switch security level to IMPERSONATE
v1.2.1,Get list of Win32_PNPEntity devices
v1.2.1,Loop over all devices
v1.2.1,Get 20 at a time
v1.2.1,"For each device, get its device ID"
v1.2.1,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.2.1,Unfortunately this information can not be found by just using DirectInput
v1.2.1,"If it does, then get the VID/PID from var.bstrVal"
v1.2.1,Add the VID/PID to a linked list
v1.2.1,-----------------------------------------------------------------------------
v1.2.1,Returns true if the DirectInput device is also an XInput device.
v1.2.1,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.2.1,-----------------------------------------------------------------------------
v1.2.1,Check each xinput device to see if this device's vid/pid matches
v1.2.1,-----------------------------------------------------------------------------
v1.2.1,Cleanup needed for IsXInputDevice()
v1.2.1,-----------------------------------------------------------------------------
v1.2.1,Cleanup linked list
v1.2.1,-----------------------------------------------------------------------------
v1.2.1,Name: EnumJoysticksCallback()
v1.2.1,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.2.1,device interface on it so we can play with it.
v1.2.1,-----------------------------------------------------------------------------
v1.2.1,Skip anything other than the perferred joystick device as defined by the control panel.
v1.2.1,Instead you could store all the enumerated joysticks and let the user pick.
v1.2.1,Obtain an interface to the enumerated joystick.
v1.2.1,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.2.1,it while we were in the middle of enumerating it.)
v1.2.1,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.2.1,could store all the enumerated joysticks and let the user pick.
v1.2.1,-----------------------------------------------------------------------------
v1.2.1,Name: EnumObjectsCallback()
v1.2.1,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.2.1,joystick. This function enables user interface elements for objects
v1.2.1,"that are found to exist, and scales axes min/max values."
v1.2.1,-----------------------------------------------------------------------------
v1.2.1,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.2.1,enumerated axis in order to scale min/max values.
v1.2.1,Set the range for the axis
v1.2.1,Set the UI to reflect what objects the joystick supports
v1.2.1,-----------------------------------------------------------------------------
v1.2.1,Name: UpdateInputState()
v1.2.1,Desc: Get the input device's state and display it.
v1.2.1,-----------------------------------------------------------------------------
v1.2.1,Poll the device to read the current state
v1.2.1,DInput is telling us that the input stream has been
v1.2.1,"interrupted. We aren't tracking any state between polls, so"
v1.2.1,we don't have any special reset that needs to be done. We
v1.2.1,just re-acquire and try again.
v1.2.1,while (hr == DIERR_INPUTLOST)
v1.2.1,hr = g_pJoystick->Acquire();
v1.2.1,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.2.1,may occur when the app is minimized or in the process of
v1.2.1,"switching, so just try again later"
v1.2.1,Get the input's device state
v1.2.1,Axes
v1.2.1,Slider controls
v1.2.1,Points of view
v1.2.1,Buttons
v1.2.1,-----------------------------------------------------------------------------
v1.2.1,Name: FreeDirectInput()
v1.2.1,Desc: Initialize the DirectInput variables.
v1.2.1,-----------------------------------------------------------------------------
v1.2.1,Unacquire the device one last time just in case
v1.2.1,the app tried to exit while the device is still acquired.
v1.2.1,Release any DirectInput objects.
v1.2.1,nop
v1.2.1,normalize min to max --> 0 to 1
v1.2.1,normalize 0 to 1 --> -1 to 1
v1.2.1,#include <libudev.h>
v1.2.1,implementation for unsupported OS
v1.2.1,if this is new index
v1.2.1,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.2.1,close previous one
v1.2.1,open new device
v1.2.1,if open was successful
v1.2.1,read the device
v1.2.1,if we didn't had valid read
v1.2.1,"NOTE if this condition is not met, we're probably out of sync and this"
v1.2.1,Joystick instance is likely unusable
v1.2.1,TODO: set below to false?
v1.2.1,state.is_valid = false;
v1.2.1,else ignore
v1.2.1,TODO: implement this for linux
v1.2.1,TODO: implement this for linux
v1.2.1,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.2.1,{
v1.2.1,"manufacturerID = productID = """";"
v1.2.1,// Use udev to look up the product and manufacturer IDs
v1.2.1,struct udev *udev = udev_new();
v1.2.1,if (udev) {
v1.2.1,char sysname[32];
v1.2.1,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.2.1,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.2.1,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.2.1,if (!dev)
v1.2.1,{
v1.2.1,"message = ""Unable to find parent USB device"";"
v1.2.1,return false;
v1.2.1,}
v1.2.1,std::stringstream ss;
v1.2.1,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.2.1,ss >> manufacturerID;
v1.2.1,ss.clear();
v1.2.1,"ss.str("""");"
v1.2.1,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.2.1,ss >> productID;
v1.2.1,udev_device_unref(dev);
v1.2.1,}
v1.2.1,else
v1.2.1,{
v1.2.1,"message = ""Cannot create udev"";"
v1.2.1,return false;
v1.2.1,}
v1.2.1,udev_unref(udev);
v1.2.1,return true;
v1.2.1,}
v1.2.1,required for pimpl
v1.2.1,TODO: anyway to workaround const_cast?
v1.2.1,FGenericPlatformMisc::PlatformInit();
v1.2.1,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.2.1,TODO: index check
v1.2.1,create main widget
v1.2.1,synchronize PIP views
v1.2.1,TODO: should we only do below on SceneCapture2D components and cameras?
v1.2.1,avoid motion blur so capture images don't get
v1.2.1,use two different methods to set console var because sometime it doesn't seem to work
v1.2.1,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.2.1,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.2.1,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.2.1,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.2.1,setup defaults
v1.2.1,Attempts to parse the settings text from one of multiple locations.
v1.2.1,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.2.1,"Next, check the executable's working directory for the settings file."
v1.2.1,"Finally, check the user's documents folder."
v1.2.1,"If the settings file cannot be read, throw an exception"
v1.2.1,Attempts to parse the settings text from the command line
v1.2.1,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.2.1,"Example: AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.2.1,"Returns true if the argument is present, false otherwise."
v1.2.1,build image file name
v1.2.1,write image file
v1.2.1,write to CSV file
v1.2.1,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.2.1,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.2.1,make sire all vars are set up
v1.2.1,"TODO: should we go as fast as possible, or should we limit this to a particular number of"
v1.2.1,frames per second?
v1.2.1,"UAirBlueprintLib::LogMessage(TEXT(""Stopped recording thread""), TEXT(""""), LogDebugLevel::Success);"
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,decide which derived BP to use
v1.2.1,we don't have real vehicle so no vehicle API
v1.2.1,put camera little bit above vehicle
v1.2.1,update ground level
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,let base class setup physics world
v1.2.1,stop physics thread before we dismantle
v1.2.1,setup clock in ClockFactory
v1.2.1,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.2.1,steppable clock returns interval that is a constant number irrespective of wall clock
v1.2.1,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.2.1,but that would cause vehicles like quadrotors to become unstable
v1.2.1,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.2.1,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.2.1,get increase in clock speed
v1.2.1,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.2.1,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.2.1,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.2.1,Approach 2: scale control loop frequency if clock is speeded up
v1.2.1,"for slowing down, this don't generate instability"
v1.2.1,-------------------------------- overrides -----------------------------------------------//
v1.2.1,decide which derived BP to use
v1.2.1,vehicle_sim_api->reset();
v1.2.1,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.2.1,create vehicle API
v1.2.1,setup physics vehicle
v1.2.1,initialize private vars
v1.2.1,calls to update* are handled by physics engine and in SimModeWorldBase
v1.2.1,"Utils::log(""------Render tick-------"");"
v1.2.1,"if reset is pending then do it first, no need to do other things until next tick"
v1.2.1,move collision info from rendering engine to vehicle
v1.2.1,update rotor poses
v1.2.1,if we did reset then don't worry about synchronizing states for this tick
v1.2.1,Continue to wait for reset
v1.2.1,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.2.1,*** Start: UpdatableState implementation ***//
v1.2.1,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.2.1,environment update for current position
v1.2.1,update forces on vertices
v1.2.1,update to controller must be done after kinematics have been updated by physics engine
v1.2.1,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.2.1,*** End: UpdatableState implementation ***//
v1.2.1,get references of existing camera
v1.2.1,setup clock in PhysX
v1.2.1,-------------------------------- overrides -----------------------------------------------//
v1.2.1,decide which derived BP to use
v1.2.1,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.2.1,Setup suspension forces
v1.2.1,Find the tire object and set the data for it
v1.2.1,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.2.1,Setup suspension forces
v1.2.1,Find the tire object and set the data for it
v1.2.1,Create In-Car camera component
v1.2.1,In car HUD
v1.2.1,Create text render component for in car speed display
v1.2.1,Create text render component for in car gear display
v1.2.1,Setup the audio component and allocate it a sound cue
v1.2.1,Colors for the in-car gear display. One for normal one for reverse
v1.2.1,Wheels/Tires
v1.2.1,Setup the wheels
v1.2.1,Adjust the tire loading
v1.2.1,Engine
v1.2.1,Torque setup
v1.2.1,Adjust the steering
v1.2.1,Transmission
v1.2.1,We want 4wd
v1.2.1,Drive the front wheels a little more than the rear
v1.2.1,Automatic gearbox
v1.2.1,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.2.1,Physics settings
v1.2.1,Adjust the center of mass - the buggy is quite low
v1.2.1,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.2.1,put camera little bit above vehicle
v1.2.1,update physics material
v1.2.1,Update the strings used in the HUD (in-car and on-screen)
v1.2.1,Set the string in the in-car HUD
v1.2.1,Pass the engine RPM to the sound component
v1.2.1,Start an engine sound playing
v1.2.1,Using FText because this is display text that should be localizable
v1.2.1,Setup the text render component strings
v1.2.1,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.2.1,below is not needed
v1.2.1,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.2.1,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.2.1,TODO: should do reset() here?
v1.2.1,create vehicle params
v1.2.1,these are called on render ticks
v1.2.1,TODO: do we need this for cars?
v1.2.1,TODO: move this to SimModeBase?
v1.2.1,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.2.1,reset();
v1.2.1,return;
v1.2.1,}
v1.2.1,Thrustmaster devices
v1.2.1,"Anything else, typically Logitech G920 wheel"
v1.2.1,Two steel levers behind wheel
v1.2.1,if API-client control is not active then we route keyboard/joystick control to car
v1.2.1,all car controls from anywhere must be routed through API component
v1.2.1,*** Start: UpdatableState implementation ***//
v1.2.1,physics tick
v1.2.1,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.2.1,*** End: UpdatableState implementation ***//
v1.2.1,TODO: implement arming for car
v1.2.1,TODO: directly accept getVehicleSimApis() using generic container
v1.2.1,remove everything that we created in BeginPlay
v1.2.1,we use custom debug reporting for this class
v1.2.1,perform any expensive rendering update outside of lock region
v1.2.1,no need to call base reset because of our custom implementation
v1.2.1,TODO: this is going to cause circular references which is fine here but
v1.2.1,in future we should consider moving SimMode not derived from AActor and move
v1.2.1,it to AirLib and directly implement WorldSimApiBase interface
v1.2.1,get player start
v1.2.1,this must be done from within actor otherwise we don't get player start
v1.2.1,else don't init
v1.2.1,else ignore
v1.2.1,should be overridden by derived class
v1.2.1,should be overridden by derived class
v1.2.1,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.2.1,default setup - this should be overridden in derived modes as needed
v1.2.1,setup clock in ClockFactory
v1.2.1,default implementation
v1.2.1,create director
v1.2.1,create external camera required for the director
v1.2.1,API server start/stop
v1.2.1,get UU origin of global NED frame
v1.2.1,determine camera director camera default pose and spawn it
v1.2.1,find all vehicle pawns
v1.2.1,add vehicles from settings
v1.2.1,if vehicle is of type for derived SimMode and auto creatable
v1.2.1,compute initial pose
v1.2.1,spawn vehicle pawn
v1.2.1,create API objects for each pawn we have
v1.2.1,create vehicle sim api
v1.2.1,TODO: better handle no FPV vehicles scenario
v1.2.1,derived class should override this method to retrieve types of pawns they support
v1.2.1,derived class should override this method to retrieve types of pawns they support
v1.2.1,derived class should override this method to retrieve types of pawns they support
v1.2.1,derived class should override this method to retrieve types of pawns they support
v1.2.1,derived class should override this method to retrieve types of pawns they support
v1.2.1,derived class should override this method to retrieve types of pawns they support
v1.2.1,derived class should override this method to retrieve types of pawns they support
v1.2.1,Draws debug-points on main viewport for Lidar laser hits.
v1.2.1,Used for debugging only.
v1.2.1,Currently we are checking the sensor-collection instead of sensor-settings.
v1.2.1,Also using variables to optimize not checking the collection if not needed.
v1.2.1,TODO: Is it incorrect to assume LidarSimple here?
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,ctor
v1.2.1,initializes information based on lidar configuration
v1.2.1,calculate verticle angle distance between each laser
v1.2.1,store vertical angles for each laser
v1.2.1,returns a point-cloud for the tick
v1.2.1,cap the points to scan via ray-tracing; this is currently needed for car/Unreal tick scenarios
v1.2.1,since SensorBase mechanism uses the elapsed clock time instead of the tick delta-time.
v1.2.1,calculate number of points needed for each laser/channel
v1.2.1,"UAirBlueprintLib::LogMessageString(""Lidar: "", ""No points requested this frame"", LogDebugLevel::Failure);"
v1.2.1,calculate needed angle/distance between each point
v1.2.1,shoot lasers
v1.2.1,"shoot laser and get the impact point, if any"
v1.2.1,simulate shooting a laser via Unreal ray-tracing.
v1.2.1,start position
v1.2.1,get ray quaternion in lidar frame (angles must be in radians)
v1.2.1,get ray quaternion in body frame
v1.2.1,get ray quaternion in world frame
v1.2.1,get ray vector (end position)
v1.2.1,Debug code for very specific cases.
v1.2.1,Mostly shouldn't be needed. Use SimModeBase::drawLidarDebugPoints()
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,update ray tracing
v1.2.1,"FString hit_name = FString(""None"");"
v1.2.1,if (dist_hit.GetActor())
v1.2.1,hit_name=dist_hit.GetActor()->GetName();
v1.2.1,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.2.1,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,This assumes you are running DroneServer already on the same machine.
v1.2.1,DroneServer must be running first.
v1.2.1,enable API control
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,move commands
v1.2.1,else leave as it is
v1.2.1,TODO: get these in one call
v1.2.1,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.2.1,TODO: shouldn't we pass folder path?
v1.2.1,parse
v1.2.1,group the images by the current date.
v1.2.1,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.2.1,{
v1.2.1,"return """";"
v1.2.1,}
v1.2.1,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.2.1,{
v1.2.1,return false;
v1.2.1,}
v1.2.1,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.2.1,params.context->client.newTask();
v1.2.1,}
v1.2.1,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.2.1,params.context->client.WaitForCompletion(0);
v1.2.1,}
v1.2.1,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.2.1,{
v1.2.1,}
v1.2.1,parse command line
v1.2.1,Shell callbacks
v1.2.1,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.2.1,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.2.1,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.2.1,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.2.1,Add shell commands
v1.2.1,TODO: add WaitForCompletion command
v1.2.1,"TODO: add command line args help, arg count validation"
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,switch to explicit hover mode so that this is the fall back when
v1.2.1,move* commands are finished.
v1.2.1,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.2.1,"Not implemented, just added for compilation."
v1.2.1,Function pointers to hold the addresses of the functions that are defined in Unity
v1.2.1,initialize state
v1.2.1,compute our home point
v1.2.1,these will be available for devices like steering wheels
v1.2.1,update position from kinematics so we have latest position after physics update
v1.2.1,kinematics_->update();
v1.2.1,parameters in NED frame
v1.2.1,allow teleportation
v1.2.1,if collisions are not enabled
v1.2.1,or we have collided but passthrough is enabled
v1.2.1,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.2.1,"without flip flopping, collisions can't be detected"
v1.2.1,no default action in this base class
v1.2.1,TODO: because this bug we are using alternative code with stringstream
v1.2.1,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.2.1,implements getImages() method in the ImageCaptureBase class.
v1.2.1,update ray tracing
v1.2.1,TODO: index check
v1.2.1,Attempts to parse the settings text from one of multiple locations.
v1.2.1,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.2.1,"Next, check the executable's working directory for the settings file."
v1.2.1,"Finally, check the user's documents folder."
v1.2.1,"If the settings file cannot be read, throw an exception"
v1.2.1,let base class setup physics world
v1.2.1,stop physics thread before we dismantle
v1.2.1,setup clock in ClockFactory
v1.2.1,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.2.1,steppable clock returns interval that is a constant number irrespective of wall clock
v1.2.1,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.2.1,but that would cause vehicles like quadrotors to become unstable
v1.2.1,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.2.1,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.2.1,get increase in clock speed
v1.2.1,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.2.1,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.2.1,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.2.1,Approach 2: scale control loop frequency if clock is speeded up
v1.2.1,"for slowing down, this don't generate instability"
v1.2.1,-------------------------------- overrides -----------------------------------------------//
v1.2.1,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.2.1,create vehicle API
v1.2.1,setup physics vehicle
v1.2.1,initialize private vars
v1.2.1,"if reset is pending then do it first, no need to do other things until next tick"
v1.2.1,move collision info from rendering engine to vehicle
v1.2.1,update rotor poses
v1.2.1,if we did reset then don't worry about synchronizing states for this tick
v1.2.1,Continue to wait for reset
v1.2.1,*** Start: UpdatableState implementation ***//
v1.2.1,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.2.1,environment update for current position
v1.2.1,update forces on vertices
v1.2.1,update to controller must be done after kinematics have been updated by physics engine
v1.2.1,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.2.1,*** End: UpdatableState implementation ***//
v1.2.1,these are called on render ticks
v1.2.1,TODO: do we need this for cars?
v1.2.1,Thrustmaster devices
v1.2.1,"Anything else, typically Logitech G920 wheel"
v1.2.1,Two steel levers behind wheel
v1.2.1,if API-client control is not active then we route keyboard/joystick control to car
v1.2.1,all car controls from anywhere must be routed through API component
v1.2.1,*** Start: UpdatableState implementation ***//
v1.2.1,physics tick
v1.2.1,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.2.1,*** End: UpdatableState implementation ***//
v1.2.1,TODO: implement arming for car
v1.2.1,remove everything that we created in BeginPlay
v1.2.1,we use custom debug reporting for this class
v1.2.1,perform any expensive rendering update outside of lock region
v1.2.1,no need to call base reset because of our custom implementation
v1.2.1,should be overridden by derived class
v1.2.1,should be overridden by derived class
v1.2.1,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.2.1,default setup - this should be overridden in derived modes as needed
v1.2.1,setup clock in ClockFactory
v1.2.1,API server start/stop
v1.2.1,determine camera director camera default pose and spawn it
v1.2.1,derived class should override this method to retrieve types of pawns they support
v1.2.1,derived class should override this method to retrieve types of pawns they support
v1.2.1,60 acres park:
v1.2.1,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.2.1,marymoore park
v1.2.1,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.2.1,"Pose goalPose = client.simGetObjectPose(""OrangeBall"");"
v1.2.1,DepthNavThreshold depthNav;
v1.2.1,DepthNavOptAStar depthNav;
v1.2.1,DepthNavThreshold depthNav;
v1.2.1,DepthNavOptAStar depthNav;
v1.2.1,Cleanup
v1.2.1,runDepthNavGT();
v1.2.1,runDepthNavSGM();
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,by Sudipta Sinha
v1.2.1,adapted for AirSim by Matthias Mueller
v1.2.1,first row
v1.2.1,last row
v1.2.1,Local quadratic fit of cost and subpixel refinement.
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,by Sudipta Sinha
v1.2.1,adapted for AirSim by Matthias Mueller
v1.2.1,uint64_t x64 = (uint64_t)x;
v1.2.1,uint64_t y64 = (uint64_t)y;
v1.2.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.1,Licensed under the MIT License.
v1.2.1,by Sudipta Sinha
v1.2.1,adapted for AirSim by Matthias Mueller
v1.2.1,ensure that disparity range is a multiple of 8
v1.2.1,sgm stereo
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,read settings and override defaults
v1.2.0,allow json overrides on a per-vehicle basis.
v1.2.0,start server in async mode
v1.2.0,check messages
v1.2.0,In settings.json first activate computer vision mode:
v1.2.0,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.0,monitor car state while you drive it manually.
v1.2.0,In settings.json first activate computer vision mode:
v1.2.0,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.0,currently reset() doesn't work in CV mode. Below is the workaround
v1.2.0,In settings.json first activate computer vision mode:
v1.2.0,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.0,requires Python 3.5.3 :: Anaconda 4.4.0
v1.2.0,pip install opencv-python
v1.2.0,In settings.json first activate computer vision mode:
v1.2.0,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.0,for block environment
v1.2.0,regex are case insensitive
v1.2.0,#for neighborhood environment
v1.2.0,set object ID for sky
v1.2.0,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.2.0,get segmentation image in various formats
v1.2.0,save segmentation images in various formats
v1.2.0,"airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))"
v1.2.0,"airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.2.0,"airsim.write_png(os.path.normpath(filename + '.numpy.png'), img_rgba) #write to png"
v1.2.0,find unique colors
v1.2.0,In settings.json first activate computer vision mode:
v1.2.0,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.0,"Go to object in Unreal Editor, click on it and then look for Tags property."
v1.2.0,"Add a tag ""MyObject"" (without quotes), save and the query using following line"
v1.2.0,see more about tags here: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.2.0,Import this module to automatically setup path to local airsim module
v1.2.0,This module first tries to see if airsim module is installed via pip
v1.2.0,If it does then we don't do anything else
v1.2.0,Else we look up grand-parent folder to see if it has airsim folder
v1.2.0,and if it does then we add that in sys.path
v1.2.0,this class simply tries to see if airsim
v1.2.0,if airsim module is installed then don't do anything else
v1.2.0,connect to the AirSim simulator
v1.2.0,monitor car state while you drive it manually.
v1.2.0,get state of the car
v1.2.0,connect to the AirSim simulator
v1.2.0,connect to the AirSim simulator
v1.2.0,go forward
v1.2.0,get state of the car
v1.2.0,import gym #pip install gym
v1.2.0,Local variable access is faster in loops
v1.2.0,"if not wrapping over current pointer,"
v1.2.0,then check if there is terminal state wrapped inside
v1.2.0,"If index > history_length, take from a slice"
v1.2.0,Metrics accumulator
v1.2.0,Action Value model (used by agent to interact with the environment)
v1.2.0,"Target model used to compute the target Q-values in training, updated"
v1.2.0,less frequently for increased stability.
v1.2.0,Function computing Q-values targets as part of the computation graph
v1.2.0,"Define the loss, using Huber Loss (more robust to outliers)"
v1.2.0,Compute the q_targets
v1.2.0,actions is a 1-hot encoding of the action done by the agent
v1.2.0,Define training criterion as the Huber Loss function
v1.2.0,Adam based SGD
v1.2.0,self._trainer.restore_from_checkpoint('models/oldmodels/model800000')
v1.2.0,Append the state to the short term memory (ie. History)
v1.2.0,"If policy requires agent to explore, sample random action"
v1.2.0,Use the network to output the best action
v1.2.0,Append batch axis with only one sample to evaluate
v1.2.0,Return the value maximizing the expected reward
v1.2.0,Keep track of interval action counter
v1.2.0,"If done, reset short term memory (ie. History)"
v1.2.0,Plot the metrics through Tensorboard and reset buffers
v1.2.0,Reset the short term memory
v1.2.0,Append to long term memory
v1.2.0,Update the Target Network if needed
v1.2.0,print(dist)
v1.2.0,Make RL agent
v1.2.0,Train
v1.2.0,connect to the AirSim simulator
v1.2.0,get state of the car
v1.2.0,go forward
v1.2.0,Go forward + steer right
v1.2.0,go reverse
v1.2.0,apply breaks
v1.2.0,get camera images from the car
v1.2.0,restore to original state
v1.2.0,connect to the AirSim simulator
v1.2.0,go forward
v1.2.0,connect to the AirSim simulator
v1.2.0,get state of the car
v1.2.0,go forward
v1.2.0,Go forward + steer right
v1.2.0,go reverse
v1.2.0,apply breaks
v1.2.0,restore to original state
v1.2.0,connect to the AirSim simulator
v1.2.0,get camera images from the car
v1.2.0,that's enough fun for now. let's quit cleanly
v1.2.0,Import this module to automatically setup path to local airsim module
v1.2.0,This module first tries to see if airsim module is installed via pip
v1.2.0,If it does then we don't do anything else
v1.2.0,Else we look up grand-parent folder to see if it has airsim folder
v1.2.0,and if it does then we add that in sys.path
v1.2.0,this class simply tries to see if airsim
v1.2.0,if airsim module is installed then don't do anything else
v1.2.0,import pkgutil
v1.2.0,airsim_loader = pkgutil.find_loader('airsim')
v1.2.0,if airsim_loader is not None:
v1.2.0,return
v1.2.0,from keras.models import load_model
v1.2.0,if (len(sys.argv) != 2):
v1.2.0,print('usage: python drive.py <modelName>')
v1.2.0,sys.exit()
v1.2.0,print('Loading model...')
v1.2.0,model = load_model(sys.argv[1])
v1.2.0,connect to the AirSim simulator
v1.2.0,image_buf[0] = get_image()
v1.2.0,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.2.0,"model_output = model.predict([image_buf, state_buf])"
v1.2.0,car_controls.steering = float(model_output[0][0])
v1.2.0,connect to the AirSim simulator
v1.2.0,Local variable access is faster in loops
v1.2.0,"if not wrapping over current pointer,"
v1.2.0,then check if there is terminal state wrapped inside
v1.2.0,"If index > history_length, take from a slice"
v1.2.0,Metrics accumulator
v1.2.0,Action Value model (used by agent to interact with the environment)
v1.2.0,"Target model used to compute the target Q-values in training, updated"
v1.2.0,less frequently for increased stability.
v1.2.0,Function computing Q-values targets as part of the computation graph
v1.2.0,"Define the loss, using Huber Loss (more robust to outliers)"
v1.2.0,Compute the q_targets
v1.2.0,actions is a 1-hot encoding of the action done by the agent
v1.2.0,Define training criterion as the Huber Loss function
v1.2.0,Adam based SGD
v1.2.0,Append the state to the short term memory (ie. History)
v1.2.0,"If policy requires agent to explore, sample random action"
v1.2.0,Use the network to output the best action
v1.2.0,Append batch axis with only one sample to evaluate
v1.2.0,Return the value maximizing the expected reward
v1.2.0,Keep track of interval action counter
v1.2.0,"If done, reset short term memory (ie. History)"
v1.2.0,Plot the metrics through Tensorboard and reset buffers
v1.2.0,Reset the short term memory
v1.2.0,Append to long term memory
v1.2.0,Update the Target Network if needed
v1.2.0,print(dist)
v1.2.0,connect to the AirSim simulator
v1.2.0,Make RL agent
v1.2.0,Train
v1.2.0,connect to the AirSim simulator
v1.2.0,get camera images from the car
v1.2.0,that's enough fun for now. let's quit cleanly
v1.2.0,use open cv to create point cloud from depth image.
v1.2.0,###########################################
v1.2.0,######### This is work in progress! #######
v1.2.0,###########################################
v1.2.0,file will be saved in PythonClient folder (i.e. same folder as script)
v1.2.0,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.2.0,skip it
v1.2.0,AirSim uses NED coordinates so negative axis is up.
v1.2.0,z of -7 is 7 meters above the original launch point.
v1.2.0,Fly given velocity vector for 5 seconds
v1.2.0,using airsim.DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.2.0,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.2.0,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.2.0,Make the drone fly in a circle.
v1.2.0,"center is just a direction vector, so normalize it to compute the actual cx,cy locations."
v1.2.0,check that our home position is stable
v1.2.0,AirSim uses NED coordinates so negative axis is up.
v1.2.0,ramp up time
v1.2.0,ramp up to full speed in smooth increments so we don't start too aggressively.
v1.2.0,compute current angle
v1.2.0,compute lookahead
v1.2.0,if we did the takeoff then also do the landing.
v1.2.0,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.2.0,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.2.0,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.2.0,ignore the click over from 360 back to 0
v1.2.0,watch direction this diff is moving if it switches from shrinking to growing
v1.2.0,then we passed the starting point.
v1.2.0,first hold our current position so drone doesn't try and keep flying while we take the picture.
v1.2.0,AirSim uses NED coordinates so negative axis is up.
v1.2.0,z of -7 is 7 meters above the original launch point.
v1.2.0,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.2.0,this method is async and we are not waiting for the result since we are passing timeout_sec=0.
v1.2.0,change clock speed in settings.json
v1.2.0,"""ClockSpeed"": 0.5"
v1.2.0,connect to the AirSim simulator
v1.2.0,that's enough fun for now. let's quit cleanly
v1.2.0,In settings.json first activate computer vision mode:
v1.2.0,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.2.0,requires Python 3.5.3 :: Anaconda 4.4.0
v1.2.0,pip install opencv-python
v1.2.0,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.2.0,connect to the AirSim simulator
v1.2.0,AirSim uses NED coordinates so negative axis is up.
v1.2.0,let it settle there a bit.
v1.2.0,now compute the survey path required to fill the box
v1.2.0,connect to the AirSim simulator
v1.2.0,Import this module to automatically setup path to local airsim module
v1.2.0,This module first tries to see if airsim module is installed via pip
v1.2.0,If it does then we don't do anything else
v1.2.0,Else we look up grand-parent folder to see if it has airsim folder
v1.2.0,and if it does then we add that in sys.path
v1.2.0,this class simply tries to see if airsim
v1.2.0,if airsim module is installed then don't do anything else
v1.2.0,connect to the AirSim simulator
v1.2.0,that's enough fun for now. let's quite cleanly
v1.2.0,use open cv to show new images from AirSim
v1.2.0,requires Python 3.5.3 :: Anaconda 4.4.0
v1.2.0,pip install opencv-python
v1.2.0,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.2.0,get depth image
v1.2.0,"this will return png width= 256, height= 144"
v1.2.0,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.2.0,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.2.0,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.2.0,to get an estimate of distance.
v1.2.0,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.2.0,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.2.0,an angular delta of the following pi/10.
v1.2.0,DEY: I don't know why this was there.
v1.2.0,data = np.flipud(data)
v1.2.0,-----------------------------------  Common vehicle APIs ---------------------------------------------
v1.2.0,basic flight control
v1.2.0,camera control
v1.2.0,simGetImage returns compressed png in array of bytes
v1.2.0,image_type uses one of the ImageType members
v1.2.0,"todo: in future remove below, it's only for compatibility to pre v1.2"
v1.2.0,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.2.0,camera control
v1.2.0,simGetImage returns compressed png in array of bytes
v1.2.0,image_type uses one of the ImageType members
v1.2.0,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.2.0,TODO: below str() conversion is only needed for legacy reason and should be removed in future
v1.2.0,legacy handling
v1.2.0,TODO: remove below legacy wrappers in future major releases
v1.2.0,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.2.0,APIs for control
v1.2.0,query vehicle state
v1.2.0,-----------------------------------  Car APIs ---------------------------------------------
v1.2.0,helper method for converting getOrientation to roll/pitch/yaw
v1.2.0,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.2.0,roll (x-axis rotation)
v1.2.0,pitch (y-axis rotation)
v1.2.0,yaw (z-axis rotation)
v1.2.0,DEY: I don't know why this was there.
v1.2.0,data = np.flipud(data)
v1.2.0,reverse the vertical line order and add null bytes at the start
v1.2.0,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.2.0,return cls(**msgpack.unpack(encoded))
v1.2.0,"todo: in future remove str(), it's only for compatibility to pre v1.2"
v1.2.0,"in header only mode, control library is not available"
v1.2.0,if using Unreal Build system then include precompiled header file first
v1.2.0,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.2.0,"Windows, OSX and Linux."
v1.2.0,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.2.0,Windows users can move the Documents folder to any location they want
v1.2.0,SHGetFolderPath knows how to find it.
v1.2.0,fall back in case SHGetFolderPath failed for some reason.
v1.2.0,convert from std::path '/' to windows backslash.
v1.2.0,make the current thread run with maximum priority.
v1.2.0,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.2.0,TODO: How to handle POSIX thread priorities on OSX?
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.2.0,
v1.2.0,Treat all errors as failure conditions.
v1.2.0,parse command line
v1.2.0,"motive gives a weird error if the project is not found, so we look for it."
v1.2.0,Do an update to pick up any recently-arrived cameras.
v1.2.0,List all detected cameras.
v1.2.0,List all defined rigid bodies.
v1.2.0,throttle to 50 messages per second.
v1.2.0,OptiTrack uses 'y' axis for vertical.
v1.2.0,stdafx.cpp : source file that includes just the standard includes
v1.2.0,MavlinkMoCap.pch will be the pre-compiled header
v1.2.0,stdafx.obj will contain the pre-compiled type information
v1.2.0,TODO: reference any additional headers you need in STDAFX.H
v1.2.0,and not in this file
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,PX4.cpp : Defines the entry point for the console application.
v1.2.0,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.2.0,how do you write to the debug output windows on Unix ?
v1.2.0,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.2.0,connection to create to talke to that server.
v1.2.0,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.2.0,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.2.0,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.2.0,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.2.0,using their the -qgc option.
v1.2.0,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.2.0,this switch controls whether we turn off the RC remote active link loss detection
v1.2.0,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.2.0,from kicking in when you try and fly.
v1.2.0,can't use experimental stuff on Linux because of potential ABI issues
v1.2.0,parse the json
v1.2.0,flatten inner mavlink object
v1.2.0,flatten inner mavlink object
v1.2.0,todo
v1.2.0,todo
v1.2.0,"const char* outLogFileOption = ""outlogfile"";"
v1.2.0,parse command line
v1.2.0,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.2.0,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.2.0,"no local serial connection, so this is the primary droneConnection."
v1.2.0,failed to connect
v1.2.0,"local connection, then we own sending the heartbeat."
v1.2.0,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.2.0,cmdTable.push_back(new AltHoldCommand());
v1.2.0,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.2.0,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.2.0,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.2.0,this stops us from being able to connect to SITL mode PX4.
v1.2.0,checkPulse();
v1.2.0,add command text in log
v1.2.0,close previous command.
v1.2.0,FilterLogFiles(logDirectory);
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,send a heartbeat
v1.2.0,accept one incoming connection
v1.2.0,send a heartbeat to the client
v1.2.0,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.2.0,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.2.0,for this unit test we are expecting a request to send an image.
v1.2.0,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.2.0,hmmm
v1.2.0,================ ls
v1.2.0,================ put file
v1.2.0,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.2.0,================ get file
v1.2.0,verify the file contents.
v1.2.0,================ remove file
v1.2.0,================ make directory
v1.2.0,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.2.0,================ remove directory
v1.2.0,Now verification
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,from main.cpp.
v1.2.0,you must call this method if you want HandleMessage to be called subsequently.
v1.2.0,treat literals as one word
v1.2.0,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.2.0,request gps info
v1.2.0,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.2.0,find relative position since command start so we can compare two commands better
v1.2.0,TODO: make below future proof (i.e. usable by C++17 compiler) - also change same in main.cpp
v1.2.0,can't use experimental stuff on Linux because of potential ABI issues
v1.2.0,"these PID values are important, so set these to match"
v1.2.0,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.2.0,we can skip ahead.
v1.2.0,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.2.0,TODO: avoid passing hadcoded HIL flag
v1.2.0,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.2.0,"The global position, as returned by the Global Positioning System (GPS)."
v1.2.0,Provides state for additional features
v1.2.0,The general system state
v1.2.0,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.2.0,Provides state for additional features
v1.2.0,The general system state
v1.2.0,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.2.0,Provides state for additional features
v1.2.0,The general system state
v1.2.0,Provides state for additional features
v1.2.0,The general system state
v1.2.0,note: we do not reset com when Close() is called because we want to keep running.
v1.2.0,"user has to invoke ""hil stop"" to stop the hil thread."
v1.2.0,generate random between 0 and 1
v1.2.0,move to range -1 to 1
v1.2.0,scale it
v1.2.0,apply iy
v1.2.0,wait for the Execute method to be called.
v1.2.0,gps is much slower frequency than IMU.
v1.2.0,MAVLINK_MSG_ID_HIL_GPS
v1.2.0,disable MAV_USEHILGPS
v1.2.0,note: we do not reset com when Close() is called because we want to keep running.
v1.2.0,"user has to invoke ""hil stop"" to stop the hil thread."
v1.2.0,generate random between 0 and 1
v1.2.0,move to range -1 to 1
v1.2.0,scale it
v1.2.0,apply iy
v1.2.0,wait for the Execute method to be called.
v1.2.0,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.2.0,gps is much slower frequency than IMU.
v1.2.0,MAVLINK_MSG_ID_HIL_GPS
v1.2.0,disable HIL mode
v1.2.0,Enumeration of landed detector states
v1.2.0,MAV landed state is unknown
v1.2.0,MAV is landed (on ground)
v1.2.0,MAV is in air
v1.2.0,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.2.0,The filtered local position
v1.2.0,must send these regularly to keep offboard control.
v1.2.0,"ok, now we can safely switch to loiter."
v1.2.0,must send these regularly to keep offboard control.
v1.2.0,integrate the heading so it is smoother.
v1.2.0,must send these regularly to keep offboard control.
v1.2.0,integrate the heading so it is smoother.
v1.2.0,fly to radius
v1.2.0,it takes about 10 cm to stop and turn.
v1.2.0,next time around switch to orbiting!
v1.2.0,heading points to center of circle.
v1.2.0,interpoloate the speed ramp up time over 2 seconds from start time
v1.2.0,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.2.0,monitor the sin curves so we can see how on track or off track it actually is.
v1.2.0,the shape of the curve will also tell us if we are progressing at a consistent
v1.2.0,"speed, the more deformed the sin curve the worse our progress."
v1.2.0,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.2.0,degrees just flipped from 359 to 0.
v1.2.0,this enables us to test what happens when offboard control is lost and resumed.
v1.2.0,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.2.0,"ok, now we can start moving by velocity"
v1.2.0,recompute to new target.
v1.2.0,start by moving right with 10 degree roll.
v1.2.0,haven't started yet.
v1.2.0,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.2.0,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.2.0,track how our actual pitch is coming along compared to our target
v1.2.0,and check position
v1.2.0,the amount of pitch should depend on our speed in that direction.
v1.2.0,passed the midpoint.
v1.2.0,fade out the pitch as we pick up speed so we don't overshoot.
v1.2.0,see if we just crossed the wiggle distance threshold.
v1.2.0,(pitch affects the x-position).
v1.2.0,reverse direction with a -30 degrees quick stop
v1.2.0,reverse direction with a 30 degrees quick stop
v1.2.0,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.2.0,too much in that direction.
v1.2.0,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.2.0,track how our actual roll is coming along compared to our target
v1.2.0,and check position
v1.2.0,the amount of roll should depend on our speed in that direction.
v1.2.0,passed the midpoint.
v1.2.0,fade out the roll as we pick up speed so we don't overshoot.
v1.2.0,see if we just crossed the wiggle distance threshold.
v1.2.0,(roll affects the y-position).
v1.2.0,reverse direction with a -30 degrees quick stop
v1.2.0,reverse direction with a 30 degrees quick stop
v1.2.0,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.2.0,too much in that direction.
v1.2.0,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.2.0,for testing PID controller.
v1.2.0,class AltHoldCommand : public Command
v1.2.0,{
v1.2.0,std::shared_ptr<MavLinkVehicle> channel;
v1.2.0,"float sx_, sy_, sz_;"
v1.2.0,MavLinkAttitudeTarget _current;
v1.2.0,PidController thrust_controller_;
v1.2.0,public:
v1.2.0,this->sz_ = pos.z; // user defined target.
v1.2.0,move to local position keeps the offboard control happy.
v1.2.0,haven't started yet.
v1.2.0,and check position
v1.2.0,double dx = this->sx_ - pos.x;
v1.2.0,double dy = this->sy_ - pos.y;
v1.2.0,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.2.0,too much in that direction.
v1.2.0,adjust thrust so we keep steady height target
v1.2.0,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.2.0,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.2.0,local remote
v1.2.0,already handled by the parse method.
v1.2.0,we only support very simple patterns for now.
v1.2.0,each wildcard must be separated by literal.
v1.2.0,back to back wildcards with no literal in between is too complex.
v1.2.0,"we only support simple matching for now, we can add full regex later if we need it."
v1.2.0,yep!
v1.2.0,'*' is done we found the next matching char
v1.2.0,this is ok.
v1.2.0,this is an ERASE_END_LINE command which we ignore.
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,unpack the message...
v1.2.0,pack the payload buffer.
v1.2.0,"json can't handle ""nan"", so we convert it to null."
v1.2.0,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.2.0,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,start listening to this connection
v1.2.0,Send heartbeat to drone.  You should not do this if some other node is
v1.2.0,already doing it.
v1.2.0,stop listening to the connection.
v1.2.0,get the connection
v1.2.0,Get the local system and component id
v1.2.0,send a command to the remote node
v1.2.0,MavLinkNode::MavLinkNode() = default;
v1.2.0,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.2.0,decrementing the count so the next WaitOne may block.
v1.2.0,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.2.0,convert to absolute time.
v1.2.0,use mach_timespec
v1.2.0,convert to absolute time.
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,return true if we still have offboard control (can lose this if user flips the switch).
v1.2.0,MavLinkVehicle::MavLinkVehicle() = default;
v1.2.0,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.2.0,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,============================== CLIENT ============================================
v1.2.0,image APIs
v1.2.0,or if you are implementing the client side call this function to get the most recent frame.
v1.2.0,returns false if there is no new frame available.
v1.2.0,============================== SERVER ============================================
v1.2.0,call this to send the image back over the connection given to start function.
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,"log every message that is ""sent"" using sendMessage."
v1.2.0,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.2.0,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.2.0,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.2.0,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,for compatibility with QGroundControl we have to save the time field in big endian.
v1.2.0,todo: mavlink2 support?
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,start listening to this connection
v1.2.0,Send heartbeat to drone.  You should not do this if some other node is
v1.2.0,already doing it.
v1.2.0,send a heart beat so that the remote node knows we are still alive
v1.2.0,(otherwise drone will trigger a failsafe operation).
v1.2.0,this is called for all messages received on the connection.
v1.2.0,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.2.0,subclasses remembering to call this base implementation.
v1.2.0,stop listening to the connection.
v1.2.0,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.2.0,wait for a heartbeat msg since this will give us the port to send commands to...
v1.2.0,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.2.0,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.0,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.0,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.0,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.0,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.0,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.2.0,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.2.0,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.2.0,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.2.0,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.2.0,"ok, now fetch the missing parameters."
v1.2.0,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.2.0,silently fail since we are on a background thread here...
v1.2.0,tell the caller this is complete.
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,add our custom telemetry message length.
v1.2.0,todo: if we support signing then initialize
v1.2.0,mavlink_intermediate_status_.signing callbacks
v1.2.0,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.2.0,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.2.0,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.2.0,send this right away just in case serial link is not already configured
v1.2.0,"log every message that is ""sent"" using sendMessage."
v1.2.0,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.2.0,pack the payload buffer.
v1.2.0,calculate checksum
v1.2.0,form the header as a byte array for the crc
v1.2.0,these macros use old style cast.
v1.2.0,forward messages from our connected node to the remote proxy.
v1.2.0,forward messages from remote proxy to local connected node
v1.2.0,CurrentThread::setMaximumPriority();
v1.2.0,"hmmm, wait till it is opened?"
v1.2.0,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.2.0,pick up the sysid/compid of the remote node we are connected to.
v1.2.0,then this is a mavlink 1 message
v1.2.0,then this mavlink sender supports mavlink 2
v1.2.0,queue event for publishing.
v1.2.0,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.2.0,as it ensures we don't lose messages if the listener is slow.
v1.2.0,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.2.0,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.2.0,we would get a deadlock.
v1.2.0,CurrentThread::setMaximumPriority();
v1.2.0,reset counters
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,------------------------------------------------------------------------------
v1.2.0,Defines
v1.2.0,------------------------------------------------------------------------------
v1.2.0,bit number  876543210987654321
v1.2.0,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.2.0,in future it would be good to have ability to add system IDs we are interested in
v1.2.0,if (msg.sysid != getTargetSystemId())
v1.2.0,{
v1.2.0,// we only care about messages from our intended remote node.
v1.2.0,return;
v1.2.0,}
v1.2.0,user may have changed modes on us! So we need to honor that and not
v1.2.0,try and take it back.
v1.2.0,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.2.0,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.2.0,we can store up to 16 channels in rc_channels_scaled.
v1.2.0,The RAW values of the servo outputs
v1.2.0,Metrics typically displayed on a HUD for fixed wing aircraft
v1.2.0,The IMU readings in SI units in NED body frame
v1.2.0,printSystemStatus(&msg);
v1.2.0,todo: use this to determine when we need to do emergency landing...
v1.2.0,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.2.0,Provides state for additional features
v1.2.0,The general system state
v1.2.0,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.2.0,but we do want to know when we get the ack.  So this is async ACK processing!
v1.2.0,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.2.0,if threshold < 0 then the threshold is inverted.
v1.2.0,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.2.0,Convert it to a floating point number between -1 and 1.
v1.2.0,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.2.0,until the move commands start happening.
v1.2.0,return true if user calls requestControl and has not called releaseControl.
v1.2.0,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.2.0,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.2.0,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.2.0,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.2.0,send a few to make sure it gets through...
v1.2.0,now the command should succeed.
v1.2.0,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.2.0,us by which time the PX4 times out offboard mode!!
v1.2.0,this mode change take precedence over offboard mode.
v1.2.0,thrust must be between -1 and 1.
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,These definitions are copied from PX4 implementation
v1.2.0,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.2.0,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.2.0,/ @brief Command opcodes
v1.2.0,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.2.0,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.2.0,must trim trailing slashes so PX4 doesn't hang!
v1.2.0,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.2.0,from the source.
v1.2.0,check if directory exists.
v1.2.0,perfect.
v1.2.0,use last_message_ so we preserve the sessionid.
v1.2.0,"could not create the local file, so stop."
v1.2.0,must use last_message_ so we preserve the session id.
v1.2.0,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.2.0,todo: error handling here? sequence is out of order...
v1.2.0,"directory must be empty then, can't do nextStep because"
v1.2.0,it will just loop for ever re-requesting zero offset into
v1.2.0,empty directory.
v1.2.0,result should be a list of null terminated file names.
v1.2.0,skipping this entry
v1.2.0,remove the file size field.
v1.2.0,"printf(""%s\n"", name.c_str());"
v1.2.0,request the next batch.
v1.2.0,"perhaps this was a late response after we did a retry, so ignore it."
v1.2.0,"perhaps this was a late response after we did a retry, so ignore it."
v1.2.0,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.2.0,reached the end of the list or the file.
v1.2.0,end of file or directory listing.
v1.2.0,"success, data should be following..."
v1.2.0,ack on this cmd is a noop
v1.2.0,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.2.0,give up then.
v1.2.0,tell watchdog we are sending a request
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,================================= CLIENT ==============================================================
v1.2.0,Check if we have a valid transaction
v1.2.0,emit signal if all packets arrived
v1.2.0,Restart statemachine
v1.2.0,image APIs
v1.2.0,================================= SERVER ==============================================================
v1.2.0,Prepare and send acknowledgment packet
v1.2.0,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.2.0,Send ENCAPSULATED_IMAGE packet
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.2.0,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.2.0,parse out the VID number
v1.2.0,now the PID
v1.2.0,parse out the VID number
v1.2.0,examples:
v1.2.0,PX4: USB\VID_26AC&PID_0011\0
v1.2.0,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.2.0,"printf(""Found: %S\n"", buffer.c_str());"
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.2.0,parse out the VID number
v1.2.0,now the PID
v1.2.0,parse out the VID number
v1.2.0,suppress
v1.2.0,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,This has not been properly tested
v1.2.0,struct iw_statistics stats;
v1.2.0,struct iwreq req;
v1.2.0,"memset(&stats, 0, sizeof(stats));"
v1.2.0,"memset(&req, 0, sizeof(iwreq));"
v1.2.0,
v1.2.0,"strncpy(req.ifr_name, ifaceName, 16);"
v1.2.0,req.u.data.pointer = &stats;
v1.2.0,req.u.data.length = sizeof(iw_statistics);
v1.2.0,
v1.2.0,#ifdef CLEAR_UPDATED
v1.2.0,req.u.data.flags = 1;
v1.2.0,#endif
v1.2.0,
v1.2.0,/* Perform the ioctl */
v1.2.0,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.2.0,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.2.0,return -127;
v1.2.0,}
v1.2.0,
v1.2.0,return stats.qual.level;
v1.2.0,todo: windows version of this...
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,windows
v1.2.0,Need to link with Ws2_32.lib
v1.2.0,posix
v1.2.0,found it!
v1.2.0,bind socket to local address.
v1.2.0,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.2.0,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.2.0,write to the serial port
v1.2.0,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.2.0,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.2.0,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.2.0,"try and receive something, up until port is closed anyway."
v1.2.0,"message was too large for the buffer, no problem, return what we have."
v1.2.0,try again - this can happen if server recreates the socket on their side.
v1.2.0,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.2.0,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.2.0,try again - this can happen if server recreates the socket on their side.
v1.2.0,"printf(""#### recv failed with error: %d\n"", hr);"
v1.2.0,we now have it.
v1.2.0,this is from someone we are not interested in.
v1.2.0,"printf(""Connection closed\n"");"
v1.2.0,-----------------------------------------------------------------------------------------
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,Initialize Winsock
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,windows
v1.2.0,Need to link with Ws2_32.lib
v1.2.0,posix
v1.2.0,found it!
v1.2.0,bind socket to local address.
v1.2.0,bind socket to local address.
v1.2.0,start listening for incoming connection
v1.2.0,accept 1
v1.2.0,write to the serial port
v1.2.0,"try and receive something, up until port is closed anyway."
v1.2.0,"message was too large for the buffer, no problem, return what we have."
v1.2.0,try again - this can happen if server recreates the socket on their side.
v1.2.0,"skip this, it is was interrupted."
v1.2.0,"printf(""Connection closed\n"");"
v1.2.0,-----------------------------------------------------------------------------------------
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.2.0,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.2.0,set signal
v1.2.0,Clear Handshake flags
v1.2.0,Set Handshake flags
v1.2.0,return GetLastError();
v1.2.0,return GetLastError();
v1.2.0,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.2.0,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.2.0,enable reading
v1.2.0,posix doesn't have mark/space parity.
v1.2.0,posix doesn't have mark/space parity.
v1.2.0,this is the default.
v1.2.0,not sure this is supported...
v1.2.0,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.2.0,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.2.0,First do those specified by POSIX.
v1.2.0,Now conditionally handle a bunch of extended rates.
v1.2.0,First do those specified by POSIX.
v1.2.0,Now conditionally handle a bunch of extended rates.
v1.2.0,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.2.0,","
v1.2.0,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.2.0,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,"in header only mode, control library is not available"
v1.2.0,TODO: something defines max macro which interfears with code here
v1.2.0,is cur_pos within fence?
v1.2.0,destination risk is not available then consider it zero
v1.2.0,if dest risk is lower than its more safe
v1.2.0,are we doing better than closest obstacle?
v1.2.0,"if we stay where we are, what is the risk distance?"
v1.2.0,else we are better of moving to dest
v1.2.0,this function should work even when dest_pos == cur_pos
v1.2.0,is this dest_pos cur_pos within the fence?
v1.2.0,transform dest_pos vector to body frame
v1.2.0,check for approx zero vectors to avoid random yaw angles
v1.2.0,we are hovering
v1.2.0,"get yaw in body frame, ie, front is always 0 radians"
v1.2.0,yaw to ticks
v1.2.0,get obstacles in the window at the tick direction around the window
v1.2.0,less risk distance is better
v1.2.0,check obstacles around current position and see if it has lower risk
v1.2.0,else obstacle is too far
v1.2.0,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.2.0,look for each surrounding tick to see if we have obstacle free angle
v1.2.0,else no suggestions required
v1.2.0,"3.2 comes from inverse CDF for epsilon = 0.05 (i.e. 95% confidence), author: akapoor"
v1.2.0,evaluate right and left side of circle
v1.2.0,find right and left risk distances
v1.2.0,at this point we have already determined hover is better than going to dest
v1.2.0,we now determine is moving to suggested angle better than hovering?
v1.2.0,check if dest_pos is safe
v1.2.0,breaking distance at this velocity
v1.2.0,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.2.0,check if dest_pos is safe
v1.2.0,float/vec parameters can have NaN which makes them optional
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,"in header only mode, control library is not available"
v1.2.0,handles +/- tick and wraps around circle
v1.2.0,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.2.0,update the specified window on the map
v1.2.0,make sure from <= to
v1.2.0,normalize the ticks so both are valid indices
v1.2.0,if from is still larger then
v1.2.0,to ticks is then added one full circle to make it larger than from_tick
v1.2.0,find closest obstacle in given window
v1.2.0,search whole map to find closest obstacle
v1.2.0,"in header only mode, control library is not available"
v1.2.0,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.2.0,"Windows, OSX and Linux."
v1.2.0,Windows users can move the Documents folder to any location they want
v1.2.0,SHGetFolderPath knows how to find it.
v1.2.0,fall back in case SHGetFolderPath failed for some reason.
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,"in header only mode, control library is not available"
v1.2.0,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.0,if using Unreal Build system then include precompiled header file first
v1.2.0,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.0,#undef check
v1.2.0,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.0,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.2.0,if we don't suppress then server will bomb out for exceptions raised by any method
v1.2.0,required for pimpl
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,"in header only mode, control library is not available"
v1.2.0,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.0,if using Unreal Build system then include precompiled header file first
v1.2.0,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.2.0,make sure we can talk to the DroneServer
v1.2.0,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.2.0,command_context.client.ping();
v1.2.0,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.2.0,sim only
v1.2.0,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.2.0,return value of last task. It should be true if task completed without
v1.2.0,cancellation or timeout
v1.2.0,"should be implemented by derived class if it supports async task,"
v1.2.0,for example using futures
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,"in header only mode, control library is not available"
v1.2.0,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.0,if using Unreal Build system then include precompiled header file first
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,"in header only mode, control library is not available"
v1.2.0,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.0,if using Unreal Build system then include precompiled header file first
v1.2.0,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.0,#undef check
v1.2.0,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.0,required for pimpl
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,"in header only mode, control library is not available"
v1.2.0,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.0,if using Unreal Build system then include precompiled header file first
v1.2.0,status getters
v1.2.0,return value of last task. It should be true if task completed without
v1.2.0,cancellation or timeout
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,"in header only mode, control library is not available"
v1.2.0,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.2.0,if using Unreal Build system then include pre-compiled header file first
v1.2.0,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.0,#undef check
v1.2.0,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.2.0,getters
v1.2.0,required for pimpl
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,"in header only mode, control library is not available"
v1.2.0,last command is to hold on to position
v1.2.0,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.2.0,after landing we detect if drone has stopped moving
v1.2.0,validate path size
v1.2.0,validate yaw mode
v1.2.0,validate and set auto-lookahead value
v1.2.0,if auto mode requested for lookahead then calculate based on velocity
v1.2.0,add current position as starting point
v1.2.0,append the input path and compute segments
v1.2.0,add last segment as zero length segment so we have equal number of segments and points.
v1.2.0,path_segs[i] refers to segment that starts at point i
v1.2.0,"when path ends, we want to slow down"
v1.2.0,else no need to change velocities for last segments
v1.2.0,setup current position on path to 0 offset
v1.2.0,initialize next path position
v1.2.0,until we are at the end of the path (last seg is always zero size)
v1.2.0,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.2.0,send drone command to get to next lookahead
v1.2.0,sleep for rest of the cycle
v1.2.0,how much have we moved towards last goal?
v1.2.0,project actual vector on goal vector
v1.2.0,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.2.0,TODO: below should be lower than 1E3 and configurable
v1.2.0,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.2.0,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.2.0,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.2.0,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.2.0,"if drone moved backward, we don't want goal to move backward as well"
v1.2.0,"so only climb forward on the path, never back. Also note >= which means"
v1.2.0,we climb path even if distance was 0 to take care of duplicated points on path
v1.2.0,else
v1.2.0,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.2.0,compute next target on path
v1.2.0,freeze the quaternion
v1.2.0,convert RC commands to velocity vector
v1.2.0,find yaw as per terrain and remote setting
v1.2.0,execute command
v1.2.0,if timeout occurred then command completed successfully otherwise it was interrupted
v1.2.0,change yaw by moving to same position but constant yaw mode
v1.2.0,by default we say that this command is not supported
v1.2.0,executes a given function until it returns true. Each execution is spaced apart at command period.
v1.2.0,"return value is true if exit was due to given function returning true, otherwise false (due to timeout)"
v1.2.0,get trims
v1.2.0,take average
v1.2.0,validate dest
v1.2.0,what is the distance we will travel at this velocity?
v1.2.0,get velocity vector
v1.2.0,yaw for the direction of travel
v1.2.0,find velocity vector
v1.2.0,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.2.0,generate velocity vector that is same size as cur_dest_norm / command period
v1.2.0,this velocity vect when executed for command period would yield cur_dest_norm
v1.2.0,send commands
v1.2.0,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.2.0,default strategy is for move. In hover mode we set new strategy temporarily
v1.2.0,are we supposed to do EM?
v1.2.0,get suggested velocity vector
v1.2.0,use the unchecked command
v1.2.0,tell caller not to execute planned command
v1.2.0,other wise throw exception
v1.2.0,otherwise there is some other reason why we are in unsafe situation
v1.2.0,send last command to come to full stop
v1.2.0,else no unsafe situation
v1.2.0,note: cur_path_loc and next_path_loc may both point to same object
v1.2.0,"otherwise use up this segment, move on to next one"
v1.2.0,if we are here then we ran out of segments
v1.2.0,consider last segment as zero length segment
v1.2.0,adjust yaw for the direction of travel in forward-only mode
v1.2.0,else no adjustment needed
v1.2.0,if auto mode requested for lookahead then calculate based on velocity
v1.2.0,Create a spring arm component for our chase camera
v1.2.0,"do nothing, spring arm is pulling the camera with it"
v1.2.0,"do nothing, we have camera turned off"
v1.2.0,set initial view mode
v1.2.0,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.2.0,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.2.0,"If the lag is missing, the camera will also occasionally shake."
v1.2.0,"But, lag is not desired when piloting a drone"
v1.2.0,attach spring arm to actor
v1.2.0,remember current parent for external camera. Later when we remove external
v1.2.0,"camera from spring arm, we will attach it back to its last parent"
v1.2.0,now attach camera to spring arm
v1.2.0,"For car, we need to move the camera back a little more than for a drone."
v1.2.0,"Otherwise, the camera will be stuck inside the car"
v1.2.0,ExternalCamera->bUsePawnControlRotation = false;
v1.2.0,detach spring arm
v1.2.0,Re-enable rendering
v1.2.0,Remove any existing key bindings for manual mode
v1.2.0,"else someone else is bound to manual pose controller, leave it alone"
v1.2.0,if new mode is manual mode then add key bindings
v1.2.0,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.2.0,other modes don't need special setup
v1.2.0,make switch official
v1.2.0,by default all image types are disabled
v1.2.0,use final color for all calculations
v1.2.0,use final color for all calculations
v1.2.0,TODO: should we be ignoring position and orientation settings here?
v1.2.0,TODO: can we eliminate storing NedTransform?
v1.2.0,if (!std::isnan(setting.target_gamma))
v1.2.0,camera-> = setting.target_gamma;
v1.2.0,do not make unnecessary calls to Activate() which otherwise causes crash in Unreal
v1.2.0,else nothing to enable
v1.2.0,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.2.0,if (controller && controller->GetViewTarget() == this)
v1.2.0,controller->SetViewTarget(nullptr);
v1.2.0,TODO: explore screenshot option
v1.2.0,addScreenCaptureHandler(camera->GetWorld());
v1.2.0,TODO: may be we should have these methods non-const?
v1.2.0,Wait for render so that view is ready for capture
v1.2.0,not sure why this doesn't work.
v1.2.0,"DECLARE_CYCLE_STAT(TEXT(""FNullGraphTask.CheckRenderStatus""), STAT_FNullGraphTask_CheckRenderStatus, STATGROUP_TaskGraphTasks);"
v1.2.0,"auto renderStatus = TGraphTask<FNullGraphTask>::CreateTask(NULL).ConstructAndDispatchWhenReady(GET_STATID(STAT_FNullGraphTask_CheckRenderStatus), ENamedThreads::RenderThread);"
v1.2.0,FTaskGraphInterface::Get().WaitUntilTaskCompletes(renderStatus);
v1.2.0,Make sure that all alpha values are opaque.
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,"#include ""Runtime/Foliage/Public/FoliageType.h"""
v1.2.0,TODO: change naming conventions to same as other files?
v1.2.0,Enable/disable primary viewport rendering flag
v1.2.0,This disables rendering of the main viewport in the same way as the
v1.2.0,"console command ""show rendering"" would do."
v1.2.0,"When getting an image through the API, the image is produced after the render"
v1.2.0,thread has finished rendering the current and the subsequent frame. This means
v1.2.0,that the frame rate for obtaining images through the API is only half as high as
v1.2.0,"it could be, since only every other image is actually captured. We work around"
v1.2.0,this by telling the viewport to flush the rendering queue at the end of each
v1.2.0,drawn frame so that it executes our render request at that point already.
v1.2.0,Do this only if the main viewport is not being rendered anyway in case there are
v1.2.0,any adverse performance effects during main rendering.
v1.2.0,HACK: FViewPort doesn't expose this field so we are doing dirty work around by maintaining count by ourselves
v1.2.0,HACK: FViewPort doesn't expose this field so we are doing dirty work around by maintaining count by ourselves
v1.2.0,nothing to do for now
v1.2.0,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.2.0,"UE_LOG(LogTemp, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.2.0,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.2.0,"UE_LOG(LogTemp, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.2.0,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.2.0,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.2.0,{
v1.2.0,InitializeObjectStencilID(*comp);
v1.2.0,}
v1.2.0,Access the subclass instance with the * or -> operators.
v1.2.0,can we see followee?
v1.2.0,remove mapping
v1.2.0,removing binding
v1.2.0,PNGs are saved as RGBA but FColors are stored as BGRA. An option to swap the order upon compression may be added at
v1.2.0,"some point. At the moment, manually swapping Red and Blue"
v1.2.0,Copy scaled image into destination thumb
v1.2.0,Compress data - convert into a .png
v1.2.0,if we already have attached actor
v1.2.0,#ifdef _MSC_VER
v1.2.0,//print to VS output window
v1.2.0,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.2.0,#endif
v1.2.0,also do default logging
v1.2.0,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.2.0,UGameUserSettings* AAirSimGameMode::GetGameUserSettings()
v1.2.0,{
v1.2.0,if (GEngine != nullptr)
v1.2.0,{
v1.2.0,return GEngine->GameUserSettings;
v1.2.0,}
v1.2.0,return nullptr;
v1.2.0,}
v1.2.0,UGameUserSettings* game_settings = GetGameUserSettings();
v1.2.0,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.2.0,game_settings->ApplySettings(true);
v1.2.0,"normally pawns have their center as origin. If we use this as 0,0,0 in NED then"
v1.2.0,"when we tell vehicle to go to 0,0,0 - it will try to go in the ground"
v1.2.0,"so we get the bounds and subtract z to get bottom as 0,0,0"
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,plugin startup
v1.2.0,plugin shutdown
v1.2.0,initialize state
v1.2.0,compute our home point
v1.2.0,add listener for pawn's collision event
v1.2.0,add cameras that already exists in pawn
v1.2.0,create or replace cameras specified in settings
v1.2.0,setup individual cameras
v1.2.0,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.2.0,for each camera in settings
v1.2.0,get pose
v1.2.0,spawn and attach camera to pawn
v1.2.0,add on to our collection
v1.2.0,Deflect along the surface when we collide.
v1.2.0,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.2.0,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.2.0,-1 to 1 --> 0 to 1
v1.2.0,-1 to 1
v1.2.0,these will be available for devices like steering wheels
v1.2.0,switch index 0 to 7 for FrSky Taranis RC is:
v1.2.0,"front-upper-left, front-upper-right, top-right-left, top-right-left, top-left-right, top-right-right, top-left-left, top-right-left"
v1.2.0,TODO: should below be at controller level info?
v1.2.0,else don't waste time
v1.2.0,update position from kinematics so we have latest position after physics update
v1.2.0,kinematics_->update();
v1.2.0,void playBack()
v1.2.0,{
v1.2.0,if (pawn_->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.2.0,pawn_->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.2.0,pawn_->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.2.0,}
v1.2.0,TODO: refactor below code used for playback
v1.2.0,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.2.0,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.2.0,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.2.0,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.2.0,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.2.0,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.2.0,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.2.0,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.2.0,}
v1.2.0,parameters in NED frame
v1.2.0,translate to new PawnSimApi position & orientation from NED to NEU
v1.2.0,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.2.0,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.2.0,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.2.0,checked at the start of next tick
v1.2.0,allow teleportation
v1.2.0,if collisions are not enabled
v1.2.0,or we have collided but passthrough is enabled
v1.2.0,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.2.0,"without flip flopping, collisions can't be detected"
v1.2.0,TODO: update other fields?
v1.2.0,no default action in this base class
v1.2.0,TODO: because this bug we are using alternative code with stringstream
v1.2.0,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.2.0,std::stringstream ss;
v1.2.0,"ss << timestamp_millis << ""\t"";"
v1.2.0,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.2.0,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.2.0,"ss << ""\n"";"
v1.2.0,return ss.str();
v1.2.0,"read pixels from render target using render thread, then compress the result into PNG"
v1.2.0,argument on the thread that calls this method.
v1.2.0,TODO: is below really needed?
v1.2.0,make sure we are not on the rendering thread
v1.2.0,TODO: below doesn't work right now because it must be running in game thread
v1.2.0,below is documented method but more expensive because it forces flush
v1.2.0,wait for render thread to pick up our task
v1.2.0,Queue up the task of rendering the scene in the render thread
v1.2.0,wait for this task to complete
v1.2.0,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.2.0,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.2.0,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.2.0,remove warnings for using safe VC++ APIs
v1.2.0,Stuff to filter out XInput devices
v1.2.0,-----------------------------------------------------------------------------
v1.2.0,"Defines, constants, and global variables"
v1.2.0,-----------------------------------------------------------------------------
v1.2.0,Magnitude ranges from -1 to 1
v1.2.0,Strength ranges from 0 to 1
v1.2.0,Autocenter
v1.2.0,Rumble
v1.2.0,Register with the DirectInput subsystem and get a pointer
v1.2.0,to a IDirectInput interface we can use.
v1.2.0,Create a DInput object
v1.2.0,Look for a simple joystick we can use for this sample program.
v1.2.0,Make sure we got a joystick
v1.2.0,"Set the data format to ""simple joystick"" - a predefined data format"
v1.2.0,
v1.2.0,"A data format specifies which controls on a device we are interested in,"
v1.2.0,and how they should be reported. This tells DInput that we will be
v1.2.0,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.2.0,Set the cooperative level to let DInput know how this device should
v1.2.0,interact with the system and with other DInput applications.
v1.2.0,Enumerate the joystick objects. The callback function enabled user
v1.2.0,"interface elements for objects that are found, and sets the min/max"
v1.2.0,values property for discovered axes.
v1.2.0,-----------------------------------------------------------------------------
v1.2.0,Enum each PNP device using WMI and check each device ID to see if it contains
v1.2.0,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then it's an XInput device"
v1.2.0,Unfortunately this information can not be found by just using DirectInput.
v1.2.0,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.2.0,XInput devices.
v1.2.0,
v1.2.0,This function stores the list of xinput devices in a linked list
v1.2.0,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.2.0,-----------------------------------------------------------------------------
v1.2.0,CoInit if needed
v1.2.0,Create WMI
v1.2.0,Create BSTRs for WMI
v1.2.0,Connect to WMI
v1.2.0,Switch security level to IMPERSONATE
v1.2.0,Get list of Win32_PNPEntity devices
v1.2.0,Loop over all devices
v1.2.0,Get 20 at a time
v1.2.0,"For each device, get its device ID"
v1.2.0,"Check if the device ID contains ""IG_"".  If it does, then it's an XInput device"
v1.2.0,Unfortunately this information can not be found by just using DirectInput
v1.2.0,"If it does, then get the VID/PID from var.bstrVal"
v1.2.0,Add the VID/PID to a linked list
v1.2.0,-----------------------------------------------------------------------------
v1.2.0,Returns true if the DirectInput device is also an XInput device.
v1.2.0,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.2.0,-----------------------------------------------------------------------------
v1.2.0,Check each xinput device to see if this device's vid/pid matches
v1.2.0,-----------------------------------------------------------------------------
v1.2.0,Cleanup needed for IsXInputDevice()
v1.2.0,-----------------------------------------------------------------------------
v1.2.0,Cleanup linked list
v1.2.0,-----------------------------------------------------------------------------
v1.2.0,Name: EnumJoysticksCallback()
v1.2.0,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.2.0,device interface on it so we can play with it.
v1.2.0,-----------------------------------------------------------------------------
v1.2.0,Skip anything other than the perferred joystick device as defined by the control panel.
v1.2.0,Instead you could store all the enumerated joysticks and let the user pick.
v1.2.0,Obtain an interface to the enumerated joystick.
v1.2.0,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.2.0,it while we were in the middle of enumerating it.)
v1.2.0,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.2.0,could store all the enumerated joysticks and let the user pick.
v1.2.0,-----------------------------------------------------------------------------
v1.2.0,Name: EnumObjectsCallback()
v1.2.0,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.2.0,joystick. This function enables user interface elements for objects
v1.2.0,"that are found to exist, and scales axes min/max values."
v1.2.0,-----------------------------------------------------------------------------
v1.2.0,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.2.0,enumerated axis in order to scale min/max values.
v1.2.0,Set the range for the axis
v1.2.0,Set the UI to reflect what objects the joystick supports
v1.2.0,-----------------------------------------------------------------------------
v1.2.0,Name: UpdateInputState()
v1.2.0,Desc: Get the input device's state and display it.
v1.2.0,-----------------------------------------------------------------------------
v1.2.0,Poll the device to read the current state
v1.2.0,DInput is telling us that the input stream has been
v1.2.0,"interrupted. We aren't tracking any state between polls, so"
v1.2.0,we don't have any special reset that needs to be done. We
v1.2.0,just re-acquire and try again.
v1.2.0,while (hr == DIERR_INPUTLOST)
v1.2.0,hr = g_pJoystick->Acquire();
v1.2.0,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.2.0,may occur when the app is minimized or in the process of
v1.2.0,"switching, so just try again later"
v1.2.0,Get the input's device state
v1.2.0,Axes
v1.2.0,Slider controls
v1.2.0,Points of view
v1.2.0,Buttons
v1.2.0,-----------------------------------------------------------------------------
v1.2.0,Name: FreeDirectInput()
v1.2.0,Desc: Initialize the DirectInput variables.
v1.2.0,-----------------------------------------------------------------------------
v1.2.0,Unacquire the device one last time just in case
v1.2.0,the app tried to exit while the device is still acquired.
v1.2.0,Release any DirectInput objects.
v1.2.0,nop
v1.2.0,normalize min to max --> 0 to 1
v1.2.0,normalize 0 to 1 --> -1 to 1
v1.2.0,#include <libudev.h>
v1.2.0,implementation for unsupported OS
v1.2.0,if this is new index
v1.2.0,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.2.0,close previous one
v1.2.0,open new device
v1.2.0,if open was successful
v1.2.0,read the device
v1.2.0,if we didn't had valid read
v1.2.0,"NOTE if this condition is not met, we're probably out of sync and this"
v1.2.0,Joystick instance is likely unusable
v1.2.0,TODO: set below to false?
v1.2.0,state.is_valid = false;
v1.2.0,else ignore
v1.2.0,TODO: implement this for linux
v1.2.0,TODO: implement this for linux
v1.2.0,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.2.0,{
v1.2.0,"manufacturerID = productID = """";"
v1.2.0,// Use udev to look up the product and manufacturer IDs
v1.2.0,struct udev *udev = udev_new();
v1.2.0,if (udev) {
v1.2.0,char sysname[32];
v1.2.0,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.2.0,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.2.0,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.2.0,if (!dev)
v1.2.0,{
v1.2.0,"message = ""Unable to find parent USB device"";"
v1.2.0,return false;
v1.2.0,}
v1.2.0,std::stringstream ss;
v1.2.0,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.2.0,ss >> manufacturerID;
v1.2.0,ss.clear();
v1.2.0,"ss.str("""");"
v1.2.0,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.2.0,ss >> productID;
v1.2.0,udev_device_unref(dev);
v1.2.0,}
v1.2.0,else
v1.2.0,{
v1.2.0,"message = ""Cannot create udev"";"
v1.2.0,return false;
v1.2.0,}
v1.2.0,udev_unref(udev);
v1.2.0,return true;
v1.2.0,}
v1.2.0,required for pimpl
v1.2.0,TODO: anyway to workaround const_cast?
v1.2.0,FGenericPlatformMisc::PlatformInit();
v1.2.0,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.2.0,TODO: index check
v1.2.0,create main widget
v1.2.0,synchronize PIP views
v1.2.0,TODO: should we only do below on SceneCapture2D components and cameras?
v1.2.0,avoid motion blur so capture images don't get
v1.2.0,use two different methods to set console var because sometime it doesn't seem to work
v1.2.0,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.2.0,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.2.0,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.2.0,"spawn at origin. We will use this to do global NED transforms, for ex, non-vehicle objects in environment"
v1.2.0,setup defaults
v1.2.0,Attempts to parse the settings text from one of multiple locations.
v1.2.0,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.2.0,"Next, check the executable's working directory for the settings file."
v1.2.0,"Finally, check the user's documents folder."
v1.2.0,"If the settings file cannot be read, throw an exception"
v1.2.0,Attempts to parse the settings text from the command line
v1.2.0,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.2.0,"Example: AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.2.0,"Returns true if the argument is present, false otherwise."
v1.2.0,build image file name
v1.2.0,write image file
v1.2.0,write to CSV file
v1.2.0,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.2.0,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.2.0,make sire all vars are set up
v1.2.0,"TODO: should we go as fast as possible, or should we limit this to a particular number of"
v1.2.0,frames per second?
v1.2.0,"UAirBlueprintLib::LogMessage(TEXT(""Stopped recording thread""), TEXT(""""), LogDebugLevel::Success);"
v1.2.0,TODO: get this from settings
v1.2.0,no effect in this sim mode
v1.2.0,no effect in this sim mode
v1.2.0,get UU origin of global NED frame
v1.2.0,TODO:make this configurable
v1.2.0,find all vehicle pawns
v1.2.0,add vehicles from settings
v1.2.0,if vehicle is of multirotor type and auto creatable
v1.2.0,decide which derived BP to use
v1.2.0,compute initial pose
v1.2.0,spawn vehicle pawn
v1.2.0,create API objects for each pawn we have
v1.2.0,initialize each vehicle pawn we found
v1.2.0,create vehicle sim api
v1.2.0,TODO: better handle no FPV vehicles scenario
v1.2.0,put camera little bit above vehicle
v1.2.0,update ground level
v1.2.0,TODO: get this from settings
v1.2.0,let base class setup physics world
v1.2.0,stop physics thread before we dismantle
v1.2.0,get UU origin of global NED frame
v1.2.0,TODO:make this configurable
v1.2.0,find all vehicle pawns
v1.2.0,add vehicles from settings
v1.2.0,if vehicle is of multirotor type and auto creatable
v1.2.0,decide which derived BP to use
v1.2.0,compute initial pose
v1.2.0,spawn vehicle pawn
v1.2.0,create API objects for each pawn we have
v1.2.0,initialize the pawn
v1.2.0,create vehicle sim api
v1.2.0,TODO: better handle no FPV vehicles scenario
v1.2.0,setup clock in ClockFactory
v1.2.0,scalable clock returns interval same as wall clock but multiplied by a scale factor
v1.2.0,steppable clock returns interval that is a constant number irrespective of wall clock
v1.2.0,we can either multiply this fixed interval by scale factor to speed up/down the clock
v1.2.0,but that would cause vehicles like quadrotors to become unstable
v1.2.0,so alternative we use here is instead to scale control loop frequency. The downside is that
v1.2.0,"depending on compute power available, we will max out control loop frequency and therefore can no longer"
v1.2.0,get increase in clock speed
v1.2.0,"Approach 1: scale clock period, no longer used now due to quadrotor instability"
v1.2.0,ClockFactory::get(std::make_shared<msr::airlib::SteppableClock>(
v1.2.0,static_cast<msr::airlib::TTimeDelta>(getPhysicsLoopPeriod() * 1E-9 * clock_speed)));
v1.2.0,Approach 2: scale control loop frequency if clock is speeded up
v1.2.0,"for slowing down, this don't generate instability"
v1.2.0,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.2.0,create vehicle API
v1.2.0,setup physics vehicle
v1.2.0,initialize private vars
v1.2.0,calls to update* are handled by physics engine and in SimModeWorldBase
v1.2.0,"Utils::log(""------Render tick-------"");"
v1.2.0,"if reset is pending then do it first, no need to do other things until next tick"
v1.2.0,move collision info from rendering engine to vehicle
v1.2.0,update rotor poses
v1.2.0,if we did reset then don't worry about synchronizing states for this tick
v1.2.0,Continue to wait for reset
v1.2.0,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response.collision_count_raw), LogDebugLevel::Unimportant);"
v1.2.0,*** Start: UpdatableState implementation ***//
v1.2.0,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.2.0,environment update for current position
v1.2.0,update forces on vertices
v1.2.0,update to controller must be done after kinematics have been updated by physics engine
v1.2.0,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.2.0,*** End: UpdatableState implementation ***//
v1.2.0,get references of existing camera
v1.2.0,TODO: get this from settings
v1.2.0,setup clock in PhysX
v1.2.0,get UU origin of global NED frame
v1.2.0,TODO:make this configurable
v1.2.0,find all vehicle pawns
v1.2.0,add vehicles from settings
v1.2.0,if vehicle is of multirotor type and auto creatable
v1.2.0,decide which derived BP to use
v1.2.0,compute initial pose
v1.2.0,spawn vehicle pawn
v1.2.0,create API objects for each pawn we have
v1.2.0,initialize each vehicle pawn we found
v1.2.0,create vehicle sim api
v1.2.0,TODO: better handle no FPV vehicles scenario
v1.2.0,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.2.0,Setup suspension forces
v1.2.0,Find the tire object and set the data for it
v1.2.0,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.2.0,Setup suspension forces
v1.2.0,Find the tire object and set the data for it
v1.2.0,Create In-Car camera component
v1.2.0,In car HUD
v1.2.0,Create text render component for in car speed display
v1.2.0,Create text render component for in car gear display
v1.2.0,Setup the audio component and allocate it a sound cue
v1.2.0,Colors for the in-car gear display. One for normal one for reverse
v1.2.0,Wheels/Tires
v1.2.0,Setup the wheels
v1.2.0,Adjust the tire loading
v1.2.0,Engine
v1.2.0,Torque setup
v1.2.0,Adjust the steering
v1.2.0,Transmission
v1.2.0,We want 4wd
v1.2.0,Drive the front wheels a little more than the rear
v1.2.0,Automatic gearbox
v1.2.0,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.2.0,Physics settings
v1.2.0,Adjust the center of mass - the buggy is quite low
v1.2.0,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.2.0,put camera little bit above vehicle
v1.2.0,update physics material
v1.2.0,Update the strings used in the HUD (in-car and on-screen)
v1.2.0,Set the string in the in-car HUD
v1.2.0,Pass the engine RPM to the sound component
v1.2.0,Start an engine sound playing
v1.2.0,Using FText because this is display text that should be localizable
v1.2.0,Setup the text render component strings
v1.2.0,This method must be in pawn because Unreal doesn't allow key bindings to non UObject pointers
v1.2.0,below is not needed
v1.2.0,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.2.0,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.2.0,TODO: should do reset() here?
v1.2.0,create vehicle params
v1.2.0,"std::shared_ptr<UnrealSensorFactory> sensor_factory = std::make_shared<UnrealSensorFactory>(getPawn(), &getNedTransform());"
v1.2.0,these are called on render ticks
v1.2.0,TODO: do we need this for cars?
v1.2.0,TODO: move this to SimModeBase?
v1.2.0,if ((joystick_state_.buttons & 4) | (joystick_state_.buttons & 1024)) { //X button or Start button
v1.2.0,reset();
v1.2.0,return;
v1.2.0,}
v1.2.0,Thrustmaster devices
v1.2.0,"Anything else, typically Logitech G920 wheel"
v1.2.0,Two steel levers behind wheel
v1.2.0,if API-client control is not active then we route keyboard/joystick control to car
v1.2.0,all car controls from anywhere must be routed through API component
v1.2.0,*** Start: UpdatableState implementation ***//
v1.2.0,physics tick
v1.2.0,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.2.0,*** End: UpdatableState implementation ***//
v1.2.0,TODO: implement arming for car
v1.2.0,TODO: directly accept getVehicleSimApis() using generic container
v1.2.0,remove everything that we created in BeginPlay
v1.2.0,we use custom debug reporting for this class
v1.2.0,perform any expensive rendering update outside of lock region
v1.2.0,no need to call base reset because of our custom implementation
v1.2.0,TODO: this is going to cause circular references which is fine here but
v1.2.0,in future we should consider moving SimMode not derived from AActor and move
v1.2.0,it to AirLib and directly implement WorldSimApiBase interface
v1.2.0,get player start
v1.2.0,this must be done from within actor otherwise we don't get player start
v1.2.0,else don't init
v1.2.0,else ignore
v1.2.0,should be overridden by derived class
v1.2.0,should be overridden by derived class
v1.2.0,this will be the case when compilation with RPCLIB is disabled or simmode doesn't support APIs
v1.2.0,default setup - this should be overridden in derived modes as needed
v1.2.0,setup clock in ClockFactory
v1.2.0,default implementation
v1.2.0,create director
v1.2.0,create external camera required for the director
v1.2.0,API server start/stop
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,update ray tracing
v1.2.0,"FString hit_name = FString(""None"");"
v1.2.0,if (dist_hit.GetActor())
v1.2.0,hit_name=dist_hit.GetActor()->GetName();
v1.2.0,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.2.0,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,This assumes you are running DroneServer already on the same machine.
v1.2.0,DroneServer must be running first.
v1.2.0,enable API control
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,move commands
v1.2.0,else leave as it is
v1.2.0,TODO: get these in one call
v1.2.0,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.2.0,TODO: shouldn't we pass folder path?
v1.2.0,parse
v1.2.0,group the images by the current date.
v1.2.0,"std::string beforeScriptStartCallback(const DroneCommandParameters& param, std::string scriptFilePath)"
v1.2.0,{
v1.2.0,"return """";"
v1.2.0,}
v1.2.0,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.2.0,{
v1.2.0,return false;
v1.2.0,}
v1.2.0,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.2.0,params.context->client.newTask();
v1.2.0,}
v1.2.0,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.2.0,params.context->client.WaitForCompletion(0);
v1.2.0,}
v1.2.0,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.2.0,{
v1.2.0,}
v1.2.0,parse command line
v1.2.0,Shell callbacks
v1.2.0,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.2.0,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.2.0,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.2.0,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.2.0,Add shell commands
v1.2.0,TODO: add WaitForCompletion command
v1.2.0,"TODO: add command line args help, arg count validation"
v1.2.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.2.0,Licensed under the MIT License.
v1.2.0,switch to explicit hover mode so that this is the fall back when
v1.2.0,move* commands are finished.
v1.2.0,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.2.0,60 acres park:
v1.2.0,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.2.0,marymoore park
v1.2.0,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,read settings and override defaults
v1.1.10,allow json overrides on a per-vehicle basis.
v1.1.10,start server in async mode
v1.1.10,check messages
v1.1.10,connect to the AirSim simulator
v1.1.10,monitor car state while you drive it manually.
v1.1.10,get state of the car
v1.1.10,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.1.10,return cls(**msgpack.unpack(encoded))
v1.1.10,basic flight control
v1.1.10,camera control
v1.1.10,simGetImage returns compressed png in array of bytes
v1.1.10,image_type uses one of the AirSimImageType members
v1.1.10,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.10,camera control
v1.1.10,simGetImage returns compressed png in array of bytes
v1.1.10,image_type uses one of the AirSimImageType members
v1.1.10,helper method for converting getOrientation to roll/pitch/yaw
v1.1.10,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.1.10,roll (x-axis rotation)
v1.1.10,pitch (y-axis rotation)
v1.1.10,yaw (z-axis rotation)
v1.1.10,DEY: I don't know why this was there.
v1.1.10,data = np.flipud(data)
v1.1.10,reverse the vertical line order and add null bytes at the start
v1.1.10,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.1.10,query vehicle state
v1.1.10,APIs for control
v1.1.10,-----------------------------------  Car APIs ---------------------------------------------
v1.1.10,Local variable access is faster in loops
v1.1.10,"if not wrapping over current pointer,"
v1.1.10,then check if there is terminal state wrapped inside
v1.1.10,"If index > history_length, take from a slice"
v1.1.10,Metrics accumulator
v1.1.10,Action Value model (used by agent to interact with the environment)
v1.1.10,"Target model used to compute the target Q-values in training, updated"
v1.1.10,less frequently for increased stability.
v1.1.10,Function computing Q-values targets as part of the computation graph
v1.1.10,"Define the loss, using Huber Loss (more robust to outliers)"
v1.1.10,Compute the q_targets
v1.1.10,actions is a 1-hot encoding of the action done by the agent
v1.1.10,Define training criterion as the Huber Loss function
v1.1.10,Adam based SGD
v1.1.10,Append the state to the short term memory (ie. History)
v1.1.10,"If policy requires agent to explore, sample random action"
v1.1.10,Use the network to output the best action
v1.1.10,Append batch axis with only one sample to evaluate
v1.1.10,Return the value maximizing the expected reward
v1.1.10,Keep track of interval action counter
v1.1.10,"If done, reset short term memory (ie. History)"
v1.1.10,Plot the metrics through Tensorboard and reset buffers
v1.1.10,Reset the short term memory
v1.1.10,Append to long term memory
v1.1.10,Update the Target Network if needed
v1.1.10,print(dist)
v1.1.10,connect to the AirSim simulator
v1.1.10,Make RL agent
v1.1.10,Train
v1.1.10,DEY: I don't know why this was there.
v1.1.10,data = np.flipud(data)
v1.1.10,In settings.json first activate computer vision mode:
v1.1.10,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.10,currently reset() doesn't work in CV mode. Below is the workaround
v1.1.10,connect to the AirSim simulator
v1.1.10,go forward
v1.1.10,get state of the car
v1.1.10,connect to the AirSim simulator
v1.1.10,get camera images from the car
v1.1.10,that's enough fun for now. let's quit cleanly
v1.1.10,import gym #pip install gym
v1.1.10,Local variable access is faster in loops
v1.1.10,"if not wrapping over current pointer,"
v1.1.10,then check if there is terminal state wrapped inside
v1.1.10,"If index > history_length, take from a slice"
v1.1.10,Metrics accumulator
v1.1.10,Action Value model (used by agent to interact with the environment)
v1.1.10,"Target model used to compute the target Q-values in training, updated"
v1.1.10,less frequently for increased stability.
v1.1.10,Function computing Q-values targets as part of the computation graph
v1.1.10,"Define the loss, using Huber Loss (more robust to outliers)"
v1.1.10,Compute the q_targets
v1.1.10,actions is a 1-hot encoding of the action done by the agent
v1.1.10,Define training criterion as the Huber Loss function
v1.1.10,Adam based SGD
v1.1.10,self._trainer.restore_from_checkpoint('models/oldmodels/model800000')
v1.1.10,Append the state to the short term memory (ie. History)
v1.1.10,"If policy requires agent to explore, sample random action"
v1.1.10,Use the network to output the best action
v1.1.10,Append batch axis with only one sample to evaluate
v1.1.10,Return the value maximizing the expected reward
v1.1.10,Keep track of interval action counter
v1.1.10,"If done, reset short term memory (ie. History)"
v1.1.10,Plot the metrics through Tensorboard and reset buffers
v1.1.10,Reset the short term memory
v1.1.10,Append to long term memory
v1.1.10,Update the Target Network if needed
v1.1.10,print(dist)
v1.1.10,Make RL agent
v1.1.10,Train
v1.1.10,use open cv to show new images from AirSim
v1.1.10,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.10,pip install opencv-python
v1.1.10,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.10,use open cv to create point cloud from depth image.
v1.1.10,###########################################
v1.1.10,######### This is work in progress! #######
v1.1.10,###########################################
v1.1.10,file will be saved in PythonClient folder (i.e. same folder as script)
v1.1.10,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.1.10,skip it
v1.1.10,AirSim uses NED coordinates so negative axis is up.
v1.1.10,z of -7 is 7 meters above the original launch point.
v1.1.10,Fly given velocity vector for 5 seconds
v1.1.10,using DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.1.10,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.1.10,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.1.10,Make the drone fly in a circle.
v1.1.10,check that our home position is stable
v1.1.10,AirSim uses NED coordinates so negative axis is up.
v1.1.10,ramp up time
v1.1.10,ramp up to full speed in smooth increments so we don't start too aggresively.
v1.1.10,compute current angle
v1.1.10,compute lookahead
v1.1.10,tracking # of completed orbits is surprisingly tricky to get right in order to handle random wobbles
v1.1.10,about the starting point.  So we watch for complete 1/2 orbits to avoid that problem.
v1.1.10,now we just have to watch for a smooth crossing from negative diff to positive diff
v1.1.10,ignore any large discontinuities
v1.1.10,watch direction this diff is moving if it switches from shrinking to growing
v1.1.10,then we passed the starting point.
v1.1.10,AirSim uses NED coordinates so negative axis is up.
v1.1.10,z of -7 is 7 meters above the original launch point.
v1.1.10,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.1.10,this method is async and we are not waiting for the result since we are passing max_wait_seconds=0.
v1.1.10,connect to the AirSim simulator
v1.1.10,get state of the car
v1.1.10,go forward
v1.1.10,Go forward + steer right
v1.1.10,go reverse
v1.1.10,apply breaks
v1.1.10,get camera images from the car
v1.1.10,restore to original state
v1.1.10,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.10,pip install opencv-python
v1.1.10,connect to the AirSim simulator
v1.1.10,AirSim uses NED coordinates so negative axis is up.
v1.1.10,let it settle there a bit.
v1.1.10,now compute the survey path required to fill the box
v1.1.10,In settings.json first activate computer vision mode:
v1.1.10,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.10,for block environment
v1.1.10,regex are case insensetive
v1.1.10,#for neighbourhood environment
v1.1.10,set object ID for sky
v1.1.10,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.1.10,get segmentation image in various formats
v1.1.10,save segmentation images in various formats
v1.1.10,"AirSimClientBase.write_pfm(os.path.normpath(filename + '.pfm'), AirSimClientBase.getPfmArray(response))"
v1.1.10,"AirSimClientBase.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.1.10,"AirSimClientBase.write_png(os.path.normpath(filename + '.numpy.png'), img_rgba) #write to png"
v1.1.10,find unique colors
v1.1.10,connect to the AirSim simulator
v1.1.10,get state of the car
v1.1.10,go forward
v1.1.10,Go forward + steer right
v1.1.10,go reverse
v1.1.10,apply breaks
v1.1.10,restore to original state
v1.1.10,"Go to object in Unreal Editor, click on it and then look for Tags property."
v1.1.10,"Add a tag ""MyObject"" (without quotes), save and the query using following line"
v1.1.10,see more about tags here: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.1.10,from keras.models import load_model
v1.1.10,if (len(sys.argv) != 2):
v1.1.10,print('usage: python drive.py <modelName>')
v1.1.10,sys.exit()
v1.1.10,print('Loading model...')
v1.1.10,model = load_model(sys.argv[1])
v1.1.10,connect to the AirSim simulator
v1.1.10,image_buf[0] = get_image()
v1.1.10,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.1.10,"model_output = model.predict([image_buf, state_buf])"
v1.1.10,car_controls.steering = float(model_output[0][0])
v1.1.10,connect to the AirSim simulator
v1.1.10,that's enough fun for now. let's quite cleanly
v1.1.10,use open cv to show new images from AirSim
v1.1.10,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.10,pip install opencv-python
v1.1.10,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.1.10,get depth image
v1.1.10,"this will return png width= 256, height= 144"
v1.1.10,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.1.10,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.1.10,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.1.10,to get an estimate of distance.
v1.1.10,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.1.10,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.1.10,an angular delta of the following pi/10.
v1.1.10,"in header only mode, control library is not available"
v1.1.10,if using Unreal Build system then include precompiled header file first
v1.1.10,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.10,"Windows, OSX and Linux."
v1.1.10,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.1.10,Windows users can move the Documents folder to any location they want
v1.1.10,SHGetFolderPath knows how to find it.
v1.1.10,fall back in case SHGetFolderPath failed for some reason.
v1.1.10,convert from std::path '/' to windows backslash.
v1.1.10,make the current thread run with maximum priority.
v1.1.10,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.1.10,TODO: How to handle POSIX thread priorities on OSX?
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.1.10,
v1.1.10,Treat all errors as failure conditions.
v1.1.10,parse command line
v1.1.10,"motive gives a weird error if the project is not found, so we look for it."
v1.1.10,Do an update to pick up any recently-arrived cameras.
v1.1.10,List all detected cameras.
v1.1.10,List all defined rigid bodies.
v1.1.10,throttle to 50 messages per second.
v1.1.10,OptiTrack uses 'y' axis for vertical.
v1.1.10,stdafx.cpp : source file that includes just the standard includes
v1.1.10,MavlinkMoCap.pch will be the pre-compiled header
v1.1.10,stdafx.obj will contain the pre-compiled type information
v1.1.10,TODO: reference any additional headers you need in STDAFX.H
v1.1.10,and not in this file
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,PX4.cpp : Defines the entry point for the console application.
v1.1.10,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.1.10,how do you write to the debug output windows on Unix ?
v1.1.10,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.1.10,connection to create to talke to that server.
v1.1.10,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.1.10,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.1.10,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.1.10,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.1.10,using their the -qgc option.
v1.1.10,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.1.10,this switch controls whether we turn off the RC remote active link loss detection
v1.1.10,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.1.10,from kicking in when you try and fly.
v1.1.10,can't use experimental stuff on Linux because of potential ABI issues
v1.1.10,parse the json
v1.1.10,flatten inner mavlink object
v1.1.10,flatten inner mavlink object
v1.1.10,todo
v1.1.10,todo
v1.1.10,"const char* outLogFileOption = ""outlogfile"";"
v1.1.10,parse command line
v1.1.10,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.1.10,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.1.10,"no local serial connection, so this is the primary droneConnection."
v1.1.10,failed to connect
v1.1.10,"local connection, then we own sending the heartbeat."
v1.1.10,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.1.10,cmdTable.push_back(new AltHoldCommand());
v1.1.10,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.1.10,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.1.10,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.1.10,this stops us from being able to connect to SITL mode PX4.
v1.1.10,checkPulse();
v1.1.10,add command text in log
v1.1.10,close previous command.
v1.1.10,FilterLogFiles(logDirectory);
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,send a heartbeat
v1.1.10,accept one incoming connection
v1.1.10,send a heartbeat to the client
v1.1.10,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.1.10,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.1.10,for this unit test we are expecting a request to send an image.
v1.1.10,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.1.10,hmmm
v1.1.10,================ ls
v1.1.10,================ put file
v1.1.10,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.1.10,================ get file
v1.1.10,verify the file contents.
v1.1.10,================ remove file
v1.1.10,================ make directory
v1.1.10,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.1.10,================ remove directory
v1.1.10,Now verification
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,from main.cpp.
v1.1.10,you must call this method if you want HandleMessage to be called subsequently.
v1.1.10,treat literals as one word
v1.1.10,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.10,request gps info
v1.1.10,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.1.10,find relative position since command start so we can compare two commands better
v1.1.10,TODO: make below future proof (i.e. usable by C++17 compiler) - also change same in main.cpp
v1.1.10,can't use experimental stuff on Linux because of potential ABI issues
v1.1.10,"these PID values are important, so set these to match"
v1.1.10,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.1.10,we can skip ahead.
v1.1.10,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.1.10,TODO: avoid passing hadcoded HIL flag
v1.1.10,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.1.10,"The global position, as returned by the Global Positioning System (GPS)."
v1.1.10,Provides state for additional features
v1.1.10,The general system state
v1.1.10,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.10,Provides state for additional features
v1.1.10,The general system state
v1.1.10,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.10,Provides state for additional features
v1.1.10,The general system state
v1.1.10,Provides state for additional features
v1.1.10,The general system state
v1.1.10,note: we do not reset com when Close() is called because we want to keep running.
v1.1.10,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.10,generate random between 0 and 1
v1.1.10,move to range -1 to 1
v1.1.10,scale it
v1.1.10,apply iy
v1.1.10,wait for the Execute method to be called.
v1.1.10,gps is much slower frequency than IMU.
v1.1.10,MAVLINK_MSG_ID_HIL_GPS
v1.1.10,disable MAV_USEHILGPS
v1.1.10,note: we do not reset com when Close() is called because we want to keep running.
v1.1.10,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.10,generate random between 0 and 1
v1.1.10,move to range -1 to 1
v1.1.10,scale it
v1.1.10,apply iy
v1.1.10,wait for the Execute method to be called.
v1.1.10,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.1.10,gps is much slower frequency than IMU.
v1.1.10,MAVLINK_MSG_ID_HIL_GPS
v1.1.10,disable HIL mode
v1.1.10,Enumeration of landed detector states
v1.1.10,MAV landed state is unknown
v1.1.10,MAV is landed (on ground)
v1.1.10,MAV is in air
v1.1.10,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.1.10,The filtered local position
v1.1.10,must send these regularly to keep offboard control.
v1.1.10,"ok, now we can safely switch to loiter."
v1.1.10,must send these regularly to keep offboard control.
v1.1.10,integrate the heading so it is smoother.
v1.1.10,must send these regularly to keep offboard control.
v1.1.10,integrate the heading so it is smoother.
v1.1.10,fly to radius
v1.1.10,it takes about 10 cm to stop and turn.
v1.1.10,next time around switch to orbiting!
v1.1.10,heading points to center of circle.
v1.1.10,interpoloate the speed ramp up time over 2 seconds from start time
v1.1.10,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.1.10,monitor the sin curves so we can see how on track or off track it actually is.
v1.1.10,the shape of the curve will also tell us if we are progressing at a consistent
v1.1.10,"speed, the more deformed the sin curve the worse our progress."
v1.1.10,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.1.10,degrees just flipped from 359 to 0.
v1.1.10,this enables us to test what happens when offboard control is lost and resumed.
v1.1.10,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.1.10,"ok, now we can start moving by velocity"
v1.1.10,recompute to new target.
v1.1.10,start by moving right with 10 degree roll.
v1.1.10,haven't started yet.
v1.1.10,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.1.10,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.1.10,track how our actual pitch is coming along compared to our target
v1.1.10,and check position
v1.1.10,the amount of pitch should depend on our speed in that direction.
v1.1.10,passed the midpoint.
v1.1.10,fade out the pitch as we pick up speed so we don't overshoot.
v1.1.10,see if we just crossed the wiggle distance threshold.
v1.1.10,(pitch affects the x-position).
v1.1.10,reverse direction with a -30 degrees quick stop
v1.1.10,reverse direction with a 30 degrees quick stop
v1.1.10,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.1.10,too much in that direction.
v1.1.10,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.10,track how our actual roll is coming along compared to our target
v1.1.10,and check position
v1.1.10,the amount of roll should depend on our speed in that direction.
v1.1.10,passed the midpoint.
v1.1.10,fade out the roll as we pick up speed so we don't overshoot.
v1.1.10,see if we just crossed the wiggle distance threshold.
v1.1.10,(roll affects the y-position).
v1.1.10,reverse direction with a -30 degrees quick stop
v1.1.10,reverse direction with a 30 degrees quick stop
v1.1.10,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.1.10,too much in that direction.
v1.1.10,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.10,for testing PID controller.
v1.1.10,class AltHoldCommand : public Command
v1.1.10,{
v1.1.10,std::shared_ptr<MavLinkVehicle> channel;
v1.1.10,"float sx_, sy_, sz_;"
v1.1.10,MavLinkAttitudeTarget _current;
v1.1.10,PidController thrust_controller_;
v1.1.10,public:
v1.1.10,this->sz_ = pos.z; // user defined target.
v1.1.10,move to local position keeps the offboard control happy.
v1.1.10,haven't started yet.
v1.1.10,and check position
v1.1.10,double dx = this->sx_ - pos.x;
v1.1.10,double dy = this->sy_ - pos.y;
v1.1.10,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.1.10,too much in that direction.
v1.1.10,adjust thrust so we keep steady height target
v1.1.10,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.10,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.1.10,local remote
v1.1.10,already handled by the parse method.
v1.1.10,we only support very simple patterns for now.
v1.1.10,each wildcard must be separated by literal.
v1.1.10,back to back wildcards with no literal in between is too complex.
v1.1.10,"we only support simple matching for now, we can add full regex later if we need it."
v1.1.10,yep!
v1.1.10,'*' is done we found the next matching char
v1.1.10,this is ok.
v1.1.10,this is an ERASE_END_LINE command which we ignore.
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,unpack the message...
v1.1.10,pack the payload buffer.
v1.1.10,"json can't handle ""nan"", so we convert it to null."
v1.1.10,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.1.10,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,start listening to this connection
v1.1.10,Send heartbeat to drone.  You should not do this if some other node is
v1.1.10,already doing it.
v1.1.10,stop listening to the connection.
v1.1.10,get the connection
v1.1.10,Get the local system and component id
v1.1.10,send a command to the remote node
v1.1.10,MavLinkNode::MavLinkNode() = default;
v1.1.10,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.1.10,decrementing the count so the next WaitOne may block.
v1.1.10,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.1.10,convert to absolute time.
v1.1.10,use mach_timespec
v1.1.10,convert to absolute time.
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,return true if we still have offboard control (can lose this if user flips the switch).
v1.1.10,MavLinkVehicle::MavLinkVehicle() = default;
v1.1.10,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.1.10,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,============================== CLIENT ============================================
v1.1.10,image APIs
v1.1.10,or if you are implementing the client side call this function to get the most recent frame.
v1.1.10,returns false if there is no new frame available.
v1.1.10,============================== SERVER ============================================
v1.1.10,call this to send the image back over the connection given to start function.
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,"log every message that is ""sent"" using sendMessage."
v1.1.10,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.1.10,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.1.10,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.1.10,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,for compatibility with QGroundControl we have to save the time field in big endian.
v1.1.10,todo: mavlink2 support?
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,start listening to this connection
v1.1.10,Send heartbeat to drone.  You should not do this if some other node is
v1.1.10,already doing it.
v1.1.10,send a heart beat so that the remote node knows we are still alive
v1.1.10,(otherwise drone will trigger a failsafe operation).
v1.1.10,this is called for all messages received on the connection.
v1.1.10,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.1.10,subclasses remembering to call this base implementation.
v1.1.10,stop listening to the connection.
v1.1.10,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.10,wait for a heartbeat msg since this will give us the port to send commands to...
v1.1.10,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.1.10,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.10,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.10,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.10,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.10,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.10,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.10,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.1.10,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.1.10,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.1.10,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.1.10,"ok, now fetch the missing parameters."
v1.1.10,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.1.10,silently fail since we are on a background thread here...
v1.1.10,tell the caller this is complete.
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,add our custom telemetry message length.
v1.1.10,todo: if we support signing then initialize
v1.1.10,mavlink_intermediate_status_.signing callbacks
v1.1.10,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.1.10,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.10,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.10,send this right away just in case serial link is not already configured
v1.1.10,"log every message that is ""sent"" using sendMessage."
v1.1.10,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.1.10,pack the payload buffer.
v1.1.10,calculate checksum
v1.1.10,form the header as a byte array for the crc
v1.1.10,these macros use old style cast.
v1.1.10,forward messages from our connected node to the remote proxy.
v1.1.10,forward messages from remote proxy to local connected node
v1.1.10,CurrentThread::setMaximumPriority();
v1.1.10,"hmmm, wait till it is opened?"
v1.1.10,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.1.10,pick up the sysid/compid of the remote node we are connected to.
v1.1.10,then this is a mavlink 1 message
v1.1.10,then this mavlink sender supports mavlink 2
v1.1.10,queue event for publishing.
v1.1.10,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.1.10,as it ensures we don't lose messages if the listener is slow.
v1.1.10,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.1.10,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.1.10,we would get a deadlock.
v1.1.10,CurrentThread::setMaximumPriority();
v1.1.10,reset counters
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,------------------------------------------------------------------------------
v1.1.10,Defines
v1.1.10,------------------------------------------------------------------------------
v1.1.10,bit number  876543210987654321
v1.1.10,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.1.10,in future it would be good to have ability to add system IDs we are interested in
v1.1.10,if (msg.sysid != getTargetSystemId())
v1.1.10,{
v1.1.10,// we only care about messages from our intended remote node.
v1.1.10,return;
v1.1.10,}
v1.1.10,user may have changed modes on us! So we need to honor that and not
v1.1.10,try and take it back.
v1.1.10,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.1.10,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.1.10,we can store up to 16 channels in rc_channels_scaled.
v1.1.10,The RAW values of the servo outputs
v1.1.10,Metrics typically displayed on a HUD for fixed wing aircraft
v1.1.10,The IMU readings in SI units in NED body frame
v1.1.10,printSystemStatus(&msg);
v1.1.10,todo: use this to determine when we need to do emergency landing...
v1.1.10,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.1.10,Provides state for additional features
v1.1.10,The general system state
v1.1.10,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.1.10,but we do want to know when we get the ack.  So this is async ACK processing!
v1.1.10,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.1.10,if threshold < 0 then the threshold is inverted.
v1.1.10,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.1.10,Convert it to a floating point number between -1 and 1.
v1.1.10,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.1.10,until the move commands start happening.
v1.1.10,return true if user calls requestControl and has not called releaseControl.
v1.1.10,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.1.10,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.1.10,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.1.10,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.1.10,send a few to make sure it gets through...
v1.1.10,now the command should succeed.
v1.1.10,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.1.10,us by which time the PX4 times out offboard mode!!
v1.1.10,this mode change take precedence over offboard mode.
v1.1.10,thrust must be between -1 and 1.
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,These definitions are copied from PX4 implementation
v1.1.10,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.1.10,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.1.10,/ @brief Command opcodes
v1.1.10,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.1.10,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.10,must trim trailing slashes so PX4 doesn't hang!
v1.1.10,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.1.10,from the source.
v1.1.10,check if directory exists.
v1.1.10,perfect.
v1.1.10,use last_message_ so we preserve the sessionid.
v1.1.10,"could not create the local file, so stop."
v1.1.10,must use last_message_ so we preserve the session id.
v1.1.10,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.1.10,todo: error handling here? sequence is out of order...
v1.1.10,"directory must be empty then, can't do nextStep because"
v1.1.10,it will just loop for ever re-requesting zero offset into
v1.1.10,empty directory.
v1.1.10,result should be a list of null terminated file names.
v1.1.10,skipping this entry
v1.1.10,remove the file size field.
v1.1.10,"printf(""%s\n"", name.c_str());"
v1.1.10,request the next batch.
v1.1.10,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.10,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.10,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.1.10,reached the end of the list or the file.
v1.1.10,end of file or directory listing.
v1.1.10,"success, data should be following..."
v1.1.10,ack on this cmd is a noop
v1.1.10,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.1.10,give up then.
v1.1.10,tell watchdog we are sending a request
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,================================= CLIENT ==============================================================
v1.1.10,Check if we have a valid transaction
v1.1.10,emit signal if all packets arrived
v1.1.10,Restart statemachine
v1.1.10,image APIs
v1.1.10,================================= SERVER ==============================================================
v1.1.10,Prepare and send acknowledgment packet
v1.1.10,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.1.10,Send ENCAPSULATED_IMAGE packet
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.1.10,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.10,parse out the VID number
v1.1.10,now the PID
v1.1.10,parse out the VID number
v1.1.10,examples:
v1.1.10,PX4: USB\VID_26AC&PID_0011\0
v1.1.10,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.1.10,"printf(""Found: %S\n"", buffer.c_str());"
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.10,parse out the VID number
v1.1.10,now the PID
v1.1.10,parse out the VID number
v1.1.10,suppress
v1.1.10,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,This has not been properly tested
v1.1.10,struct iw_statistics stats;
v1.1.10,struct iwreq req;
v1.1.10,"memset(&stats, 0, sizeof(stats));"
v1.1.10,"memset(&req, 0, sizeof(iwreq));"
v1.1.10,
v1.1.10,"strncpy(req.ifr_name, ifaceName, 16);"
v1.1.10,req.u.data.pointer = &stats;
v1.1.10,req.u.data.length = sizeof(iw_statistics);
v1.1.10,
v1.1.10,#ifdef CLEAR_UPDATED
v1.1.10,req.u.data.flags = 1;
v1.1.10,#endif
v1.1.10,
v1.1.10,/* Perform the ioctl */
v1.1.10,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.1.10,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.1.10,return -127;
v1.1.10,}
v1.1.10,
v1.1.10,return stats.qual.level;
v1.1.10,todo: windows version of this...
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,windows
v1.1.10,Need to link with Ws2_32.lib
v1.1.10,posix
v1.1.10,found it!
v1.1.10,bind socket to local address.
v1.1.10,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.1.10,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.1.10,write to the serial port
v1.1.10,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.1.10,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.1.10,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.1.10,"try and receive something, up until port is closed anyway."
v1.1.10,"message was too large for the buffer, no problem, return what we have."
v1.1.10,try again - this can happen if server recreates the socket on their side.
v1.1.10,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.10,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.10,try again - this can happen if server recreates the socket on their side.
v1.1.10,"printf(""#### recv failed with error: %d\n"", hr);"
v1.1.10,we now have it.
v1.1.10,this is from someone we are not interested in.
v1.1.10,"printf(""Connection closed\n"");"
v1.1.10,-----------------------------------------------------------------------------------------
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,Initialize Winsock
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,windows
v1.1.10,Need to link with Ws2_32.lib
v1.1.10,posix
v1.1.10,found it!
v1.1.10,bind socket to local address.
v1.1.10,bind socket to local address.
v1.1.10,start listening for incoming connection
v1.1.10,accept 1
v1.1.10,write to the serial port
v1.1.10,"try and receive something, up until port is closed anyway."
v1.1.10,"message was too large for the buffer, no problem, return what we have."
v1.1.10,try again - this can happen if server recreates the socket on their side.
v1.1.10,"skip this, it is was interrupted."
v1.1.10,"printf(""Connection closed\n"");"
v1.1.10,-----------------------------------------------------------------------------------------
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.1.10,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.1.10,set signal
v1.1.10,Clear Handshake flags
v1.1.10,Set Handshake flags
v1.1.10,return GetLastError();
v1.1.10,return GetLastError();
v1.1.10,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.10,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.1.10,enable reading
v1.1.10,posix doesn't have mark/space parity.
v1.1.10,posix doesn't have mark/space parity.
v1.1.10,this is the default.
v1.1.10,not sure this is supported...
v1.1.10,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.1.10,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.10,First do those specified by POSIX.
v1.1.10,Now conditionally handle a bunch of extended rates.
v1.1.10,First do those specified by POSIX.
v1.1.10,Now conditionally handle a bunch of extended rates.
v1.1.10,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.10,","
v1.1.10,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.1.10,"std::unique_ptr<TestBase>(new RosFlightTest()),"
v1.1.10,"std::unique_ptr<TestBase>(new QuaternionTest()),"
v1.1.10,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,"in header only mode, control library is not available"
v1.1.10,TODO: something defines max macro which interfears with code here
v1.1.10,is cur_pos within fence?
v1.1.10,destination risk is not available then consider it zero
v1.1.10,if dest risk is lower than its more safe
v1.1.10,are we doing better than closest obstacle?
v1.1.10,"if we stay where we are, what is the risk distance?"
v1.1.10,else we are better of moving to dest
v1.1.10,this function should work even when dest_pos == cur_pos
v1.1.10,is this dest_pos cur_pos within the fence?
v1.1.10,transform dest_pos vector to body frame
v1.1.10,check for approx zero vectors to avoid random yaw angles
v1.1.10,we are hovering
v1.1.10,"get yaw in body frame, ie, front is always 0 radians"
v1.1.10,yaw to ticks
v1.1.10,get obstacles in the window at the tick direction around the window
v1.1.10,less risk distance is better
v1.1.10,check obstacles around current position and see if it has lower risk
v1.1.10,else obstacle is too far
v1.1.10,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.1.10,look for each surrounding tick to see if we have obstacle free angle
v1.1.10,else no suggestions required
v1.1.10,"3.2 comes from inverse CDF for epsilone = 0.05 (i.e. 95% confidence), author: akapoor"
v1.1.10,evaluate right and left side of circle
v1.1.10,find right and left risk distances
v1.1.10,at this point we have already determined hover is better than going to dest
v1.1.10,we now determine is moving to suggested angle better than hovering?
v1.1.10,check if dest_pos is safe
v1.1.10,breaking distance at this velocity
v1.1.10,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.1.10,check if dest_pos is safe
v1.1.10,float/vec parameters can have NaN which makes them optional
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,"in header only mode, control library is not available"
v1.1.10,handles +/- tick and wraps around circle
v1.1.10,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.1.10,update the specified window on the map
v1.1.10,make dure from <= to
v1.1.10,normalize the ticks so bothe are valid indices
v1.1.10,if from is still larger then
v1.1.10,to ticks is then added one full circle to make it larger than from_tick
v1.1.10,find closest obstacle in given window
v1.1.10,search whole map to find closest obstacle
v1.1.10,"in header only mode, control library is not available"
v1.1.10,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.10,"Windows, OSX and Linux."
v1.1.10,Windows users can move the Documents folder to any location they want
v1.1.10,SHGetFolderPath knows how to find it.
v1.1.10,fall back in case SHGetFolderPath failed for some reason.
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,"in header only mode, control library is not available"
v1.1.10,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.10,if using Unreal Build system then include precompiled header file first
v1.1.10,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.10,#undef check
v1.1.10,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.10,sim only
v1.1.10,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.10,required for pimpl
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,"in header only mode, control library is not available"
v1.1.10,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.10,if using Unreal Build system then include precompiled header file first
v1.1.10,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.1.10,sim only
v1.1.10,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.10,make sure we can talk to the DroneServer
v1.1.10,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.1.10,command_context.client.ping();
v1.1.10,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,"in header only mode, control library is not available"
v1.1.10,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.10,if using Unreal Build system then include precompiled header file first
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,"in header only mode, control library is not available"
v1.1.10,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.10,if using Unreal Build system then include precompiled header file first
v1.1.10,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.10,#undef check
v1.1.10,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.10,required for pimpl
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,"in header only mode, control library is not available"
v1.1.10,if auto mode requested for lookahead then calculate based on velocity
v1.1.10,no-op by default. derived class can override it if needed
v1.1.10,no-op by default. derived class can override it if needed
v1.1.10,validate path size
v1.1.10,validate yaw mode
v1.1.10,validate and set auto-lookahead value
v1.1.10,if auto mode requested for lookahead then calculate based on velocity
v1.1.10,add current position as starting point
v1.1.10,append the input path and compute segments
v1.1.10,add last segment as zero length segment so we have equal number of segments and points.
v1.1.10,path_segs[i] refers to segment that starts at point i
v1.1.10,"when path ends, we want to slow down"
v1.1.10,else no need to change velocities for last segments
v1.1.10,setup current position on path to 0 offset
v1.1.10,initialize next path position
v1.1.10,until we are at the end of the path (last seg is always zero size)
v1.1.10,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.1.10,send drone command to get to next lookahead
v1.1.10,sleep for rest of the cycle
v1.1.10,how much have we moved towards last goal?
v1.1.10,project actual vector on goal vector
v1.1.10,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.1.10,TODO: below should be lower than 1E3 and configurable
v1.1.10,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.1.10,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.1.10,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.1.10,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.1.10,"if drone moved backward, we don't want goal to move backward as well"
v1.1.10,"so only climb forward on the path, never back. Also note >= which means"
v1.1.10,we climb path even if distance was 0 to take care of duplicated points on path
v1.1.10,else
v1.1.10,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.1.10,compute next target on path
v1.1.10,last command is to hold on to position
v1.1.10,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.1.10,default strategy is for move. In hover mode we set new strategy temporarily
v1.1.10,get trims
v1.1.10,take average
v1.1.10,freeze the quaternion
v1.1.10,convert RC commands to velocity vector
v1.1.10,find yaw as per terrain and remote setting
v1.1.10,execute command
v1.1.10,Only raise exception is time out occurred. If preempted then return status.
v1.1.10,are we supposed to do EM?
v1.1.10,get suggested velocity vector
v1.1.10,use the unchecked command
v1.1.10,tell caller not to execute planned command
v1.1.10,other wise throw exception
v1.1.10,otherwise there is some other reason why we are in unsafe situation
v1.1.10,send last command to come to full stop
v1.1.10,else no unsafe situation
v1.1.10,note: cur_path_loc and next_path_loc may both point to same object
v1.1.10,"otherwise use up this segment, move on to next one"
v1.1.10,if we are here then we ran out of segments
v1.1.10,consider last segment as zero length segment
v1.1.10,adjust yaw for the direction of travel in foward-only mode
v1.1.10,else no adjustment needed
v1.1.10,validate dest
v1.1.10,what is the distance we will travel at this velocity?
v1.1.10,get velocity vector
v1.1.10,yaw for the direction of travel
v1.1.10,find velocity vector
v1.1.10,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.1.10,generate velocity vector that is same size as cur_dest_norm / command period
v1.1.10,this velocity vect when executed for command period would yield cur_dest_norm
v1.1.10,send commands
v1.1.10,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.1.10,by default indicate that we don't have alternative pose info
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,"in header only mode, control library is not available"
v1.1.10,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.10,if using Unreal Build system then include precompiled header file first
v1.1.10,status getters
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,"in header only mode, control library is not available"
v1.1.10,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.10,if using Unreal Build system then include precompiled header file first
v1.1.10,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.10,#undef check
v1.1.10,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.10,getters
v1.1.10,required for pimpl
v1.1.10,Create a spring arm component for our chase camera
v1.1.10,"do nothing, spring arm is pulling the camera with it"
v1.1.10,"do nothing, we have camera turned off"
v1.1.10,set initial view mode
v1.1.10,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.1.10,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.1.10,"If the lag is missing, the camera will also occasionally shake."
v1.1.10,"But, lag is not desired when piloting a drone"
v1.1.10,attach spring arm to actor
v1.1.10,remember current parent for external camera. Later when we remove external
v1.1.10,"camera from spring arm, we will attach it back to its last parent"
v1.1.10,now attach camera to spring arm
v1.1.10,"For car, we need to move the camera back a little more than for a drone."
v1.1.10,"Otherwise, the camera will be stuck inside the car"
v1.1.10,external_camera_->bUsePawnControlRotation = false;
v1.1.10,detach spring arm
v1.1.10,Re-enable rendering
v1.1.10,Remove any existing key bindings for manual mode
v1.1.10,"else someone else is bound to manual pose controller, leave it alone"
v1.1.10,if new mode is manual mode then add key bindings
v1.1.10,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.1.10,other modes don't need special setup
v1.1.10,make switch official
v1.1.10,Deflect along the surface when we collide.
v1.1.10,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.1.10,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.1.10,find out which RC we should use
v1.1.10,find out which RC we should use
v1.1.10,initialize state
v1.1.10,compute our home point
v1.1.10,should be overridden in derived class
v1.1.10,if (pawn_->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.1.10,pawn_->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.1.10,pawn_->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.1.10,}
v1.1.10,TODO: refactor below code used for playback
v1.1.10,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.10,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.10,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.10,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.10,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.1.10,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.10,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.1.10,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.10,parameters in NED frame
v1.1.10,translate to new VehiclePawnWrapper position & orientation from NED to NEU
v1.1.10,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.1.10,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.1.10,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.1.10,checked at the start of next tick
v1.1.10,allow teleportation
v1.1.10,if collisions are not enabled
v1.1.10,or we have collided but passthrough is enabled
v1.1.10,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.1.10,"without flip flopping, collisions can't be detected"
v1.1.10,Computer transform using the actor that this camera is attached to
v1.1.10,if this is free floting camera like external observer camera then just use
v1.1.10,itself to select origin point
v1.1.10,by default all image types are disabled
v1.1.10,use final color for all calculations
v1.1.10,use final color for all calculations
v1.1.10,if (!std::isnan(setting.target_gamma))
v1.1.10,camera-> = setting.target_gamma;
v1.1.10,do not make unnecessory calls to Activate() which otherwise causes crash in Unreal
v1.1.10,else nothing to enable
v1.1.10,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.1.10,if (controller && controller->GetViewTarget() == this)
v1.1.10,controller->SetViewTarget(nullptr);
v1.1.10,TODO: explore screenshot option
v1.1.10,addScreenCaptureHandler(camera->GetWorld());
v1.1.10,Wait for render so that view is ready for capture
v1.1.10,not sure why this doesn't work.
v1.1.10,"DECLARE_CYCLE_STAT(TEXT(""FNullGraphTask.CheckRenderStatus""), STAT_FNullGraphTask_CheckRenderStatus, STATGROUP_TaskGraphTasks);"
v1.1.10,"auto renderStatus = TGraphTask<FNullGraphTask>::CreateTask(NULL).ConstructAndDispatchWhenReady(GET_STATID(STAT_FNullGraphTask_CheckRenderStatus), ENamedThreads::RenderThread);"
v1.1.10,FTaskGraphInterface::Get().WaitUntilTaskCompletes(renderStatus);
v1.1.10,Make sure that all alpha values are opaque.
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,"#include ""Runtime/Foliage/Public/FoliageType.h"""
v1.1.10,TODO: change naming conventions to same as other files?
v1.1.10,Enable/disable primary viewport rendering flag
v1.1.10,This disables rendering of the main viewport in the same way as the
v1.1.10,"console command ""show rendering"" would do."
v1.1.10,"When getting an image through the API, the image is produced after the render"
v1.1.10,thread has finished rendering the current and the subsequent frame. This means
v1.1.10,that the frame rate for obtaining images through the API is only half as high as
v1.1.10,"it could be, since only every other image is actually captured. We work around"
v1.1.10,this by telling the viewport to flush the rendering queue at the end of each
v1.1.10,drawn frame so that it executes our render request at that point already.
v1.1.10,Do this only if the main viewport is not being rendered anyway in case there are
v1.1.10,any adverse performance effects during main rendering.
v1.1.10,HACK: FViewPort doesn't expose this field so we are doing dirty work around by maintaining count by ourselves
v1.1.10,HACK: FViewPort doesn't expose this field so we are doing dirty work around by maintaining count by ourselves
v1.1.10,nothing to do for now
v1.1.10,"UE_LOG(LogAirSim, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.1.10,"UE_LOG(LogAirSim, Log, TEXT(""%s%s""), *prefix, *suffix);"
v1.1.10,"UE_LOG(LogAirSim, Error, TEXT(""%s%s""), *prefix, *suffix);"
v1.1.10,"UE_LOG(LogAirSim, Verbose, TEXT(""%s%s""), *prefix, *suffix);"
v1.1.10,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.1.10,"UAirBlueprintLib::LogMessage(name + TEXT("" Actor not found!""), TEXT(""""), LogDebugLevel::Failure);"
v1.1.10,common_utils::Utils::DebugBreak();
v1.1.10,mesh->SetVisibility(false);
v1.1.10,mesh->SetVisibility(true);
v1.1.10,Explicitly set the custom depth state on the components so the
v1.1.10,render state is marked dirty and the update actually takes effect
v1.1.10,immediately.
v1.1.10,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.1.10,{
v1.1.10,InitializeObjectStencilID(*comp);
v1.1.10,}
v1.1.10,Access the subclass instance with the * or -> operators.
v1.1.10,can we see followee?
v1.1.10,remove mapping
v1.1.10,removing binding
v1.1.10,"TODO: can't do remove because there is no ""stamp"" on who established binding"
v1.1.10,removeInputBindings();
v1.1.10,#ifdef _MSC_VER
v1.1.10,//print to VS output window
v1.1.10,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.1.10,#endif
v1.1.10,also do default logging
v1.1.10,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.1.10,UGameUserSettings* game_settings = GetGameUserSettings();
v1.1.10,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.1.10,game_settings->ApplySettings(true);
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,plugin startup
v1.1.10,plugin shutdown
v1.1.10,"read pixels from render target using render thread, then compress the result into PNG"
v1.1.10,argument on the thread that calls this method.
v1.1.10,TODO: is below really needed?
v1.1.10,make sure we are not on the rendering thread
v1.1.10,TODO: below doesn't work right now because it must be running in game thread
v1.1.10,below is documented method but more expensive because it forces flush
v1.1.10,wait for render thread to pick up our task
v1.1.10,Queue up the task of rendering the scene in the render thread
v1.1.10,wait for this task to complete
v1.1.10,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.1.10,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.1.10,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.1.10,Stuff to filter out XInput devices
v1.1.10,-----------------------------------------------------------------------------
v1.1.10,"Defines, constants, and global variables"
v1.1.10,-----------------------------------------------------------------------------
v1.1.10,Register with the DirectInput subsystem and get a pointer
v1.1.10,to a IDirectInput interface we can use.
v1.1.10,Create a DInput object
v1.1.10,Look for a simple joystick we can use for this sample program.
v1.1.10,Make sure we got a joystick
v1.1.10,"Set the data format to ""simple joystick"" - a predefined data format"
v1.1.10,
v1.1.10,"A data format specifies which controls on a device we are interested in,"
v1.1.10,and how they should be reported. This tells DInput that we will be
v1.1.10,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.1.10,Set the cooperative level to let DInput know how this device should
v1.1.10,interact with the system and with other DInput applications.
v1.1.10,Enumerate the joystick objects. The callback function enabled user
v1.1.10,"interface elements for objects that are found, and sets the min/max"
v1.1.10,values property for discovered axes.
v1.1.10,-----------------------------------------------------------------------------
v1.1.10,Enum each PNP device using WMI and check each device ID to see if it contains
v1.1.10,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then its an XInput device"
v1.1.10,Unfortunately this information can not be found by just using DirectInput.
v1.1.10,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.1.10,XInput devices.
v1.1.10,
v1.1.10,This function stores the list of xinput devices in a linked list
v1.1.10,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.1.10,-----------------------------------------------------------------------------
v1.1.10,CoInit if needed
v1.1.10,Create WMI
v1.1.10,Create BSTRs for WMI
v1.1.10,Connect to WMI
v1.1.10,Switch security level to IMPERSONATE
v1.1.10,Get list of Win32_PNPEntity devices
v1.1.10,Loop over all devices
v1.1.10,Get 20 at a time
v1.1.10,"For each device, get its device ID"
v1.1.10,"Check if the device ID contains ""IG_"".  If it does, then its an XInput device"
v1.1.10,Unfortunately this information can not be found by just using DirectInput
v1.1.10,"If it does, then get the VID/PID from var.bstrVal"
v1.1.10,Add the VID/PID to a linked list
v1.1.10,-----------------------------------------------------------------------------
v1.1.10,Returns true if the DirectInput device is also an XInput device.
v1.1.10,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.1.10,-----------------------------------------------------------------------------
v1.1.10,Check each xinput device to see if this device's vid/pid matches
v1.1.10,-----------------------------------------------------------------------------
v1.1.10,Cleanup needed for IsXInputDevice()
v1.1.10,-----------------------------------------------------------------------------
v1.1.10,Cleanup linked list
v1.1.10,-----------------------------------------------------------------------------
v1.1.10,Name: EnumJoysticksCallback()
v1.1.10,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.1.10,device interface on it so we can play with it.
v1.1.10,-----------------------------------------------------------------------------
v1.1.10,Skip anything other than the perferred joystick device as defined by the control panel.
v1.1.10,Instead you could store all the enumerated joysticks and let the user pick.
v1.1.10,Obtain an interface to the enumerated joystick.
v1.1.10,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.1.10,it while we were in the middle of enumerating it.)
v1.1.10,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.1.10,could store all the enumerated joysticks and let the user pick.
v1.1.10,-----------------------------------------------------------------------------
v1.1.10,Name: EnumObjectsCallback()
v1.1.10,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.1.10,joystick. This function enables user interface elements for objects
v1.1.10,"that are found to exist, and scales axes min/max values."
v1.1.10,-----------------------------------------------------------------------------
v1.1.10,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.1.10,enumerated axis in order to scale min/max values.
v1.1.10,Set the range for the axis
v1.1.10,Set the UI to reflect what objects the joystick supports
v1.1.10,-----------------------------------------------------------------------------
v1.1.10,Name: UpdateInputState()
v1.1.10,Desc: Get the input device's state and display it.
v1.1.10,-----------------------------------------------------------------------------
v1.1.10,Poll the device to read the current state
v1.1.10,DInput is telling us that the input stream has been
v1.1.10,"interrupted. We aren't tracking any state between polls, so"
v1.1.10,we don't have any special reset that needs to be done. We
v1.1.10,just re-acquire and try again.
v1.1.10,while (hr == DIERR_INPUTLOST)
v1.1.10,hr = g_pJoystick->Acquire();
v1.1.10,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.1.10,may occur when the app is minimized or in the process of
v1.1.10,"switching, so just try again later"
v1.1.10,Get the input's device state
v1.1.10,Axes
v1.1.10,Slider controls
v1.1.10,Points of view
v1.1.10,Buttons
v1.1.10,-----------------------------------------------------------------------------
v1.1.10,Name: FreeDirectInput()
v1.1.10,Desc: Initialize the DirectInput variables.
v1.1.10,-----------------------------------------------------------------------------
v1.1.10,Unacquire the device one last time just in case
v1.1.10,the app tried to exit while the device is still acquired.
v1.1.10,Release any DirectInput objects.
v1.1.10,nop
v1.1.10,normalize min to max --> 0 to 1
v1.1.10,normalize 0 to 1 --> -1 to 1
v1.1.10,#include <libudev.h>
v1.1.10,implementation for unsupported OS
v1.1.10,if this is new indec
v1.1.10,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.1.10,close previos one
v1.1.10,open new device
v1.1.10,if open was sucessfull
v1.1.10,read the device
v1.1.10,if we didn't had valid read
v1.1.10,"NOTE if this condition is not met, we're probably out of sync and this"
v1.1.10,Joystick instance is likely unusable
v1.1.10,TODO: set below to false?
v1.1.10,state.is_valid = false;
v1.1.10,else ignore
v1.1.10,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.1.10,{
v1.1.10,"manufacturerID = productID = """";"
v1.1.10,// Use udev to look up the product and manufacturer IDs
v1.1.10,struct udev *udev = udev_new();
v1.1.10,if (udev) {
v1.1.10,char sysname[32];
v1.1.10,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.1.10,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.1.10,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.1.10,if (!dev)
v1.1.10,{
v1.1.10,"message = ""Unable to find parent USB device"";"
v1.1.10,return false;
v1.1.10,}
v1.1.10,std::stringstream ss;
v1.1.10,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.1.10,ss >> manufacturerID;
v1.1.10,ss.clear();
v1.1.10,"ss.str("""");"
v1.1.10,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.1.10,ss >> productID;
v1.1.10,udev_device_unref(dev);
v1.1.10,}
v1.1.10,else
v1.1.10,{
v1.1.10,"message = ""Cannot create udev"";"
v1.1.10,return false;
v1.1.10,}
v1.1.10,udev_unref(udev);
v1.1.10,return true;
v1.1.10,}
v1.1.10,required for pimpl
v1.1.10,FGenericPlatformMisc::PlatformInit();
v1.1.10,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.1.10,TODO: index check
v1.1.10,create main widget
v1.1.10,synchronize PIP views
v1.1.10,TODO: should we only do below on SceneCapture2D components and cameras?
v1.1.10,avoid motion blur so capture images don't get
v1.1.10,use two different methods to set console var because sometime it doesn't seem to work
v1.1.10,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.1.10,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.1.10,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.1.10,setup defaults
v1.1.10,Attempts to parse the settings text from one of multiple locations.
v1.1.10,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.1.10,"Next, check the executable's working directory for the settings file."
v1.1.10,"Finally, check the user's documents folder."
v1.1.10,"If the settings file cannot be read, throw an exception"
v1.1.10,Attempts to parse the settings text from the command line
v1.1.10,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.1.10,"Example: AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.1.10,"Returns true if the argument is present, false otherwise."
v1.1.10,create control server
v1.1.10,stop physics thread before we dismental
v1.1.10,for (AActor* actor : spawned_actors_) {
v1.1.10,actor->Destroy();
v1.1.10,}
v1.1.10,fpv_vehicle_connectors_.Empty();
v1.1.10,get player controller
v1.1.10,put camera little bit above vehicle
v1.1.10,we will either find external camera if it already exist in evironment or create one
v1.1.10,find all BP camera directors in the environment
v1.1.10,create director
v1.1.10,create external camera required for the director
v1.1.10,find all vehicle pawns
v1.1.10,if no vehicle pawns exists in environment
v1.1.10,create vehicle pawn
v1.1.10,set up vehicle pawns
v1.1.10,initialize each vehicle pawn we found
v1.1.10,chose first pawn as FPV if none is designated as FPV
v1.1.10,now create the connector for each pawn
v1.1.10,else we don't have vehicle for this pawn
v1.1.10,TODO: because this bug we are using alternative code with stringstream
v1.1.10,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.1.10,std::stringstream ss;
v1.1.10,"ss << timestamp_millis << ""\t"";"
v1.1.10,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.1.10,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.1.10,"ss << ""\n"";"
v1.1.10,return ss.str();
v1.1.10,find vehicles and cameras available in environment
v1.1.10,if none available then we will create one
v1.1.10,get references of components so we can use later
v1.1.10,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.1.10,"Can't obtain NedTransform from wrapper because it's not initialized yet, so make our own."
v1.1.10,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.1.10,-1 to 1 --> 0 to 1
v1.1.10,convert 0 to 1 -> -1 to 1
v1.1.10,TODO: add fields for z axis?
v1.1.10,last 8 bits are not used for now
v1.1.10,TODO: should below be at controller level info?
v1.1.10,else don't waste time
v1.1.10,"Utils::log(""------Render tick-------"");"
v1.1.10,"if reset is pending then do it first, no need to do other things until next tick"
v1.1.10,move collision info from rendering engine to vehicle
v1.1.10,update ground level
v1.1.10,update rotor poses
v1.1.10,if we did reset then don't worry about synchrnozing states for this tick
v1.1.10,Continue to wait for reset
v1.1.10,update rotor animations
v1.1.10,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response_info.collision_count_raw), LogDebugLevel::Unimportant);"
v1.1.10,Kinematics::State kinematics_estimated = controller_->getKinematicsEstimated();
v1.1.10,Kinematics::State kinematics_true = vehicle_.getKinematics();
v1.1.10,"UAirBlueprintLib::LogMessageString(""Position (true): "", VectorMath::toString(kinematics_true.pose.position), LogDebugLevel::Informational);"
v1.1.10,"UAirBlueprintLib::LogMessageString(""Position (est): "", VectorMath::toString(kinematics_estimated.pose.position), LogDebugLevel::Informational);"
v1.1.10,"UAirBlueprintLib::LogMessageString(""Lin Velocity (true): "", VectorMath::toString(kinematics_true.twist.linear), LogDebugLevel::Informational);"
v1.1.10,"UAirBlueprintLib::LogMessageString(""Lin Velocity (est): "", VectorMath::toString(kinematics_estimated.twist.linear), LogDebugLevel::Informational);"
v1.1.10,"UAirBlueprintLib::LogMessageString(""Ang Velocity (true): "", VectorMath::toString(kinematics_true.twist.angular), LogDebugLevel::Informational);"
v1.1.10,"UAirBlueprintLib::LogMessageString(""Ang Velocity (est): "", VectorMath::toString(kinematics_estimated.twist.angular), LogDebugLevel::Informational);"
v1.1.10,"UAirBlueprintLib::LogMessageString(""Lin Accel (true): "", VectorMath::toString(kinematics_true.accelerations.linear), LogDebugLevel::Informational);"
v1.1.10,"UAirBlueprintLib::LogMessageString(""Lin Accel (est): "", VectorMath::toString(kinematics_estimated.accelerations.linear), LogDebugLevel::Informational);"
v1.1.10,"UAirBlueprintLib::LogMessageString(""Ang Accel (true): "", VectorMath::toString(kinematics_true.accelerations.angular), LogDebugLevel::Informational);"
v1.1.10,"UAirBlueprintLib::LogMessageString(""Ang Accel (est): "", VectorMath::toString(kinematics_estimated.accelerations.angular), LogDebugLevel::Informational);"
v1.1.10,"UAirBlueprintLib::LogMessageString(""Orien (true): "", VectorMath::toString(kinematics_true.pose.orientation), LogDebugLevel::Informational);"
v1.1.10,"UAirBlueprintLib::LogMessageString(""Orien (est): "", VectorMath::toString(kinematics_estimated.pose.orientation), LogDebugLevel::Informational);"
v1.1.10,*** Start: UpdatableState implementation ***//
v1.1.10,schedule the task which we will execute in tick event when World object is locked
v1.1.10,TODO: should this be done in MultiRotor.hpp
v1.1.10,controller_->reset();
v1.1.10,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.1.10,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.1.10,*** End: UpdatableState implementation ***//
v1.1.10,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.1.10,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.1.10,make sire all vars are set up
v1.1.10,"todo: should we go as fast as possible, or should we limit this to a particular number of"
v1.1.10,frames per second?
v1.1.10,"UAirBlueprintLib::LogMessage(TEXT(""Stopped recording thread""), TEXT(""""), LogDebugLevel::Success);"
v1.1.10,get player controller
v1.1.10,put camera little bit above vehicle
v1.1.10,we will either find external camera if it already exist in evironment or create one
v1.1.10,find all vehicle pawns
v1.1.10,if no vehicle pawns exists in environment
v1.1.10,create vehicle pawn
v1.1.10,set up vehicle pawns
v1.1.10,initialize each vehicle pawn we found
v1.1.10,chose first pawn as FPV if none is designated as FPV
v1.1.10,find all BP camera directors in the environment
v1.1.10,create director
v1.1.10,create external camera required for the director
v1.1.10,find vehicles and cameras available in environment
v1.1.10,if none available then we will create one
v1.1.10,find all vehicle pawns
v1.1.10,set up vehicle pawns
v1.1.10,initialize each vehicle pawn we found
v1.1.10,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.10,Setup suspension forces
v1.1.10,Find the tire object and set the data for it
v1.1.10,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.10,Setup suspension forces
v1.1.10,Find the tire object and set the data for it
v1.1.10,Create In-Car camera component
v1.1.10,In car HUD
v1.1.10,Create text render component for in car speed display
v1.1.10,Create text render component for in car gear display
v1.1.10,Setup the audio component and allocate it a sound cue
v1.1.10,Colors for the in-car gear display. One for normal one for reverse
v1.1.10,Wheels/Tyres
v1.1.10,Setup the wheels
v1.1.10,Adjust the tire loading
v1.1.10,Engine
v1.1.10,Torque setup
v1.1.10,Adjust the steering
v1.1.10,Transmission
v1.1.10,We want 4wd
v1.1.10,Drive the front wheels a little more than the rear
v1.1.10,Automatic gearbox
v1.1.10,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.1.10,Physics settings
v1.1.10,Adjust the center of mass - the buggy is quite low
v1.1.10,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.1.10,put camera little bit above vehicle
v1.1.10,TODO: should do reset() here?
v1.1.10,joystick
v1.1.10,below is not needed
v1.1.10,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReversePressed, true);"
v1.1.10,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::onReverseReleased, false);"
v1.1.10,TODO: update other fields
v1.1.10,update phsyics material
v1.1.10,Update the strings used in the hud (incar and onscreen)
v1.1.10,Set the string in the incar hud
v1.1.10,Pass the engine RPM to the sound component
v1.1.10,Two steel levers behind wheel
v1.1.10,Start an engine sound playing
v1.1.10,Using FText because this is display text that should be localizable
v1.1.10,Setup the text render component strings
v1.1.10,Timestamp \t Speed \t Throttle \t Steering \t Brake \t gear
v1.1.10,timestamp
v1.1.10,Speed
v1.1.10,Gear
v1.1.10,else don't save
v1.1.10,movement_->ResetMoveState();
v1.1.10,movement_->SetActive(false);
v1.1.10,"movement_->SetActive(true, true);"
v1.1.10,call virtual method in derived class
v1.1.10,remove everything that we created in BeginPlay
v1.1.10,perfom any expensive rendering update outside of lock region
v1.1.10,should be overridden by derived class
v1.1.10,Unreal doesn't allow pure abstract methods in actors
v1.1.10,else don't init
v1.1.10,else ignore
v1.1.10,setup clock in PhysX
v1.1.10,setup clock in ClockFactory
v1.1.10,Should be overridden by derived classes
v1.1.10,Should be overridden by derived classes
v1.1.10,Should be overridden by derived classes
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,update ray tracing
v1.1.10,"FString hit_name = FString(""None"");"
v1.1.10,if (dist_hit.GetActor())
v1.1.10,hit_name=dist_hit.GetActor()->GetName();
v1.1.10,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.1.10,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,This assumes you are running DroneServer already on the same machine.
v1.1.10,DroneServer must be running first.
v1.1.10,enable API control
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,move commands
v1.1.10,else leave as it is
v1.1.10,TODO: get these in one call
v1.1.10,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.1.10,TODO: shouldn't we pass folder path?
v1.1.10,parse
v1.1.10,group the images by the current date.
v1.1.10,"std::string beforeScriptStartCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.10,{
v1.1.10,"return """";"
v1.1.10,}
v1.1.10,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.10,{
v1.1.10,return false;
v1.1.10,}
v1.1.10,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.1.10,params.context->client.newTask();
v1.1.10,}
v1.1.10,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.1.10,params.context->client.WaitForCompletion(0);
v1.1.10,}
v1.1.10,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.1.10,{
v1.1.10,}
v1.1.10,parse command line
v1.1.10,Shell callbacks
v1.1.10,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.10,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.10,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.10,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.10,Add shell commands
v1.1.10,TODO: add WaitForCompletion command
v1.1.10,"TODO: add command line args help, arg count validation"
v1.1.10,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.10,Licensed under the MIT License.
v1.1.10,switch to explicit hover mode so that this is the fallback when
v1.1.10,move* commands are finished.
v1.1.10,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.1.10,60 acres park:
v1.1.10,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.1.10,marymoore park
v1.1.10,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,read settings and override defaults
v1.1.9,allow json overrides on a per-vehicle basis.
v1.1.9,start server in async mode
v1.1.9,check messages
v1.1.9,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.1.9,return cls(**msgpack.unpack(encoded))
v1.1.9,basic flight control
v1.1.9,camera control
v1.1.9,simGetImage returns compressed png in array of bytes
v1.1.9,image_type uses one of the AirSimImageType members
v1.1.9,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.9,camera control
v1.1.9,simGetImage returns compressed png in array of bytes
v1.1.9,image_type uses one of the AirSimImageType members
v1.1.9,helper method for converting getOrientation to roll/pitch/yaw
v1.1.9,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.1.9,roll (x-axis rotation)
v1.1.9,pitch (y-axis rotation)
v1.1.9,yaw (z-axis rotation)
v1.1.9,DEY: I don't know why this was there.
v1.1.9,data = np.flipud(data)
v1.1.9,reverse the vertical line order and add null bytes at the start
v1.1.9,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.1.9,query vehicle state
v1.1.9,APIs for control
v1.1.9,-----------------------------------  Car APIs ---------------------------------------------
v1.1.9,Local variable access is faster in loops
v1.1.9,"if not wrapping over current pointer,"
v1.1.9,then check if there is terminal state wrapped inside
v1.1.9,"If index > history_length, take from a slice"
v1.1.9,Metrics accumulator
v1.1.9,Action Value model (used by agent to interact with the environment)
v1.1.9,"Target model used to compute the target Q-values in training, updated"
v1.1.9,less frequently for increased stability.
v1.1.9,Function computing Q-values targets as part of the computation graph
v1.1.9,"Define the loss, using Huber Loss (more robust to outliers)"
v1.1.9,Compute the q_targets
v1.1.9,actions is a 1-hot encoding of the action done by the agent
v1.1.9,Define training criterion as the Huber Loss function
v1.1.9,Adam based SGD
v1.1.9,Append the state to the short term memory (ie. History)
v1.1.9,"If policy requires agent to explore, sample random action"
v1.1.9,Use the network to output the best action
v1.1.9,Append batch axis with only one sample to evaluate
v1.1.9,Return the value maximizing the expected reward
v1.1.9,Keep track of interval action counter
v1.1.9,"If done, reset short term memory (ie. History)"
v1.1.9,Plot the metrics through Tensorboard and reset buffers
v1.1.9,Reset the short term memory
v1.1.9,Append to long term memory
v1.1.9,Update the Target Network if needed
v1.1.9,print(dist)
v1.1.9,connect to the AirSim simulator
v1.1.9,Make RL agent
v1.1.9,Train
v1.1.9,DEY: I don't know why this was there.
v1.1.9,data = np.flipud(data)
v1.1.9,In settings.json first activate computer vision mode:
v1.1.9,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.9,currently reset() doesn't work in CV mode. Below is the workaround
v1.1.9,connect to the AirSim simulator
v1.1.9,go forward
v1.1.9,get state of the car
v1.1.9,connect to the AirSim simulator
v1.1.9,get camera images from the car
v1.1.9,that's enough fun for now. let's quit cleanly
v1.1.9,import gym #pip install gym
v1.1.9,Local variable access is faster in loops
v1.1.9,"if not wrapping over current pointer,"
v1.1.9,then check if there is terminal state wrapped inside
v1.1.9,"If index > history_length, take from a slice"
v1.1.9,Metrics accumulator
v1.1.9,Action Value model (used by agent to interact with the environment)
v1.1.9,"Target model used to compute the target Q-values in training, updated"
v1.1.9,less frequently for increased stability.
v1.1.9,Function computing Q-values targets as part of the computation graph
v1.1.9,"Define the loss, using Huber Loss (more robust to outliers)"
v1.1.9,Compute the q_targets
v1.1.9,actions is a 1-hot encoding of the action done by the agent
v1.1.9,Define training criterion as the Huber Loss function
v1.1.9,Adam based SGD
v1.1.9,self._trainer.restore_from_checkpoint('models/oldmodels/model800000')
v1.1.9,Append the state to the short term memory (ie. History)
v1.1.9,"If policy requires agent to explore, sample random action"
v1.1.9,Use the network to output the best action
v1.1.9,Append batch axis with only one sample to evaluate
v1.1.9,Return the value maximizing the expected reward
v1.1.9,Keep track of interval action counter
v1.1.9,"If done, reset short term memory (ie. History)"
v1.1.9,Plot the metrics through Tensorboard and reset buffers
v1.1.9,Reset the short term memory
v1.1.9,Append to long term memory
v1.1.9,Update the Target Network if needed
v1.1.9,print(dist)
v1.1.9,Make RL agent
v1.1.9,Train
v1.1.9,use open cv to show new images from AirSim
v1.1.9,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.9,pip install opencv-python
v1.1.9,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.9,use open cv to create point cloud from depth image.
v1.1.9,###########################################
v1.1.9,######### This is work in progress! #######
v1.1.9,###########################################
v1.1.9,file will be saved in PythonClient folder (i.e. same folder as script)
v1.1.9,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.1.9,skip it
v1.1.9,AirSim uses NED coordinates so negative axis is up.
v1.1.9,z of -7 is 7 meters above the original launch point.
v1.1.9,Fly given velocity vector for 5 seconds
v1.1.9,using DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.1.9,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.1.9,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.1.9,AirSim uses NED coordinates so negative axis is up.
v1.1.9,z of -7 is 7 meters above the original launch point.
v1.1.9,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.1.9,this method is async and we are not waiting for the result since we are passing max_wait_seconds=0.
v1.1.9,connect to the AirSim simulator
v1.1.9,get state of the car
v1.1.9,go forward
v1.1.9,Go forward + steer right
v1.1.9,go reverse
v1.1.9,apply breaks
v1.1.9,get camera images from the car
v1.1.9,restore to original state
v1.1.9,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.9,pip install opencv-python
v1.1.9,connect to the AirSim simulator
v1.1.9,AirSim uses NED coordinates so negative axis is up.
v1.1.9,let it settle there a bit.
v1.1.9,now compute the survey path required to fill the box
v1.1.9,In settings.json first activate computer vision mode:
v1.1.9,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.9,for block environment
v1.1.9,regex are case insensetive
v1.1.9,#for neighbourhood environment
v1.1.9,set object ID for sky
v1.1.9,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.1.9,get segmentation image in various formats
v1.1.9,save segmentation images in various formats
v1.1.9,"AirSimClientBase.write_pfm(os.path.normpath(filename + '.pfm'), AirSimClientBase.getPfmArray(response))"
v1.1.9,"AirSimClientBase.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.1.9,"AirSimClientBase.write_png(os.path.normpath(filename + '.numpy.png'), img_rgba) #write to png"
v1.1.9,find unique colors
v1.1.9,connect to the AirSim simulator
v1.1.9,get state of the car
v1.1.9,go forward
v1.1.9,Go forward + steer right
v1.1.9,go reverse
v1.1.9,apply breaks
v1.1.9,restore to original state
v1.1.9,"Go to object in Unreal Editor, click on it and then look for Tags property."
v1.1.9,"Add a tag ""MyObject"" (without quotes), save and the query using following line"
v1.1.9,see more about tags here: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.1.9,from keras.models import load_model
v1.1.9,if (len(sys.argv) != 2):
v1.1.9,print('usage: python drive.py <modelName>')
v1.1.9,sys.exit()
v1.1.9,print('Loading model...')
v1.1.9,model = load_model(sys.argv[1])
v1.1.9,connect to the AirSim simulator
v1.1.9,image_buf[0] = get_image()
v1.1.9,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.1.9,"model_output = model.predict([image_buf, state_buf])"
v1.1.9,car_controls.steering = float(model_output[0][0])
v1.1.9,connect to the AirSim simulator
v1.1.9,that's enough fun for now. let's quite cleanly
v1.1.9,use open cv to show new images from AirSim
v1.1.9,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.9,pip install opencv-python
v1.1.9,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.1.9,get depth image
v1.1.9,"this will return png width= 256, height= 144"
v1.1.9,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.1.9,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.1.9,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.1.9,to get an estimate of distance.
v1.1.9,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.1.9,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.1.9,an angular delta of the following pi/10.
v1.1.9,"in header only mode, control library is not available"
v1.1.9,if using Unreal Build system then include precompiled header file first
v1.1.9,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.9,"Windows, OSX and Linux."
v1.1.9,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.1.9,Windows users can move the Documents folder to any location they want
v1.1.9,SHGetFolderPath knows how to find it.
v1.1.9,fall back in case SHGetFolderPath failed for some reason.
v1.1.9,convert from std::path '/' to windows backslash.
v1.1.9,make the current thread run with maximum priority.
v1.1.9,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.1.9,TODO: How to handle POSIX thread priorities on OSX?
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.1.9,
v1.1.9,Treat all errors as failure conditions.
v1.1.9,parse command line
v1.1.9,"motive gives a weird error if the project is not found, so we look for it."
v1.1.9,Do an update to pick up any recently-arrived cameras.
v1.1.9,List all detected cameras.
v1.1.9,List all defined rigid bodies.
v1.1.9,throttle to 50 messages per second.
v1.1.9,OptiTrack uses 'y' axis for vertical.
v1.1.9,stdafx.cpp : source file that includes just the standard includes
v1.1.9,MavlinkMoCap.pch will be the pre-compiled header
v1.1.9,stdafx.obj will contain the pre-compiled type information
v1.1.9,TODO: reference any additional headers you need in STDAFX.H
v1.1.9,and not in this file
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,PX4.cpp : Defines the entry point for the console application.
v1.1.9,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.1.9,how do you write to the debug output windows on Unix ?
v1.1.9,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.1.9,connection to create to talke to that server.
v1.1.9,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.1.9,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.1.9,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.1.9,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.1.9,using their the -qgc option.
v1.1.9,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.1.9,this switch controls whether we turn off the RC remote active link loss detection
v1.1.9,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.1.9,from kicking in when you try and fly.
v1.1.9,can't use experimental stuff on Linux because of potential ABI issues
v1.1.9,parse the json
v1.1.9,flatten inner mavlink object
v1.1.9,flatten inner mavlink object
v1.1.9,todo
v1.1.9,todo
v1.1.9,"const char* outLogFileOption = ""outlogfile"";"
v1.1.9,parse command line
v1.1.9,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.1.9,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.1.9,"no local serial connection, so this is the primary droneConnection."
v1.1.9,failed to connect
v1.1.9,"local connection, then we own sending the heartbeat."
v1.1.9,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.1.9,cmdTable.push_back(new AltHoldCommand());
v1.1.9,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.1.9,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.1.9,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.1.9,this stops us from being able to connect to SITL mode PX4.
v1.1.9,checkPulse();
v1.1.9,add command text in log
v1.1.9,close previous command.
v1.1.9,FilterLogFiles(logDirectory);
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,send a heartbeat
v1.1.9,accept one incoming connection
v1.1.9,send a heartbeat to the client
v1.1.9,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.1.9,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.1.9,for this unit test we are expecting a request to send an image.
v1.1.9,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.1.9,hmmm
v1.1.9,================ ls
v1.1.9,================ put file
v1.1.9,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.1.9,================ get file
v1.1.9,verify the file contents.
v1.1.9,================ remove file
v1.1.9,================ make directory
v1.1.9,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.1.9,================ remove directory
v1.1.9,Now verification
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,from main.cpp.
v1.1.9,you must call this method if you want HandleMessage to be called subsequently.
v1.1.9,treat literals as one word
v1.1.9,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.9,request gps info
v1.1.9,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.1.9,find relative position since command start so we can compare two commands better
v1.1.9,TODO: make below future proof (i.e. usable by C++17 compiler) - also change same in main.cpp
v1.1.9,can't use experimental stuff on Linux because of potential ABI issues
v1.1.9,"these PID values are important, so set these to match"
v1.1.9,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.1.9,we can skip ahead.
v1.1.9,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.1.9,TODO: avoid passing hadcoded HIL flag
v1.1.9,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.1.9,"The global position, as returned by the Global Positioning System (GPS)."
v1.1.9,Provides state for additional features
v1.1.9,The general system state
v1.1.9,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.9,Provides state for additional features
v1.1.9,The general system state
v1.1.9,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.9,Provides state for additional features
v1.1.9,The general system state
v1.1.9,Provides state for additional features
v1.1.9,The general system state
v1.1.9,note: we do not reset com when Close() is called because we want to keep running.
v1.1.9,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.9,generate random between 0 and 1
v1.1.9,move to range -1 to 1
v1.1.9,scale it
v1.1.9,apply iy
v1.1.9,wait for the Execute method to be called.
v1.1.9,gps is much slower frequency than IMU.
v1.1.9,MAVLINK_MSG_ID_HIL_GPS
v1.1.9,disable MAV_USEHILGPS
v1.1.9,note: we do not reset com when Close() is called because we want to keep running.
v1.1.9,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.9,generate random between 0 and 1
v1.1.9,move to range -1 to 1
v1.1.9,scale it
v1.1.9,apply iy
v1.1.9,wait for the Execute method to be called.
v1.1.9,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.1.9,gps is much slower frequency than IMU.
v1.1.9,MAVLINK_MSG_ID_HIL_GPS
v1.1.9,disable HIL mode
v1.1.9,Enumeration of landed detector states
v1.1.9,MAV landed state is unknown
v1.1.9,MAV is landed (on ground)
v1.1.9,MAV is in air
v1.1.9,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.1.9,The filtered local position
v1.1.9,must send these regularly to keep offboard control.
v1.1.9,"ok, now we can safely switch to loiter."
v1.1.9,must send these regularly to keep offboard control.
v1.1.9,integrate the heading so it is smoother.
v1.1.9,must send these regularly to keep offboard control.
v1.1.9,integrate the heading so it is smoother.
v1.1.9,fly to radius
v1.1.9,it takes about 10 cm to stop and turn.
v1.1.9,next time around switch to orbiting!
v1.1.9,heading points to center of circle.
v1.1.9,interpoloate the speed ramp up time over 2 seconds from start time
v1.1.9,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.1.9,monitor the sin curves so we can see how on track or off track it actually is.
v1.1.9,the shape of the curve will also tell us if we are progressing at a consistent
v1.1.9,"speed, the more deformed the sin curve the worse our progress."
v1.1.9,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.1.9,degrees just flipped from 359 to 0.
v1.1.9,this enables us to test what happens when offboard control is lost and resumed.
v1.1.9,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.1.9,"ok, now we can start moving by velocity"
v1.1.9,recompute to new target.
v1.1.9,start by moving right with 10 degree roll.
v1.1.9,haven't started yet.
v1.1.9,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.1.9,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.1.9,track how our actual pitch is coming along compared to our target
v1.1.9,and check position
v1.1.9,the amount of pitch should depend on our speed in that direction.
v1.1.9,passed the midpoint.
v1.1.9,fade out the pitch as we pick up speed so we don't overshoot.
v1.1.9,see if we just crossed the wiggle distance threshold.
v1.1.9,(pitch affects the x-position).
v1.1.9,reverse direction with a -30 degrees quick stop
v1.1.9,reverse direction with a 30 degrees quick stop
v1.1.9,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.1.9,too much in that direction.
v1.1.9,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.9,track how our actual roll is coming along compared to our target
v1.1.9,and check position
v1.1.9,the amount of roll should depend on our speed in that direction.
v1.1.9,passed the midpoint.
v1.1.9,fade out the roll as we pick up speed so we don't overshoot.
v1.1.9,see if we just crossed the wiggle distance threshold.
v1.1.9,(roll affects the y-position).
v1.1.9,reverse direction with a -30 degrees quick stop
v1.1.9,reverse direction with a 30 degrees quick stop
v1.1.9,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.1.9,too much in that direction.
v1.1.9,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.9,for testing PID controller.
v1.1.9,class AltHoldCommand : public Command
v1.1.9,{
v1.1.9,std::shared_ptr<MavLinkVehicle> channel;
v1.1.9,"float sx_, sy_, sz_;"
v1.1.9,MavLinkAttitudeTarget _current;
v1.1.9,PidController thrust_controller_;
v1.1.9,public:
v1.1.9,this->sz_ = pos.z; // user defined target.
v1.1.9,move to local position keeps the offboard control happy.
v1.1.9,haven't started yet.
v1.1.9,and check position
v1.1.9,double dx = this->sx_ - pos.x;
v1.1.9,double dy = this->sy_ - pos.y;
v1.1.9,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.1.9,too much in that direction.
v1.1.9,adjust thrust so we keep steady height target
v1.1.9,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.9,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.1.9,local remote
v1.1.9,already handled by the parse method.
v1.1.9,we only support very simple patterns for now.
v1.1.9,each wildcard must be separated by literal.
v1.1.9,back to back wildcards with no literal in between is too complex.
v1.1.9,"we only support simple matching for now, we can add full regex later if we need it."
v1.1.9,yep!
v1.1.9,'*' is done we found the next matching char
v1.1.9,this is ok.
v1.1.9,this is an ERASE_END_LINE command which we ignore.
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,unpack the message...
v1.1.9,pack the payload buffer.
v1.1.9,"json can't handle ""nan"", so we convert it to null."
v1.1.9,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.1.9,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,start listening to this connection
v1.1.9,Send heartbeat to drone.  You should not do this if some other node is
v1.1.9,already doing it.
v1.1.9,stop listening to the connection.
v1.1.9,get the connection
v1.1.9,Get the local system and component id
v1.1.9,send a command to the remote node
v1.1.9,MavLinkNode::MavLinkNode() = default;
v1.1.9,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.1.9,decrementing the count so the next WaitOne may block.
v1.1.9,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.1.9,convert to absolute time.
v1.1.9,use mach_timespec
v1.1.9,convert to absolute time.
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,return true if we still have offboard control (can lose this if user flips the switch).
v1.1.9,MavLinkVehicle::MavLinkVehicle() = default;
v1.1.9,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.1.9,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,============================== CLIENT ============================================
v1.1.9,image APIs
v1.1.9,or if you are implementing the client side call this function to get the most recent frame.
v1.1.9,returns false if there is no new frame available.
v1.1.9,============================== SERVER ============================================
v1.1.9,call this to send the image back over the connection given to start function.
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,"log every message that is ""sent"" using sendMessage."
v1.1.9,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.1.9,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.1.9,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.1.9,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,for compatibility with QGroundControl we have to save the time field in big endian.
v1.1.9,todo: mavlink2 support?
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,start listening to this connection
v1.1.9,Send heartbeat to drone.  You should not do this if some other node is
v1.1.9,already doing it.
v1.1.9,send a heart beat so that the remote node knows we are still alive
v1.1.9,(otherwise drone will trigger a failsafe operation).
v1.1.9,this is called for all messages received on the connection.
v1.1.9,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.1.9,subclasses remembering to call this base implementation.
v1.1.9,stop listening to the connection.
v1.1.9,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.9,wait for a heartbeat msg since this will give us the port to send commands to...
v1.1.9,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.1.9,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.9,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.9,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.9,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.9,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.9,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.9,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.1.9,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.1.9,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.1.9,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.1.9,"ok, now fetch the missing parameters."
v1.1.9,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.1.9,silently fail since we are on a background thread here...
v1.1.9,tell the caller this is complete.
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,add our custom telemetry message length.
v1.1.9,todo: if we support signing then initialize
v1.1.9,mavlink_intermediate_status_.signing callbacks
v1.1.9,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.1.9,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.9,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.9,send this right away just in case serial link is not already configured
v1.1.9,"log every message that is ""sent"" using sendMessage."
v1.1.9,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.1.9,pack the payload buffer.
v1.1.9,calculate checksum
v1.1.9,form the header as a byte array for the crc
v1.1.9,these macros use old style cast.
v1.1.9,forward messages from our connected node to the remote proxy.
v1.1.9,forward messages from remote proxy to local connected node
v1.1.9,CurrentThread::setMaximumPriority();
v1.1.9,"hmmm, wait till it is opened?"
v1.1.9,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.1.9,pick up the sysid/compid of the remote node we are connected to.
v1.1.9,then this is a mavlink 1 message
v1.1.9,then this mavlink sender supports mavlink 2
v1.1.9,queue event for publishing.
v1.1.9,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.1.9,as it ensures we don't lose messages if the listener is slow.
v1.1.9,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.1.9,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.1.9,we would get a deadlock.
v1.1.9,CurrentThread::setMaximumPriority();
v1.1.9,reset counters
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,------------------------------------------------------------------------------
v1.1.9,Defines
v1.1.9,------------------------------------------------------------------------------
v1.1.9,bit number  876543210987654321
v1.1.9,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.1.9,in future it would be good to have ability to add system IDs we are interested in
v1.1.9,if (msg.sysid != getTargetSystemId())
v1.1.9,{
v1.1.9,// we only care about messages from our intended remote node.
v1.1.9,return;
v1.1.9,}
v1.1.9,user may have changed modes on us! So we need to honor that and not
v1.1.9,try and take it back.
v1.1.9,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.1.9,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.1.9,we can store up to 16 channels in rc_channels_scaled.
v1.1.9,The RAW values of the servo outputs
v1.1.9,Metrics typically displayed on a HUD for fixed wing aircraft
v1.1.9,The IMU readings in SI units in NED body frame
v1.1.9,printSystemStatus(&msg);
v1.1.9,todo: use this to determine when we need to do emergency landing...
v1.1.9,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.1.9,Provides state for additional features
v1.1.9,The general system state
v1.1.9,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.1.9,but we do want to know when we get the ack.  So this is async ACK processing!
v1.1.9,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.1.9,if threshold < 0 then the threshold is inverted.
v1.1.9,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.1.9,Convert it to a floating point number between -1 and 1.
v1.1.9,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.1.9,until the move commands start happening.
v1.1.9,return true if user calls requestControl and has not called releaseControl.
v1.1.9,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.1.9,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.1.9,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.1.9,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.1.9,send a few to make sure it gets through...
v1.1.9,now the command should succeed.
v1.1.9,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.1.9,us by which time the PX4 times out offboard mode!!
v1.1.9,this mode change take precedence over offboard mode.
v1.1.9,thrust must be between -1 and 1.
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,These definitions are copied from PX4 implementation
v1.1.9,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.1.9,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.1.9,/ @brief Command opcodes
v1.1.9,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.1.9,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.9,must trim trailing slashes so PX4 doesn't hang!
v1.1.9,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.1.9,from the source.
v1.1.9,check if directory exists.
v1.1.9,perfect.
v1.1.9,use last_message_ so we preserve the sessionid.
v1.1.9,"could not create the local file, so stop."
v1.1.9,must use last_message_ so we preserve the session id.
v1.1.9,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.1.9,todo: error handling here? sequence is out of order...
v1.1.9,"directory must be empty then, can't do nextStep because"
v1.1.9,it will just loop for ever re-requesting zero offset into
v1.1.9,empty directory.
v1.1.9,result should be a list of null terminated file names.
v1.1.9,skipping this entry
v1.1.9,remove the file size field.
v1.1.9,"printf(""%s\n"", name.c_str());"
v1.1.9,request the next batch.
v1.1.9,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.9,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.9,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.1.9,reached the end of the list or the file.
v1.1.9,end of file or directory listing.
v1.1.9,"success, data should be following..."
v1.1.9,ack on this cmd is a noop
v1.1.9,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.1.9,give up then.
v1.1.9,tell watchdog we are sending a request
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,================================= CLIENT ==============================================================
v1.1.9,Check if we have a valid transaction
v1.1.9,emit signal if all packets arrived
v1.1.9,Restart statemachine
v1.1.9,image APIs
v1.1.9,================================= SERVER ==============================================================
v1.1.9,Prepare and send acknowledgment packet
v1.1.9,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.1.9,Send ENCAPSULATED_IMAGE packet
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.1.9,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.9,parse out the VID number
v1.1.9,now the PID
v1.1.9,parse out the VID number
v1.1.9,examples:
v1.1.9,PX4: USB\VID_26AC&PID_0011\0
v1.1.9,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.1.9,"printf(""Found: %S\n"", buffer.c_str());"
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.9,parse out the VID number
v1.1.9,now the PID
v1.1.9,parse out the VID number
v1.1.9,suppress
v1.1.9,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,This has not been properly tested
v1.1.9,struct iw_statistics stats;
v1.1.9,struct iwreq req;
v1.1.9,"memset(&stats, 0, sizeof(stats));"
v1.1.9,"memset(&req, 0, sizeof(iwreq));"
v1.1.9,
v1.1.9,"strncpy(req.ifr_name, ifaceName, 16);"
v1.1.9,req.u.data.pointer = &stats;
v1.1.9,req.u.data.length = sizeof(iw_statistics);
v1.1.9,
v1.1.9,#ifdef CLEAR_UPDATED
v1.1.9,req.u.data.flags = 1;
v1.1.9,#endif
v1.1.9,
v1.1.9,/* Perform the ioctl */
v1.1.9,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.1.9,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.1.9,return -127;
v1.1.9,}
v1.1.9,
v1.1.9,return stats.qual.level;
v1.1.9,todo: windows version of this...
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,windows
v1.1.9,Need to link with Ws2_32.lib
v1.1.9,posix
v1.1.9,found it!
v1.1.9,bind socket to local address.
v1.1.9,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.1.9,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.1.9,write to the serial port
v1.1.9,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.1.9,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.1.9,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.1.9,"try and receive something, up until port is closed anyway."
v1.1.9,"message was too large for the buffer, no problem, return what we have."
v1.1.9,try again - this can happen if server recreates the socket on their side.
v1.1.9,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.9,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.9,try again - this can happen if server recreates the socket on their side.
v1.1.9,"printf(""#### recv failed with error: %d\n"", hr);"
v1.1.9,we now have it.
v1.1.9,this is from someone we are not interested in.
v1.1.9,"printf(""Connection closed\n"");"
v1.1.9,-----------------------------------------------------------------------------------------
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,Initialize Winsock
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,windows
v1.1.9,Need to link with Ws2_32.lib
v1.1.9,posix
v1.1.9,found it!
v1.1.9,bind socket to local address.
v1.1.9,bind socket to local address.
v1.1.9,start listening for incoming connection
v1.1.9,accept 1
v1.1.9,write to the serial port
v1.1.9,"try and receive something, up until port is closed anyway."
v1.1.9,"message was too large for the buffer, no problem, return what we have."
v1.1.9,try again - this can happen if server recreates the socket on their side.
v1.1.9,"skip this, it is was interrupted."
v1.1.9,"printf(""Connection closed\n"");"
v1.1.9,-----------------------------------------------------------------------------------------
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.1.9,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.1.9,set signal
v1.1.9,Clear Handshake flags
v1.1.9,Set Handshake flags
v1.1.9,return GetLastError();
v1.1.9,return GetLastError();
v1.1.9,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.9,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.1.9,enable reading
v1.1.9,posix doesn't have mark/space parity.
v1.1.9,posix doesn't have mark/space parity.
v1.1.9,this is the default.
v1.1.9,not sure this is supported...
v1.1.9,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.1.9,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.9,First do those specified by POSIX.
v1.1.9,Now conditionally handle a bunch of extended rates.
v1.1.9,First do those specified by POSIX.
v1.1.9,Now conditionally handle a bunch of extended rates.
v1.1.9,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.9,","
v1.1.9,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.1.9,"std::unique_ptr<TestBase>(new RosFlightTest()),"
v1.1.9,"std::unique_ptr<TestBase>(new QuaternionTest()),"
v1.1.9,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,"in header only mode, control library is not available"
v1.1.9,TODO: something defines max macro which interfears with code here
v1.1.9,is cur_pos within fence?
v1.1.9,destination risk is not available then consider it zero
v1.1.9,if dest risk is lower than its more safe
v1.1.9,are we doing better than closest obstacle?
v1.1.9,"if we stay where we are, what is the risk distance?"
v1.1.9,else we are better of moving to dest
v1.1.9,this function should work even when dest_pos == cur_pos
v1.1.9,is this dest_pos cur_pos within the fence?
v1.1.9,transform dest_pos vector to body frame
v1.1.9,check for approx zero vectors to avoid random yaw angles
v1.1.9,we are hovering
v1.1.9,"get yaw in body frame, ie, front is always 0 radians"
v1.1.9,yaw to ticks
v1.1.9,get obstacles in the window at the tick direction around the window
v1.1.9,less risk distance is better
v1.1.9,check obstacles around current position and see if it has lower risk
v1.1.9,else obstacle is too far
v1.1.9,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.1.9,look for each surrounding tick to see if we have obstacle free angle
v1.1.9,else no suggestions required
v1.1.9,"3.2 comes from inverse CDF for epsilone = 0.05 (i.e. 95% confidence), author: akapoor"
v1.1.9,evaluate right and left side of circle
v1.1.9,find right and left risk distances
v1.1.9,at this point we have already determined hover is better than going to dest
v1.1.9,we now determine is moving to suggested angle better than hovering?
v1.1.9,check if dest_pos is safe
v1.1.9,breaking distance at this velocity
v1.1.9,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.1.9,check if dest_pos is safe
v1.1.9,float/vec parameters can have NaN which makes them optional
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,"in header only mode, control library is not available"
v1.1.9,handles +/- tick and wraps around circle
v1.1.9,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.1.9,update the specified window on the map
v1.1.9,make dure from <= to
v1.1.9,normalize the ticks so bothe are valid indices
v1.1.9,if from is still larger then
v1.1.9,to ticks is then added one full circle to make it larger than from_tick
v1.1.9,find closest obstacle in given window
v1.1.9,search whole map to find closest obstacle
v1.1.9,"in header only mode, control library is not available"
v1.1.9,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.9,"Windows, OSX and Linux."
v1.1.9,Windows users can move the Documents folder to any location they want
v1.1.9,SHGetFolderPath knows how to find it.
v1.1.9,fall back in case SHGetFolderPath failed for some reason.
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,"in header only mode, control library is not available"
v1.1.9,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.9,if using Unreal Build system then include precompiled header file first
v1.1.9,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.9,#undef check
v1.1.9,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.9,sim only
v1.1.9,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.9,required for pimpl
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,"in header only mode, control library is not available"
v1.1.9,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.9,if using Unreal Build system then include precompiled header file first
v1.1.9,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.1.9,sim only
v1.1.9,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.9,make sure we can talk to the DroneServer
v1.1.9,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.1.9,command_context.client.ping();
v1.1.9,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,"in header only mode, control library is not available"
v1.1.9,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.9,if using Unreal Build system then include precompiled header file first
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,"in header only mode, control library is not available"
v1.1.9,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.9,if using Unreal Build system then include precompiled header file first
v1.1.9,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.9,#undef check
v1.1.9,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.9,required for pimpl
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,"in header only mode, control library is not available"
v1.1.9,if auto mode requested for lookahead then calculate based on velocity
v1.1.9,no-op by default. derived class can override it if needed
v1.1.9,no-op by default. derived class can override it if needed
v1.1.9,validate path size
v1.1.9,validate yaw mode
v1.1.9,validate and set auto-lookahead value
v1.1.9,if auto mode requested for lookahead then calculate based on velocity
v1.1.9,add current position as starting point
v1.1.9,append the input path and compute segments
v1.1.9,add last segment as zero length segment so we have equal number of segments and points.
v1.1.9,path_segs[i] refers to segment that starts at point i
v1.1.9,"when path ends, we want to slow down"
v1.1.9,else no need to change velocities for last segments
v1.1.9,setup current position on path to 0 offset
v1.1.9,initialize next path position
v1.1.9,until we are at the end of the path (last seg is always zero size)
v1.1.9,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.1.9,send drone command to get to next lookahead
v1.1.9,sleep for rest of the cycle
v1.1.9,how much have we moved towards last goal?
v1.1.9,project actual vector on goal vector
v1.1.9,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.1.9,TODO: below should be lower than 1E3 and configurable
v1.1.9,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.1.9,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.1.9,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.1.9,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.1.9,"if drone moved backward, we don't want goal to move backward as well"
v1.1.9,"so only climb forward on the path, never back. Also note >= which means"
v1.1.9,we climb path even if distance was 0 to take care of duplicated points on path
v1.1.9,else
v1.1.9,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.1.9,compute next target on path
v1.1.9,last command is to hold on to position
v1.1.9,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.1.9,default strategy is for move. In hover mode we set new strategy temporarily
v1.1.9,get trims
v1.1.9,take average
v1.1.9,freeze the quaternion
v1.1.9,convert RC commands to velocity vector
v1.1.9,find yaw as per terrain and remote setting
v1.1.9,execute command
v1.1.9,Only raise exception is time out occurred. If preempted then return status.
v1.1.9,are we supposed to do EM?
v1.1.9,get suggested velocity vector
v1.1.9,use the unchecked command
v1.1.9,tell caller not to execute planned command
v1.1.9,other wise throw exception
v1.1.9,otherwise there is some other reason why we are in unsafe situation
v1.1.9,send last command to come to full stop
v1.1.9,else no unsafe situation
v1.1.9,note: cur_path_loc and next_path_loc may both point to same object
v1.1.9,"otherwise use up this segment, move on to next one"
v1.1.9,if we are here then we ran out of segments
v1.1.9,consider last segment as zero length segment
v1.1.9,adjust yaw for the direction of travel in foward-only mode
v1.1.9,else no adjustment needed
v1.1.9,validate dest
v1.1.9,what is the distance we will travel at this velocity?
v1.1.9,get velocity vector
v1.1.9,yaw for the direction of travel
v1.1.9,find velocity vector
v1.1.9,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.1.9,generate velocity vector that is same size as cur_dest_norm / command period
v1.1.9,this velocity vect when executed for command period would yield cur_dest_norm
v1.1.9,send commands
v1.1.9,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.1.9,by default indicate that we don't have alternative pose info
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,"in header only mode, control library is not available"
v1.1.9,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.9,if using Unreal Build system then include precompiled header file first
v1.1.9,status getters
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,"in header only mode, control library is not available"
v1.1.9,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.9,if using Unreal Build system then include precompiled header file first
v1.1.9,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.9,#undef check
v1.1.9,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.9,getters
v1.1.9,required for pimpl
v1.1.9,Create a spring arm component for our chase camera
v1.1.9,"do nothing, spring arm is pulling the camera with it"
v1.1.9,"do nothing, we have camera turned off"
v1.1.9,set initial view mode
v1.1.9,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.1.9,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.1.9,"If the lag is missing, the camera will also occasionally shake."
v1.1.9,"But, lag is not desired when piloting a drone"
v1.1.9,attach spring arm to actor
v1.1.9,remember current parent for external camera. Later when we remove external
v1.1.9,"camera from spring arm, we will attach it back to its last parent"
v1.1.9,now attach camera to spring arm
v1.1.9,"For car, we need to move the camera back a little more than for a drone."
v1.1.9,"Otherwise, the camera will be stuck inside the car"
v1.1.9,external_camera_->bUsePawnControlRotation = false;
v1.1.9,detach spring arm
v1.1.9,Re-enable rendering
v1.1.9,Remove any existing key bindings for manual mode
v1.1.9,"else someone else is bound to manual pose controller, leave it alone"
v1.1.9,if new mode is manual mode then add key bindings
v1.1.9,if we switched to spring arm mode then attach to spring arm (detachment was done earlier in method)
v1.1.9,other modes don't need special setup
v1.1.9,make switch official
v1.1.9,Deflect along the surface when we collide.
v1.1.9,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.1.9,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.1.9,find out which RC we should use
v1.1.9,initialize state
v1.1.9,compute our home point
v1.1.9,should be overridden in derived class
v1.1.9,if (pawn_->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.1.9,pawn_->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.1.9,pawn_->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.1.9,}
v1.1.9,TODO: refactor below code used for playback
v1.1.9,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.9,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.9,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.9,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.9,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.1.9,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.9,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.1.9,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.9,parameters in NED frame
v1.1.9,translate to new VehiclePawnWrapper position & orientation from NED to NEU
v1.1.9,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.1.9,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.1.9,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.1.9,checked at the start of next tick
v1.1.9,allow teleportation
v1.1.9,if collisions are not enabled
v1.1.9,or we have collided but passthrough is enabled
v1.1.9,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.1.9,"without flip flopping, collisions can't be detected"
v1.1.9,Computer transform using the actor that this camera is attached to
v1.1.9,if this is free floting camera like external observer camera then just use
v1.1.9,itself to select origin point
v1.1.9,by default all image types are disabled
v1.1.9,use final color for all calculations
v1.1.9,use final color for all calculations
v1.1.9,if (!std::isnan(setting.target_gamma))
v1.1.9,camera-> = setting.target_gamma;
v1.1.9,do not make unnecessory calls to Activate() which otherwise causes crash in Unreal
v1.1.9,else nothing to enable
v1.1.9,APlayerController* controller = this->GetWorld()->GetFirstPlayerController();
v1.1.9,if (controller && controller->GetViewTarget() == this)
v1.1.9,controller->SetViewTarget(nullptr);
v1.1.9,TODO: explore screenshot option
v1.1.9,addScreenCaptureHandler(camera->GetWorld());
v1.1.9,Wait for render so that view is ready for capture
v1.1.9,not sure why this doesn't work.
v1.1.9,"DECLARE_CYCLE_STAT(TEXT(""FNullGraphTask.CheckRenderStatus""), STAT_FNullGraphTask_CheckRenderStatus, STATGROUP_TaskGraphTasks);"
v1.1.9,"auto renderStatus = TGraphTask<FNullGraphTask>::CreateTask(NULL).ConstructAndDispatchWhenReady(GET_STATID(STAT_FNullGraphTask_CheckRenderStatus), ENamedThreads::RenderThread);"
v1.1.9,FTaskGraphInterface::Get().WaitUntilTaskCompletes(renderStatus);
v1.1.9,Make sure that all alpha values are opaque.
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,"#include ""Runtime/Foliage/Public/FoliageType.h"""
v1.1.9,TODO: change naming conventions to same as other files?
v1.1.9,Enable/disable primary viewport rendering flag
v1.1.9,This disables rendering of the main viewport in the same way as the
v1.1.9,"console command ""show rendering"" would do."
v1.1.9,"When getting an image through the API, the image is produced after the render"
v1.1.9,thread has finished rendering the current and the subsequent frame. This means
v1.1.9,that the frame rate for obtaining images through the API is only half as high as
v1.1.9,"it could be, since only every other image is actually captured. We work around"
v1.1.9,this by telling the viewport to flush the rendering queue at the end of each
v1.1.9,drawn frame so that it executes our render request at that point already.
v1.1.9,Do this only if the main viewport is not being rendered anyway in case there are
v1.1.9,any adverse performance effects during main rendering.
v1.1.9,HACK: FViewPort doesn't expose this field so we are doing dirty work around by maintaining count by ourselves
v1.1.9,HACK: FViewPort doesn't expose this field so we are doing dirty work around by maintaining count by ourselves
v1.1.9,nothing to do for now
v1.1.9,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.1.9,"UAirBlueprintLib::LogMessage(name + TEXT("" Actor not found!""), TEXT(""""), LogDebugLevel::Failure);"
v1.1.9,common_utils::Utils::DebugBreak();
v1.1.9,mesh->SetVisibility(false);
v1.1.9,mesh->SetVisibility(true);
v1.1.9,Explicitly set the custom depth state on the components so the
v1.1.9,render state is marked dirty and the update actually takes effect
v1.1.9,immediately.
v1.1.9,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.1.9,{
v1.1.9,InitializeObjectStencilID(*comp);
v1.1.9,}
v1.1.9,Access the subclass instance with the * or -> operators.
v1.1.9,can we see followee?
v1.1.9,remove mapping
v1.1.9,removing binding
v1.1.9,"TODO: can't do remove because there is no ""stamp"" on who established binding"
v1.1.9,removeInputBindings();
v1.1.9,#ifdef _MSC_VER
v1.1.9,//print to VS output window
v1.1.9,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.1.9,#endif
v1.1.9,also do default logging
v1.1.9,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.1.9,UGameUserSettings* game_settings = GetGameUserSettings();
v1.1.9,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.1.9,game_settings->ApplySettings(true);
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,plugin startup
v1.1.9,plugin shutdown
v1.1.9,"read pixels from render target using render thread, then compress the result into PNG"
v1.1.9,argument on the thread that calls this method.
v1.1.9,TODO: is below really needed?
v1.1.9,make sure we are not on the rendering thread
v1.1.9,TODO: below doesn't work right now because it must be running in game thread
v1.1.9,below is documented method but more expensive because it forces flush
v1.1.9,wait for render thread to pick up our task
v1.1.9,Queue up the task of rendering the scene in the render thread
v1.1.9,wait for this task to complete
v1.1.9,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.1.9,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.1.9,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.1.9,Stuff to filter out XInput devices
v1.1.9,-----------------------------------------------------------------------------
v1.1.9,"Defines, constants, and global variables"
v1.1.9,-----------------------------------------------------------------------------
v1.1.9,Register with the DirectInput subsystem and get a pointer
v1.1.9,to a IDirectInput interface we can use.
v1.1.9,Create a DInput object
v1.1.9,Look for a simple joystick we can use for this sample program.
v1.1.9,Make sure we got a joystick
v1.1.9,"Set the data format to ""simple joystick"" - a predefined data format"
v1.1.9,
v1.1.9,"A data format specifies which controls on a device we are interested in,"
v1.1.9,and how they should be reported. This tells DInput that we will be
v1.1.9,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.1.9,Set the cooperative level to let DInput know how this device should
v1.1.9,interact with the system and with other DInput applications.
v1.1.9,Enumerate the joystick objects. The callback function enabled user
v1.1.9,"interface elements for objects that are found, and sets the min/max"
v1.1.9,values property for discovered axes.
v1.1.9,-----------------------------------------------------------------------------
v1.1.9,Enum each PNP device using WMI and check each device ID to see if it contains
v1.1.9,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then its an XInput device"
v1.1.9,Unfortunately this information can not be found by just using DirectInput.
v1.1.9,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.1.9,XInput devices.
v1.1.9,
v1.1.9,This function stores the list of xinput devices in a linked list
v1.1.9,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.1.9,-----------------------------------------------------------------------------
v1.1.9,CoInit if needed
v1.1.9,Create WMI
v1.1.9,Create BSTRs for WMI
v1.1.9,Connect to WMI
v1.1.9,Switch security level to IMPERSONATE
v1.1.9,Get list of Win32_PNPEntity devices
v1.1.9,Loop over all devices
v1.1.9,Get 20 at a time
v1.1.9,"For each device, get its device ID"
v1.1.9,"Check if the device ID contains ""IG_"".  If it does, then its an XInput device"
v1.1.9,Unfortunately this information can not be found by just using DirectInput
v1.1.9,"If it does, then get the VID/PID from var.bstrVal"
v1.1.9,Add the VID/PID to a linked list
v1.1.9,-----------------------------------------------------------------------------
v1.1.9,Returns true if the DirectInput device is also an XInput device.
v1.1.9,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.1.9,-----------------------------------------------------------------------------
v1.1.9,Check each xinput device to see if this device's vid/pid matches
v1.1.9,-----------------------------------------------------------------------------
v1.1.9,Cleanup needed for IsXInputDevice()
v1.1.9,-----------------------------------------------------------------------------
v1.1.9,Cleanup linked list
v1.1.9,-----------------------------------------------------------------------------
v1.1.9,Name: EnumJoysticksCallback()
v1.1.9,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.1.9,device interface on it so we can play with it.
v1.1.9,-----------------------------------------------------------------------------
v1.1.9,Skip anything other than the perferred joystick device as defined by the control panel.
v1.1.9,Instead you could store all the enumerated joysticks and let the user pick.
v1.1.9,Obtain an interface to the enumerated joystick.
v1.1.9,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.1.9,it while we were in the middle of enumerating it.)
v1.1.9,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.1.9,could store all the enumerated joysticks and let the user pick.
v1.1.9,-----------------------------------------------------------------------------
v1.1.9,Name: EnumObjectsCallback()
v1.1.9,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.1.9,joystick. This function enables user interface elements for objects
v1.1.9,"that are found to exist, and scales axes min/max values."
v1.1.9,-----------------------------------------------------------------------------
v1.1.9,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.1.9,enumerated axis in order to scale min/max values.
v1.1.9,Set the range for the axis
v1.1.9,Set the UI to reflect what objects the joystick supports
v1.1.9,-----------------------------------------------------------------------------
v1.1.9,Name: UpdateInputState()
v1.1.9,Desc: Get the input device's state and display it.
v1.1.9,-----------------------------------------------------------------------------
v1.1.9,Poll the device to read the current state
v1.1.9,DInput is telling us that the input stream has been
v1.1.9,"interrupted. We aren't tracking any state between polls, so"
v1.1.9,we don't have any special reset that needs to be done. We
v1.1.9,just re-acquire and try again.
v1.1.9,while (hr == DIERR_INPUTLOST)
v1.1.9,hr = g_pJoystick->Acquire();
v1.1.9,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.1.9,may occur when the app is minimized or in the process of
v1.1.9,"switching, so just try again later"
v1.1.9,Get the input's device state
v1.1.9,Axes
v1.1.9,Slider controls
v1.1.9,Points of view
v1.1.9,Buttons
v1.1.9,-----------------------------------------------------------------------------
v1.1.9,Name: FreeDirectInput()
v1.1.9,Desc: Initialize the DirectInput variables.
v1.1.9,-----------------------------------------------------------------------------
v1.1.9,Unacquire the device one last time just in case
v1.1.9,the app tried to exit while the device is still acquired.
v1.1.9,Release any DirectInput objects.
v1.1.9,nop
v1.1.9,normalize min to max --> 0 to 1
v1.1.9,normalize 0 to 1 --> -1 to 1
v1.1.9,#include <libudev.h>
v1.1.9,implementation for unsupported OS
v1.1.9,if this is new indec
v1.1.9,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.1.9,close previos one
v1.1.9,open new device
v1.1.9,if open was sucessfull
v1.1.9,read the device
v1.1.9,if we didn't had valid read
v1.1.9,"NOTE if this condition is not met, we're probably out of sync and this"
v1.1.9,Joystick instance is likely unusable
v1.1.9,TODO: set below to false?
v1.1.9,state.is_valid = false;
v1.1.9,else ignore
v1.1.9,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.1.9,{
v1.1.9,"manufacturerID = productID = """";"
v1.1.9,// Use udev to look up the product and manufacturer IDs
v1.1.9,struct udev *udev = udev_new();
v1.1.9,if (udev) {
v1.1.9,char sysname[32];
v1.1.9,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.1.9,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.1.9,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.1.9,if (!dev)
v1.1.9,{
v1.1.9,"message = ""Unable to find parent USB device"";"
v1.1.9,return false;
v1.1.9,}
v1.1.9,std::stringstream ss;
v1.1.9,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.1.9,ss >> manufacturerID;
v1.1.9,ss.clear();
v1.1.9,"ss.str("""");"
v1.1.9,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.1.9,ss >> productID;
v1.1.9,udev_device_unref(dev);
v1.1.9,}
v1.1.9,else
v1.1.9,{
v1.1.9,"message = ""Cannot create udev"";"
v1.1.9,return false;
v1.1.9,}
v1.1.9,udev_unref(udev);
v1.1.9,return true;
v1.1.9,}
v1.1.9,required for pimpl
v1.1.9,FGenericPlatformMisc::PlatformInit();
v1.1.9,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.1.9,TODO: index check
v1.1.9,create main widget
v1.1.9,synchronize PIP views
v1.1.9,TODO: should we only do below on SceneCapture2D components and cameras?
v1.1.9,avoid motion blur so capture images don't get
v1.1.9,use two different methods to set console var because sometime it doesn't seem to work
v1.1.9,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.1.9,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.1.9,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.1.9,setup defaults
v1.1.9,Attempts to parse the settings text from one of multiple locations.
v1.1.9,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.1.9,"Next, check the executable's working directory for the settings file."
v1.1.9,"Finally, check the user's documents folder."
v1.1.9,"If the settings file cannot be read, throw an exception"
v1.1.9,Attempts to parse the settings text from the command line
v1.1.9,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.1.9,"Example: AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.1.9,"Returns true if the argument is present, false otherwise."
v1.1.9,create control server
v1.1.9,stop physics thread before we dismental
v1.1.9,for (AActor* actor : spawned_actors_) {
v1.1.9,actor->Destroy();
v1.1.9,}
v1.1.9,fpv_vehicle_connectors_.Empty();
v1.1.9,get player controller
v1.1.9,put camera little bit above vehicle
v1.1.9,we will either find external camera if it already exist in evironment or create one
v1.1.9,find all BP camera directors in the environment
v1.1.9,create director
v1.1.9,create external camera required for the director
v1.1.9,find all vehicle pawns
v1.1.9,if no vehicle pawns exists in environment
v1.1.9,create vehicle pawn
v1.1.9,set up vehicle pawns
v1.1.9,initialize each vehicle pawn we found
v1.1.9,chose first pawn as FPV if none is designated as FPV
v1.1.9,now create the connector for each pawn
v1.1.9,else we don't have vehicle for this pawn
v1.1.9,TODO: because this bug we are using alternative code with stringstream
v1.1.9,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.1.9,std::stringstream ss;
v1.1.9,"ss << timestamp_millis << ""\t"";"
v1.1.9,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.1.9,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.1.9,"ss << ""\n"";"
v1.1.9,return ss.str();
v1.1.9,find vehicles and cameras available in environment
v1.1.9,if none available then we will create one
v1.1.9,get references of components so we can use later
v1.1.9,"UStaticMeshComponent* bodyMesh = UAirBlueprintLib::GetActorComponent<UStaticMeshComponent>(this, TEXT(""BodyMesh""));"
v1.1.9,"Can't obtain NedTransform from wrapper because it's not initialized yet, so make our own."
v1.1.9,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.1.9,-1 to 1 --> 0 to 1
v1.1.9,convert 0 to 1 -> -1 to 1
v1.1.9,TODO: add fields for z axis?
v1.1.9,last 8 bits are not used for now
v1.1.9,TODO: should below be at controller level info?
v1.1.9,else don't waste time
v1.1.9,"Utils::log(""------Render tick-------"");"
v1.1.9,"if reset is pending then do it first, no need to do other things until next tick"
v1.1.9,move collision info from rendering engine to vehicle
v1.1.9,update ground level
v1.1.9,update rotor poses
v1.1.9,if we did reset then don't worry about synchrnozing states for this tick
v1.1.9,Continue to wait for reset
v1.1.9,update rotor animations
v1.1.9,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response_info.collision_count_raw), LogDebugLevel::Unimportant);"
v1.1.9,Kinematics::State kinematics_estimated = controller_->getKinematicsEstimated();
v1.1.9,Kinematics::State kinematics_true = vehicle_.getKinematics();
v1.1.9,"UAirBlueprintLib::LogMessageString(""Position (true): "", VectorMath::toString(kinematics_true.pose.position), LogDebugLevel::Informational);"
v1.1.9,"UAirBlueprintLib::LogMessageString(""Position (est): "", VectorMath::toString(kinematics_estimated.pose.position), LogDebugLevel::Informational);"
v1.1.9,"UAirBlueprintLib::LogMessageString(""Lin Velocity (true): "", VectorMath::toString(kinematics_true.twist.linear), LogDebugLevel::Informational);"
v1.1.9,"UAirBlueprintLib::LogMessageString(""Lin Velocity (est): "", VectorMath::toString(kinematics_estimated.twist.linear), LogDebugLevel::Informational);"
v1.1.9,"UAirBlueprintLib::LogMessageString(""Ang Velocity (true): "", VectorMath::toString(kinematics_true.twist.angular), LogDebugLevel::Informational);"
v1.1.9,"UAirBlueprintLib::LogMessageString(""Ang Velocity (est): "", VectorMath::toString(kinematics_estimated.twist.angular), LogDebugLevel::Informational);"
v1.1.9,"UAirBlueprintLib::LogMessageString(""Lin Accel (true): "", VectorMath::toString(kinematics_true.accelerations.linear), LogDebugLevel::Informational);"
v1.1.9,"UAirBlueprintLib::LogMessageString(""Lin Accel (est): "", VectorMath::toString(kinematics_estimated.accelerations.linear), LogDebugLevel::Informational);"
v1.1.9,"UAirBlueprintLib::LogMessageString(""Ang Accel (true): "", VectorMath::toString(kinematics_true.accelerations.angular), LogDebugLevel::Informational);"
v1.1.9,"UAirBlueprintLib::LogMessageString(""Ang Accel (est): "", VectorMath::toString(kinematics_estimated.accelerations.angular), LogDebugLevel::Informational);"
v1.1.9,"UAirBlueprintLib::LogMessageString(""Orien (true): "", VectorMath::toString(kinematics_true.pose.orientation), LogDebugLevel::Informational);"
v1.1.9,"UAirBlueprintLib::LogMessageString(""Orien (est): "", VectorMath::toString(kinematics_estimated.pose.orientation), LogDebugLevel::Informational);"
v1.1.9,*** Start: UpdatableState implementation ***//
v1.1.9,schedule the task which we will execute in tick event when World object is locked
v1.1.9,TODO: should this be done in MultiRotor.hpp
v1.1.9,controller_->reset();
v1.1.9,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.1.9,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.1.9,*** End: UpdatableState implementation ***//
v1.1.9,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.1.9,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.1.9,make sire all vars are set up
v1.1.9,"todo: should we go as fast as possible, or should we limit this to a particular number of"
v1.1.9,frames per second?
v1.1.9,"UAirBlueprintLib::LogMessage(TEXT(""Stopped recording thread""), TEXT(""""), LogDebugLevel::Success);"
v1.1.9,Try to find the high polycount vehicle
v1.1.9,"If not found, spawn the default class (go-kart)"
v1.1.9,get player controller
v1.1.9,put camera little bit above vehicle
v1.1.9,we will either find external camera if it already exist in evironment or create one
v1.1.9,find all BP camera directors in the environment
v1.1.9,create director
v1.1.9,create external camera required for the director
v1.1.9,find all vehicle pawns
v1.1.9,if no vehicle pawns exists in environment
v1.1.9,create vehicle pawn
v1.1.9,set up vehicle pawns
v1.1.9,initialize each vehicle pawn we found
v1.1.9,chose first pawn as FPV if none is designated as FPV
v1.1.9,find out which RC we should use
v1.1.9,find vehicles and cameras available in environment
v1.1.9,if none available then we will create one
v1.1.9,find all vehicle pawns
v1.1.9,set up vehicle pawns
v1.1.9,initialize each vehicle pawn we found
v1.1.9,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.9,Setup suspension forces
v1.1.9,Find the tire object and set the data for it
v1.1.9,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.9,Setup suspension forces
v1.1.9,Find the tire object and set the data for it
v1.1.9,Needed for VR Headset
v1.1.9,this->AutoReceiveInput = EAutoReceiveInput::Player0;
v1.1.9,Car mesh
v1.1.9,Setup friction materials
v1.1.9,Wheels/Tyres
v1.1.9,Setup the wheels
v1.1.9,Adjust the tire loading
v1.1.9,Engine
v1.1.9,Torque setup
v1.1.9,Adjust the steering
v1.1.9,Transmission
v1.1.9,We want 4wd
v1.1.9,Drive the front wheels a little more than the rear
v1.1.9,Automatic gearbox
v1.1.9,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.1.9,Physics settings
v1.1.9,Adjust the center of mass - the buggy is quite low
v1.1.9,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.1.9,Create In-Car camera component
v1.1.9,In car HUD
v1.1.9,Create text render component for in car speed display
v1.1.9,Create text render component for in car gear display
v1.1.9,Setup the audio component and allocate it a sound cue
v1.1.9,Colors for the in-car gear display. One for normal one for reverse
v1.1.9,put camera little bit above vehicle
v1.1.9,TODO: should do reset() here?
v1.1.9,joystick
v1.1.9,below is not needed
v1.1.9,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::OnReversePressed, true);"
v1.1.9,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::OnReverseReleased, false);"
v1.1.9,TODO: update other fields
v1.1.9,Update phsyics material
v1.1.9,Update the strings used in the hud (incar and onscreen)
v1.1.9,Set the string in the incar hud
v1.1.9,Pass the engine RPM to the sound component
v1.1.9,Two steel levers behind wheel
v1.1.9,Start an engine sound playing
v1.1.9,Using FText because this is display text that should be localizable
v1.1.9,Setup the text render component strings
v1.1.9,Timestamp \t Speed \t Throttle \t Steering \t Brake \t gear
v1.1.9,timestamp
v1.1.9,Speed
v1.1.9,Gear
v1.1.9,else don't save
v1.1.9,movement_->ResetMoveState();
v1.1.9,movement_->SetActive(false);
v1.1.9,"movement_->SetActive(true, true);"
v1.1.9,call virtual method in derived class
v1.1.9,remove everything that we created in BeginPlay
v1.1.9,perfom any expensive rendering update outside of lock region
v1.1.9,should be overridden by derived class
v1.1.9,Unreal doesn't allow pure abstract methods in actors
v1.1.9,else don't init
v1.1.9,else ignore
v1.1.9,setup clock in PhysX
v1.1.9,setup clock in ClockFactory
v1.1.9,Should be overridden by derived classes
v1.1.9,Should be overridden by derived classes
v1.1.9,Should be overridden by derived classes
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,update ray tracing
v1.1.9,"FString hit_name = FString(""None"");"
v1.1.9,if (dist_hit.GetActor())
v1.1.9,hit_name=dist_hit.GetActor()->GetName();
v1.1.9,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.1.9,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,This assumes you are running DroneServer already on the same machine.
v1.1.9,DroneServer must be running first.
v1.1.9,enable API control
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,move commands
v1.1.9,else leave as it is
v1.1.9,TODO: get these in one call
v1.1.9,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.1.9,TODO: shouldn't we pass folder path?
v1.1.9,parse
v1.1.9,group the images by the current date.
v1.1.9,"std::string beforeScriptStartCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.9,{
v1.1.9,"return """";"
v1.1.9,}
v1.1.9,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.9,{
v1.1.9,return false;
v1.1.9,}
v1.1.9,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.1.9,params.context->client.newTask();
v1.1.9,}
v1.1.9,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.1.9,params.context->client.WaitForCompletion(0);
v1.1.9,}
v1.1.9,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.1.9,{
v1.1.9,}
v1.1.9,parse command line
v1.1.9,Shell callbacks
v1.1.9,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.9,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.9,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.9,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.9,Add shell commands
v1.1.9,TODO: add WaitForCompletion command
v1.1.9,"TODO: add command line args help, arg count validation"
v1.1.9,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.9,Licensed under the MIT License.
v1.1.9,switch to explicit hover mode so that this is the fallback when
v1.1.9,move* commands are finished.
v1.1.9,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.1.9,60 acres park:
v1.1.9,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.1.9,marymoore park
v1.1.9,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,read settings and override defaults
v1.1.8,allow json overrides on a per-vehicle basis.
v1.1.8,start server in async mode
v1.1.8,check messages
v1.1.8,"obj.__dict__ = {k.decode('utf-8'): (from_msgpack(v.__class__, v) if hasattr(v, ""__dict__"") else v) for k, v in encoded.items()}"
v1.1.8,return cls(**msgpack.unpack(encoded))
v1.1.8,basic flight control
v1.1.8,camera control
v1.1.8,simGetImage returns compressed png in array of bytes
v1.1.8,image_type uses one of the AirSimImageType members
v1.1.8,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.8,camera control
v1.1.8,simGetImage returns compressed png in array of bytes
v1.1.8,image_type uses one of the AirSimImageType members
v1.1.8,helper method for converting getOrientation to roll/pitch/yaw
v1.1.8,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.1.8,roll (x-axis rotation)
v1.1.8,pitch (y-axis rotation)
v1.1.8,yaw (z-axis rotation)
v1.1.8,DEY: I don't know why this was there.
v1.1.8,data = np.flipud(data)
v1.1.8,reverse the vertical line order and add null bytes at the start
v1.1.8,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.1.8,query vehicle state
v1.1.8,def getRCData(self):
v1.1.8,return self.client.call('getRCData')
v1.1.8,APIs for control
v1.1.8,-----------------------------------  Car APIs ---------------------------------------------
v1.1.8,Local variable access is faster in loops
v1.1.8,"if not wrapping over current pointer,"
v1.1.8,then check if there is terminal state wrapped inside
v1.1.8,"If index > history_length, take from a slice"
v1.1.8,Metrics accumulator
v1.1.8,Action Value model (used by agent to interact with the environment)
v1.1.8,"Target model used to compute the target Q-values in training, updated"
v1.1.8,less frequently for increased stability.
v1.1.8,Function computing Q-values targets as part of the computation graph
v1.1.8,"Define the loss, using Huber Loss (more robust to outliers)"
v1.1.8,Compute the q_targets
v1.1.8,actions is a 1-hot encoding of the action done by the agent
v1.1.8,Define training criterion as the Huber Loss function
v1.1.8,Adam based SGD
v1.1.8,Append the state to the short term memory (ie. History)
v1.1.8,"If policy requires agent to explore, sample random action"
v1.1.8,Use the network to output the best action
v1.1.8,Append batch axis with only one sample to evaluate
v1.1.8,Return the value maximizing the expected reward
v1.1.8,Keep track of interval action counter
v1.1.8,"If done, reset short term memory (ie. History)"
v1.1.8,Plot the metrics through Tensorboard and reset buffers
v1.1.8,Reset the short term memory
v1.1.8,Append to long term memory
v1.1.8,Update the Target Network if needed
v1.1.8,print(dist)
v1.1.8,connect to the AirSim simulator
v1.1.8,Make RL agent
v1.1.8,Train
v1.1.8,DEY: I don't know why this was there.
v1.1.8,data = np.flipud(data)
v1.1.8,In settings.json first activate computer vision mode:
v1.1.8,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.8,currently reset() doesn't work in CV mode. Below is the workaround
v1.1.8,connect to the AirSim simulator
v1.1.8,go forward
v1.1.8,get state of the car
v1.1.8,connect to the AirSim simulator
v1.1.8,get camera images from the car
v1.1.8,that's enough fun for now. let's quit cleanly
v1.1.8,import gym #pip install gym
v1.1.8,Local variable access is faster in loops
v1.1.8,"if not wrapping over current pointer,"
v1.1.8,then check if there is terminal state wrapped inside
v1.1.8,"If index > history_length, take from a slice"
v1.1.8,Metrics accumulator
v1.1.8,Action Value model (used by agent to interact with the environment)
v1.1.8,"Target model used to compute the target Q-values in training, updated"
v1.1.8,less frequently for increased stability.
v1.1.8,Function computing Q-values targets as part of the computation graph
v1.1.8,"Define the loss, using Huber Loss (more robust to outliers)"
v1.1.8,Compute the q_targets
v1.1.8,actions is a 1-hot encoding of the action done by the agent
v1.1.8,Define training criterion as the Huber Loss function
v1.1.8,Adam based SGD
v1.1.8,self._trainer.restore_from_checkpoint('models/oldmodels/model800000')
v1.1.8,Append the state to the short term memory (ie. History)
v1.1.8,"If policy requires agent to explore, sample random action"
v1.1.8,Use the network to output the best action
v1.1.8,Append batch axis with only one sample to evaluate
v1.1.8,Return the value maximizing the expected reward
v1.1.8,Keep track of interval action counter
v1.1.8,"If done, reset short term memory (ie. History)"
v1.1.8,Plot the metrics through Tensorboard and reset buffers
v1.1.8,Reset the short term memory
v1.1.8,Append to long term memory
v1.1.8,Update the Target Network if needed
v1.1.8,print(dist)
v1.1.8,Make RL agent
v1.1.8,Train
v1.1.8,use open cv to show new images from AirSim
v1.1.8,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.8,pip install opencv-python
v1.1.8,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.8,use open cv to create point cloud from depth image.
v1.1.8,###########################################
v1.1.8,######### This is work in progress! #######
v1.1.8,###########################################
v1.1.8,file will be saved in PythonClient folder (i.e. same folder as script)
v1.1.8,"point cloud ASCII format, use viewers like CloudCompare http://www.danielgm.net/cc/ or see http://www.geonext.nl/wp-content/uploads/2014/05/Point-Cloud-Viewers.pdf"
v1.1.8,skip it
v1.1.8,AirSim uses NED coordinates so negative axis is up.
v1.1.8,z of -7 is 7 meters above the original launch point.
v1.1.8,Fly given velocity vector for 5 seconds
v1.1.8,using DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.1.8,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.1.8,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.1.8,AirSim uses NED coordinates so negative axis is up.
v1.1.8,z of -7 is 7 meters above the original launch point.
v1.1.8,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.1.8,this method is async and we are not waiting for the result since we are passing max_wait_seconds=0.
v1.1.8,connect to the AirSim simulator
v1.1.8,get state of the car
v1.1.8,go forward
v1.1.8,Go forward + steer right
v1.1.8,go reverse
v1.1.8,apply breaks
v1.1.8,get camera images from the car
v1.1.8,restore to original state
v1.1.8,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.8,pip install opencv-python
v1.1.8,AirSim uses NED coordinates so negative axis is up.
v1.1.8,let it settle there a bit.
v1.1.8,now compute the survey path required to fill the box
v1.1.8,In settings.json first activate computer vision mode:
v1.1.8,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.8,for block environment
v1.1.8,regex are case insensetive
v1.1.8,#for neighbourhood environment
v1.1.8,set object ID for sky
v1.1.8,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.1.8,get segmentation image in various formats
v1.1.8,save segmentation images in various formats
v1.1.8,"AirSimClientBase.write_pfm(os.path.normpath(filename + '.pfm'), AirSimClientBase.getPfmArray(response))"
v1.1.8,"AirSimClientBase.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.1.8,"AirSimClientBase.write_png(os.path.normpath(filename + '.numpy.png'), img_rgba) #write to png"
v1.1.8,find unique colors
v1.1.8,connect to the AirSim simulator
v1.1.8,get state of the car
v1.1.8,go forward
v1.1.8,Go forward + steer right
v1.1.8,go reverse
v1.1.8,apply breaks
v1.1.8,restore to original state
v1.1.8,"Go to object in Unreal Editor, click on it and then look for Tags property."
v1.1.8,"Add a tag ""MyObject"" (without quotes), save and the query using following line"
v1.1.8,see more about tags here: https://answers.unrealengine.com/questions/543807/whats-the-difference-between-tag-and-tag.html
v1.1.8,from keras.models import load_model
v1.1.8,if (len(sys.argv) != 2):
v1.1.8,print('usage: python drive.py <modelName>')
v1.1.8,sys.exit()
v1.1.8,print('Loading model...')
v1.1.8,model = load_model(sys.argv[1])
v1.1.8,connect to the AirSim simulator
v1.1.8,image_buf[0] = get_image()
v1.1.8,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.1.8,"model_output = model.predict([image_buf, state_buf])"
v1.1.8,car_controls.steering = float(model_output[0][0])
v1.1.8,connect to the AirSim simulator
v1.1.8,that's enough fun for now. let's quite cleanly
v1.1.8,use open cv to show new images from AirSim
v1.1.8,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.8,pip install opencv-python
v1.1.8,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.1.8,get depth image
v1.1.8,"this will return png width= 256, height= 144"
v1.1.8,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.1.8,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.1.8,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.1.8,to get an estimate of distance.
v1.1.8,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.1.8,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.1.8,an angular delta of the following pi/10.
v1.1.8,"in header only mode, control library is not available"
v1.1.8,if using Unreal Build system then include precompiled header file first
v1.1.8,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.8,"Windows, OSX and Linux."
v1.1.8,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.1.8,Windows users can move the Documents folder to any location they want
v1.1.8,SHGetFolderPath knows how to find it.
v1.1.8,fall back in case SHGetFolderPath failed for some reason.
v1.1.8,convert from std::path '/' to windows backslash.
v1.1.8,make the current thread run with maximum priority.
v1.1.8,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.1.8,TODO: How to handle POSIX thread priorities on OSX?
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.1.8,
v1.1.8,Treat all errors as failure conditions.
v1.1.8,parse command line
v1.1.8,"motive gives a weird error if the project is not found, so we look for it."
v1.1.8,Do an update to pick up any recently-arrived cameras.
v1.1.8,List all detected cameras.
v1.1.8,List all defined rigid bodies.
v1.1.8,throttle to 50 messages per second.
v1.1.8,OptiTrack uses 'y' axis for vertical.
v1.1.8,stdafx.cpp : source file that includes just the standard includes
v1.1.8,MavlinkMoCap.pch will be the pre-compiled header
v1.1.8,stdafx.obj will contain the pre-compiled type information
v1.1.8,TODO: reference any additional headers you need in STDAFX.H
v1.1.8,and not in this file
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,PX4.cpp : Defines the entry point for the console application.
v1.1.8,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.1.8,how do you write to the debug output windows on Unix ?
v1.1.8,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.1.8,connection to create to talke to that server.
v1.1.8,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.1.8,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.1.8,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.1.8,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.1.8,using their the -qgc option.
v1.1.8,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.1.8,this switch controls whether we turn off the RC remote active link loss detection
v1.1.8,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.1.8,from kicking in when you try and fly.
v1.1.8,can't use experimental stuff on Linux because of potential ABI issues
v1.1.8,parse the json
v1.1.8,flatten inner mavlink object
v1.1.8,flatten inner mavlink object
v1.1.8,todo
v1.1.8,todo
v1.1.8,"const char* outLogFileOption = ""outlogfile"";"
v1.1.8,parse command line
v1.1.8,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.1.8,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.1.8,"no local serial connection, so this is the primary droneConnection."
v1.1.8,failed to connect
v1.1.8,"local connection, then we own sending the heartbeat."
v1.1.8,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.1.8,cmdTable.push_back(new AltHoldCommand());
v1.1.8,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.1.8,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.1.8,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.1.8,this stops us from being able to connect to SITL mode PX4.
v1.1.8,checkPulse();
v1.1.8,add command text in log
v1.1.8,close previous command.
v1.1.8,FilterLogFiles(logDirectory);
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,send a heartbeat
v1.1.8,accept one incoming connection
v1.1.8,send a heartbeat to the client
v1.1.8,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.1.8,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.1.8,for this unit test we are expecting a request to send an image.
v1.1.8,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.1.8,hmmm
v1.1.8,================ ls
v1.1.8,================ put file
v1.1.8,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.1.8,================ get file
v1.1.8,verify the file contents.
v1.1.8,================ remove file
v1.1.8,================ make directory
v1.1.8,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.1.8,================ remove directory
v1.1.8,Now verification
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,from main.cpp.
v1.1.8,you must call this method if you want HandleMessage to be called subsequently.
v1.1.8,treat literals as one word
v1.1.8,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.8,request gps info
v1.1.8,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.1.8,find relative position since command start so we can compare two commands better
v1.1.8,TODO: make below future proof (i.e. usable by C++17 compiler) - also change same in main.cpp
v1.1.8,can't use experimental stuff on Linux because of potential ABI issues
v1.1.8,"these PID values are important, so set these to match"
v1.1.8,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.1.8,we can skip ahead.
v1.1.8,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.1.8,TODO: avoid passing hadcoded HIL flag
v1.1.8,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.1.8,"The global position, as returned by the Global Positioning System (GPS)."
v1.1.8,Provides state for additional features
v1.1.8,The general system state
v1.1.8,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.8,Provides state for additional features
v1.1.8,The general system state
v1.1.8,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.8,Provides state for additional features
v1.1.8,The general system state
v1.1.8,Provides state for additional features
v1.1.8,The general system state
v1.1.8,note: we do not reset com when Close() is called because we want to keep running.
v1.1.8,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.8,generate random between 0 and 1
v1.1.8,move to range -1 to 1
v1.1.8,scale it
v1.1.8,apply iy
v1.1.8,wait for the Execute method to be called.
v1.1.8,gps is much slower frequency than IMU.
v1.1.8,MAVLINK_MSG_ID_HIL_GPS
v1.1.8,disable MAV_USEHILGPS
v1.1.8,note: we do not reset com when Close() is called because we want to keep running.
v1.1.8,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.8,generate random between 0 and 1
v1.1.8,move to range -1 to 1
v1.1.8,scale it
v1.1.8,apply iy
v1.1.8,wait for the Execute method to be called.
v1.1.8,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.1.8,gps is much slower frequency than IMU.
v1.1.8,MAVLINK_MSG_ID_HIL_GPS
v1.1.8,disable HIL mode
v1.1.8,Enumeration of landed detector states
v1.1.8,MAV landed state is unknown
v1.1.8,MAV is landed (on ground)
v1.1.8,MAV is in air
v1.1.8,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.1.8,The filtered local position
v1.1.8,must send these regularly to keep offboard control.
v1.1.8,"ok, now we can safely switch to loiter."
v1.1.8,must send these regularly to keep offboard control.
v1.1.8,integrate the heading so it is smoother.
v1.1.8,must send these regularly to keep offboard control.
v1.1.8,integrate the heading so it is smoother.
v1.1.8,fly to radius
v1.1.8,it takes about 10 cm to stop and turn.
v1.1.8,next time around switch to orbiting!
v1.1.8,heading points to center of circle.
v1.1.8,interpoloate the speed ramp up time over 2 seconds from start time
v1.1.8,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.1.8,monitor the sin curves so we can see how on track or off track it actually is.
v1.1.8,the shape of the curve will also tell us if we are progressing at a consistent
v1.1.8,"speed, the more deformed the sin curve the worse our progress."
v1.1.8,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.1.8,degrees just flipped from 359 to 0.
v1.1.8,this enables us to test what happens when offboard control is lost and resumed.
v1.1.8,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.1.8,"ok, now we can start moving by velocity"
v1.1.8,recompute to new target.
v1.1.8,start by moving right with 10 degree roll.
v1.1.8,haven't started yet.
v1.1.8,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.1.8,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.1.8,track how our actual pitch is coming along compared to our target
v1.1.8,and check position
v1.1.8,the amount of pitch should depend on our speed in that direction.
v1.1.8,passed the midpoint.
v1.1.8,fade out the pitch as we pick up speed so we don't overshoot.
v1.1.8,see if we just crossed the wiggle distance threshold.
v1.1.8,(pitch affects the x-position).
v1.1.8,reverse direction with a -30 degrees quick stop
v1.1.8,reverse direction with a 30 degrees quick stop
v1.1.8,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.1.8,too much in that direction.
v1.1.8,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.8,track how our actual roll is coming along compared to our target
v1.1.8,and check position
v1.1.8,the amount of roll should depend on our speed in that direction.
v1.1.8,passed the midpoint.
v1.1.8,fade out the roll as we pick up speed so we don't overshoot.
v1.1.8,see if we just crossed the wiggle distance threshold.
v1.1.8,(roll affects the y-position).
v1.1.8,reverse direction with a -30 degrees quick stop
v1.1.8,reverse direction with a 30 degrees quick stop
v1.1.8,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.1.8,too much in that direction.
v1.1.8,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.8,for testing PID controller.
v1.1.8,class AltHoldCommand : public Command
v1.1.8,{
v1.1.8,std::shared_ptr<MavLinkVehicle> channel;
v1.1.8,"float sx_, sy_, sz_;"
v1.1.8,MavLinkAttitudeTarget _current;
v1.1.8,PidController thrust_controller_;
v1.1.8,public:
v1.1.8,this->sz_ = pos.z; // user defined target.
v1.1.8,move to local position keeps the offboard control happy.
v1.1.8,haven't started yet.
v1.1.8,and check position
v1.1.8,double dx = this->sx_ - pos.x;
v1.1.8,double dy = this->sy_ - pos.y;
v1.1.8,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.1.8,too much in that direction.
v1.1.8,adjust thrust so we keep steady height target
v1.1.8,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.8,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.1.8,local remote
v1.1.8,already handled by the parse method.
v1.1.8,we only support very simple patterns for now.
v1.1.8,each wildcard must be separated by literal.
v1.1.8,back to back wildcards with no literal in between is too complex.
v1.1.8,"we only support simple matching for now, we can add full regex later if we need it."
v1.1.8,yep!
v1.1.8,'*' is done we found the next matching char
v1.1.8,this is ok.
v1.1.8,this is an ERASE_END_LINE command which we ignore.
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,unpack the message...
v1.1.8,pack the payload buffer.
v1.1.8,"json can't handle ""nan"", so we convert it to null."
v1.1.8,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.1.8,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,start listening to this connection
v1.1.8,Send heartbeat to drone.  You should not do this if some other node is
v1.1.8,already doing it.
v1.1.8,stop listening to the connection.
v1.1.8,get the connection
v1.1.8,Get the local system and component id
v1.1.8,send a command to the remote node
v1.1.8,MavLinkNode::MavLinkNode() = default;
v1.1.8,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.1.8,decrementing the count so the next WaitOne may block.
v1.1.8,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.1.8,convert to absolute time.
v1.1.8,use mach_timespec
v1.1.8,convert to absolute time.
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,return true if we still have offboard control (can lose this if user flips the switch).
v1.1.8,MavLinkVehicle::MavLinkVehicle() = default;
v1.1.8,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.1.8,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,============================== CLIENT ============================================
v1.1.8,image APIs
v1.1.8,or if you are implementing the client side call this function to get the most recent frame.
v1.1.8,returns false if there is no new frame available.
v1.1.8,============================== SERVER ============================================
v1.1.8,call this to send the image back over the connection given to start function.
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,"log every message that is ""sent"" using sendMessage."
v1.1.8,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.1.8,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.1.8,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.1.8,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,for compatibility with QGroundControl we have to save the time field in big endian.
v1.1.8,todo: mavlink2 support?
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,start listening to this connection
v1.1.8,Send heartbeat to drone.  You should not do this if some other node is
v1.1.8,already doing it.
v1.1.8,send a heart beat so that the remote node knows we are still alive
v1.1.8,(otherwise drone will trigger a failsafe operation).
v1.1.8,this is called for all messages received on the connection.
v1.1.8,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.1.8,subclasses remembering to call this base implementation.
v1.1.8,stop listening to the connection.
v1.1.8,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.8,wait for a heartbeat msg since this will give us the port to send commands to...
v1.1.8,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.1.8,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.8,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.8,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.8,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.8,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.8,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.8,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.1.8,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.1.8,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.1.8,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.1.8,"ok, now fetch the missing parameters."
v1.1.8,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.1.8,silently fail since we are on a background thread here...
v1.1.8,tell the caller this is complete.
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,add our custom telemetry message length.
v1.1.8,todo: if we support signing then initialize
v1.1.8,mavlink_intermediate_status_.signing callbacks
v1.1.8,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.1.8,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.8,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.8,send this right away just in case serial link is not already configured
v1.1.8,"log every message that is ""sent"" using sendMessage."
v1.1.8,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.1.8,pack the payload buffer.
v1.1.8,calculate checksum
v1.1.8,form the header as a byte array for the crc
v1.1.8,these macros use old style cast.
v1.1.8,forward messages from our connected node to the remote proxy.
v1.1.8,forward messages from remote proxy to local connected node
v1.1.8,CurrentThread::setMaximumPriority();
v1.1.8,"hmmm, wait till it is opened?"
v1.1.8,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.1.8,pick up the sysid/compid of the remote node we are connected to.
v1.1.8,then this is a mavlink 1 message
v1.1.8,then this mavlink sender supports mavlink 2
v1.1.8,queue event for publishing.
v1.1.8,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.1.8,as it ensures we don't lose messages if the listener is slow.
v1.1.8,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.1.8,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.1.8,we would get a deadlock.
v1.1.8,CurrentThread::setMaximumPriority();
v1.1.8,reset counters
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,------------------------------------------------------------------------------
v1.1.8,Defines
v1.1.8,------------------------------------------------------------------------------
v1.1.8,bit number  876543210987654321
v1.1.8,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.1.8,in future it would be good to have ability to add system IDs we are interested in
v1.1.8,if (msg.sysid != getTargetSystemId())
v1.1.8,{
v1.1.8,// we only care about messages from our intended remote node.
v1.1.8,return;
v1.1.8,}
v1.1.8,user may have changed modes on us! So we need to honor that and not
v1.1.8,try and take it back.
v1.1.8,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.1.8,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.1.8,we can store up to 16 channels in rc_channels_scaled.
v1.1.8,The RAW values of the servo outputs
v1.1.8,Metrics typically displayed on a HUD for fixed wing aircraft
v1.1.8,The IMU readings in SI units in NED body frame
v1.1.8,printSystemStatus(&msg);
v1.1.8,todo: use this to determine when we need to do emergency landing...
v1.1.8,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.1.8,Provides state for additional features
v1.1.8,The general system state
v1.1.8,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.1.8,but we do want to know when we get the ack.  So this is async ACK processing!
v1.1.8,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.1.8,if threshold < 0 then the threshold is inverted.
v1.1.8,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.1.8,Convert it to a floating point number between -1 and 1.
v1.1.8,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.1.8,until the move commands start happening.
v1.1.8,return true if user calls requestControl and has not called releaseControl.
v1.1.8,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.1.8,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.1.8,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.1.8,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.1.8,send a few to make sure it gets through...
v1.1.8,now the command should succeed.
v1.1.8,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.1.8,us by which time the PX4 times out offboard mode!!
v1.1.8,this mode change take precedence over offboard mode.
v1.1.8,thrust must be between -1 and 1.
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,These definitions are copied from PX4 implementation
v1.1.8,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.1.8,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.1.8,/ @brief Command opcodes
v1.1.8,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.1.8,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.8,must trim trailing slashes so PX4 doesn't hang!
v1.1.8,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.1.8,from the source.
v1.1.8,check if directory exists.
v1.1.8,perfect.
v1.1.8,use last_message_ so we preserve the sessionid.
v1.1.8,"could not create the local file, so stop."
v1.1.8,must use last_message_ so we preserve the session id.
v1.1.8,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.1.8,todo: error handling here? sequence is out of order...
v1.1.8,"directory must be empty then, can't do nextStep because"
v1.1.8,it will just loop for ever re-requesting zero offset into
v1.1.8,empty directory.
v1.1.8,result should be a list of null terminated file names.
v1.1.8,skipping this entry
v1.1.8,remove the file size field.
v1.1.8,"printf(""%s\n"", name.c_str());"
v1.1.8,request the next batch.
v1.1.8,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.8,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.8,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.1.8,reached the end of the list or the file.
v1.1.8,end of file or directory listing.
v1.1.8,"success, data should be following..."
v1.1.8,ack on this cmd is a noop
v1.1.8,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.1.8,give up then.
v1.1.8,tell watchdog we are sending a request
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,================================= CLIENT ==============================================================
v1.1.8,Check if we have a valid transaction
v1.1.8,emit signal if all packets arrived
v1.1.8,Restart statemachine
v1.1.8,image APIs
v1.1.8,================================= SERVER ==============================================================
v1.1.8,Prepare and send acknowledgment packet
v1.1.8,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.1.8,Send ENCAPSULATED_IMAGE packet
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.1.8,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.8,parse out the VID number
v1.1.8,now the PID
v1.1.8,parse out the VID number
v1.1.8,examples:
v1.1.8,PX4: USB\VID_26AC&PID_0011\0
v1.1.8,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.1.8,"printf(""Found: %S\n"", buffer.c_str());"
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.8,parse out the VID number
v1.1.8,now the PID
v1.1.8,parse out the VID number
v1.1.8,suppress
v1.1.8,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,This has not been properly tested
v1.1.8,struct iw_statistics stats;
v1.1.8,struct iwreq req;
v1.1.8,"memset(&stats, 0, sizeof(stats));"
v1.1.8,"memset(&req, 0, sizeof(iwreq));"
v1.1.8,
v1.1.8,"strncpy(req.ifr_name, ifaceName, 16);"
v1.1.8,req.u.data.pointer = &stats;
v1.1.8,req.u.data.length = sizeof(iw_statistics);
v1.1.8,
v1.1.8,#ifdef CLEAR_UPDATED
v1.1.8,req.u.data.flags = 1;
v1.1.8,#endif
v1.1.8,
v1.1.8,/* Perform the ioctl */
v1.1.8,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.1.8,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.1.8,return -127;
v1.1.8,}
v1.1.8,
v1.1.8,return stats.qual.level;
v1.1.8,todo: windows version of this...
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,windows
v1.1.8,Need to link with Ws2_32.lib
v1.1.8,posix
v1.1.8,found it!
v1.1.8,bind socket to local address.
v1.1.8,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.1.8,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.1.8,write to the serial port
v1.1.8,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.1.8,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.1.8,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.1.8,"try and receive something, up until port is closed anyway."
v1.1.8,"message was too large for the buffer, no problem, return what we have."
v1.1.8,try again - this can happen if server recreates the socket on their side.
v1.1.8,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.8,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.8,try again - this can happen if server recreates the socket on their side.
v1.1.8,"printf(""#### recv failed with error: %d\n"", hr);"
v1.1.8,we now have it.
v1.1.8,this is from someone we are not interested in.
v1.1.8,"printf(""Connection closed\n"");"
v1.1.8,-----------------------------------------------------------------------------------------
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,Initialize Winsock
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,windows
v1.1.8,Need to link with Ws2_32.lib
v1.1.8,posix
v1.1.8,found it!
v1.1.8,bind socket to local address.
v1.1.8,bind socket to local address.
v1.1.8,start listening for incoming connection
v1.1.8,accept 1
v1.1.8,write to the serial port
v1.1.8,"try and receive something, up until port is closed anyway."
v1.1.8,"message was too large for the buffer, no problem, return what we have."
v1.1.8,try again - this can happen if server recreates the socket on their side.
v1.1.8,"skip this, it is was interrupted."
v1.1.8,"printf(""Connection closed\n"");"
v1.1.8,-----------------------------------------------------------------------------------------
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.1.8,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.1.8,set signal
v1.1.8,Clear Handshake flags
v1.1.8,Set Handshake flags
v1.1.8,return GetLastError();
v1.1.8,return GetLastError();
v1.1.8,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.8,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.1.8,enable reading
v1.1.8,posix doesn't have mark/space parity.
v1.1.8,posix doesn't have mark/space parity.
v1.1.8,this is the default.
v1.1.8,not sure this is supported...
v1.1.8,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.1.8,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.8,First do those specified by POSIX.
v1.1.8,Now conditionally handle a bunch of extended rates.
v1.1.8,First do those specified by POSIX.
v1.1.8,Now conditionally handle a bunch of extended rates.
v1.1.8,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.8,","
v1.1.8,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.1.8,"std::unique_ptr<TestBase>(new RosFlightTest()),"
v1.1.8,"std::unique_ptr<TestBase>(new QuaternionTest()),"
v1.1.8,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,"in header only mode, control library is not available"
v1.1.8,TODO: something defines max macro which interfears with code here
v1.1.8,is cur_pos within fence?
v1.1.8,destination risk is not available then consider it zero
v1.1.8,if dest risk is lower than its more safe
v1.1.8,are we doing better than closest obstacle?
v1.1.8,"if we stay where we are, what is the risk distance?"
v1.1.8,else we are better of moving to dest
v1.1.8,this function should work even when dest_pos == cur_pos
v1.1.8,is this dest_pos cur_pos within the fence?
v1.1.8,transform dest_pos vector to body frame
v1.1.8,check for approx zero vectors to avoid random yaw angles
v1.1.8,we are hovering
v1.1.8,"get yaw in body frame, ie, front is always 0 radians"
v1.1.8,yaw to ticks
v1.1.8,get obstacles in the window at the tick direction around the window
v1.1.8,less risk distance is better
v1.1.8,check obstacles around current position and see if it has lower risk
v1.1.8,else obstacle is too far
v1.1.8,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.1.8,look for each surrounding tick to see if we have obstacle free angle
v1.1.8,else no suggestions required
v1.1.8,"3.2 comes from inverse CDF for epsilone = 0.05 (i.e. 95% confidence), author: akapoor"
v1.1.8,evaluate right and left side of circle
v1.1.8,find right and left risk distances
v1.1.8,at this point we have already determined hover is better than going to dest
v1.1.8,we now determine is moving to suggested angle better than hovering?
v1.1.8,check if dest_pos is safe
v1.1.8,breaking distance at this velocity
v1.1.8,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.1.8,check if dest_pos is safe
v1.1.8,float/vec parameters can have NaN which makes them optional
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,"in header only mode, control library is not available"
v1.1.8,handles +/- tick and wraps around circle
v1.1.8,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.1.8,update the specified window on the map
v1.1.8,make dure from <= to
v1.1.8,normalize the ticks so bothe are valid indices
v1.1.8,if from is still larger then
v1.1.8,to ticks is then added one full circle to make it larger than from_tick
v1.1.8,find closest obstacle in given window
v1.1.8,search whole map to find closest obstacle
v1.1.8,"in header only mode, control library is not available"
v1.1.8,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.8,"Windows, OSX and Linux."
v1.1.8,Windows users can move the Documents folder to any location they want
v1.1.8,SHGetFolderPath knows how to find it.
v1.1.8,fall back in case SHGetFolderPath failed for some reason.
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,"in header only mode, control library is not available"
v1.1.8,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.8,if using Unreal Build system then include precompiled header file first
v1.1.8,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.8,#undef check
v1.1.8,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.8,sim only
v1.1.8,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.8,required for pimpl
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,"in header only mode, control library is not available"
v1.1.8,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.8,if using Unreal Build system then include precompiled header file first
v1.1.8,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.1.8,sim only
v1.1.8,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.8,make sure we can talk to the DroneServer
v1.1.8,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.1.8,command_context.client.ping();
v1.1.8,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,"in header only mode, control library is not available"
v1.1.8,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.8,if using Unreal Build system then include precompiled header file first
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,"in header only mode, control library is not available"
v1.1.8,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.8,if using Unreal Build system then include precompiled header file first
v1.1.8,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.8,#undef check
v1.1.8,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.8,required for pimpl
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,"in header only mode, control library is not available"
v1.1.8,if auto mode requested for lookahead then calculate based on velocity
v1.1.8,no-op by default. derived class can override it if needed
v1.1.8,no-op by default. derived class can override it if needed
v1.1.8,validate path size
v1.1.8,validate yaw mode
v1.1.8,validate and set auto-lookahead value
v1.1.8,if auto mode requested for lookahead then calculate based on velocity
v1.1.8,add current position as starting point
v1.1.8,append the input path and compute segments
v1.1.8,add last segment as zero length segment so we have equal number of segments and points.
v1.1.8,path_segs[i] refers to segment that starts at point i
v1.1.8,"when path ends, we want to slow down"
v1.1.8,else no need to change velocities for last segments
v1.1.8,setup current position on path to 0 offset
v1.1.8,initialize next path position
v1.1.8,until we are at the end of the path (last seg is always zero size)
v1.1.8,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.1.8,send drone command to get to next lookahead
v1.1.8,sleep for rest of the cycle
v1.1.8,how much have we moved towards last goal?
v1.1.8,project actual vector on goal vector
v1.1.8,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.1.8,TODO: below should be lower than 1E3 and configurable
v1.1.8,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.1.8,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.1.8,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.1.8,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.1.8,"if drone moved backward, we don't want goal to move backward as well"
v1.1.8,"so only climb forward on the path, never back. Also note >= which means"
v1.1.8,we climb path even if distance was 0 to take care of duplicated points on path
v1.1.8,else
v1.1.8,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.1.8,compute next target on path
v1.1.8,last command is to hold on to position
v1.1.8,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.1.8,default strategy is for move. In hover mode we set new strategy temporarily
v1.1.8,freeze the quaternion
v1.1.8,get trims
v1.1.8,take average
v1.1.8,convert RC commands to velocity vector
v1.1.8,find yaw as per terrain and remote setting
v1.1.8,execute command
v1.1.8,Only raise exception is time out occurred. If preempted then return status.
v1.1.8,are we supposed to do EM?
v1.1.8,get suggested velocity vector
v1.1.8,use the unchecked command
v1.1.8,tell caller not to execute planned command
v1.1.8,other wise throw exception
v1.1.8,otherwise there is some other reason why we are in unsafe situation
v1.1.8,send last command to come to full stop
v1.1.8,else no unsafe situation
v1.1.8,note: cur_path_loc and next_path_loc may both point to same object
v1.1.8,"otherwise use up this segment, move on to next one"
v1.1.8,if we are here then we ran out of segments
v1.1.8,consider last segment as zero length segment
v1.1.8,adjust yaw for the direction of travel in foward-only mode
v1.1.8,else no adjustment needed
v1.1.8,validate dest
v1.1.8,what is the distance we will travel at this velocity?
v1.1.8,get velocity vector
v1.1.8,yaw for the direction of travel
v1.1.8,find velocity vector
v1.1.8,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.1.8,generate velocity vector that is same size as cur_dest_norm / command period
v1.1.8,this velocity vect when executed for command period would yield cur_dest_norm
v1.1.8,send commands
v1.1.8,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.1.8,by default indicate that we don't have alternative pose info
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,"in header only mode, control library is not available"
v1.1.8,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.8,if using Unreal Build system then include precompiled header file first
v1.1.8,status getters
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,"in header only mode, control library is not available"
v1.1.8,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.8,if using Unreal Build system then include precompiled header file first
v1.1.8,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.8,#undef check
v1.1.8,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.8,getters
v1.1.8,required for pimpl
v1.1.8,Create a spring arm component for our chase camera
v1.1.8,do nothing
v1.1.8,set initial view mode
v1.1.8,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.1.8,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.1.8,"If the lag is missing, the camera will also occasionally shake."
v1.1.8,"But, lag is not desired when piloting a drone"
v1.1.8,attach spring arm to actor
v1.1.8,remember current parent for external camera. Later when we remove external
v1.1.8,"camera from spring arm, we will attach it back to its last parent"
v1.1.8,now attach camera to spring arm
v1.1.8,"For car, we need to move the camera back a little more than for a drone."
v1.1.8,"Otherwise, the camera will be stuck inside the car"
v1.1.8,external_camera_->bUsePawnControlRotation = false;
v1.1.8,if prev mode was spring arm but new mode isn't then detach spring arm
v1.1.8,"else someone else is bound to manual pose controller, leave it alone"
v1.1.8,Deflect along the surface when we collide.
v1.1.8,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.1.8,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.1.8,find out which RC we should use
v1.1.8,set up key variables
v1.1.8,initialize state
v1.1.8,should be overridden in derived class
v1.1.8,if (pawn_->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.1.8,pawn_->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.1.8,pawn_->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.1.8,}
v1.1.8,TODO: delete below
v1.1.8,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.8,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.8,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.8,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.8,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.1.8,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.8,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.1.8,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.8,parameters in NED frame
v1.1.8,translate to new VehiclePawnWrapper position & orientation from NED to NEU
v1.1.8,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.1.8,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.1.8,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.1.8,checked at the start of next tick
v1.1.8,allow teleportation
v1.1.8,if collisions are not enabled
v1.1.8,or we have collided but passthrough is enabled
v1.1.8,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.1.8,"without flip flopping, collisions can't be detected"
v1.1.8,by default all image types are disabled
v1.1.8,use final color for all calculations
v1.1.8,use final color for all calculations
v1.1.8,if (!std::isnan(setting.target_gamma))
v1.1.8,camera-> = setting.target_gamma;
v1.1.8,do not make unnecessory calls to Activate() which otherwise causes crash in Unreal
v1.1.8,else nothing to enable
v1.1.8,TODO: explore screenshot option
v1.1.8,addScreenCaptureHandler(camera->GetWorld());
v1.1.8,Wait for render so that view is ready for capture
v1.1.8,not sure why this doesn't work.
v1.1.8,"DECLARE_CYCLE_STAT(TEXT(""FNullGraphTask.CheckRenderStatus""), STAT_FNullGraphTask_CheckRenderStatus, STATGROUP_TaskGraphTasks);"
v1.1.8,"auto renderStatus = TGraphTask<FNullGraphTask>::CreateTask(NULL).ConstructAndDispatchWhenReady(GET_STATID(STAT_FNullGraphTask_CheckRenderStatus), ENamedThreads::RenderThread);"
v1.1.8,FTaskGraphInterface::Get().WaitUntilTaskCompletes(renderStatus);
v1.1.8,Make sure that all alpha values are opaque.
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,"#include ""Runtime/Foliage/Public/FoliageType.h"""
v1.1.8,TODO: change naming conventions to same as other files?
v1.1.8,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.1.8,"UAirBlueprintLib::LogMessage(name + TEXT("" Actor not found!""), TEXT(""""), LogDebugLevel::Failure);"
v1.1.8,common_utils::Utils::DebugBreak();
v1.1.8,mesh->SetVisibility(false);
v1.1.8,mesh->SetVisibility(true);
v1.1.8,Explicitly set the custom depth state on the components so the
v1.1.8,render state is marked dirty and the update actually takes effect
v1.1.8,immediately.
v1.1.8,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.1.8,{
v1.1.8,InitializeObjectStencilID(*comp);
v1.1.8,}
v1.1.8,Access the subclass instance with the * or -> operators.
v1.1.8,can we see followee?
v1.1.8,remove mapping
v1.1.8,removing binding
v1.1.8,"TODO: can't do remove because there is no ""stamp"" on who established binding"
v1.1.8,removeInputBindings();
v1.1.8,#ifdef _MSC_VER
v1.1.8,//print to VS output window
v1.1.8,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.1.8,#endif
v1.1.8,also do default logging
v1.1.8,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.1.8,UGameUserSettings* game_settings = GetGameUserSettings();
v1.1.8,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.1.8,game_settings->ApplySettings(true);
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,plugin startup
v1.1.8,plugin shutdown
v1.1.8,"read pixels from render target using render thread, then compress the result into PNG"
v1.1.8,argument on the thread that calls this method.
v1.1.8,TODO: is below really needed?
v1.1.8,make sure we are not on the rendering thread
v1.1.8,TODO: below doesn't work right now because it must be running in game thread
v1.1.8,below is documented method but more expensive because it forces flush
v1.1.8,wait for render thread to pick up our task
v1.1.8,Queue up the task of rendering the scene in the render thread
v1.1.8,wait for this task to complete
v1.1.8,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.1.8,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.1.8,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.1.8,Stuff to filter out XInput devices
v1.1.8,-----------------------------------------------------------------------------
v1.1.8,"Defines, constants, and global variables"
v1.1.8,-----------------------------------------------------------------------------
v1.1.8,Register with the DirectInput subsystem and get a pointer
v1.1.8,to a IDirectInput interface we can use.
v1.1.8,Create a DInput object
v1.1.8,Look for a simple joystick we can use for this sample program.
v1.1.8,Make sure we got a joystick
v1.1.8,"Set the data format to ""simple joystick"" - a predefined data format"
v1.1.8,
v1.1.8,"A data format specifies which controls on a device we are interested in,"
v1.1.8,and how they should be reported. This tells DInput that we will be
v1.1.8,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.1.8,Set the cooperative level to let DInput know how this device should
v1.1.8,interact with the system and with other DInput applications.
v1.1.8,Enumerate the joystick objects. The callback function enabled user
v1.1.8,"interface elements for objects that are found, and sets the min/max"
v1.1.8,values property for discovered axes.
v1.1.8,-----------------------------------------------------------------------------
v1.1.8,Enum each PNP device using WMI and check each device ID to see if it contains
v1.1.8,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then its an XInput device"
v1.1.8,Unfortunately this information can not be found by just using DirectInput.
v1.1.8,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.1.8,XInput devices.
v1.1.8,
v1.1.8,This function stores the list of xinput devices in a linked list
v1.1.8,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.1.8,-----------------------------------------------------------------------------
v1.1.8,CoInit if needed
v1.1.8,Create WMI
v1.1.8,Create BSTRs for WMI
v1.1.8,Connect to WMI
v1.1.8,Switch security level to IMPERSONATE
v1.1.8,Get list of Win32_PNPEntity devices
v1.1.8,Loop over all devices
v1.1.8,Get 20 at a time
v1.1.8,"For each device, get its device ID"
v1.1.8,"Check if the device ID contains ""IG_"".  If it does, then its an XInput device"
v1.1.8,Unfortunately this information can not be found by just using DirectInput
v1.1.8,"If it does, then get the VID/PID from var.bstrVal"
v1.1.8,Add the VID/PID to a linked list
v1.1.8,-----------------------------------------------------------------------------
v1.1.8,Returns true if the DirectInput device is also an XInput device.
v1.1.8,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.1.8,-----------------------------------------------------------------------------
v1.1.8,Check each xinput device to see if this device's vid/pid matches
v1.1.8,-----------------------------------------------------------------------------
v1.1.8,Cleanup needed for IsXInputDevice()
v1.1.8,-----------------------------------------------------------------------------
v1.1.8,Cleanup linked list
v1.1.8,-----------------------------------------------------------------------------
v1.1.8,Name: EnumJoysticksCallback()
v1.1.8,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.1.8,device interface on it so we can play with it.
v1.1.8,-----------------------------------------------------------------------------
v1.1.8,Skip anything other than the perferred joystick device as defined by the control panel.
v1.1.8,Instead you could store all the enumerated joysticks and let the user pick.
v1.1.8,Obtain an interface to the enumerated joystick.
v1.1.8,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.1.8,it while we were in the middle of enumerating it.)
v1.1.8,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.1.8,could store all the enumerated joysticks and let the user pick.
v1.1.8,-----------------------------------------------------------------------------
v1.1.8,Name: EnumObjectsCallback()
v1.1.8,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.1.8,joystick. This function enables user interface elements for objects
v1.1.8,"that are found to exist, and scales axes min/max values."
v1.1.8,-----------------------------------------------------------------------------
v1.1.8,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.1.8,enumerated axis in order to scale min/max values.
v1.1.8,Set the range for the axis
v1.1.8,Set the UI to reflect what objects the joystick supports
v1.1.8,-----------------------------------------------------------------------------
v1.1.8,Name: UpdateInputState()
v1.1.8,Desc: Get the input device's state and display it.
v1.1.8,-----------------------------------------------------------------------------
v1.1.8,Poll the device to read the current state
v1.1.8,DInput is telling us that the input stream has been
v1.1.8,"interrupted. We aren't tracking any state between polls, so"
v1.1.8,we don't have any special reset that needs to be done. We
v1.1.8,just re-acquire and try again.
v1.1.8,while (hr == DIERR_INPUTLOST)
v1.1.8,hr = g_pJoystick->Acquire();
v1.1.8,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.1.8,may occur when the app is minimized or in the process of
v1.1.8,"switching, so just try again later"
v1.1.8,Get the input's device state
v1.1.8,Axes
v1.1.8,Slider controls
v1.1.8,Points of view
v1.1.8,Buttons
v1.1.8,-----------------------------------------------------------------------------
v1.1.8,Name: FreeDirectInput()
v1.1.8,Desc: Initialize the DirectInput variables.
v1.1.8,-----------------------------------------------------------------------------
v1.1.8,Unacquire the device one last time just in case
v1.1.8,the app tried to exit while the device is still acquired.
v1.1.8,Release any DirectInput objects.
v1.1.8,nop
v1.1.8,normalize min to max --> 0 to 1
v1.1.8,normalize 0 to 1 --> -1 to 1
v1.1.8,#include <libudev.h>
v1.1.8,implementation for unsupported OS
v1.1.8,if this is new indec
v1.1.8,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.1.8,close previos one
v1.1.8,open new device
v1.1.8,if open was sucessfull
v1.1.8,read the device
v1.1.8,if we didn't had valid read
v1.1.8,"NOTE if this condition is not met, we're probably out of sync and this"
v1.1.8,Joystick instance is likely unusable
v1.1.8,TODO: set below to false?
v1.1.8,state.is_valid = false;
v1.1.8,else ignore
v1.1.8,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.1.8,{
v1.1.8,"manufacturerID = productID = """";"
v1.1.8,// Use udev to look up the product and manufacturer IDs
v1.1.8,struct udev *udev = udev_new();
v1.1.8,if (udev) {
v1.1.8,char sysname[32];
v1.1.8,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.1.8,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.1.8,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.1.8,if (!dev)
v1.1.8,{
v1.1.8,"message = ""Unable to find parent USB device"";"
v1.1.8,return false;
v1.1.8,}
v1.1.8,std::stringstream ss;
v1.1.8,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.1.8,ss >> manufacturerID;
v1.1.8,ss.clear();
v1.1.8,"ss.str("""");"
v1.1.8,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.1.8,ss >> productID;
v1.1.8,udev_device_unref(dev);
v1.1.8,}
v1.1.8,else
v1.1.8,{
v1.1.8,"message = ""Cannot create udev"";"
v1.1.8,return false;
v1.1.8,}
v1.1.8,udev_unref(udev);
v1.1.8,return true;
v1.1.8,}
v1.1.8,required for pimpl
v1.1.8,FGenericPlatformMisc::PlatformInit();
v1.1.8,"FGenericPlatformMisc::MessageBoxExt(EAppMsgType::Ok, TEXT(""Error at Startup""), ANSI_TO_TCHAR(ex.what()));"
v1.1.8,TODO: index check
v1.1.8,create main widget
v1.1.8,synchronize PIP views
v1.1.8,TODO: should we only do below on SceneCapture2D components and cameras?
v1.1.8,avoid motion blur so capture images don't get
v1.1.8,use two different methods to set console var because sometime it doesn't seem to work
v1.1.8,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.1.8,during startup we init stencil IDs to random hash and it takes long time for large environments
v1.1.8,we get error that GameThread has timed out after 30 sec waiting on render thread
v1.1.8,setup defaults
v1.1.8,Attempts to parse the settings text from one of multiple locations.
v1.1.8,"First, check the command line for settings provided via ""-s"" or ""--settings"" arguments"
v1.1.8,"Next, check the executable's working directory for the settings file."
v1.1.8,"Finally, check the user's documents folder."
v1.1.8,"If the settings file cannot be read, throw an exception"
v1.1.8,Attempts to parse the settings text from the command line
v1.1.8,"Looks for the flag ""--settings"". If it exists, settingsText will be set to the value."
v1.1.8,"Example: AirSim.exe -s '{""foo"" : ""bar""}' -> settingsText will be set to {""foo"": ""bar""}"
v1.1.8,"Returns true if the argument is present, false otherwise."
v1.1.8,create control server
v1.1.8,stop physics thread before we dismental
v1.1.8,for (AActor* actor : spawned_actors_) {
v1.1.8,actor->Destroy();
v1.1.8,}
v1.1.8,fpv_vehicle_connectors_.Empty();
v1.1.8,get player controller
v1.1.8,put camera little bit above vehicle
v1.1.8,we will either find external camera if it already exist in evironment or create one
v1.1.8,find all BP camera directors in the environment
v1.1.8,create director
v1.1.8,create external camera required for the director
v1.1.8,find all vehicle pawns
v1.1.8,if no vehicle pawns exists in environment
v1.1.8,create vehicle pawn
v1.1.8,set up vehicle pawns
v1.1.8,initialize each vehicle pawn we found
v1.1.8,chose first pawn as FPV if none is designated as FPV
v1.1.8,now create the connector for each pawn
v1.1.8,else we don't have vehicle for this pawn
v1.1.8,TODO: because this bug we are using alternative code with stringstream
v1.1.8,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.1.8,std::stringstream ss;
v1.1.8,"ss << timestamp_millis << ""\t"";"
v1.1.8,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.1.8,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.1.8,"ss << ""\n"";"
v1.1.8,return ss.str();
v1.1.8,find vehicles and cameras available in environment
v1.1.8,if none available then we will create one
v1.1.8,get references of components so we can use later
v1.1.8,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.1.8,-1 to 1 --> 0 to 1
v1.1.8,convert 0 to 1 -> -1 to 1
v1.1.8,TODO: add fields for z axis?
v1.1.8,last 8 bits are not used for now
v1.1.8,TODO: should below be at controller level info?
v1.1.8,else don't waste time
v1.1.8,"Utils::log(""------Render tick-------"");"
v1.1.8,"if reset is pending then do it first, no need to do other things until next tick"
v1.1.8,move collision info from rendering engine to vehicle
v1.1.8,update ground level
v1.1.8,update rotor poses
v1.1.8,if we did reset then don't worry about synchrnozing states for this tick
v1.1.8,update rotor animations
v1.1.8,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response_info.collision_count_raw), LogDebugLevel::Unimportant);"
v1.1.8,Kinematics::State kinematics_estimated = controller_->getKinematicsEstimated();
v1.1.8,Kinematics::State kinematics_true = vehicle_.getKinematics();
v1.1.8,"UAirBlueprintLib::LogMessageString(""Position (true): "", VectorMath::toString(kinematics_true.pose.position), LogDebugLevel::Informational);"
v1.1.8,"UAirBlueprintLib::LogMessageString(""Position (est): "", VectorMath::toString(kinematics_estimated.pose.position), LogDebugLevel::Informational);"
v1.1.8,"UAirBlueprintLib::LogMessageString(""Lin Velocity (true): "", VectorMath::toString(kinematics_true.twist.linear), LogDebugLevel::Informational);"
v1.1.8,"UAirBlueprintLib::LogMessageString(""Lin Velocity (est): "", VectorMath::toString(kinematics_estimated.twist.linear), LogDebugLevel::Informational);"
v1.1.8,"UAirBlueprintLib::LogMessageString(""Ang Velocity (true): "", VectorMath::toString(kinematics_true.twist.angular), LogDebugLevel::Informational);"
v1.1.8,"UAirBlueprintLib::LogMessageString(""Ang Velocity (est): "", VectorMath::toString(kinematics_estimated.twist.angular), LogDebugLevel::Informational);"
v1.1.8,"UAirBlueprintLib::LogMessageString(""Lin Accel (true): "", VectorMath::toString(kinematics_true.accelerations.linear), LogDebugLevel::Informational);"
v1.1.8,"UAirBlueprintLib::LogMessageString(""Lin Accel (est): "", VectorMath::toString(kinematics_estimated.accelerations.linear), LogDebugLevel::Informational);"
v1.1.8,"UAirBlueprintLib::LogMessageString(""Ang Accel (true): "", VectorMath::toString(kinematics_true.accelerations.angular), LogDebugLevel::Informational);"
v1.1.8,"UAirBlueprintLib::LogMessageString(""Ang Accel (est): "", VectorMath::toString(kinematics_estimated.accelerations.angular), LogDebugLevel::Informational);"
v1.1.8,"UAirBlueprintLib::LogMessageString(""Orien (true): "", VectorMath::toString(kinematics_true.pose.orientation), LogDebugLevel::Informational);"
v1.1.8,"UAirBlueprintLib::LogMessageString(""Orien (est): "", VectorMath::toString(kinematics_estimated.pose.orientation), LogDebugLevel::Informational);"
v1.1.8,*** Start: UpdatableState implementation ***//
v1.1.8,schedule the task which we will execute in tick event when World object is locked
v1.1.8,TODO: should this be done in MultiRotor.hpp
v1.1.8,controller_->reset();
v1.1.8,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.1.8,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.1.8,*** End: UpdatableState implementation ***//
v1.1.8,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.1.8,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.1.8,make sire all vars are set up
v1.1.8,"todo: should we go as fast as possible, or should we limit this to a particular number of"
v1.1.8,frames per second?
v1.1.8,"UAirBlueprintLib::LogMessage(TEXT(""Stopped recording thread""), TEXT(""""), LogDebugLevel::Success);"
v1.1.8,Try to find the high polycount vehicle
v1.1.8,"If not found, spawn the default class (go-kart)"
v1.1.8,get player controller
v1.1.8,put camera little bit above vehicle
v1.1.8,we will either find external camera if it already exist in evironment or create one
v1.1.8,find all BP camera directors in the environment
v1.1.8,create director
v1.1.8,create external camera required for the director
v1.1.8,find all vehicle pawns
v1.1.8,if no vehicle pawns exists in environment
v1.1.8,create vehicle pawn
v1.1.8,set up vehicle pawns
v1.1.8,initialize each vehicle pawn we found
v1.1.8,chose first pawn as FPV if none is designated as FPV
v1.1.8,find out which RC we should use
v1.1.8,find vehicles and cameras available in environment
v1.1.8,if none available then we will create one
v1.1.8,find all vehicle pawns
v1.1.8,set up vehicle pawns
v1.1.8,initialize each vehicle pawn we found
v1.1.8,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.8,Setup suspension forces
v1.1.8,Find the tire object and set the data for it
v1.1.8,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.8,Setup suspension forces
v1.1.8,Find the tire object and set the data for it
v1.1.8,Needed for VR Headset
v1.1.8,this->AutoReceiveInput = EAutoReceiveInput::Player0;
v1.1.8,Car mesh
v1.1.8,Setup friction materials
v1.1.8,Wheels/Tyres
v1.1.8,Setup the wheels
v1.1.8,Adjust the tire loading
v1.1.8,Engine
v1.1.8,Torque setup
v1.1.8,Adjust the steering
v1.1.8,Transmission
v1.1.8,We want 4wd
v1.1.8,Drive the front wheels a little more than the rear
v1.1.8,Automatic gearbox
v1.1.8,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.1.8,Physics settings
v1.1.8,Adjust the center of mass - the buggy is quite low
v1.1.8,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.1.8,Create In-Car camera component
v1.1.8,In car HUD
v1.1.8,Create text render component for in car speed display
v1.1.8,Create text render component for in car gear display
v1.1.8,Setup the audio component and allocate it a sound cue
v1.1.8,Colors for the in-car gear display. One for normal one for reverse
v1.1.8,put camera little bit above vehicle
v1.1.8,TODO: should do reset() here?
v1.1.8,joystick
v1.1.8,below is not needed
v1.1.8,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::OnReversePressed, true);"
v1.1.8,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::OnReverseReleased, false);"
v1.1.8,TODO: update other fields
v1.1.8,Update phsyics material
v1.1.8,Update the strings used in the hud (incar and onscreen)
v1.1.8,Set the string in the incar hud
v1.1.8,Pass the engine RPM to the sound component
v1.1.8,Two steel levers behind wheel
v1.1.8,Start an engine sound playing
v1.1.8,Using FText because this is display text that should be localizable
v1.1.8,Setup the text render component strings
v1.1.8,Timestamp \t Speed \t Throttle \t Steering \t Brake \t gear
v1.1.8,timestamp
v1.1.8,Speed
v1.1.8,Gear
v1.1.8,else don't save
v1.1.8,movement_->ResetMoveState();
v1.1.8,movement_->SetActive(false);
v1.1.8,"movement_->SetActive(true, true);"
v1.1.8,call virtual method in derived class
v1.1.8,remove everything that we created in BeginPlay
v1.1.8,perfom any expensive rendering update outside of lock region
v1.1.8,should be overridden by derived class
v1.1.8,Unreal doesn't allow pure abstract methods in actors
v1.1.8,else don't init
v1.1.8,Should be overridden by derived classes
v1.1.8,Should be overridden by derived classes
v1.1.8,Should be overridden by derived classes
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,update ray tracing
v1.1.8,"FString hit_name = FString(""None"");"
v1.1.8,if (dist_hit.GetActor())
v1.1.8,hit_name=dist_hit.GetActor()->GetName();
v1.1.8,"UAirBlueprintLib::LogMessage(FString(""Distance to ""), hit_name+FString("": "")+FString::SanitizeFloat(distance), LogDebugLevel::Informational);"
v1.1.8,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,This assumes you are running DroneServer already on the same machine.
v1.1.8,DroneServer must be running first.
v1.1.8,enable API control
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,move commands
v1.1.8,else leave as it is
v1.1.8,TODO: get these in one call
v1.1.8,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.1.8,TODO: shouldn't we pass folder path?
v1.1.8,parse
v1.1.8,group the images by the current date.
v1.1.8,"std::string beforeScriptStartCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.8,{
v1.1.8,"return """";"
v1.1.8,}
v1.1.8,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.8,{
v1.1.8,return false;
v1.1.8,}
v1.1.8,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.1.8,params.context->client.newTask();
v1.1.8,}
v1.1.8,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.1.8,params.context->client.WaitForCompletion(0);
v1.1.8,}
v1.1.8,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.1.8,{
v1.1.8,}
v1.1.8,parse command line
v1.1.8,Shell callbacks
v1.1.8,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.8,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.8,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.8,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.8,Add shell commands
v1.1.8,TODO: add WaitForCompletion command
v1.1.8,"TODO: add command line args help, arg count validation"
v1.1.8,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.8,Licensed under the MIT License.
v1.1.8,switch to explicit hover mode so that this is the fallback when
v1.1.8,move* commands are finished.
v1.1.8,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.1.8,60 acres park:
v1.1.8,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.1.8,marymoore park
v1.1.8,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,read settings and override defaults
v1.1.7,allow json overrides on a per-vehicle basis.
v1.1.7,start server in async mode
v1.1.7,check messages
v1.1.7,basic flight control
v1.1.7,camera control
v1.1.7,simGetImage returns compressed png in array of bytes
v1.1.7,image_type uses one of the AirSimImageType members
v1.1.7,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.7,camera control
v1.1.7,simGetImage returns compressed png in array of bytes
v1.1.7,image_type uses one of the AirSimImageType members
v1.1.7,helper method for converting getOrientation to roll/pitch/yaw
v1.1.7,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.1.7,roll (x-axis rotation)
v1.1.7,pitch (y-axis rotation)
v1.1.7,yaw (z-axis rotation)
v1.1.7,DEY: I don't know why this was there.
v1.1.7,data = np.flipud(data)
v1.1.7,reverse the vertical line order and add null bytes at the start
v1.1.7,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.1.7,query vehicle state
v1.1.7,def getRCData(self):
v1.1.7,return self.client.call('getRCData')
v1.1.7,APIs for control
v1.1.7,-----------------------------------  Car APIs ---------------------------------------------
v1.1.7,Local variable access is faster in loops
v1.1.7,"if not wrapping over current pointer,"
v1.1.7,then check if there is terminal state wrapped inside
v1.1.7,"If index > history_length, take from a slice"
v1.1.7,Metrics accumulator
v1.1.7,Action Value model (used by agent to interact with the environment)
v1.1.7,"Target model used to compute the target Q-values in training, updated"
v1.1.7,less frequently for increased stability.
v1.1.7,Function computing Q-values targets as part of the computation graph
v1.1.7,"Define the loss, using Huber Loss (more robust to outliers)"
v1.1.7,Compute the q_targets
v1.1.7,actions is a 1-hot encoding of the action done by the agent
v1.1.7,Define training criterion as the Huber Loss function
v1.1.7,Adam based SGD
v1.1.7,Append the state to the short term memory (ie. History)
v1.1.7,"If policy requires agent to explore, sample random action"
v1.1.7,Use the network to output the best action
v1.1.7,Append batch axis with only one sample to evaluate
v1.1.7,Return the value maximizing the expected reward
v1.1.7,Keep track of interval action counter
v1.1.7,"If done, reset short term memory (ie. History)"
v1.1.7,Plot the metrics through Tensorboard and reset buffers
v1.1.7,Reset the short term memory
v1.1.7,Append to long term memory
v1.1.7,Update the Target Network if needed
v1.1.7,print(dist)
v1.1.7,connect to the AirSim simulator
v1.1.7,Make RL agent
v1.1.7,Train
v1.1.7,DEY: I don't know why this was there.
v1.1.7,data = np.flipud(data)
v1.1.7,In settings.json first activate computer vision mode:
v1.1.7,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.7,currently reset() doesn't work in CV mode. Below is the workaround
v1.1.7,connect to the AirSim simulator
v1.1.7,go forward
v1.1.7,get state of the car
v1.1.7,connect to the AirSim simulator
v1.1.7,get camera images from the car
v1.1.7,that's enough fun for now. let's quite cleanly
v1.1.7,Local variable access is faster in loops
v1.1.7,"if not wrapping over current pointer,"
v1.1.7,then check if there is terminal state wrapped inside
v1.1.7,"If index > history_length, take from a slice"
v1.1.7,Metrics accumulator
v1.1.7,Action Value model (used by agent to interact with the environment)
v1.1.7,"Target model used to compute the target Q-values in training, updated"
v1.1.7,less frequently for increased stability.
v1.1.7,Function computing Q-values targets as part of the computation graph
v1.1.7,"Define the loss, using Huber Loss (more robust to outliers)"
v1.1.7,Compute the q_targets
v1.1.7,actions is a 1-hot encoding of the action done by the agent
v1.1.7,Define training criterion as the Huber Loss function
v1.1.7,Adam based SGD
v1.1.7,self._trainer.restore_from_checkpoint('models/oldmodels/model800000')
v1.1.7,Append the state to the short term memory (ie. History)
v1.1.7,"If policy requires agent to explore, sample random action"
v1.1.7,Use the network to output the best action
v1.1.7,Append batch axis with only one sample to evaluate
v1.1.7,Return the value maximizing the expected reward
v1.1.7,Keep track of interval action counter
v1.1.7,"If done, reset short term memory (ie. History)"
v1.1.7,Plot the metrics through Tensorboard and reset buffers
v1.1.7,Reset the short term memory
v1.1.7,Append to long term memory
v1.1.7,Update the Target Network if needed
v1.1.7,print(dist)
v1.1.7,Make RL agent
v1.1.7,Train
v1.1.7,use open cv to show new images from AirSim
v1.1.7,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.7,pip install opencv-python
v1.1.7,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.7,use open cv to create point cloud from depth image.
v1.1.7,skip it
v1.1.7,AirSim uses NED coordinates so negative axis is up.
v1.1.7,z of -7 is 7 meters above the original launch point.
v1.1.7,Fly given velocity vector for 5 seconds
v1.1.7,using DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.1.7,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.1.7,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.1.7,AirSim uses NED coordinates so negative axis is up.
v1.1.7,z of -5 is 5 meters above the original launch point.
v1.1.7,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.1.7,this method is async and we are not waiting for the result since we are passing max_wait_seconds=0.
v1.1.7,connect to the AirSim simulator
v1.1.7,get state of the car
v1.1.7,go forward
v1.1.7,Go forward + steer right
v1.1.7,go reverse
v1.1.7,apply breaks
v1.1.7,get camera images from the car
v1.1.7,restore to original state
v1.1.7,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.7,pip install opencv-python
v1.1.7,In settings.json first activate computer vision mode:
v1.1.7,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.7,for block environment
v1.1.7,regex are case insensetive
v1.1.7,#for neighbourhood environment
v1.1.7,set object ID for sky
v1.1.7,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.1.7,get segmentation image in various formats
v1.1.7,save segmentation images in various formats
v1.1.7,"AirSimClientBase.write_pfm(os.path.normpath(filename + '.pfm'), AirSimClientBase.getPfmArray(response))"
v1.1.7,"AirSimClientBase.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.1.7,"AirSimClientBase.write_png(os.path.normpath(filename + '.numpy.png'), img_rgba) #write to png"
v1.1.7,find unique colors
v1.1.7,connect to the AirSim simulator
v1.1.7,get state of the car
v1.1.7,go forward
v1.1.7,Go forward + steer right
v1.1.7,go reverse
v1.1.7,apply breaks
v1.1.7,restore to original state
v1.1.7,from keras.models import load_model
v1.1.7,if (len(sys.argv) != 2):
v1.1.7,print('usage: python drive.py <modelName>')
v1.1.7,sys.exit()
v1.1.7,print('Loading model...')
v1.1.7,model = load_model(sys.argv[1])
v1.1.7,connect to the AirSim simulator
v1.1.7,image_buf[0] = get_image()
v1.1.7,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.1.7,"model_output = model.predict([image_buf, state_buf])"
v1.1.7,car_controls.steering = float(model_output[0][0])
v1.1.7,connect to the AirSim simulator
v1.1.7,that's enough fun for now. let's quite cleanly
v1.1.7,use open cv to show new images from AirSim
v1.1.7,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.7,pip install opencv-python
v1.1.7,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.1.7,get depth image
v1.1.7,"this will return png width= 256, height= 144"
v1.1.7,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.1.7,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.1.7,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.1.7,to get an estimate of distance.
v1.1.7,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.1.7,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.1.7,an angular delta of the following pi/10.
v1.1.7,"in header only mode, control library is not available"
v1.1.7,if using Unreal Build system then include precompiled header file first
v1.1.7,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.7,"Windows, OSX and Linux."
v1.1.7,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.1.7,Windows users can move the Documents folder to any location they want
v1.1.7,SHGetFolderPath knows how to find it.
v1.1.7,fall back in case SHGetFolderPath failed for some reason.
v1.1.7,convert from std::path '/' to windows backslash.
v1.1.7,make the current thread run with maximum priority.
v1.1.7,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.1.7,TODO: How to handle POSIX thread priorities on OSX?
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.1.7,
v1.1.7,Treat all errors as failure conditions.
v1.1.7,parse command line
v1.1.7,"motive gives a weird error if the project is not found, so we look for it."
v1.1.7,Do an update to pick up any recently-arrived cameras.
v1.1.7,List all detected cameras.
v1.1.7,List all defined rigid bodies.
v1.1.7,throttle to 50 messages per second.
v1.1.7,OptiTrack uses 'y' axis for vertical.
v1.1.7,stdafx.cpp : source file that includes just the standard includes
v1.1.7,MavlinkMoCap.pch will be the pre-compiled header
v1.1.7,stdafx.obj will contain the pre-compiled type information
v1.1.7,TODO: reference any additional headers you need in STDAFX.H
v1.1.7,and not in this file
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,PX4.cpp : Defines the entry point for the console application.
v1.1.7,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.1.7,how do you write to the debug output windows on Unix ?
v1.1.7,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.1.7,connection to create to talke to that server.
v1.1.7,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.1.7,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.1.7,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.1.7,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.1.7,using their the -qgc option.
v1.1.7,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.1.7,this switch controls whether we turn off the RC remote active link loss detection
v1.1.7,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.1.7,from kicking in when you try and fly.
v1.1.7,can't use experimental stuff on Linux because of potential ABI issues
v1.1.7,parse the json
v1.1.7,flatten inner mavlink object
v1.1.7,flatten inner mavlink object
v1.1.7,todo
v1.1.7,todo
v1.1.7,"const char* outLogFileOption = ""outlogfile"";"
v1.1.7,parse command line
v1.1.7,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.1.7,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.1.7,"no local serial connection, so this is the primary droneConnection."
v1.1.7,failed to connect
v1.1.7,"local connection, then we own sending the heartbeat."
v1.1.7,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.1.7,cmdTable.push_back(new AltHoldCommand());
v1.1.7,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.1.7,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.1.7,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.1.7,this stops us from being able to connect to SITL mode PX4.
v1.1.7,checkPulse();
v1.1.7,add command text in log
v1.1.7,close previous command.
v1.1.7,FilterLogFiles(logDirectory);
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,send a heartbeat
v1.1.7,accept one incoming connection
v1.1.7,send a heartbeat to the client
v1.1.7,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.1.7,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.1.7,for this unit test we are expecting a request to send an image.
v1.1.7,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.1.7,hmmm
v1.1.7,================ ls
v1.1.7,================ put file
v1.1.7,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.1.7,================ get file
v1.1.7,verify the file contents.
v1.1.7,================ remove file
v1.1.7,================ make directory
v1.1.7,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.1.7,================ remove directory
v1.1.7,Now verification
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,from main.cpp.
v1.1.7,you must call this method if you want HandleMessage to be called subsequently.
v1.1.7,treat literals as one word
v1.1.7,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.7,request gps info
v1.1.7,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.1.7,find relative position since command start so we can compare two commands better
v1.1.7,TODO: make below future proof (i.e. usable by C++17 compiler) - also change same in main.cpp
v1.1.7,can't use experimental stuff on Linux because of potential ABI issues
v1.1.7,"these PID values are important, so set these to match"
v1.1.7,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.1.7,we can skip ahead.
v1.1.7,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.1.7,TODO: avoid passing hadcoded HIL flag
v1.1.7,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.1.7,"The global position, as returned by the Global Positioning System (GPS)."
v1.1.7,Provides state for additional features
v1.1.7,The general system state
v1.1.7,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.7,Provides state for additional features
v1.1.7,The general system state
v1.1.7,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.7,Provides state for additional features
v1.1.7,The general system state
v1.1.7,Provides state for additional features
v1.1.7,The general system state
v1.1.7,note: we do not reset com when Close() is called because we want to keep running.
v1.1.7,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.7,generate random between 0 and 1
v1.1.7,move to range -1 to 1
v1.1.7,scale it
v1.1.7,apply iy
v1.1.7,wait for the Execute method to be called.
v1.1.7,gps is much slower frequency than IMU.
v1.1.7,MAVLINK_MSG_ID_HIL_GPS
v1.1.7,disable MAV_USEHILGPS
v1.1.7,note: we do not reset com when Close() is called because we want to keep running.
v1.1.7,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.7,generate random between 0 and 1
v1.1.7,move to range -1 to 1
v1.1.7,scale it
v1.1.7,apply iy
v1.1.7,wait for the Execute method to be called.
v1.1.7,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.1.7,gps is much slower frequency than IMU.
v1.1.7,MAVLINK_MSG_ID_HIL_GPS
v1.1.7,disable HIL mode
v1.1.7,Enumeration of landed detector states
v1.1.7,MAV landed state is unknown
v1.1.7,MAV is landed (on ground)
v1.1.7,MAV is in air
v1.1.7,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.1.7,The filtered local position
v1.1.7,must send these regularly to keep offboard control.
v1.1.7,"ok, now we can safely switch to loiter."
v1.1.7,must send these regularly to keep offboard control.
v1.1.7,integrate the heading so it is smoother.
v1.1.7,must send these regularly to keep offboard control.
v1.1.7,integrate the heading so it is smoother.
v1.1.7,fly to radius
v1.1.7,it takes about 10 cm to stop and turn.
v1.1.7,next time around switch to orbiting!
v1.1.7,heading points to center of circle.
v1.1.7,interpoloate the speed ramp up time over 2 seconds from start time
v1.1.7,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.1.7,monitor the sin curves so we can see how on track or off track it actually is.
v1.1.7,the shape of the curve will also tell us if we are progressing at a consistent
v1.1.7,"speed, the more deformed the sin curve the worse our progress."
v1.1.7,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.1.7,degrees just flipped from 359 to 0.
v1.1.7,this enables us to test what happens when offboard control is lost and resumed.
v1.1.7,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.1.7,"ok, now we can start moving by velocity"
v1.1.7,recompute to new target.
v1.1.7,start by moving right with 10 degree roll.
v1.1.7,haven't started yet.
v1.1.7,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.1.7,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.1.7,track how our actual pitch is coming along compared to our target
v1.1.7,and check position
v1.1.7,the amount of pitch should depend on our speed in that direction.
v1.1.7,passed the midpoint.
v1.1.7,fade out the pitch as we pick up speed so we don't overshoot.
v1.1.7,see if we just crossed the wiggle distance threshold.
v1.1.7,(pitch affects the x-position).
v1.1.7,reverse direction with a -30 degrees quick stop
v1.1.7,reverse direction with a 30 degrees quick stop
v1.1.7,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.1.7,too much in that direction.
v1.1.7,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.7,track how our actual roll is coming along compared to our target
v1.1.7,and check position
v1.1.7,the amount of roll should depend on our speed in that direction.
v1.1.7,passed the midpoint.
v1.1.7,fade out the roll as we pick up speed so we don't overshoot.
v1.1.7,see if we just crossed the wiggle distance threshold.
v1.1.7,(roll affects the y-position).
v1.1.7,reverse direction with a -30 degrees quick stop
v1.1.7,reverse direction with a 30 degrees quick stop
v1.1.7,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.1.7,too much in that direction.
v1.1.7,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.7,for testing PID controller.
v1.1.7,class AltHoldCommand : public Command
v1.1.7,{
v1.1.7,std::shared_ptr<MavLinkVehicle> channel;
v1.1.7,"float sx_, sy_, sz_;"
v1.1.7,MavLinkAttitudeTarget _current;
v1.1.7,PidController thrust_controller_;
v1.1.7,public:
v1.1.7,this->sz_ = pos.z; // user defined target.
v1.1.7,move to local position keeps the offboard control happy.
v1.1.7,haven't started yet.
v1.1.7,and check position
v1.1.7,double dx = this->sx_ - pos.x;
v1.1.7,double dy = this->sy_ - pos.y;
v1.1.7,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.1.7,too much in that direction.
v1.1.7,adjust thrust so we keep steady height target
v1.1.7,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.7,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.1.7,local remote
v1.1.7,already handled by the parse method.
v1.1.7,we only support very simple patterns for now.
v1.1.7,each wildcard must be separated by literal.
v1.1.7,back to back wildcards with no literal in between is too complex.
v1.1.7,"we only support simple matching for now, we can add full regex later if we need it."
v1.1.7,yep!
v1.1.7,'*' is done we found the next matching char
v1.1.7,this is ok.
v1.1.7,this is an ERASE_END_LINE command which we ignore.
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,unpack the message...
v1.1.7,pack the payload buffer.
v1.1.7,"json can't handle ""nan"", so we convert it to null."
v1.1.7,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.1.7,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,start listening to this connection
v1.1.7,Send heartbeat to drone.  You should not do this if some other node is
v1.1.7,already doing it.
v1.1.7,stop listening to the connection.
v1.1.7,get the connection
v1.1.7,Get the local system and component id
v1.1.7,send a command to the remote node
v1.1.7,MavLinkNode::MavLinkNode() = default;
v1.1.7,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.1.7,decrementing the count so the next WaitOne may block.
v1.1.7,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.1.7,convert to absolute time.
v1.1.7,use mach_timespec
v1.1.7,convert to absolute time.
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,return true if we still have offboard control (can lose this if user flips the switch).
v1.1.7,MavLinkVehicle::MavLinkVehicle() = default;
v1.1.7,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.1.7,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,============================== CLIENT ============================================
v1.1.7,image APIs
v1.1.7,or if you are implementing the client side call this function to get the most recent frame.
v1.1.7,returns false if there is no new frame available.
v1.1.7,============================== SERVER ============================================
v1.1.7,call this to send the image back over the connection given to start function.
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,"log every message that is ""sent"" using sendMessage."
v1.1.7,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.1.7,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.1.7,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.1.7,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,for compatibility with QGroundControl we have to save the time field in big endian.
v1.1.7,todo: mavlink2 support?
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,start listening to this connection
v1.1.7,Send heartbeat to drone.  You should not do this if some other node is
v1.1.7,already doing it.
v1.1.7,send a heart beat so that the remote node knows we are still alive
v1.1.7,(otherwise drone will trigger a failsafe operation).
v1.1.7,this is called for all messages received on the connection.
v1.1.7,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.1.7,subclasses remembering to call this base implementation.
v1.1.7,stop listening to the connection.
v1.1.7,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.7,wait for a heartbeat msg since this will give us the port to send commands to...
v1.1.7,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.1.7,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.7,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.7,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.7,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.7,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.7,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.7,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.1.7,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.1.7,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.1.7,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.1.7,"ok, now fetch the missing parameters."
v1.1.7,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.1.7,silently fail since we are on a background thread here...
v1.1.7,tell the caller this is complete.
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,add our custom telemetry message length.
v1.1.7,todo: if we support signing then initialize
v1.1.7,mavlink_intermediate_status_.signing callbacks
v1.1.7,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.1.7,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.7,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.7,send this right away just in case serial link is not already configured
v1.1.7,"log every message that is ""sent"" using sendMessage."
v1.1.7,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.1.7,pack the payload buffer.
v1.1.7,calculate checksum
v1.1.7,form the header as a byte array for the crc
v1.1.7,these macros use old style cast.
v1.1.7,forward messages from our connected node to the remote proxy.
v1.1.7,forward messages from remote proxy to local connected node
v1.1.7,CurrentThread::setMaximumPriority();
v1.1.7,"hmmm, wait till it is opened?"
v1.1.7,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.1.7,pick up the sysid/compid of the remote node we are connected to.
v1.1.7,then this is a mavlink 1 message
v1.1.7,then this mavlink sender supports mavlink 2
v1.1.7,queue event for publishing.
v1.1.7,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.1.7,as it ensures we don't lose messages if the listener is slow.
v1.1.7,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.1.7,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.1.7,we would get a deadlock.
v1.1.7,CurrentThread::setMaximumPriority();
v1.1.7,reset counters
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,------------------------------------------------------------------------------
v1.1.7,Defines
v1.1.7,------------------------------------------------------------------------------
v1.1.7,bit number  876543210987654321
v1.1.7,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.1.7,in future it would be good to have ability to add system IDs we are interested in
v1.1.7,if (msg.sysid != getTargetSystemId())
v1.1.7,{
v1.1.7,// we only care about messages from our intended remote node.
v1.1.7,return;
v1.1.7,}
v1.1.7,user may have changed modes on us! So we need to honor that and not
v1.1.7,try and take it back.
v1.1.7,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.1.7,we can store up to 16 channels in rc_channels_scaled.
v1.1.7,The RAW values of the servo outputs
v1.1.7,Metrics typically displayed on a HUD for fixed wing aircraft
v1.1.7,The IMU readings in SI units in NED body frame
v1.1.7,printSystemStatus(&msg);
v1.1.7,todo: use this to determine when we need to do emergency landing...
v1.1.7,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.1.7,Provides state for additional features
v1.1.7,The general system state
v1.1.7,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.1.7,but we do want to know when we get the ack.  So this is async ACK processing!
v1.1.7,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.1.7,if threshold < 0 then the threshold is inverted.
v1.1.7,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.1.7,Convert it to a floating point number between -1 and 1.
v1.1.7,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.1.7,until the move commands start happening.
v1.1.7,return true if user calls requestControl and has not called releaseControl.
v1.1.7,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.1.7,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.1.7,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.1.7,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.1.7,send a few to make sure it gets through...
v1.1.7,now the command should succeed.
v1.1.7,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.1.7,us by which time the PX4 times out offboard mode!!
v1.1.7,this mode change take precedence over offboard mode.
v1.1.7,thrust must be between -1 and 1.
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,These definitions are copied from PX4 implementation
v1.1.7,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.1.7,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.1.7,/ @brief Command opcodes
v1.1.7,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.1.7,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.7,must trim trailing slashes so PX4 doesn't hang!
v1.1.7,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.1.7,from the source.
v1.1.7,check if directory exists.
v1.1.7,perfect.
v1.1.7,use last_message_ so we preserve the sessionid.
v1.1.7,"could not create the local file, so stop."
v1.1.7,must use last_message_ so we preserve the session id.
v1.1.7,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.1.7,todo: error handling here? sequence is out of order...
v1.1.7,"directory must be empty then, can't do nextStep because"
v1.1.7,it will just loop for ever re-requesting zero offset into
v1.1.7,empty directory.
v1.1.7,result should be a list of null terminated file names.
v1.1.7,skipping this entry
v1.1.7,remove the file size field.
v1.1.7,"printf(""%s\n"", name.c_str());"
v1.1.7,request the next batch.
v1.1.7,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.7,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.7,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.1.7,reached the end of the list or the file.
v1.1.7,end of file or directory listing.
v1.1.7,"success, data should be following..."
v1.1.7,ack on this cmd is a noop
v1.1.7,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.1.7,give up then.
v1.1.7,tell watchdog we are sending a request
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,================================= CLIENT ==============================================================
v1.1.7,Check if we have a valid transaction
v1.1.7,emit signal if all packets arrived
v1.1.7,Restart statemachine
v1.1.7,image APIs
v1.1.7,================================= SERVER ==============================================================
v1.1.7,Prepare and send acknowledgment packet
v1.1.7,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.1.7,Send ENCAPSULATED_IMAGE packet
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.1.7,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.7,parse out the VID number
v1.1.7,now the PID
v1.1.7,parse out the VID number
v1.1.7,examples:
v1.1.7,PX4: USB\VID_26AC&PID_0011\0
v1.1.7,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.1.7,"printf(""Found: %S\n"", buffer.c_str());"
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.7,parse out the VID number
v1.1.7,now the PID
v1.1.7,parse out the VID number
v1.1.7,suppress
v1.1.7,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,This has not been properly tested
v1.1.7,struct iw_statistics stats;
v1.1.7,struct iwreq req;
v1.1.7,"memset(&stats, 0, sizeof(stats));"
v1.1.7,"memset(&req, 0, sizeof(iwreq));"
v1.1.7,
v1.1.7,"strncpy(req.ifr_name, ifaceName, 16);"
v1.1.7,req.u.data.pointer = &stats;
v1.1.7,req.u.data.length = sizeof(iw_statistics);
v1.1.7,
v1.1.7,#ifdef CLEAR_UPDATED
v1.1.7,req.u.data.flags = 1;
v1.1.7,#endif
v1.1.7,
v1.1.7,/* Perform the ioctl */
v1.1.7,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.1.7,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.1.7,return -127;
v1.1.7,}
v1.1.7,
v1.1.7,return stats.qual.level;
v1.1.7,todo: windows version of this...
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,windows
v1.1.7,Need to link with Ws2_32.lib
v1.1.7,posix
v1.1.7,found it!
v1.1.7,bind socket to local address.
v1.1.7,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.1.7,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.1.7,write to the serial port
v1.1.7,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.1.7,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.1.7,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.1.7,"try and receive something, up until port is closed anyway."
v1.1.7,"message was too large for the buffer, no problem, return what we have."
v1.1.7,try again - this can happen if server recreates the socket on their side.
v1.1.7,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.7,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.7,try again - this can happen if server recreates the socket on their side.
v1.1.7,"printf(""#### recv failed with error: %d\n"", hr);"
v1.1.7,we now have it.
v1.1.7,this is from someone we are not interested in.
v1.1.7,"printf(""Connection closed\n"");"
v1.1.7,-----------------------------------------------------------------------------------------
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,Initialize Winsock
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,windows
v1.1.7,Need to link with Ws2_32.lib
v1.1.7,posix
v1.1.7,found it!
v1.1.7,bind socket to local address.
v1.1.7,bind socket to local address.
v1.1.7,start listening for incoming connection
v1.1.7,accept 1
v1.1.7,write to the serial port
v1.1.7,"try and receive something, up until port is closed anyway."
v1.1.7,"message was too large for the buffer, no problem, return what we have."
v1.1.7,try again - this can happen if server recreates the socket on their side.
v1.1.7,"skip this, it is was interrupted."
v1.1.7,"printf(""Connection closed\n"");"
v1.1.7,-----------------------------------------------------------------------------------------
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.1.7,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.1.7,set signal
v1.1.7,Clear Handshake flags
v1.1.7,Set Handshake flags
v1.1.7,return GetLastError();
v1.1.7,return GetLastError();
v1.1.7,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.7,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.1.7,enable reading
v1.1.7,posix doesn't have mark/space parity.
v1.1.7,posix doesn't have mark/space parity.
v1.1.7,this is the default.
v1.1.7,not sure this is supported...
v1.1.7,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.1.7,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.7,First do those specified by POSIX.
v1.1.7,Now conditionally handle a bunch of extended rates.
v1.1.7,First do those specified by POSIX.
v1.1.7,Now conditionally handle a bunch of extended rates.
v1.1.7,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.7,","
v1.1.7,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.1.7,"std::unique_ptr<TestBase>(new RosFlightTest()),"
v1.1.7,"std::unique_ptr<TestBase>(new QuaternionTest()),"
v1.1.7,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,"in header only mode, control library is not available"
v1.1.7,TODO: something defines max macro which interfears with code here
v1.1.7,is cur_pos within fence?
v1.1.7,destination risk is not available then consider it zero
v1.1.7,if dest risk is lower than its more safe
v1.1.7,are we doing better than closest obstacle?
v1.1.7,"if we stay where we are, what is the risk distance?"
v1.1.7,else we are better of moving to dest
v1.1.7,this function should work even when dest_pos == cur_pos
v1.1.7,is this dest_pos cur_pos within the fence?
v1.1.7,transform dest_pos vector to body frame
v1.1.7,check for approx zero vectors to avoid random yaw angles
v1.1.7,we are hovering
v1.1.7,"get yaw in body frame, ie, front is always 0 radians"
v1.1.7,yaw to ticks
v1.1.7,get obstacles in the window at the tick direction around the window
v1.1.7,less risk distance is better
v1.1.7,check obstacles around current position and see if it has lower risk
v1.1.7,else obstacle is too far
v1.1.7,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.1.7,look for each surrounding tick to see if we have obstacle free angle
v1.1.7,else no suggestions required
v1.1.7,"3.2 comes from inverse CDF for epsilone = 0.05 (i.e. 95% confidence), author: akapoor"
v1.1.7,evaluate right and left side of circle
v1.1.7,find right and left risk distances
v1.1.7,at this point we have already determined hover is better than going to dest
v1.1.7,we now determine is moving to suggested angle better than hovering?
v1.1.7,check if dest_pos is safe
v1.1.7,breaking distance at this velocity
v1.1.7,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.1.7,check if dest_pos is safe
v1.1.7,float/vec parameters can have NaN which makes them optional
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,"in header only mode, control library is not available"
v1.1.7,handles +/- tick and wraps around circle
v1.1.7,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.1.7,update the specified window on the map
v1.1.7,make dure from <= to
v1.1.7,normalize the ticks so bothe are valid indices
v1.1.7,if from is still larger then
v1.1.7,to ticks is then added one full circle to make it larger than from_tick
v1.1.7,find closest obstacle in given window
v1.1.7,search whole map to find closest obstacle
v1.1.7,"in header only mode, control library is not available"
v1.1.7,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.7,"Windows, OSX and Linux."
v1.1.7,Windows users can move the Documents folder to any location they want
v1.1.7,SHGetFolderPath knows how to find it.
v1.1.7,fall back in case SHGetFolderPath failed for some reason.
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,"in header only mode, control library is not available"
v1.1.7,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.7,if using Unreal Build system then include precompiled header file first
v1.1.7,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.7,#undef check
v1.1.7,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.7,sim only
v1.1.7,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.7,required for pimpl
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,"in header only mode, control library is not available"
v1.1.7,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.7,if using Unreal Build system then include precompiled header file first
v1.1.7,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.1.7,sim only
v1.1.7,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.7,make sure we can talk to the DroneServer
v1.1.7,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.1.7,command_context.client.ping();
v1.1.7,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,"in header only mode, control library is not available"
v1.1.7,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.7,if using Unreal Build system then include precompiled header file first
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,"in header only mode, control library is not available"
v1.1.7,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.7,if using Unreal Build system then include precompiled header file first
v1.1.7,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.7,#undef check
v1.1.7,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.7,required for pimpl
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,"in header only mode, control library is not available"
v1.1.7,if auto mode requested for lookahead then calculate based on velocity
v1.1.7,no-op by default. derived class can override it if needed
v1.1.7,no-op by default. derived class can override it if needed
v1.1.7,validate path size
v1.1.7,validate yaw mode
v1.1.7,validate and set auto-lookahead value
v1.1.7,if auto mode requested for lookahead then calculate based on velocity
v1.1.7,add current position as starting point
v1.1.7,append the input path and compute segments
v1.1.7,add last segment as zero length segment so we have equal number of segments and points.
v1.1.7,path_segs[i] refers to segment that starts at point i
v1.1.7,"when path ends, we want to slow down"
v1.1.7,else no need to change velocities for last segments
v1.1.7,setup current position on path to 0 offset
v1.1.7,initialize next path position
v1.1.7,until we are at the end of the path (last seg is always zero size)
v1.1.7,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.1.7,send drone command to get to next lookahead
v1.1.7,sleep for rest of the cycle
v1.1.7,how much have we moved towards last goal?
v1.1.7,project actual vector on goal vector
v1.1.7,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.1.7,TODO: below should be lower than 1E3 and configurable
v1.1.7,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.1.7,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.1.7,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.1.7,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.1.7,"if drone moved backward, we don't want goal to move backward as well"
v1.1.7,"so only climb forward on the path, never back. Also note >= which means"
v1.1.7,we climb path even if distance was 0 to take care of duplicated points on path
v1.1.7,else
v1.1.7,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.1.7,compute next target on path
v1.1.7,last command is to hold on to position
v1.1.7,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.1.7,default strategy is for move. In hover mode we set new strategy temporarily
v1.1.7,freeze the quaternion
v1.1.7,get trims
v1.1.7,take average
v1.1.7,convert RC commands to velocity vector
v1.1.7,find yaw as per terrain and remote setting
v1.1.7,execute command
v1.1.7,Only raise exception is time out occurred. If preempted then return status.
v1.1.7,are we supposed to do EM?
v1.1.7,get suggested velocity vector
v1.1.7,use the unchecked command
v1.1.7,tell caller not to execute planned command
v1.1.7,other wise throw exception
v1.1.7,otherwise there is some other reason why we are in unsafe situation
v1.1.7,send last command to come to full stop
v1.1.7,else no unsafe situation
v1.1.7,note: cur_path_loc and next_path_loc may both point to same object
v1.1.7,"otherwise use up this segment, move on to next one"
v1.1.7,if we are here then we ran out of segments
v1.1.7,consider last segment as zero length segment
v1.1.7,adjust yaw for the direction of travel in foward-only mode
v1.1.7,else no adjustment needed
v1.1.7,validate dest
v1.1.7,what is the distance we will travel at this velocity?
v1.1.7,get velocity vector
v1.1.7,yaw for the direction of travel
v1.1.7,find velocity vector
v1.1.7,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.1.7,generate velocity vector that is same size as cur_dest_norm / command period
v1.1.7,this velocity vect when executed for command period would yield cur_dest_norm
v1.1.7,send commands
v1.1.7,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.1.7,by default indicate that we don't have alternative pose info
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,"in header only mode, control library is not available"
v1.1.7,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.7,if using Unreal Build system then include precompiled header file first
v1.1.7,status getters
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,"in header only mode, control library is not available"
v1.1.7,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.7,if using Unreal Build system then include precompiled header file first
v1.1.7,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.7,#undef check
v1.1.7,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.7,getters
v1.1.7,required for pimpl
v1.1.7,Create a spring arm component for our chase camera
v1.1.7,do nothing
v1.1.7,set initial view mode
v1.1.7,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.1.7,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.1.7,"If the lag is missing, the camera will also occasionally shake."
v1.1.7,"But, lag is not desired when piloting a drone"
v1.1.7,attach spring arm to actor
v1.1.7,remember current parent for external camera. Later when we remove external
v1.1.7,"camera from spring arm, we will attach it back to its last parent"
v1.1.7,now attach camera to spring arm
v1.1.7,"For car, we need to move the camera back a little more than for a drone."
v1.1.7,"Otherwise, the camera will be stuck inside the car"
v1.1.7,external_camera_->bUsePawnControlRotation = false;
v1.1.7,if prev mode was spring arm but new mode isn't then detach spring arm
v1.1.7,"else someone else is bound to manual pose controller, leave it alone"
v1.1.7,TODO: explore screenshot option
v1.1.7,addScreenCaptureHandler(camera->GetWorld());
v1.1.7,Wait for render so that view is ready for capture
v1.1.7,not sure why this doesn't work.
v1.1.7,"DECLARE_CYCLE_STAT(TEXT(""FNullGraphTask.CheckRenderStatus""), STAT_FNullGraphTask_CheckRenderStatus, STATGROUP_TaskGraphTasks);"
v1.1.7,"auto renderStatus = TGraphTask<FNullGraphTask>::CreateTask(NULL).ConstructAndDispatchWhenReady(GET_STATID(STAT_FNullGraphTask_CheckRenderStatus), ENamedThreads::RenderThread);"
v1.1.7,FTaskGraphInterface::Get().WaitUntilTaskCompletes(renderStatus);
v1.1.7,Make sure that all alpha values are opaque.
v1.1.7,Deflect along the surface when we collide.
v1.1.7,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.1.7,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.1.7,set up key variables
v1.1.7,initialize state
v1.1.7,should be overridden in derived class
v1.1.7,should be overridden in derived class
v1.1.7,if (pawn_->GetRootPrimitiveComponent()->IsAnySimulatingPhysics()) {
v1.1.7,pawn_->GetRootPrimitiveComponent()->SetSimulatePhysics(false);
v1.1.7,pawn_->GetRootPrimitiveComponent()->SetSimulatePhysics(true);
v1.1.7,}
v1.1.7,TODO: delete below
v1.1.7,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.7,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.7,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.7,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.7,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.1.7,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.7,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.1.7,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.7,parameters in NED frame
v1.1.7,translate to new VehiclePawnWrapper position & orientation from NED to NEU
v1.1.7,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.1.7,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.1.7,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.1.7,checked at the start of next tick
v1.1.7,allow teleportation
v1.1.7,if collisions are not enabled
v1.1.7,or we have collided but passthrough is enabled
v1.1.7,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.1.7,"without flip flopping, collisions can't be detected"
v1.1.7,set default for brigher images
v1.1.7,by default all image types are disabled
v1.1.7,use final color for all calculations
v1.1.7,use final color for all calculations
v1.1.7,else we will set this after this components get created
v1.1.7,else we will set this after this components get created
v1.1.7,do not make unnecessory calls to Activate() which otherwise causes crash in Unreal
v1.1.7,else nothing to enable
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,"#include ""Runtime/Foliage/Public/FoliageType.h"""
v1.1.7,TODO: change naming conventions to same as other files?
v1.1.7,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.1.7,common_utils::Utils::DebugBreak();
v1.1.7,mesh->SetVisibility(false);
v1.1.7,mesh->SetVisibility(true);
v1.1.7,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.1.7,{
v1.1.7,InitializeObjectStencilID(*comp);
v1.1.7,}
v1.1.7,Access the subclass instance with the * or -> operators.
v1.1.7,can we see followee?
v1.1.7,remove mapping
v1.1.7,removing binding
v1.1.7,"TODO: can't do remove because there is no ""stamp"" on who established binding"
v1.1.7,removeInputBindings();
v1.1.7,#ifdef _MSC_VER
v1.1.7,//print to VS output window
v1.1.7,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.1.7,#endif
v1.1.7,also do default logging
v1.1.7,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.1.7,UGameUserSettings* game_settings = GetGameUserSettings();
v1.1.7,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.1.7,game_settings->ApplySettings(true);
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,plugin startup
v1.1.7,plugin shutdown
v1.1.7,"read pixels from render target using render thread, then compress the result into PNG"
v1.1.7,argument on the thread that calls this method.
v1.1.7,make sure we are not on the rendering thread
v1.1.7,TODO: below doesn't work right now because it must be running in game thread
v1.1.7,below is documented method but more expensive because it forces flush
v1.1.7,wait for render thread to pick up our task
v1.1.7,Queue up the task of rendering the scene in the render thread
v1.1.7,wait for this task to complete
v1.1.7,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.1.7,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.1.7,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.1.7,Stuff to filter out XInput devices
v1.1.7,-----------------------------------------------------------------------------
v1.1.7,"Defines, constants, and global variables"
v1.1.7,-----------------------------------------------------------------------------
v1.1.7,Register with the DirectInput subsystem and get a pointer
v1.1.7,to a IDirectInput interface we can use.
v1.1.7,Create a DInput object
v1.1.7,Look for a simple joystick we can use for this sample program.
v1.1.7,Make sure we got a joystick
v1.1.7,"Set the data format to ""simple joystick"" - a predefined data format"
v1.1.7,
v1.1.7,"A data format specifies which controls on a device we are interested in,"
v1.1.7,and how they should be reported. This tells DInput that we will be
v1.1.7,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.1.7,Set the cooperative level to let DInput know how this device should
v1.1.7,interact with the system and with other DInput applications.
v1.1.7,Enumerate the joystick objects. The callback function enabled user
v1.1.7,"interface elements for objects that are found, and sets the min/max"
v1.1.7,values property for discovered axes.
v1.1.7,-----------------------------------------------------------------------------
v1.1.7,Enum each PNP device using WMI and check each device ID to see if it contains
v1.1.7,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then its an XInput device"
v1.1.7,Unfortunately this information can not be found by just using DirectInput.
v1.1.7,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.1.7,XInput devices.
v1.1.7,
v1.1.7,This function stores the list of xinput devices in a linked list
v1.1.7,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.1.7,-----------------------------------------------------------------------------
v1.1.7,CoInit if needed
v1.1.7,Create WMI
v1.1.7,Create BSTRs for WMI
v1.1.7,Connect to WMI
v1.1.7,Switch security level to IMPERSONATE
v1.1.7,Get list of Win32_PNPEntity devices
v1.1.7,Loop over all devices
v1.1.7,Get 20 at a time
v1.1.7,"For each device, get its device ID"
v1.1.7,"Check if the device ID contains ""IG_"".  If it does, then its an XInput device"
v1.1.7,Unfortunately this information can not be found by just using DirectInput
v1.1.7,"If it does, then get the VID/PID from var.bstrVal"
v1.1.7,Add the VID/PID to a linked list
v1.1.7,-----------------------------------------------------------------------------
v1.1.7,Returns true if the DirectInput device is also an XInput device.
v1.1.7,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.1.7,-----------------------------------------------------------------------------
v1.1.7,Check each xinput device to see if this device's vid/pid matches
v1.1.7,-----------------------------------------------------------------------------
v1.1.7,Cleanup needed for IsXInputDevice()
v1.1.7,-----------------------------------------------------------------------------
v1.1.7,Cleanup linked list
v1.1.7,-----------------------------------------------------------------------------
v1.1.7,Name: EnumJoysticksCallback()
v1.1.7,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.1.7,device interface on it so we can play with it.
v1.1.7,-----------------------------------------------------------------------------
v1.1.7,Skip anything other than the perferred joystick device as defined by the control panel.
v1.1.7,Instead you could store all the enumerated joysticks and let the user pick.
v1.1.7,Obtain an interface to the enumerated joystick.
v1.1.7,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.1.7,it while we were in the middle of enumerating it.)
v1.1.7,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.1.7,could store all the enumerated joysticks and let the user pick.
v1.1.7,-----------------------------------------------------------------------------
v1.1.7,Name: EnumObjectsCallback()
v1.1.7,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.1.7,joystick. This function enables user interface elements for objects
v1.1.7,"that are found to exist, and scales axes min/max values."
v1.1.7,-----------------------------------------------------------------------------
v1.1.7,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.1.7,enumerated axis in order to scale min/max values.
v1.1.7,Set the range for the axis
v1.1.7,Set the UI to reflect what objects the joystick supports
v1.1.7,-----------------------------------------------------------------------------
v1.1.7,Name: UpdateInputState()
v1.1.7,Desc: Get the input device's state and display it.
v1.1.7,-----------------------------------------------------------------------------
v1.1.7,Poll the device to read the current state
v1.1.7,DInput is telling us that the input stream has been
v1.1.7,"interrupted. We aren't tracking any state between polls, so"
v1.1.7,we don't have any special reset that needs to be done. We
v1.1.7,just re-acquire and try again.
v1.1.7,while (hr == DIERR_INPUTLOST)
v1.1.7,hr = g_pJoystick->Acquire();
v1.1.7,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.1.7,may occur when the app is minimized or in the process of
v1.1.7,"switching, so just try again later"
v1.1.7,Get the input's device state
v1.1.7,Axes
v1.1.7,Slider controls
v1.1.7,Points of view
v1.1.7,Buttons
v1.1.7,-----------------------------------------------------------------------------
v1.1.7,Name: FreeDirectInput()
v1.1.7,Desc: Initialize the DirectInput variables.
v1.1.7,-----------------------------------------------------------------------------
v1.1.7,Unacquire the device one last time just in case
v1.1.7,the app tried to exit while the device is still acquired.
v1.1.7,Release any DirectInput objects.
v1.1.7,nop
v1.1.7,normalize min to max --> 0 to 1
v1.1.7,normalize 0 to 1 --> -1 to 1
v1.1.7,#include <libudev.h>
v1.1.7,implementation for unsupported OS
v1.1.7,if this is new indec
v1.1.7,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.1.7,close previos one
v1.1.7,open new device
v1.1.7,if open was sucessfull
v1.1.7,read the device
v1.1.7,if we didn't had valid read
v1.1.7,"NOTE if this condition is not met, we're probably out of sync and this"
v1.1.7,Joystick instance is likely unusable
v1.1.7,TODO: set below to false?
v1.1.7,state.is_valid = false;
v1.1.7,else ignore
v1.1.7,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.1.7,{
v1.1.7,"manufacturerID = productID = """";"
v1.1.7,// Use udev to look up the product and manufacturer IDs
v1.1.7,struct udev *udev = udev_new();
v1.1.7,if (udev) {
v1.1.7,char sysname[32];
v1.1.7,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.1.7,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.1.7,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.1.7,if (!dev)
v1.1.7,{
v1.1.7,"message = ""Unable to find parent USB device"";"
v1.1.7,return false;
v1.1.7,}
v1.1.7,std::stringstream ss;
v1.1.7,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.1.7,ss >> manufacturerID;
v1.1.7,ss.clear();
v1.1.7,"ss.str("""");"
v1.1.7,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.1.7,ss >> productID;
v1.1.7,udev_device_unref(dev);
v1.1.7,}
v1.1.7,else
v1.1.7,{
v1.1.7,"message = ""Cannot create udev"";"
v1.1.7,return false;
v1.1.7,}
v1.1.7,udev_unref(udev);
v1.1.7,return true;
v1.1.7,}
v1.1.7,required for pimpl
v1.1.7,TODO: should we only do below on SceneCapture2D components and cameras?
v1.1.7,avoid motion blur so capture images don't get
v1.1.7,use two different methods to set console var because sometime it doesn't seem to work
v1.1.7,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.1.7,create main widget
v1.1.7,synchronize PIP views
v1.1.7,setup defaults
v1.1.7,TODO: should this be done somewhere else?
v1.1.7,load settings file if found
v1.1.7,create default settings
v1.1.7,"write some settings in new file otherwise the string ""null"" is written if all settigs are empty"
v1.1.7,TODO: there is a crash in Linux due to settings.saveJSonString(). Remove this workaround after we only support Unreal 4.17
v1.1.7,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.1.7,create its control server
v1.1.7,stop physics thread before we dismental
v1.1.7,for (AActor* actor : spawned_actors_) {
v1.1.7,actor->Destroy();
v1.1.7,}
v1.1.7,get player controller
v1.1.7,put camera little bit above vehicle
v1.1.7,we will either find external camera if it already exist in evironment or create one
v1.1.7,find all BP camera directors in the environment
v1.1.7,create director
v1.1.7,create external camera required for the director
v1.1.7,find all vehicle pawns
v1.1.7,if no vehicle pawns exists in environment
v1.1.7,create vehicle pawn
v1.1.7,set up vehicle pawns
v1.1.7,initialize each vehicle pawn we found
v1.1.7,chose first pawn as FPV if none is designated as FPV
v1.1.7,now create the connector for each pawn
v1.1.7,else we don't have vehicle for this pawn
v1.1.7,TODO: because this bug we are using alternative code with stringstream
v1.1.7,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.1.7,std::stringstream ss;
v1.1.7,"ss << timestamp_millis << ""\t"";"
v1.1.7,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.1.7,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.1.7,"ss << ""\n"";"
v1.1.7,return ss.str();
v1.1.7,find vehicles and cameras available in environment
v1.1.7,if none available then we will create one
v1.1.7,get references of components so we can use later
v1.1.7,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.1.7,-1 to 1 --> 0 to 1
v1.1.7,convert 0 to 1 -> -1 to 1
v1.1.7,TODO: add fields for z axis?
v1.1.7,last 8 bits are not used for now
v1.1.7,TODO: should below be at controller level info?
v1.1.7,else don't waste time
v1.1.7,"Utils::log(""------Render tick-------"");"
v1.1.7,"if reset is pending then do it first, no need to do other things until next tick"
v1.1.7,move collision info from rendering engine to vehicle
v1.1.7,update ground level
v1.1.7,update rotor poses
v1.1.7,if we did reset then don't worry about synchrnozing states for this tick
v1.1.7,update rotor animations
v1.1.7,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response_info.collision_count_raw), LogDebugLevel::Unimportant);"
v1.1.7,*** Start: UpdatableState implementation ***//
v1.1.7,schedule the task which we will execute in tick event when World object is locked
v1.1.7,TODO: should this be done in MultiRotor.hpp
v1.1.7,controller_->reset();
v1.1.7,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.1.7,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.1.7,*** End: UpdatableState implementation ***//
v1.1.7,"If render command is complete, save image along with position and orientation"
v1.1.7,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.1.7,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.1.7,make sire all vars are set up
v1.1.7,"todo: should we go as fast as possible, or should we limit this to a particular number of"
v1.1.7,frames per second?
v1.1.7,"UAirBlueprintLib::LogMessage(TEXT(""Stopped recording thread""), TEXT(""""), LogDebugLevel::Success);"
v1.1.7,Try to find the high polycount vehicle
v1.1.7,"If not found, spawn the default class (go-kart)"
v1.1.7,Timestamp \t Speed \t Throttle \t Steering \t Brake \t gear \t ImageName
v1.1.7,get player controller
v1.1.7,put camera little bit above vehicle
v1.1.7,we will either find external camera if it already exist in evironment or create one
v1.1.7,find all BP camera directors in the environment
v1.1.7,create director
v1.1.7,create external camera required for the director
v1.1.7,find all vehicle pawns
v1.1.7,if no vehicle pawns exists in environment
v1.1.7,create vehicle pawn
v1.1.7,set up vehicle pawns
v1.1.7,initialize each vehicle pawn we found
v1.1.7,chose first pawn as FPV if none is designated as FPV
v1.1.7,find out which RC we should use
v1.1.7,find vehicles and cameras available in environment
v1.1.7,if none available then we will create one
v1.1.7,find all vehicle pawns
v1.1.7,set up vehicle pawns
v1.1.7,initialize each vehicle pawn we found
v1.1.7,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.7,Setup suspension forces
v1.1.7,Find the tire object and set the data for it
v1.1.7,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.7,Setup suspension forces
v1.1.7,Find the tire object and set the data for it
v1.1.7,Needed for VR Headset
v1.1.7,this->AutoReceiveInput = EAutoReceiveInput::Player0;
v1.1.7,Car mesh
v1.1.7,Setup friction materials
v1.1.7,Wheels/Tyres
v1.1.7,Setup the wheels
v1.1.7,Adjust the tire loading
v1.1.7,Engine
v1.1.7,Torque setup
v1.1.7,Adjust the steering
v1.1.7,Transmission
v1.1.7,We want 4wd
v1.1.7,Drive the front wheels a little more than the rear
v1.1.7,Automatic gearbox
v1.1.7,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.1.7,Physics settings
v1.1.7,Adjust the center of mass - the buggy is quite low
v1.1.7,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.1.7,Create In-Car camera component
v1.1.7,In car HUD
v1.1.7,Create text render component for in car speed display
v1.1.7,Create text render component for in car gear display
v1.1.7,Setup the audio component and allocate it a sound cue
v1.1.7,Colors for the in-car gear display. One for normal one for reverse
v1.1.7,put camera little bit above vehicle
v1.1.7,TODO: should do reset() here?
v1.1.7,joystick
v1.1.7,below is not needed
v1.1.7,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::OnReversePressed, true);"
v1.1.7,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::OnReverseReleased, false);"
v1.1.7,TODO: update other fields
v1.1.7,Update phsyics material
v1.1.7,Update the strings used in the hud (incar and onscreen)
v1.1.7,Set the string in the incar hud
v1.1.7,Pass the engine RPM to the sound component
v1.1.7,Two steel levers behind wheel
v1.1.7,Start an engine sound playing
v1.1.7,Using FText because this is display text that should be localizable
v1.1.7,Setup the text render component strings
v1.1.7,Timestamp \t Speed \t Throttle \t Steering \t Brake \t gear
v1.1.7,timestamp
v1.1.7,Speed
v1.1.7,Gear
v1.1.7,else don't save
v1.1.7,movement_->ResetMoveState();
v1.1.7,movement_->SetActive(false);
v1.1.7,"movement_->SetActive(true, true);"
v1.1.7,call virtual method in derived class
v1.1.7,remove everything that we created in BeginPlay
v1.1.7,perfom any expensive rendering update outside of lock region
v1.1.7,should be overridden by derived class
v1.1.7,Unreal doesn't allow pure abstract methods in actors
v1.1.7,set defaults in case exception occurs
v1.1.7,we had spelling mistake so we are currently supporting SettingsVersion or SettingdVersion :(
v1.1.7,no warnings because we have default settings
v1.1.7,by default we spawn server at local endpoint. Do not use 127.0.0.1 as default below
v1.1.7,because for docker container default is 0.0.0.0 and people get really confused why things
v1.1.7,don't work
v1.1.7,By default this is the column header. Override it in BeginPlay of pawn mode
v1.1.7,Should be overridden by derived classes
v1.1.7,Should be overridden by derived classes
v1.1.7,Should be overridden by derived classes
v1.1.7,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,This assumes you are running DroneServer already on the same machine.
v1.1.7,DroneServer must be running first.
v1.1.7,enable API control
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,move commands
v1.1.7,else leave as it is
v1.1.7,TODO: get these in one call
v1.1.7,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.1.7,TODO: shouldn't we pass folder path?
v1.1.7,parse
v1.1.7,group the images by the current date.
v1.1.7,"std::string beforeScriptStartCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.7,{
v1.1.7,"return """";"
v1.1.7,}
v1.1.7,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.7,{
v1.1.7,return false;
v1.1.7,}
v1.1.7,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.1.7,params.context->client.newTask();
v1.1.7,}
v1.1.7,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.1.7,params.context->client.WaitForCompletion(0);
v1.1.7,}
v1.1.7,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.1.7,{
v1.1.7,}
v1.1.7,parse command line
v1.1.7,Shell callbacks
v1.1.7,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.7,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.7,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.7,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.7,Add shell commands
v1.1.7,TODO: add WaitForCompletion command
v1.1.7,"TODO: add command line args help, arg count validation"
v1.1.7,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.7,Licensed under the MIT License.
v1.1.7,switch to explicit hover mode so that this is the fallback when
v1.1.7,move* commands are finished.
v1.1.7,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.1.7,60 acres park:
v1.1.7,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.1.7,marymoore park
v1.1.7,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,read settings and override defaults
v1.1.6,allow json overrides on a per-vehicle basis.
v1.1.6,start server in async mode
v1.1.6,check messages
v1.1.6,basic flight control
v1.1.6,camera control
v1.1.6,simGetImage returns compressed png in array of bytes
v1.1.6,image_type uses one of the AirSimImageType members
v1.1.6,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.6,camera control
v1.1.6,simGetImage returns compressed png in array of bytes
v1.1.6,image_type uses one of the AirSimImageType members
v1.1.6,helper method for converting getOrientation to roll/pitch/yaw
v1.1.6,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.1.6,roll (x-axis rotation)
v1.1.6,pitch (y-axis rotation)
v1.1.6,yaw (z-axis rotation)
v1.1.6,DEY: I don't know why this was there.
v1.1.6,data = np.flipud(data)
v1.1.6,reverse the vertical line order and add null bytes at the start
v1.1.6,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.1.6,query vehicle state
v1.1.6,def getRCData(self):
v1.1.6,return self.client.call('getRCData')
v1.1.6,APIs for control
v1.1.6,-----------------------------------  Car APIs ---------------------------------------------
v1.1.6,Local variable access is faster in loops
v1.1.6,"if not wrapping over current pointer,"
v1.1.6,then check if there is terminal state wrapped inside
v1.1.6,"If index > history_length, take from a slice"
v1.1.6,Metrics accumulator
v1.1.6,Action Value model (used by agent to interact with the environment)
v1.1.6,"Target model used to compute the target Q-values in training, updated"
v1.1.6,less frequently for increased stability.
v1.1.6,Function computing Q-values targets as part of the computation graph
v1.1.6,"Define the loss, using Huber Loss (more robust to outliers)"
v1.1.6,Compute the q_targets
v1.1.6,actions is a 1-hot encoding of the action done by the agent
v1.1.6,Define training criterion as the Huber Loss function
v1.1.6,Adam based SGD
v1.1.6,Append the state to the short term memory (ie. History)
v1.1.6,"If policy requires agent to explore, sample random action"
v1.1.6,Use the network to output the best action
v1.1.6,Append batch axis with only one sample to evaluate
v1.1.6,Return the value maximizing the expected reward
v1.1.6,Keep track of interval action counter
v1.1.6,"If done, reset short term memory (ie. History)"
v1.1.6,Plot the metrics through Tensorboard and reset buffers
v1.1.6,Reset the short term memory
v1.1.6,Append to long term memory
v1.1.6,Update the Target Network if needed
v1.1.6,print(dist)
v1.1.6,connect to the AirSim simulator
v1.1.6,Make RL agent
v1.1.6,Train
v1.1.6,DEY: I don't know why this was there.
v1.1.6,data = np.flipud(data)
v1.1.6,In settings.json first activate computer vision mode:
v1.1.6,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.6,currently reset() doesn't work in CV mode. Below is the workaround
v1.1.6,connect to the AirSim simulator
v1.1.6,go forward
v1.1.6,get state of the car
v1.1.6,connect to the AirSim simulator
v1.1.6,get camera images from the car
v1.1.6,that's enough fun for now. let's quite cleanly
v1.1.6,Local variable access is faster in loops
v1.1.6,"if not wrapping over current pointer,"
v1.1.6,then check if there is terminal state wrapped inside
v1.1.6,"If index > history_length, take from a slice"
v1.1.6,Metrics accumulator
v1.1.6,Action Value model (used by agent to interact with the environment)
v1.1.6,"Target model used to compute the target Q-values in training, updated"
v1.1.6,less frequently for increased stability.
v1.1.6,Function computing Q-values targets as part of the computation graph
v1.1.6,"Define the loss, using Huber Loss (more robust to outliers)"
v1.1.6,Compute the q_targets
v1.1.6,actions is a 1-hot encoding of the action done by the agent
v1.1.6,Define training criterion as the Huber Loss function
v1.1.6,Adam based SGD
v1.1.6,self._trainer.restore_from_checkpoint('models/oldmodels/model800000')
v1.1.6,Append the state to the short term memory (ie. History)
v1.1.6,"If policy requires agent to explore, sample random action"
v1.1.6,Use the network to output the best action
v1.1.6,Append batch axis with only one sample to evaluate
v1.1.6,Return the value maximizing the expected reward
v1.1.6,Keep track of interval action counter
v1.1.6,"If done, reset short term memory (ie. History)"
v1.1.6,Plot the metrics through Tensorboard and reset buffers
v1.1.6,Reset the short term memory
v1.1.6,Append to long term memory
v1.1.6,Update the Target Network if needed
v1.1.6,print(dist)
v1.1.6,Make RL agent
v1.1.6,Train
v1.1.6,use open cv to show new images from AirSim
v1.1.6,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.6,pip install opencv-python
v1.1.6,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.6,use open cv to create point cloud from depth image.
v1.1.6,skip it
v1.1.6,AirSim uses NED coordinates so negative axis is up.
v1.1.6,z of -7 is 7 meters above the original launch point.
v1.1.6,Fly given velocity vector for 5 seconds
v1.1.6,using DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.1.6,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.1.6,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.1.6,AirSim uses NED coordinates so negative axis is up.
v1.1.6,z of -5 is 5 meters above the original launch point.
v1.1.6,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.1.6,this method is async and we are not waiting for the result since we are passing max_wait_seconds=0.
v1.1.6,connect to the AirSim simulator
v1.1.6,get state of the car
v1.1.6,go forward
v1.1.6,Go forward + steer right
v1.1.6,go reverse
v1.1.6,apply breaks
v1.1.6,get camera images from the car
v1.1.6,restore to original state
v1.1.6,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.6,pip install opencv-python
v1.1.6,In settings.json first activate computer vision mode:
v1.1.6,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.6,for block environment
v1.1.6,regex are case insensetive
v1.1.6,#for neighbourhood environment
v1.1.6,set object ID for sky
v1.1.6,below doesn't work yet. You must set CustomDepthStencilValue in Unreal Editor for now
v1.1.6,get segmentation image in various formats
v1.1.6,save segmentation images in various formats
v1.1.6,"AirSimClientBase.write_pfm(os.path.normpath(filename + '.pfm'), AirSimClientBase.getPfmArray(response))"
v1.1.6,"AirSimClientBase.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)"
v1.1.6,"AirSimClientBase.write_png(os.path.normpath(filename + '.numpy.png'), img_rgba) #write to png"
v1.1.6,find unique colors
v1.1.6,from keras.models import load_model
v1.1.6,if (len(sys.argv) != 2):
v1.1.6,print('usage: python drive.py <modelName>')
v1.1.6,sys.exit()
v1.1.6,print('Loading model...')
v1.1.6,model = load_model(sys.argv[1])
v1.1.6,connect to the AirSim simulator
v1.1.6,image_buf[0] = get_image()
v1.1.6,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.1.6,"model_output = model.predict([image_buf, state_buf])"
v1.1.6,car_controls.steering = float(model_output[0][0])
v1.1.6,use open cv to show new images from AirSim
v1.1.6,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.6,pip install opencv-python
v1.1.6,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.1.6,get depth image
v1.1.6,"this will return png width= 256, height= 144"
v1.1.6,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.1.6,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.1.6,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.1.6,to get an estimate of distance.
v1.1.6,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.1.6,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.1.6,an angular delta of the following pi/10.
v1.1.6,"in header only mode, control library is not available"
v1.1.6,if using Unreal Build system then include precompiled header file first
v1.1.6,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.6,"Windows, OSX and Linux."
v1.1.6,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.1.6,Windows users can move the Documents folder to any location they want
v1.1.6,SHGetFolderPath knows how to find it.
v1.1.6,fall back in case SHGetFolderPath failed for some reason.
v1.1.6,convert from std::path '/' to windows backslash.
v1.1.6,make the current thread run with maximum priority.
v1.1.6,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.1.6,TODO: How to handle POSIX thread priorities on OSX?
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.1.6,
v1.1.6,Treat all errors as failure conditions.
v1.1.6,parse command line
v1.1.6,"motive gives a weird error if the project is not found, so we look for it."
v1.1.6,Do an update to pick up any recently-arrived cameras.
v1.1.6,List all detected cameras.
v1.1.6,List all defined rigid bodies.
v1.1.6,throttle to 50 messages per second.
v1.1.6,OptiTrack uses 'y' axis for vertical.
v1.1.6,stdafx.cpp : source file that includes just the standard includes
v1.1.6,MavlinkMoCap.pch will be the pre-compiled header
v1.1.6,stdafx.obj will contain the pre-compiled type information
v1.1.6,TODO: reference any additional headers you need in STDAFX.H
v1.1.6,and not in this file
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,PX4.cpp : Defines the entry point for the console application.
v1.1.6,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.1.6,how do you write to the debug output windows on Unix ?
v1.1.6,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.1.6,connection to create to talke to that server.
v1.1.6,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.1.6,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.1.6,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.1.6,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.1.6,using their the -qgc option.
v1.1.6,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.1.6,this switch controls whether we turn off the RC remote active link loss detection
v1.1.6,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.1.6,from kicking in when you try and fly.
v1.1.6,can't use experimental stuff on Linux because of potential ABI issues
v1.1.6,parse the json
v1.1.6,flatten inner mavlink object
v1.1.6,flatten inner mavlink object
v1.1.6,todo
v1.1.6,todo
v1.1.6,"const char* outLogFileOption = ""outlogfile"";"
v1.1.6,parse command line
v1.1.6,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.1.6,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.1.6,"no local serial connection, so this is the primary droneConnection."
v1.1.6,failed to connect
v1.1.6,"local connection, then we own sending the heartbeat."
v1.1.6,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.1.6,cmdTable.push_back(new AltHoldCommand());
v1.1.6,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.1.6,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.1.6,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.1.6,this stops us from being able to connect to SITL mode PX4.
v1.1.6,checkPulse();
v1.1.6,add command text in log
v1.1.6,close previous command.
v1.1.6,FilterLogFiles(logDirectory);
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,send a heartbeat
v1.1.6,accept one incoming connection
v1.1.6,send a heartbeat to the client
v1.1.6,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.1.6,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.1.6,for this unit test we are expecting a request to send an image.
v1.1.6,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.1.6,hmmm
v1.1.6,================ ls
v1.1.6,================ put file
v1.1.6,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.1.6,================ get file
v1.1.6,verify the file contents.
v1.1.6,================ remove file
v1.1.6,================ make directory
v1.1.6,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.1.6,================ remove directory
v1.1.6,Now verification
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,from main.cpp.
v1.1.6,you must call this method if you want HandleMessage to be called subsequently.
v1.1.6,treat literals as one word
v1.1.6,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.6,request gps info
v1.1.6,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.1.6,find relative position since command start so we can compare two commands better
v1.1.6,TODO: make below future proof (i.e. usable by C++17 compiler) - also change same in main.cpp
v1.1.6,can't use experimental stuff on Linux because of potential ABI issues
v1.1.6,"these PID values are important, so set these to match"
v1.1.6,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.1.6,we can skip ahead.
v1.1.6,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.1.6,TODO: avoid passing hadcoded HIL flag
v1.1.6,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.1.6,"The global position, as returned by the Global Positioning System (GPS)."
v1.1.6,Provides state for additional features
v1.1.6,The general system state
v1.1.6,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.6,Provides state for additional features
v1.1.6,The general system state
v1.1.6,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.6,Provides state for additional features
v1.1.6,The general system state
v1.1.6,Provides state for additional features
v1.1.6,The general system state
v1.1.6,note: we do not reset com when Close() is called because we want to keep running.
v1.1.6,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.6,generate random between 0 and 1
v1.1.6,move to range -1 to 1
v1.1.6,scale it
v1.1.6,apply iy
v1.1.6,wait for the Execute method to be called.
v1.1.6,gps is much slower frequency than IMU.
v1.1.6,MAVLINK_MSG_ID_HIL_GPS
v1.1.6,disable MAV_USEHILGPS
v1.1.6,note: we do not reset com when Close() is called because we want to keep running.
v1.1.6,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.6,generate random between 0 and 1
v1.1.6,move to range -1 to 1
v1.1.6,scale it
v1.1.6,apply iy
v1.1.6,wait for the Execute method to be called.
v1.1.6,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.1.6,gps is much slower frequency than IMU.
v1.1.6,MAVLINK_MSG_ID_HIL_GPS
v1.1.6,disable HIL mode
v1.1.6,Enumeration of landed detector states
v1.1.6,MAV landed state is unknown
v1.1.6,MAV is landed (on ground)
v1.1.6,MAV is in air
v1.1.6,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.1.6,The filtered local position
v1.1.6,must send these regularly to keep offboard control.
v1.1.6,"ok, now we can safely switch to loiter."
v1.1.6,must send these regularly to keep offboard control.
v1.1.6,integrate the heading so it is smoother.
v1.1.6,must send these regularly to keep offboard control.
v1.1.6,integrate the heading so it is smoother.
v1.1.6,fly to radius
v1.1.6,it takes about 10 cm to stop and turn.
v1.1.6,next time around switch to orbiting!
v1.1.6,heading points to center of circle.
v1.1.6,interpoloate the speed ramp up time over 2 seconds from start time
v1.1.6,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.1.6,monitor the sin curves so we can see how on track or off track it actually is.
v1.1.6,the shape of the curve will also tell us if we are progressing at a consistent
v1.1.6,"speed, the more deformed the sin curve the worse our progress."
v1.1.6,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.1.6,degrees just flipped from 359 to 0.
v1.1.6,this enables us to test what happens when offboard control is lost and resumed.
v1.1.6,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.1.6,"ok, now we can start moving by velocity"
v1.1.6,recompute to new target.
v1.1.6,start by moving right with 10 degree roll.
v1.1.6,haven't started yet.
v1.1.6,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.1.6,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.1.6,track how our actual pitch is coming along compared to our target
v1.1.6,and check position
v1.1.6,the amount of pitch should depend on our speed in that direction.
v1.1.6,passed the midpoint.
v1.1.6,fade out the pitch as we pick up speed so we don't overshoot.
v1.1.6,see if we just crossed the wiggle distance threshold.
v1.1.6,(pitch affects the x-position).
v1.1.6,reverse direction with a -30 degrees quick stop
v1.1.6,reverse direction with a 30 degrees quick stop
v1.1.6,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.1.6,too much in that direction.
v1.1.6,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.6,track how our actual roll is coming along compared to our target
v1.1.6,and check position
v1.1.6,the amount of roll should depend on our speed in that direction.
v1.1.6,passed the midpoint.
v1.1.6,fade out the roll as we pick up speed so we don't overshoot.
v1.1.6,see if we just crossed the wiggle distance threshold.
v1.1.6,(roll affects the y-position).
v1.1.6,reverse direction with a -30 degrees quick stop
v1.1.6,reverse direction with a 30 degrees quick stop
v1.1.6,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.1.6,too much in that direction.
v1.1.6,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.6,for testing PID controller.
v1.1.6,class AltHoldCommand : public Command
v1.1.6,{
v1.1.6,std::shared_ptr<MavLinkVehicle> channel;
v1.1.6,"float sx_, sy_, sz_;"
v1.1.6,MavLinkAttitudeTarget _current;
v1.1.6,PidController thrust_controller_;
v1.1.6,public:
v1.1.6,this->sz_ = pos.z; // user defined target.
v1.1.6,move to local position keeps the offboard control happy.
v1.1.6,haven't started yet.
v1.1.6,and check position
v1.1.6,double dx = this->sx_ - pos.x;
v1.1.6,double dy = this->sy_ - pos.y;
v1.1.6,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.1.6,too much in that direction.
v1.1.6,adjust thrust so we keep steady height target
v1.1.6,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.6,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.1.6,local remote
v1.1.6,already handled by the parse method.
v1.1.6,we only support very simple patterns for now.
v1.1.6,each wildcard must be separated by literal.
v1.1.6,back to back wildcards with no literal in between is too complex.
v1.1.6,"we only support simple matching for now, we can add full regex later if we need it."
v1.1.6,yep!
v1.1.6,'*' is done we found the next matching char
v1.1.6,this is ok.
v1.1.6,this is an ERASE_END_LINE command which we ignore.
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,unpack the message...
v1.1.6,pack the payload buffer.
v1.1.6,"json can't handle ""nan"", so we convert it to null."
v1.1.6,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.1.6,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,start listening to this connection
v1.1.6,Send heartbeat to drone.  You should not do this if some other node is
v1.1.6,already doing it.
v1.1.6,stop listening to the connection.
v1.1.6,get the connection
v1.1.6,Get the local system and component id
v1.1.6,send a command to the remote node
v1.1.6,MavLinkNode::MavLinkNode() = default;
v1.1.6,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.1.6,decrementing the count so the next WaitOne may block.
v1.1.6,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.1.6,convert to absolute time.
v1.1.6,use mach_timespec
v1.1.6,convert to absolute time.
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,return true if we still have offboard control (can lose this if user flips the switch).
v1.1.6,MavLinkVehicle::MavLinkVehicle() = default;
v1.1.6,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.1.6,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,============================== CLIENT ============================================
v1.1.6,image APIs
v1.1.6,or if you are implementing the client side call this function to get the most recent frame.
v1.1.6,returns false if there is no new frame available.
v1.1.6,============================== SERVER ============================================
v1.1.6,call this to send the image back over the connection given to start function.
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,"log every message that is ""sent"" using sendMessage."
v1.1.6,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.1.6,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.1.6,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.1.6,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,for compatibility with QGroundControl we have to save the time field in big endian.
v1.1.6,todo: mavlink2 support?
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,start listening to this connection
v1.1.6,Send heartbeat to drone.  You should not do this if some other node is
v1.1.6,already doing it.
v1.1.6,send a heart beat so that the remote node knows we are still alive
v1.1.6,(otherwise drone will trigger a failsafe operation).
v1.1.6,this is called for all messages received on the connection.
v1.1.6,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.1.6,subclasses remembering to call this base implementation.
v1.1.6,stop listening to the connection.
v1.1.6,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.6,wait for a heartbeat msg since this will give us the port to send commands to...
v1.1.6,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.1.6,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.6,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.6,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.6,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.6,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.6,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.6,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.1.6,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.1.6,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.1.6,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.1.6,"ok, now fetch the missing parameters."
v1.1.6,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.1.6,silently fail since we are on a background thread here...
v1.1.6,tell the caller this is complete.
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,add our custom telemetry message length.
v1.1.6,todo: if we support signing then initialize
v1.1.6,mavlink_intermediate_status_.signing callbacks
v1.1.6,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.1.6,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.6,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.6,send this right away just in case serial link is not already configured
v1.1.6,"log every message that is ""sent"" using sendMessage."
v1.1.6,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.1.6,pack the payload buffer.
v1.1.6,calculate checksum
v1.1.6,form the header as a byte array for the crc
v1.1.6,these macros use old style cast.
v1.1.6,forward messages from our connected node to the remote proxy.
v1.1.6,forward messages from remote proxy to local connected node
v1.1.6,CurrentThread::setMaximumPriority();
v1.1.6,"hmmm, wait till it is opened?"
v1.1.6,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.1.6,pick up the sysid/compid of the remote node we are connected to.
v1.1.6,then this is a mavlink 1 message
v1.1.6,then this mavlink sender supports mavlink 2
v1.1.6,queue event for publishing.
v1.1.6,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.1.6,as it ensures we don't lose messages if the listener is slow.
v1.1.6,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.1.6,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.1.6,we would get a deadlock.
v1.1.6,CurrentThread::setMaximumPriority();
v1.1.6,reset counters
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,------------------------------------------------------------------------------
v1.1.6,Defines
v1.1.6,------------------------------------------------------------------------------
v1.1.6,bit number  876543210987654321
v1.1.6,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.1.6,in future it would be good to have ability to add system IDs we are interested in
v1.1.6,if (msg.sysid != getTargetSystemId())
v1.1.6,{
v1.1.6,// we only care about messages from our intended remote node.
v1.1.6,return;
v1.1.6,}
v1.1.6,user may have changed modes on us! So we need to honor that and not
v1.1.6,try and take it back.
v1.1.6,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.1.6,we can store up to 16 channels in rc_channels_scaled.
v1.1.6,The RAW values of the servo outputs
v1.1.6,Metrics typically displayed on a HUD for fixed wing aircraft
v1.1.6,The IMU readings in SI units in NED body frame
v1.1.6,printSystemStatus(&msg);
v1.1.6,todo: use this to determine when we need to do emergency landing...
v1.1.6,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.1.6,Provides state for additional features
v1.1.6,The general system state
v1.1.6,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.1.6,but we do want to know when we get the ack.  So this is async ACK processing!
v1.1.6,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.1.6,if threshold < 0 then the threshold is inverted.
v1.1.6,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.1.6,Convert it to a floating point number between -1 and 1.
v1.1.6,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.1.6,until the move commands start happening.
v1.1.6,return true if user calls requestControl and has not called releaseControl.
v1.1.6,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.1.6,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.1.6,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.1.6,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.1.6,send a few to make sure it gets through...
v1.1.6,now the command should succeed.
v1.1.6,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.1.6,us by which time the PX4 times out offboard mode!!
v1.1.6,this mode change take precedence over offboard mode.
v1.1.6,thrust must be between -1 and 1.
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,These definitions are copied from PX4 implementation
v1.1.6,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.1.6,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.1.6,/ @brief Command opcodes
v1.1.6,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.1.6,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.6,must trim trailing slashes so PX4 doesn't hang!
v1.1.6,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.1.6,from the source.
v1.1.6,check if directory exists.
v1.1.6,perfect.
v1.1.6,use last_message_ so we preserve the sessionid.
v1.1.6,"could not create the local file, so stop."
v1.1.6,must use last_message_ so we preserve the session id.
v1.1.6,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.1.6,todo: error handling here? sequence is out of order...
v1.1.6,"directory must be empty then, can't do nextStep because"
v1.1.6,it will just loop for ever re-requesting zero offset into
v1.1.6,empty directory.
v1.1.6,result should be a list of null terminated file names.
v1.1.6,skipping this entry
v1.1.6,remove the file size field.
v1.1.6,"printf(""%s\n"", name.c_str());"
v1.1.6,request the next batch.
v1.1.6,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.6,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.6,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.1.6,reached the end of the list or the file.
v1.1.6,end of file or directory listing.
v1.1.6,"success, data should be following..."
v1.1.6,ack on this cmd is a noop
v1.1.6,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.1.6,give up then.
v1.1.6,tell watchdog we are sending a request
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,================================= CLIENT ==============================================================
v1.1.6,Check if we have a valid transaction
v1.1.6,emit signal if all packets arrived
v1.1.6,Restart statemachine
v1.1.6,image APIs
v1.1.6,================================= SERVER ==============================================================
v1.1.6,Prepare and send acknowledgment packet
v1.1.6,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.1.6,Send ENCAPSULATED_IMAGE packet
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.1.6,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.6,parse out the VID number
v1.1.6,now the PID
v1.1.6,parse out the VID number
v1.1.6,examples:
v1.1.6,PX4: USB\VID_26AC&PID_0011\0
v1.1.6,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.1.6,"printf(""Found: %S\n"", buffer.c_str());"
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.6,parse out the VID number
v1.1.6,now the PID
v1.1.6,parse out the VID number
v1.1.6,suppress
v1.1.6,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,This has not been properly tested
v1.1.6,struct iw_statistics stats;
v1.1.6,struct iwreq req;
v1.1.6,"memset(&stats, 0, sizeof(stats));"
v1.1.6,"memset(&req, 0, sizeof(iwreq));"
v1.1.6,
v1.1.6,"strncpy(req.ifr_name, ifaceName, 16);"
v1.1.6,req.u.data.pointer = &stats;
v1.1.6,req.u.data.length = sizeof(iw_statistics);
v1.1.6,
v1.1.6,#ifdef CLEAR_UPDATED
v1.1.6,req.u.data.flags = 1;
v1.1.6,#endif
v1.1.6,
v1.1.6,/* Perform the ioctl */
v1.1.6,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.1.6,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.1.6,return -127;
v1.1.6,}
v1.1.6,
v1.1.6,return stats.qual.level;
v1.1.6,todo: windows version of this...
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,windows
v1.1.6,Need to link with Ws2_32.lib
v1.1.6,posix
v1.1.6,found it!
v1.1.6,bind socket to local address.
v1.1.6,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.1.6,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.1.6,write to the serial port
v1.1.6,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.1.6,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.1.6,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.1.6,"try and receive something, up until port is closed anyway."
v1.1.6,"message was too large for the buffer, no problem, return what we have."
v1.1.6,try again - this can happen if server recreates the socket on their side.
v1.1.6,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.6,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.6,try again - this can happen if server recreates the socket on their side.
v1.1.6,"printf(""#### recv failed with error: %d\n"", hr);"
v1.1.6,we now have it.
v1.1.6,this is from someone we are not interested in.
v1.1.6,"printf(""Connection closed\n"");"
v1.1.6,-----------------------------------------------------------------------------------------
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,Initialize Winsock
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,windows
v1.1.6,Need to link with Ws2_32.lib
v1.1.6,posix
v1.1.6,found it!
v1.1.6,bind socket to local address.
v1.1.6,bind socket to local address.
v1.1.6,start listening for incoming connection
v1.1.6,accept 1
v1.1.6,write to the serial port
v1.1.6,"try and receive something, up until port is closed anyway."
v1.1.6,"message was too large for the buffer, no problem, return what we have."
v1.1.6,try again - this can happen if server recreates the socket on their side.
v1.1.6,"skip this, it is was interrupted."
v1.1.6,"printf(""Connection closed\n"");"
v1.1.6,-----------------------------------------------------------------------------------------
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.1.6,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.1.6,set signal
v1.1.6,Clear Handshake flags
v1.1.6,Set Handshake flags
v1.1.6,return GetLastError();
v1.1.6,return GetLastError();
v1.1.6,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.6,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.1.6,enable reading
v1.1.6,posix doesn't have mark/space parity.
v1.1.6,posix doesn't have mark/space parity.
v1.1.6,this is the default.
v1.1.6,not sure this is supported...
v1.1.6,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.1.6,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.6,First do those specified by POSIX.
v1.1.6,Now conditionally handle a bunch of extended rates.
v1.1.6,First do those specified by POSIX.
v1.1.6,Now conditionally handle a bunch of extended rates.
v1.1.6,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.6,","
v1.1.6,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.1.6,"std::unique_ptr<TestBase>(new RosFlightTest()),"
v1.1.6,"std::unique_ptr<TestBase>(new QuaternionTest()),"
v1.1.6,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,"in header only mode, control library is not available"
v1.1.6,TODO: something defines max macro which interfears with code here
v1.1.6,is cur_pos within fence?
v1.1.6,destination risk is not available then consider it zero
v1.1.6,if dest risk is lower than its more safe
v1.1.6,are we doing better than closest obstacle?
v1.1.6,"if we stay where we are, what is the risk distance?"
v1.1.6,else we are better of moving to dest
v1.1.6,this function should work even when dest_pos == cur_pos
v1.1.6,is this dest_pos cur_pos within the fence?
v1.1.6,transform dest_pos vector to body frame
v1.1.6,check for approx zero vectors to avoid random yaw angles
v1.1.6,we are hovering
v1.1.6,"get yaw in body frame, ie, front is always 0 radians"
v1.1.6,yaw to ticks
v1.1.6,get obstacles in the window at the tick direction around the window
v1.1.6,less risk distance is better
v1.1.6,check obstacles around current position and see if it has lower risk
v1.1.6,else obstacle is too far
v1.1.6,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.1.6,look for each surrounding tick to see if we have obstacle free angle
v1.1.6,else no suggestions required
v1.1.6,"3.2 comes from inverse CDF for epsilone = 0.05 (i.e. 95% confidence), author: akapoor"
v1.1.6,evaluate right and left side of circle
v1.1.6,find right and left risk distances
v1.1.6,at this point we have already determined hover is better than going to dest
v1.1.6,we now determine is moving to suggested angle better than hovering?
v1.1.6,check if dest_pos is safe
v1.1.6,breaking distance at this velocity
v1.1.6,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.1.6,check if dest_pos is safe
v1.1.6,float/vec parameters can have NaN which makes them optional
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,"in header only mode, control library is not available"
v1.1.6,handles +/- tick and wraps around circle
v1.1.6,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.1.6,update the specified window on the map
v1.1.6,make dure from <= to
v1.1.6,normalize the ticks so bothe are valid indices
v1.1.6,if from is still larger then
v1.1.6,to ticks is then added one full circle to make it larger than from_tick
v1.1.6,find closest obstacle in given window
v1.1.6,search whole map to find closest obstacle
v1.1.6,"in header only mode, control library is not available"
v1.1.6,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.6,"Windows, OSX and Linux."
v1.1.6,Windows users can move the Documents folder to any location they want
v1.1.6,SHGetFolderPath knows how to find it.
v1.1.6,fall back in case SHGetFolderPath failed for some reason.
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,"in header only mode, control library is not available"
v1.1.6,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.6,if using Unreal Build system then include precompiled header file first
v1.1.6,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.6,#undef check
v1.1.6,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.6,sim only
v1.1.6,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.6,required for pimpl
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,"in header only mode, control library is not available"
v1.1.6,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.6,if using Unreal Build system then include precompiled header file first
v1.1.6,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.1.6,sim only
v1.1.6,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.6,make sure we can talk to the DroneServer
v1.1.6,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.1.6,command_context.client.ping();
v1.1.6,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,"in header only mode, control library is not available"
v1.1.6,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.6,if using Unreal Build system then include precompiled header file first
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,"in header only mode, control library is not available"
v1.1.6,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.6,if using Unreal Build system then include precompiled header file first
v1.1.6,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.6,#undef check
v1.1.6,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.6,required for pimpl
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,"in header only mode, control library is not available"
v1.1.6,if auto mode requested for lookahead then calculate based on velocity
v1.1.6,no-op by default. derived class can override it if needed
v1.1.6,no-op by default. derived class can override it if needed
v1.1.6,validate path size
v1.1.6,validate yaw mode
v1.1.6,validate and set auto-lookahead value
v1.1.6,if auto mode requested for lookahead then calculate based on velocity
v1.1.6,add current position as starting point
v1.1.6,append the input path and compute segments
v1.1.6,add last segment as zero length segment so we have equal number of segments and points.
v1.1.6,path_segs[i] refers to segment that starts at point i
v1.1.6,"when path ends, we want to slow down"
v1.1.6,else no need to change velocities for last segments
v1.1.6,setup current position on path to 0 offset
v1.1.6,initialize next path position
v1.1.6,until we are at the end of the path (last seg is always zero size)
v1.1.6,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.1.6,send drone command to get to next lookahead
v1.1.6,sleep for rest of the cycle
v1.1.6,how much have we moved towards last goal?
v1.1.6,project actual vector on goal vector
v1.1.6,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.1.6,TODO: below should be lower than 1E3 and configurable
v1.1.6,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.1.6,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.1.6,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.1.6,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.1.6,"if drone moved backward, we don't want goal to move backward as well"
v1.1.6,"so only climb forward on the path, never back. Also note >= which means"
v1.1.6,we climb path even if distance was 0 to take care of duplicated points on path
v1.1.6,else
v1.1.6,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.1.6,compute next target on path
v1.1.6,last command is to hold on to position
v1.1.6,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.1.6,default strategy is for move. In hover mode we set new strategy temporarily
v1.1.6,freeze the quaternion
v1.1.6,get trims
v1.1.6,take average
v1.1.6,convert RC commands to velocity vector
v1.1.6,find yaw as per terrain and remote setting
v1.1.6,execute command
v1.1.6,Only raise exception is time out occurred. If preempted then return status.
v1.1.6,are we supposed to do EM?
v1.1.6,get suggested velocity vector
v1.1.6,use the unchecked command
v1.1.6,tell caller not to execute planned command
v1.1.6,other wise throw exception
v1.1.6,otherwise there is some other reason why we are in unsafe situation
v1.1.6,send last command to come to full stop
v1.1.6,else no unsafe situation
v1.1.6,note: cur_path_loc and next_path_loc may both point to same object
v1.1.6,"otherwise use up this segment, move on to next one"
v1.1.6,if we are here then we ran out of segments
v1.1.6,consider last segment as zero length segment
v1.1.6,adjust yaw for the direction of travel in foward-only mode
v1.1.6,else no adjustment needed
v1.1.6,validate dest
v1.1.6,what is the distance we will travel at this velocity?
v1.1.6,get velocity vector
v1.1.6,yaw for the direction of travel
v1.1.6,find velocity vector
v1.1.6,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.1.6,generate velocity vector that is same size as cur_dest_norm / command period
v1.1.6,this velocity vect when executed for command period would yield cur_dest_norm
v1.1.6,send commands
v1.1.6,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.1.6,by default indicate that we don't have alternative pose info
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,"in header only mode, control library is not available"
v1.1.6,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.6,if using Unreal Build system then include precompiled header file first
v1.1.6,status getters
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,"in header only mode, control library is not available"
v1.1.6,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.6,if using Unreal Build system then include precompiled header file first
v1.1.6,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.6,#undef check
v1.1.6,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.6,getters
v1.1.6,required for pimpl
v1.1.6,Create a spring arm component for our chase camera
v1.1.6,do nothing
v1.1.6,set initial view mode
v1.1.6,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.1.6,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.1.6,"If the lag is missing, the camera will also occasionally shake."
v1.1.6,"But, lag is not desired when piloting a drone"
v1.1.6,attach spring arm to actor
v1.1.6,remember current parent for external camera. Later when we remove external
v1.1.6,"camera from spring arm, we will attach it back to its last parent"
v1.1.6,now attach camera to spring arm
v1.1.6,"For car, we need to move the camera back a little more than for a drone."
v1.1.6,"Otherwise, the camera will be stuck inside the car"
v1.1.6,external_camera_->bUsePawnControlRotation = false;
v1.1.6,if prev mode was spring arm but new mode isn't then detach spring arm
v1.1.6,"else someone else is bound to manual pose controller, leave it alone"
v1.1.6,TODO: explore screenshot option
v1.1.6,addScreenCaptureHandler(camera->GetWorld());
v1.1.6,Wait for render so that view is ready for capture
v1.1.6,not sure why this doesn't work.
v1.1.6,"DECLARE_CYCLE_STAT(TEXT(""FNullGraphTask.CheckRenderStatus""), STAT_FNullGraphTask_CheckRenderStatus, STATGROUP_TaskGraphTasks);"
v1.1.6,"auto renderStatus = TGraphTask<FNullGraphTask>::CreateTask(NULL).ConstructAndDispatchWhenReady(GET_STATID(STAT_FNullGraphTask_CheckRenderStatus), ENamedThreads::RenderThread);"
v1.1.6,FTaskGraphInterface::Get().WaitUntilTaskCompletes(renderStatus);
v1.1.6,Make sure that all alpha values are opaque.
v1.1.6,Deflect along the surface when we collide.
v1.1.6,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.1.6,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.1.6,set up key variables
v1.1.6,initialize state
v1.1.6,should be overridden in derived class
v1.1.6,should be overridden in derived class
v1.1.6,TODO: delete below
v1.1.6,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.6,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.6,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.6,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.6,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.1.6,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.6,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.1.6,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.6,parameters in NED frame
v1.1.6,translate to new VehiclePawnWrapper position & orientation from NED to NEU
v1.1.6,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.1.6,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.1.6,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.1.6,checked at the start of next tick
v1.1.6,allow teleportation
v1.1.6,if collisions are not enabled
v1.1.6,or we have collided but passthrough is enabled
v1.1.6,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.1.6,"without flip flopping, collisions can't be detected"
v1.1.6,set default for brigher images
v1.1.6,by default all image types are disabled
v1.1.6,use final color for all calculations
v1.1.6,use final color for all calculations
v1.1.6,else we will set this after this components get created
v1.1.6,else we will set this after this components get created
v1.1.6,do not make unnecessory calls to Activate() which otherwise causes crash in Unreal
v1.1.6,else nothing to enable
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,"#include ""Runtime/Foliage/Public/FoliageType.h"""
v1.1.6,TODO: change naming conventions to same as other files?
v1.1.6,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.1.6,common_utils::Utils::DebugBreak();
v1.1.6,mesh->SetVisibility(false);
v1.1.6,mesh->SetVisibility(true);
v1.1.6,for (TObjectIterator<UFoliageType> comp; comp; ++comp)
v1.1.6,{
v1.1.6,InitializeObjectStencilID(*comp);
v1.1.6,}
v1.1.6,Access the subclass instance with the * or -> operators.
v1.1.6,can we see followee?
v1.1.6,remove mapping
v1.1.6,removing binding
v1.1.6,"TODO: can't do remove because there is no ""stamp"" on who established binding"
v1.1.6,removeInputBindings();
v1.1.6,#ifdef _MSC_VER
v1.1.6,//print to VS output window
v1.1.6,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.1.6,#endif
v1.1.6,also do default logging
v1.1.6,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.1.6,UGameUserSettings* game_settings = GetGameUserSettings();
v1.1.6,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.1.6,game_settings->ApplySettings(true);
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,plugin startup
v1.1.6,plugin shutdown
v1.1.6,"read pixels from render target using render thread, then compress the result into PNG"
v1.1.6,argument on the thread that calls this method.
v1.1.6,make sure we are not on the rendering thread
v1.1.6,TODO: below doesn't work right now because it must be running in game thread
v1.1.6,below is documented method but more expensive because it forces flush
v1.1.6,wait for render thread to pick up our task
v1.1.6,Queue up the task of rendering the scene in the render thread
v1.1.6,wait for this task to complete
v1.1.6,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.1.6,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.1.6,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.1.6,Stuff to filter out XInput devices
v1.1.6,-----------------------------------------------------------------------------
v1.1.6,"Defines, constants, and global variables"
v1.1.6,-----------------------------------------------------------------------------
v1.1.6,Register with the DirectInput subsystem and get a pointer
v1.1.6,to a IDirectInput interface we can use.
v1.1.6,Create a DInput object
v1.1.6,Look for a simple joystick we can use for this sample program.
v1.1.6,Make sure we got a joystick
v1.1.6,"Set the data format to ""simple joystick"" - a predefined data format"
v1.1.6,
v1.1.6,"A data format specifies which controls on a device we are interested in,"
v1.1.6,and how they should be reported. This tells DInput that we will be
v1.1.6,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.1.6,Set the cooperative level to let DInput know how this device should
v1.1.6,interact with the system and with other DInput applications.
v1.1.6,Enumerate the joystick objects. The callback function enabled user
v1.1.6,"interface elements for objects that are found, and sets the min/max"
v1.1.6,values property for discovered axes.
v1.1.6,-----------------------------------------------------------------------------
v1.1.6,Enum each PNP device using WMI and check each device ID to see if it contains
v1.1.6,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then its an XInput device"
v1.1.6,Unfortunately this information can not be found by just using DirectInput.
v1.1.6,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.1.6,XInput devices.
v1.1.6,
v1.1.6,This function stores the list of xinput devices in a linked list
v1.1.6,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.1.6,-----------------------------------------------------------------------------
v1.1.6,CoInit if needed
v1.1.6,Create WMI
v1.1.6,Create BSTRs for WMI
v1.1.6,Connect to WMI
v1.1.6,Switch security level to IMPERSONATE
v1.1.6,Get list of Win32_PNPEntity devices
v1.1.6,Loop over all devices
v1.1.6,Get 20 at a time
v1.1.6,"For each device, get its device ID"
v1.1.6,"Check if the device ID contains ""IG_"".  If it does, then its an XInput device"
v1.1.6,Unfortunately this information can not be found by just using DirectInput
v1.1.6,"If it does, then get the VID/PID from var.bstrVal"
v1.1.6,Add the VID/PID to a linked list
v1.1.6,-----------------------------------------------------------------------------
v1.1.6,Returns true if the DirectInput device is also an XInput device.
v1.1.6,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.1.6,-----------------------------------------------------------------------------
v1.1.6,Check each xinput device to see if this device's vid/pid matches
v1.1.6,-----------------------------------------------------------------------------
v1.1.6,Cleanup needed for IsXInputDevice()
v1.1.6,-----------------------------------------------------------------------------
v1.1.6,Cleanup linked list
v1.1.6,-----------------------------------------------------------------------------
v1.1.6,Name: EnumJoysticksCallback()
v1.1.6,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.1.6,device interface on it so we can play with it.
v1.1.6,-----------------------------------------------------------------------------
v1.1.6,Skip anything other than the perferred joystick device as defined by the control panel.
v1.1.6,Instead you could store all the enumerated joysticks and let the user pick.
v1.1.6,Obtain an interface to the enumerated joystick.
v1.1.6,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.1.6,it while we were in the middle of enumerating it.)
v1.1.6,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.1.6,could store all the enumerated joysticks and let the user pick.
v1.1.6,-----------------------------------------------------------------------------
v1.1.6,Name: EnumObjectsCallback()
v1.1.6,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.1.6,joystick. This function enables user interface elements for objects
v1.1.6,"that are found to exist, and scales axes min/max values."
v1.1.6,-----------------------------------------------------------------------------
v1.1.6,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.1.6,enumerated axis in order to scale min/max values.
v1.1.6,Set the range for the axis
v1.1.6,Set the UI to reflect what objects the joystick supports
v1.1.6,-----------------------------------------------------------------------------
v1.1.6,Name: UpdateInputState()
v1.1.6,Desc: Get the input device's state and display it.
v1.1.6,-----------------------------------------------------------------------------
v1.1.6,Poll the device to read the current state
v1.1.6,DInput is telling us that the input stream has been
v1.1.6,"interrupted. We aren't tracking any state between polls, so"
v1.1.6,we don't have any special reset that needs to be done. We
v1.1.6,just re-acquire and try again.
v1.1.6,while (hr == DIERR_INPUTLOST)
v1.1.6,hr = g_pJoystick->Acquire();
v1.1.6,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.1.6,may occur when the app is minimized or in the process of
v1.1.6,"switching, so just try again later"
v1.1.6,Get the input's device state
v1.1.6,Axes
v1.1.6,Slider controls
v1.1.6,Points of view
v1.1.6,Buttons
v1.1.6,-----------------------------------------------------------------------------
v1.1.6,Name: FreeDirectInput()
v1.1.6,Desc: Initialize the DirectInput variables.
v1.1.6,-----------------------------------------------------------------------------
v1.1.6,Unacquire the device one last time just in case
v1.1.6,the app tried to exit while the device is still acquired.
v1.1.6,Release any DirectInput objects.
v1.1.6,nop
v1.1.6,normalize min to max --> 0 to 1
v1.1.6,normalize 0 to 1 --> -1 to 1
v1.1.6,#include <libudev.h>
v1.1.6,implementation for unsupported OS
v1.1.6,if this is new indec
v1.1.6,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.1.6,close previos one
v1.1.6,open new device
v1.1.6,if open was sucessfull
v1.1.6,read the device
v1.1.6,if we didn't had valid read
v1.1.6,"NOTE if this condition is not met, we're probably out of sync and this"
v1.1.6,Joystick instance is likely unusable
v1.1.6,TODO: set below to false?
v1.1.6,state.is_valid = false;
v1.1.6,else ignore
v1.1.6,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.1.6,{
v1.1.6,"manufacturerID = productID = """";"
v1.1.6,// Use udev to look up the product and manufacturer IDs
v1.1.6,struct udev *udev = udev_new();
v1.1.6,if (udev) {
v1.1.6,char sysname[32];
v1.1.6,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.1.6,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.1.6,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.1.6,if (!dev)
v1.1.6,{
v1.1.6,"message = ""Unable to find parent USB device"";"
v1.1.6,return false;
v1.1.6,}
v1.1.6,std::stringstream ss;
v1.1.6,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.1.6,ss >> manufacturerID;
v1.1.6,ss.clear();
v1.1.6,"ss.str("""");"
v1.1.6,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.1.6,ss >> productID;
v1.1.6,udev_device_unref(dev);
v1.1.6,}
v1.1.6,else
v1.1.6,{
v1.1.6,"message = ""Cannot create udev"";"
v1.1.6,return false;
v1.1.6,}
v1.1.6,udev_unref(udev);
v1.1.6,return true;
v1.1.6,}
v1.1.6,required for pimpl
v1.1.6,TODO: should we only do below on SceneCapture2D components and cameras?
v1.1.6,avoid motion blur so capture images don't get
v1.1.6,use two different methods to set console var because sometime it doesn't seem to work
v1.1.6,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.1.6,create main widget
v1.1.6,synchronize PIP views
v1.1.6,setup defaults
v1.1.6,TODO: should this be done somewhere else?
v1.1.6,load settings file if found
v1.1.6,create default settings
v1.1.6,"write some settings in new file otherwise the string ""null"" is written if all settigs are empty"
v1.1.6,TODO: there is a crash in Linux due to settings.saveJSonString(). Remove this workaround after we only support Unreal 4.17
v1.1.6,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.1.6,create its control server
v1.1.6,stop physics thread before we dismental
v1.1.6,for (AActor* actor : spawned_actors_) {
v1.1.6,actor->Destroy();
v1.1.6,}
v1.1.6,get player controller
v1.1.6,put camera little bit above vehicle
v1.1.6,we will either find external camera if it already exist in evironment or create one
v1.1.6,find all BP camera directors in the environment
v1.1.6,create director
v1.1.6,create external camera required for the director
v1.1.6,find all vehicle pawns
v1.1.6,if no vehicle pawns exists in environment
v1.1.6,create vehicle pawn
v1.1.6,set up vehicle pawns
v1.1.6,initialize each vehicle pawn we found
v1.1.6,chose first pawn as FPV if none is designated as FPV
v1.1.6,now create the connector for each pawn
v1.1.6,else we don't have vehicle for this pawn
v1.1.6,TODO: because this bug we are using alternative code with stringstream
v1.1.6,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.1.6,std::stringstream ss;
v1.1.6,"ss << timestamp_millis << ""\t"";"
v1.1.6,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.1.6,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.1.6,"ss << ""\n"";"
v1.1.6,return ss.str();
v1.1.6,find vehicles and cameras available in environment
v1.1.6,if none available then we will create one
v1.1.6,get references of components so we can use later
v1.1.6,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.1.6,-1 to 1 --> 0 to 1
v1.1.6,convert 0 to 1 -> -1 to 1
v1.1.6,TODO: add fields for z axis?
v1.1.6,last 8 bits are not used for now
v1.1.6,TODO: should below be at controller level info?
v1.1.6,else don't waste time
v1.1.6,"Utils::log(""------Render tick-------"");"
v1.1.6,move collision info from rendering engine to vehicle
v1.1.6,update ground level
v1.1.6,update rotor poses
v1.1.6,update rotor animations
v1.1.6,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response_info.collision_count_raw), LogDebugLevel::Unimportant);"
v1.1.6,*** Start: UpdatableState implementation ***//
v1.1.6,TODO: should this be done in MultiRotor.hpp
v1.1.6,controller_->reset();
v1.1.6,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.1.6,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.1.6,*** End: UpdatableState implementation ***//
v1.1.6,"If render command is complete, save image along with position and orientation"
v1.1.6,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.1.6,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.1.6,make sire all vars are set up
v1.1.6,"todo: should we go as fast as possible, or should we limit this to a particular number of"
v1.1.6,frames per second?
v1.1.6,"UAirBlueprintLib::LogMessage(TEXT(""Stopped recording thread""), TEXT(""""), LogDebugLevel::Success);"
v1.1.6,Try to find the high polycount vehicle
v1.1.6,"If not found, spawn the default class (go-kart)"
v1.1.6,Timestamp \t Speed \t Throttle \t Steering \t Brake \t gear \t ImageName
v1.1.6,get player controller
v1.1.6,put camera little bit above vehicle
v1.1.6,we will either find external camera if it already exist in evironment or create one
v1.1.6,find all BP camera directors in the environment
v1.1.6,create director
v1.1.6,create external camera required for the director
v1.1.6,find all vehicle pawns
v1.1.6,if no vehicle pawns exists in environment
v1.1.6,create vehicle pawn
v1.1.6,set up vehicle pawns
v1.1.6,initialize each vehicle pawn we found
v1.1.6,chose first pawn as FPV if none is designated as FPV
v1.1.6,find vehicles and cameras available in environment
v1.1.6,if none available then we will create one
v1.1.6,find all vehicle pawns
v1.1.6,set up vehicle pawns
v1.1.6,initialize each vehicle pawn we found
v1.1.6,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.6,Setup suspension forces
v1.1.6,Find the tire object and set the data for it
v1.1.6,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.6,Setup suspension forces
v1.1.6,Find the tire object and set the data for it
v1.1.6,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.6,Needed for VR Headset
v1.1.6,this->AutoReceiveInput = EAutoReceiveInput::Player0;
v1.1.6,Car mesh
v1.1.6,Setup friction materials
v1.1.6,Wheels/Tyres
v1.1.6,Setup the wheels
v1.1.6,Adjust the tire loading
v1.1.6,Engine
v1.1.6,Torque setup
v1.1.6,Adjust the steering
v1.1.6,Transmission
v1.1.6,We want 4wd
v1.1.6,Drive the front wheels a little more than the rear
v1.1.6,Automatic gearbox
v1.1.6,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.1.6,Physics settings
v1.1.6,Adjust the center of mass - the buggy is quite low
v1.1.6,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.1.6,Create In-Car camera component
v1.1.6,In car HUD
v1.1.6,Create text render component for in car speed display
v1.1.6,Create text render component for in car gear display
v1.1.6,Setup the audio component and allocate it a sound cue
v1.1.6,Colors for the in-car gear display. One for normal one for reverse
v1.1.6,put camera little bit above vehicle
v1.1.6,below is not needed
v1.1.6,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::OnReversePressed, true);"
v1.1.6,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::OnReverseReleased, false);"
v1.1.6,TODO: update other fields
v1.1.6,Setup the flag to say we are in reverse gear
v1.1.6,Update phsyics material
v1.1.6,Update the strings used in the hud (incar and onscreen)
v1.1.6,Set the string in the incar hud
v1.1.6,Pass the engine RPM to the sound component
v1.1.6,Start an engine sound playing
v1.1.6,Using FText because this is display text that should be localizable
v1.1.6,Setup the text render component strings
v1.1.6,Timestamp \t Speed \t Throttle \t Steering \t Brake \t gear
v1.1.6,timestamp
v1.1.6,Speed
v1.1.6,Gear
v1.1.6,call virtual method in derived class
v1.1.6,remove everything that we created in BeginPlay
v1.1.6,perfom any expensive rendering update outside of lock region
v1.1.6,should be overridden by derived class
v1.1.6,Unreal doesn't allow pure abstract methods in actors
v1.1.6,set defaults in case exception occurs
v1.1.6,we had spelling mistake so we are currently supporting SettingsVersion or SettingdVersion :(
v1.1.6,no warnings because we have default settings
v1.1.6,by default we spawn server at local endpoint. Do not use 127.0.0.1 as default below
v1.1.6,because for docker container default is 0.0.0.0 and people get really confused why things
v1.1.6,don't work
v1.1.6,By default this is the column header. Override it in BeginPlay of pawn mode
v1.1.6,Should be overridden by derived classes
v1.1.6,Should be overridden by derived classes
v1.1.6,Should be overridden by derived classes
v1.1.6,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,This assumes you are running DroneServer already on the same machine.
v1.1.6,DroneServer must be running first.
v1.1.6,enable API control
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,move commands
v1.1.6,else leave as it is
v1.1.6,TODO: get these in one call
v1.1.6,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.1.6,TODO: shouldn't we pass folder path?
v1.1.6,parse
v1.1.6,group the images by the current date.
v1.1.6,"std::string beforeScriptStartCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.6,{
v1.1.6,"return """";"
v1.1.6,}
v1.1.6,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.6,{
v1.1.6,return false;
v1.1.6,}
v1.1.6,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.1.6,params.context->client.newTask();
v1.1.6,}
v1.1.6,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.1.6,params.context->client.WaitForCompletion(0);
v1.1.6,}
v1.1.6,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.1.6,{
v1.1.6,}
v1.1.6,parse command line
v1.1.6,Shell callbacks
v1.1.6,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.6,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.6,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.6,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.6,Add shell commands
v1.1.6,TODO: add WaitForCompletion command
v1.1.6,"TODO: add command line args help, arg count validation"
v1.1.6,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.6,Licensed under the MIT License.
v1.1.6,switch to explicit hover mode so that this is the fallback when
v1.1.6,move* commands are finished.
v1.1.6,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.1.6,60 acres park:
v1.1.6,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.1.6,marymoore park
v1.1.6,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,read settings and override defaults
v1.1.5,allow json overrides on a per-vehicle basis.
v1.1.5,start server in async mode
v1.1.5,check messages
v1.1.5,basic flight control
v1.1.5,camera control
v1.1.5,simGetImage returns compressed png in array of bytes
v1.1.5,image_type uses one of the AirSimImageType members
v1.1.5,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.5,camera control
v1.1.5,simGetImage returns compressed png in array of bytes
v1.1.5,image_type uses one of the AirSimImageType members
v1.1.5,helper method for converting getOrientation to roll/pitch/yaw
v1.1.5,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.1.5,roll (x-axis rotation)
v1.1.5,pitch (y-axis rotation)
v1.1.5,yaw (z-axis rotation)
v1.1.5,DEY: I don't know why this was there.
v1.1.5,data = np.flipud(data)
v1.1.5,reverse the vertical line order and add null bytes at the start
v1.1.5,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.1.5,query vehicle state
v1.1.5,def getRCData(self):
v1.1.5,return self.client.call('getRCData')
v1.1.5,APIs for control
v1.1.5,-----------------------------------  Car APIs ---------------------------------------------
v1.1.5,Local variable access is faster in loops
v1.1.5,"if not wrapping over current pointer,"
v1.1.5,then check if there is terminal state wrapped inside
v1.1.5,"If index > history_length, take from a slice"
v1.1.5,Metrics accumulator
v1.1.5,Action Value model (used by agent to interact with the environment)
v1.1.5,"Target model used to compute the target Q-values in training, updated"
v1.1.5,less frequently for increased stability.
v1.1.5,Function computing Q-values targets as part of the computation graph
v1.1.5,"Define the loss, using Huber Loss (more robust to outliers)"
v1.1.5,Compute the q_targets
v1.1.5,actions is a 1-hot encoding of the action done by the agent
v1.1.5,Define training criterion as the Huber Loss function
v1.1.5,Adam based SGD
v1.1.5,Append the state to the short term memory (ie. History)
v1.1.5,"If policy requires agent to explore, sample random action"
v1.1.5,Use the network to output the best action
v1.1.5,Append batch axis with only one sample to evaluate
v1.1.5,Return the value maximizing the expected reward
v1.1.5,Keep track of interval action counter
v1.1.5,"If done, reset short term memory (ie. History)"
v1.1.5,Plot the metrics through Tensorboard and reset buffers
v1.1.5,Reset the short term memory
v1.1.5,Append to long term memory
v1.1.5,Update the Target Network if needed
v1.1.5,print(dist)
v1.1.5,connect to the AirSim simulator
v1.1.5,Make RL agent
v1.1.5,Train
v1.1.5,DEY: I don't know why this was there.
v1.1.5,data = np.flipud(data)
v1.1.5,In settings.json first activate computer vision mode:
v1.1.5,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.5,connect to the AirSim simulator
v1.1.5,go forward
v1.1.5,get state of the car
v1.1.5,connect to the AirSim simulator
v1.1.5,get camera images from the car
v1.1.5,that's enough fun for now. let's quite cleanly
v1.1.5,Local variable access is faster in loops
v1.1.5,"if not wrapping over current pointer,"
v1.1.5,then check if there is terminal state wrapped inside
v1.1.5,"If index > history_length, take from a slice"
v1.1.5,Metrics accumulator
v1.1.5,Action Value model (used by agent to interact with the environment)
v1.1.5,"Target model used to compute the target Q-values in training, updated"
v1.1.5,less frequently for increased stability.
v1.1.5,Function computing Q-values targets as part of the computation graph
v1.1.5,"Define the loss, using Huber Loss (more robust to outliers)"
v1.1.5,Compute the q_targets
v1.1.5,actions is a 1-hot encoding of the action done by the agent
v1.1.5,Define training criterion as the Huber Loss function
v1.1.5,Adam based SGD
v1.1.5,self._trainer.restore_from_checkpoint('models/oldmodels/model800000')
v1.1.5,Append the state to the short term memory (ie. History)
v1.1.5,"If policy requires agent to explore, sample random action"
v1.1.5,Use the network to output the best action
v1.1.5,Append batch axis with only one sample to evaluate
v1.1.5,Return the value maximizing the expected reward
v1.1.5,Keep track of interval action counter
v1.1.5,"If done, reset short term memory (ie. History)"
v1.1.5,Plot the metrics through Tensorboard and reset buffers
v1.1.5,Reset the short term memory
v1.1.5,Append to long term memory
v1.1.5,Update the Target Network if needed
v1.1.5,print(dist)
v1.1.5,Make RL agent
v1.1.5,Train
v1.1.5,use open cv to show new images from AirSim
v1.1.5,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.5,pip install opencv-python
v1.1.5,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.5,use open cv to create point cloud from depth image.
v1.1.5,skip it
v1.1.5,AirSim uses NED coordinates so negative axis is up.
v1.1.5,z of -7 is 7 meters above the original launch point.
v1.1.5,Fly given velocity vector for 5 seconds
v1.1.5,using DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.1.5,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.1.5,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.1.5,AirSim uses NED coordinates so negative axis is up.
v1.1.5,z of -5 is 5 meters above the original launch point.
v1.1.5,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.1.5,this method is async and we are not waiting for the result since we are passing max_wait_seconds=0.
v1.1.5,connect to the AirSim simulator
v1.1.5,get state of the car
v1.1.5,go forward
v1.1.5,Go forward + steer right
v1.1.5,go reverse
v1.1.5,apply breaks
v1.1.5,get camera images from the car
v1.1.5,restore to original state
v1.1.5,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.5,pip install opencv-python
v1.1.5,In settings.json first activate computer vision mode:
v1.1.5,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.5,for neighbourhood environment
v1.1.5,get segmentation image in various formats
v1.1.5,save segmentation images in various formats
v1.1.5,find unique colors
v1.1.5,from keras.models import load_model
v1.1.5,if (len(sys.argv) != 2):
v1.1.5,print('usage: python drive.py <modelName>')
v1.1.5,sys.exit()
v1.1.5,print('Loading model...')
v1.1.5,model = load_model(sys.argv[1])
v1.1.5,connect to the AirSim simulator
v1.1.5,image_buf[0] = get_image()
v1.1.5,"state_buf[0] = np.array([car_controls.steering, car_controls.throttle, car_controls.brake, car_state.speed])"
v1.1.5,"model_output = model.predict([image_buf, state_buf])"
v1.1.5,car_controls.steering = float(model_output[0][0])
v1.1.5,use open cv to show new images from AirSim
v1.1.5,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.5,pip install opencv-python
v1.1.5,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.1.5,get depth image
v1.1.5,"this will return png width= 256, height= 144"
v1.1.5,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.1.5,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.1.5,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.1.5,to get an estimate of distance.
v1.1.5,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.1.5,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.1.5,an angular delta of the following pi/10.
v1.1.5,"in header only mode, control library is not available"
v1.1.5,if using Unreal Build system then include precompiled header file first
v1.1.5,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.5,"Windows, OSX and Linux."
v1.1.5,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.1.5,Windows users can move the Documents folder to any location they want
v1.1.5,SHGetFolderPath knows how to find it.
v1.1.5,fall back in case SHGetFolderPath failed for some reason.
v1.1.5,convert from std::path '/' to windows backslash.
v1.1.5,make the current thread run with maximum priority.
v1.1.5,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.1.5,TODO: How to handle POSIX thread priorities on OSX?
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.1.5,
v1.1.5,Treat all errors as failure conditions.
v1.1.5,parse command line
v1.1.5,"motive gives a weird error if the project is not found, so we look for it."
v1.1.5,Do an update to pick up any recently-arrived cameras.
v1.1.5,List all detected cameras.
v1.1.5,List all defined rigid bodies.
v1.1.5,throttle to 50 messages per second.
v1.1.5,OptiTrack uses 'y' axis for vertical.
v1.1.5,stdafx.cpp : source file that includes just the standard includes
v1.1.5,MavlinkMoCap.pch will be the pre-compiled header
v1.1.5,stdafx.obj will contain the pre-compiled type information
v1.1.5,TODO: reference any additional headers you need in STDAFX.H
v1.1.5,and not in this file
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,PX4.cpp : Defines the entry point for the console application.
v1.1.5,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.1.5,how do you write to the debug output windows on Unix ?
v1.1.5,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.1.5,connection to create to talke to that server.
v1.1.5,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.1.5,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.1.5,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.1.5,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.1.5,using their the -qgc option.
v1.1.5,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.1.5,this switch controls whether we turn off the RC remote active link loss detection
v1.1.5,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.1.5,from kicking in when you try and fly.
v1.1.5,can't use experimental stuff on Linux because of potential ABI issues
v1.1.5,parse the json
v1.1.5,flatten inner mavlink object
v1.1.5,flatten inner mavlink object
v1.1.5,todo
v1.1.5,todo
v1.1.5,"const char* outLogFileOption = ""outlogfile"";"
v1.1.5,parse command line
v1.1.5,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.1.5,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.1.5,"no local serial connection, so this is the primary droneConnection."
v1.1.5,failed to connect
v1.1.5,"local connection, then we own sending the heartbeat."
v1.1.5,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.1.5,cmdTable.push_back(new AltHoldCommand());
v1.1.5,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.1.5,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.1.5,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.1.5,this stops us from being able to connect to SITL mode PX4.
v1.1.5,checkPulse();
v1.1.5,add command text in log
v1.1.5,close previous command.
v1.1.5,FilterLogFiles(logDirectory);
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,send a heartbeat
v1.1.5,accept one incoming connection
v1.1.5,send a heartbeat to the client
v1.1.5,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.1.5,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.1.5,for this unit test we are expecting a request to send an image.
v1.1.5,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.1.5,hmmm
v1.1.5,================ ls
v1.1.5,================ put file
v1.1.5,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.1.5,================ get file
v1.1.5,verify the file contents.
v1.1.5,================ remove file
v1.1.5,================ make directory
v1.1.5,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.1.5,================ remove directory
v1.1.5,Now verification
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,from main.cpp.
v1.1.5,you must call this method if you want HandleMessage to be called subsequently.
v1.1.5,treat literals as one word
v1.1.5,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.5,request gps info
v1.1.5,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.1.5,find relative position since command start so we can compare two commands better
v1.1.5,TODO: make below future proof (i.e. usable by C++17 compiler) - also change same in main.cpp
v1.1.5,can't use experimental stuff on Linux because of potential ABI issues
v1.1.5,"these PID values are important, so set these to match"
v1.1.5,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.1.5,we can skip ahead.
v1.1.5,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.1.5,TODO: avoid passing hadcoded HIL flag
v1.1.5,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.1.5,"The global position, as returned by the Global Positioning System (GPS)."
v1.1.5,Provides state for additional features
v1.1.5,The general system state
v1.1.5,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.5,Provides state for additional features
v1.1.5,The general system state
v1.1.5,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.5,Provides state for additional features
v1.1.5,The general system state
v1.1.5,Provides state for additional features
v1.1.5,The general system state
v1.1.5,note: we do not reset com when Close() is called because we want to keep running.
v1.1.5,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.5,generate random between 0 and 1
v1.1.5,move to range -1 to 1
v1.1.5,scale it
v1.1.5,apply iy
v1.1.5,wait for the Execute method to be called.
v1.1.5,gps is much slower frequency than IMU.
v1.1.5,MAVLINK_MSG_ID_HIL_GPS
v1.1.5,disable MAV_USEHILGPS
v1.1.5,note: we do not reset com when Close() is called because we want to keep running.
v1.1.5,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.5,generate random between 0 and 1
v1.1.5,move to range -1 to 1
v1.1.5,scale it
v1.1.5,apply iy
v1.1.5,wait for the Execute method to be called.
v1.1.5,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.1.5,gps is much slower frequency than IMU.
v1.1.5,MAVLINK_MSG_ID_HIL_GPS
v1.1.5,disable HIL mode
v1.1.5,Enumeration of landed detector states
v1.1.5,MAV landed state is unknown
v1.1.5,MAV is landed (on ground)
v1.1.5,MAV is in air
v1.1.5,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.1.5,The filtered local position
v1.1.5,must send these regularly to keep offboard control.
v1.1.5,"ok, now we can safely switch to loiter."
v1.1.5,must send these regularly to keep offboard control.
v1.1.5,integrate the heading so it is smoother.
v1.1.5,must send these regularly to keep offboard control.
v1.1.5,integrate the heading so it is smoother.
v1.1.5,fly to radius
v1.1.5,it takes about 10 cm to stop and turn.
v1.1.5,next time around switch to orbiting!
v1.1.5,heading points to center of circle.
v1.1.5,interpoloate the speed ramp up time over 2 seconds from start time
v1.1.5,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.1.5,monitor the sin curves so we can see how on track or off track it actually is.
v1.1.5,the shape of the curve will also tell us if we are progressing at a consistent
v1.1.5,"speed, the more deformed the sin curve the worse our progress."
v1.1.5,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.1.5,degrees just flipped from 359 to 0.
v1.1.5,this enables us to test what happens when offboard control is lost and resumed.
v1.1.5,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.1.5,"ok, now we can start moving by velocity"
v1.1.5,recompute to new target.
v1.1.5,start by moving right with 10 degree roll.
v1.1.5,haven't started yet.
v1.1.5,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.1.5,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.1.5,track how our actual pitch is coming along compared to our target
v1.1.5,and check position
v1.1.5,the amount of pitch should depend on our speed in that direction.
v1.1.5,passed the midpoint.
v1.1.5,fade out the pitch as we pick up speed so we don't overshoot.
v1.1.5,see if we just crossed the wiggle distance threshold.
v1.1.5,(pitch affects the x-position).
v1.1.5,reverse direction with a -30 degrees quick stop
v1.1.5,reverse direction with a 30 degrees quick stop
v1.1.5,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.1.5,too much in that direction.
v1.1.5,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.5,track how our actual roll is coming along compared to our target
v1.1.5,and check position
v1.1.5,the amount of roll should depend on our speed in that direction.
v1.1.5,passed the midpoint.
v1.1.5,fade out the roll as we pick up speed so we don't overshoot.
v1.1.5,see if we just crossed the wiggle distance threshold.
v1.1.5,(roll affects the y-position).
v1.1.5,reverse direction with a -30 degrees quick stop
v1.1.5,reverse direction with a 30 degrees quick stop
v1.1.5,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.1.5,too much in that direction.
v1.1.5,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.5,for testing PID controller.
v1.1.5,class AltHoldCommand : public Command
v1.1.5,{
v1.1.5,std::shared_ptr<MavLinkVehicle> channel;
v1.1.5,"float sx_, sy_, sz_;"
v1.1.5,MavLinkAttitudeTarget _current;
v1.1.5,PidController thrust_controller_;
v1.1.5,public:
v1.1.5,this->sz_ = pos.z; // user defined target.
v1.1.5,move to local position keeps the offboard control happy.
v1.1.5,haven't started yet.
v1.1.5,and check position
v1.1.5,double dx = this->sx_ - pos.x;
v1.1.5,double dy = this->sy_ - pos.y;
v1.1.5,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.1.5,too much in that direction.
v1.1.5,adjust thrust so we keep steady height target
v1.1.5,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.5,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.1.5,local remote
v1.1.5,already handled by the parse method.
v1.1.5,we only support very simple patterns for now.
v1.1.5,each wildcard must be separated by literal.
v1.1.5,back to back wildcards with no literal in between is too complex.
v1.1.5,"we only support simple matching for now, we can add full regex later if we need it."
v1.1.5,yep!
v1.1.5,'*' is done we found the next matching char
v1.1.5,this is ok.
v1.1.5,this is an ERASE_END_LINE command which we ignore.
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,unpack the message...
v1.1.5,pack the payload buffer.
v1.1.5,"json can't handle ""nan"", so we convert it to null."
v1.1.5,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.1.5,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,start listening to this connection
v1.1.5,Send heartbeat to drone.  You should not do this if some other node is
v1.1.5,already doing it.
v1.1.5,stop listening to the connection.
v1.1.5,get the connection
v1.1.5,Get the local system and component id
v1.1.5,send a command to the remote node
v1.1.5,MavLinkNode::MavLinkNode() = default;
v1.1.5,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.1.5,decrementing the count so the next WaitOne may block.
v1.1.5,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.1.5,convert to absolute time.
v1.1.5,use mach_timespec
v1.1.5,convert to absolute time.
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,return true if we still have offboard control (can lose this if user flips the switch).
v1.1.5,MavLinkVehicle::MavLinkVehicle() = default;
v1.1.5,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.1.5,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,============================== CLIENT ============================================
v1.1.5,image APIs
v1.1.5,or if you are implementing the client side call this function to get the most recent frame.
v1.1.5,returns false if there is no new frame available.
v1.1.5,============================== SERVER ============================================
v1.1.5,call this to send the image back over the connection given to start function.
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,"log every message that is ""sent"" using sendMessage."
v1.1.5,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.1.5,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.1.5,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.1.5,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,for compatibility with QGroundControl we have to save the time field in big endian.
v1.1.5,todo: mavlink2 support?
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,start listening to this connection
v1.1.5,Send heartbeat to drone.  You should not do this if some other node is
v1.1.5,already doing it.
v1.1.5,send a heart beat so that the remote node knows we are still alive
v1.1.5,(otherwise drone will trigger a failsafe operation).
v1.1.5,this is called for all messages received on the connection.
v1.1.5,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.1.5,subclasses remembering to call this base implementation.
v1.1.5,stop listening to the connection.
v1.1.5,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.5,wait for a heartbeat msg since this will give us the port to send commands to...
v1.1.5,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.1.5,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.5,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.5,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.5,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.5,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.5,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.5,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.1.5,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.1.5,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.1.5,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.1.5,"ok, now fetch the missing parameters."
v1.1.5,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.1.5,silently fail since we are on a background thread here...
v1.1.5,tell the caller this is complete.
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,add our custom telemetry message length.
v1.1.5,todo: if we support signing then initialize
v1.1.5,mavlink_intermediate_status_.signing callbacks
v1.1.5,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.1.5,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.5,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.5,send this right away just in case serial link is not already configured
v1.1.5,"log every message that is ""sent"" using sendMessage."
v1.1.5,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.1.5,pack the payload buffer.
v1.1.5,calculate checksum
v1.1.5,form the header as a byte array for the crc
v1.1.5,these macros use old style cast.
v1.1.5,forward messages from our connected node to the remote proxy.
v1.1.5,forward messages from remote proxy to local connected node
v1.1.5,CurrentThread::setMaximumPriority();
v1.1.5,"hmmm, wait till it is opened?"
v1.1.5,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.1.5,pick up the sysid/compid of the remote node we are connected to.
v1.1.5,then this is a mavlink 1 message
v1.1.5,then this mavlink sender supports mavlink 2
v1.1.5,queue event for publishing.
v1.1.5,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.1.5,as it ensures we don't lose messages if the listener is slow.
v1.1.5,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.1.5,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.1.5,we would get a deadlock.
v1.1.5,CurrentThread::setMaximumPriority();
v1.1.5,reset counters
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,------------------------------------------------------------------------------
v1.1.5,Defines
v1.1.5,------------------------------------------------------------------------------
v1.1.5,bit number  876543210987654321
v1.1.5,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.1.5,in future it would be good to have ability to add system IDs we are interested in
v1.1.5,if (msg.sysid != getTargetSystemId())
v1.1.5,{
v1.1.5,// we only care about messages from our intended remote node.
v1.1.5,return;
v1.1.5,}
v1.1.5,user may have changed modes on us! So we need to honor that and not
v1.1.5,try and take it back.
v1.1.5,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.1.5,we can store up to 16 channels in rc_channels_scaled.
v1.1.5,The RAW values of the servo outputs
v1.1.5,Metrics typically displayed on a HUD for fixed wing aircraft
v1.1.5,The IMU readings in SI units in NED body frame
v1.1.5,printSystemStatus(&msg);
v1.1.5,todo: use this to determine when we need to do emergency landing...
v1.1.5,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.1.5,Provides state for additional features
v1.1.5,The general system state
v1.1.5,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.1.5,but we do want to know when we get the ack.  So this is async ACK processing!
v1.1.5,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.1.5,if threshold < 0 then the threshold is inverted.
v1.1.5,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.1.5,Convert it to a floating point number between -1 and 1.
v1.1.5,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.1.5,until the move commands start happening.
v1.1.5,return true if user calls requestControl and has not called releaseControl.
v1.1.5,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.1.5,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.1.5,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.1.5,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.1.5,send a few to make sure it gets through...
v1.1.5,now the command should succeed.
v1.1.5,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.1.5,us by which time the PX4 times out offboard mode!!
v1.1.5,this mode change take precedence over offboard mode.
v1.1.5,thrust must be between -1 and 1.
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,These definitions are copied from PX4 implementation
v1.1.5,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.1.5,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.1.5,/ @brief Command opcodes
v1.1.5,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.1.5,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.5,must trim trailing slashes so PX4 doesn't hang!
v1.1.5,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.1.5,from the source.
v1.1.5,check if directory exists.
v1.1.5,perfect.
v1.1.5,use last_message_ so we preserve the sessionid.
v1.1.5,"could not create the local file, so stop."
v1.1.5,must use last_message_ so we preserve the session id.
v1.1.5,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.1.5,todo: error handling here? sequence is out of order...
v1.1.5,"directory must be empty then, can't do nextStep because"
v1.1.5,it will just loop for ever re-requesting zero offset into
v1.1.5,empty directory.
v1.1.5,result should be a list of null terminated file names.
v1.1.5,skipping this entry
v1.1.5,remove the file size field.
v1.1.5,"printf(""%s\n"", name.c_str());"
v1.1.5,request the next batch.
v1.1.5,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.5,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.5,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.1.5,reached the end of the list or the file.
v1.1.5,end of file or directory listing.
v1.1.5,"success, data should be following..."
v1.1.5,ack on this cmd is a noop
v1.1.5,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.1.5,give up then.
v1.1.5,tell watchdog we are sending a request
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,================================= CLIENT ==============================================================
v1.1.5,Check if we have a valid transaction
v1.1.5,emit signal if all packets arrived
v1.1.5,Restart statemachine
v1.1.5,image APIs
v1.1.5,================================= SERVER ==============================================================
v1.1.5,Prepare and send acknowledgment packet
v1.1.5,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.1.5,Send ENCAPSULATED_IMAGE packet
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.1.5,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.5,parse out the VID number
v1.1.5,now the PID
v1.1.5,parse out the VID number
v1.1.5,examples:
v1.1.5,PX4: USB\VID_26AC&PID_0011\0
v1.1.5,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.1.5,"printf(""Found: %S\n"", buffer.c_str());"
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.5,parse out the VID number
v1.1.5,now the PID
v1.1.5,parse out the VID number
v1.1.5,suppress
v1.1.5,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,This has not been properly tested
v1.1.5,struct iw_statistics stats;
v1.1.5,struct iwreq req;
v1.1.5,"memset(&stats, 0, sizeof(stats));"
v1.1.5,"memset(&req, 0, sizeof(iwreq));"
v1.1.5,
v1.1.5,"strncpy(req.ifr_name, ifaceName, 16);"
v1.1.5,req.u.data.pointer = &stats;
v1.1.5,req.u.data.length = sizeof(iw_statistics);
v1.1.5,
v1.1.5,#ifdef CLEAR_UPDATED
v1.1.5,req.u.data.flags = 1;
v1.1.5,#endif
v1.1.5,
v1.1.5,/* Perform the ioctl */
v1.1.5,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.1.5,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.1.5,return -127;
v1.1.5,}
v1.1.5,
v1.1.5,return stats.qual.level;
v1.1.5,todo: windows version of this...
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,windows
v1.1.5,Need to link with Ws2_32.lib
v1.1.5,posix
v1.1.5,found it!
v1.1.5,bind socket to local address.
v1.1.5,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.1.5,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.1.5,write to the serial port
v1.1.5,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.1.5,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.1.5,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.1.5,"try and receive something, up until port is closed anyway."
v1.1.5,"message was too large for the buffer, no problem, return what we have."
v1.1.5,try again - this can happen if server recreates the socket on their side.
v1.1.5,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.5,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.5,try again - this can happen if server recreates the socket on their side.
v1.1.5,"printf(""#### recv failed with error: %d\n"", hr);"
v1.1.5,we now have it.
v1.1.5,this is from someone we are not interested in.
v1.1.5,"printf(""Connection closed\n"");"
v1.1.5,-----------------------------------------------------------------------------------------
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,Initialize Winsock
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,windows
v1.1.5,Need to link with Ws2_32.lib
v1.1.5,posix
v1.1.5,found it!
v1.1.5,bind socket to local address.
v1.1.5,bind socket to local address.
v1.1.5,start listening for incoming connection
v1.1.5,accept 1
v1.1.5,write to the serial port
v1.1.5,"try and receive something, up until port is closed anyway."
v1.1.5,"message was too large for the buffer, no problem, return what we have."
v1.1.5,try again - this can happen if server recreates the socket on their side.
v1.1.5,"skip this, it is was interrupted."
v1.1.5,"printf(""Connection closed\n"");"
v1.1.5,-----------------------------------------------------------------------------------------
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.1.5,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.1.5,set signal
v1.1.5,Clear Handshake flags
v1.1.5,Set Handshake flags
v1.1.5,return GetLastError();
v1.1.5,return GetLastError();
v1.1.5,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.5,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.1.5,enable reading
v1.1.5,posix doesn't have mark/space parity.
v1.1.5,posix doesn't have mark/space parity.
v1.1.5,this is the default.
v1.1.5,not sure this is supported...
v1.1.5,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.1.5,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.5,First do those specified by POSIX.
v1.1.5,Now conditionally handle a bunch of extended rates.
v1.1.5,First do those specified by POSIX.
v1.1.5,Now conditionally handle a bunch of extended rates.
v1.1.5,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.5,","
v1.1.5,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.1.5,"std::unique_ptr<TestBase>(new RosFlightTest()),"
v1.1.5,"std::unique_ptr<TestBase>(new QuaternionTest()),"
v1.1.5,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,"in header only mode, control library is not available"
v1.1.5,TODO: something defines max macro which interfears with code here
v1.1.5,is cur_pos within fence?
v1.1.5,destination risk is not available then consider it zero
v1.1.5,if dest risk is lower than its more safe
v1.1.5,are we doing better than closest obstacle?
v1.1.5,"if we stay where we are, what is the risk distance?"
v1.1.5,else we are better of moving to dest
v1.1.5,this function should work even when dest_pos == cur_pos
v1.1.5,is this dest_pos cur_pos within the fence?
v1.1.5,transform dest_pos vector to body frame
v1.1.5,check for approx zero vectors to avoid random yaw angles
v1.1.5,we are hovering
v1.1.5,"get yaw in body frame, ie, front is always 0 radians"
v1.1.5,yaw to ticks
v1.1.5,get obstacles in the window at the tick direction around the window
v1.1.5,less risk distance is better
v1.1.5,check obstacles around current position and see if it has lower risk
v1.1.5,else obstacle is too far
v1.1.5,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.1.5,look for each surrounding tick to see if we have obstacle free angle
v1.1.5,else no suggestions required
v1.1.5,"3.2 comes from inverse CDF for epsilone = 0.05 (i.e. 95% confidence), author: akapoor"
v1.1.5,evaluate right and left side of circle
v1.1.5,find right and left risk distances
v1.1.5,at this point we have already determined hover is better than going to dest
v1.1.5,we now determine is moving to suggested angle better than hovering?
v1.1.5,check if dest_pos is safe
v1.1.5,breaking distance at this velocity
v1.1.5,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.1.5,check if dest_pos is safe
v1.1.5,float/vec parameters can have NaN which makes them optional
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,"in header only mode, control library is not available"
v1.1.5,handles +/- tick and wraps around circle
v1.1.5,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.1.5,update the specified window on the map
v1.1.5,make dure from <= to
v1.1.5,normalize the ticks so bothe are valid indices
v1.1.5,if from is still larger then
v1.1.5,to ticks is then added one full circle to make it larger than from_tick
v1.1.5,find closest obstacle in given window
v1.1.5,search whole map to find closest obstacle
v1.1.5,"in header only mode, control library is not available"
v1.1.5,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.5,"Windows, OSX and Linux."
v1.1.5,Windows users can move the Documents folder to any location they want
v1.1.5,SHGetFolderPath knows how to find it.
v1.1.5,fall back in case SHGetFolderPath failed for some reason.
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,"in header only mode, control library is not available"
v1.1.5,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.5,if using Unreal Build system then include precompiled header file first
v1.1.5,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.5,#undef check
v1.1.5,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.5,sim only
v1.1.5,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.5,required for pimpl
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,"in header only mode, control library is not available"
v1.1.5,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.5,if using Unreal Build system then include precompiled header file first
v1.1.5,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.1.5,sim only
v1.1.5,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.5,make sure we can talk to the DroneServer
v1.1.5,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.1.5,command_context.client.ping();
v1.1.5,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,"in header only mode, control library is not available"
v1.1.5,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.5,if using Unreal Build system then include precompiled header file first
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,"in header only mode, control library is not available"
v1.1.5,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.5,if using Unreal Build system then include precompiled header file first
v1.1.5,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.5,#undef check
v1.1.5,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.5,required for pimpl
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,"in header only mode, control library is not available"
v1.1.5,if auto mode requested for lookahead then calculate based on velocity
v1.1.5,no-op by default. derived class can override it if needed
v1.1.5,no-op by default. derived class can override it if needed
v1.1.5,validate path size
v1.1.5,validate yaw mode
v1.1.5,validate and set auto-lookahead value
v1.1.5,if auto mode requested for lookahead then calculate based on velocity
v1.1.5,add current position as starting point
v1.1.5,append the input path and compute segments
v1.1.5,add last segment as zero length segment so we have equal number of segments and points.
v1.1.5,path_segs[i] refers to segment that starts at point i
v1.1.5,"when path ends, we want to slow down"
v1.1.5,else no need to change velocities for last segments
v1.1.5,setup current position on path to 0 offset
v1.1.5,initialize next path position
v1.1.5,until we are at the end of the path (last seg is always zero size)
v1.1.5,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.1.5,send drone command to get to next lookahead
v1.1.5,sleep for rest of the cycle
v1.1.5,how much have we moved towards last goal?
v1.1.5,project actual vector on goal vector
v1.1.5,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.1.5,TODO: below should be lower than 1E3 and configurable
v1.1.5,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.1.5,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.1.5,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.1.5,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.1.5,"if drone moved backward, we don't want goal to move backward as well"
v1.1.5,"so only climb forward on the path, never back. Also note >= which means"
v1.1.5,we climb path even if distance was 0 to take care of duplicated points on path
v1.1.5,else
v1.1.5,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.1.5,compute next target on path
v1.1.5,last command is to hold on to position
v1.1.5,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.1.5,default strategy is for move. In hover mode we set new strategy temporarily
v1.1.5,freeze the quaternion
v1.1.5,get trims
v1.1.5,take average
v1.1.5,convert RC commands to velocity vector
v1.1.5,find yaw as per terrain and remote setting
v1.1.5,execute command
v1.1.5,Only raise exception is time out occurred. If preempted then return status.
v1.1.5,are we supposed to do EM?
v1.1.5,get suggested velocity vector
v1.1.5,use the unchecked command
v1.1.5,tell caller not to execute planned command
v1.1.5,other wise throw exception
v1.1.5,otherwise there is some other reason why we are in unsafe situation
v1.1.5,send last command to come to full stop
v1.1.5,else no unsafe situation
v1.1.5,note: cur_path_loc and next_path_loc may both point to same object
v1.1.5,"otherwise use up this segment, move on to next one"
v1.1.5,if we are here then we ran out of segments
v1.1.5,consider last segment as zero length segment
v1.1.5,adjust yaw for the direction of travel in foward-only mode
v1.1.5,else no adjustment needed
v1.1.5,validate dest
v1.1.5,what is the distance we will travel at this velocity?
v1.1.5,get velocity vector
v1.1.5,yaw for the direction of travel
v1.1.5,find velocity vector
v1.1.5,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.1.5,generate velocity vector that is same size as cur_dest_norm / command period
v1.1.5,this velocity vect when executed for command period would yield cur_dest_norm
v1.1.5,send commands
v1.1.5,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.1.5,by default indicate that we don't have alternative pose info
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,"in header only mode, control library is not available"
v1.1.5,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.5,if using Unreal Build system then include precompiled header file first
v1.1.5,status getters
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,"in header only mode, control library is not available"
v1.1.5,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.5,if using Unreal Build system then include precompiled header file first
v1.1.5,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.5,#undef check
v1.1.5,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.5,getters
v1.1.5,required for pimpl
v1.1.5,Create a spring arm component for our chase camera
v1.1.5,do nothing
v1.1.5,set initial view mode
v1.1.5,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.1.5,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.1.5,"If the lag is missing, the camera will also occasionally shake."
v1.1.5,"But, lag is not desired when piloting a drone"
v1.1.5,attach spring arm to actor
v1.1.5,remember current parent for external camera. Later when we remove external
v1.1.5,"camera from spring arm, we will attach it back to its last parent"
v1.1.5,now attach camera to spring arm
v1.1.5,"For car, we need to move the camera back a little more than for a drone."
v1.1.5,"Otherwise, the camera will be stuck inside the car"
v1.1.5,external_camera_->bUsePawnControlRotation = false;
v1.1.5,if prev mode was spring arm but new mode isn't then detach spring arm
v1.1.5,"else someone else is bound to manual pose controller, leave it alone"
v1.1.5,TODO: explore screenshot option
v1.1.5,addScreenCaptureHandler(camera->GetWorld());
v1.1.5,Wait for render so that view is ready for capture
v1.1.5,not sure why this doesn't work.
v1.1.5,"DECLARE_CYCLE_STAT(TEXT(""FNullGraphTask.CheckRenderStatus""), STAT_FNullGraphTask_CheckRenderStatus, STATGROUP_TaskGraphTasks);"
v1.1.5,"auto renderStatus = TGraphTask<FNullGraphTask>::CreateTask(NULL).ConstructAndDispatchWhenReady(GET_STATID(STAT_FNullGraphTask_CheckRenderStatus), ENamedThreads::RenderThread);"
v1.1.5,FTaskGraphInterface::Get().WaitUntilTaskCompletes(renderStatus);
v1.1.5,Make sure that all alpha values are opaque.
v1.1.5,Deflect along the surface when we collide.
v1.1.5,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.1.5,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.1.5,set up key variables
v1.1.5,initialize state
v1.1.5,should be overridden in derived class
v1.1.5,should be overridden in derived class
v1.1.5,TODO: delete below
v1.1.5,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.5,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.5,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.5,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.5,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.1.5,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.5,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.1.5,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.5,parameters in NED frame
v1.1.5,translate to new VehiclePawnWrapper position & orientation from NED to NEU
v1.1.5,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.1.5,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.1.5,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.1.5,checked at the start of next tick
v1.1.5,allow teleportation
v1.1.5,if collisions are not enabled
v1.1.5,or we have collided but passthrough is enabled
v1.1.5,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.1.5,"without flip flopping, collisions can't be detected"
v1.1.5,set default for brigher images
v1.1.5,by default all image types are disabled
v1.1.5,use final color for all calculations
v1.1.5,use final color for all calculations
v1.1.5,else we will set this after this components get created
v1.1.5,else we will set this after this components get created
v1.1.5,do not make unnecessory calls to Activate() which otherwise causes crash in Unreal
v1.1.5,else nothing to enable
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,TODO: change naming conventions to same as other files?
v1.1.5,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.1.5,mesh->SetRenderCustomDepth(false);
v1.1.5,mesh->SetRenderCustomDepth(true);
v1.1.5,mesh->SetVisibility(false);
v1.1.5,mesh->SetVisibility(true);
v1.1.5,if (! is_name_regex)
v1.1.5,return true;
v1.1.5,Access the subclass instance with the * or -> operators.
v1.1.5,can we see followee?
v1.1.5,remove mapping
v1.1.5,removing binding
v1.1.5,"TODO: can't do remove because there is no ""stamp"" on who established binding"
v1.1.5,removeInputBindings();
v1.1.5,#ifdef _MSC_VER
v1.1.5,//print to VS output window
v1.1.5,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.1.5,#endif
v1.1.5,also do default logging
v1.1.5,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.1.5,UGameUserSettings* game_settings = GetGameUserSettings();
v1.1.5,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.1.5,game_settings->ApplySettings(true);
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,plugin startup
v1.1.5,plugin shutdown
v1.1.5,"read pixels from render target using render thread, then compress the result into PNG"
v1.1.5,argument on the thread that calls this method.
v1.1.5,make sure we are not on the rendering thread
v1.1.5,TODO: below doesn't work right now because it must be running in game thread
v1.1.5,below is documented method but more expensive because it forces flush
v1.1.5,wait for render thread to pick up our task
v1.1.5,Queue up the task of rendering the scene in the render thread
v1.1.5,wait for this task to complete
v1.1.5,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.1.5,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.1.5,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.1.5,Stuff to filter out XInput devices
v1.1.5,-----------------------------------------------------------------------------
v1.1.5,"Defines, constants, and global variables"
v1.1.5,-----------------------------------------------------------------------------
v1.1.5,Register with the DirectInput subsystem and get a pointer
v1.1.5,to a IDirectInput interface we can use.
v1.1.5,Create a DInput object
v1.1.5,Look for a simple joystick we can use for this sample program.
v1.1.5,Make sure we got a joystick
v1.1.5,"Set the data format to ""simple joystick"" - a predefined data format"
v1.1.5,
v1.1.5,"A data format specifies which controls on a device we are interested in,"
v1.1.5,and how they should be reported. This tells DInput that we will be
v1.1.5,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.1.5,Set the cooperative level to let DInput know how this device should
v1.1.5,interact with the system and with other DInput applications.
v1.1.5,Enumerate the joystick objects. The callback function enabled user
v1.1.5,"interface elements for objects that are found, and sets the min/max"
v1.1.5,values property for discovered axes.
v1.1.5,-----------------------------------------------------------------------------
v1.1.5,Enum each PNP device using WMI and check each device ID to see if it contains
v1.1.5,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then its an XInput device"
v1.1.5,Unfortunately this information can not be found by just using DirectInput.
v1.1.5,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.1.5,XInput devices.
v1.1.5,
v1.1.5,This function stores the list of xinput devices in a linked list
v1.1.5,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.1.5,-----------------------------------------------------------------------------
v1.1.5,CoInit if needed
v1.1.5,Create WMI
v1.1.5,Create BSTRs for WMI
v1.1.5,Connect to WMI
v1.1.5,Switch security level to IMPERSONATE
v1.1.5,Get list of Win32_PNPEntity devices
v1.1.5,Loop over all devices
v1.1.5,Get 20 at a time
v1.1.5,"For each device, get its device ID"
v1.1.5,"Check if the device ID contains ""IG_"".  If it does, then its an XInput device"
v1.1.5,Unfortunately this information can not be found by just using DirectInput
v1.1.5,"If it does, then get the VID/PID from var.bstrVal"
v1.1.5,Add the VID/PID to a linked list
v1.1.5,-----------------------------------------------------------------------------
v1.1.5,Returns true if the DirectInput device is also an XInput device.
v1.1.5,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.1.5,-----------------------------------------------------------------------------
v1.1.5,Check each xinput device to see if this device's vid/pid matches
v1.1.5,-----------------------------------------------------------------------------
v1.1.5,Cleanup needed for IsXInputDevice()
v1.1.5,-----------------------------------------------------------------------------
v1.1.5,Cleanup linked list
v1.1.5,-----------------------------------------------------------------------------
v1.1.5,Name: EnumJoysticksCallback()
v1.1.5,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.1.5,device interface on it so we can play with it.
v1.1.5,-----------------------------------------------------------------------------
v1.1.5,Skip anything other than the perferred joystick device as defined by the control panel.
v1.1.5,Instead you could store all the enumerated joysticks and let the user pick.
v1.1.5,Obtain an interface to the enumerated joystick.
v1.1.5,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.1.5,it while we were in the middle of enumerating it.)
v1.1.5,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.1.5,could store all the enumerated joysticks and let the user pick.
v1.1.5,-----------------------------------------------------------------------------
v1.1.5,Name: EnumObjectsCallback()
v1.1.5,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.1.5,joystick. This function enables user interface elements for objects
v1.1.5,"that are found to exist, and scales axes min/max values."
v1.1.5,-----------------------------------------------------------------------------
v1.1.5,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.1.5,enumerated axis in order to scale min/max values.
v1.1.5,Set the range for the axis
v1.1.5,Set the UI to reflect what objects the joystick supports
v1.1.5,-----------------------------------------------------------------------------
v1.1.5,Name: UpdateInputState()
v1.1.5,Desc: Get the input device's state and display it.
v1.1.5,-----------------------------------------------------------------------------
v1.1.5,Poll the device to read the current state
v1.1.5,DInput is telling us that the input stream has been
v1.1.5,"interrupted. We aren't tracking any state between polls, so"
v1.1.5,we don't have any special reset that needs to be done. We
v1.1.5,just re-acquire and try again.
v1.1.5,while (hr == DIERR_INPUTLOST)
v1.1.5,hr = g_pJoystick->Acquire();
v1.1.5,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.1.5,may occur when the app is minimized or in the process of
v1.1.5,"switching, so just try again later"
v1.1.5,Get the input's device state
v1.1.5,Axes
v1.1.5,Slider controls
v1.1.5,Points of view
v1.1.5,Buttons
v1.1.5,-----------------------------------------------------------------------------
v1.1.5,Name: FreeDirectInput()
v1.1.5,Desc: Initialize the DirectInput variables.
v1.1.5,-----------------------------------------------------------------------------
v1.1.5,Unacquire the device one last time just in case
v1.1.5,the app tried to exit while the device is still acquired.
v1.1.5,Release any DirectInput objects.
v1.1.5,nop
v1.1.5,normalize min to max --> 0 to 1
v1.1.5,normalize 0 to 1 --> -1 to 1
v1.1.5,implementation for unsupported OS
v1.1.5,if this is new indec
v1.1.5,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.1.5,close previos one
v1.1.5,open new device
v1.1.5,if open was sucessfull
v1.1.5,read the device
v1.1.5,if we didn't had valid read
v1.1.5,"NOTE if this condition is not met, we're probably out of sync and this"
v1.1.5,Joystick instance is likely unusable
v1.1.5,TODO: set below to false?
v1.1.5,state.is_valid = false;
v1.1.5,else ignore
v1.1.5,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.1.5,{
v1.1.5,"manufacturerID = productID = """";"
v1.1.5,// Use udev to look up the product and manufacturer IDs
v1.1.5,struct udev *udev = udev_new();
v1.1.5,if (udev) {
v1.1.5,char sysname[32];
v1.1.5,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.1.5,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.1.5,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.1.5,if (!dev)
v1.1.5,{
v1.1.5,"message = ""Unable to find parent USB device"";"
v1.1.5,return false;
v1.1.5,}
v1.1.5,std::stringstream ss;
v1.1.5,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.1.5,ss >> manufacturerID;
v1.1.5,ss.clear();
v1.1.5,"ss.str("""");"
v1.1.5,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.1.5,ss >> productID;
v1.1.5,udev_device_unref(dev);
v1.1.5,}
v1.1.5,else
v1.1.5,{
v1.1.5,"message = ""Cannot create udev"";"
v1.1.5,return false;
v1.1.5,}
v1.1.5,udev_unref(udev);
v1.1.5,return true;
v1.1.5,}
v1.1.5,required for pimpl
v1.1.5,TODO: should we only do below on SceneCapture2D components and cameras?
v1.1.5,avoid motion blur so capture images don't get
v1.1.5,use two different methods to set console var because sometime it doesn't seem to work
v1.1.5,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.1.5,create main widget
v1.1.5,synchronize PIP views
v1.1.5,setup defaults
v1.1.5,TODO: should this be done somewhere else?
v1.1.5,load settings file if found
v1.1.5,create default settings
v1.1.5,"write some settings in new file otherwise the string ""null"" is written if all settigs are empty"
v1.1.5,TODO: there is a crash in Linux due to settings.saveJSonString(). Remove this workaround after we only support Unreal 4.17
v1.1.5,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.1.5,create its control server
v1.1.5,stop physics thread before we dismental
v1.1.5,for (AActor* actor : spawned_actors_) {
v1.1.5,actor->Destroy();
v1.1.5,}
v1.1.5,get player controller
v1.1.5,put camera little bit above vehicle
v1.1.5,we will either find external camera if it already exist in evironment or create one
v1.1.5,find all BP camera directors in the environment
v1.1.5,create director
v1.1.5,create external camera required for the director
v1.1.5,find all vehicle pawns
v1.1.5,if no vehicle pawns exists in environment
v1.1.5,create vehicle pawn
v1.1.5,set up vehicle pawns
v1.1.5,initialize each vehicle pawn we found
v1.1.5,chose first pawn as FPV if none is designated as FPV
v1.1.5,now create the connector for each pawn
v1.1.5,else we don't have vehicle for this pawn
v1.1.5,TODO: because this bug we are using alternative code with stringstream
v1.1.5,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.1.5,std::stringstream ss;
v1.1.5,"ss << timestamp_millis << ""\t"";"
v1.1.5,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.1.5,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.1.5,"ss << ""\n"";"
v1.1.5,return ss.str();
v1.1.5,find vehicles and cameras available in environment
v1.1.5,if none available then we will create one
v1.1.5,get references of components so we can use later
v1.1.5,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.1.5,-1 to 1 --> 0 to 1
v1.1.5,convert 0 to 1 -> -1 to 1
v1.1.5,TODO: add fields for z axis?
v1.1.5,last 8 bits are not used for now
v1.1.5,TODO: should below be at controller level info?
v1.1.5,else don't waste time
v1.1.5,"Utils::log(""------Render tick-------"");"
v1.1.5,move collision info from rendering engine to vehicle
v1.1.5,update ground level
v1.1.5,update rotor poses
v1.1.5,update rotor animations
v1.1.5,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response_info.collision_count_raw), LogDebugLevel::Unimportant);"
v1.1.5,*** Start: UpdatableState implementation ***//
v1.1.5,TODO: should this be done in MultiRotor.hpp
v1.1.5,controller_->reset();
v1.1.5,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.1.5,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.1.5,*** End: UpdatableState implementation ***//
v1.1.5,"If render command is complete, save image along with position and orientation"
v1.1.5,"UAirBlueprintLib::LogMessage(TEXT(""Screenshot saved to:""), filePath, LogDebugLevel::Success);"
v1.1.5,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.1.5,make sire all vars are set up
v1.1.5,"todo: should we go as fast as possible, or should we limit this to a particular number of"
v1.1.5,frames per second?
v1.1.5,"UAirBlueprintLib::LogMessage(TEXT(""Stopped recording thread""), TEXT(""""), LogDebugLevel::Success);"
v1.1.5,Try to find the high polycount vehicle
v1.1.5,"If not found, spawn the default class (go-kart)"
v1.1.5,Timestamp \t Speed \t Throttle \t Steering \t Brake \t gear \t ImageName
v1.1.5,get player controller
v1.1.5,put camera little bit above vehicle
v1.1.5,we will either find external camera if it already exist in evironment or create one
v1.1.5,find all BP camera directors in the environment
v1.1.5,create director
v1.1.5,create external camera required for the director
v1.1.5,find all vehicle pawns
v1.1.5,if no vehicle pawns exists in environment
v1.1.5,create vehicle pawn
v1.1.5,set up vehicle pawns
v1.1.5,initialize each vehicle pawn we found
v1.1.5,chose first pawn as FPV if none is designated as FPV
v1.1.5,find vehicles and cameras available in environment
v1.1.5,if none available then we will create one
v1.1.5,find all vehicle pawns
v1.1.5,set up vehicle pawns
v1.1.5,initialize each vehicle pawn we found
v1.1.5,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.5,Setup suspension forces
v1.1.5,Find the tire object and set the data for it
v1.1.5,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.5,Setup suspension forces
v1.1.5,Find the tire object and set the data for it
v1.1.5,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.5,Needed for VR Headset
v1.1.5,this->AutoReceiveInput = EAutoReceiveInput::Player0;
v1.1.5,Car mesh
v1.1.5,Setup friction materials
v1.1.5,Wheels/Tyres
v1.1.5,Setup the wheels
v1.1.5,Adjust the tire loading
v1.1.5,Engine
v1.1.5,Torque setup
v1.1.5,Adjust the steering
v1.1.5,Transmission
v1.1.5,We want 4wd
v1.1.5,Drive the front wheels a little more than the rear
v1.1.5,Automatic gearbox
v1.1.5,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.1.5,Physics settings
v1.1.5,Adjust the center of mass - the buggy is quite low
v1.1.5,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.1.5,Create In-Car camera component
v1.1.5,In car HUD
v1.1.5,Create text render component for in car speed display
v1.1.5,Create text render component for in car gear display
v1.1.5,Setup the audio component and allocate it a sound cue
v1.1.5,Colors for the in-car gear display. One for normal one for reverse
v1.1.5,put camera little bit above vehicle
v1.1.5,below is not needed
v1.1.5,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::OnReversePressed, true);"
v1.1.5,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::OnReverseReleased, false);"
v1.1.5,TODO: update other fields
v1.1.5,Setup the flag to say we are in reverse gear
v1.1.5,Update phsyics material
v1.1.5,Update the strings used in the hud (incar and onscreen)
v1.1.5,Set the string in the incar hud
v1.1.5,Pass the engine RPM to the sound component
v1.1.5,Start an engine sound playing
v1.1.5,Using FText because this is display text that should be localizable
v1.1.5,Setup the text render component strings
v1.1.5,Timestamp \t Speed \t Throttle \t Steering \t Brake \t gear
v1.1.5,timestamp
v1.1.5,Speed
v1.1.5,Gear
v1.1.5,call virtual method in derived class
v1.1.5,remove everything that we created in BeginPlay
v1.1.5,perfom any expensive rendering update outside of lock region
v1.1.5,should be overridden by derived class
v1.1.5,Unreal doesn't allow pure abstract methods in actors
v1.1.5,set defaults in case exception occurs
v1.1.5,we had spelling mistake so we are currently supporting SettingsVersion or SettingdVersion :(
v1.1.5,no warnings because we have default settings
v1.1.5,by default we spawn server at local endpoint. Do not use 127.0.0.1 as default below
v1.1.5,because for docker container default is 0.0.0.0 and people get really confused why things
v1.1.5,don't work
v1.1.5,By default this is the column header. Override it in BeginPlay of pawn mode
v1.1.5,Should be overridden by derived classes
v1.1.5,Should be overridden by derived classes
v1.1.5,Should be overridden by derived classes
v1.1.5,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,This assumes you are running DroneServer already on the same machine.
v1.1.5,DroneServer must be running first.
v1.1.5,enable API control
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,move commands
v1.1.5,else leave as it is
v1.1.5,TODO: get these in one call
v1.1.5,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.1.5,TODO: shouldn't we pass folder path?
v1.1.5,parse
v1.1.5,group the images by the current date.
v1.1.5,"std::string beforeScriptStartCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.5,{
v1.1.5,"return """";"
v1.1.5,}
v1.1.5,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.5,{
v1.1.5,return false;
v1.1.5,}
v1.1.5,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.1.5,params.context->client.newTask();
v1.1.5,}
v1.1.5,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.1.5,params.context->client.WaitForCompletion(0);
v1.1.5,}
v1.1.5,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.1.5,{
v1.1.5,}
v1.1.5,parse command line
v1.1.5,Shell callbacks
v1.1.5,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.5,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.5,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.5,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.5,Add shell commands
v1.1.5,TODO: add WaitForCompletion command
v1.1.5,"TODO: add command line args help, arg count validation"
v1.1.5,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.5,Licensed under the MIT License.
v1.1.5,switch to explicit hover mode so that this is the fallback when
v1.1.5,move* commands are finished.
v1.1.5,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.1.5,60 acres park:
v1.1.5,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.1.5,marymoore park
v1.1.5,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,read settings and override defaults
v1.1.4,allow json overrides on a per-vehicle basis.
v1.1.4,start server in async mode
v1.1.4,check messages
v1.1.4,basic flight control
v1.1.4,camera control
v1.1.4,simGetImage returns compressed png in array of bytes
v1.1.4,image_type uses one of the AirSimImageType members
v1.1.4,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.4,camera control
v1.1.4,simGetImage returns compressed png in array of bytes
v1.1.4,image_type uses one of the AirSimImageType members
v1.1.4,helper method for converting getOrientation to roll/pitch/yaw
v1.1.4,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.1.4,roll (x-axis rotation)
v1.1.4,pitch (y-axis rotation)
v1.1.4,yaw (z-axis rotation)
v1.1.4,DEY: I don't know why this was there.
v1.1.4,data = np.flipud(data)
v1.1.4,reverse the vertical line order and add null bytes at the start
v1.1.4,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.1.4,query vehicle state
v1.1.4,def getRCData(self):
v1.1.4,return self.client.call('getRCData')
v1.1.4,APIs for control
v1.1.4,-----------------------------------  Car APIs ---------------------------------------------
v1.1.4,DEY: I don't know why this was there.
v1.1.4,data = np.flipud(data)
v1.1.4,In settings.json first activate computer vision mode:
v1.1.4,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.4,connect to the AirSim simulator
v1.1.4,go forward
v1.1.4,get state of the car
v1.1.4,connect to the AirSim simulator
v1.1.4,get camera images from the car
v1.1.4,that's enough fun for now. let's quite cleanly
v1.1.4,use open cv to show new images from AirSim
v1.1.4,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.4,pip install opencv-python
v1.1.4,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.4,use open cv to create point cloud from depth image.
v1.1.4,skip it
v1.1.4,AirSim uses NED coordinates so negative axis is up.
v1.1.4,z of -7 is 7 meters above the original launch point.
v1.1.4,Fly given velocity vector for 5 seconds
v1.1.4,using DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.1.4,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.1.4,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.1.4,AirSim uses NED coordinates so negative axis is up.
v1.1.4,z of -5 is 5 meters above the original launch point.
v1.1.4,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.1.4,this method is async and we are not waiting for the result since we are passing max_wait_seconds=0.
v1.1.4,connect to the AirSim simulator
v1.1.4,get state of the car
v1.1.4,go forward
v1.1.4,Go forward + steer right
v1.1.4,go reverse
v1.1.4,apply breaks
v1.1.4,get camera images from the car
v1.1.4,restore to original state
v1.1.4,In settings.json first activate computer vision mode:
v1.1.4,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.4,use open cv to show new images from AirSim
v1.1.4,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.4,pip install opencv-python
v1.1.4,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.1.4,get depth image
v1.1.4,"this will return png width= 256, height= 144"
v1.1.4,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.1.4,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.1.4,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.1.4,to get an estimate of distance.
v1.1.4,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.1.4,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.1.4,an angular delta of the following pi/10.
v1.1.4,"in header only mode, control library is not available"
v1.1.4,if using Unreal Build system then include precompiled header file first
v1.1.4,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.4,"Windows, OSX and Linux."
v1.1.4,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.1.4,Windows users can move the Documents folder to any location they want
v1.1.4,SHGetFolderPath knows how to find it.
v1.1.4,fall back in case SHGetFolderPath failed for some reason.
v1.1.4,convert from std::path '/' to windows backslash.
v1.1.4,make the current thread run with maximum priority.
v1.1.4,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.1.4,TODO: How to handle POSIX thread priorities on OSX?
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.1.4,
v1.1.4,Treat all errors as failure conditions.
v1.1.4,parse command line
v1.1.4,"motive gives a weird error if the project is not found, so we look for it."
v1.1.4,Do an update to pick up any recently-arrived cameras.
v1.1.4,List all detected cameras.
v1.1.4,List all defined rigid bodies.
v1.1.4,throttle to 50 messages per second.
v1.1.4,OptiTrack uses 'y' axis for vertical.
v1.1.4,stdafx.cpp : source file that includes just the standard includes
v1.1.4,MavlinkMoCap.pch will be the pre-compiled header
v1.1.4,stdafx.obj will contain the pre-compiled type information
v1.1.4,TODO: reference any additional headers you need in STDAFX.H
v1.1.4,and not in this file
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,PX4.cpp : Defines the entry point for the console application.
v1.1.4,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.1.4,how do you write to the debug output windows on Unix ?
v1.1.4,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.1.4,connection to create to talke to that server.
v1.1.4,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.1.4,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.1.4,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.1.4,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.1.4,using their the -qgc option.
v1.1.4,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.1.4,this switch controls whether we turn off the RC remote active link loss detection
v1.1.4,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.1.4,from kicking in when you try and fly.
v1.1.4,can't use experimental stuff on Linux because of potential ABI issues
v1.1.4,parse the json
v1.1.4,flatten inner mavlink object
v1.1.4,flatten inner mavlink object
v1.1.4,todo
v1.1.4,todo
v1.1.4,"const char* outLogFileOption = ""outlogfile"";"
v1.1.4,parse command line
v1.1.4,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.1.4,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.1.4,"no local serial connection, so this is the primary droneConnection."
v1.1.4,failed to connect
v1.1.4,"local connection, then we own sending the heartbeat."
v1.1.4,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.1.4,cmdTable.push_back(new AltHoldCommand());
v1.1.4,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.1.4,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.1.4,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.1.4,this stops us from being able to connect to SITL mode PX4.
v1.1.4,checkPulse();
v1.1.4,add command text in log
v1.1.4,close previous command.
v1.1.4,FilterLogFiles(logDirectory);
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,send a heartbeat
v1.1.4,accept one incoming connection
v1.1.4,send a heartbeat to the client
v1.1.4,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.1.4,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.1.4,for this unit test we are expecting a request to send an image.
v1.1.4,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.1.4,hmmm
v1.1.4,================ ls
v1.1.4,================ put file
v1.1.4,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.1.4,================ get file
v1.1.4,verify the file contents.
v1.1.4,================ remove file
v1.1.4,================ make directory
v1.1.4,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.1.4,================ remove directory
v1.1.4,Now verification
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,from main.cpp.
v1.1.4,you must call this method if you want HandleMessage to be called subsequently.
v1.1.4,treat literals as one word
v1.1.4,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.4,request gps info
v1.1.4,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.1.4,find relative position since command start so we can compare two commands better
v1.1.4,TODO: make below future proof (i.e. usable by C++17 compiler) - also change same in main.cpp
v1.1.4,can't use experimental stuff on Linux because of potential ABI issues
v1.1.4,"these PID values are important, so set these to match"
v1.1.4,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.1.4,we can skip ahead.
v1.1.4,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.1.4,TODO: avoid passing hadcoded HIL flag
v1.1.4,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.1.4,"The global position, as returned by the Global Positioning System (GPS)."
v1.1.4,Provides state for additional features
v1.1.4,The general system state
v1.1.4,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.4,Provides state for additional features
v1.1.4,The general system state
v1.1.4,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.4,Provides state for additional features
v1.1.4,The general system state
v1.1.4,Provides state for additional features
v1.1.4,The general system state
v1.1.4,note: we do not reset com when Close() is called because we want to keep running.
v1.1.4,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.4,generate random between 0 and 1
v1.1.4,move to range -1 to 1
v1.1.4,scale it
v1.1.4,apply iy
v1.1.4,wait for the Execute method to be called.
v1.1.4,gps is much slower frequency than IMU.
v1.1.4,MAVLINK_MSG_ID_HIL_GPS
v1.1.4,disable MAV_USEHILGPS
v1.1.4,note: we do not reset com when Close() is called because we want to keep running.
v1.1.4,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.4,generate random between 0 and 1
v1.1.4,move to range -1 to 1
v1.1.4,scale it
v1.1.4,apply iy
v1.1.4,wait for the Execute method to be called.
v1.1.4,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.1.4,gps is much slower frequency than IMU.
v1.1.4,MAVLINK_MSG_ID_HIL_GPS
v1.1.4,disable HIL mode
v1.1.4,Enumeration of landed detector states
v1.1.4,MAV landed state is unknown
v1.1.4,MAV is landed (on ground)
v1.1.4,MAV is in air
v1.1.4,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.1.4,The filtered local position
v1.1.4,must send these regularly to keep offboard control.
v1.1.4,"ok, now we can safely switch to loiter."
v1.1.4,must send these regularly to keep offboard control.
v1.1.4,integrate the heading so it is smoother.
v1.1.4,must send these regularly to keep offboard control.
v1.1.4,integrate the heading so it is smoother.
v1.1.4,fly to radius
v1.1.4,it takes about 10 cm to stop and turn.
v1.1.4,next time around switch to orbiting!
v1.1.4,heading points to center of circle.
v1.1.4,interpoloate the speed ramp up time over 2 seconds from start time
v1.1.4,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.1.4,monitor the sin curves so we can see how on track or off track it actually is.
v1.1.4,the shape of the curve will also tell us if we are progressing at a consistent
v1.1.4,"speed, the more deformed the sin curve the worse our progress."
v1.1.4,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.1.4,degrees just flipped from 359 to 0.
v1.1.4,this enables us to test what happens when offboard control is lost and resumed.
v1.1.4,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.1.4,"ok, now we can start moving by velocity"
v1.1.4,recompute to new target.
v1.1.4,start by moving right with 10 degree roll.
v1.1.4,haven't started yet.
v1.1.4,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.1.4,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.1.4,track how our actual pitch is coming along compared to our target
v1.1.4,and check position
v1.1.4,the amount of pitch should depend on our speed in that direction.
v1.1.4,passed the midpoint.
v1.1.4,fade out the pitch as we pick up speed so we don't overshoot.
v1.1.4,see if we just crossed the wiggle distance threshold.
v1.1.4,(pitch affects the x-position).
v1.1.4,reverse direction with a -30 degrees quick stop
v1.1.4,reverse direction with a 30 degrees quick stop
v1.1.4,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.1.4,too much in that direction.
v1.1.4,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.4,track how our actual roll is coming along compared to our target
v1.1.4,and check position
v1.1.4,the amount of roll should depend on our speed in that direction.
v1.1.4,passed the midpoint.
v1.1.4,fade out the roll as we pick up speed so we don't overshoot.
v1.1.4,see if we just crossed the wiggle distance threshold.
v1.1.4,(roll affects the y-position).
v1.1.4,reverse direction with a -30 degrees quick stop
v1.1.4,reverse direction with a 30 degrees quick stop
v1.1.4,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.1.4,too much in that direction.
v1.1.4,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.4,for testing PID controller.
v1.1.4,class AltHoldCommand : public Command
v1.1.4,{
v1.1.4,std::shared_ptr<MavLinkVehicle> channel;
v1.1.4,"float sx_, sy_, sz_;"
v1.1.4,MavLinkAttitudeTarget _current;
v1.1.4,PidController thrust_controller_;
v1.1.4,public:
v1.1.4,this->sz_ = pos.z; // user defined target.
v1.1.4,move to local position keeps the offboard control happy.
v1.1.4,haven't started yet.
v1.1.4,and check position
v1.1.4,double dx = this->sx_ - pos.x;
v1.1.4,double dy = this->sy_ - pos.y;
v1.1.4,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.1.4,too much in that direction.
v1.1.4,adjust thrust so we keep steady height target
v1.1.4,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.4,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.1.4,local remote
v1.1.4,already handled by the parse method.
v1.1.4,we only support very simple patterns for now.
v1.1.4,each wildcard must be separated by literal.
v1.1.4,back to back wildcards with no literal in between is too complex.
v1.1.4,"we only support simple matching for now, we can add full regex later if we need it."
v1.1.4,yep!
v1.1.4,'*' is done we found the next matching char
v1.1.4,this is ok.
v1.1.4,this is an ERASE_END_LINE command which we ignore.
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,unpack the message...
v1.1.4,pack the payload buffer.
v1.1.4,"json can't handle ""nan"", so we convert it to null."
v1.1.4,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.1.4,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,start listening to this connection
v1.1.4,Send heartbeat to drone.  You should not do this if some other node is
v1.1.4,already doing it.
v1.1.4,stop listening to the connection.
v1.1.4,get the connection
v1.1.4,Get the local system and component id
v1.1.4,send a command to the remote node
v1.1.4,MavLinkNode::MavLinkNode() = default;
v1.1.4,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.1.4,decrementing the count so the next WaitOne may block.
v1.1.4,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.1.4,convert to absolute time.
v1.1.4,use mach_timespec
v1.1.4,convert to absolute time.
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,return true if we still have offboard control (can lose this if user flips the switch).
v1.1.4,MavLinkVehicle::MavLinkVehicle() = default;
v1.1.4,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.1.4,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,============================== CLIENT ============================================
v1.1.4,image APIs
v1.1.4,or if you are implementing the client side call this function to get the most recent frame.
v1.1.4,returns false if there is no new frame available.
v1.1.4,============================== SERVER ============================================
v1.1.4,call this to send the image back over the connection given to start function.
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,"log every message that is ""sent"" using sendMessage."
v1.1.4,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.1.4,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.1.4,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.1.4,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,for compatibility with QGroundControl we have to save the time field in big endian.
v1.1.4,todo: mavlink2 support?
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,start listening to this connection
v1.1.4,Send heartbeat to drone.  You should not do this if some other node is
v1.1.4,already doing it.
v1.1.4,send a heart beat so that the remote node knows we are still alive
v1.1.4,(otherwise drone will trigger a failsafe operation).
v1.1.4,this is called for all messages received on the connection.
v1.1.4,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.1.4,subclasses remembering to call this base implementation.
v1.1.4,stop listening to the connection.
v1.1.4,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.4,wait for a heartbeat msg since this will give us the port to send commands to...
v1.1.4,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.1.4,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.4,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.4,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.4,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.4,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.4,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.4,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.1.4,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.1.4,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.1.4,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.1.4,"ok, now fetch the missing parameters."
v1.1.4,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.1.4,silently fail since we are on a background thread here...
v1.1.4,tell the caller this is complete.
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,add our custom telemetry message length.
v1.1.4,todo: if we support signing then initialize
v1.1.4,mavlink_intermediate_status_.signing callbacks
v1.1.4,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.1.4,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.4,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.4,send this right away just in case serial link is not already configured
v1.1.4,"log every message that is ""sent"" using sendMessage."
v1.1.4,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.1.4,pack the payload buffer.
v1.1.4,calculate checksum
v1.1.4,form the header as a byte array for the crc
v1.1.4,these macros use old style cast.
v1.1.4,forward messages from our connected node to the remote proxy.
v1.1.4,forward messages from remote proxy to local connected node
v1.1.4,CurrentThread::setMaximumPriority();
v1.1.4,"hmmm, wait till it is opened?"
v1.1.4,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.1.4,pick up the sysid/compid of the remote node we are connected to.
v1.1.4,then this is a mavlink 1 message
v1.1.4,then this mavlink sender supports mavlink 2
v1.1.4,queue event for publishing.
v1.1.4,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.1.4,as it ensures we don't lose messages if the listener is slow.
v1.1.4,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.1.4,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.1.4,we would get a deadlock.
v1.1.4,CurrentThread::setMaximumPriority();
v1.1.4,reset counters
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,------------------------------------------------------------------------------
v1.1.4,Defines
v1.1.4,------------------------------------------------------------------------------
v1.1.4,bit number  876543210987654321
v1.1.4,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.1.4,in future it would be good to have ability to add system IDs we are interested in
v1.1.4,if (msg.sysid != getTargetSystemId())
v1.1.4,{
v1.1.4,// we only care about messages from our intended remote node.
v1.1.4,return;
v1.1.4,}
v1.1.4,user may have changed modes on us! So we need to honor that and not
v1.1.4,try and take it back.
v1.1.4,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.1.4,we can store up to 16 channels in rc_channels_scaled.
v1.1.4,The RAW values of the servo outputs
v1.1.4,Metrics typically displayed on a HUD for fixed wing aircraft
v1.1.4,The IMU readings in SI units in NED body frame
v1.1.4,printSystemStatus(&msg);
v1.1.4,todo: use this to determine when we need to do emergency landing...
v1.1.4,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.1.4,Provides state for additional features
v1.1.4,The general system state
v1.1.4,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.1.4,but we do want to know when we get the ack.  So this is async ACK processing!
v1.1.4,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.1.4,if threshold < 0 then the threshold is inverted.
v1.1.4,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.1.4,Convert it to a floating point number between -1 and 1.
v1.1.4,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.1.4,until the move commands start happening.
v1.1.4,return true if user calls requestControl and has not called releaseControl.
v1.1.4,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.1.4,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.1.4,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.1.4,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.1.4,send a few to make sure it gets through...
v1.1.4,now the command should succeed.
v1.1.4,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.1.4,us by which time the PX4 times out offboard mode!!
v1.1.4,this mode change take precedence over offboard mode.
v1.1.4,thrust must be between -1 and 1.
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,These definitions are copied from PX4 implementation
v1.1.4,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.1.4,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.1.4,/ @brief Command opcodes
v1.1.4,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.1.4,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.4,must trim trailing slashes so PX4 doesn't hang!
v1.1.4,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.1.4,from the source.
v1.1.4,check if directory exists.
v1.1.4,perfect.
v1.1.4,use last_message_ so we preserve the sessionid.
v1.1.4,"could not create the local file, so stop."
v1.1.4,must use last_message_ so we preserve the session id.
v1.1.4,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.1.4,todo: error handling here? sequence is out of order...
v1.1.4,"directory must be empty then, can't do nextStep because"
v1.1.4,it will just loop for ever re-requesting zero offset into
v1.1.4,empty directory.
v1.1.4,result should be a list of null terminated file names.
v1.1.4,skipping this entry
v1.1.4,remove the file size field.
v1.1.4,"printf(""%s\n"", name.c_str());"
v1.1.4,request the next batch.
v1.1.4,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.4,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.4,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.1.4,reached the end of the list or the file.
v1.1.4,end of file or directory listing.
v1.1.4,"success, data should be following..."
v1.1.4,ack on this cmd is a noop
v1.1.4,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.1.4,give up then.
v1.1.4,tell watchdog we are sending a request
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,================================= CLIENT ==============================================================
v1.1.4,Check if we have a valid transaction
v1.1.4,emit signal if all packets arrived
v1.1.4,Restart statemachine
v1.1.4,image APIs
v1.1.4,================================= SERVER ==============================================================
v1.1.4,Prepare and send acknowledgment packet
v1.1.4,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.1.4,Send ENCAPSULATED_IMAGE packet
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.1.4,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.4,parse out the VID number
v1.1.4,now the PID
v1.1.4,parse out the VID number
v1.1.4,examples:
v1.1.4,PX4: USB\VID_26AC&PID_0011\0
v1.1.4,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.1.4,"printf(""Found: %S\n"", buffer.c_str());"
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.4,parse out the VID number
v1.1.4,now the PID
v1.1.4,parse out the VID number
v1.1.4,suppress
v1.1.4,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,This has not been properly tested
v1.1.4,struct iw_statistics stats;
v1.1.4,struct iwreq req;
v1.1.4,"memset(&stats, 0, sizeof(stats));"
v1.1.4,"memset(&req, 0, sizeof(iwreq));"
v1.1.4,
v1.1.4,"strncpy(req.ifr_name, ifaceName, 16);"
v1.1.4,req.u.data.pointer = &stats;
v1.1.4,req.u.data.length = sizeof(iw_statistics);
v1.1.4,
v1.1.4,#ifdef CLEAR_UPDATED
v1.1.4,req.u.data.flags = 1;
v1.1.4,#endif
v1.1.4,
v1.1.4,/* Perform the ioctl */
v1.1.4,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.1.4,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.1.4,return -127;
v1.1.4,}
v1.1.4,
v1.1.4,return stats.qual.level;
v1.1.4,todo: windows version of this...
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,windows
v1.1.4,Need to link with Ws2_32.lib
v1.1.4,posix
v1.1.4,found it!
v1.1.4,bind socket to local address.
v1.1.4,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.1.4,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.1.4,write to the serial port
v1.1.4,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.1.4,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.1.4,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.1.4,"try and receive something, up until port is closed anyway."
v1.1.4,"message was too large for the buffer, no problem, return what we have."
v1.1.4,try again - this can happen if server recreates the socket on their side.
v1.1.4,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.4,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.4,try again - this can happen if server recreates the socket on their side.
v1.1.4,"printf(""#### recv failed with error: %d\n"", hr);"
v1.1.4,we now have it.
v1.1.4,this is from someone we are not interested in.
v1.1.4,"printf(""Connection closed\n"");"
v1.1.4,-----------------------------------------------------------------------------------------
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,Initialize Winsock
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,windows
v1.1.4,Need to link with Ws2_32.lib
v1.1.4,posix
v1.1.4,found it!
v1.1.4,bind socket to local address.
v1.1.4,bind socket to local address.
v1.1.4,start listening for incoming connection
v1.1.4,accept 1
v1.1.4,write to the serial port
v1.1.4,"try and receive something, up until port is closed anyway."
v1.1.4,"message was too large for the buffer, no problem, return what we have."
v1.1.4,try again - this can happen if server recreates the socket on their side.
v1.1.4,"skip this, it is was interrupted."
v1.1.4,"printf(""Connection closed\n"");"
v1.1.4,-----------------------------------------------------------------------------------------
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.1.4,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.1.4,set signal
v1.1.4,Clear Handshake flags
v1.1.4,Set Handshake flags
v1.1.4,return GetLastError();
v1.1.4,return GetLastError();
v1.1.4,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.4,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.1.4,enable reading
v1.1.4,posix doesn't have mark/space parity.
v1.1.4,posix doesn't have mark/space parity.
v1.1.4,this is the default.
v1.1.4,not sure this is supported...
v1.1.4,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.1.4,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.4,First do those specified by POSIX.
v1.1.4,Now conditionally handle a bunch of extended rates.
v1.1.4,First do those specified by POSIX.
v1.1.4,Now conditionally handle a bunch of extended rates.
v1.1.4,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.4,","
v1.1.4,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.1.4,"std::unique_ptr<TestBase>(new RosFlightTest()),"
v1.1.4,"std::unique_ptr<TestBase>(new QuaternionTest()),"
v1.1.4,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,"in header only mode, control library is not available"
v1.1.4,TODO: something defines max macro which interfears with code here
v1.1.4,is cur_pos within fence?
v1.1.4,destination risk is not available then consider it zero
v1.1.4,if dest risk is lower than its more safe
v1.1.4,are we doing better than closest obstacle?
v1.1.4,"if we stay where we are, what is the risk distance?"
v1.1.4,else we are better of moving to dest
v1.1.4,this function should work even when dest_pos == cur_pos
v1.1.4,is this dest_pos cur_pos within the fence?
v1.1.4,transform dest_pos vector to body frame
v1.1.4,check for approx zero vectors to avoid random yaw angles
v1.1.4,we are hovering
v1.1.4,"get yaw in body frame, ie, front is always 0 radians"
v1.1.4,yaw to ticks
v1.1.4,get obstacles in the window at the tick direction around the window
v1.1.4,less risk distance is better
v1.1.4,check obstacles around current position and see if it has lower risk
v1.1.4,else obstacle is too far
v1.1.4,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.1.4,look for each surrounding tick to see if we have obstacle free angle
v1.1.4,else no suggestions required
v1.1.4,"3.2 comes from inverse CDF for epsilone = 0.05 (i.e. 95% confidence), author: akapoor"
v1.1.4,evaluate right and left side of circle
v1.1.4,find right and left risk distances
v1.1.4,at this point we have already determined hover is better than going to dest
v1.1.4,we now determine is moving to suggested angle better than hovering?
v1.1.4,check if dest_pos is safe
v1.1.4,breaking distance at this velocity
v1.1.4,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.1.4,check if dest_pos is safe
v1.1.4,float/vec parameters can have NaN which makes them optional
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,"in header only mode, control library is not available"
v1.1.4,handles +/- tick and wraps around circle
v1.1.4,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.1.4,update the specified window on the map
v1.1.4,make dure from <= to
v1.1.4,normalize the ticks so bothe are valid indices
v1.1.4,if from is still larger then
v1.1.4,to ticks is then added one full circle to make it larger than from_tick
v1.1.4,find closest obstacle in given window
v1.1.4,search whole map to find closest obstacle
v1.1.4,"in header only mode, control library is not available"
v1.1.4,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.4,"Windows, OSX and Linux."
v1.1.4,Windows users can move the Documents folder to any location they want
v1.1.4,SHGetFolderPath knows how to find it.
v1.1.4,fall back in case SHGetFolderPath failed for some reason.
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,"in header only mode, control library is not available"
v1.1.4,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.4,if using Unreal Build system then include precompiled header file first
v1.1.4,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.4,#undef check
v1.1.4,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.4,sim only
v1.1.4,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.4,required for pimpl
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,"in header only mode, control library is not available"
v1.1.4,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.4,if using Unreal Build system then include precompiled header file first
v1.1.4,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.1.4,sim only
v1.1.4,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.4,make sure we can talk to the DroneServer
v1.1.4,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.1.4,command_context.client.ping();
v1.1.4,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,"in header only mode, control library is not available"
v1.1.4,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.4,if using Unreal Build system then include precompiled header file first
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,"in header only mode, control library is not available"
v1.1.4,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.4,if using Unreal Build system then include precompiled header file first
v1.1.4,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.4,#undef check
v1.1.4,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.4,required for pimpl
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,"in header only mode, control library is not available"
v1.1.4,if auto mode requested for lookahead then calculate based on velocity
v1.1.4,no-op by default. derived class can override it if needed
v1.1.4,no-op by default. derived class can override it if needed
v1.1.4,validate path size
v1.1.4,validate yaw mode
v1.1.4,validate and set auto-lookahead value
v1.1.4,if auto mode requested for lookahead then calculate based on velocity
v1.1.4,add current position as starting point
v1.1.4,append the input path and compute segments
v1.1.4,add last segment as zero length segment so we have equal number of segments and points.
v1.1.4,path_segs[i] refers to segment that starts at point i
v1.1.4,"when path ends, we want to slow down"
v1.1.4,else no need to change velocities for last segments
v1.1.4,setup current position on path to 0 offset
v1.1.4,initialize next path position
v1.1.4,until we are at the end of the path (last seg is always zero size)
v1.1.4,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.1.4,send drone command to get to next lookahead
v1.1.4,sleep for rest of the cycle
v1.1.4,how much have we moved towards last goal?
v1.1.4,project actual vector on goal vector
v1.1.4,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.1.4,TODO: below should be lower than 1E3 and configurable
v1.1.4,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.1.4,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.1.4,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.1.4,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.1.4,"if drone moved backward, we don't want goal to move backward as well"
v1.1.4,"so only climb forward on the path, never back. Also note >= which means"
v1.1.4,we climb path even if distance was 0 to take care of duplicated points on path
v1.1.4,else
v1.1.4,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.1.4,compute next target on path
v1.1.4,last command is to hold on to position
v1.1.4,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.1.4,default strategy is for move. In hover mode we set new strategy temporarily
v1.1.4,freeze the quaternion
v1.1.4,get trims
v1.1.4,take average
v1.1.4,convert RC commands to velocity vector
v1.1.4,find yaw as per terrain and remote setting
v1.1.4,execute command
v1.1.4,Only raise exception is time out occurred. If preempted then return status.
v1.1.4,are we supposed to do EM?
v1.1.4,get suggested velocity vector
v1.1.4,use the unchecked command
v1.1.4,tell caller not to execute planned command
v1.1.4,other wise throw exception
v1.1.4,otherwise there is some other reason why we are in unsafe situation
v1.1.4,send last command to come to full stop
v1.1.4,else no unsafe situation
v1.1.4,note: cur_path_loc and next_path_loc may both point to same object
v1.1.4,"otherwise use up this segment, move on to next one"
v1.1.4,if we are here then we ran out of segments
v1.1.4,consider last segment as zero length segment
v1.1.4,adjust yaw for the direction of travel in foward-only mode
v1.1.4,else no adjustment needed
v1.1.4,validate dest
v1.1.4,what is the distance we will travel at this velocity?
v1.1.4,get velocity vector
v1.1.4,yaw for the direction of travel
v1.1.4,find velocity vector
v1.1.4,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.1.4,generate velocity vector that is same size as cur_dest_norm / command period
v1.1.4,this velocity vect when executed for command period would yield cur_dest_norm
v1.1.4,send commands
v1.1.4,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.1.4,by default indicate that we don't have alternative pose info
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,"in header only mode, control library is not available"
v1.1.4,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.4,if using Unreal Build system then include precompiled header file first
v1.1.4,status getters
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,"in header only mode, control library is not available"
v1.1.4,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.4,if using Unreal Build system then include precompiled header file first
v1.1.4,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.4,#undef check
v1.1.4,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.4,getters
v1.1.4,required for pimpl
v1.1.4,Create a spring arm component for our chase camera
v1.1.4,do nothing
v1.1.4,set initial view mode
v1.1.4,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.1.4,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.1.4,"If the lag is missing, the camera will also occasionally shake."
v1.1.4,"But, lag is not desired when piloting a drone"
v1.1.4,attach spring arm to actor
v1.1.4,remember current parent for external camera. Later when we remove external
v1.1.4,"camera from spring arm, we will attach it back to its last parent"
v1.1.4,now attach camera to spring arm
v1.1.4,"For car, we need to move the camera back a little more than for a drone."
v1.1.4,"Otherwise, the camera will be stuck inside the car"
v1.1.4,external_camera_->bUsePawnControlRotation = false;
v1.1.4,"else someone else is bound to manual pose controller, leave it alone"
v1.1.4,TODO: explore screenshot option
v1.1.4,addScreenCaptureHandler(camera->GetWorld());
v1.1.4,Wait for render so that view is ready for capture
v1.1.4,not sure why this doesn't work.
v1.1.4,"DECLARE_CYCLE_STAT(TEXT(""FNullGraphTask.CheckRenderStatus""), STAT_FNullGraphTask_CheckRenderStatus, STATGROUP_TaskGraphTasks);"
v1.1.4,"auto renderStatus = TGraphTask<FNullGraphTask>::CreateTask(NULL).ConstructAndDispatchWhenReady(GET_STATID(STAT_FNullGraphTask_CheckRenderStatus), ENamedThreads::RenderThread);"
v1.1.4,FTaskGraphInterface::Get().WaitUntilTaskCompletes(renderStatus);
v1.1.4,Make sure that all alpha values are opaque.
v1.1.4,Deflect along the surface when we collide.
v1.1.4,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.1.4,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.1.4,set up key variables
v1.1.4,initialize state
v1.1.4,should be overridden in derived class
v1.1.4,should be overridden in derived class
v1.1.4,TODO: delete below
v1.1.4,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.4,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.4,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.4,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.4,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.1.4,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.4,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.1.4,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.4,parameters in NED frame
v1.1.4,translate to new VehiclePawnWrapper position & orientation from NED to NEU
v1.1.4,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.1.4,must reset collision before we set pose. Setting pose will immediately call NotifyHit if there was collision
v1.1.4,"if there was no collision than has_collided would remain false, else it will be set so its value can be"
v1.1.4,checked at the start of next tick
v1.1.4,allow teleportation
v1.1.4,if collisions are not enabled
v1.1.4,or we have collided but passthrough is enabled
v1.1.4,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.1.4,"without flip flopping, collisions can't be detected"
v1.1.4,set default for brigher images
v1.1.4,by default all image types are disabled
v1.1.4,use final color for all calculations
v1.1.4,use final color for all calculations
v1.1.4,else we will set this after this components get created
v1.1.4,else we will set this after this components get created
v1.1.4,do not make unnecessory calls to Activate() which otherwise causes crash in Unreal
v1.1.4,else nothing to enable
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,TODO: change naming conventions to same as other files?
v1.1.4,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.1.4,mesh->SetRenderCustomDepth(false);
v1.1.4,mesh->SetRenderCustomDepth(true);
v1.1.4,mesh->SetVisibility(false);
v1.1.4,mesh->SetVisibility(true);
v1.1.4,if (! is_name_regex)
v1.1.4,return true;
v1.1.4,Access the subclass instance with the * or -> operators.
v1.1.4,can we see followee?
v1.1.4,remove mapping
v1.1.4,removing binding
v1.1.4,"TODO: can't do remove because there is no ""stamp"" on who established binding"
v1.1.4,removeInputBindings();
v1.1.4,#ifdef _MSC_VER
v1.1.4,//print to VS output window
v1.1.4,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.1.4,#endif
v1.1.4,also do default logging
v1.1.4,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.1.4,UGameUserSettings* game_settings = GetGameUserSettings();
v1.1.4,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.1.4,game_settings->ApplySettings(true);
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,plugin startup
v1.1.4,plugin shutdown
v1.1.4,"read pixels from render target using render thread, then compress the result into PNG"
v1.1.4,argument on the thread that calls this method.
v1.1.4,make sure we are not on the rendering thread
v1.1.4,TODO: below doesn't work right now because it must be running in game thread
v1.1.4,below is documented method but more expensive because it forces flush
v1.1.4,wait for render thread to pick up our task
v1.1.4,Queue up the task of rendering the scene in the render thread
v1.1.4,wait for this task to complete
v1.1.4,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.1.4,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.1.4,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.1.4,Stuff to filter out XInput devices
v1.1.4,-----------------------------------------------------------------------------
v1.1.4,"Defines, constants, and global variables"
v1.1.4,-----------------------------------------------------------------------------
v1.1.4,Register with the DirectInput subsystem and get a pointer
v1.1.4,to a IDirectInput interface we can use.
v1.1.4,Create a DInput object
v1.1.4,Look for a simple joystick we can use for this sample program.
v1.1.4,Make sure we got a joystick
v1.1.4,"Set the data format to ""simple joystick"" - a predefined data format"
v1.1.4,
v1.1.4,"A data format specifies which controls on a device we are interested in,"
v1.1.4,and how they should be reported. This tells DInput that we will be
v1.1.4,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.1.4,Set the cooperative level to let DInput know how this device should
v1.1.4,interact with the system and with other DInput applications.
v1.1.4,Enumerate the joystick objects. The callback function enabled user
v1.1.4,"interface elements for objects that are found, and sets the min/max"
v1.1.4,values property for discovered axes.
v1.1.4,-----------------------------------------------------------------------------
v1.1.4,Enum each PNP device using WMI and check each device ID to see if it contains
v1.1.4,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then its an XInput device"
v1.1.4,Unfortunately this information can not be found by just using DirectInput.
v1.1.4,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.1.4,XInput devices.
v1.1.4,
v1.1.4,This function stores the list of xinput devices in a linked list
v1.1.4,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.1.4,-----------------------------------------------------------------------------
v1.1.4,CoInit if needed
v1.1.4,Create WMI
v1.1.4,Create BSTRs for WMI
v1.1.4,Connect to WMI
v1.1.4,Switch security level to IMPERSONATE
v1.1.4,Get list of Win32_PNPEntity devices
v1.1.4,Loop over all devices
v1.1.4,Get 20 at a time
v1.1.4,"For each device, get its device ID"
v1.1.4,"Check if the device ID contains ""IG_"".  If it does, then its an XInput device"
v1.1.4,Unfortunately this information can not be found by just using DirectInput
v1.1.4,"If it does, then get the VID/PID from var.bstrVal"
v1.1.4,Add the VID/PID to a linked list
v1.1.4,-----------------------------------------------------------------------------
v1.1.4,Returns true if the DirectInput device is also an XInput device.
v1.1.4,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.1.4,-----------------------------------------------------------------------------
v1.1.4,Check each xinput device to see if this device's vid/pid matches
v1.1.4,-----------------------------------------------------------------------------
v1.1.4,Cleanup needed for IsXInputDevice()
v1.1.4,-----------------------------------------------------------------------------
v1.1.4,Cleanup linked list
v1.1.4,-----------------------------------------------------------------------------
v1.1.4,Name: EnumJoysticksCallback()
v1.1.4,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.1.4,device interface on it so we can play with it.
v1.1.4,-----------------------------------------------------------------------------
v1.1.4,Skip anything other than the perferred joystick device as defined by the control panel.
v1.1.4,Instead you could store all the enumerated joysticks and let the user pick.
v1.1.4,Obtain an interface to the enumerated joystick.
v1.1.4,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.1.4,it while we were in the middle of enumerating it.)
v1.1.4,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.1.4,could store all the enumerated joysticks and let the user pick.
v1.1.4,-----------------------------------------------------------------------------
v1.1.4,Name: EnumObjectsCallback()
v1.1.4,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.1.4,joystick. This function enables user interface elements for objects
v1.1.4,"that are found to exist, and scales axes min/max values."
v1.1.4,-----------------------------------------------------------------------------
v1.1.4,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.1.4,enumerated axis in order to scale min/max values.
v1.1.4,Set the range for the axis
v1.1.4,Set the UI to reflect what objects the joystick supports
v1.1.4,-----------------------------------------------------------------------------
v1.1.4,Name: UpdateInputState()
v1.1.4,Desc: Get the input device's state and display it.
v1.1.4,-----------------------------------------------------------------------------
v1.1.4,Poll the device to read the current state
v1.1.4,DInput is telling us that the input stream has been
v1.1.4,"interrupted. We aren't tracking any state between polls, so"
v1.1.4,we don't have any special reset that needs to be done. We
v1.1.4,just re-acquire and try again.
v1.1.4,while (hr == DIERR_INPUTLOST)
v1.1.4,hr = g_pJoystick->Acquire();
v1.1.4,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.1.4,may occur when the app is minimized or in the process of
v1.1.4,"switching, so just try again later"
v1.1.4,Get the input's device state
v1.1.4,Axes
v1.1.4,Slider controls
v1.1.4,Points of view
v1.1.4,Buttons
v1.1.4,-----------------------------------------------------------------------------
v1.1.4,Name: FreeDirectInput()
v1.1.4,Desc: Initialize the DirectInput variables.
v1.1.4,-----------------------------------------------------------------------------
v1.1.4,Unacquire the device one last time just in case
v1.1.4,the app tried to exit while the device is still acquired.
v1.1.4,Release any DirectInput objects.
v1.1.4,nop
v1.1.4,normalize min to max --> 0 to 1
v1.1.4,normalize 0 to 1 --> -1 to 1
v1.1.4,implementation for unsupported OS
v1.1.4,if this is new indec
v1.1.4,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.1.4,close previos one
v1.1.4,open new device
v1.1.4,if open was sucessfull
v1.1.4,read the device
v1.1.4,if we didn't had valid read
v1.1.4,"NOTE if this condition is not met, we're probably out of sync and this"
v1.1.4,Joystick instance is likely unusable
v1.1.4,TODO: set below to false?
v1.1.4,state.is_valid = false;
v1.1.4,else ignore
v1.1.4,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.1.4,{
v1.1.4,"manufacturerID = productID = """";"
v1.1.4,// Use udev to look up the product and manufacturer IDs
v1.1.4,struct udev *udev = udev_new();
v1.1.4,if (udev) {
v1.1.4,char sysname[32];
v1.1.4,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.1.4,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.1.4,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.1.4,if (!dev)
v1.1.4,{
v1.1.4,"message = ""Unable to find parent USB device"";"
v1.1.4,return false;
v1.1.4,}
v1.1.4,std::stringstream ss;
v1.1.4,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.1.4,ss >> manufacturerID;
v1.1.4,ss.clear();
v1.1.4,"ss.str("""");"
v1.1.4,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.1.4,ss >> productID;
v1.1.4,udev_device_unref(dev);
v1.1.4,}
v1.1.4,else
v1.1.4,{
v1.1.4,"message = ""Cannot create udev"";"
v1.1.4,return false;
v1.1.4,}
v1.1.4,udev_unref(udev);
v1.1.4,return true;
v1.1.4,}
v1.1.4,required for pimpl
v1.1.4,TODO: should we only do below on SceneCapture2D components and cameras?
v1.1.4,avoid motion blur so capture images don't get
v1.1.4,use two different methods to set console var because sometime it doesn't seem to work
v1.1.4,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.1.4,create main widget
v1.1.4,synchronize PIP views
v1.1.4,setup defaults
v1.1.4,TODO: should this be done somewhere else?
v1.1.4,load settings file if found
v1.1.4,create default settings
v1.1.4,"write some settings in new file otherwise the string ""null"" is written if all settigs are empty"
v1.1.4,TODO: there is a crash in Linux due to settings.saveJSonString(). Remove this workaround after we only support Unreal 4.17
v1.1.4,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.1.4,create its control server
v1.1.4,stop physics thread before we dismental
v1.1.4,for (AActor* actor : spawned_actors_) {
v1.1.4,actor->Destroy();
v1.1.4,}
v1.1.4,get player controller
v1.1.4,put camera little bit above vehicle
v1.1.4,we will either find external camera if it already exist in evironment or create one
v1.1.4,find all BP camera directors in the environment
v1.1.4,create director
v1.1.4,create external camera required for the director
v1.1.4,find all vehicle pawns
v1.1.4,if no vehicle pawns exists in environment
v1.1.4,create vehicle pawn
v1.1.4,set up vehicle pawns
v1.1.4,initialize each vehicle pawn we found
v1.1.4,chose first pawn as FPV if none is designated as FPV
v1.1.4,now create the connector for each pawn
v1.1.4,else we don't have vehicle for this pawn
v1.1.4,TODO: because this bug we are using alternative code with stringstream
v1.1.4,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.1.4,std::stringstream ss;
v1.1.4,"ss << timestamp_millis << ""\t"";"
v1.1.4,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.1.4,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.1.4,"ss << ""\n"";"
v1.1.4,return ss.str();
v1.1.4,find vehicles and cameras available in environment
v1.1.4,if none available then we will create one
v1.1.4,get references of components so we can use later
v1.1.4,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.1.4,-1 to 1 --> 0 to 1
v1.1.4,convert 0 to 1 -> -1 to 1
v1.1.4,TODO: add fields for z axis?
v1.1.4,last 8 bits are not used for now
v1.1.4,TODO: should below be at controller level info?
v1.1.4,else don't waste time
v1.1.4,"Utils::log(""------Render tick-------"");"
v1.1.4,move collision info from rendering engine to vehicle
v1.1.4,update ground level
v1.1.4,update rotor poses
v1.1.4,update rotor animations
v1.1.4,"UAirBlueprintLib::LogMessage(TEXT(""Collision (raw) Count:""), FString::FromInt(collision_response_info.collision_count_raw), LogDebugLevel::Unimportant);"
v1.1.4,*** Start: UpdatableState implementation ***//
v1.1.4,TODO: should this be done in MultiRotor.hpp
v1.1.4,controller_->reset();
v1.1.4,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.1.4,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.1.4,*** End: UpdatableState implementation ***//
v1.1.4,"If render command is complete, save image along with position and orientation"
v1.1.4,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.1.4,make sire all vars are set up
v1.1.4,"todo: should we go as fast as possible, or should we limit this to a particular number of"
v1.1.4,frames per second?
v1.1.4,Try to find the high polycount vehicle
v1.1.4,"If not found, spawn the default class (go-kart)"
v1.1.4,Timestamp \t Speed \t Throttle \t Steering \t Brake \t gear \t ImageName
v1.1.4,get player controller
v1.1.4,put camera little bit above vehicle
v1.1.4,we will either find external camera if it already exist in evironment or create one
v1.1.4,find all BP camera directors in the environment
v1.1.4,create director
v1.1.4,create external camera required for the director
v1.1.4,find all vehicle pawns
v1.1.4,if no vehicle pawns exists in environment
v1.1.4,create vehicle pawn
v1.1.4,set up vehicle pawns
v1.1.4,initialize each vehicle pawn we found
v1.1.4,chose first pawn as FPV if none is designated as FPV
v1.1.4,find vehicles and cameras available in environment
v1.1.4,if none available then we will create one
v1.1.4,find all vehicle pawns
v1.1.4,set up vehicle pawns
v1.1.4,initialize each vehicle pawn we found
v1.1.4,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.4,Setup suspension forces
v1.1.4,Find the tire object and set the data for it
v1.1.4,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.4,Setup suspension forces
v1.1.4,Find the tire object and set the data for it
v1.1.4,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.4,Needed for VR Headset
v1.1.4,this->AutoReceiveInput = EAutoReceiveInput::Player0;
v1.1.4,Car mesh
v1.1.4,Setup friction materials
v1.1.4,Wheels/Tyres
v1.1.4,Setup the wheels
v1.1.4,Adjust the tire loading
v1.1.4,Engine
v1.1.4,Torque setup
v1.1.4,Adjust the steering
v1.1.4,Transmission
v1.1.4,We want 4wd
v1.1.4,Drive the front wheels a little more than the rear
v1.1.4,Automatic gearbox
v1.1.4,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.1.4,Physics settings
v1.1.4,Adjust the center of mass - the buggy is quite low
v1.1.4,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.1.4,Create In-Car camera component
v1.1.4,In car HUD
v1.1.4,Create text render component for in car speed display
v1.1.4,Create text render component for in car gear display
v1.1.4,Setup the audio component and allocate it a sound cue
v1.1.4,Colors for the in-car gear display. One for normal one for reverse
v1.1.4,put camera little bit above vehicle
v1.1.4,below is not needed
v1.1.4,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::OnReversePressed, true);"
v1.1.4,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::OnReverseReleased, false);"
v1.1.4,TODO: update other fields
v1.1.4,Setup the flag to say we are in reverse gear
v1.1.4,Update phsyics material
v1.1.4,Update the strings used in the hud (incar and onscreen)
v1.1.4,Set the string in the incar hud
v1.1.4,Pass the engine RPM to the sound component
v1.1.4,Start an engine sound playing
v1.1.4,Using FText because this is display text that should be localizable
v1.1.4,Setup the text render component strings
v1.1.4,Timestamp \t Speed \t Throttle \t Steering \t Brake \t gear
v1.1.4,timestamp
v1.1.4,Speed
v1.1.4,Gear
v1.1.4,call virtual method in derived class
v1.1.4,remove everything that we created in BeginPlay
v1.1.4,perfom any expensive rendering update outside of lock region
v1.1.4,should be overridden by derived class
v1.1.4,Unreal doesn't allow pure abstract methods in actors
v1.1.4,set defaults in case exception occurs
v1.1.4,we had spelling mistake so we are currently supporting SettingsVersion or SettingdVersion :(
v1.1.4,no warnings because we have default settings
v1.1.4,by default we spawn server at local endpoint. Do not use 127.0.0.1 as default below
v1.1.4,because for docker container default is 0.0.0.0 and people get really confused why things
v1.1.4,don't work
v1.1.4,By default this is the column header. Override it in BeginPlay of pawn mode
v1.1.4,Should be overridden by derived classes
v1.1.4,Should be overridden by derived classes
v1.1.4,Should be overridden by derived classes
v1.1.4,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,This assumes you are running DroneServer already on the same machine.
v1.1.4,DroneServer must be running first.
v1.1.4,enable API control
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,move commands
v1.1.4,else leave as it is
v1.1.4,TODO: get these in one call
v1.1.4,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.1.4,TODO: shouldn't we pass folder path?
v1.1.4,parse
v1.1.4,group the images by the current date.
v1.1.4,"std::string beforeScriptStartCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.4,{
v1.1.4,"return """";"
v1.1.4,}
v1.1.4,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.4,{
v1.1.4,return false;
v1.1.4,}
v1.1.4,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.1.4,params.context->client.newTask();
v1.1.4,}
v1.1.4,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.1.4,params.context->client.WaitForCompletion(0);
v1.1.4,}
v1.1.4,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.1.4,{
v1.1.4,}
v1.1.4,parse command line
v1.1.4,Shell callbacks
v1.1.4,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.4,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.4,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.4,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.4,Add shell commands
v1.1.4,TODO: add WaitForCompletion command
v1.1.4,"TODO: add command line args help, arg count validation"
v1.1.4,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.4,Licensed under the MIT License.
v1.1.4,switch to explicit hover mode so that this is the fallback when
v1.1.4,move* commands are finished.
v1.1.4,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.1.4,60 acres park:
v1.1.4,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.1.4,marymoore park
v1.1.4,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,read settings and override defaults
v1.1.3,allow json overrides on a per-vehicle basis.
v1.1.3,start server in async mode
v1.1.3,check messages
v1.1.3,basic flight control
v1.1.3,camera control
v1.1.3,simGetImage returns compressed png in array of bytes
v1.1.3,image_type uses one of the AirSimImageType members
v1.1.3,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.3,camera control
v1.1.3,simGetImage returns compressed png in array of bytes
v1.1.3,image_type uses one of the AirSimImageType members
v1.1.3,helper method for converting getOrientation to roll/pitch/yaw
v1.1.3,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.1.3,roll (x-axis rotation)
v1.1.3,pitch (y-axis rotation)
v1.1.3,yaw (z-axis rotation)
v1.1.3,DEY: I don't know why this was there.
v1.1.3,data = np.flipud(data)
v1.1.3,reverse the vertical line order and add null bytes at the start
v1.1.3,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.1.3,query vehicle state
v1.1.3,def getRCData(self):
v1.1.3,return self.client.call('getRCData')
v1.1.3,APIs for control
v1.1.3,-----------------------------------  Car APIs ---------------------------------------------
v1.1.3,DEY: I don't know why this was there.
v1.1.3,data = np.flipud(data)
v1.1.3,In settings.json first activate computer vision mode:
v1.1.3,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.3,connect to the AirSim simulator
v1.1.3,get camera images from the car
v1.1.3,that's enough fun for now. let's quite cleanly
v1.1.3,use open cv to show new images from AirSim
v1.1.3,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.3,pip install opencv-python
v1.1.3,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.3,use open cv to create point cloud from depth image.
v1.1.3,skip it
v1.1.3,AirSim uses NED coordinates so negative axis is up.
v1.1.3,z of -7 is 7 meters above the original launch point.
v1.1.3,Fly given velocity vector for 5 seconds
v1.1.3,using DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.1.3,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.1.3,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.1.3,AirSim uses NED coordinates so negative axis is up.
v1.1.3,z of -5 is 5 meters above the original launch point.
v1.1.3,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.1.3,this method is async and we are not waiting for the result since we are passing max_wait_seconds=0.
v1.1.3,connect to the AirSim simulator
v1.1.3,get state of the car
v1.1.3,go forward
v1.1.3,Go forward + steer right
v1.1.3,go reverse
v1.1.3,apply breaks
v1.1.3,get camera images from the car
v1.1.3,restore to original state
v1.1.3,In settings.json first activate computer vision mode:
v1.1.3,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.3,use open cv to show new images from AirSim
v1.1.3,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.3,pip install opencv-python
v1.1.3,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.1.3,get depth image
v1.1.3,"this will return png width= 256, height= 144"
v1.1.3,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.1.3,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.1.3,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.1.3,to get an estimate of distance.
v1.1.3,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.1.3,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.1.3,an angular delta of the following pi/10.
v1.1.3,"in header only mode, control library is not available"
v1.1.3,if using Unreal Build system then include precompiled header file first
v1.1.3,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.3,"Windows, OSX and Linux."
v1.1.3,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.1.3,Windows users can move the Documents folder to any location they want
v1.1.3,SHGetFolderPath knows how to find it.
v1.1.3,fall back in case SHGetFolderPath failed for some reason.
v1.1.3,convert from std::path '/' to windows backslash.
v1.1.3,make the current thread run with maximum priority.
v1.1.3,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.1.3,TODO: How to handle POSIX thread priorities on OSX?
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.1.3,
v1.1.3,Treat all errors as failure conditions.
v1.1.3,parse command line
v1.1.3,"motive gives a weird error if the project is not found, so we look for it."
v1.1.3,Do an update to pick up any recently-arrived cameras.
v1.1.3,List all detected cameras.
v1.1.3,List all defined rigid bodies.
v1.1.3,throttle to 50 messages per second.
v1.1.3,OptiTrack uses 'y' axis for vertical.
v1.1.3,stdafx.cpp : source file that includes just the standard includes
v1.1.3,MavlinkMoCap.pch will be the pre-compiled header
v1.1.3,stdafx.obj will contain the pre-compiled type information
v1.1.3,TODO: reference any additional headers you need in STDAFX.H
v1.1.3,and not in this file
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,PX4.cpp : Defines the entry point for the console application.
v1.1.3,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.1.3,how do you write to the debug output windows on Unix ?
v1.1.3,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.1.3,connection to create to talke to that server.
v1.1.3,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.1.3,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.1.3,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.1.3,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.1.3,using their the -qgc option.
v1.1.3,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.1.3,this switch controls whether we turn off the RC remote active link loss detection
v1.1.3,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.1.3,from kicking in when you try and fly.
v1.1.3,can't use experimental stuff on Linux because of potential ABI issues
v1.1.3,parse the json
v1.1.3,flatten inner mavlink object
v1.1.3,flatten inner mavlink object
v1.1.3,todo
v1.1.3,todo
v1.1.3,"const char* outLogFileOption = ""outlogfile"";"
v1.1.3,parse command line
v1.1.3,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.1.3,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.1.3,"no local serial connection, so this is the primary droneConnection."
v1.1.3,failed to connect
v1.1.3,"local connection, then we own sending the heartbeat."
v1.1.3,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.1.3,cmdTable.push_back(new AltHoldCommand());
v1.1.3,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.1.3,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.1.3,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.1.3,this stops us from being able to connect to SITL mode PX4.
v1.1.3,checkPulse();
v1.1.3,add command text in log
v1.1.3,close previous command.
v1.1.3,FilterLogFiles(logDirectory);
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,send a heartbeat
v1.1.3,accept one incoming connection
v1.1.3,send a heartbeat to the client
v1.1.3,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.1.3,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.1.3,for this unit test we are expecting a request to send an image.
v1.1.3,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.1.3,hmmm
v1.1.3,================ ls
v1.1.3,================ put file
v1.1.3,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.1.3,================ get file
v1.1.3,verify the file contents.
v1.1.3,================ remove file
v1.1.3,================ make directory
v1.1.3,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.1.3,================ remove directory
v1.1.3,Now verification
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,from main.cpp.
v1.1.3,you must call this method if you want HandleMessage to be called subsequently.
v1.1.3,treat literals as one word
v1.1.3,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.3,request gps info
v1.1.3,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.1.3,find relative position since command start so we can compare two commands better
v1.1.3,TODO: make below future proof (i.e. usable by C++17 compiler) - also change same in main.cpp
v1.1.3,can't use experimental stuff on Linux because of potential ABI issues
v1.1.3,"these PID values are important, so set these to match"
v1.1.3,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.1.3,we can skip ahead.
v1.1.3,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.1.3,TODO: avoid passing hadcoded HIL flag
v1.1.3,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.1.3,"The global position, as returned by the Global Positioning System (GPS)."
v1.1.3,Provides state for additional features
v1.1.3,The general system state
v1.1.3,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.3,Provides state for additional features
v1.1.3,The general system state
v1.1.3,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.3,Provides state for additional features
v1.1.3,The general system state
v1.1.3,Provides state for additional features
v1.1.3,The general system state
v1.1.3,note: we do not reset com when Close() is called because we want to keep running.
v1.1.3,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.3,generate random between 0 and 1
v1.1.3,move to range -1 to 1
v1.1.3,scale it
v1.1.3,apply iy
v1.1.3,wait for the Execute method to be called.
v1.1.3,gps is much slower frequency than IMU.
v1.1.3,MAVLINK_MSG_ID_HIL_GPS
v1.1.3,disable MAV_USEHILGPS
v1.1.3,note: we do not reset com when Close() is called because we want to keep running.
v1.1.3,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.3,generate random between 0 and 1
v1.1.3,move to range -1 to 1
v1.1.3,scale it
v1.1.3,apply iy
v1.1.3,wait for the Execute method to be called.
v1.1.3,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.1.3,gps is much slower frequency than IMU.
v1.1.3,MAVLINK_MSG_ID_HIL_GPS
v1.1.3,disable HIL mode
v1.1.3,Enumeration of landed detector states
v1.1.3,MAV landed state is unknown
v1.1.3,MAV is landed (on ground)
v1.1.3,MAV is in air
v1.1.3,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.1.3,The filtered local position
v1.1.3,must send these regularly to keep offboard control.
v1.1.3,"ok, now we can safely switch to loiter."
v1.1.3,must send these regularly to keep offboard control.
v1.1.3,integrate the heading so it is smoother.
v1.1.3,must send these regularly to keep offboard control.
v1.1.3,integrate the heading so it is smoother.
v1.1.3,fly to radius
v1.1.3,it takes about 10 cm to stop and turn.
v1.1.3,next time around switch to orbiting!
v1.1.3,heading points to center of circle.
v1.1.3,interpoloate the speed ramp up time over 2 seconds from start time
v1.1.3,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.1.3,monitor the sin curves so we can see how on track or off track it actually is.
v1.1.3,the shape of the curve will also tell us if we are progressing at a consistent
v1.1.3,"speed, the more deformed the sin curve the worse our progress."
v1.1.3,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.1.3,degrees just flipped from 359 to 0.
v1.1.3,this enables us to test what happens when offboard control is lost and resumed.
v1.1.3,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.1.3,"ok, now we can start moving by velocity"
v1.1.3,recompute to new target.
v1.1.3,start by moving right with 10 degree roll.
v1.1.3,haven't started yet.
v1.1.3,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.1.3,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.1.3,track how our actual pitch is coming along compared to our target
v1.1.3,and check position
v1.1.3,the amount of pitch should depend on our speed in that direction.
v1.1.3,passed the midpoint.
v1.1.3,fade out the pitch as we pick up speed so we don't overshoot.
v1.1.3,see if we just crossed the wiggle distance threshold.
v1.1.3,(pitch affects the x-position).
v1.1.3,reverse direction with a -30 degrees quick stop
v1.1.3,reverse direction with a 30 degrees quick stop
v1.1.3,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.1.3,too much in that direction.
v1.1.3,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.3,track how our actual roll is coming along compared to our target
v1.1.3,and check position
v1.1.3,the amount of roll should depend on our speed in that direction.
v1.1.3,passed the midpoint.
v1.1.3,fade out the roll as we pick up speed so we don't overshoot.
v1.1.3,see if we just crossed the wiggle distance threshold.
v1.1.3,(roll affects the y-position).
v1.1.3,reverse direction with a -30 degrees quick stop
v1.1.3,reverse direction with a 30 degrees quick stop
v1.1.3,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.1.3,too much in that direction.
v1.1.3,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.3,for testing PID controller.
v1.1.3,class AltHoldCommand : public Command
v1.1.3,{
v1.1.3,std::shared_ptr<MavLinkVehicle> channel;
v1.1.3,"float sx_, sy_, sz_;"
v1.1.3,MavLinkAttitudeTarget _current;
v1.1.3,PidController thrust_controller_;
v1.1.3,public:
v1.1.3,this->sz_ = pos.z; // user defined target.
v1.1.3,move to local position keeps the offboard control happy.
v1.1.3,haven't started yet.
v1.1.3,and check position
v1.1.3,double dx = this->sx_ - pos.x;
v1.1.3,double dy = this->sy_ - pos.y;
v1.1.3,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.1.3,too much in that direction.
v1.1.3,adjust thrust so we keep steady height target
v1.1.3,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.3,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.1.3,local remote
v1.1.3,already handled by the parse method.
v1.1.3,we only support very simple patterns for now.
v1.1.3,each wildcard must be separated by literal.
v1.1.3,back to back wildcards with no literal in between is too complex.
v1.1.3,"we only support simple matching for now, we can add full regex later if we need it."
v1.1.3,yep!
v1.1.3,'*' is done we found the next matching char
v1.1.3,this is ok.
v1.1.3,this is an ERASE_END_LINE command which we ignore.
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,unpack the message...
v1.1.3,pack the payload buffer.
v1.1.3,"json can't handle ""nan"", so we convert it to null."
v1.1.3,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.1.3,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,start listening to this connection
v1.1.3,Send heartbeat to drone.  You should not do this if some other node is
v1.1.3,already doing it.
v1.1.3,stop listening to the connection.
v1.1.3,get the connection
v1.1.3,Get the local system and component id
v1.1.3,send a command to the remote node
v1.1.3,MavLinkNode::MavLinkNode() = default;
v1.1.3,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.1.3,decrementing the count so the next WaitOne may block.
v1.1.3,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.1.3,convert to absolute time.
v1.1.3,use mach_timespec
v1.1.3,convert to absolute time.
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,return true if we still have offboard control (can lose this if user flips the switch).
v1.1.3,MavLinkVehicle::MavLinkVehicle() = default;
v1.1.3,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.1.3,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,============================== CLIENT ============================================
v1.1.3,image APIs
v1.1.3,or if you are implementing the client side call this function to get the most recent frame.
v1.1.3,returns false if there is no new frame available.
v1.1.3,============================== SERVER ============================================
v1.1.3,call this to send the image back over the connection given to start function.
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,"log every message that is ""sent"" using sendMessage."
v1.1.3,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.1.3,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.1.3,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.1.3,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,for compatibility with QGroundControl we have to save the time field in big endian.
v1.1.3,todo: mavlink2 support?
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,start listening to this connection
v1.1.3,Send heartbeat to drone.  You should not do this if some other node is
v1.1.3,already doing it.
v1.1.3,send a heart beat so that the remote node knows we are still alive
v1.1.3,(otherwise drone will trigger a failsafe operation).
v1.1.3,this is called for all messages received on the connection.
v1.1.3,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.1.3,subclasses remembering to call this base implementation.
v1.1.3,stop listening to the connection.
v1.1.3,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.3,wait for a heartbeat msg since this will give us the port to send commands to...
v1.1.3,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.1.3,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.3,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.3,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.3,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.3,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.3,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.3,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.1.3,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.1.3,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.1.3,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.1.3,"ok, now fetch the missing parameters."
v1.1.3,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.1.3,silently fail since we are on a background thread here...
v1.1.3,tell the caller this is complete.
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,add our custom telemetry message length.
v1.1.3,todo: if we support signing then initialize
v1.1.3,mavlink_intermediate_status_.signing callbacks
v1.1.3,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.1.3,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.3,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.3,send this right away just in case serial link is not already configured
v1.1.3,"log every message that is ""sent"" using sendMessage."
v1.1.3,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.1.3,pack the payload buffer.
v1.1.3,calculate checksum
v1.1.3,form the header as a byte array for the crc
v1.1.3,these macros use old style cast.
v1.1.3,forward messages from our connected node to the remote proxy.
v1.1.3,forward messages from remote proxy to local connected node
v1.1.3,CurrentThread::setMaximumPriority();
v1.1.3,"hmmm, wait till it is opened?"
v1.1.3,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.1.3,pick up the sysid/compid of the remote node we are connected to.
v1.1.3,then this is a mavlink 1 message
v1.1.3,then this mavlink sender supports mavlink 2
v1.1.3,queue event for publishing.
v1.1.3,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.1.3,as it ensures we don't lose messages if the listener is slow.
v1.1.3,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.1.3,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.1.3,we would get a deadlock.
v1.1.3,CurrentThread::setMaximumPriority();
v1.1.3,reset counters
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,------------------------------------------------------------------------------
v1.1.3,Defines
v1.1.3,------------------------------------------------------------------------------
v1.1.3,bit number  876543210987654321
v1.1.3,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.1.3,in future it would be good to have ability to add system IDs we are interested in
v1.1.3,if (msg.sysid != getTargetSystemId())
v1.1.3,{
v1.1.3,// we only care about messages from our intended remote node.
v1.1.3,return;
v1.1.3,}
v1.1.3,user may have changed modes on us! So we need to honor that and not
v1.1.3,try and take it back.
v1.1.3,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.1.3,we can store up to 16 channels in rc_channels_scaled.
v1.1.3,The RAW values of the servo outputs
v1.1.3,Metrics typically displayed on a HUD for fixed wing aircraft
v1.1.3,The IMU readings in SI units in NED body frame
v1.1.3,printSystemStatus(&msg);
v1.1.3,todo: use this to determine when we need to do emergency landing...
v1.1.3,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.1.3,Provides state for additional features
v1.1.3,The general system state
v1.1.3,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.1.3,but we do want to know when we get the ack.  So this is async ACK processing!
v1.1.3,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.1.3,if threshold < 0 then the threshold is inverted.
v1.1.3,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.1.3,Convert it to a floating point number between -1 and 1.
v1.1.3,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.1.3,until the move commands start happening.
v1.1.3,return true if user calls requestControl and has not called releaseControl.
v1.1.3,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.1.3,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.1.3,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.1.3,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.1.3,send a few to make sure it gets through...
v1.1.3,now the command should succeed.
v1.1.3,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.1.3,us by which time the PX4 times out offboard mode!!
v1.1.3,this mode change take precedence over offboard mode.
v1.1.3,thrust must be between -1 and 1.
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,These definitions are copied from PX4 implementation
v1.1.3,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.1.3,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.1.3,/ @brief Command opcodes
v1.1.3,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.1.3,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.3,must trim trailing slashes so PX4 doesn't hang!
v1.1.3,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.1.3,from the source.
v1.1.3,check if directory exists.
v1.1.3,perfect.
v1.1.3,use last_message_ so we preserve the sessionid.
v1.1.3,"could not create the local file, so stop."
v1.1.3,must use last_message_ so we preserve the session id.
v1.1.3,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.1.3,todo: error handling here? sequence is out of order...
v1.1.3,"directory must be empty then, can't do nextStep because"
v1.1.3,it will just loop for ever re-requesting zero offset into
v1.1.3,empty directory.
v1.1.3,result should be a list of null terminated file names.
v1.1.3,skipping this entry
v1.1.3,remove the file size field.
v1.1.3,"printf(""%s\n"", name.c_str());"
v1.1.3,request the next batch.
v1.1.3,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.3,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.3,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.1.3,reached the end of the list or the file.
v1.1.3,end of file or directory listing.
v1.1.3,"success, data should be following..."
v1.1.3,ack on this cmd is a noop
v1.1.3,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.1.3,give up then.
v1.1.3,tell watchdog we are sending a request
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,================================= CLIENT ==============================================================
v1.1.3,Check if we have a valid transaction
v1.1.3,emit signal if all packets arrived
v1.1.3,Restart statemachine
v1.1.3,image APIs
v1.1.3,================================= SERVER ==============================================================
v1.1.3,Prepare and send acknowledgment packet
v1.1.3,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.1.3,Send ENCAPSULATED_IMAGE packet
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.1.3,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.3,parse out the VID number
v1.1.3,now the PID
v1.1.3,parse out the VID number
v1.1.3,examples:
v1.1.3,PX4: USB\VID_26AC&PID_0011\0
v1.1.3,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.1.3,"printf(""Found: %S\n"", buffer.c_str());"
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.3,parse out the VID number
v1.1.3,now the PID
v1.1.3,parse out the VID number
v1.1.3,suppress
v1.1.3,"OneCoreFindSerialPorts.obj : warning LNK4221: This object file does not define any previously undefined public symbols, so it will not be used by any link operation that consumes this library"
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,This has not been properly tested
v1.1.3,struct iw_statistics stats;
v1.1.3,struct iwreq req;
v1.1.3,"memset(&stats, 0, sizeof(stats));"
v1.1.3,"memset(&req, 0, sizeof(iwreq));"
v1.1.3,
v1.1.3,"strncpy(req.ifr_name, ifaceName, 16);"
v1.1.3,req.u.data.pointer = &stats;
v1.1.3,req.u.data.length = sizeof(iw_statistics);
v1.1.3,
v1.1.3,#ifdef CLEAR_UPDATED
v1.1.3,req.u.data.flags = 1;
v1.1.3,#endif
v1.1.3,
v1.1.3,/* Perform the ioctl */
v1.1.3,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.1.3,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.1.3,return -127;
v1.1.3,}
v1.1.3,
v1.1.3,return stats.qual.level;
v1.1.3,todo: windows version of this...
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,windows
v1.1.3,Need to link with Ws2_32.lib
v1.1.3,posix
v1.1.3,found it!
v1.1.3,bind socket to local address.
v1.1.3,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.1.3,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.1.3,write to the serial port
v1.1.3,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.1.3,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.1.3,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.1.3,"try and receive something, up until port is closed anyway."
v1.1.3,"message was too large for the buffer, no problem, return what we have."
v1.1.3,try again - this can happen if server recreates the socket on their side.
v1.1.3,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.3,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.3,try again - this can happen if server recreates the socket on their side.
v1.1.3,"printf(""#### recv failed with error: %d\n"", hr);"
v1.1.3,we now have it.
v1.1.3,this is from someone we are not interested in.
v1.1.3,"printf(""Connection closed\n"");"
v1.1.3,-----------------------------------------------------------------------------------------
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,Initialize Winsock
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,windows
v1.1.3,Need to link with Ws2_32.lib
v1.1.3,posix
v1.1.3,found it!
v1.1.3,bind socket to local address.
v1.1.3,bind socket to local address.
v1.1.3,start listening for incoming connection
v1.1.3,accept 1
v1.1.3,write to the serial port
v1.1.3,"try and receive something, up until port is closed anyway."
v1.1.3,"message was too large for the buffer, no problem, return what we have."
v1.1.3,try again - this can happen if server recreates the socket on their side.
v1.1.3,"skip this, it is was interrupted."
v1.1.3,"printf(""Connection closed\n"");"
v1.1.3,-----------------------------------------------------------------------------------------
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.1.3,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.1.3,set signal
v1.1.3,Clear Handshake flags
v1.1.3,Set Handshake flags
v1.1.3,return GetLastError();
v1.1.3,return GetLastError();
v1.1.3,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.3,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.1.3,enable reading
v1.1.3,posix doesn't have mark/space parity.
v1.1.3,posix doesn't have mark/space parity.
v1.1.3,this is the default.
v1.1.3,not sure this is supported...
v1.1.3,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.1.3,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.3,First do those specified by POSIX.
v1.1.3,Now conditionally handle a bunch of extended rates.
v1.1.3,First do those specified by POSIX.
v1.1.3,Now conditionally handle a bunch of extended rates.
v1.1.3,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.3,","
v1.1.3,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.1.3,"std::unique_ptr<TestBase>(new RosFlightTest()),"
v1.1.3,"std::unique_ptr<TestBase>(new QuaternionTest()),"
v1.1.3,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,"in header only mode, control library is not available"
v1.1.3,TODO: something defines max macro which interfears with code here
v1.1.3,is cur_pos within fence?
v1.1.3,destination risk is not available then consider it zero
v1.1.3,if dest risk is lower than its more safe
v1.1.3,are we doing better than closest obstacle?
v1.1.3,"if we stay where we are, what is the risk distance?"
v1.1.3,else we are better of moving to dest
v1.1.3,this function should work even when dest_pos == cur_pos
v1.1.3,is this dest_pos cur_pos within the fence?
v1.1.3,transform dest_pos vector to body frame
v1.1.3,check for approx zero vectors to avoid random yaw angles
v1.1.3,we are hovering
v1.1.3,"get yaw in body frame, ie, front is always 0 radians"
v1.1.3,yaw to ticks
v1.1.3,get obstacles in the window at the tick direction around the window
v1.1.3,less risk distance is better
v1.1.3,check obstacles around current position and see if it has lower risk
v1.1.3,else obstacle is too far
v1.1.3,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.1.3,look for each surrounding tick to see if we have obstacle free angle
v1.1.3,else no suggestions required
v1.1.3,"3.2 comes from inverse CDF for epsilone = 0.05 (i.e. 95% confidence), author: akapoor"
v1.1.3,evaluate right and left side of circle
v1.1.3,find right and left risk distances
v1.1.3,at this point we have already determined hover is better than going to dest
v1.1.3,we now determine is moving to suggested angle better than hovering?
v1.1.3,check if dest_pos is safe
v1.1.3,breaking distance at this velocity
v1.1.3,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.1.3,check if dest_pos is safe
v1.1.3,float/vec parameters can have NaN which makes them optional
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,"in header only mode, control library is not available"
v1.1.3,handles +/- tick and wraps around circle
v1.1.3,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.1.3,update the specified window on the map
v1.1.3,make dure from <= to
v1.1.3,normalize the ticks so bothe are valid indices
v1.1.3,if from is still larger then
v1.1.3,to ticks is then added one full circle to make it larger than from_tick
v1.1.3,find closest obstacle in given window
v1.1.3,search whole map to find closest obstacle
v1.1.3,"in header only mode, control library is not available"
v1.1.3,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.3,"Windows, OSX and Linux."
v1.1.3,Windows users can move the Documents folder to any location they want
v1.1.3,SHGetFolderPath knows how to find it.
v1.1.3,fall back in case SHGetFolderPath failed for some reason.
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,"in header only mode, control library is not available"
v1.1.3,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.3,if using Unreal Build system then include precompiled header file first
v1.1.3,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.3,#undef check
v1.1.3,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.3,sim only
v1.1.3,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.3,required for pimpl
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,"in header only mode, control library is not available"
v1.1.3,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.3,if using Unreal Build system then include precompiled header file first
v1.1.3,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.1.3,sim only
v1.1.3,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.3,make sure we can talk to the DroneServer
v1.1.3,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.1.3,command_context.client.ping();
v1.1.3,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,"in header only mode, control library is not available"
v1.1.3,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.3,if using Unreal Build system then include precompiled header file first
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,"in header only mode, control library is not available"
v1.1.3,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.3,if using Unreal Build system then include precompiled header file first
v1.1.3,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.3,#undef check
v1.1.3,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.3,required for pimpl
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,"in header only mode, control library is not available"
v1.1.3,if auto mode requested for lookahead then calculate based on velocity
v1.1.3,no-op by default. derived class can override it if needed
v1.1.3,no-op by default. derived class can override it if needed
v1.1.3,validate path size
v1.1.3,validate yaw mode
v1.1.3,validate and set auto-lookahead value
v1.1.3,if auto mode requested for lookahead then calculate based on velocity
v1.1.3,add current position as starting point
v1.1.3,append the input path and compute segments
v1.1.3,add last segment as zero length segment so we have equal number of segments and points.
v1.1.3,path_segs[i] refers to segment that starts at point i
v1.1.3,"when path ends, we want to slow down"
v1.1.3,else no need to change velocities for last segments
v1.1.3,setup current position on path to 0 offset
v1.1.3,initialize next path position
v1.1.3,until we are at the end of the path (last seg is always zero size)
v1.1.3,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.1.3,send drone command to get to next lookahead
v1.1.3,sleep for rest of the cycle
v1.1.3,how much have we moved towards last goal?
v1.1.3,project actual vector on goal vector
v1.1.3,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.1.3,TODO: below should be lower than 1E3 and configurable
v1.1.3,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.1.3,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.1.3,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.1.3,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.1.3,"if drone moved backward, we don't want goal to move backward as well"
v1.1.3,"so only climb forward on the path, never back. Also note >= which means"
v1.1.3,we climb path even if distance was 0 to take care of duplicated points on path
v1.1.3,else
v1.1.3,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.1.3,compute next target on path
v1.1.3,last command is to hold on to position
v1.1.3,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.1.3,default strategy is for move. In hover mode we set new strategy temporarily
v1.1.3,freeze the quaternion
v1.1.3,get trims
v1.1.3,take average
v1.1.3,convert RC commands to velocity vector
v1.1.3,find yaw as per terrain and remote setting
v1.1.3,execute command
v1.1.3,Only raise exception is time out occurred. If preempted then return status.
v1.1.3,are we supposed to do EM?
v1.1.3,get suggested velocity vector
v1.1.3,use the unchecked command
v1.1.3,tell caller not to execute planned command
v1.1.3,other wise throw exception
v1.1.3,otherwise there is some other reason why we are in unsafe situation
v1.1.3,send last command to come to full stop
v1.1.3,else no unsafe situation
v1.1.3,note: cur_path_loc and next_path_loc may both point to same object
v1.1.3,"otherwise use up this segment, move on to next one"
v1.1.3,if we are here then we ran out of segments
v1.1.3,consider last segment as zero length segment
v1.1.3,adjust yaw for the direction of travel in foward-only mode
v1.1.3,else no adjustment needed
v1.1.3,validate dest
v1.1.3,what is the distance we will travel at this velocity?
v1.1.3,get velocity vector
v1.1.3,yaw for the direction of travel
v1.1.3,find velocity vector
v1.1.3,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.1.3,generate velocity vector that is same size as cur_dest_norm / command period
v1.1.3,this velocity vect when executed for command period would yield cur_dest_norm
v1.1.3,send commands
v1.1.3,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.1.3,by default indicate that we don't have alternative pose info
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,"in header only mode, control library is not available"
v1.1.3,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.3,if using Unreal Build system then include precompiled header file first
v1.1.3,status getters
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,"in header only mode, control library is not available"
v1.1.3,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.3,if using Unreal Build system then include precompiled header file first
v1.1.3,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.3,#undef check
v1.1.3,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.3,getters
v1.1.3,required for pimpl
v1.1.3,Create a spring arm component for our chase camera
v1.1.3,do nothing
v1.1.3,set initial view mode
v1.1.3,"If we do have actor to follow AND don't have sprint arm attached to that actor, we will attach it"
v1.1.3,"For car, we want a bit of camera lag, as that is customary of racing video games"
v1.1.3,"If the lag is missing, the camera will also occasionally shake."
v1.1.3,"But, lag is not desired when piloting a drone"
v1.1.3,attach spring arm to actor
v1.1.3,remember current parent for external camera. Later when we remove external
v1.1.3,"camera from spring arm, we will attach it back to its last parent"
v1.1.3,now attach camera to spring arm
v1.1.3,"For car, we need to move the camera back a little more than for a drone."
v1.1.3,"Otherwise, the camera will be stuck inside the car"
v1.1.3,external_camera_->bUsePawnControlRotation = false;
v1.1.3,"else someone else is bound to manual pose controller, leave it alone"
v1.1.3,TODO: explore screenshot option
v1.1.3,addScreenCaptureHandler(camera->GetWorld());
v1.1.3,Wait for render so that view is ready for capture
v1.1.3,not sure why this doesn't work.
v1.1.3,"DECLARE_CYCLE_STAT(TEXT(""FNullGraphTask.CheckRenderStatus""), STAT_FNullGraphTask_CheckRenderStatus, STATGROUP_TaskGraphTasks);"
v1.1.3,"auto renderStatus = TGraphTask<FNullGraphTask>::CreateTask(NULL).ConstructAndDispatchWhenReady(GET_STATID(STAT_FNullGraphTask_CheckRenderStatus), ENamedThreads::RenderThread);"
v1.1.3,FTaskGraphInterface::Get().WaitUntilTaskCompletes(renderStatus);
v1.1.3,Make sure that all alpha values are opaque.
v1.1.3,Deflect along the surface when we collide.
v1.1.3,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.1.3,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.1.3,set up key variables
v1.1.3,initialize state
v1.1.3,should be overridden in derived class
v1.1.3,should be overridden in derived class
v1.1.3,TODO: delete below
v1.1.3,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.3,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.3,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.3,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.3,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.1.3,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.3,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.1.3,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.3,parameters in NED frame
v1.1.3,translate to new VehiclePawnWrapper position & orientation from NED to NEU
v1.1.3,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.1.3,must reset collison before we set pose. Setting pose will immediately call NotifyHit if there was collison
v1.1.3,"if there was no collison than has_collided would remain false, else it will be set so its value can be"
v1.1.3,checked at the start of next tick
v1.1.3,allow teleportation
v1.1.3,if collisons are not enabled
v1.1.3,or we have collided but passthrough is enabled
v1.1.3,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.1.3,"without flip flopping, collisons can't be detected"
v1.1.3,set default for brigher images
v1.1.3,by default all image types are disabled
v1.1.3,use final color for all calculations
v1.1.3,use final color for all calculations
v1.1.3,else we will set this after this components get created
v1.1.3,else we will set this after this components get created
v1.1.3,do not make unnecessory calls to Activate() which otherwise causes crash in Unreal
v1.1.3,else nothing to enable
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,TODO: change naming conventions to same as other files?
v1.1.3,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.1.3,mesh->SetRenderCustomDepth(false);
v1.1.3,mesh->SetRenderCustomDepth(true);
v1.1.3,mesh->SetVisibility(false);
v1.1.3,mesh->SetVisibility(true);
v1.1.3,if (! is_name_regex)
v1.1.3,return true;
v1.1.3,Access the subclass instance with the * or -> operators.
v1.1.3,can we see followee?
v1.1.3,remove mapping
v1.1.3,removing binding
v1.1.3,"TODO: can't do remove because there is no ""stamp"" on who established binding"
v1.1.3,removeInputBindings();
v1.1.3,#ifdef _MSC_VER
v1.1.3,//print to VS output window
v1.1.3,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.1.3,#endif
v1.1.3,also do default logging
v1.1.3,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.1.3,UGameUserSettings* game_settings = GetGameUserSettings();
v1.1.3,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.1.3,game_settings->ApplySettings(true);
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,plugin startup
v1.1.3,plugin shutdown
v1.1.3,"read pixels from render target using render thread, then compress the result into PNG"
v1.1.3,argument on the thread that calls this method.
v1.1.3,make sure we are not on the rendering thread
v1.1.3,TODO: below doesn't work right now because it must be running in game thread
v1.1.3,below is documented method but more expensive because it forces flush
v1.1.3,wait for render thread to pick up our task
v1.1.3,Queue up the task of rendering the scene in the render thread
v1.1.3,wait for this task to complete
v1.1.3,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.1.3,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.1.3,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.1.3,Stuff to filter out XInput devices
v1.1.3,-----------------------------------------------------------------------------
v1.1.3,"Defines, constants, and global variables"
v1.1.3,-----------------------------------------------------------------------------
v1.1.3,Register with the DirectInput subsystem and get a pointer
v1.1.3,to a IDirectInput interface we can use.
v1.1.3,Create a DInput object
v1.1.3,Look for a simple joystick we can use for this sample program.
v1.1.3,Make sure we got a joystick
v1.1.3,"Set the data format to ""simple joystick"" - a predefined data format"
v1.1.3,
v1.1.3,"A data format specifies which controls on a device we are interested in,"
v1.1.3,and how they should be reported. This tells DInput that we will be
v1.1.3,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.1.3,Set the cooperative level to let DInput know how this device should
v1.1.3,interact with the system and with other DInput applications.
v1.1.3,Enumerate the joystick objects. The callback function enabled user
v1.1.3,"interface elements for objects that are found, and sets the min/max"
v1.1.3,values property for discovered axes.
v1.1.3,-----------------------------------------------------------------------------
v1.1.3,Enum each PNP device using WMI and check each device ID to see if it contains
v1.1.3,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then its an XInput device"
v1.1.3,Unfortunately this information can not be found by just using DirectInput.
v1.1.3,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.1.3,XInput devices.
v1.1.3,
v1.1.3,This function stores the list of xinput devices in a linked list
v1.1.3,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.1.3,-----------------------------------------------------------------------------
v1.1.3,CoInit if needed
v1.1.3,Create WMI
v1.1.3,Create BSTRs for WMI
v1.1.3,Connect to WMI
v1.1.3,Switch security level to IMPERSONATE
v1.1.3,Get list of Win32_PNPEntity devices
v1.1.3,Loop over all devices
v1.1.3,Get 20 at a time
v1.1.3,"For each device, get its device ID"
v1.1.3,"Check if the device ID contains ""IG_"".  If it does, then its an XInput device"
v1.1.3,Unfortunately this information can not be found by just using DirectInput
v1.1.3,"If it does, then get the VID/PID from var.bstrVal"
v1.1.3,Add the VID/PID to a linked list
v1.1.3,-----------------------------------------------------------------------------
v1.1.3,Returns true if the DirectInput device is also an XInput device.
v1.1.3,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.1.3,-----------------------------------------------------------------------------
v1.1.3,Check each xinput device to see if this device's vid/pid matches
v1.1.3,-----------------------------------------------------------------------------
v1.1.3,Cleanup needed for IsXInputDevice()
v1.1.3,-----------------------------------------------------------------------------
v1.1.3,Cleanup linked list
v1.1.3,-----------------------------------------------------------------------------
v1.1.3,Name: EnumJoysticksCallback()
v1.1.3,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.1.3,device interface on it so we can play with it.
v1.1.3,-----------------------------------------------------------------------------
v1.1.3,Skip anything other than the perferred joystick device as defined by the control panel.
v1.1.3,Instead you could store all the enumerated joysticks and let the user pick.
v1.1.3,Obtain an interface to the enumerated joystick.
v1.1.3,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.1.3,it while we were in the middle of enumerating it.)
v1.1.3,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.1.3,could store all the enumerated joysticks and let the user pick.
v1.1.3,-----------------------------------------------------------------------------
v1.1.3,Name: EnumObjectsCallback()
v1.1.3,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.1.3,joystick. This function enables user interface elements for objects
v1.1.3,"that are found to exist, and scales axes min/max values."
v1.1.3,-----------------------------------------------------------------------------
v1.1.3,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.1.3,enumerated axis in order to scale min/max values.
v1.1.3,Set the range for the axis
v1.1.3,Set the UI to reflect what objects the joystick supports
v1.1.3,-----------------------------------------------------------------------------
v1.1.3,Name: UpdateInputState()
v1.1.3,Desc: Get the input device's state and display it.
v1.1.3,-----------------------------------------------------------------------------
v1.1.3,Poll the device to read the current state
v1.1.3,DInput is telling us that the input stream has been
v1.1.3,"interrupted. We aren't tracking any state between polls, so"
v1.1.3,we don't have any special reset that needs to be done. We
v1.1.3,just re-acquire and try again.
v1.1.3,while (hr == DIERR_INPUTLOST)
v1.1.3,hr = g_pJoystick->Acquire();
v1.1.3,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.1.3,may occur when the app is minimized or in the process of
v1.1.3,"switching, so just try again later"
v1.1.3,Get the input's device state
v1.1.3,Axes
v1.1.3,Slider controls
v1.1.3,Points of view
v1.1.3,Buttons
v1.1.3,-----------------------------------------------------------------------------
v1.1.3,Name: FreeDirectInput()
v1.1.3,Desc: Initialize the DirectInput variables.
v1.1.3,-----------------------------------------------------------------------------
v1.1.3,Unacquire the device one last time just in case
v1.1.3,the app tried to exit while the device is still acquired.
v1.1.3,Release any DirectInput objects.
v1.1.3,nop
v1.1.3,normalize min to max --> 0 to 1
v1.1.3,normalize 0 to 1 --> -1 to 1
v1.1.3,implementation for unsupported OS
v1.1.3,if this is new indec
v1.1.3,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.1.3,close previos one
v1.1.3,open new device
v1.1.3,if open was sucessfull
v1.1.3,read the device
v1.1.3,if we didn't had valid read
v1.1.3,"NOTE if this condition is not met, we're probably out of sync and this"
v1.1.3,Joystick instance is likely unusable
v1.1.3,TODO: set below to false?
v1.1.3,state.is_valid = false;
v1.1.3,else ignore
v1.1.3,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.1.3,{
v1.1.3,"manufacturerID = productID = """";"
v1.1.3,// Use udev to look up the product and manufacturer IDs
v1.1.3,struct udev *udev = udev_new();
v1.1.3,if (udev) {
v1.1.3,char sysname[32];
v1.1.3,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.1.3,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.1.3,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.1.3,if (!dev)
v1.1.3,{
v1.1.3,"message = ""Unable to find parent USB device"";"
v1.1.3,return false;
v1.1.3,}
v1.1.3,std::stringstream ss;
v1.1.3,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.1.3,ss >> manufacturerID;
v1.1.3,ss.clear();
v1.1.3,"ss.str("""");"
v1.1.3,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.1.3,ss >> productID;
v1.1.3,udev_device_unref(dev);
v1.1.3,}
v1.1.3,else
v1.1.3,{
v1.1.3,"message = ""Cannot create udev"";"
v1.1.3,return false;
v1.1.3,}
v1.1.3,udev_unref(udev);
v1.1.3,return true;
v1.1.3,}
v1.1.3,required for pimpl
v1.1.3,TODO: should we only do below on SceneCapture2D components and cameras?
v1.1.3,avoid motion blur so capture images don't get
v1.1.3,use two different methods to set console var because sometime it doesn't seem to work
v1.1.3,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.1.3,create main widget
v1.1.3,synchronize PIP views
v1.1.3,setup defaults
v1.1.3,TODO: should this be done somewhere else?
v1.1.3,load settings file if found
v1.1.3,create default settings
v1.1.3,"write some settings in new file otherwise the string ""null"" is written if all settigs are empty"
v1.1.3,TODO: there is a crash in Linux due to settings.saveJSonString(). Remove this workaround after we only support Unreal 4.17
v1.1.3,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.1.3,create its control server
v1.1.3,stop physics thread before we dismental
v1.1.3,for (AActor* actor : spawned_actors_) {
v1.1.3,actor->Destroy();
v1.1.3,}
v1.1.3,get player controller
v1.1.3,put camera little bit above vehicle
v1.1.3,we will either find external camera if it already exist in evironment or create one
v1.1.3,find all BP camera directors in the environment
v1.1.3,create director
v1.1.3,create external camera required for the director
v1.1.3,find all vehicle pawns
v1.1.3,if no vehicle pawns exists in environment
v1.1.3,create vehicle pawn
v1.1.3,set up vehicle pawns
v1.1.3,initialize each vehicle pawn we found
v1.1.3,chose first pawn as FPV if none is designated as FPV
v1.1.3,now create the connector for each pawn
v1.1.3,else we don't have vehicle for this pawn
v1.1.3,TODO: because this bug we are using alternative code with stringstream
v1.1.3,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.1.3,std::stringstream ss;
v1.1.3,"ss << timestamp_millis << ""\t"";"
v1.1.3,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.1.3,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.1.3,"ss << ""\n"";"
v1.1.3,return ss.str();
v1.1.3,find vehicles and cameras available in environment
v1.1.3,if none available then we will create one
v1.1.3,get references of components so we can use later
v1.1.3,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.1.3,-1 to 1 --> 0 to 1
v1.1.3,convert 0 to 1 -> -1 to 1
v1.1.3,TODO: add fields for z axis?
v1.1.3,last 8 bits are not used for now
v1.1.3,TODO: should below be at controller level info?
v1.1.3,else don't waste time
v1.1.3,"Utils::log(""------Render tick-------"");"
v1.1.3,move collison info from rendering engine to vehicle
v1.1.3,update ground level
v1.1.3,update rotor poses
v1.1.3,update rotor animations
v1.1.3,"UAirBlueprintLib::LogMessage(TEXT(""Collison (raw) Count:""), FString::FromInt(collision_response_info.collison_count_raw), LogDebugLevel::Unimportant);"
v1.1.3,*** Start: UpdatableState implementation ***//
v1.1.3,TODO: should this be done in MultiRotor.hpp
v1.1.3,controller_->reset();
v1.1.3,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.1.3,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.1.3,*** End: UpdatableState implementation ***//
v1.1.3,"If render command is complete, save image along with position and orientation"
v1.1.3,TODO: check FPlatformProcess::SupportsMultithreading()?
v1.1.3,make sire all vars are set up
v1.1.3,"todo: should we go as fast as possible, or should we limit this to a particular number of"
v1.1.3,frames per second?
v1.1.3,Try to find the high polycount vehicle
v1.1.3,"If not found, spawn the default class (go-kart)"
v1.1.3,Timestamp \t Speed \t Throttle \t Steering \t Brake \t gear \t ImageName
v1.1.3,get player controller
v1.1.3,put camera little bit above vehicle
v1.1.3,we will either find external camera if it already exist in evironment or create one
v1.1.3,find all BP camera directors in the environment
v1.1.3,create director
v1.1.3,create external camera required for the director
v1.1.3,find all vehicle pawns
v1.1.3,if no vehicle pawns exists in environment
v1.1.3,create vehicle pawn
v1.1.3,set up vehicle pawns
v1.1.3,initialize each vehicle pawn we found
v1.1.3,chose first pawn as FPV if none is designated as FPV
v1.1.3,find vehicles and cameras available in environment
v1.1.3,if none available then we will create one
v1.1.3,find all vehicle pawns
v1.1.3,set up vehicle pawns
v1.1.3,initialize each vehicle pawn we found
v1.1.3,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.3,Setup suspension forces
v1.1.3,Find the tire object and set the data for it
v1.1.3,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.3,Setup suspension forces
v1.1.3,Find the tire object and set the data for it
v1.1.3,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.3,Needed for VR Headset
v1.1.3,this->AutoReceiveInput = EAutoReceiveInput::Player0;
v1.1.3,Car mesh
v1.1.3,Setup friction materials
v1.1.3,Wheels/Tyres
v1.1.3,Setup the wheels
v1.1.3,Adjust the tire loading
v1.1.3,Engine
v1.1.3,Torque setup
v1.1.3,Adjust the steering
v1.1.3,Transmission
v1.1.3,We want 4wd
v1.1.3,Drive the front wheels a little more than the rear
v1.1.3,Automatic gearbox
v1.1.3,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.1.3,Physics settings
v1.1.3,Adjust the center of mass - the buggy is quite low
v1.1.3,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.1.3,Create In-Car camera component
v1.1.3,In car HUD
v1.1.3,Create text render component for in car speed display
v1.1.3,Create text render component for in car gear display
v1.1.3,Setup the audio component and allocate it a sound cue
v1.1.3,Colors for the in-car gear display. One for normal one for reverse
v1.1.3,put camera little bit above vehicle
v1.1.3,below is not needed
v1.1.3,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::OnReversePressed, true);"
v1.1.3,"UAirBlueprintLib::BindActionToKey(""Reverse"", EKeys::Down, this, &ACarPawn::OnReverseReleased, false);"
v1.1.3,TODO: update other fields
v1.1.3,Setup the flag to say we are in reverse gear
v1.1.3,Update phsyics material
v1.1.3,Update the strings used in the hud (incar and onscreen)
v1.1.3,Set the string in the incar hud
v1.1.3,Pass the engine RPM to the sound component
v1.1.3,Start an engine sound playing
v1.1.3,Using FText because this is display text that should be localizable
v1.1.3,Setup the text render component strings
v1.1.3,Timestamp \t Speed \t Throttle \t Steering \t Brake \t gear
v1.1.3,timestamp
v1.1.3,Speed
v1.1.3,Gear
v1.1.3,call virtual method in derived class
v1.1.3,remove everything that we created in BeginPlay
v1.1.3,perfom any expensive rendering update outside of lock region
v1.1.3,should be overridden by derived class
v1.1.3,Unreal doesn't allow pure abstract methods in actors
v1.1.3,set defaults in case exception occurs
v1.1.3,we had spelling mistake so we are currently supporting SettingsVersion or SettingdVersion :(
v1.1.3,no warnings because we have default settings
v1.1.3,by default we spawn server at local endpoint. Do not use 127.0.0.1 as default below
v1.1.3,because for docker container default is 0.0.0.0 and people get really confused why things
v1.1.3,don't work
v1.1.3,By default this is the column header. Override it in BeginPlay of pawn mode
v1.1.3,Should be overridden by derived classes
v1.1.3,Should be overridden by derived classes
v1.1.3,Should be overridden by derived classes
v1.1.3,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,This assumes you are running DroneServer already on the same machine.
v1.1.3,DroneServer must be running first.
v1.1.3,enable API control
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,move commands
v1.1.3,else leave as it is
v1.1.3,TODO: get these in one call
v1.1.3,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.1.3,TODO: shouldn't we pass folder path?
v1.1.3,parse
v1.1.3,group the images by the current date.
v1.1.3,"std::string beforeScriptStartCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.3,{
v1.1.3,"return """";"
v1.1.3,}
v1.1.3,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.3,{
v1.1.3,return false;
v1.1.3,}
v1.1.3,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.1.3,params.context->client.newTask();
v1.1.3,}
v1.1.3,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.1.3,params.context->client.WaitForCompletion(0);
v1.1.3,}
v1.1.3,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.1.3,{
v1.1.3,}
v1.1.3,parse command line
v1.1.3,Shell callbacks
v1.1.3,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.3,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.3,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.3,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.3,Add shell commands
v1.1.3,TODO: add WaitForCompletion command
v1.1.3,"TODO: add command line args help, arg count validation"
v1.1.3,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.3,Licensed under the MIT License.
v1.1.3,switch to explicit hover mode so that this is the fallback when
v1.1.3,move* commands are finished.
v1.1.3,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.1.3,60 acres park:
v1.1.3,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.1.3,marymoore park
v1.1.3,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,read settings and override defaults
v1.1.1,allow json overrides on a per-vehicle basis.
v1.1.1,start server in async mode
v1.1.1,check messages
v1.1.1,DEY: I don't know why this was there.
v1.1.1,data = np.flipud(data)
v1.1.1,In settings.json first activate computer vision mode:
v1.1.1,https://github.com/Microsoft/AirSim/blob/master/docs/image_apis.md#computer-vision-mode
v1.1.1,"you can also use MultirotorClient.toQuaternion(0, 0, x) to generate quaternion"
v1.1.1,connect to the AirSim simulator
v1.1.1,use open cv to show new images from AirSim
v1.1.1,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.1,pip install opencv-python
v1.1.1,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.1,use open cv to create point cloud from depth image.
v1.1.1,skip it
v1.1.1,AirSim uses NED coordinates so negative axis is up.
v1.1.1,z of -7 is 7 meters above the original launch point.
v1.1.1,Fly given velocity vector for 5 seconds
v1.1.1,using DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.1.1,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.1.1,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.1.1,AirSim uses NED coordinates so negative axis is up.
v1.1.1,z of -5 is 5 meters above the original launch point.
v1.1.1,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.1.1,this method is async and we are not waiting for the result since we are passing max_wait_seconds=0.
v1.1.1,connect to the AirSim simulator
v1.1.1,get state of the car
v1.1.1,go forward
v1.1.1,Go forward + steer right
v1.1.1,"go reverse, steer left"
v1.1.1,apply breaks
v1.1.1,get camera images from the car
v1.1.1,basic flight control
v1.1.1,camera control
v1.1.1,simGetImage returns compressed png in array of bytes
v1.1.1,image_type uses one of the AirSimImageType members
v1.1.1,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.1.1,camera control
v1.1.1,simGetImage returns compressed png in array of bytes
v1.1.1,image_type uses one of the AirSimImageType members
v1.1.1,helper method for converting getOrientation to roll/pitch/yaw
v1.1.1,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.1.1,roll (x-axis rotation)
v1.1.1,pitch (y-axis rotation)
v1.1.1,yaw (z-axis rotation)
v1.1.1,DEY: I don't know why this was there.
v1.1.1,data = np.flipud(data)
v1.1.1,-----------------------------------  Multirotor APIs ---------------------------------------------
v1.1.1,query vehicle state
v1.1.1,def getRCData(self):
v1.1.1,return self.client.call('getRCData')
v1.1.1,APIs for control
v1.1.1,-----------------------------------  Car APIs ---------------------------------------------
v1.1.1,use open cv to show new images from AirSim
v1.1.1,requires Python 3.5.3 :: Anaconda 4.4.0
v1.1.1,pip install opencv-python
v1.1.1,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.1.1,get depth image
v1.1.1,"this will return png width= 256, height= 144"
v1.1.1,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.1.1,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.1.1,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.1.1,to get an estimate of distance.
v1.1.1,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.1.1,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.1.1,an angular delta of the following pi/10.
v1.1.1,"in header only mode, control library is not available"
v1.1.1,if using Unreal Build system then include precompiled header file first
v1.1.1,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.1,"Windows, OSX and Linux."
v1.1.1,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.1.1,Windows users can move the Documents folder to any location they want
v1.1.1,SHGetFolderPath knows how to find it.
v1.1.1,fall back in case SHGetFolderPath failed for some reason.
v1.1.1,convert from std::path '/' to windows backslash.
v1.1.1,make the current thread run with maximum priority.
v1.1.1,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.1.1,TODO: How to handle POSIX thread priorities on OSX?
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.1.1,
v1.1.1,Treat all errors as failure conditions.
v1.1.1,parse command line
v1.1.1,"motive gives a weird error if the project is not found, so we look for it."
v1.1.1,Do an update to pick up any recently-arrived cameras.
v1.1.1,List all detected cameras.
v1.1.1,List all defined rigid bodies.
v1.1.1,throttle to 50 messages per second.
v1.1.1,OptiTrack uses 'y' axis for vertical.
v1.1.1,stdafx.cpp : source file that includes just the standard includes
v1.1.1,MavlinkMoCap.pch will be the pre-compiled header
v1.1.1,stdafx.obj will contain the pre-compiled type information
v1.1.1,TODO: reference any additional headers you need in STDAFX.H
v1.1.1,and not in this file
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,PX4.cpp : Defines the entry point for the console application.
v1.1.1,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.1.1,how do you write to the debug output windows on Unix ?
v1.1.1,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.1.1,connection to create to talke to that server.
v1.1.1,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.1.1,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.1.1,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.1.1,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.1.1,using their the -qgc option.
v1.1.1,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.1.1,this switch controls whether we turn off the RC remote active link loss detection
v1.1.1,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.1.1,from kicking in when you try and fly.
v1.1.1,can't use experimental stuff on Linux because of potential ABI issues
v1.1.1,parse the json
v1.1.1,flatten inner mavlink object
v1.1.1,flatten inner mavlink object
v1.1.1,todo
v1.1.1,todo
v1.1.1,"const char* outLogFileOption = ""outlogfile"";"
v1.1.1,parse command line
v1.1.1,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.1.1,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.1.1,"no local serial connection, so this is the primary droneConnection."
v1.1.1,failed to connect
v1.1.1,"local connection, then we own sending the heartbeat."
v1.1.1,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.1.1,cmdTable.push_back(new AltHoldCommand());
v1.1.1,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.1.1,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.1.1,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.1.1,this stops us from being able to connect to SITL mode PX4.
v1.1.1,checkPulse();
v1.1.1,add command text in log
v1.1.1,close previous command.
v1.1.1,FilterLogFiles(logDirectory);
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,send a heartbeat
v1.1.1,accept one incoming connection
v1.1.1,send a heartbeat to the client
v1.1.1,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.1.1,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.1.1,for this unit test we are expecting a request to send an image.
v1.1.1,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.1.1,hmmm
v1.1.1,================ ls
v1.1.1,================ put file
v1.1.1,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.1.1,================ get file
v1.1.1,verify the file contents.
v1.1.1,================ remove file
v1.1.1,================ make directory
v1.1.1,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.1.1,================ remove directory
v1.1.1,Now verification
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,from main.cpp.
v1.1.1,you must call this method if you want HandleMessage to be called subsequently.
v1.1.1,treat literals as one word
v1.1.1,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.1,request gps info
v1.1.1,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.1.1,find relative position since command start so we can compare two commands better
v1.1.1,TODO: make below future proof (i.e. usable by C++17 compiler) - also change same in main.cpp
v1.1.1,can't use experimental stuff on Linux because of potential ABI issues
v1.1.1,"these PID values are important, so set these to match"
v1.1.1,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.1.1,we can skip ahead.
v1.1.1,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.1.1,TODO: avoid passing hadcoded HIL flag
v1.1.1,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.1.1,"The global position, as returned by the Global Positioning System (GPS)."
v1.1.1,Provides state for additional features
v1.1.1,The general system state
v1.1.1,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.1,Provides state for additional features
v1.1.1,The general system state
v1.1.1,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.1.1,Provides state for additional features
v1.1.1,The general system state
v1.1.1,Provides state for additional features
v1.1.1,The general system state
v1.1.1,note: we do not reset com when Close() is called because we want to keep running.
v1.1.1,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.1,generate random between 0 and 1
v1.1.1,move to range -1 to 1
v1.1.1,scale it
v1.1.1,apply iy
v1.1.1,wait for the Execute method to be called.
v1.1.1,gps is much slower frequency than IMU.
v1.1.1,MAVLINK_MSG_ID_HIL_GPS
v1.1.1,disable MAV_USEHILGPS
v1.1.1,note: we do not reset com when Close() is called because we want to keep running.
v1.1.1,"user has to invoke ""hil stop"" to stop the hil thread."
v1.1.1,generate random between 0 and 1
v1.1.1,move to range -1 to 1
v1.1.1,scale it
v1.1.1,apply iy
v1.1.1,wait for the Execute method to be called.
v1.1.1,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.1.1,gps is much slower frequency than IMU.
v1.1.1,MAVLINK_MSG_ID_HIL_GPS
v1.1.1,disable HIL mode
v1.1.1,Enumeration of landed detector states
v1.1.1,MAV landed state is unknown
v1.1.1,MAV is landed (on ground)
v1.1.1,MAV is in air
v1.1.1,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.1.1,The filtered local position
v1.1.1,must send these regularly to keep offboard control.
v1.1.1,"ok, now we can safely switch to loiter."
v1.1.1,must send these regularly to keep offboard control.
v1.1.1,integrate the heading so it is smoother.
v1.1.1,must send these regularly to keep offboard control.
v1.1.1,integrate the heading so it is smoother.
v1.1.1,fly to radius
v1.1.1,it takes about 10 cm to stop and turn.
v1.1.1,next time around switch to orbiting!
v1.1.1,heading points to center of circle.
v1.1.1,interpoloate the speed ramp up time over 2 seconds from start time
v1.1.1,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.1.1,monitor the sin curves so we can see how on track or off track it actually is.
v1.1.1,the shape of the curve will also tell us if we are progressing at a consistent
v1.1.1,"speed, the more deformed the sin curve the worse our progress."
v1.1.1,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.1.1,degrees just flipped from 359 to 0.
v1.1.1,this enables us to test what happens when offboard control is lost and resumed.
v1.1.1,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.1.1,"ok, now we can start moving by velocity"
v1.1.1,recompute to new target.
v1.1.1,start by moving right with 10 degree roll.
v1.1.1,haven't started yet.
v1.1.1,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.1.1,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.1.1,track how our actual pitch is coming along compared to our target
v1.1.1,and check position
v1.1.1,the amount of pitch should depend on our speed in that direction.
v1.1.1,passed the midpoint.
v1.1.1,fade out the pitch as we pick up speed so we don't overshoot.
v1.1.1,see if we just crossed the wiggle distance threshold.
v1.1.1,(pitch affects the x-position).
v1.1.1,reverse direction with a -30 degrees quick stop
v1.1.1,reverse direction with a 30 degrees quick stop
v1.1.1,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.1.1,too much in that direction.
v1.1.1,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.1,track how our actual roll is coming along compared to our target
v1.1.1,and check position
v1.1.1,the amount of roll should depend on our speed in that direction.
v1.1.1,passed the midpoint.
v1.1.1,fade out the roll as we pick up speed so we don't overshoot.
v1.1.1,see if we just crossed the wiggle distance threshold.
v1.1.1,(roll affects the y-position).
v1.1.1,reverse direction with a -30 degrees quick stop
v1.1.1,reverse direction with a 30 degrees quick stop
v1.1.1,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.1.1,too much in that direction.
v1.1.1,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.1,for testing PID controller.
v1.1.1,class AltHoldCommand : public Command
v1.1.1,{
v1.1.1,std::shared_ptr<MavLinkVehicle> channel;
v1.1.1,"float sx_, sy_, sz_;"
v1.1.1,MavLinkAttitudeTarget _current;
v1.1.1,PidController thrust_controller_;
v1.1.1,public:
v1.1.1,this->sz_ = pos.z; // user defined target.
v1.1.1,move to local position keeps the offboard control happy.
v1.1.1,haven't started yet.
v1.1.1,and check position
v1.1.1,double dx = this->sx_ - pos.x;
v1.1.1,double dy = this->sy_ - pos.y;
v1.1.1,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.1.1,too much in that direction.
v1.1.1,adjust thrust so we keep steady height target
v1.1.1,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.1.1,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.1.1,local remote
v1.1.1,already handled by the parse method.
v1.1.1,we only support very simple patterns for now.
v1.1.1,each wildcard must be separated by literal.
v1.1.1,back to back wildcards with no literal in between is too complex.
v1.1.1,"we only support simple matching for now, we can add full regex later if we need it."
v1.1.1,yep!
v1.1.1,'*' is done we found the next matching char
v1.1.1,this is ok.
v1.1.1,this is an ERASE_END_LINE command which we ignore.
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,unpack the message...
v1.1.1,pack the payload buffer.
v1.1.1,"json can't handle ""nan"", so we convert it to null."
v1.1.1,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.1.1,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,start listening to this connection
v1.1.1,Send heartbeat to drone.  You should not do this if some other node is
v1.1.1,already doing it.
v1.1.1,stop listening to the connection.
v1.1.1,get the connection
v1.1.1,Get the local system and component id
v1.1.1,send a command to the remote node
v1.1.1,MavLinkNode::MavLinkNode() = default;
v1.1.1,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.1.1,decrementing the count so the next WaitOne may block.
v1.1.1,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.1.1,convert to absolute time.
v1.1.1,use mach_timespec
v1.1.1,convert to absolute time.
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,return true if we still have offboard control (can lose this if user flips the switch).
v1.1.1,MavLinkVehicle::MavLinkVehicle() = default;
v1.1.1,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.1.1,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,============================== CLIENT ============================================
v1.1.1,image APIs
v1.1.1,or if you are implementing the client side call this function to get the most recent frame.
v1.1.1,returns false if there is no new frame available.
v1.1.1,============================== SERVER ============================================
v1.1.1,call this to send the image back over the connection given to start function.
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,"log every message that is ""sent"" using sendMessage."
v1.1.1,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.1.1,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.1.1,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.1.1,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,for compatibility with QGroundControl we have to save the time field in big endian.
v1.1.1,todo: mavlink2 support?
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,start listening to this connection
v1.1.1,Send heartbeat to drone.  You should not do this if some other node is
v1.1.1,already doing it.
v1.1.1,send a heart beat so that the remote node knows we are still alive
v1.1.1,(otherwise drone will trigger a failsafe operation).
v1.1.1,this is called for all messages received on the connection.
v1.1.1,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.1.1,subclasses remembering to call this base implementation.
v1.1.1,stop listening to the connection.
v1.1.1,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.1,wait for a heartbeat msg since this will give us the port to send commands to...
v1.1.1,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.1.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.1,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.1.1,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.1.1,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.1.1,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.1.1,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.1.1,"ok, now fetch the missing parameters."
v1.1.1,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.1.1,silently fail since we are on a background thread here...
v1.1.1,tell the caller this is complete.
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,add our custom telemetry message length.
v1.1.1,todo: if we support signing then initialize
v1.1.1,mavlink_intermediate_status_.signing callbacks
v1.1.1,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.1.1,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.1,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.1.1,send this right away just in case serial link is not already configured
v1.1.1,"log every message that is ""sent"" using sendMessage."
v1.1.1,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.1.1,pack the payload buffer.
v1.1.1,calculate checksum
v1.1.1,form the header as a byte array for the crc
v1.1.1,these macros use old style cast.
v1.1.1,forward messages from our connected node to the remote proxy.
v1.1.1,forward messages from remote proxy to local connected node
v1.1.1,CurrentThread::setMaximumPriority();
v1.1.1,"hmmm, wait till it is opened?"
v1.1.1,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.1.1,pick up the sysid/compid of the remote node we are connected to.
v1.1.1,then this is a mavlink 1 message
v1.1.1,then this mavlink sender supports mavlink 2
v1.1.1,queue event for publishing.
v1.1.1,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.1.1,as it ensures we don't lose messages if the listener is slow.
v1.1.1,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.1.1,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.1.1,we would get a deadlock.
v1.1.1,CurrentThread::setMaximumPriority();
v1.1.1,reset counters
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,------------------------------------------------------------------------------
v1.1.1,Defines
v1.1.1,------------------------------------------------------------------------------
v1.1.1,bit number  876543210987654321
v1.1.1,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.1.1,in future it would be good to have ability to add system IDs we are interested in
v1.1.1,if (msg.sysid != getTargetSystemId())
v1.1.1,{
v1.1.1,// we only care about messages from our intended remote node.
v1.1.1,return;
v1.1.1,}
v1.1.1,user may have changed modes on us! So we need to honor that and not
v1.1.1,try and take it back.
v1.1.1,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.1.1,we can store up to 16 channels in rc_channels_scaled.
v1.1.1,The RAW values of the servo outputs
v1.1.1,Metrics typically displayed on a HUD for fixed wing aircraft
v1.1.1,The IMU readings in SI units in NED body frame
v1.1.1,printSystemStatus(&msg);
v1.1.1,todo: use this to determine when we need to do emergency landing...
v1.1.1,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.1.1,Provides state for additional features
v1.1.1,The general system state
v1.1.1,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.1.1,but we do want to know when we get the ack.  So this is async ACK processing!
v1.1.1,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.1.1,if threshold < 0 then the threshold is inverted.
v1.1.1,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.1.1,Convert it to a floating point number between -1 and 1.
v1.1.1,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.1.1,until the move commands start happening.
v1.1.1,return true if user calls requestControl and has not called releaseControl.
v1.1.1,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.1.1,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.1.1,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.1.1,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.1.1,send a few to make sure it gets through...
v1.1.1,now the command should succeed.
v1.1.1,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.1.1,us by which time the PX4 times out offboard mode!!
v1.1.1,this mode change take precedence over offboard mode.
v1.1.1,thrust must be between -1 and 1.
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,These definitions are copied from PX4 implementation
v1.1.1,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.1.1,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.1.1,/ @brief Command opcodes
v1.1.1,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.1.1,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.1.1,must trim trailing slashes so PX4 doesn't hang!
v1.1.1,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.1.1,from the source.
v1.1.1,check if directory exists.
v1.1.1,perfect.
v1.1.1,use last_message_ so we preserve the sessionid.
v1.1.1,"could not create the local file, so stop."
v1.1.1,must use last_message_ so we preserve the session id.
v1.1.1,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.1.1,todo: error handling here? sequence is out of order...
v1.1.1,"directory must be empty then, can't do nextStep because"
v1.1.1,it will just loop for ever re-requesting zero offset into
v1.1.1,empty directory.
v1.1.1,result should be a list of null terminated file names.
v1.1.1,skipping this entry
v1.1.1,remove the file size field.
v1.1.1,"printf(""%s\n"", name.c_str());"
v1.1.1,request the next batch.
v1.1.1,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.1,"perhaps this was a late response after we did a retry, so ignore it."
v1.1.1,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.1.1,reached the end of the list or the file.
v1.1.1,end of file or directory listing.
v1.1.1,"success, data should be following..."
v1.1.1,ack on this cmd is a noop
v1.1.1,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.1.1,give up then.
v1.1.1,tell watchdog we are sending a request
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,================================= CLIENT ==============================================================
v1.1.1,Check if we have a valid transaction
v1.1.1,emit signal if all packets arrived
v1.1.1,Restart statemachine
v1.1.1,image APIs
v1.1.1,================================= SERVER ==============================================================
v1.1.1,Prepare and send acknowledgment packet
v1.1.1,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.1.1,Send ENCAPSULATED_IMAGE packet
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.1.1,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.1.1,parse out the VID number
v1.1.1,now the PID
v1.1.1,parse out the VID number
v1.1.1,examples:
v1.1.1,PX4: USB\VID_26AC&PID_0011\0
v1.1.1,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.1.1,"printf(""Found: %S\n"", buffer.c_str());"
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,This has not been properly tested
v1.1.1,struct iw_statistics stats;
v1.1.1,struct iwreq req;
v1.1.1,"memset(&stats, 0, sizeof(stats));"
v1.1.1,"memset(&req, 0, sizeof(iwreq));"
v1.1.1,
v1.1.1,"strncpy(req.ifr_name, ifaceName, 16);"
v1.1.1,req.u.data.pointer = &stats;
v1.1.1,req.u.data.length = sizeof(iw_statistics);
v1.1.1,
v1.1.1,#ifdef CLEAR_UPDATED
v1.1.1,req.u.data.flags = 1;
v1.1.1,#endif
v1.1.1,
v1.1.1,/* Perform the ioctl */
v1.1.1,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.1.1,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.1.1,return -127;
v1.1.1,}
v1.1.1,
v1.1.1,return stats.qual.level;
v1.1.1,todo: windows version of this...
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,windows
v1.1.1,Need to link with Ws2_32.lib
v1.1.1,posix
v1.1.1,found it!
v1.1.1,bind socket to local address.
v1.1.1,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.1.1,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.1.1,write to the serial port
v1.1.1,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.1.1,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.1.1,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.1.1,"try and receive something, up until port is closed anyway."
v1.1.1,"message was too large for the buffer, no problem, return what we have."
v1.1.1,try again - this can happen if server recreates the socket on their side.
v1.1.1,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.1,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.1.1,try again - this can happen if server recreates the socket on their side.
v1.1.1,"printf(""#### recv failed with error: %d\n"", hr);"
v1.1.1,we now have it.
v1.1.1,this is from someone we are not interested in.
v1.1.1,"printf(""Connection closed\n"");"
v1.1.1,-----------------------------------------------------------------------------------------
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,Initialize Winsock
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,windows
v1.1.1,Need to link with Ws2_32.lib
v1.1.1,posix
v1.1.1,found it!
v1.1.1,bind socket to local address.
v1.1.1,bind socket to local address.
v1.1.1,start listening for incoming connection
v1.1.1,accept 1
v1.1.1,write to the serial port
v1.1.1,"try and receive something, up until port is closed anyway."
v1.1.1,"message was too large for the buffer, no problem, return what we have."
v1.1.1,try again - this can happen if server recreates the socket on their side.
v1.1.1,"skip this, it is was interrupted."
v1.1.1,"printf(""Connection closed\n"");"
v1.1.1,-----------------------------------------------------------------------------------------
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.1.1,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.1.1,set signal
v1.1.1,Clear Handshake flags
v1.1.1,Set Handshake flags
v1.1.1,return GetLastError();
v1.1.1,return GetLastError();
v1.1.1,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.1,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.1.1,enable reading
v1.1.1,posix doesn't have mark/space parity.
v1.1.1,posix doesn't have mark/space parity.
v1.1.1,this is the default.
v1.1.1,not sure this is supported...
v1.1.1,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.1.1,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.1,First do those specified by POSIX.
v1.1.1,Now conditionally handle a bunch of extended rates.
v1.1.1,First do those specified by POSIX.
v1.1.1,Now conditionally handle a bunch of extended rates.
v1.1.1,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.1.1,","
v1.1.1,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.1.1,"std::unique_ptr<TestBase>(new RosFlightTest()),"
v1.1.1,"std::unique_ptr<TestBase>(new QuaternionTest()),"
v1.1.1,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,"in header only mode, control library is not available"
v1.1.1,TODO: something defines max macro which interfears with code here
v1.1.1,is cur_pos within fence?
v1.1.1,destination risk is not available then consider it zero
v1.1.1,if dest risk is lower than its more safe
v1.1.1,are we doing better than closest obstacle?
v1.1.1,"if we stay where we are, what is the risk distance?"
v1.1.1,else we are better of moving to dest
v1.1.1,this function should work even when dest_pos == cur_pos
v1.1.1,is this dest_pos cur_pos within the fence?
v1.1.1,transform dest_pos vector to body frame
v1.1.1,check for approx zero vectors to avoid random yaw angles
v1.1.1,we are hovering
v1.1.1,"get yaw in body frame, ie, front is always 0 radians"
v1.1.1,yaw to ticks
v1.1.1,get obstacles in the window at the tick direction around the window
v1.1.1,less risk distance is better
v1.1.1,check obstacles around current position and see if it has lower risk
v1.1.1,else obstacle is too far
v1.1.1,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.1.1,look for each surrounding tick to see if we have obstacle free angle
v1.1.1,else no suggestions required
v1.1.1,"3.2 comes from inverse CDF for epsilone = 0.05 (i.e. 95% confidence), author: akapoor"
v1.1.1,evaluate right and left side of circle
v1.1.1,find right and left risk distances
v1.1.1,at this point we have already determined hover is better than going to dest
v1.1.1,we now determine is moving to suggested angle better than hovering?
v1.1.1,check if dest_pos is safe
v1.1.1,breaking distance at this velocity
v1.1.1,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.1.1,check if dest_pos is safe
v1.1.1,float/vec parameters can have NaN which makes them optional
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,"in header only mode, control library is not available"
v1.1.1,handles +/- tick and wraps around circle
v1.1.1,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.1.1,update the specified window on the map
v1.1.1,make dure from <= to
v1.1.1,normalize the ticks so bothe are valid indices
v1.1.1,if from is still larger then
v1.1.1,to ticks is then added one full circle to make it larger than from_tick
v1.1.1,find closest obstacle in given window
v1.1.1,search whole map to find closest obstacle
v1.1.1,"in header only mode, control library is not available"
v1.1.1,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.1.1,"Windows, OSX and Linux."
v1.1.1,Windows users can move the Documents folder to any location they want
v1.1.1,SHGetFolderPath knows how to find it.
v1.1.1,fall back in case SHGetFolderPath failed for some reason.
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,"in header only mode, control library is not available"
v1.1.1,if auto mode requested for lookahead then calculate based on velocity
v1.1.1,no-op by default. derived class can override it if needed
v1.1.1,no-op by default. derived class can override it if needed
v1.1.1,validate path size
v1.1.1,validate yaw mode
v1.1.1,validate and set auto-lookahead value
v1.1.1,if auto mode requested for lookahead then calculate based on velocity
v1.1.1,add current position as starting point
v1.1.1,append the input path and compute segments
v1.1.1,add last segment as zero length segment so we have equal number of segments and points.
v1.1.1,path_segs[i] refers to segment that starts at point i
v1.1.1,"when path ends, we want to slow down"
v1.1.1,else no need to change velocities for last segments
v1.1.1,setup current position on path to 0 offset
v1.1.1,initialize next path position
v1.1.1,until we are at the end of the path (last seg is always zero size)
v1.1.1,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.1.1,send drone command to get to next lookahead
v1.1.1,sleep for rest of the cycle
v1.1.1,how much have we moved towards last goal?
v1.1.1,project actual vector on goal vector
v1.1.1,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.1.1,TODO: below should be lower than 1E3 and configurable
v1.1.1,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.1.1,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.1.1,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.1.1,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.1.1,"if drone moved backward, we don't want goal to move backward as well"
v1.1.1,"so only climb forward on the path, never back. Also note >= which means"
v1.1.1,we climb path even if distance was 0 to take care of duplicated points on path
v1.1.1,else
v1.1.1,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.1.1,compute next target on path
v1.1.1,last command is to hold on to position
v1.1.1,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.1.1,derived flight controller class should provide implementation if they support exclusive sim*** methods
v1.1.1,derived class should override this if it supports sim**** methods
v1.1.1,default strategy is for move. In hover mode we set new strategy temporarily
v1.1.1,freeze the quaternion
v1.1.1,get trims
v1.1.1,take average
v1.1.1,convert RC commands to velocity vector
v1.1.1,find yaw as per terrain and remote setting
v1.1.1,execute command
v1.1.1,Only raise exception is time out occurred. If preempted then return status.
v1.1.1,are we supposed to do EM?
v1.1.1,get suggested velocity vector
v1.1.1,use the unchecked command
v1.1.1,tell caller not to execute planned command
v1.1.1,other wise throw exception
v1.1.1,otherwise there is some other reason why we are in unsafe situation
v1.1.1,send last command to come to full stop
v1.1.1,else no unsafe situation
v1.1.1,note: cur_path_loc and next_path_loc may both point to same object
v1.1.1,"otherwise use up this segment, move on to next one"
v1.1.1,if we are here then we ran out of segments
v1.1.1,consider last segment as zero length segment
v1.1.1,adjust yaw for the direction of travel in foward-only mode
v1.1.1,else no adjustment needed
v1.1.1,validate dest
v1.1.1,what is the distance we will travel at this velocity?
v1.1.1,get velocity vector
v1.1.1,yaw for the direction of travel
v1.1.1,find velocity vector
v1.1.1,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.1.1,generate velocity vector that is same size as cur_dest_norm / command period
v1.1.1,this velocity vect when executed for command period would yield cur_dest_norm
v1.1.1,send commands
v1.1.1,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.1.1,by default indicate that we don't have alternative pose info
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,"in header only mode, control library is not available"
v1.1.1,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.1,if using Unreal Build system then include precompiled header file first
v1.1.1,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.1.1,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.1,make sure we can talk to the DroneServer
v1.1.1,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.1.1,command_context.client.ping();
v1.1.1,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,"in header only mode, control library is not available"
v1.1.1,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.1,if using Unreal Build system then include precompiled header file first
v1.1.1,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.1,#undef check
v1.1.1,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.1,sim only
v1.1.1,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.1,required for pimpl
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,"in header only mode, control library is not available"
v1.1.1,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.1,if using Unreal Build system then include precompiled header file first
v1.1.1,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.1.1,sim only
v1.1.1,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.1,status getters
v1.1.1,make sure we can talk to the DroneServer
v1.1.1,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.1.1,command_context.client.ping();
v1.1.1,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,"in header only mode, control library is not available"
v1.1.1,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.1.1,if using Unreal Build system then include precompiled header file first
v1.1.1,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.1,#undef check
v1.1.1,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.1.1,sim only
v1.1.1,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.1.1,getters
v1.1.1,required for pimpl
v1.1.1,Create a spring arm component for our chase camera
v1.1.1,do nothing
v1.1.1,set initial view mode
v1.1.1,external_camera_->bUsePawnControlRotation = false;
v1.1.1,"else someone else is bound to manual pose controller, leave it alone"
v1.1.1,TODO: explore screenshot option
v1.1.1,addScreenCaptureHandler(camera->GetWorld());
v1.1.1,Wait for render so that view is ready for capture
v1.1.1,not sure why this doesn't work.
v1.1.1,"DECLARE_CYCLE_STAT(TEXT(""FNullGraphTask.CheckRenderStatus""), STAT_FNullGraphTask_CheckRenderStatus, STATGROUP_TaskGraphTasks);"
v1.1.1,"auto renderStatus = TGraphTask<FNullGraphTask>::CreateTask(NULL).ConstructAndDispatchWhenReady(GET_STATID(STAT_FNullGraphTask_CheckRenderStatus), ENamedThreads::RenderThread);"
v1.1.1,FTaskGraphInterface::Get().WaitUntilTaskCompletes(renderStatus);
v1.1.1,Make sure that all alpha values are opaque.
v1.1.1,Deflect along the surface when we collide.
v1.1.1,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.1.1,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.1.1,set up key variables
v1.1.1,initialize state
v1.1.1,should be overridden in derived class
v1.1.1,TODO: delete below
v1.1.1,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.1,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.1,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.1.1,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.1,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.1.1,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.1.1,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.1.1,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.1.1,parameters in NED frame
v1.1.1,translate to new VehiclePawnWrapper position & orientation from NED to NEU
v1.1.1,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.1.1,must reset collison before we set pose. Setting pose will immediately call NotifyHit if there was collison
v1.1.1,"if there was no collison than has_collided would remain false, else it will be set so its value can be"
v1.1.1,checked at the start of next tick
v1.1.1,allow teleportation
v1.1.1,if collisons are not enabled
v1.1.1,or we have collided but passthrough is enabled
v1.1.1,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.1.1,"without flip flopping, collisons can't be detected"
v1.1.1,set default for brigher images
v1.1.1,by default all image types are disabled
v1.1.1,use final color for all calculations
v1.1.1,use final color for all calculations
v1.1.1,else we will set this after this components get created
v1.1.1,else we will set this after this components get created
v1.1.1,do not make unnecessory calls to Activate() which otherwise causes crash in Unreal
v1.1.1,else nothing to enable
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,TODO: change naming conventions to same as other files?
v1.1.1,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.1.1,can we see followee?
v1.1.1,remove mapping
v1.1.1,removing binding
v1.1.1,"TODO: can't do remove because there is no ""stamp"" on who established binding"
v1.1.1,removeInputBindings();
v1.1.1,#ifdef _MSC_VER
v1.1.1,//print to VS output window
v1.1.1,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.1.1,#endif
v1.1.1,also do default logging
v1.1.1,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.1.1,UGameUserSettings* game_settings = GetGameUserSettings();
v1.1.1,game_settings->SetFullscreenMode(EWindowMode::WindowedFullscreen);
v1.1.1,game_settings->ApplySettings(true);
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,plugin startup
v1.1.1,plugin shutdown
v1.1.1,"read pixels from render target using render thread, then compress the result into PNG"
v1.1.1,argument on the thread that calls this method.
v1.1.1,make sure we are not on the rendering thread
v1.1.1,TODO: below doesn't work right now because it must be running in game thread
v1.1.1,below is documented method but more expensive because it forces flush
v1.1.1,wait for render thread to pick up our task
v1.1.1,Queue up the task of rendering the scene in the render thread
v1.1.1,wait for this task to complete
v1.1.1,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.1.1,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.1.1,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.1.1,Stuff to filter out XInput devices
v1.1.1,-----------------------------------------------------------------------------
v1.1.1,"Defines, constants, and global variables"
v1.1.1,-----------------------------------------------------------------------------
v1.1.1,Register with the DirectInput subsystem and get a pointer
v1.1.1,to a IDirectInput interface we can use.
v1.1.1,Create a DInput object
v1.1.1,Look for a simple joystick we can use for this sample program.
v1.1.1,Make sure we got a joystick
v1.1.1,"Set the data format to ""simple joystick"" - a predefined data format"
v1.1.1,
v1.1.1,"A data format specifies which controls on a device we are interested in,"
v1.1.1,and how they should be reported. This tells DInput that we will be
v1.1.1,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.1.1,Set the cooperative level to let DInput know how this device should
v1.1.1,interact with the system and with other DInput applications.
v1.1.1,Enumerate the joystick objects. The callback function enabled user
v1.1.1,"interface elements for objects that are found, and sets the min/max"
v1.1.1,values property for discovered axes.
v1.1.1,-----------------------------------------------------------------------------
v1.1.1,Enum each PNP device using WMI and check each device ID to see if it contains
v1.1.1,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then its an XInput device"
v1.1.1,Unfortunately this information can not be found by just using DirectInput.
v1.1.1,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.1.1,XInput devices.
v1.1.1,
v1.1.1,This function stores the list of xinput devices in a linked list
v1.1.1,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.1.1,-----------------------------------------------------------------------------
v1.1.1,CoInit if needed
v1.1.1,Create WMI
v1.1.1,Create BSTRs for WMI
v1.1.1,Connect to WMI
v1.1.1,Switch security level to IMPERSONATE
v1.1.1,Get list of Win32_PNPEntity devices
v1.1.1,Loop over all devices
v1.1.1,Get 20 at a time
v1.1.1,"For each device, get its device ID"
v1.1.1,"Check if the device ID contains ""IG_"".  If it does, then its an XInput device"
v1.1.1,Unfortunately this information can not be found by just using DirectInput
v1.1.1,"If it does, then get the VID/PID from var.bstrVal"
v1.1.1,Add the VID/PID to a linked list
v1.1.1,-----------------------------------------------------------------------------
v1.1.1,Returns true if the DirectInput device is also an XInput device.
v1.1.1,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.1.1,-----------------------------------------------------------------------------
v1.1.1,Check each xinput device to see if this device's vid/pid matches
v1.1.1,-----------------------------------------------------------------------------
v1.1.1,Cleanup needed for IsXInputDevice()
v1.1.1,-----------------------------------------------------------------------------
v1.1.1,Cleanup linked list
v1.1.1,-----------------------------------------------------------------------------
v1.1.1,Name: EnumJoysticksCallback()
v1.1.1,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.1.1,device interface on it so we can play with it.
v1.1.1,-----------------------------------------------------------------------------
v1.1.1,Skip anything other than the perferred joystick device as defined by the control panel.
v1.1.1,Instead you could store all the enumerated joysticks and let the user pick.
v1.1.1,Obtain an interface to the enumerated joystick.
v1.1.1,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.1.1,it while we were in the middle of enumerating it.)
v1.1.1,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.1.1,could store all the enumerated joysticks and let the user pick.
v1.1.1,-----------------------------------------------------------------------------
v1.1.1,Name: EnumObjectsCallback()
v1.1.1,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.1.1,joystick. This function enables user interface elements for objects
v1.1.1,"that are found to exist, and scales axes min/max values."
v1.1.1,-----------------------------------------------------------------------------
v1.1.1,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.1.1,enumerated axis in order to scale min/max values.
v1.1.1,Set the range for the axis
v1.1.1,Set the UI to reflect what objects the joystick supports
v1.1.1,-----------------------------------------------------------------------------
v1.1.1,Name: UpdateInputState()
v1.1.1,Desc: Get the input device's state and display it.
v1.1.1,-----------------------------------------------------------------------------
v1.1.1,Poll the device to read the current state
v1.1.1,DInput is telling us that the input stream has been
v1.1.1,"interrupted. We aren't tracking any state between polls, so"
v1.1.1,we don't have any special reset that needs to be done. We
v1.1.1,just re-acquire and try again.
v1.1.1,while (hr == DIERR_INPUTLOST)
v1.1.1,hr = g_pJoystick->Acquire();
v1.1.1,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.1.1,may occur when the app is minimized or in the process of
v1.1.1,"switching, so just try again later"
v1.1.1,Get the input's device state
v1.1.1,Axes
v1.1.1,Slider controls
v1.1.1,Points of view
v1.1.1,Buttons
v1.1.1,-----------------------------------------------------------------------------
v1.1.1,Name: FreeDirectInput()
v1.1.1,Desc: Initialize the DirectInput variables.
v1.1.1,-----------------------------------------------------------------------------
v1.1.1,Unacquire the device one last time just in case
v1.1.1,the app tried to exit while the device is still acquired.
v1.1.1,Release any DirectInput objects.
v1.1.1,nop
v1.1.1,normalize min to max --> 0 to 1
v1.1.1,normalize 0 to 1 --> -1 to 1
v1.1.1,implementation for unsupported OS
v1.1.1,if this is new indec
v1.1.1,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.1.1,close previos one
v1.1.1,open new device
v1.1.1,if open was sucessfull
v1.1.1,read the device
v1.1.1,if we didn't had valid read
v1.1.1,"NOTE if this condition is not met, we're probably out of sync and this"
v1.1.1,Joystick instance is likely unusable
v1.1.1,TODO: set below to false?
v1.1.1,state.is_valid = false;
v1.1.1,else ignore
v1.1.1,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.1.1,{
v1.1.1,"manufacturerID = productID = """";"
v1.1.1,// Use udev to look up the product and manufacturer IDs
v1.1.1,struct udev *udev = udev_new();
v1.1.1,if (udev) {
v1.1.1,char sysname[32];
v1.1.1,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.1.1,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.1.1,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.1.1,if (!dev)
v1.1.1,{
v1.1.1,"message = ""Unable to find parent USB device"";"
v1.1.1,return false;
v1.1.1,}
v1.1.1,std::stringstream ss;
v1.1.1,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.1.1,ss >> manufacturerID;
v1.1.1,ss.clear();
v1.1.1,"ss.str("""");"
v1.1.1,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.1.1,ss >> productID;
v1.1.1,udev_device_unref(dev);
v1.1.1,}
v1.1.1,else
v1.1.1,{
v1.1.1,"message = ""Cannot create udev"";"
v1.1.1,return false;
v1.1.1,}
v1.1.1,udev_unref(udev);
v1.1.1,return true;
v1.1.1,}
v1.1.1,required for pimpl
v1.1.1,TODO: should we only do below on SceneCapture2D components and cameras?
v1.1.1,avoid motion blur so capture images don't get
v1.1.1,use two different methods to set console var because sometime it doesn't seem to work
v1.1.1,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.1.1,create main widget
v1.1.1,synchronize PIP views
v1.1.1,setup defaults
v1.1.1,TODO: should this be done somewhere else?
v1.1.1,load settings file if found
v1.1.1,create default settings
v1.1.1,"write some settings in new file otherwise the string ""null"" is written if all settigs are empty"
v1.1.1,TODO: there is a crash in Linux due to settings.saveJSonString(). Remove this workaround after we only support Unreal 4.17
v1.1.1,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.1.1,create its control server
v1.1.1,stop physics thread before we dismental
v1.1.1,for (AActor* actor : spawned_actors_) {
v1.1.1,actor->Destroy();
v1.1.1,}
v1.1.1,get player controller
v1.1.1,put camera little bit above vehicle
v1.1.1,we will either find external camera if it already exist in evironment or create one
v1.1.1,find all BP camera directors in the environment
v1.1.1,create director
v1.1.1,create external camera required for the director
v1.1.1,find all vehicle pawns
v1.1.1,if no vehicle pawns exists in environment
v1.1.1,create vehicle pawn
v1.1.1,set up vehicle pawns
v1.1.1,initialize each vehicle pawn we found
v1.1.1,chose first pawn as FPV if none is designated as FPV
v1.1.1,now create the connector for each pawn
v1.1.1,else we don't have vehicle for this pawn
v1.1.1,find vehicles and cameras available in environment
v1.1.1,if none available then we will create one
v1.1.1,get references of components so we can use later
v1.1.1,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.1.1,-1 to 1 --> 0 to 1
v1.1.1,convert 0 to 1 -> -1 to 1
v1.1.1,TODO: add fields for z axis?
v1.1.1,last 8 bits are not used for now
v1.1.1,TODO: should below be at controller level info?
v1.1.1,else don't waste time
v1.1.1,"Utils::log(""------Render tick-------"");"
v1.1.1,move collison info from rendering engine to vehicle
v1.1.1,update ground level
v1.1.1,update rotor poses
v1.1.1,this must be the first call so controller can change the state before anything else we do
v1.1.1,update rotor animations
v1.1.1,"UAirBlueprintLib::LogMessage(TEXT(""Collison (raw) Count:""), FString::FromInt(collision_response_info.collison_count_raw), LogDebugLevel::Unimportant);"
v1.1.1,*** Start: UpdatableState implementation ***//
v1.1.1,TODO: should this be done in MultiRotor.hpp
v1.1.1,controller_->reset();
v1.1.1,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.1.1,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.1.1,*** End: UpdatableState implementation ***//
v1.1.1,"If render command is complete, save image along with position and orientation"
v1.1.1,TODO: because this bug we are using alternative code with stringstream
v1.1.1,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.1.1,std::stringstream ss;
v1.1.1,"ss << timestamp_millis << ""\t"";"
v1.1.1,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.1.1,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.1.1,"ss << ""\n"";"
v1.1.1,return ss.str();
v1.1.1,make sire all vars are set up
v1.1.1,"todo: should we go as fast as possible, or should we limit this to a particular number of"
v1.1.1,frames per second?
v1.1.1,get player controller
v1.1.1,put camera little bit above vehicle
v1.1.1,we will either find external camera if it already exist in evironment or create one
v1.1.1,find all BP camera directors in the environment
v1.1.1,create director
v1.1.1,create external camera required for the director
v1.1.1,find all vehicle pawns
v1.1.1,if no vehicle pawns exists in environment
v1.1.1,create vehicle pawn
v1.1.1,set up vehicle pawns
v1.1.1,initialize each vehicle pawn we found
v1.1.1,chose first pawn as FPV if none is designated as FPV
v1.1.1,find vehicles and cameras available in environment
v1.1.1,if none available then we will create one
v1.1.1,find all vehicle pawns
v1.1.1,set up vehicle pawns
v1.1.1,initialize each vehicle pawn we found
v1.1.1,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.1,Setup suspension forces
v1.1.1,Find the tire object and set the data for it
v1.1.1,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.1,Setup suspension forces
v1.1.1,Find the tire object and set the data for it
v1.1.1,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.1,Needed for VR Headset
v1.1.1,this->AutoReceiveInput = EAutoReceiveInput::Player0;
v1.1.1,Car mesh
v1.1.1,Setup friction materials
v1.1.1,Wheels/Tyres
v1.1.1,Setup the wheels
v1.1.1,Adjust the tire loading
v1.1.1,Engine
v1.1.1,Torque setup
v1.1.1,Adjust the steering
v1.1.1,Transmission
v1.1.1,We want 4wd
v1.1.1,Drive the front wheels a little more than the rear
v1.1.1,Automatic gearbox
v1.1.1,"Disable reverse as brake, this is needed for SetBreakInput() to take effect"
v1.1.1,Physics settings
v1.1.1,Adjust the center of mass - the buggy is quite low
v1.1.1,Set the inertia scale. This controls how the mass of the vehicle is distributed.
v1.1.1,Create In-Car camera component
v1.1.1,In car HUD
v1.1.1,Create text render component for in car speed display
v1.1.1,Create text render component for in car gear display
v1.1.1,Setup the audio component and allocate it a sound cue
v1.1.1,Colors for the in-car gear display. One for normal one for reverse
v1.1.1,put camera little bit above vehicle
v1.1.1,if (Val < 0)
v1.1.1,OnReversePressed();
v1.1.1,else
v1.1.1,OnReverseReleased();
v1.1.1,Setup the flag to say we are in reverse gear
v1.1.1,Update phsyics material
v1.1.1,Update the strings used in the hud (incar and onscreen)
v1.1.1,Set the string in the incar hud
v1.1.1,Pass the engine RPM to the sound component
v1.1.1,Start an engine sound playing
v1.1.1,Using FText because this is display text that should be localizable
v1.1.1,Setup the text render component strings
v1.1.1,call virtual method in derived class
v1.1.1,remove everything that we created in BeginPlay
v1.1.1,perfom any expensive rendering update outside of lock region
v1.1.1,should be overridden by derived class
v1.1.1,Unreal doesn't allow pure abstract methods in actors
v1.1.1,set defaults in case exception occurs
v1.1.1,we had spelling mistake so we are currently supporting SettingsVersion or SettingdVersion :(
v1.1.1,no warnings because we have default settings
v1.1.1,by default we spawn server at local endpoint. Do not use 127.0.0.1 as default below
v1.1.1,because for docker container default is 0.0.0.0 and people get really confused why things
v1.1.1,don't work
v1.1.1,Should be overridden by derived classes
v1.1.1,Should be overridden by derived classes
v1.1.1,Should be overridden by derived classes
v1.1.1,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,This assumes you are running DroneServer already on the same machine.
v1.1.1,DroneServer must be running first.
v1.1.1,enable API control
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,move commands
v1.1.1,else leave as it is
v1.1.1,TODO: get these in one call
v1.1.1,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.1.1,parse
v1.1.1,group the images by the current date.
v1.1.1,"std::string beforeScriptStartCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.1,{
v1.1.1,"return """";"
v1.1.1,}
v1.1.1,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.1.1,{
v1.1.1,return false;
v1.1.1,}
v1.1.1,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.1.1,params.context->client.newTask();
v1.1.1,}
v1.1.1,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.1.1,params.context->client.WaitForCompletion(0);
v1.1.1,}
v1.1.1,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.1.1,{
v1.1.1,}
v1.1.1,parse command line
v1.1.1,Shell callbacks
v1.1.1,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.1,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.1,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.1,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.1.1,Add shell commands
v1.1.1,TODO: add WaitForCompletion command
v1.1.1,"TODO: add command line args help, arg count validation"
v1.1.1,Copyright (c) Microsoft Corporation. All rights reserved.
v1.1.1,Licensed under the MIT License.
v1.1.1,switch to explicit hover mode so that this is the fallback when
v1.1.1,move* commands are finished.
v1.1.1,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.1.1,60 acres park:
v1.1.1,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.1.1,marymoore park
v1.1.1,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,read settings and override defaults
v1.0.0,allow json overrides on a per-vehicle basis.
v1.0.0,start server in async mode
v1.0.0,check messages
v1.0.0,DEY: I don't know why this was there.
v1.0.0,data = np.flipud(data)
v1.0.0,connect to the AirSim simulator
v1.0.0,use open cv to show new images from AirSim
v1.0.0,requires Python 3.5.3 :: Anaconda 4.4.0
v1.0.0,pip install opencv-python
v1.0.0,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.0.0,use open cv to create point cloud from depth image.
v1.0.0,skip it
v1.0.0,AirSim uses NED coordinates so negative axis is up.
v1.0.0,z of -7 is 7 meters above the original launch point.
v1.0.0,Fly given velocity vector for 5 seconds
v1.0.0,using DrivetrainType.MaxDegreeOfFreedom means we can control the drone yaw independently
v1.0.0,from the direction the drone is flying.  I've set values here that make the drone always point inwards
v1.0.0,towards the inside of the box (which would be handy if you are building a 3d scan of an object in the real world).
v1.0.0,AirSim uses NED coordinates so negative axis is up.
v1.0.0,z of -5 is 5 meters above the original launch point.
v1.0.0,see https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo
v1.0.0,this method is async and we are not waiting for the result since we are passing max_wait_seconds=0.
v1.0.0,basic flight control
v1.0.0,query vehicle state
v1.0.0,def getRCData(self):
v1.0.0,return self.client.call('getRCData')
v1.0.0,APIs for control
v1.0.0,camera control
v1.0.0,simGetImage returns compressed png in array of bytes
v1.0.0,image_type uses one of the AirSimImageType members
v1.0.0,"because this method returns std::vector<uint8>, msgpack decides to encode it as a string unfortunately."
v1.0.0,camera control
v1.0.0,simGetImage returns compressed png in array of bytes
v1.0.0,image_type uses one of the AirSimImageType members
v1.0.0,helper method for converting getOrientation to roll/pitch/yaw
v1.0.0,https:#en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles
v1.0.0,roll (x-axis rotation)
v1.0.0,pitch (y-axis rotation)
v1.0.0,yaw (z-axis rotation)
v1.0.0,DEY: I don't know why this was there.
v1.0.0,data = np.flipud(data)
v1.0.0,use open cv to show new images from AirSim
v1.0.0,requires Python 3.5.3 :: Anaconda 4.4.0
v1.0.0,pip install opencv-python
v1.0.0,"you must first press ""1"" in the AirSim view to turn on the depth capture"
v1.0.0,get depth image
v1.0.0,"this will return png width= 256, height= 144"
v1.0.0,slice the image so we only check what we are headed into (and not what is down on the ground below us).
v1.0.0,"now look at 4 horizontal bands (far left, left, right, far right) and see which is most open."
v1.0.0,"the depth map uses black for far away (0) and white for very close (255), so we invert that"
v1.0.0,to get an estimate of distance.
v1.0.0,sanity check on what is directly in front of us (slot 2 in our hsplit)
v1.0.0,"we have a 90 degree field of view (pi/2), we've sliced that into 5 chunks, each chunk then represents"
v1.0.0,an angular delta of the following pi/10.
v1.0.0,"in header only mode, control library is not available"
v1.0.0,if using Unreal Build system then include precompiled header file first
v1.0.0,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.0.0,"Windows, OSX and Linux."
v1.0.0,WIN32 will create the wrong file names if we don't first convert them to UTF-16.
v1.0.0,Windows users can move the Documents folder to any location they want
v1.0.0,SHGetFolderPath knows how to find it.
v1.0.0,fall back in case SHGetFolderPath failed for some reason.
v1.0.0,convert from std::path '/' to windows backslash.
v1.0.0,make the current thread run with maximum priority.
v1.0.0,THREAD_PRIORITY_HIGHEST is too high and makes animation a bit jumpy.
v1.0.0,TODO: How to handle POSIX thread priorities on OSX?
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,MavlinkMoCap.cpp : Defines the entry point for the console application.
v1.0.0,
v1.0.0,Treat all errors as failure conditions.
v1.0.0,parse command line
v1.0.0,"motive gives a weird error if the project is not found, so we look for it."
v1.0.0,Do an update to pick up any recently-arrived cameras.
v1.0.0,List all detected cameras.
v1.0.0,List all defined rigid bodies.
v1.0.0,throttle to 50 messages per second.
v1.0.0,OptiTrack uses 'y' axis for vertical.
v1.0.0,stdafx.cpp : source file that includes just the standard includes
v1.0.0,MavlinkMoCap.pch will be the pre-compiled header
v1.0.0,stdafx.obj will contain the pre-compiled type information
v1.0.0,TODO: reference any additional headers you need in STDAFX.H
v1.0.0,and not in this file
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,PX4.cpp : Defines the entry point for the console application.
v1.0.0,static const int pixhawkFMUV1ProductId = 16;     ///< Product ID for PX4 FMU V1 board
v1.0.0,how do you write to the debug output windows on Unix ?
v1.0.0,"The remote app is connected to Pixhawk, and is also ""serving"" UDP packets, this tells us what remote"
v1.0.0,connection to create to talke to that server.
v1.0.0,this is used if you want to connect MavLinkTest to the serial port of the Pixhawk directly
v1.0.0,server mode is when you want another app to connect to Pixhawk and publish data back to this process.
v1.0.0,"this server will be listening for UDP packets, this is mutually exclusive with 'offboard' as this"
v1.0.0,"server will become the primary ""droneConnection"".  For example, jMAVSim can talk to this server"
v1.0.0,using their the -qgc option.
v1.0.0,These are used to echo the mavlink messages to other 3rd party apps like QGC or LogViewer.
v1.0.0,this switch controls whether we turn off the RC remote active link loss detection
v1.0.0,"if you do not have radio connected this is needed to stop ""failsafe"" override in pixhawk"
v1.0.0,from kicking in when you try and fly.
v1.0.0,can't use experimental stuff on Linux because of potential ABI issues
v1.0.0,parse the json
v1.0.0,flatten inner mavlink object
v1.0.0,flatten inner mavlink object
v1.0.0,todo
v1.0.0,todo
v1.0.0,"const char* outLogFileOption = ""outlogfile"";"
v1.0.0,parse command line
v1.0.0,forward all PX4 messages to the remote proxy and all messages from remote proxy to PX4.
v1.0.0,"then we have a serial connection as the primary droneConnection, so publish all PX4 messages out to the server"
v1.0.0,"no local serial connection, so this is the primary droneConnection."
v1.0.0,failed to connect
v1.0.0,"local connection, then we own sending the heartbeat."
v1.0.0,"this is advanced command that can get us into trouble on real drone, so remove it for now."
v1.0.0,cmdTable.push_back(new AltHoldCommand());
v1.0.0,"DebugOutput(""q1 : %f\t%f\t%f\t%g"", target.q[0], target.q[1], target.q[2], target.q[3]);"
v1.0.0,"DebugOutput(""q2 : %f\t%f\t%f\t%g"", q2[0], q2[1], q2[2], q2[3]);"
v1.0.0,"DebugOutput(""target roll: %f\tpitch: %f\tyaw:%f\tthrust: %f"", roll, pitch, yaw, target.thrust);"
v1.0.0,this stops us from being able to connect to SITL mode PX4.
v1.0.0,checkPulse();
v1.0.0,add command text in log
v1.0.0,close previous command.
v1.0.0,FilterLogFiles(logDirectory);
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,send a heartbeat
v1.0.0,accept one incoming connection
v1.0.0,send a heartbeat to the client
v1.0.0,"printf(""    Received message %d\n"", static_cast<int>(msg.msgid));"
v1.0.0,"this is the server code, it will accept 1 connection from a client on port 14588"
v1.0.0,for this unit test we are expecting a request to send an image.
v1.0.0,add a drone connection so the mavLinkCom can use it to send requests to the above server.
v1.0.0,hmmm
v1.0.0,================ ls
v1.0.0,================ put file
v1.0.0,"I wish there was a cleaner way to do this, but I can't use tempPath.native() because on windows that is a wstring and on our linux build it is a string."
v1.0.0,================ get file
v1.0.0,verify the file contents.
v1.0.0,================ remove file
v1.0.0,================ make directory
v1.0.0,D:\px4\src\lovettchris\Firmware\rootfs\fs\microsd
v1.0.0,================ remove directory
v1.0.0,Now verification
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,from main.cpp.
v1.0.0,you must call this method if you want HandleMessage to be called subsequently.
v1.0.0,treat literals as one word
v1.0.0,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.0.0,request gps info
v1.0.0,convert target altitude to a 'z' coordinate (in NED coordinates).
v1.0.0,find relative position since command start so we can compare two commands better
v1.0.0,TODO: make below future proof (i.e. usable by C++17 compiler) - also change same in main.cpp
v1.0.0,can't use experimental stuff on Linux because of potential ABI issues
v1.0.0,"these PID values are important, so set these to match"
v1.0.0,sync clocks all the time so that the yellow ribbon also plays back at the right speed.
v1.0.0,we can skip ahead.
v1.0.0,our clock fell behind somehow (debug breakpoint?) So fix it by moving our start time forwards by this amount.
v1.0.0,TODO: avoid passing hadcoded HIL flag
v1.0.0,"com->setMode(last_basemode | static_cast<int>(MAV_MODE_FLAG::MAV_MODE_FLAG_HIL_ENABLED), last_custommode);"
v1.0.0,"The global position, as returned by the Global Positioning System (GPS)."
v1.0.0,Provides state for additional features
v1.0.0,The general system state
v1.0.0,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.0.0,Provides state for additional features
v1.0.0,The general system state
v1.0.0,subscribe to get subsequent messages so we can track our progress towards the requested altitude.
v1.0.0,Provides state for additional features
v1.0.0,The general system state
v1.0.0,Provides state for additional features
v1.0.0,The general system state
v1.0.0,note: we do not reset com when Close() is called because we want to keep running.
v1.0.0,"user has to invoke ""hil stop"" to stop the hil thread."
v1.0.0,generate random between 0 and 1
v1.0.0,move to range -1 to 1
v1.0.0,scale it
v1.0.0,apply iy
v1.0.0,wait for the Execute method to be called.
v1.0.0,gps is much slower frequency than IMU.
v1.0.0,MAVLINK_MSG_ID_HIL_GPS
v1.0.0,disable MAV_USEHILGPS
v1.0.0,note: we do not reset com when Close() is called because we want to keep running.
v1.0.0,"user has to invoke ""hil stop"" to stop the hil thread."
v1.0.0,generate random between 0 and 1
v1.0.0,move to range -1 to 1
v1.0.0,scale it
v1.0.0,apply iy
v1.0.0,wait for the Execute method to be called.
v1.0.0,add MAV_MODE_FLAG_HIL_ENABLED flag to current mode
v1.0.0,gps is much slower frequency than IMU.
v1.0.0,MAVLINK_MSG_ID_HIL_GPS
v1.0.0,disable HIL mode
v1.0.0,Enumeration of landed detector states
v1.0.0,MAV landed state is unknown
v1.0.0,MAV is landed (on ground)
v1.0.0,MAV is in air
v1.0.0,"control works better if we get about 50 of these per second (20ms interval, if we can)."
v1.0.0,The filtered local position
v1.0.0,must send these regularly to keep offboard control.
v1.0.0,"ok, now we can safely switch to loiter."
v1.0.0,must send these regularly to keep offboard control.
v1.0.0,integrate the heading so it is smoother.
v1.0.0,must send these regularly to keep offboard control.
v1.0.0,integrate the heading so it is smoother.
v1.0.0,fly to radius
v1.0.0,it takes about 10 cm to stop and turn.
v1.0.0,next time around switch to orbiting!
v1.0.0,heading points to center of circle.
v1.0.0,interpoloate the speed ramp up time over 2 seconds from start time
v1.0.0,"printf(""speeding up to %f\n"", orbitSpeed);"
v1.0.0,monitor the sin curves so we can see how on track or off track it actually is.
v1.0.0,the shape of the curve will also tell us if we are progressing at a consistent
v1.0.0,"speed, the more deformed the sin curve the worse our progress."
v1.0.0,pack this tracking info into mavlink_vicon_position_estimate_t just because we can....
v1.0.0,degrees just flipped from 359 to 0.
v1.0.0,this enables us to test what happens when offboard control is lost and resumed.
v1.0.0,"in case we are flying fast, we first do a Goto to get to a fixed stationary position before we try and start rotating."
v1.0.0,"ok, now we can start moving by velocity"
v1.0.0,recompute to new target.
v1.0.0,start by moving right with 10 degree roll.
v1.0.0,haven't started yet.
v1.0.0,"these PID values were calculated experimentally using AltHoldCommand, this provides the best"
v1.0.0,control over thrust to achieve minimal over/under shoot in a reasonable amount of time.
v1.0.0,track how our actual pitch is coming along compared to our target
v1.0.0,and check position
v1.0.0,the amount of pitch should depend on our speed in that direction.
v1.0.0,passed the midpoint.
v1.0.0,fade out the pitch as we pick up speed so we don't overshoot.
v1.0.0,see if we just crossed the wiggle distance threshold.
v1.0.0,(pitch affects the x-position).
v1.0.0,reverse direction with a -30 degrees quick stop
v1.0.0,reverse direction with a 30 degrees quick stop
v1.0.0,"try and keep y on target by using roll, but only use a little bit since it shouldn't wander"
v1.0.0,too much in that direction.
v1.0.0,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.0.0,track how our actual roll is coming along compared to our target
v1.0.0,and check position
v1.0.0,the amount of roll should depend on our speed in that direction.
v1.0.0,passed the midpoint.
v1.0.0,fade out the roll as we pick up speed so we don't overshoot.
v1.0.0,see if we just crossed the wiggle distance threshold.
v1.0.0,(roll affects the y-position).
v1.0.0,reverse direction with a -30 degrees quick stop
v1.0.0,reverse direction with a 30 degrees quick stop
v1.0.0,"try and keep x on target by using pitch, but only use a little bit since it shouldn't wander"
v1.0.0,too much in that direction.
v1.0.0,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.0.0,for testing PID controller.
v1.0.0,class AltHoldCommand : public Command
v1.0.0,{
v1.0.0,std::shared_ptr<MavLinkVehicle> channel;
v1.0.0,"float sx_, sy_, sz_;"
v1.0.0,MavLinkAttitudeTarget _current;
v1.0.0,PidController thrust_controller_;
v1.0.0,public:
v1.0.0,this->sz_ = pos.z; // user defined target.
v1.0.0,move to local position keeps the offboard control happy.
v1.0.0,haven't started yet.
v1.0.0,and check position
v1.0.0,double dx = this->sx_ - pos.x;
v1.0.0,double dy = this->sy_ - pos.y;
v1.0.0,"try and keep x & y on target by using pitch & roll, but only use a little bit since it shouldn't wander"
v1.0.0,too much in that direction.
v1.0.0,adjust thrust so we keep steady height target
v1.0.0,"DebugOutput(""ctrl=%f, sz=%f, z=%f, dz=%f, new thrust=%f"", ctrl, sz_, z, sz_ - z, thrust);"
v1.0.0,"""ftp [ls|cd name|get source [target]|put source target]"";"
v1.0.0,local remote
v1.0.0,already handled by the parse method.
v1.0.0,we only support very simple patterns for now.
v1.0.0,each wildcard must be separated by literal.
v1.0.0,back to back wildcards with no literal in between is too complex.
v1.0.0,"we only support simple matching for now, we can add full regex later if we need it."
v1.0.0,yep!
v1.0.0,'*' is done we found the next matching char
v1.0.0,this is ok.
v1.0.0,this is an ERASE_END_LINE command which we ignore.
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,unpack the message...
v1.0.0,pack the payload buffer.
v1.0.0,"json can't handle ""nan"", so we convert it to null."
v1.0.0,ostringstream tries to convert uint8_t to 'char' which is not what we want here.
v1.0.0,ostringstream tries to convert int8_t to 'char' which is not what we want here.
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,start listening to this connection
v1.0.0,Send heartbeat to drone.  You should not do this if some other node is
v1.0.0,already doing it.
v1.0.0,stop listening to the connection.
v1.0.0,get the connection
v1.0.0,Get the local system and component id
v1.0.0,send a command to the remote node
v1.0.0,MavLinkNode::MavLinkNode() = default;
v1.0.0,MavLinkNode::MavLinkNode(MavLinkNode&&) = default;
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,WaitOne indefinitely for one Signal.  If a Signal has already been posted then WaitOne returns immediately
v1.0.0,decrementing the count so the next WaitOne may block.
v1.0.0,perhaps we have WAIT_IO_COMPLETION interrupt...
v1.0.0,convert to absolute time.
v1.0.0,use mach_timespec
v1.0.0,convert to absolute time.
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,return true if we still have offboard control (can lose this if user flips the switch).
v1.0.0,MavLinkVehicle::MavLinkVehicle() = default;
v1.0.0,MavLinkVehicle::MavLinkVehicle(MavLinkVehicle&&) = default;
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,MavLinkTcpServer::MavLinkTcpServer(MavLinkTcpServer&&) = default;
v1.0.0,MavLinkTcpServer& MavLinkTcpServer::operator=(MavLinkTcpServer&&) = default;
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,============================== CLIENT ============================================
v1.0.0,image APIs
v1.0.0,or if you are implementing the client side call this function to get the most recent frame.
v1.0.0,returns false if there is no new frame available.
v1.0.0,============================== SERVER ============================================
v1.0.0,call this to send the image back over the connection given to start function.
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,"log every message that is ""sent"" using sendMessage."
v1.0.0,"get the next telemetry snapshot, then clear the internal counters and start over.  This way each snapshot"
v1.0.0,gives you a picture of what happened in whatever timeslice you decide to call this method.
v1.0.0,MavLinkConnection::MavLinkConnection(MavLinkConnection&&) = default;
v1.0.0,MavLinkConnection& MavLinkConnection::operator=(MavLinkConnection&&) = default;
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,for compatibility with QGroundControl we have to save the time field in big endian.
v1.0.0,todo: mavlink2 support?
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,start listening to this connection
v1.0.0,Send heartbeat to drone.  You should not do this if some other node is
v1.0.0,already doing it.
v1.0.0,send a heart beat so that the remote node knows we are still alive
v1.0.0,(otherwise drone will trigger a failsafe operation).
v1.0.0,this is called for all messages received on the connection.
v1.0.0,this is for the subclasses to play with.  We put nothing here so we are not dependent on the
v1.0.0,subclasses remembering to call this base implementation.
v1.0.0,stop listening to the connection.
v1.0.0,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.0.0,wait for a heartbeat msg since this will give us the port to send commands to...
v1.0.0,"this->setMessageInterval(static_cast<int>(MavLinkMessageIds::MAVLINK_MSG_ID_HEARTBEAT), 1);"
v1.0.0,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.0.0,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.0.0,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.0.0,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.0.0,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.0.0,"we only have 4 bytes for the value in mavlink_param_value_t, so how does this one work?"
v1.0.0,MAVLINK_MSG_ID_PARAM_REQUEST_LIST
v1.0.0,"timeout, so we'll drop through to the code below which will try and fix this..."
v1.0.0,"note that UDP does not guarantee delivery of messages, so we have to also check if some parameters are missing and get them individually."
v1.0.0,"nested loop is inefficient, but it is needed because UDP also doesn't guarantee in-order delivery"
v1.0.0,"ok, now fetch the missing parameters."
v1.0.0,confirmation of the PARAM_SET is to receive the updated PARAM_VALUE.
v1.0.0,silently fail since we are on a background thread here...
v1.0.0,tell the caller this is complete.
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,add our custom telemetry message length.
v1.0.0,todo: if we support signing then initialize
v1.0.0,mavlink_intermediate_status_.signing callbacks
v1.0.0,"std::shared_ptr<MavLinkCom> owner, const std::string& nodeName"
v1.0.0,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.0.0,"just a little sanity check on the local address, if remoteAddr is localhost then localAddr must be also."
v1.0.0,send this right away just in case serial link is not already configured
v1.0.0,"log every message that is ""sent"" using sendMessage."
v1.0.0,as per  https://github.com/mavlink/mavlink/blob/master/doc/MAVLink2.md
v1.0.0,pack the payload buffer.
v1.0.0,calculate checksum
v1.0.0,form the header as a byte array for the crc
v1.0.0,these macros use old style cast.
v1.0.0,forward messages from our connected node to the remote proxy.
v1.0.0,forward messages from remote proxy to local connected node
v1.0.0,CurrentThread::setMaximumPriority();
v1.0.0,"hmmm, wait till it is opened?"
v1.0.0,"error? well let's try again, but we should be careful not to spin too fast and kill the CPU"
v1.0.0,pick up the sysid/compid of the remote node we are connected to.
v1.0.0,then this is a mavlink 1 message
v1.0.0,then this mavlink sender supports mavlink 2
v1.0.0,queue event for publishing.
v1.0.0,"publish the message from this thread, this is safer than publishing from the readPackets thread"
v1.0.0,as it ensures we don't lose messages if the listener is slow.
v1.0.0,"this is tricky, the clear has to be done outside the lock because it is destructing the handlers"
v1.0.0,"and the handler might try and call unsubscribe, which needs to be able to grab the lock, otherwise"
v1.0.0,we would get a deadlock.
v1.0.0,CurrentThread::setMaximumPriority();
v1.0.0,reset counters
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,------------------------------------------------------------------------------
v1.0.0,Defines
v1.0.0,------------------------------------------------------------------------------
v1.0.0,bit number  876543210987654321
v1.0.0,"status messages should usually be only sent by actual PX4. However if someone else is sending it to, we should listen it."
v1.0.0,in future it would be good to have ability to add system IDs we are interested in
v1.0.0,if (msg.sysid != getTargetSystemId())
v1.0.0,{
v1.0.0,// we only care about messages from our intended remote node.
v1.0.0,return;
v1.0.0,}
v1.0.0,user may have changed modes on us! So we need to honor that and not
v1.0.0,try and take it back.
v1.0.0,"Utils::logMessage(""Received attitude, acc=[%2.2f %2.2f %2.2f]"", att.pitch, att.roll, att.yaw);"
v1.0.0,we can store up to 16 channels in rc_channels_scaled.
v1.0.0,The RAW values of the servo outputs
v1.0.0,Metrics typically displayed on a HUD for fixed wing aircraft
v1.0.0,The IMU readings in SI units in NED body frame
v1.0.0,printSystemStatus(&msg);
v1.0.0,todo: use this to determine when we need to do emergency landing...
v1.0.0,Reports the current commanded attitude of the vehicle as specified by the autopilot
v1.0.0,Provides state for additional features
v1.0.0,The general system state
v1.0.0,"This one is tricky, we can't do sendCommandAndWaitForAck in this case because it takes too long"
v1.0.0,but we do want to know when we get the ack.  So this is async ACK processing!
v1.0.0,"careful here, we are doing a tricky conversion from local coordinates to global coordinates."
v1.0.0,if threshold < 0 then the threshold is inverted.
v1.0.0,"RC channel 1 value scaled, (-100%) -10000, (0%) 0, (100%) 10000, (invalid) INT16_MAX."
v1.0.0,Convert it to a floating point number between -1 and 1.
v1.0.0,"PX4 expects the move commands to happen IMMEDIATELY after this call, so we don't actually request control here"
v1.0.0,until the move commands start happening.
v1.0.0,return true if user calls requestControl and has not called releaseControl.
v1.0.0,"Ok, now's the time to actually request it since the caller is about to send MavLinkSetPositionTargetGlobalInt, but"
v1.0.0,PX4 will reject this thinking 'offboard_control_loss_timeout' because we haven't actually sent any offboard messages
v1.0.0,yet.  I know the PX4 protocol is kind of weird.  So we prime the pump here with some dummy messages that tell the
v1.0.0,"drone to stay where it is, this will reset the 'offboard_control_loss_timeout', then we should be able to get control."
v1.0.0,send a few to make sure it gets through...
v1.0.0,now the command should succeed.
v1.0.0,"Note: we can't wait for ACK here, I've tried it.  The ACK takes too long to get back to"
v1.0.0,us by which time the PX4 times out offboard mode!!
v1.0.0,this mode change take precedence over offboard mode.
v1.0.0,thrust must be between -1 and 1.
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,These definitions are copied from PX4 implementation
v1.0.0,/ @brief This is the payload which is in mavlink_file_transfer_protocol_t.payload. We pad the structure ourselves to
v1.0.0,/ 32 bit alignment to avoid usage of any pack pragmas.
v1.0.0,/ @brief Command opcodes
v1.0.0,/ @brief Error codes returned in Nak response PayloadHeader.data[0].
v1.0.0,"request capabilities, it will respond with AUTOPILOT_VERSION."
v1.0.0,must trim trailing slashes so PX4 doesn't hang!
v1.0.0,"user was lazy, only told us where to put the file, so we borrow the name of the file"
v1.0.0,from the source.
v1.0.0,check if directory exists.
v1.0.0,perfect.
v1.0.0,use last_message_ so we preserve the sessionid.
v1.0.0,"could not create the local file, so stop."
v1.0.0,must use last_message_ so we preserve the session id.
v1.0.0,todo: wait for any pending responses from PX4 so we can safely start a new command.
v1.0.0,todo: error handling here? sequence is out of order...
v1.0.0,"directory must be empty then, can't do nextStep because"
v1.0.0,it will just loop for ever re-requesting zero offset into
v1.0.0,empty directory.
v1.0.0,result should be a list of null terminated file names.
v1.0.0,skipping this entry
v1.0.0,remove the file size field.
v1.0.0,"printf(""%s\n"", name.c_str());"
v1.0.0,request the next batch.
v1.0.0,"perhaps this was a late response after we did a retry, so ignore it."
v1.0.0,"perhaps this was a late response after we did a retry, so ignore it."
v1.0.0,"payload->size contains the bytes_written from PX4, so that's how much we advance."
v1.0.0,reached the end of the list or the file.
v1.0.0,end of file or directory listing.
v1.0.0,"success, data should be following..."
v1.0.0,ack on this cmd is a noop
v1.0.0,todo: how to handle this? For now we ignore it and let the watchdog kick in and do a retry.
v1.0.0,give up then.
v1.0.0,tell watchdog we are sending a request
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,================================= CLIENT ==============================================================
v1.0.0,Check if we have a valid transaction
v1.0.0,emit signal if all packets arrived
v1.0.0,Restart statemachine
v1.0.0,image APIs
v1.0.0,================================= SERVER ==============================================================
v1.0.0,Prepare and send acknowledgment packet
v1.0.0,Copy PACKET_PAYLOAD bytes of image data to send buffer
v1.0.0,Send ENCAPSULATED_IMAGE packet
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,todo: alternative:  probably need to do an lstat on '/dev/serial/by-id' and find
v1.0.0,"something that looks like PX4 and return that name, or follow the symbolic link to /dev/ttyACM0..."
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,{4d36e978-e325-11ce-bfc1-08002be10318}
v1.0.0,parse out the VID number
v1.0.0,now the PID
v1.0.0,parse out the VID number
v1.0.0,examples:
v1.0.0,PX4: USB\VID_26AC&PID_0011\0
v1.0.0,"FTDI cable: FTDIBUS\VID_0403+PID_6001+FTUAN9UJA\0000"""
v1.0.0,"printf(""Found: %S\n"", buffer.c_str());"
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,This has not been properly tested
v1.0.0,struct iw_statistics stats;
v1.0.0,struct iwreq req;
v1.0.0,"memset(&stats, 0, sizeof(stats));"
v1.0.0,"memset(&req, 0, sizeof(iwreq));"
v1.0.0,
v1.0.0,"strncpy(req.ifr_name, ifaceName, 16);"
v1.0.0,req.u.data.pointer = &stats;
v1.0.0,req.u.data.length = sizeof(iw_statistics);
v1.0.0,
v1.0.0,#ifdef CLEAR_UPDATED
v1.0.0,req.u.data.flags = 1;
v1.0.0,#endif
v1.0.0,
v1.0.0,/* Perform the ioctl */
v1.0.0,"if (ioctl(socket, SIOCGIWSTATS, &req) == -1) {"
v1.0.0,"//printf(""Error performing SIOCGIWSTATS on %s\n"", ifaceName);"
v1.0.0,return -127;
v1.0.0,}
v1.0.0,
v1.0.0,return stats.qual.level;
v1.0.0,todo: windows version of this...
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,windows
v1.0.0,Need to link with Ws2_32.lib
v1.0.0,posix
v1.0.0,found it!
v1.0.0,bind socket to local address.
v1.0.0,"limit the socket to only send/receive to/from this remote address/port, this ensures our"
v1.0.0,subsequent recvfrom calls don't steal messages from other UdpClientPorts.
v1.0.0,write to the serial port
v1.0.0,"well if we are creating a server, we don't know when the client is going to connect, so skip this exception for now."
v1.0.0,"throw std::runtime_error(""UdpClientPort cannot send until we've received something first so we can find out what port to send to.\n"");"
v1.0.0,"perhaps the client is gone, and may want to come back on a different port, in which case let's reset our remote port to allow that."
v1.0.0,"try and receive something, up until port is closed anyway."
v1.0.0,"message was too large for the buffer, no problem, return what we have."
v1.0.0,try again - this can happen if server recreates the socket on their side.
v1.0.0,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.0.0,"skip this, it is was interrupted, and if user is closing the port closed_ will be true."
v1.0.0,try again - this can happen if server recreates the socket on their side.
v1.0.0,"printf(""#### recv failed with error: %d\n"", hr);"
v1.0.0,we now have it.
v1.0.0,this is from someone we are not interested in.
v1.0.0,"printf(""Connection closed\n"");"
v1.0.0,-----------------------------------------------------------------------------------------
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,Initialize Winsock
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,windows
v1.0.0,Need to link with Ws2_32.lib
v1.0.0,posix
v1.0.0,found it!
v1.0.0,bind socket to local address.
v1.0.0,bind socket to local address.
v1.0.0,start listening for incoming connection
v1.0.0,accept 1
v1.0.0,write to the serial port
v1.0.0,"try and receive something, up until port is closed anyway."
v1.0.0,"message was too large for the buffer, no problem, return what we have."
v1.0.0,try again - this can happen if server recreates the socket on their side.
v1.0.0,"skip this, it is was interrupted."
v1.0.0,"printf(""Connection closed\n"");"
v1.0.0,-----------------------------------------------------------------------------------------
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,"FIXME: The windows api docs are not very clear about read timeouts,"
v1.0.0,and we have to simulate infinite with a big value (uint.MaxValue - 1)
v1.0.0,set signal
v1.0.0,Clear Handshake flags
v1.0.0,Set Handshake flags
v1.0.0,return GetLastError();
v1.0.0,return GetLastError();
v1.0.0,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.0.0,"Utils::logMessage(""unsupported data size %d (expecting 5,6,7, or 8)"", dataBits);"
v1.0.0,enable reading
v1.0.0,posix doesn't have mark/space parity.
v1.0.0,posix doesn't have mark/space parity.
v1.0.0,this is the default.
v1.0.0,not sure this is supported...
v1.0.0,"Utils::logMessage(""error %d from tcsetattr"", errno);"
v1.0.0,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.0.0,First do those specified by POSIX.
v1.0.0,Now conditionally handle a bunch of extended rates.
v1.0.0,First do those specified by POSIX.
v1.0.0,Now conditionally handle a bunch of extended rates.
v1.0.0,"Utils::logMessage(""error %d from tcgetattr"", errno);"
v1.0.0,","
v1.0.0,"std::unique_ptr<TestBase>(new PixhawkTest()),"
v1.0.0,"std::unique_ptr<TestBase>(new RosFlightTest()),"
v1.0.0,"std::unique_ptr<TestBase>(new QuaternionTest()),"
v1.0.0,std::unique_ptr<TestBase>(new WorkerThreadTest())
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,"in header only mode, control library is not available"
v1.0.0,TODO: something defines max macro which interfears with code here
v1.0.0,is cur_pos within fence?
v1.0.0,destination risk is not available then consider it zero
v1.0.0,if dest risk is lower than its more safe
v1.0.0,are we doing better than closest obstacle?
v1.0.0,"if we stay where we are, what is the risk distance?"
v1.0.0,else we are better of moving to dest
v1.0.0,this function should work even when dest_pos == cur_pos
v1.0.0,is this dest_pos cur_pos within the fence?
v1.0.0,transform dest_pos vector to body frame
v1.0.0,check for approx zero vectors to avoid random yaw angles
v1.0.0,we are hovering
v1.0.0,"get yaw in body frame, ie, front is always 0 radians"
v1.0.0,yaw to ticks
v1.0.0,get obstacles in the window at the tick direction around the window
v1.0.0,less risk distance is better
v1.0.0,check obstacles around current position and see if it has lower risk
v1.0.0,else obstacle is too far
v1.0.0,"if we detected unsafe condition due to obstacle, find direction to move away to"
v1.0.0,look for each surrounding tick to see if we have obstacle free angle
v1.0.0,else no suggestions required
v1.0.0,"3.2 comes from inverse CDF for epsilone = 0.05 (i.e. 95% confidence), author: akapoor"
v1.0.0,evaluate right and left side of circle
v1.0.0,find right and left risk distances
v1.0.0,at this point we have already determined hover is better than going to dest
v1.0.0,we now determine is moving to suggested angle better than hovering?
v1.0.0,check if dest_pos is safe
v1.0.0,breaking distance at this velocity
v1.0.0,calculate dest_pos cur_pos we will be if we had to break suddenly
v1.0.0,check if dest_pos is safe
v1.0.0,float/vec parameters can have NaN which makes them optional
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,"in header only mode, control library is not available"
v1.0.0,handles +/- tick and wraps around circle
v1.0.0,return value of this function is always >= 0 and < ticks_ (i.e. valid indices)
v1.0.0,update the specified window on the map
v1.0.0,make dure from <= to
v1.0.0,normalize the ticks so bothe are valid indices
v1.0.0,if from is still larger then
v1.0.0,to ticks is then added one full circle to make it larger than from_tick
v1.0.0,find closest obstacle in given window
v1.0.0,search whole map to find closest obstacle
v1.0.0,"in header only mode, control library is not available"
v1.0.0,"File names are unicode (std::wstring), because users can create folders containing unicode characters on both"
v1.0.0,"Windows, OSX and Linux."
v1.0.0,Windows users can move the Documents folder to any location they want
v1.0.0,SHGetFolderPath knows how to find it.
v1.0.0,fall back in case SHGetFolderPath failed for some reason.
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,"in header only mode, control library is not available"
v1.0.0,if auto mode requested for lookahead then calculate based on velocity
v1.0.0,no-op by default. derived class can override it if needed
v1.0.0,no-op by default. derived class can override it if needed
v1.0.0,validate path size
v1.0.0,validate yaw mode
v1.0.0,validate and set auto-lookahead value
v1.0.0,if auto mode requested for lookahead then calculate based on velocity
v1.0.0,add current position as starting point
v1.0.0,append the input path and compute segments
v1.0.0,add last segment as zero length segment so we have equal number of segments and points.
v1.0.0,path_segs[i] refers to segment that starts at point i
v1.0.0,"when path ends, we want to slow down"
v1.0.0,else no need to change velocities for last segments
v1.0.0,setup current position on path to 0 offset
v1.0.0,initialize next path position
v1.0.0,until we are at the end of the path (last seg is always zero size)
v1.0.0,"Utils::logMessage(""path_length_remaining = %f, Switched to breaking vel %f"", path_length_remaining, seg_velocity);"
v1.0.0,send drone command to get to next lookahead
v1.0.0,sleep for rest of the cycle
v1.0.0,how much have we moved towards last goal?
v1.0.0,project actual vector on goal vector
v1.0.0,if adaptive lookahead is enabled the calculate lookahead error (see above fig)
v1.0.0,TODO: below should be lower than 1E3 and configurable
v1.0.0,but lower values like 100 doesn't work for simple_flight + ScalableClock
v1.0.0,"Utils::logMessage(""PF: cur=%s, goal_dist=%f, cur_path_loc=%s, next_path_loc=%s, lookahead_error=%f"","
v1.0.0,"VectorMath::toString(getPosition()).c_str(), goal_dist, VectorMath::toString(cur_path_loc.position).c_str(),"
v1.0.0,"VectorMath::toString(next_path_loc.position).c_str(), lookahead_error);"
v1.0.0,"if drone moved backward, we don't want goal to move backward as well"
v1.0.0,"so only climb forward on the path, never back. Also note >= which means"
v1.0.0,we climb path even if distance was 0 to take care of duplicated points on path
v1.0.0,else
v1.0.0,"Utils::logMessage(""goal_dist was negative: %f"", goal_dist);"
v1.0.0,compute next target on path
v1.0.0,last command is to hold on to position
v1.0.0,"commandPosition(0, 0, getTakeoffZ(), YawMode::Zero());"
v1.0.0,derived flight controller class should provide implementation if they support exclusive sim*** methods
v1.0.0,derived class should override this if it supports sim**** methods
v1.0.0,default strategy is for move. In hover mode we set new strategy temporarily
v1.0.0,freeze the quaternion
v1.0.0,get trims
v1.0.0,take average
v1.0.0,convert RC commands to velocity vector
v1.0.0,find yaw as per terrain and remote setting
v1.0.0,execute command
v1.0.0,Only raise exception is time out occurred. If preempted then return status.
v1.0.0,are we supposed to do EM?
v1.0.0,get suggested velocity vector
v1.0.0,use the unchecked command
v1.0.0,tell caller not to execute planned command
v1.0.0,other wise throw exception
v1.0.0,otherwise there is some other reason why we are in unsafe situation
v1.0.0,send last command to come to full stop
v1.0.0,else no unsafe situation
v1.0.0,note: cur_path_loc and next_path_loc may both point to same object
v1.0.0,"otherwise use up this segment, move on to next one"
v1.0.0,if we are here then we ran out of segments
v1.0.0,consider last segment as zero length segment
v1.0.0,adjust yaw for the direction of travel in foward-only mode
v1.0.0,else no adjustment needed
v1.0.0,validate dest
v1.0.0,what is the distance we will travel at this velocity?
v1.0.0,get velocity vector
v1.0.0,yaw for the direction of travel
v1.0.0,find velocity vector
v1.0.0,"Utils::logMessage(""velocity_vect=%s"", VectorMath::toString(velocity_vect).c_str());"
v1.0.0,generate velocity vector that is same size as cur_dest_norm / command period
v1.0.0,this velocity vect when executed for command period would yield cur_dest_norm
v1.0.0,send commands
v1.0.0,"try to maintain altitude if path was in XY plan only, velocity based control is not as good"
v1.0.0,by default indicate that we don't have alternative pose info
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,"in header only mode, control library is not available"
v1.0.0,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.0.0,if using Unreal Build system then include precompiled header file first
v1.0.0,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.0.0,#undef check
v1.0.0,"TODO: HACK: UE4 defines macro with stupid names like ""check"" that conflicts with msgpack library"
v1.0.0,sim only
v1.0.0,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.0.0,getters
v1.0.0,required for pimpl
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,"in header only mode, control library is not available"
v1.0.0,RPC code requires C++14. If build system like Unreal doesn't support it then use compiled binaries
v1.0.0,if using Unreal Build system then include precompiled header file first
v1.0.0,"some long flight path commands can take a while, so we give it up to 1 hour max."
v1.0.0,sim only
v1.0.0,"rpclib has a bug with serializing empty vectors, so we return a 1 byte vector instead."
v1.0.0,status getters
v1.0.0,make sure we can talk to the DroneServer
v1.0.0,"std::cout << ""Contacting DroneServer..."" << std::flush;"
v1.0.0,command_context.client.ping();
v1.0.0,"std::cout << ""DroneServer is responding."" << std::endl;"
v1.0.0,set initial view mode
v1.0.0,"else someone else is bound to manual pose controller, leave it alone"
v1.0.0,TODO: explore screenshot option
v1.0.0,addScreenCaptureHandler(camera->GetWorld());
v1.0.0,Wait for render so that view is ready for capture
v1.0.0,not sure why this doesn't work.
v1.0.0,"DECLARE_CYCLE_STAT(TEXT(""FNullGraphTask.CheckRenderStatus""), STAT_FNullGraphTask_CheckRenderStatus, STATGROUP_TaskGraphTasks);"
v1.0.0,"auto renderStatus = TGraphTask<FNullGraphTask>::CreateTask(NULL).ConstructAndDispatchWhenReady(GET_STATID(STAT_FNullGraphTask_CheckRenderStatus), ENamedThreads::RenderThread);"
v1.0.0,FTaskGraphInterface::Get().WaitUntilTaskCompletes(renderStatus);
v1.0.0,Make sure that all alpha values are opaque.
v1.0.0,set default for brigher images
v1.0.0,by default all image types are disabled
v1.0.0,use final color for all calculations
v1.0.0,use final color for all calculations
v1.0.0,else we will set this after this components get created
v1.0.0,else we will set this after this components get created
v1.0.0,do not make unnecessory calls to Activate() which otherwise causes crash in Unreal
v1.0.0,else nothing to enable
v1.0.0,get references of components so we can use later
v1.0.0,set stencil IDs
v1.0.0,UAirBlueprintLib::EnableInput(this);
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,TODO: change naming conventions to same as other files?
v1.0.0,"GEngine->AddOnScreenDebugMessage(key + 10, 60.0f, color, FString::FromInt(key));"
v1.0.0,can we see followee?
v1.0.0,remove mapping
v1.0.0,removing binding
v1.0.0,"TODO: can't do remove because there is no ""stamp"" on who established binding"
v1.0.0,removeInputBindings();
v1.0.0,Deflect along the surface when we collide.
v1.0.0,FRotator CurrentRotation = GetActorRotation(RootComponent);
v1.0.0,"SetActorRotation(FQuat::Slerp(CurrentRotation.Quaternion(), HitNormal.ToOrientationQuat(), 0.025f));"
v1.0.0,set up key variables
v1.0.0,initialize state
v1.0.0,call derived class reset which in turn should call base class reset
v1.0.0,nothing to do in base
v1.0.0,should be overridden in derived class
v1.0.0,TODO: delete below
v1.0.0,"std::ifstream sim_log(""C:\\temp\\mavlogs\\circle\\sim_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.0.0,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.0.0,"std::ifstream real_log(""C:\\temp\\mavlogs\\circle\\real_cmd_006_orbit 5 1.txt.pos.txt"");"
v1.0.0,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.0.0,"std::ifstream sim_log(""C:\\temp\\mavlogs\\square\\sim_cmd_005_square 5 1.txt.pos.txt"");"
v1.0.0,"plot(sim_log, FColor::Purple, Vector3r(0, 0, -3));"
v1.0.0,"std::ifstream real_log(""C:\\temp\\mavlogs\\square\\real_cmd_012_square 5 1.txt.pos.txt"");"
v1.0.0,"plot(real_log, FColor::Yellow, Vector3r(0, 0, -3));"
v1.0.0,parameters in NED frame
v1.0.0,translate to new AVehiclePawnBase position & orientation from NED to NEU
v1.0.0,quaternion formula comes from http://stackoverflow.com/a/40334755/207661
v1.0.0,must reset collison before we set pose. Setting pose will immediately call NotifyHit if there was collison
v1.0.0,"if there was no collison than has_collided would remain false, else it will be set so its value can be"
v1.0.0,checked at the start of next tick
v1.0.0,allow teleportation
v1.0.0,if collisons are not enabled
v1.0.0,or we have collided but passthrough is enabled
v1.0.0,we will flip-flop was_last_move_teleport flag so on one tick we have passthrough and other tick we don't
v1.0.0,"without flip flopping, collisons can't be detected"
v1.0.0,//for OutputDebugString
v1.0.0,#ifdef _MSC_VER
v1.0.0,#define WIN32_LEAN_AND_MEAN
v1.0.0,#include <windows.h>
v1.0.0,#endif
v1.0.0,#ifdef _MSC_VER
v1.0.0,//print to VS output window
v1.0.0,"OutputDebugString(std::wstring(message.begin(), message.end()).c_str());"
v1.0.0,#endif
v1.0.0,also do default logging
v1.0.0,"module loading is not allowed outside of the main thread, so we load the ImageWrapper module ahead of time."
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,plugin startup
v1.0.0,plugin shutdown
v1.0.0,"read pixels from render target using render thread, then compress the result into PNG"
v1.0.0,argument on the thread that calls this method.
v1.0.0,make sure we are not on the rendering thread
v1.0.0,TODO: below doesn't work right now because it must be running in game thread
v1.0.0,below is documented method but more expensive because it forces flush
v1.0.0,wait for render thread to pick up our task
v1.0.0,Queue up the task of rendering the scene in the render thread
v1.0.0,wait for this task to complete
v1.0.0,should we be using ENQUEUE_UNIQUE_RENDER_COMMAND_ONEPARAMETER which was in original commit by @saihv
v1.0.0,https://github.com/Microsoft/AirSim/pull/162/commits/63e80c43812300a8570b04ed42714a3f6949e63f#diff-56b790f9394f7ca1949ddbb320d8456fR64
v1.0.0,"below is undocumented method that avoids flushing, but it seems to segfault every 2000 or so calls"
v1.0.0,reset roll & pitch of vehicle as multirotors required to be on plain surface at start
v1.0.0,-1 to 1 --> 0 to 1
v1.0.0,convert 0 to 1 -> -1 to 1
v1.0.0,TODO: add fields for z axis?
v1.0.0,last 8 bits are not used for now
v1.0.0,TODO: should below be at controller level info?
v1.0.0,else don't waste time
v1.0.0,"Utils::log(""------Render tick-------"");"
v1.0.0,move collison info from rendering engine to vehicle
v1.0.0,update ground level
v1.0.0,update rotor poses
v1.0.0,this must be the first call so controller can change the state before anything else we do
v1.0.0,update rotor animations
v1.0.0,"UAirBlueprintLib::LogMessage(TEXT(""Collison (raw) Count:""), FString::FromInt(collision_response_info.collison_count_raw), LogDebugLevel::Unimportant);"
v1.0.0,*** Start: UpdatableState implementation ***//
v1.0.0,TODO: should this be done in MultiRotor.hpp
v1.0.0,controller_->reset();
v1.0.0,"this is high frequency physics tick, flier gets ticked at rendering frame rate"
v1.0.0,report actual location in unreal coordinates so we can plug that into the UE editor to move the drone.
v1.0.0,*** End: UpdatableState implementation ***//
v1.0.0,Stuff to filter out XInput devices
v1.0.0,-----------------------------------------------------------------------------
v1.0.0,"Defines, constants, and global variables"
v1.0.0,-----------------------------------------------------------------------------
v1.0.0,Register with the DirectInput subsystem and get a pointer
v1.0.0,to a IDirectInput interface we can use.
v1.0.0,Create a DInput object
v1.0.0,Look for a simple joystick we can use for this sample program.
v1.0.0,Make sure we got a joystick
v1.0.0,"Set the data format to ""simple joystick"" - a predefined data format"
v1.0.0,
v1.0.0,"A data format specifies which controls on a device we are interested in,"
v1.0.0,and how they should be reported. This tells DInput that we will be
v1.0.0,passing a DIJOYSTATE2 structure to IDirectInputDevice::GetDeviceState().
v1.0.0,Set the cooperative level to let DInput know how this device should
v1.0.0,interact with the system and with other DInput applications.
v1.0.0,Enumerate the joystick objects. The callback function enabled user
v1.0.0,"interface elements for objects that are found, and sets the min/max"
v1.0.0,values property for discovered axes.
v1.0.0,-----------------------------------------------------------------------------
v1.0.0,Enum each PNP device using WMI and check each device ID to see if it contains
v1.0.0,"""IG_"" (ex. ""VID_045E&PID_028E&IG_00"").  If it does, then its an XInput device"
v1.0.0,Unfortunately this information can not be found by just using DirectInput.
v1.0.0,Checking against a VID/PID of 0x028E/0x045E won't find 3rd party or future
v1.0.0,XInput devices.
v1.0.0,
v1.0.0,This function stores the list of xinput devices in a linked list
v1.0.0,"at g_pXInputDeviceList, and IsXInputDevice() searchs that linked list"
v1.0.0,-----------------------------------------------------------------------------
v1.0.0,CoInit if needed
v1.0.0,Create WMI
v1.0.0,Create BSTRs for WMI
v1.0.0,Connect to WMI
v1.0.0,Switch security level to IMPERSONATE
v1.0.0,Get list of Win32_PNPEntity devices
v1.0.0,Loop over all devices
v1.0.0,Get 20 at a time
v1.0.0,"For each device, get its device ID"
v1.0.0,"Check if the device ID contains ""IG_"".  If it does, then its an XInput device"
v1.0.0,Unfortunately this information can not be found by just using DirectInput
v1.0.0,"If it does, then get the VID/PID from var.bstrVal"
v1.0.0,Add the VID/PID to a linked list
v1.0.0,-----------------------------------------------------------------------------
v1.0.0,Returns true if the DirectInput device is also an XInput device.
v1.0.0,"Call SetupForIsXInputDevice() before, and CleanupForIsXInputDevice() after"
v1.0.0,-----------------------------------------------------------------------------
v1.0.0,Check each xinput device to see if this device's vid/pid matches
v1.0.0,-----------------------------------------------------------------------------
v1.0.0,Cleanup needed for IsXInputDevice()
v1.0.0,-----------------------------------------------------------------------------
v1.0.0,Cleanup linked list
v1.0.0,-----------------------------------------------------------------------------
v1.0.0,Name: EnumJoysticksCallback()
v1.0.0,"Desc: Called once for each enumerated joystick. If we find one, create a"
v1.0.0,device interface on it so we can play with it.
v1.0.0,-----------------------------------------------------------------------------
v1.0.0,Skip anything other than the perferred joystick device as defined by the control panel.
v1.0.0,Instead you could store all the enumerated joysticks and let the user pick.
v1.0.0,Obtain an interface to the enumerated joystick.
v1.0.0,"If it failed, then we can't use this joystick. (Maybe the user unplugged"
v1.0.0,it while we were in the middle of enumerating it.)
v1.0.0,Stop enumeration. Note: we're just taking the first joystick we get. You
v1.0.0,could store all the enumerated joysticks and let the user pick.
v1.0.0,-----------------------------------------------------------------------------
v1.0.0,Name: EnumObjectsCallback()
v1.0.0,"Desc: Callback function for enumerating objects (axes, buttons, POVs) on a"
v1.0.0,joystick. This function enables user interface elements for objects
v1.0.0,"that are found to exist, and scales axes min/max values."
v1.0.0,-----------------------------------------------------------------------------
v1.0.0,"For axes that are returned, set the DIPROP_RANGE property for the"
v1.0.0,enumerated axis in order to scale min/max values.
v1.0.0,Set the range for the axis
v1.0.0,Set the UI to reflect what objects the joystick supports
v1.0.0,-----------------------------------------------------------------------------
v1.0.0,Name: UpdateInputState()
v1.0.0,Desc: Get the input device's state and display it.
v1.0.0,-----------------------------------------------------------------------------
v1.0.0,Poll the device to read the current state
v1.0.0,DInput is telling us that the input stream has been
v1.0.0,"interrupted. We aren't tracking any state between polls, so"
v1.0.0,we don't have any special reset that needs to be done. We
v1.0.0,just re-acquire and try again.
v1.0.0,while (hr == DIERR_INPUTLOST)
v1.0.0,hr = g_pJoystick->Acquire();
v1.0.0,hr may be DIERR_OTHERAPPHASPRIO or other errors.  This
v1.0.0,may occur when the app is minimized or in the process of
v1.0.0,"switching, so just try again later"
v1.0.0,Get the input's device state
v1.0.0,Axes
v1.0.0,Slider controls
v1.0.0,Points of view
v1.0.0,Buttons
v1.0.0,-----------------------------------------------------------------------------
v1.0.0,Name: FreeDirectInput()
v1.0.0,Desc: Initialize the DirectInput variables.
v1.0.0,-----------------------------------------------------------------------------
v1.0.0,Unacquire the device one last time just in case
v1.0.0,the app tried to exit while the device is still acquired.
v1.0.0,Release any DirectInput objects.
v1.0.0,nop
v1.0.0,normalize min to max --> 0 to 1
v1.0.0,normalize 0 to 1 --> -1 to 1
v1.0.0,implementation for unsupported OS
v1.0.0,if this is new indec
v1.0.0,"getJoystickInfo(1, manufacturerID, productID, state.message);"
v1.0.0,close previos one
v1.0.0,open new device
v1.0.0,if open was sucessfull
v1.0.0,read the device
v1.0.0,if we didn't had valid read
v1.0.0,"NOTE if this condition is not met, we're probably out of sync and this"
v1.0.0,Joystick instance is likely unusable
v1.0.0,TODO: set below to false?
v1.0.0,state.is_valid = false;
v1.0.0,else ignore
v1.0.0,"bool getJoystickInfo(int index, std::string& manufacturerID, std::string& productID, std::string& message)"
v1.0.0,{
v1.0.0,"manufacturerID = productID = """";"
v1.0.0,// Use udev to look up the product and manufacturer IDs
v1.0.0,struct udev *udev = udev_new();
v1.0.0,if (udev) {
v1.0.0,char sysname[32];
v1.0.0,"std::snprintf(sysname, sizeof(sysname), ""js%u"", index);"
v1.0.0,"struct udev_device *dev = udev_device_new_from_subsystem_sysname(udev, ""input"", sysname);"
v1.0.0,"dev = udev_device_get_parent_with_subsystem_devtype(dev, ""usb"", ""usb_device"");"
v1.0.0,if (!dev)
v1.0.0,{
v1.0.0,"message = ""Unable to find parent USB device"";"
v1.0.0,return false;
v1.0.0,}
v1.0.0,std::stringstream ss;
v1.0.0,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idVendor"");"
v1.0.0,ss >> manufacturerID;
v1.0.0,ss.clear();
v1.0.0,"ss.str("""");"
v1.0.0,"ss << std::hex << udev_device_get_sysattr_value(dev, ""idProduct"");"
v1.0.0,ss >> productID;
v1.0.0,udev_device_unref(dev);
v1.0.0,}
v1.0.0,else
v1.0.0,{
v1.0.0,"message = ""Cannot create udev"";"
v1.0.0,return false;
v1.0.0,}
v1.0.0,udev_unref(udev);
v1.0.0,return true;
v1.0.0,}
v1.0.0,required for pimpl
v1.0.0,TODO: should we only do below on SceneCapture2D components and cameras?
v1.0.0,avoid motion blur so capture images don't get
v1.0.0,use two different methods to set console var because sometime it doesn't seem to work
v1.0.0,Equivalent to enabling Custom Stencil in Project > Settings > Rendering > Postprocessing
v1.0.0,create main widget
v1.0.0,create simmode
v1.0.0,synchronize PIP views
v1.0.0,setup defaults
v1.0.0,"If render command is complete, save image along with position and orientation"
v1.0.0,TODO: because this bug we are using alternative code with stringstream
v1.0.0,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.0.0,std::stringstream ss;
v1.0.0,"ss << timestamp_millis << ""\t"";"
v1.0.0,"ss << kinematics.pose.position.x() << ""\t"" << kinematics.pose.position.y() << ""\t"" << kinematics.pose.position.z() << ""\t"";"
v1.0.0,"ss << kinematics.pose.orientation.w() << ""\t"" << kinematics.pose.orientation.x() << ""\t"" << kinematics.pose.orientation.y() << ""\t"" << kinematics.pose.orientation.z() << ""\t"";"
v1.0.0,"ss << ""\n"";"
v1.0.0,return ss.str();
v1.0.0,make sire all vars are set up
v1.0.0,"todo: should we go as fast as possible, or should we limit this to a particular number of"
v1.0.0,frames per second?
v1.0.0,create its control server
v1.0.0,stop physics thread before we dismental
v1.0.0,for (AActor* actor : spawned_actors_) {
v1.0.0,actor->Destroy();
v1.0.0,}
v1.0.0,get player controller
v1.0.0,put camera little bit above vehicle
v1.0.0,we will either find external camera if it already exist in evironment or create one
v1.0.0,find all BP camera directors in the environment
v1.0.0,create director
v1.0.0,create external camera required for the director
v1.0.0,find all vehicle pawns
v1.0.0,if no vehicle pawns exists in environment
v1.0.0,create vehicle pawn
v1.0.0,set up vehicle pawns
v1.0.0,initialize each vehicle pawn we found
v1.0.0,chose first pawn as FPV if none is designated as FPV
v1.0.0,now create the connector for each pawn
v1.0.0,else we don't have vehicle for this pawn
v1.0.0,find vehicles and cameras available in environment
v1.0.0,if none available then we will create one
v1.0.0,call virtual method in derived class
v1.0.0,remove everything that we created in BeginPlay
v1.0.0,perfom any expensive rendering update outside of lock region
v1.0.0,should be overridden by derived class
v1.0.0,Unreal doesn't allow pure abstract methods in actors
v1.0.0,needs to be done before we call base class
v1.0.0,TODO: should this be done somewhere else?
v1.0.0,load settings file if found
v1.0.0,create default settings
v1.0.0,"write some settings in new file otherwise the string ""null"" is written if all settigs are empty"
v1.0.0,TODO: there is a crash in Linux due to settings.saveJSonString(). Remove this workaround after we only support Unreal 4.17
v1.0.0,https://answers.unrealengine.com/questions/664905/unreal-crashes-on-two-lines-of-extremely-simple-st.html
v1.0.0,no warnings because we have default settings
v1.0.0,by default we spawn server at local endpoint. Do not use 127.0.0.1 as default below
v1.0.0,because for docker container default is 0.0.0.0 and people get really confused why things
v1.0.0,don't work
v1.0.0,Should be overridden by derived classes
v1.0.0,Should be overridden by derived classes
v1.0.0,Should be overridden by derived classes
v1.0.0,"Copyright 1998-2017 Epic Games, Inc. All Rights Reserved."
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,move commands
v1.0.0,else leave as it is
v1.0.0,TODO: get these in one call
v1.0.0,"shell.addCommand(""PlayPose"", &playPoseCommand, ""Play position, quaternion and GPS coordinates of drone from log file"");"
v1.0.0,parse
v1.0.0,group the images by the current date.
v1.0.0,"std::string beforeScriptStartCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.0.0,{
v1.0.0,"return """";"
v1.0.0,}
v1.0.0,"bool afterScriptEndCallback(const DroneCommandParameters& params, std::string scriptFilePath)"
v1.0.0,{
v1.0.0,return false;
v1.0.0,}
v1.0.0,std::string beforeScriptCommandStartCallback(const DroneCommandParameters& params) {
v1.0.0,params.context->client.newTask();
v1.0.0,}
v1.0.0,"bool afterScriptCommandEndCallback(const DroneCommandParameters& params, bool commandReturnValue) {"
v1.0.0,params.context->client.WaitForCompletion(0);
v1.0.0,}
v1.0.0,"void beforeCommandStartCallback(const DroneCommandParameters& params, std::string command_line)"
v1.0.0,{
v1.0.0,}
v1.0.0,parse command line
v1.0.0,Shell callbacks
v1.0.0,"shell.beforeScriptStartCallback(std::bind(&beforeScriptStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.0.0,"shell.afterScriptEndCallback(std::bind(&afterScriptEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.0.0,"shell.afterScriptCommandEndCallback(std::bind(&afterScriptCommandEndCallback, std::placeholders::_1, std::placeholders::_2));"
v1.0.0,"shell.beforeCommandStartCallback(std::bind(&beforeCommandStartCallback, std::placeholders::_1, std::placeholders::_2));"
v1.0.0,Add shell commands
v1.0.0,TODO: add WaitForCompletion command
v1.0.0,"TODO: add command line args help, arg count validation"
v1.0.0,Copyright (c) Microsoft Corporation. All rights reserved.
v1.0.0,Licensed under the MIT License.
v1.0.0,This assumes you are running DroneServer already on the same machine.
v1.0.0,DroneServer must be running first.
v1.0.0,switch to explicit hover mode so that this is the fallback when
v1.0.0,move* commands are finished.
v1.0.0,"moveByVelocityZ is an offboard operation, so we need to set offboard mode."
v1.0.0,60 acres park:
v1.0.0,"GeoPoint testLocation(47.7037051477, -122.1415384809, 9.93f);"
v1.0.0,marymoore park
v1.0.0,"GeoPoint testLocation(47.662804385, -122.1167039875, 9.93f);"
